<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>üöñ Tr∆∞·ªùng An Driving</title>
    <meta name="theme-color" content="#006400">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* --- CORE STYLES --- */
        :root { --primary: #006400; --primary-light: #28a745; --bg: #f4f6f8; --text: #333; --red: #dc3545; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 60px; }

        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white; padding: 15px; position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center;
        }
        .brand-title { font-size: 18px; font-weight: 900; text-transform: uppercase; margin: 0; }
        .hotline { font-size: 13px; font-weight: bold; color: #ffeb3b; text-decoration: none; }
        .lang-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; }
        .lang-btn.active { background: white; color: var(--primary); font-weight: bold; }

        /* CONTAINER */
        .container { max-width: 650px; margin: 0 auto; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section-head { font-size: 14px; font-weight: 700; color: var(--primary); text-transform: uppercase; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }

        /* INPUTS */
        .input-group { margin-bottom: 12px; position: relative; }
        label { font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 4px; }
        input, select { width: 100%; padding: 12px; padding-right: 45px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: #fafafa; }
        input:focus { border-color: var(--primary-light); background: #fff; }
        
        /* TOOLS */
        .tools { position: absolute; right: 5px; top: 28px; display: flex; gap: 5px; }
        .btn-icon { width: 30px; height: 30px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-x { background: #eee; color: #555; display: none; }
        .btn-trash { background: #ffebee; color: var(--red); }
        .btn-map { background: var(--primary-light); color: white; }
        
        .stop-item { margin-top: 10px; position: relative; }
        .suggestions { position: absolute; top: 100%; left: 0; width: 100%; background: white; z-index: 99; border: 1px solid #ddd; border-radius: 0 0 8px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-height: 200px; overflow-y: auto; display: none; }
        .sug-item { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 13px; cursor: pointer; }

        /* BUTTONS */
        .btn-calc { width: 100%; padding: 14px; background: linear-gradient(to right, var(--primary), var(--primary-light)); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 900; text-transform: uppercase; cursor: pointer; margin-top: 10px; }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-act { flex: 1; padding: 12px; border-radius: 8px; color: white; font-weight: bold; border: none; cursor: pointer; }
        .zalo { background: #0068ff; }
        .mail { background: #dc3545; }

        /* RESULT */
        #result-box { display: none; border: 2px solid var(--primary-light); }
        .price-tag { font-size: 28px; font-weight: 900; color: var(--primary); text-align: center; display: block; margin: 5px 0; }
        .detail-row { display: flex; justify-content: space-between; font-size: 13px; padding: 6px 0; border-bottom: 1px dashed #eee; }

        /* POLICY - COLORFUL ICONS */
        .policy { font-size: 12px; color: #555; background: #fff; padding: 10px; border-radius: 12px; margin-top: 15px; border: 1px solid #ccc; }
        .policy p { margin: 6px 0; display: flex; gap: 8px; align-items: flex-start; }
        .policy i { font-size: 14px; margin-top: 2px; }
        /* M√†u icon n·ªïi b·∫≠t */
        .icon-info { color: #17a2b8; }
        .icon-disc { color: #ffc107; text-shadow: 0 0 1px orange; }
        .icon-wait { color: #6f42c1; }
        .icon-road { color: #dc3545; }

        /* MODAL */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; border-radius: 12px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-head { padding: 12px; background: var(--primary); color: white; font-weight: bold; display: flex; justify-content: space-between; }
        #phone-modal .modal-content { padding: 20px; text-align: center; height: auto; }
        #phone-modal input { text-align: center; font-size: 18px; margin: 15px 0; }
    </style>
</head>
<body>

<header>
    <div>
        <div class="brand-title" data-i18n="brand">TR∆Ø·ªúNG AN DRIVING</div>
        <a href="tel:0847526893" class="hotline">‚òéÔ∏è 084.752.6893</a>
    </div>
    <div style="display:flex; gap:4px;">
        <button class="lang-btn active" onclick="setLang('vi')">VN</button>
        <button class="lang-btn" onclick="setLang('en')">EN</button>
        <button class="lang-btn" onclick="setLang('cn')">CN</button>
    </div>
</header>

<div class="container">
    <div class="card">
        <div class="section-head"><span data-i18n="sec_info">üìã TH√îNG TIN</span></div>
        <div class="input-group">
            <label data-i18n="lbl_phone">S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="phone" placeholder="VD: 0912345678">
            <div class="tools"><button class="btn-icon btn-x" onclick="clearInp('phone')">‚úï</button></div>
        </div>
        <div class="input-group">
            <label data-i18n="lbl_time">Th·ªùi gian ƒë√≥n:</label>
            <input type="datetime-local" id="time">
        </div>
    </div>

    <div class="card">
        <div class="section-head">
            <span data-i18n="sec_route">üó∫Ô∏è L·ªò TR√åNH</span>
            <small style="color:#007bff; cursor:pointer;" onclick="getMyLoc()" id="btn-loc" data-i18n="btn_myloc">üéØ V·ªã tr√≠ t√¥i</small>
        </div>
        
        <div class="input-group">
            <label data-i18n="lbl_pickup">ƒêi·ªÉm ƒë√≥n:</label>
            <input type="text" id="pickup" placeholder="VD: 200 ƒê·ªìng Kh·ªüi, Qu·∫≠n 1">
            <div class="tools">
                <button class="btn-icon btn-x" onclick="clearInp('pickup')">‚úï</button>
                <button class="btn-icon btn-map" onclick="openMap('pickup')">üó∫Ô∏è</button>
            </div>
            <div id="sug-pickup" class="suggestions"></div>
        </div>

        <div id="stops-box"></div>
        <div style="text-align:right; margin-bottom:10px;">
            <button onclick="addStop()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer;" data-i18n="btn_add_stop">+ Th√™m ƒëi·ªÉm d·ª´ng</button>
        </div>

        <div class="input-group">
            <label data-i18n="lbl_dropoff">ƒêi·ªÉm ƒë·∫øn:</label>
            <input type="text" id="dropoff" placeholder="VD: S√¢n bay T√¢n S∆°n Nh·∫•t (TSN)">
            <div class="tools">
                <button class="btn-icon btn-x" onclick="clearInp('dropoff')">‚úï</button>
                <button class="btn-icon btn-map" onclick="openMap('dropoff')">üó∫Ô∏è</button>
            </div>
            <div id="sug-dropoff" class="suggestions"></div>
        </div>
    </div>

    <div class="card">
        <div class="section-head" data-i18n="sec_opt">üöò T√ôY CH·ªåN</div>
        <div class="input-group">
            <label data-i18n="lbl_car">Lo·∫°i xe:</label>
            <select id="carType"><option value="4" data-i18n="opt_4seat">üöó Xe 4 ch·ªó (10k/km)</option><option value="7" data-i18n="opt_7seat">üöê Xe 7 ch·ªó (12k/km)</option></select>
        </div>
        <div class="input-group">
            <label data-i18n="lbl_type">H√¨nh th·ª©c:</label>
            <select id="tripType" onchange="toggleWait()"><option value="1" data-i18n="opt_1way">‚û°Ô∏è 1 Chi·ªÅu</option><option value="2" data-i18n="opt_2way">üîÑ 2 Chi·ªÅu (∆Øu ƒë√£i)</option></select>
        </div>
        <div id="wait-area" style="display:none; background:#e8f5e9; padding:8px; border-radius:8px; margin-bottom:10px;">
            <label data-i18n="lbl_wait">‚è≥ Gi·ªù ch·ªù (Free 3h):</label>
            <input type="number" id="waitHour" value="0">
        </div>
        <div class="input-group">
            <label data-i18n="lbl_driver">T√†i x·∫ø:</label>
            <select id="driver">
                <option value="H·ªá th·ªëng" data-i18n="opt_system">‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)</option>
                <option value="Thanh Loan">üë©‚Äçü¶∞ Thanh Loan</option>
            </select>
        </div>
    </div>

    <button class="btn-calc" id="btn-calc" onclick="calculate()" data-i18n="btn_calc">üí∞ T√çNH GI√Å C∆Ø·ªöC</button>

    <div id="main-map" style="height:250px; margin-top:15px; border-radius:12px; border:1px solid #ccc; z-index:10;"></div>

    <div id="result-box" class="card" style="margin-top:15px;">
        <div style="text-align:center; color:#555;" data-i18n="lbl_est_price">Gi√° d·ª± ki·∫øn</div>
        <span class="price-tag" id="res-total">0 ƒë</span>
        <div class="detail-row"><span data-i18n="res_dist">Qu√£ng ƒë∆∞·ªùng:</span> <strong id="res-km">0 km</strong></div>
        <div class="detail-row"><span data-i18n="res_time">Th·ªùi gian:</span> <strong id="res-min">0 min</strong></div>
        <div class="detail-row" id="row-back" style="display:none; color:var(--primary);"><span data-i18n="res_return_disc">Gi·∫£m gi√° chi·ªÅu v·ªÅ:</span> <strong id="val-back">0 ƒë</strong></div>
        <div class="detail-row" id="row-deposit" style="display:none; background:#fff3cd;"><span data-i18n="res_deposit">ƒê·∫∑t c·ªçc (20%):</span> <strong style="color:#d32f2f;" id="val-deposit">0 ƒë</strong></div>

        <div class="actions">
            <button class="btn-act zalo" onclick="preBook('zalo')">ZALO</button>
            <button class="btn-act mail" onclick="preBook('mail')">EMAIL</button>
        </div>
    </div>

    <div class="policy">
        <p><i class="fas fa-info-circle icon-info"></i> <span data-i18n="note_price">Gi√° 4 ch·ªó: 10k/km | 7 ch·ªó: 12k/km</span></p>
        <p><i class="fas fa-percent icon-disc"></i> <span data-i18n="note_disc">ƒêi 2 chi·ªÅu (1 chi·ªÅu >45km / T·ªïng >90km) gi·∫£m 40% chi·ªÅu v·ªÅ.</span></p>
        <p><i class="fas fa-clock icon-wait"></i> <span data-i18n="note_wait">Ch·ªù: Mi·ªÖn ph√≠ 3h ƒë·∫ßu. Sau ƒë√≥ 50k/h.</span></p>
        <p><i class="fas fa-road icon-road"></i> <span data-i18n="note_fee">Gi√° ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.</span></p>
    </div>
</div>

<div id="modal-map" class="modal">
    <div class="modal-content" style="height:80vh;">
        <div class="modal-head"><span data-i18n="modal_map_title">Ch·ªçn v·ªã tr√≠</span><span onclick="closeMap()" style="cursor:pointer;">‚úï</span></div>
        <div style="flex:1; position:relative;">
            <div id="picker-map" style="width:100%; height:100%;"></div>
            <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-100%); z-index:1000;">
        </div>
        <button onclick="confirmMap()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; font-weight:bold;" data-i18n="btn_confirm">X√ÅC NH·∫¨N</button>
    </div>
</div>

<div id="phone-modal" class="modal">
    <div class="modal-content">
        <h3 data-i18n="modal_phone_title">Nh·∫≠p S·ªë ƒêi·ªán Tho·∫°i</h3>
        <p data-i18n="modal_phone_desc">Vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ t√†i x·∫ø li√™n h·ªá:</p>
        <input type="tel" id="quick-phone" placeholder="09xxxx..." autofocus>
        <div style="display:flex; gap:10px;">
            <button onclick="closePhoneModal()" style="flex:1; padding:10px; border:none; background:#eee;" data-i18n="btn_cancel">H·ªßy</button>
            <button onclick="savePhoneAndBook()" style="flex:1; padding:10px; border:none; background:var(--primary); color:white; font-weight:bold;" data-i18n="btn_ok">OK & ƒê·∫∑t</button>
        </div>
    </div>
</div>

<script>
    const LANG={
        vi:{
            brand:"TR∆Ø·ªúNG AN DRIVING",sec_info:"üìã TH√îNG TIN",lbl_phone:"S·ªë ƒëi·ªán tho·∫°i:",lbl_time:"Th·ªùi gian ƒë√≥n:",sec_route:"üó∫Ô∏è L·ªò TR√åNH",btn_myloc:"üéØ V·ªã tr√≠ t√¥i",lbl_pickup:"ƒêi·ªÉm ƒë√≥n:",lbl_dropoff:"ƒêi·ªÉm ƒë·∫øn:",btn_add_stop:"+ Th√™m ƒëi·ªÉm d·ª´ng",sec_opt:"üöò T√ôY CH·ªåN",lbl_car:"Lo·∫°i xe:",opt_4seat:"üöó Xe 4 ch·ªó (10k/km)",opt_7seat:"üöê Xe 7 ch·ªó (12k/km)",lbl_type:"H√¨nh th·ª©c:",opt_1way:"‚û°Ô∏è 1 Chi·ªÅu",opt_2way:"üîÑ 2 Chi·ªÅu (∆Øu ƒë√£i)",lbl_wait:"‚è≥ Gi·ªù ch·ªù (Free 3h):",lbl_driver:"T√†i x·∫ø:",opt_system:"‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)",btn_calc:"üí∞ T√çNH GI√Å C∆Ø·ªöC",lbl_est_price:"Gi√° d·ª± ki·∫øn",res_dist:"Qu√£ng ƒë∆∞·ªùng:",res_time:"Th·ªùi gian:",res_return_disc:"Gi·∫£m gi√° chi·ªÅu v·ªÅ:",res_deposit:"C·∫ßn ƒë·∫∑t c·ªçc (20%):",note_price:"Gi√° 4 ch·ªó: 10k/km | 7 ch·ªó: 12k/km",note_disc:"ƒêi 2 chi·ªÅu (1 chi·ªÅu >45km / T·ªïng >90km) gi·∫£m 40% chi·ªÅu v·ªÅ.",note_wait:"Ch·ªù: Mi·ªÖn ph√≠ 3h ƒë·∫ßu. Sau ƒë√≥ 50k/h.",note_fee:"Gi√° ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.",modal_map_title:"Ch·ªçn v·ªã tr√≠",btn_confirm:"X√ÅC NH·∫¨N",modal_phone_title:"Nh·∫≠p S·ªë ƒêi·ªán Tho·∫°i",modal_phone_desc:"Nh√† xe c·∫ßn SƒêT ƒë·ªÉ li√™n h·ªá ƒë√≥n b·∫°n:",btn_cancel:"H·ªßy",btn_ok:"X√°c nh·∫≠n",
            plh_phone:"VD: 0912345678", plh_pickup:"VD: 200 ƒê·ªìng Kh·ªüi, Qu·∫≠n 1", plh_dropoff:"VD: S√¢n bay T√¢n S∆°n Nh·∫•t (TSN)", plh_stop:"ƒê·ªãa ch·ªâ ƒëi·ªÉm d·ª´ng (n·∫øu c√≥)..."
        },
        en:{
            brand:"TRUONG AN DRIVING",sec_info:"üìã INFORMATION",lbl_phone:"Phone Number:",lbl_time:"Pickup Time:",sec_route:"üó∫Ô∏è ROUTE",btn_myloc:"üéØ My Location",lbl_pickup:"Pick-up:",lbl_dropoff:"Drop-off:",btn_add_stop:"+ Add Stop",sec_opt:"üöò OPTIONS",lbl_car:"Car Type:",opt_4seat:"üöó 4 Seats (10k/km)",opt_7seat:"üöê 7 Seats (12k/km)",lbl_type:"Trip Type:",opt_1way:"‚û°Ô∏è One way",opt_2way:"üîÑ Round trip",lbl_wait:"‚è≥ Waiting (Free 3h):",lbl_driver:"Driver:",opt_system:"‚≠ê System (Fastest)",btn_calc:"üí∞ CALCULATE PRICE",lbl_est_price:"Estimated Price",res_dist:"Distance:",res_time:"Duration:",res_return_disc:"Return Discount:",res_deposit:"Deposit (20%):",note_price:"4 Seats: 10k/km | 7 Seats: 12k/km",note_disc:"Round trip (One-way >45km / Total >90km) get 40% off return.",note_wait:"Waiting: Free first 3h. Then 50k/h.",note_fee:"Tolls not included.",modal_map_title:"Pick Location",btn_confirm:"CONFIRM",modal_phone_title:"Enter Phone Number",modal_phone_desc:"We need your phone to contact:",btn_cancel:"Cancel",btn_ok:"Confirm",
            plh_phone:"Ex: 0912345678", plh_pickup:"Ex: 200 Dong Khoi, Dist 1", plh_dropoff:"Ex: Tan Son Nhat Airport (TSN)", plh_stop:"Stop address (if any)..."
        },
        cn:{
            brand:"ÈïøÂÆâÈ©æÈ©∂",sec_info:"üìã ‰ø°ÊÅØ",lbl_phone:"ÁîµËØùÂè∑Á†Å:",lbl_time:"Êé•ËΩ¶Êó∂Èó¥:",sec_route:"üó∫Ô∏è Ë∑ØÁ∫ø",btn_myloc:"üéØ ÊàëÁöÑ‰ΩçÁΩÆ",lbl_pickup:"‰∏äËΩ¶Âú∞ÁÇπ:",lbl_dropoff:"‰∏ãËΩ¶Âú∞ÁÇπ:",btn_add_stop:"+ Â¢ûÂä†Á´ôÁÇπ",sec_opt:"üöò ËΩ¶ÂûãÈÄâÊã©",lbl_car:"ËΩ¶Âûã:",opt_4seat:"üöó 4Â∫ß (10k/km)",opt_7seat:"üöê 7Â∫ß (12k/km)",lbl_type:"Ë°åÁ®ã:",opt_1way:"‚û°Ô∏è ÂçïÁ®ã",opt_2way:"üîÑ ÂæÄËøî",lbl_wait:"‚è≥ Á≠âÂæÖ (ÂÖçË¥π3h):",lbl_driver:"Âè∏Êú∫:",opt_system:"‚≠ê Á≥ªÁªüÂàÜÈÖç (ÊúÄÂø´)",btn_calc:"üí∞ ËÆ°ÁÆó‰ª∑Ê†º",lbl_est_price:"È¢ÑËÆ°‰ª∑Ê†º",res_dist:"Ë∑ùÁ¶ª:",res_time:"Êó∂Èó¥:",res_return_disc:"ËøîÁ®ã‰ºòÊÉ†:",res_deposit:"ÂÆöÈáë (20%):",note_price:"4Â∫ß: 10k/km | 7Â∫ß: 12k/km",note_disc:"ÂæÄËøî (ÂçïÁ®ã>45km / ÊÄªÁ®ã>90km) ËøîÁ®ãÂáè40%„ÄÇ",note_wait:"Á≠âÂæÖ: Ââç3Â∞èÊó∂ÂÖçË¥π„ÄÇ‰πãÂêé 50k/Â∞èÊó∂„ÄÇ",note_fee:"‰ª∑Ê†º‰∏çÂê´ËøáË∑ØË¥π„ÄÇ",modal_map_title:"ÈÄâÊã©‰ΩçÁΩÆ",btn_confirm:"Á°ÆËÆ§",modal_phone_title:"ËæìÂÖ•ÁîµËØùÂè∑Á†Å",modal_phone_desc:"Êàë‰ª¨ÈúÄË¶ÅÁîµËØùËÅîÁ≥ªÊÇ®:",btn_cancel:"ÂèñÊ∂à",btn_ok:"Á°ÆËÆ§",
            plh_phone:"‰æã: 0912345678", plh_pickup:"‰æã: 200 ƒê·ªìng Kh·ªüi, 1Âå∫", plh_dropoff:"‰æã: Êñ∞Â±±‰∏ÄÊú∫Âú∫ (TSN)", plh_stop:"ÂÅúÈù†ÁÇπÂú∞ÂùÄ..."
        }
    };
    let curLang='vi';
    function setLang(c){
        curLang=c;
        document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
        document.querySelector(`.lang-btn[onclick="setLang('${c}')"]`).classList.add('active');
        document.querySelectorAll('[data-i18n]').forEach(el=>{let k=el.getAttribute('data-i18n');if(LANG[c][k])el.innerText=LANG[c][k]});
        
        // C·∫≠p nh·∫≠t Placeholder
        document.getElementById('phone').placeholder = LANG[c].plh_phone;
        document.getElementById('pickup').placeholder = LANG[c].plh_pickup;
        document.getElementById('dropoff').placeholder = LANG[c].plh_dropoff;
        document.querySelectorAll('.stop-inp').forEach(inp => inp.placeholder = LANG[c].plh_stop);
    }

    const CFG={p4:10000,p7:12000,wait:50000};
    let map,pickerMap,routeL,activeInp,pendingMethod;

    window.onload=()=>{
        // Th·ª≠ kh·ªüi t·∫°o b·∫£n ƒë·ªì ch√≠nh
        try {
            map=L.map('main-map').setView([10.7769,106.7009],13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        } catch(e) {
            console.error("L·ªói kh·ªüi t·∫°o Leaflet/B·∫£n ƒë·ªì ch√≠nh. H√£y ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† c√°c th∆∞ vi·ªán Leaflet:", e);
        }

        let now=new Date(); now.setMinutes(now.getMinutes()+30-now.getTimezoneOffset());
        document.getElementById('time').value=now.toISOString().slice(0,16);
        setupInp('phone');setupInp('pickup');setupInp('dropoff');
        setLang('vi');
    };

    function setupInp(id){
        let el=document.getElementById(id);
        el.addEventListener('input',function(){toggleX(this);if(id!=='phone')searchAddr(this)});
        el.addEventListener('focus',()=>toggleX(el));
    }
    function toggleX(i){let b=i.parentElement.querySelector('.btn-x');if(b)b.style.display=i.value?'flex':'none'}
    function clearInp(id){let i=document.getElementById(id);i.value='';delete i.dataset.lat;delete i.dataset.lon;toggleX(i)} // C·∫≠p nh·∫≠t ƒë·ªÉ x√≥a c·∫£ dataset.lon

    let timer;
    function searchAddr(inp){
        clearTimeout(timer);
        let box=inp.parentElement.querySelector('.suggestions');
        if(inp.value.length<3){box.style.display='none';return}
        timer=setTimeout(()=>{
            // Ki·ªÉm tra n·∫øu ng∆∞·ªùi d√πng nh·∫≠p t·ªça ƒë·ªô (ch·ª©a d·∫•u ph·∫©y v√† s·ªë)
            const coordRegex = /^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/;
            if(coordRegex.test(inp.value.trim())) {
                let [lat, lon] = inp.value.split(',').map(s => s.trim());
                if(lat && lon) {
                    inp.dataset.lat = lat;
                    inp.dataset.lon = lon;
                    box.style.display = 'none';
                    // T·ª± ƒë·ªông Reverse Geocoding ƒë·ªÉ hi·ªÉn th·ªã t√™n ƒë∆∞·ªùng (kh√¥ng ch·∫∑n lu·ªìng)
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                    .then(r=>r.json()).then(d=>{if(d.display_name)inp.value=d.display_name;toggleX(inp)})
                    .catch(e => { console.error("L·ªói Reverse Geocoding T·ªça ƒë·ªô nh·∫≠p:", e); });
                    return;
                }
            }
            // N·∫øu kh√¥ng ph·∫£i t·ªça ƒë·ªô, ti·∫øp t·ª•c t√¨m ki·∫øm ƒë·ªãa ch·ªâ
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(inp.value)}&countrycodes=vn&addressdetails=1&limit=5&layer=address,poi`)
            .then(r=>r.json()).then(d=>{
                box.innerHTML='';if(!d.length){box.style.display='none';return}
                d.forEach(i=>{
                    let div=document.createElement('div');div.className='sug-item';
                    let n=i.display_name.split(',').slice(0,3).join(',');
                    div.innerText=`üìç ${n}`;
                    div.onclick=()=>{inp.value=n;inp.dataset.lat=i.lat;inp.dataset.lon=i.lon;box.style.display='none';toggleX(inp)};
                    box.appendChild(div);
                });box.style.display='block';
            })
            .catch(e => { console.error("L·ªói t√¨m ki·∫øm ƒë·ªãa ch·ªâ (Nominatim API):", e); box.style.display='none'; });
        },400);
    }
    document.addEventListener('click',e=>{if(!e.target.closest('.input-group'))document.querySelectorAll('.suggestions').forEach(s=>s.style.display='none')});

    function addStop(){
        let plh = LANG[curLang].plh_stop;
        let div=document.createElement('div');div.className='input-group stop-item';
        // ƒê√£ th√™m placeholder
        div.innerHTML=`<input type="text" class="stop-inp" placeholder="${plh}" oninput="searchAddr(this)"><div class="suggestions"></div><div class="tools"><button class="btn-icon btn-trash" onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button><button class="btn-icon btn-map" onclick="openMapStop(this)">üó∫Ô∏è</button></div>`;
        document.getElementById('stops-box').appendChild(div);
    }
    function openMapStop(btn){activeInp=btn.parentElement.parentElement.querySelector('input');openModalMap()}
    function openMap(id){activeInp=document.getElementById(id);openModalMap()}
    function openModalMap(){
        document.getElementById('modal-map').style.display='flex';
        // Th·ª≠ kh·ªüi t·∫°o b·∫£n ƒë·ªì ch·ªçn n·∫øu ch∆∞a c√≥
        try {
            if(!pickerMap){pickerMap=L.map('picker-map').setView([10.7769,106.7009],13);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap)}
            setTimeout(()=>pickerMap.invalidateSize(),200);
            if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>pickerMap.setView([p.coords.latitude,p.coords.longitude],15));
        } catch(e) {
             console.error("L·ªói kh·ªüi t·∫°o Leaflet/B·∫£n ƒë·ªì ch·ªçn:", e);
        }
    }
    function closeMap(){document.getElementById('modal-map').style.display='none'}
    function confirmMap(){
        let c=pickerMap.getCenter();
        activeInp.dataset.lat=c.lat;activeInp.dataset.lon=c.lng;
        activeInp.value=`${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${c.lat}&lon=${c.lng}`)
        .then(r=>r.json()).then(d=>{if(d.display_name)activeInp.value=d.display_name;toggleX(activeInp)})
        .catch(e => { console.error("L·ªói Reverse Geocoding:", e); });
        closeMap();
    }
    
    function getMyLoc(){
        let btn=document.getElementById('btn-loc'); btn.innerText="‚è≥...";
        if(!navigator.geolocation)return alert("L·ªói GPS");
        navigator.geolocation.getCurrentPosition(p=>{
            let i=document.getElementById('pickup');
            let lat=p.coords.latitude, lon=p.coords.longitude;
            i.dataset.lat=lat; i.dataset.lon=lon;
            i.value=`${lat.toFixed(5)}, ${lon.toFixed(5)}`; toggleX(i);
            btn.innerText="üéØ V·ªã tr√≠ t√¥i";
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
            .then(r=>r.json()).then(d=>{if(d.display_name)i.value=d.display_name})
            .catch(e => { console.error("L·ªói Reverse Geocoding V·ªã tr√≠ t√¥i:", e); });
        },()=>{alert("B·∫≠t GPS!");btn.innerText="üéØ V·ªã tr√≠ t√¥i"},{enableHighAccuracy:true,timeout:5000});
    }

    function toggleWait(){document.getElementById('wait-area').style.display=document.getElementById('tripType').value=='2'?'block':'none'}
    
    async function calculate(){
        let p=document.getElementById('pickup'),d=document.getElementById('dropoff');
        if(!p.dataset.lat||!d.dataset.lat)return alert(curLang=='vi'?"Ch·ªçn ƒë·ªãa ch·ªâ!":"Select address!");
        let btn=document.getElementById('btn-calc');btn.disabled=true;btn.style.opacity=0.7;
        let points=[p,...document.querySelectorAll('.stop-inp'),d].filter(x=>x.dataset.lat);
        let coord=points.map(x=>`${x.dataset.lon},${x.dataset.lat}`).join(';');
        
        try{
            let res=await fetch(`https://router.project-osrm.org/route/v1/driving/${coord}?overview=full&geometries=geojson`);
            let data=await res.json();
            if(data.code!=='Ok')throw 'API Error';
            
            let r=data.routes[0], km=r.distance/1000, time=Math.round(r.duration/60);
            
            // X√≥a v√† v·∫Ω l·∫°i Route tr√™n b·∫£n ƒë·ªì ch√≠nh
            if(routeL)map.removeLayer(routeL);
            routeL=L.geoJSON(r.geometry).addTo(map);map.fitBounds(routeL.getBounds(),{padding:[30,30]});

            let type=document.getElementById('tripType').value, unit=document.getElementById('carType').value=='4'?CFG.p4:CFG.p7;
            let go=Math.round(km*unit);
            let back=(type=='2'&&km>=45)?Math.round(go*0.6):(type=='2'?go:0);
            let wait=(type=='2'&&(parseFloat(document.getElementById('waitHour').value)||0)>3)?((parseFloat(document.getElementById('waitHour').value)-3)*CFG.wait):0;
            let total=go+back+wait, dep=(type=='2')?Math.round(total*0.2):0;

            document.getElementById('result-box').style.display='block';
            document.getElementById('res-total').innerText=total.toLocaleString()+' ƒë';
            document.getElementById('res-km').innerText=km.toFixed(1)+' km';
            document.getElementById('res-min').innerText=time+' min';
            
            let rb=document.getElementById('row-back'); rb.style.display=(type=='2'&&km>=45)?'flex':'none';
            if(rb.style.display=='flex')document.getElementById('val-back').innerText=`-${(go-back).toLocaleString()}ƒë`;
            let rd=document.getElementById('row-deposit'); rd.style.display=dep>0?'flex':'none';
            if(dep>0)document.getElementById('val-deposit').innerText=dep.toLocaleString()+' ƒë';
            document.getElementById('result-box').scrollIntoView({behavior:'smooth'});
        }catch(e){
            alert('L·ªói t√≠nh c∆∞·ªõc! Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ ho·∫∑c k·∫øt n·ªëi m·∫°ng.');
            console.error("L·ªói t√≠nh c∆∞·ªõc OSRM:", e);
        }
        btn.disabled=false;btn.style.opacity=1;
    }

    function preBook(m){
        if(!document.getElementById('phone').value){pendingMethod=m;document.getElementById('phone-modal').style.display='flex';document.getElementById('quick-phone').focus()}
        else finalBook(m);
    }
    function closePhoneModal(){document.getElementById('phone-modal').style.display='none'}
    function savePhoneAndBook(){
        let p=document.getElementById('quick-phone').value;
        if(p.length<8)return alert("SƒêT l·ªói!");
        document.getElementById('phone').value=p;closePhoneModal();finalBook(pendingMethod);
    }

    const shortC = (l) => parseFloat(l).toFixed(5);

    function finalBook(method){
        try{
            let p=document.getElementById('pickup'), d=document.getElementById('dropoff');
            if(!p.dataset.lat||!d.dataset.lat)return alert("Ch∆∞a t√≠nh gi√°!");
            
            let lat1=p.dataset.lat, lon1=p.dataset.lon;
            let lat2=d.dataset.lat, lon2=d.dataset.lon;
            
            // ƒê√É S·ª¨A L·ªñI LINK: S·ª¨ D·ª§NG C√ö PH√ÅP CHU·∫®N C·ª¶A GOOGLE MAPS
            let link1 = `https://www.google.com/maps/place/${lat1},${lon1}`;
            let link2 = `https://www.google.com/maps/place/${lat2},${lon2}`;

            let info={
                ph:document.getElementById('phone').value,
                t:document.getElementById('time').value.replace('T',' '),
                p:p.value, d:d.value,
                km:document.getElementById('res-km').innerText,
                time:document.getElementById('res-min').innerText,
                money:document.getElementById('res-total').innerText,
                car:document.getElementById('carType').selectedOptions[0].text,
                type:document.getElementById('tripType').selectedOptions[0].text
            };

            let msg=`üöñ BOOKING (${curLang.toUpperCase()})\n----------------\nüìû ${info.ph}\nüïí ${info.t}\nüöò ${info.car} | ${info.type}\n\nüìç ƒê√≥n: ${info.p}\n   ‚îî GPS: ${shortC(lat1)},${shortC(lon1)}\n   üëâ Map: ${link1}\n\nüèÅ ƒê·∫øn: ${info.d}\n   ‚îî GPS: ${shortC(lat2)},${shortC(lon2)}\n   üëâ Map: ${link2}\n\nüìä L·ªô tr√¨nh: ${info.km} (${info.time})\nüí∞ T·ªîNG: ${info.money}`;
            
            if(document.getElementById('row-deposit').style.display!='none')
                msg+=`\nüí≥ C·ªçc: ${document.getElementById('val-deposit').innerText}`;

            if(method=='zalo'){
                navigator.clipboard.writeText(msg).then(()=>{
                    alert("ƒê√£ copy! M·ªü Zalo..."); window.open('https://zalo.me/0847526893');
                }).catch(()=>{alert("L·ªói copy!")});
            }else{
                window.location.href=`mailto:truongan.driving@gmail.com?subject=BOOKING&body=${encodeURIComponent(msg)}`;
            }
        }catch(e){alert("L·ªói t·∫°o ƒë∆°n h√†ng!")}
    }
</script>
</body>
</html>
