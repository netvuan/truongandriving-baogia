<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title data-i18n="appTitle">ğŸš– Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving</title>
Â  
Â  <link rel="manifest" href="./manifest.json">
Â  <meta name="theme-color" content="#28a745"> 
Â  
Â  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
Â  <style>
Â Â Â  :root{--green:#28a745;--muted:#6c757d;--light-gray:#f4f6f8;}
Â Â Â  *{box-sizing:border-box}
Â Â Â  #main-content {
Â Â Â Â Â  background:var(--light-gray);
Â Â Â Â Â  padding: 0;
Â Â Â  }
Â Â Â  body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
Â Â Â  header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
Â Â Â  .phone-number{font-size:18px;font-weight:700;margin-top:4px}
Â Â Â  .container{padding:12px}
Â Â Â  .label-row{display:flex;align-items:center;gap:8px;margin-top:12px} /* TÄƒng khoáº£ng cÃ¡ch trÃªn */
Â Â Â  .label-row:first-of-type { margin-top: 6px; } /* Giá»¯ khoáº£ng cÃ¡ch trÃªn cho SÄT */
Â Â Â  .label-row h3{margin:0;font-size:16px} 

Â Â Â  #location-status-wrapper {
Â Â Â Â Â Â Â  display: flex;
Â Â Â Â Â Â Â  align-items: center;
Â Â Â Â Â Â Â  gap: 8px;
Â Â Â Â Â Â Â  margin-left: auto; /* Äáº©y sang pháº£i */
Â Â Â  }
Â Â Â  #reloadLocationBtn {
Â Â Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â Â Â  font-style: normal;
Â Â Â Â Â Â Â  font-size: 20px;
Â Â Â Â Â Â Â  color: #007bff;
Â Â Â Â Â Â Â  transition: transform 0.2s;
Â Â Â  }
Â Â Â  #reloadLocationBtn:hover {
Â Â Â Â Â Â Â  transform: rotate(45deg);
Â Â Â  }
Â Â Â  
Â Â Â  .input-row{position:relative;margin-top:8px}
    /* Sá»¬A Lá»–I GIAO DIá»†N: Äiá»u chá»‰nh vá»‹ trÃ­ nÃºt xÃ³a Ä‘á»ƒ khÃ´ng bá»‹ che bá»Ÿi nÃºt Báº£n Ä‘á»“ */
    /* NÃºt xÃ³a sáº½ náº±m cÃ¡ch nÃºt Báº£n Ä‘á»“ 8px */
Â Â Â  .input-row .clear-btn {
Â Â Â Â Â Â Â  position: absolute; 
        right: 80px; /* CÃ¡ch nÃºt Báº£n Ä‘á»“ (width 60px + padding + margin) */
        top: 1px; /* CÄƒn chá»‰nh láº¡i Ä‘á»ƒ khá»›p vá»›i padding cá»§a input */
Â Â Â Â Â Â Â  height: calc(100% - 2px); /* Chiá»u cao gáº§n báº±ng input */
Â Â Â Â Â Â Â  background: #e9ecef; /* MÃ u ná»n nháº¹ Ä‘á»ƒ ná»•i báº­t */
        color: #6c757d; 
        border: none; 
        padding: 0 8px; /* Giáº£m padding */
Â Â Â Â Â Â Â  border-radius: 0 8px 8px 0; /* Bo trÃ²n chá»‰ bÃªn pháº£i */
Â Â Â Â Â Â Â  font-weight: 700; 
        cursor: pointer; 
        line-height: 1;
Â Â Â Â Â Â Â  font-size: 14px; 
        display: none; 
Â Â Â Â Â Â Â  z-index: 1000;
        transition: background 0.1s;
        display: flex; /* DÃ¹ng flex Ä‘á»ƒ cÄƒn giá»¯a chá»¯ X */
        align-items: center;
        justify-content: center;
Â Â Â  }
    /* Giá»¯ nguyÃªn logic hiá»ƒn thá»‹ nÃºt clear-btn khi focus */
Â Â Â  .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
Â Â Â Â Â Â Â  display: flex; /* Äáº£m báº£o nÃºt Ä‘Æ°á»£c hiá»ƒn thá»‹ */
Â Â Â  }
    .input-row .clear-btn:hover { background: #dee2e6; color: #495057; }
    /* Äiá»u chá»‰nh input Ä‘á»ƒ chá»«a chá»— cho clear-btn vÃ  map-btn */
Â Â Â  input[type="text"]{
        padding-right: 140px; /* Chá»«a chá»— cho clear-btn (~60px) + map-btn (~70px) */
    }
Â Â Â  input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
Â Â Â Â Â  width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
Â Â Â  }
    /* Sá»¬A Lá»–I GIAO DIá»†N: Äiá»u chá»‰nh vá»‹ trÃ­ vÃ  kÃ­ch thÆ°á»›c nÃºt Báº£n Ä‘á»“ */
Â Â Â  .map-btn{
        position:absolute; 
        right:8px; 
        top:8px; 
        background:var(--green); 
        color:#fff; 
        border:0; 
        padding:6px 8px; 
        border-radius:6px; 
        font-weight:700; 
        cursor:pointer;
        line-height: 1.5; /* CÄƒn chá»‰nh láº¡i */
    }
Â Â Â  .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
Â Â Â  .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
Â Â Â  #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    /* Sá»¬A Lá»–I GIAO DIá»†N: Äáº£m báº£o suggestions hiá»ƒn thá»‹ trÃªn má»i thá»© */
Â Â Â  .suggestions{
        position:absolute; 
        left:0; 
        right:0; 
        top:100%; /* Äáº·t ngay dÆ°á»›i input */
        margin-top: 4px; /* ThÃªm khoáº£ng cÃ¡ch */
        background:#fff;
        border:1px solid #ddd;
        border-radius:8px;
        max-height:220px;
        overflow:auto; 
        -webkit-overflow-scrolling:touch; 
        z-index:2000; /* TÄƒng z-index Ä‘á»ƒ khÃ´ng bá»‹ modal hoáº·c map che */
        box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }
Â Â Â  .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
Â Â Â  .suggestions div:last-child{border-bottom:0}
Â Â Â  .suggestions div:hover{background:#f8f9fa}
Â Â Â  .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
Â Â Â  .result-row{display:flex;align-items:center;gap:8px}
Â Â Â  .distance-text{font-size:16px}
Â Â Â  .price-title{font-weight:700;margin-top:6px}
Â Â Â  .price-value{font-size:22px;color:red;font-weight:800}
Â Â Â  .price-break{margin-top:8px;font-size:15px}
Â Â Â  .actions{display:flex;gap:10px;margin-top:12px}
Â Â Â  .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
Â Â Â  .zalo-btn {background:#0068ff;} 
Â Â Â  .mail{background:#dc3545}
Â Â Â  .note{margin-top:12px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
Â Â Â  .way-wrapper{position:relative;margin-top:12px}
    /* Äiá»u chá»‰nh input trong way-wrapper */
    .way-wrapper input[type="text"] {
        padding-right: 50px; /* Chá»«a chá»— cho nÃºt xÃ³a stop */
    }
Â Â Â  .way-remove{
        position:absolute;
        right:8px;
        top:8px;
        background:#ff6b6b;
        color:#fff;
        border:0;
        padding:6px 10px;
        border-radius:6px;
        cursor:pointer;
        font-weight: 700;
    } 
    /* áº¨n nÃºt clear-btn cho Stop Input vÃ¬ Ä‘Ã£ cÃ³ way-remove */
    .way-wrapper .clear-btn { display: none !important; }


Â Â Â  /* KILL SWITCH STYLES */
Â Â Â  .disabled-form {
Â Â Â Â Â Â Â  pointer-events: none;
Â Â Â Â Â Â Â  opacity: 0.6; 
Â Â Â Â Â Â Â  transition: opacity 0.3s;
Â Â Â  }
Â Â Â  #serviceOffNotice {
Â Â Â Â Â  margin-top: 12px; 
Â Â Â Â Â  padding: 10px; 
Â Â Â Â Â  background: #dc3545; 
Â Â Â Â Â  color: white; 
Â Â Â Â Â  border-radius: 8px; 
Â Â Â Â Â  font-size: 15px; 
Â Â Â Â Â  font-weight: 600; 
Â Â Â Â Â  text-align: center;
Â Â Â  }


Â Â Â  /* Modal Styling */
Â Â Â  .modal-overlay {
Â Â Â Â Â  position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
Â Â Â Â Â  background: rgba(0,0,0,0.7); z-index: 9999; display: none;
Â Â Â Â Â  justify-content: center; align-items: center; padding: 20px;
Â Â Â Â Â  animation: fadeIn 0.3s;
Â Â Â  }
Â Â Â  .modal-content {
Â Â Â Â Â  background: #fff; border-radius: 12px; padding: 20px;
Â Â Â Â Â  width: 100%; max-width: 450px; 
Â Â Â Â Â  max-height: 90vh; 
Â Â Â Â Â  overflow-y: auto; 
Â Â Â Â Â  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
Â Â Â Â Â  animation: slideIn 0.3s;
Â Â Â  }
Â Â Â  .modal-content h3 {
Â Â Â Â Â  margin-top: 0; color: var(--green); font-size: 20px; text-align: center;
Â Â Â  }
Â Â Â  #modal-text {
Â Â Â Â Â  white-space: pre-wrap; 
Â Â Â Â Â  font-family: monospace;
Â Â Â Â Â  font-size: 14px;
Â Â Â Â Â  background: #f8f9fa;
Â Â Â Â Â  padding: 10px;
Â Â Â Â Â  border-radius: 6px;
Â Â Â Â Â  border: 1px solid #ddd;
Â Â Â Â Â  margin-bottom: 15px;
Â Â Â Â Â  overflow-x: auto; /* ThÃªm scroll ngang náº¿u ná»™i dung quÃ¡ dÃ i */
Â Â Â  }
Â Â Â  .modal-actions {
Â Â Â Â Â  display: flex; gap: 10px;
Â Â Â  }
Â Â Â  .modal-actions button {
Â Â Â Â Â  flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer;
Â Â Â  }
Â Â Â  #copyModalBtn { background: #ffc107; color: #333; } 
Â Â Â  #zaloModalBtn { background: #0068ff; color: #fff; }
Â Â Â  #closeModalBtn { background: #ccc; color: #333; }
Â Â Â  
Â Â Â  /* Phone Modal Styles */
Â Â Â  #phoneModal .modal-content { background: #f8d7da; border: 1px solid #f5c6cb; }
Â Â Â  #phoneModal h3 { color: #721c24; }
Â Â Â  #phoneModal #inputPhoneForBooking { margin-top: 15px; }
Â Â Â  #phoneModal #confirmPhoneBtn { background: #007bff; color: white; } 

Â Â Â  /* Deposit Modal Styles */
Â Â Â  #depositModal .modal-content { background: #d4edda; border: 1px solid #c3e6cb; }
Â Â Â  #depositModal h3 { color: #155724; }
Â Â Â  #depositModal p { margin-bottom: 15px; }
Â Â Â  #depositModal #depositAmount { 
Â Â Â Â Â Â Â  font-weight: 800; 
Â Â Â Â Â Â Â  font-size: 20px; 
Â Â Â Â Â Â Â  color: #007bff; 
Â Â Â Â Â Â Â  background: #fff;
Â Â Â Â Â Â Â  padding: 5px 10px;
Â Â Â Â Â Â Â  border-radius: 5px;
Â Â Â Â Â Â Â  display: inline-block;
Â Â Â  }
Â Â Â  #depositModal #confirmDepositBtn { background: var(--green); color: white; }
Â Â Â  
Â Â Â  /* NEW: Driver Select Styling */
Â Â Â  #driverRequest {
Â Â Â Â Â Â Â  font-size: 18px; /* TÄƒng cá»¡ chá»¯ */
Â Â Â Â Â Â Â  font-weight: 600;
Â Â Â Â Â Â Â  border: 2px solid var(--green); /* Viá»n ná»•i báº­t */
Â Â Â  }
Â Â Â  .driver-option-highlight {
Â Â Â Â Â Â Â  color: red; /* MÃ u Ä‘á» ná»•i báº­t cho TrÆ°á»ng An Driving */
Â Â Â Â Â Â Â  font-weight: 900 !important; /* Äáº£m báº£o ná»•i báº­t */
Â Â Â Â Â Â Â  background-color: #f7f7f7;
Â Â Â  }
Â Â Â  .driver-option-avatar {
Â Â Â Â Â Â Â  margin-right: 5px; 
Â Â Â Â Â Â Â  font-size: 1.1em;
Â Â Â Â Â Â Â  vertical-align: middle;
Â Â Â  } 

Â Â Â  #language-switcher {
Â Â Â Â Â Â Â  margin-top: 8px;
Â Â Â Â Â Â Â  padding: 5px 8px;
Â Â Â Â Â Â Â  border-radius: 6px;
Â Â Â Â Â Â Â  border: 1px solid white;
Â Â Â Â Â Â Â  background: #34c759;
Â Â Â Â Â Â Â  color: white;
Â Â Â Â Â Â Â  font-weight: 600;
Â Â Â Â Â Â Â  font-size: 14px;
Â Â Â  }
    
    /* Loading Overlay Style */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 10000; /* Cao nháº¥t */
        display: flex;
        justify-content: center;
        align-items: center;
    }


Â Â Â  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
Â Â Â  @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } 

Â Â Â  @media(min-width:700px){.container{max-width:720px;margin:0 auto}}
Â  </style>
</head>
<body>
<div id="main-content">
Â  <header>
Â Â Â  <span data-i18n="headerService">ğŸš– Dá»‹ch Vá»¥ Taxi</span><br>
Â Â Â  TrÆ°á»ng An Driving<br>
Â Â Â  <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">â˜ï¸ 0847526893</a>
Â Â Â  <select id="language-switcher">
Â Â Â Â Â Â Â  <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
Â Â Â Â Â Â Â  <option value="en">ğŸ‡¬ğŸ‡§ English</option>
Â Â Â Â Â Â Â  <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
Â Â Â  </select>
Â  </header> 

Â  <div class="container">
Â Â Â  
Â Â Â  <div id="serviceOffNotice" style="display:none;">
Â Â Â Â Â  </div>
Â Â Â  
Â Â Â  <div id="instructionText" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;" data-i18n="statusChecking">
Â Â Â Â Â  ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...
Â Â Â  </div> 

Â Â Â  <div id="booking-form-wrapper"> 
Â Â Â Â Â  <div class="label-row" style="margin-top:6px"><h3 data-i18n="labelPhone">ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)</h3></div>
Â Â Â Â Â  <input id="customerPhone" type="tel" data-i18n-placeholder="placeholderPhone" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel"> 

Â Â Â Â Â  <div class="label-row">
Â Â Â Â Â Â Â  <h3 data-i18n="labelPickup">ğŸ“ Äiá»ƒm Ä‘Ã³n</h3>
Â Â Â Â Â Â Â  <div id="location-status-wrapper">
Â Â Â Â Â Â Â Â Â  <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;" data-i18n="statusLocating">(Äang tÃ¬m vá»‹ trÃ­...)</span>
Â Â Â Â Â Â Â Â Â  <i id="reloadLocationBtn" data-i18n-title="titleReloadLocation" title="Thá»­ láº¥y láº¡i vá»‹ trÃ­">ğŸ”„</i>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â  </div>
Â Â Â Â Â  <div class="input-row">
Â Â Â Â Â Â Â  <input id="pickup" type="text" data-i18n-placeholder="placeholderPickup" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)">
Â Â Â Â Â Â Â  <button class="clear-btn" data-input-id="pickup">âœ–</button> 
Â Â Â Â Â Â Â  <button class="map-btn" id="pick-from-map" data-i18n="btnMap">Báº£n Ä‘á»“</button>
Â Â Â Â Â Â Â  <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
Â Â Â Â Â  </div> 

Â Â Â Â Â  <div class="label-row"><h3 data-i18n="labelTime">ğŸ•’ NgÃ y & Giá» Ä‘Ã³n</h3></div>
Â Â Â Â Â  <input id="pickupDateTime" type="datetime-local"> 

Â Â Â Â Â  <div id="stops"></div>
Â Â Â Â Â  <button class="add-stop" id="add-stop-btn" data-i18n="btnAddStop">ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng</button> 

Â Â Â Â Â  <div class="label-row"><h3 data-i18n="labelDropoff">ğŸ Äiá»ƒm Ä‘áº¿n</h3></div>
Â Â Â Â Â  <div class="input-row">
Â Â Â Â Â Â Â  <input id="dropoff" type="text" data-i18n-placeholder="placeholderDropoff" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i">
Â Â Â Â Â Â Â  <button class="clear-btn" data-input-id="dropoff">âœ–</button> 
Â Â Â Â Â Â Â  <button class="map-btn" id="pick-to-map" data-i18n="btnMap">Báº£n Ä‘á»“</button>
Â Â Â Â Â Â Â  <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
Â Â Â Â Â  </div>
Â Â Â Â Â  
Â Â Â Â Â  <div class="label-row"><h3 data-i18n="labelCarType">ğŸš˜ Loáº¡i xe</h3></div>
Â Â Â Â Â  <select id="carType">
Â Â Â Â Â Â Â  <option value="4 chá»— (10.000Ä‘/km)" data-i18n="car4seater">Xe 4 chá»— (10.000Ä‘/km)</option> 
Â Â Â Â Â Â Â  <option value="7 chá»— (12.000Ä‘/km)" data-i18n="car7seater">Xe 7 chá»— (12.000Ä‘/km)</option> 
Â Â Â Â Â  </select>
Â Â Â Â Â  
Â Â Â Â Â  <div class="label-row">
Â Â Â Â Â Â Â  <h3 data-i18n="labelDriverRequest">
Â Â Â Â Â Â Â Â Â Â Â  ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿ 
Â Â Â Â Â Â Â Â Â Â Â  <span class="driver-option-avatar" data-i18n-title="titleDriverIcon" title="Icon nÃ y cÃ³ thá»ƒ thay báº±ng Avatar">ğŸ‘¤</span>
Â Â Â Â Â Â Â  </h3>
Â Â Â Â Â  </div>
Â Â Â Â Â  <select id="driverRequest">
Â Â Â Â Â Â Â  <option value="TrÆ°á»ng An Driving" class="driver-option-highlight" data-i18n="driverDefault">
Â Â Â Â Â Â Â Â Â Â Â  â­ TrÆ°á»ng An Driving (Máº·c Ä‘á»‹nh)
Â Â Â Â Â Â Â  </option>
Â Â Â Â Â Â Â  <option value="Thanh Loan">ğŸ‘¸ Thanh Loan</option>
Â Â Â Â Â Â Â  <option value="ÄÃ¬nh TÃ¢m">ğŸ§‘â€âœˆï¸ ÄÃ¬nh TÃ¢m</option>
Â Â Â Â Â Â Â  <option value="Háº£i ÄÄƒng">ğŸ§‘â€âœˆï¸ Háº£i ÄÄƒng</option>
Â Â Â Â Â Â Â  <option value="LÃª TÃ¢m">ğŸ§‘â€âœˆï¸ LÃª TÃ¢m</option>
Â Â Â Â Â Â Â  <option value="Nguyá»…n Tháº£o">ğŸ‘¸ Nguyá»…n Tháº£o</option>
Â Â Â Â Â Â Â  <option value="Quá»‘c DÅ©ng">ğŸ§‘â€âœˆï¸ Quá»‘c DÅ©ng</option>
Â Â Â Â Â Â Â  <option value="TÃ¢n Há»“">ğŸ§‘â€âœˆï¸ TÃ¢n Há»“</option>
Â Â Â Â Â Â Â  <option value="Tráº§n Vinh">ğŸ§‘â€âœˆï¸ Tráº§n Vinh</option>
Â Â Â Â Â Â Â  <option value="XuÃ¢n Phong">ğŸ§‘â€âœˆï¸ XuÃ¢n Phong</option>
Â Â Â Â Â  </select>
Â Â Â Â Â  <div class="label-row"><h3 data-i18n="labelTripType">ğŸš— Loáº¡i chuyáº¿n Ä‘i</h3></div>
Â Â Â Â Â  <select id="tripType">
Â Â Â Â Â Â Â  <option value="1" data-i18n="tripOneWay">1 chiá»u</option>
Â Â Â Â Â Â Â  <option value="2" data-i18n="tripTwoWay">2 chiá»u (giáº£m 40% chiá»u vá»)</option>
Â Â Â Â Â  </select> 

Â Â Â Â Â  <div id="waitingWrapper"> 
Â Â Â Â Â Â Â  <div class="label-row"><h3 data-i18n="labelWaiting">â³ Thá»i gian chá» (giá»)</h3></div>
Â Â Â Â Â Â Â  <input id="waiting" type="number" min="0" value="0" data-i18n-placeholder="placeholderWaiting" placeholder="Nháº­p sá»‘ giá» chá»">
Â Â Â Â Â  </div> 

Â Â Â Â Â  <button class="calc-btn" id="calc-btn" data-i18n="btnCalculate">ğŸ’° TÃ­nh giÃ¡</button>
Â Â Â  </div> 
Â Â Â  
Â Â Â  <div id="map"></div> 

Â Â Â  <div id="result" class="result-box" style="display:none">
Â Â Â Â Â  <div class="result-row">
Â Â Â Â Â Â Â  <div class="distance-text" id="distanceText"></div>
Â Â Â Â Â  </div> 

Â Â Â Â Â  <div class="price-title" data-i18n="resultPriceTitle">ğŸ’µ GiÃ¡ dá»± kiáº¿n</div>
Â Â Â Â Â  <div class="price-value" id="priceValue">â€” Ä‘</div> 

Â Â Â Â Â  <div class="price-break" id="priceBreak"></div> 

Â Â Â Â Â  <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst"></div>
Â Â Â Â Â  <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo"></div>
Â Â Â  </div> 

Â Â Â  <div class="actions">
Â Â Â Â Â  <a id="zaloBtn" class="zalo-btn" href="javascript:void(0);" style="display:none;" data-i18n="btnBookZalo">ğŸ“± Äáº·t qua Zalo</a>
Â Â Â Â Â  <a id="mailBtn" class="mail" href="javascript:void(0);" style="display:none;" data-i18n="btnBookMail">ğŸ“§ Äáº·t qua Mail</a>
Â Â Â  </div> 

Â Â Â  <div class="note" data-i18n="noteMain">
Â Â Â Â Â  ğŸ“Œ Ghi chÃº: GiÃ¡ 4 chá»—/7 chá»—: **10.000Ä‘/km** / **12.000Ä‘/km**. 2 chiá»u: chiá»u vá» giáº£m 40% (Ã¡p dá»¥ng cho chuyáº¿n 1 chiá»u **â‰¥ 45km**).
Â Â Â Â Â  <br>
Â Â Â Â Â  **Thá»i gian chá»:**
Â Â Â Â Â  <ul>
Â Â Â Â Â Â Â  <li>Chá» 0â€“3 giá»: **Miá»…n phÃ­**.</li>
Â Â Â Â Â Â Â  <li>Ká»ƒ tá»« giá» thá»© 4, má»—i giá» tiáº¿p theo phÃ¡t sinh phá»¥ phÃ­ **50.000 VNÄ/giá»**.</li>
Â Â Â Â Â Â Â  <li>Thá»i gian chá» Ä‘Æ°á»£c tÃ­nh tá»« khi hÃ nh khÃ¡ch **hoÃ n táº¥t viá»‡c xuá»‘ng xe táº¡i Ä‘iá»ƒm Ä‘áº¿n** cho Ä‘áº¿n khi xe quay trá»Ÿ láº¡i Ä‘Ã³n Ä‘á»ƒ vá» Ä‘iá»ƒm xuáº¥t phÃ¡t ban Ä‘áº§u.</li>
Â Â Â Â Â  </ul>
Â Â Â Â Â  GiÃ¡ Ä‘Ã£ bao gá»“m phÃ­ cáº§u Ä‘Æ°á»ng.
Â Â Â  </div>
Â  </div>
</div> 

<div id="depositModal" class="modal-overlay" style="display:none;">
Â Â Â  <div class="modal-content">
Â Â Â Â Â Â Â  <h3 data-i18n="modalDepositTitle">ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u</h3>
Â Â Â Â Â Â Â  <p data-i18n="modalDepositNotice1">
Â Â Â Â Â Â Â Â Â Â Â  **QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:**<br>
Â Â Â Â Â Â Â Â Â Â Â  Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i **Hai chiá»u** cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch **Ä‘áº·t cá»c trÆ°á»›c 20%** trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.
Â Â Â Â Â Â Â  </p>
Â Â Â Â Â Â Â  <p style="text-align:center; font-size:18px;">
Â Â Â Â Â Â Â Â Â Â Â  <span data-i18n="modalDepositAmountText">Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n:</span> <span id="depositAmount">0 Ä‘</span>
Â Â Â Â Â Â Â  </p>
Â Â Â Â Â Â Â  <p data-i18n="modalDepositNotice2">
Â Â Â Â Â Â Â Â Â Â Â  Khi nhÃ¢n viÃªn **TrÆ°á»ng An Driving** pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i **hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ** (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.
Â Â Â Â Â Â Â  </p>
Â Â Â Â Â Â Â  <p style="font-size:14px; color:#555;" data-i18n="modalDepositNote">
Â Â Â Â Â Â Â Â Â Â Â  **LÆ°u Ã½:** Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i.
Â Â Â Â Â Â Â Â Â Â Â  Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.
Â Â Â Â Â Â Â  </p>
Â Â Â Â Â Â Â  <div class="modal-actions" style="margin-top:10px;">
Â Â Â Â Â Â Â Â Â Â Â  <button id="confirmDepositBtn" style="width:100%;" data-i18n="modalDepositConfirm">ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c</button>
Â Â Â Â Â Â Â  </div>
Â Â Â  </div>
</div> 

<div id="phoneModal" class="modal-overlay" style="display:none;">
Â Â Â  <div class="modal-content">
Â Â Â Â Â Â Â  <h3 data-i18n="modalPhoneTitle">ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i</h3>
Â Â Â Â Â Â Â  <p style="text-align:center;" data-i18n="modalPhoneNotice">QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.</p>
Â Â Â Â Â Â Â  <input id="inputPhoneForBooking" type="tel" data-i18n-placeholder="placeholderPhone" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel" required>
Â Â Â Â Â Â Â  <div class="modal-actions" style="margin-top:15px;">
Â Â Â Â Â Â Â Â Â Â Â  <button id="confirmPhoneBtn" data-i18n="modalPhoneConfirm">XÃ¡c nháº­n</button> 
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  <button id="closePhoneModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; background:#ccc; color:#333;" data-i18n="modalClose">ÄÃ³ng</button>
Â Â Â  </div>
</div> 

<div id="zaloModal" class="modal-overlay" style="display:none;">
Â Â Â  <div class="modal-content">
Â Â Â Â Â Â Â  <h3 data-i18n="modalBookingTitle">âœ… THÃ”NG TIN Äáº¶T XE</h3>
Â Â Â Â Â Â Â  <p style="text-align:center; font-size:15px; font-weight:600;" data-i18n="modalBookingNotice">Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:</p>
Â Â Â Â Â Â Â  <pre id="modal-text"></pre>
Â Â Â Â Â Â Â  <div class="modal-actions">
Â Â Â Â Â Â Â Â Â Â Â  <button id="copyModalBtn" data-i18n="modalBtnCopy">ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin</button> 
Â Â Â Â Â Â Â Â Â Â Â  <button id="zaloModalBtn" data-i18n="modalBtnZalo">ğŸ“± Má»Ÿ Zalo Chat</button>
Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;" data-i18n="modalClose">ÄÃ³ng</button>
Â Â Â  </div>
</div> 

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div> 

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- I18N CONFIGURATION START ---------- */
const i18n = {
    vi: {
        appTitle: "ğŸš– Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving",
        headerService: "ğŸš– Dá»‹ch Vá»¥ Taxi",
        statusChecking: "ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...",
        statusActive: 'ğŸ’° Báº¥m "TÃ­nh giÃ¡" Ä‘á»ƒ xem chi tiáº¿t Ä‘áº·t xe.',
        statusLocating: "(Äang tÃ¬m vá»‹ trÃ­...)",
        titleReloadLocation: "Thá»­ láº¥y láº¡i vá»‹ trÃ­",
        
        // Form Labels & Placeholders
        labelPhone: "ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)",
        placeholderPhone: "Nháº­p SÄT (10 sá»‘, VD: 0987654321)",
        labelPickup: "ğŸ“ Äiá»ƒm Ä‘Ã³n",
        placeholderPickup: "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)",
        labelTime: "ğŸ•’ NgÃ y & Giá» Ä‘Ã³n",
        btnAddStop: "ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng",
        labelDropoff: "ğŸ Äiá»ƒm Ä‘áº¿n",
        placeholderDropoff: "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i",
        labelCarType: "ğŸš˜ Loáº¡i xe",
        car4seater: "Xe 4 chá»— (10.000Ä‘/km)",
        car7seater: "Xe 7 chá»— (12.000Ä‘/km)",
        labelDriverRequest: "ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿",
        titleDriverIcon: "Icon nÃ y cÃ³ thá»ƒ thay báº±ng Avatar",
        driverDefault: "â­ TrÆ°á»ng An Driving (Máº·c Ä‘á»‹nh)",
        labelTripType: "ğŸš— Loáº¡i chuyáº¿n Ä‘i",
        tripOneWay: "1 chiá»u",
        tripTwoWay: "2 chiá»u (giáº£m 40% chiá»u vá»)",
        labelWaiting: "â³ Thá»i gian chá» (giá»)",
        placeholderWaiting: "Nháº­p sá»‘ giá» chá»",
        btnCalculate: "ğŸ’° TÃ­nh giÃ¡",
        btnMap: "Báº£n Ä‘á»“",
        
        // Calculation Status & Results
        statusCalculating: "Äang tÃ­nh toÃ¡n...",
        statusCalculatingRoute: "Äang tÃ­nh lá»™ trÃ¬nh...",
        statusNoRoute: "KhÃ´ng tÃ­nh Ä‘Æ°á»£c lá»™ trÃ¬nh",
        statusNoCoord: "KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ Äiá»ƒm ", // + 'Ä‘Ã³n'/'Ä‘áº¿n'
        resultPriceTitle: "ğŸ’µ GiÃ¡ dá»± kiáº¿n",
        resultDistance: "âœï¸ QuÃ£ng Ä‘Æ°á»ng:",
        resultTimeEst: "â± Thá»i gian dá»± kiáº¿n:",
        resultPickupTime: "ğŸ•’ NgÃ y giá» Ä‘Ã³n:",
        
        // Notes
        noteMain: `ğŸ“Œ Ghi chÃº: GiÃ¡ 4 chá»—/7 chá»—: **10.000Ä‘/km** / **12.000Ä‘/km**. 2 chiá»u: chiá»u vá» giáº£m 40% (Ã¡p dá»¥ng cho chuyáº¿n 1 chiá»u **â‰¥ 45km**).
Â Â Â Â Â  <br>
Â Â Â Â Â  **Thá»i gian chá»:**
Â Â Â Â Â  <ul>
Â Â Â Â Â Â Â  <li>Chá» 0â€“3 giá»: **Miá»…n phÃ­**.</li>
Â Â Â Â Â Â Â  <li>Ká»ƒ tá»« giá» thá»© 4, má»—i giá» tiáº¿p theo phÃ¡t sinh phá»¥ phÃ­ **50.000 VNÄ/giá»**.</li>
Â Â Â Â Â Â Â  <li>Thá»i gian chá» Ä‘Æ°á»£c tÃ­nh tá»« khi hÃ nh khÃ¡ch **hoÃ n táº¥t viá»‡c xuá»‘ng xe táº¡i Ä‘iá»ƒm Ä‘áº¿n** cho Ä‘áº¿n khi xe quay trá»Ÿ láº¡i Ä‘Ã³n Ä‘á»ƒ vá» Ä‘iá»ƒm xuáº¥t phÃ¡t ban Ä‘áº§u.</li>
Â Â Â Â Â  </ul>
Â Â Â Â Â  GiÃ¡ Ä‘Ã£ bao gá»“m phÃ­ cáº§u Ä‘Æ°á»ng.`,

        // Booking Buttons
        btnBookZalo: "ğŸ“± Äáº·t qua Zalo",
        btnBookMail: "ğŸ“§ Äáº·t qua Mail",

        // Modals
        modalClose: "ÄÃ³ng",
        modalBookingTitle: "âœ… THÃ”NG TIN Äáº¶T XE",
        modalBookingNotice: "Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:",
        modalBtnCopy: "ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin",
        modalBtnZalo: "ğŸ“± Má»Ÿ Zalo Chat",

        // Phone Modal
        modalPhoneTitle: "ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i",
        modalPhoneNotice: "QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.",
        modalPhoneConfirm: "XÃ¡c nháº­n",

        // Deposit Modal
        modalDepositTitle: "ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u",
        modalDepositNotice1: "**QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:**<br>Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i **Hai chiá»u** cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch **Ä‘áº·t cá»c trÆ°á»›c 20%** trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.",
        modalDepositAmountText: "Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n:",
        modalDepositNotice2: "Khi nhÃ¢n viÃªn **TrÆ°á»ng An Driving** pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i **hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ** (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.",
        modalDepositNote: "**LÆ°u Ã½:** Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i. Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.",
        modalDepositConfirm: "ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c",

        // Geolocation Errors
        errorNetwork: "âš ï¸ Thiáº¿t bá»‹ Ä‘ang OFFLINE hoáº·c Lá»–I Káº¾T Ná»I. KhÃ´ng thá»ƒ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.",
        errorTimeout: "âš ï¸ Kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥ quÃ¡ lÃ¢u. Viá»‡c Ä‘áº·t xe bá»‹ táº¡m ngÆ°ng.",
        errorServiceFetch: "âš ï¸ Cáº¢NH BÃO Máº NG: KhÃ´ng tÃ¬m tháº¥y file tráº¡ng thÃ¡i dá»‹ch vá»¥ (404/Server Error). Chá»©c nÄƒng Ä‘áº·t xe bá»‹ táº¡m ngÆ°ng.",
        errorLocating: "âš ï¸ Lá»—i tÃ¬m vá»‹ trÃ­. Nháº­p thá»§ cÃ´ng.",
        errorDenied: "âŒ Bá»‹ tá»« chá»‘i quyá»n truy cáº­p vá»‹ trÃ­.",
        errorUnavailable: "âŒ Vá»‹ trÃ­ khÃ´ng kháº£ dá»¥ng (Báº­t GPS).",
        errorTimeoutLoc: "âš ï¸ Háº¿t thá»i gian tÃ¬m vá»‹ trÃ­.",
        errorNotSupported: "âŒ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Geolocation.",
        statusLocated: "âœ… ÄÃ£ tÃ¬m tháº¥y vá»‹ trÃ­",
        statusPopup: "ğŸ“ Vá»‹ trÃ­ hiá»‡n táº¡i",
        mapPopupPickup: "ğŸ“ Äiá»ƒm Ä‘Ã³n",
        mapPopupDropoff: "ğŸ Äiá»ƒm Ä‘áº¿n",
        mapPopupStop: "ğŸ“ Äiá»ƒm dá»«ng",
        alertPickup: 'âŒ Vui lÃ²ng nháº­p Äá»‹a chá»‰ Äiá»ƒm Ä‘Ã³n.',
        alertDropoff: 'âŒ Vui lÃ²ng nháº­p Äá»‹a chá»‰ Äiá»ƒm Ä‘áº¿n.',
        alertWaiting: 'âŒ VÃ¬ báº¡n chá»n chuyáº¿n 2 chiá»u, vui lÃ²ng nháº­p Thá»i gian chá» (sá»‘ giá») Ä‘á»ƒ chÃºng tÃ´i sáº¯p xáº¿p xe. GiÃ¡ trá»‹ pháº£i â‰¥ 0.',
        alertNoCoord: 'KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™. HÃ£y chá»n gá»£i Ã½ hoáº·c Ä‘áº·t trÃªn báº£n Ä‘á»“.',
        alertNoStopCoord: 'KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ cho má»™t Äiá»ƒm dá»«ng.',
        alertNoSuggestions: 'KhÃ´ng tÃ¬m tháº¥y Ä‘á»‹a Ä‘iá»ƒm',
        alertSearching: 'Äang tÃ¬m kiáº¿m...',
        alertMapPickPickup: 'Báº¥m vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n Ä‘iá»ƒm Ä‘Ã³n',
        alertMapPickDropoff: 'Báº¥m vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n Ä‘iá»ƒm Ä‘áº¿n',
        
    },
    en: {
        appTitle: "ğŸš– Truong An Driving Taxi Service",
        headerService: "ğŸš– Taxi Service",
        statusChecking: "ğŸ’° Checking service status...",
        statusActive: 'ğŸ’° Click "Calculate Price" for booking details.',
        statusLocating: "(Locating...)",
        titleReloadLocation: "Try to get location again",

        // Form Labels & Placeholders
        labelPhone: "ğŸ“ Your Phone Number (Optional for Price Calculation)",
        placeholderPhone: "Enter Phone No. (10 digits, e.g.: 0987654321)",
        labelPickup: "ğŸ“ Pickup Location",
        placeholderPickup: "Enter pickup address (or auto-locate)",
        labelTime: "ğŸ•’ Pickup Date & Time",
        btnAddStop: "ï¼‹ Add Stopover",
        labelDropoff: "ğŸ Drop-off Location",
        placeholderDropoff: "Enter final drop-off address",
        labelCarType: "ğŸš˜ Car Type",
        car4seater: "4 Seater (10,000Ä‘/km)",
        car7seater: "7 Seater (12,000Ä‘/km)",
        labelDriverRequest: "ğŸ§‘â€âœˆï¸ Driver Request",
        titleDriverIcon: "This icon can be replaced by an Avatar",
        driverDefault: "â­ Truong An Driving (Default)",
        labelTripType: "ğŸš— Trip Type",
        tripOneWay: "One-Way",
        tripTwoWay: "Two-Way (40% off return trip)",
        labelWaiting: "â³ Waiting Time (hours)",
        placeholderWaiting: "Enter waiting time in hours",
        btnCalculate: "ğŸ’° Calculate Price",
        btnMap: "Map",
        
        // Calculation Status & Results
        statusCalculating: "Calculating...",
        statusCalculatingRoute: "Calculating route...",
        statusNoRoute: "Could not calculate route",
        statusNoCoord: "Could not find coordinates for ", // + 'Pickup'/'Drop-off'
        resultPriceTitle: "ğŸ’µ Estimated Price",
        resultDistance: "âœï¸ Distance:",
        resultTimeEst: "â± Estimated Time:",
        resultPickupTime: "ğŸ•’ Pickup Date & Time:",

        // Notes
        noteMain: `ğŸ“Œ Note: Price 4-seater/7-seater: **10,000 VND/km** / **12,000 VND/km**. Two-way trip: 40% off return leg (applies to one-way trips **â‰¥ 45km**).
Â Â Â Â Â  <br>
Â Â Â Â Â  **Waiting Time:**
Â Â Â Â Â  <ul>
Â Â Â Â Â Â Â  <li>0â€“3 hours waiting: **Free**.</li>
Â Â Â Â Â Â Â  <li>From the 4th hour onwards, a surcharge of **50,000 VND/hour** applies.</li>
Â Â Â Â Â Â Â  <li>Waiting time is calculated from when the passenger **completes drop-off at the destination** until the car returns to pick up for the original starting point.</li>
Â Â Â Â Â  </ul>
Â Â Â Â Â  Price includes all road/toll fees.`,

        // Booking Buttons
        btnBookZalo: "ğŸ“± Book via Zalo",
        btnBookMail: "ğŸ“§ Book via Mail",

        // Modals
        modalClose: "Close",
        modalBookingTitle: "âœ… BOOKING INFORMATION",
        modalBookingNotice: "Copy the information and send via Zalo:",
        modalBtnCopy: "ğŸ“‹ Copy Information",
        modalBtnZalo: "ğŸ“± Open Zalo Chat",

        // Phone Modal
        modalPhoneTitle: "ğŸ“ Please Enter Your Phone Number",
        modalPhoneNotice: "Please enter your phone number so we can contact you to confirm the order.",
        modalPhoneConfirm: "Confirm",

        // Deposit Modal
        modalDepositTitle: "ğŸ“ Deposit Required for Two-Way Trip",
        modalDepositNotice1: "**Dear customer, please note:**<br>To confirm and ensure service quality for your **Two-way** trip, we kindly request a **20% deposit** on the estimated total fare.",
        modalDepositAmountText: "Estimated deposit amount:",
        modalDepositNotice2: "When a **Truong An Driving** staff member responds via Zalo, we will send **specific payment instructions** (bank transfer) to finalize the deposit.",
        modalDepositNote: "**Note:** The remaining fare will be paid directly to the driver after the trip is completed. Thank you for trusting our service.",
        modalDepositConfirm: "I Understand and Continue",

        // Geolocation Errors
        errorNetwork: "âš ï¸ Device is OFFLINE or CONNECTION ERROR. Order confirmation is not possible.",
        errorTimeout: "âš ï¸ Service status check took too long. Booking is temporarily suspended.",
        errorServiceFetch: "âš ï¸ NETWORK WARNING: Service status file not found (404/Server Error). Booking functionality is suspended.",
        errorLocating: "âš ï¸ Location search error. Please enter manually.",
        errorDenied: "âŒ Location access permission denied.",
        errorUnavailable: "âŒ Location unavailable (Turn on GPS).",
        errorTimeoutLoc: "âš ï¸ Location search timed out.",
        errorNotSupported: "âŒ Browser does not support Geolocation.",
        statusLocated: "âœ… Location found",
        statusPopup: "ğŸ“ Current Location",
        mapPopupPickup: "ğŸ“ Pickup Point",
        mapPopupDropoff: "ğŸ Drop-off Point",
        mapPopupStop: "ğŸ“ Stopover Point",
        alertPickup: 'âŒ Please enter the Pickup address.',
        alertDropoff: 'âŒ Please enter the Drop-off address.',
        alertWaiting: 'âŒ Since you chose a two-way trip, please enter the Waiting Time (hours) for us to arrange the car. Value must be â‰¥ 0.',
        alertNoCoord: 'Coordinates not found. Please choose a suggestion or set on the map.',
        alertNoStopCoord: 'Coordinates not found for a Stopover.',
        alertNoSuggestions: 'No locations found',
        alertSearching: 'Searching...',
        alertMapPickPickup: 'Click on the map to select the pickup point',
        alertMapPickDropoff: 'Click on the map to select the drop-off point',
    },
    zh: {
        appTitle: "ğŸš– é•¿å®‰é©¾é©¶å‡ºç§Ÿè½¦æœåŠ¡",
        headerService: "ğŸš– å‡ºç§Ÿè½¦æœåŠ¡",
        statusChecking: "ğŸ’° æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...",
        statusActive: 'ğŸ’° ç‚¹å‡»â€œè®¡ç®—ä»·æ ¼â€æŸ¥çœ‹é¢„è®¢è¯¦æƒ…ã€‚',
        statusLocating: "(æ­£åœ¨å®šä½...)",
        titleReloadLocation: "å°è¯•é‡æ–°è·å–ä½ç½®",

        // Form Labels & Placeholders
        labelPhone: "ğŸ“ æ‚¨çš„ç”µè¯å·ç  (è®¡ç®—ä»·æ ¼å¯é€‰)",
        placeholderPhone: "è¾“å…¥ç”µè¯å·ç  (10ä½ï¼Œä¾‹å¦‚ï¼š0987654321)",
        labelPickup: "ğŸ“ ä¸Šè½¦åœ°ç‚¹",
        placeholderPickup: "è¾“å…¥ä¸Šè½¦åœ°å€ (æˆ–è‡ªåŠ¨å®šä½)",
        labelTime: "ğŸ•’ ä¸Šè½¦æ—¥æœŸå’Œæ—¶é—´",
        btnAddStop: "ï¼‹ æ·»åŠ ç»åœç‚¹",
        labelDropoff: "ğŸ ç›®çš„åœ°",
        placeholderDropoff: "è¾“å…¥æœ€ç»ˆç›®çš„åœ°åœ°å€",
        labelCarType: "ğŸš˜ è½¦å‹",
        car4seater: "4åº§è½¦ (10,000Ä‘/å…¬é‡Œ)",
        car7seater: "7åº§è½¦ (12,000Ä‘/å…¬é‡Œ)",
        labelDriverRequest: "ğŸ§‘â€âœˆï¸ å¸æœºè¦æ±‚",
        titleDriverIcon: "æ­¤å›¾æ ‡å¯æ›¿æ¢ä¸ºå¤´åƒ",
        driverDefault: "â­ é•¿å®‰é©¾é©¶ (é»˜è®¤)",
        labelTripType: "ğŸš— è¡Œç¨‹ç±»å‹",
        tripOneWay: "å•ç¨‹",
        tripTwoWay: "åŒç¨‹ (è¿”ç¨‹å‡40%)",
        labelWaiting: "â³ ç­‰å¾…æ—¶é—´ (å°æ—¶)",
        placeholderWaiting: "è¾“å…¥ç­‰å¾…æ—¶é—´(å°æ—¶)",
        btnCalculate: "ğŸ’° è®¡ç®—ä»·æ ¼",
        btnMap: "åœ°å›¾",
        
        // Calculation Status & Results
        statusCalculating: "æ­£åœ¨è®¡ç®—...",
        statusCalculatingRoute: "æ­£åœ¨è®¡ç®—è·¯çº¿...",
        statusNoRoute: "æ— æ³•è®¡ç®—è·¯çº¿",
        statusNoCoord: "æ‰¾ä¸åˆ°åæ ‡ï¼š", // + 'ä¸Šè½¦'/'ç›®çš„åœ°'
        resultPriceTitle: "ğŸ’µ é¢„è®¡ä»·æ ¼",
        resultDistance: "âœï¸ è·ç¦»:",
        resultTimeEst: "â± é¢„è®¡æ—¶é—´:",
        resultPickupTime: "ğŸ•’ ä¸Šè½¦æ—¥æœŸå’Œæ—¶é—´:",

        // Notes
        noteMain: `ğŸ“Œ æ³¨æ„ï¼š4åº§/7åº§è½¦ä»·æ ¼: **10,000 è¶Šå—ç›¾/å…¬é‡Œ** / **12,000 è¶Šå—ç›¾/å…¬é‡Œ**ã€‚åŒç¨‹: è¿”ç¨‹å‡40% (é€‚ç”¨äºå•ç¨‹ **â‰¥ 45å…¬é‡Œ**)ã€‚
Â Â Â Â Â  <br>
Â Â Â Â Â  **ç­‰å¾…æ—¶é—´:**
Â Â Â Â Â  <ul>
Â Â Â Â Â Â Â  <li>ç­‰å¾… 0â€“3 å°æ—¶: **å…è´¹**ã€‚</li>
Â Â Â Â Â Â Â  <li>ä»ç¬¬4å°æ—¶èµ·ï¼Œæ¯å°æ—¶åŠ æ”¶ **50,000 è¶Šå—ç›¾/å°æ—¶**ã€‚</li>
Â Â Â Â Â Â Â  <li>ç­‰å¾…æ—¶é—´ä»ä¹˜å®¢åœ¨**ç›®çš„åœ°å®Œæˆä¸‹è½¦**å¼€å§‹è®¡ç®—ï¼Œç›´åˆ°è½¦è¾†è¿”å›æ¥ä¹˜å®¢å›åˆ°æœ€åˆçš„èµ·ç‚¹ã€‚</li>
Â Â Â Â Â  </ul>
Â Â Â Â Â  ä»·æ ¼å·²åŒ…å«æ‰€æœ‰è¿‡è·¯/è¿‡æ¡¥è´¹ã€‚`,

        // Booking Buttons
        btnBookZalo: "ğŸ“± é€šè¿‡ Zalo é¢„è®¢",
        btnBookMail: "ğŸ“§ é€šè¿‡é‚®ä»¶é¢„è®¢",

        // Modals
        modalClose: "å…³é—­",
        modalBookingTitle: "âœ… é¢„è®¢ä¿¡æ¯",
        modalBookingNotice: "å¤åˆ¶ä¿¡æ¯å¹¶é€šè¿‡ Zalo å‘é€:",
        modalBtnCopy: "ğŸ“‹ å¤åˆ¶ä¿¡æ¯",
        modalBtnZalo: "ğŸ“± æ‰“å¼€ Zalo èŠå¤©",

        // Phone Modal
        modalPhoneTitle: "ğŸ“ è¯·è¾“å…¥ç”µè¯å·ç ",
        modalPhoneNotice: "è¯·è¾“å…¥æ‚¨çš„ç”µè¯å·ç ï¼Œä»¥ä¾¿æˆ‘ä»¬è”ç³»æ‚¨ç¡®è®¤è®¢å•ã€‚",
        modalPhoneConfirm: "ç¡®è®¤",

        // Deposit Modal
        modalDepositTitle: "ğŸ“ åŒç¨‹æ—…è¡Œéœ€æ”¯ä»˜æŠ¼é‡‘",
        modalDepositNotice1: "**å°Šæ•¬çš„å®¢æˆ·ï¼Œè¯·æ³¨æ„:**<br>ä¸ºç¡®è®¤å¹¶ç¡®ä¿æ‚¨**åŒç¨‹**æ—…è¡Œçš„æœåŠ¡è´¨é‡ï¼Œæˆ‘ä»¬æ³è¯·æ‚¨é¢„å…ˆæ”¯ä»˜é¢„ä¼°æ€»è´¹ç”¨çš„ **20% æŠ¼é‡‘**ã€‚",
        modalDepositAmountText: "é¢„è®¡æŠ¼é‡‘é‡‘é¢:",
        modalDepositNotice2: "å½“ **é•¿å®‰é©¾é©¶** å‘˜å·¥é€šè¿‡ Zalo å›å¤æ‚¨æ—¶ï¼Œæˆ‘ä»¬å°†å‘é€**å…·ä½“çš„ä»˜æ¬¾æŒ‡ç¤º** (é“¶è¡Œè½¬è´¦) ä»¥å®ŒæˆæŠ¼é‡‘æ‰‹ç»­ã€‚",
        modalDepositNote: "**æ³¨æ„:** å‰©ä½™è½¦è´¹å°†åœ¨è¡Œç¨‹ç»“æŸåç›´æ¥æ”¯ä»˜ç»™å¸æœºã€‚è¡·å¿ƒæ„Ÿè°¢æ‚¨å¯¹æˆ‘ä»¬æœåŠ¡çš„ä¿¡ä»»ã€‚",
        modalDepositConfirm: "æˆ‘å·²äº†è§£å¹¶ç»§ç»­",

        // Geolocation Errors
        errorNetwork: "âš ï¸ è®¾å¤‡å¤„äºç¦»çº¿çŠ¶æ€æˆ–è¿æ¥é”™è¯¯ã€‚æ— æ³•ç¡®è®¤è®¢å•ã€‚",
        errorTimeout: "âš ï¸ æœåŠ¡çŠ¶æ€æ£€æŸ¥è¶…æ—¶ã€‚é¢„è®¢æš‚æ—¶åœæ­¢ã€‚",
        errorServiceFetch: "âš ï¸ ç½‘ç»œè­¦å‘Šï¼šæ‰¾ä¸åˆ°æœåŠ¡çŠ¶æ€æ–‡ä»¶ (404/æœåŠ¡å™¨é”™è¯¯)ã€‚é¢„è®¢åŠŸèƒ½å·²æš‚åœã€‚",
        errorLocating: "âš ï¸ å®šä½é”™è¯¯ã€‚è¯·æ‰‹åŠ¨è¾“å…¥ã€‚",
        errorDenied: "âŒ ä½ç½®è®¿é—®æƒé™è¢«æ‹’ç»ã€‚",
        errorUnavailable: "âŒ ä½ç½®ä¸å¯ç”¨ (è¯·æ‰“å¼€GPS)ã€‚",
        errorTimeoutLoc: "âš ï¸ ä½ç½®æœç´¢è¶…æ—¶ã€‚",
        errorNotSupported: "âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½ã€‚",
        statusLocated: "âœ… å·²æ‰¾åˆ°ä½ç½®",
        statusPopup: "ğŸ“ å½“å‰ä½ç½®",
        mapPopupPickup: "ğŸ“ ä¸Šè½¦ç‚¹",
        mapPopupDropoff: "ğŸ ä¸‹è½¦ç‚¹",
        mapPopupStop: "ğŸ“ ç»åœç‚¹",
        alertPickup: 'âŒ è¯·è¾“å…¥ä¸Šè½¦åœ°å€ã€‚',
        alertDropoff: 'âŒ è¯·è¾“å…¥ç›®çš„åœ°åœ°å€ã€‚',
        alertWaiting: 'âŒ æ‚¨é€‰æ‹©äº†åŒç¨‹æ—…è¡Œï¼Œè¯·è¾“å…¥ç­‰å¾…æ—¶é—´ (å°æ—¶) ä»¥ä¾¿æˆ‘ä»¬å®‰æ’è½¦è¾†ã€‚è¯¥å€¼å¿…é¡» â‰¥ 0ã€‚',
        alertNoCoord: 'æ‰¾ä¸åˆ°åæ ‡ã€‚è¯·é€‰æ‹©å»ºè®®æˆ–åœ¨åœ°å›¾ä¸Šè®¾ç½®ã€‚',
        alertNoStopCoord: 'æ‰¾ä¸åˆ°æŸä¸ªç»åœç‚¹çš„åæ ‡ã€‚',
        alertNoSuggestions: 'æœªæ‰¾åˆ°åœ°ç‚¹',
        alertSearching: 'æ­£åœ¨æœç´¢...',
        alertMapPickPickup: 'ç‚¹å‡»åœ°å›¾é€‰æ‹©ä¸Šè½¦ç‚¹',
        alertMapPickDropoff: 'ç‚¹å‡»åœ°å›¾é€‰æ‹©ä¸‹è½¦ç‚¹',
    }
};

let currentLang = localStorage.getItem('lang') || 'vi';

function updateContent() {
    const translations = i18n[currentLang];
    
    // 1. Update text content
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[key]) {
            element.textContent = translations[key];
        }
    });

    // 2. Update attributes (placeholder, title)
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[key]) {
            element.setAttribute('placeholder', translations[key]);
        }
    });
    
    document.querySelectorAll('[data-i18n-title]').forEach(element => {
        const key = element.getAttribute('data-i18n-title');
        if (translations[key]) {
            element.setAttribute('title', translations[key]);
        }
    });
    
    // 3. Update <title> separately
    const titleEl = document.querySelector('title');
    if (titleEl) {
        const key = titleEl.getAttribute('data-i18n');
        if (translations[key]) {
            titleEl.textContent = translations[key];
        }
    }

    // 4. Update the select options for car type
    document.getElementById('carType').querySelector('option[data-i18n="car4seater"]').textContent = translations.car4seater;
    document.getElementById('carType').querySelector('option[data-i18n="car7seater"]').textContent = translations.car7seater;

    // 5. Update the select options for trip type
    document.getElementById('tripType').querySelector('option[data-i18n="tripOneWay"]').textContent = translations.tripOneWay;
    document.getElementById('tripType').querySelector('option[data-i18n="tripTwoWay"]').textContent = translations.tripTwoWay;

    // 6. Update HTML lang attribute
    document.documentElement.setAttribute('lang', currentLang);

    // 7. Update status/popup texts that are dynamically set elsewhere
    // This is handled in the relevant functions (e.g., getGeolocation, calculateAndGenerateMessage)
    // but we can set the initial state here too.
    document.getElementById('location-status').textContent = translations.statusLocating;
    document.getElementById('instructionText').innerHTML = translations.statusChecking;
    
    // Update placeholder for stop inputs (since they are created dynamically)
    document.querySelectorAll('input[id^="stop-"]').forEach((input, index) => {
        input.setAttribute('placeholder', translations.placeholderPickup.replace('Ä‘iá»ƒm Ä‘Ã³n', 'Ä‘iá»ƒm dá»«ng ' + (index + 1)).replace('pickup address', 'stopover ' + (index + 1)).replace('ä¸Šè½¦åœ°å€', 'ç»åœç‚¹ ' + (index + 1)));
    });
    
}

document.getElementById('language-switcher').addEventListener('change', (e) => {
    currentLang = e.target.value;
    localStorage.setItem('lang', currentLang);
    updateContent();
    // Re-check service status to update instruction text with new language
    checkServiceStatus().then(updateUIBasedOnStatus);
    // Re-validate to update alert messages if a trip is calculated (optional but good practice)
    // calculateAndGenerateMessage(); 
});

// Set initial language in the switcher and update content
document.getElementById('language-switcher').value = currentLang;
updateContent();
/* ---------- I18N CONFIGURATION END ---------- */


/* ---------- Cáº¥u hÃ¬nh Tá»‘i Æ¯u HÃ³a ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving"; 

const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/"; 
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/"; 

const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const driverRequestEl = document.getElementById('driverRequest'); // New Driver Select
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn'); 

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 

const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn'); 

// New Modal DOM
const phoneModal = document.getElementById('phoneModal');
const inputPhoneForBooking = document.getElementById('inputPhoneForBooking');
const confirmPhoneBtn = document.getElementById('confirmPhoneBtn');
const closePhoneModalBtn = document.getElementById('closePhoneModalBtn');
const depositModal = document.getElementById('depositModal');
const depositAmount = document.getElementById('depositAmount');
const confirmDepositBtn = document.getElementById('confirmDepositBtn'); 

let finalZaloMessage = ''; 
let finalTotalFee = 0; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;
let bookingAction = null; // 'zalo' or 'mail' 

/* ---------- TÃN HIá»†U KILL SWITCH (Polling) ---------- */ 

async function checkServiceStatus() {
Â Â Â  const cacheBuster = `?t=${Date.now()}`; 
Â Â Â  const finalUrl = REMOTE_STATUS_URL + cacheBuster; 

Â Â Â  try {
Â Â Â Â Â Â Â  const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  if (!response.ok) {
Â Â Â Â Â Â Â Â Â Â Â  return { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  active: false, 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  message_vn: i18n[currentLang].errorServiceFetch
Â Â Â Â Â Â Â Â Â Â Â  };
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  const data = await response.json();
        // Use the current language version of the message
        let statusMessage = data[`message_${currentLang}`] || data.message_vn;
Â Â Â Â Â Â Â  return { active: data.active, message_vn: statusMessage };
Â Â Â  } catch (error) {
Â Â Â Â Â Â Â  let msg = i18n[currentLang].errorNetwork;
Â Â Â Â Â Â Â  if (error.name === 'TimeoutError') {
Â Â Â Â Â Â Â Â Â Â Â Â  msg = i18n[currentLang].errorTimeout;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  console.error("Lá»—i khi fetch tráº¡ng thÃ¡i dá»‹ch vá»¥:", error);
Â Â Â Â Â Â Â  return { 
Â Â Â Â Â Â Â Â Â Â Â  active: false, 
Â Â Â Â Â Â Â Â Â Â Â  message_vn: msg
Â Â Â Â Â Â Â  };
Â Â Â  }
}


async function updateUIBasedOnStatus(status) {
Â Â Â  if (status.active !== isServiceActive) {
Â Â Â Â Â Â Â  isServiceActive = status.active;
Â Â Â  }
Â Â Â  
Â Â Â  instructionText.style.display = 'block'; // Hiá»ƒn thá»‹ máº·c Ä‘á»‹nh 

Â Â Â  if (!isServiceActive) {
Â Â Â Â Â Â Â  // Táº®T Dá»ŠCH Vá»¤
Â Â Â Â Â Â Â  calcBtn.style.background = '#ccc';
Â Â Â Â Â Â Â  calcBtn.style.cursor = 'not-allowed';
Â Â Â Â Â Â Â  calcBtn.disabled = true;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  serviceOffNotice.style.display = 'block';
Â Â Â Â Â Â Â  serviceOffNotice.innerHTML = status.message_vn;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // VÃ´ hiá»‡u hÃ³a form
Â Â Â Â Â Â Â  bookingFormWrapper.classList.add('disabled-form');
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  zaloBtn.style.display = 'none';
Â Â Â Â Â Â Â  mailBtn.style.display = 'none';
Â Â Â Â Â Â Â  resultBox.style.display = 'none';
Â Â Â Â Â Â Â  instructionText.style.display = 'none';
Â Â Â Â Â Â Â  
Â Â Â  } else {
Â Â Â Â Â Â Â  // Má» Dá»ŠCH Vá»¤
Â Â Â Â Â Â Â  calcBtn.style.background = 'var(--green)';
Â Â Â Â Â Â Â  calcBtn.style.cursor = 'pointer';
Â Â Â Â Â Â Â  calcBtn.disabled = false;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  serviceOffNotice.style.display = 'none';
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // KÃ­ch hoáº¡t form
Â Â Â Â Â Â Â  bookingFormWrapper.classList.remove('disabled-form');
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  instructionText.innerHTML = status.message_vn || i18n[currentLang].statusActive;
Â Â Â  }
} 

/* ---------- CÃ¡c hÃ m JS khÃ¡c (InitMap, Geolocation, Autocomplete, Calculate...) ÄÃ£ cáº­p nháº­t I18N ---------- */
function initMap(center) {
Â Â Â  if (!map) {
Â Â Â Â Â Â Â  map = L.map('map').setView(center, 11);
Â Â Â Â Â Â Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 

Â Â Â Â Â Â Â  map.on('click', handleMapClick);
Â Â Â Â Â Â Â  map.on('dblclick', handleMapDblClick);
Â Â Â  } else {
Â Â Â Â Â Â Â  map.setView(center, 11);
Â Â Â  }
} 

async function reverseGeocode(lat, lon) {
Â Â Â  try {
Â Â Â Â Â Â Â  // Use the current language in the Nominatim request
Â Â Â Â Â Â Â  const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=${currentLang},en`;
Â Â Â Â Â Â Â  const r = await fetch(url);
Â Â Â Â Â Â Â  const data = await r.json();
Â Â Â Â Â Â Â  return data.display_name;
Â Â Â  } catch (e) {
Â Â Â Â Â Â Â  console.warn('Reverse Geocoding Error', e);
Â Â Â Â Â Â Â  return `${lat.toFixed(6)}, ${lon.toFixed(6)} (${i18n[currentLang].statusNoCoord + i18n[currentLang].labelPickup})`;
Â Â Â  }
} 

function getGeolocation() {
    const translations = i18n[currentLang];
Â Â Â  locationStatusEl.textContent = translations.statusLocating;
Â Â Â  locationStatusEl.style.color = 'var(--muted)';
Â Â Â  reloadLocationBtn.style.color = '#ccc'; 
Â Â Â  reloadLocationBtn.style.pointerEvents = 'none'; 

Â Â Â  if(navigator.geolocation){
Â Â Â Â Â Â Â  navigator.geolocation.getCurrentPosition(async (pos)=>{
Â Â Â Â Â Â Â Â Â Â Â  userLocation = [pos.coords.latitude, pos.coords.longitude]; 
Â Â Â Â Â Â Â Â Â Â Â  initMap(userLocation); 
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  const address = await reverseGeocode(userLocation[0], userLocation[1]);
Â Â Â Â Â Â Â Â Â Â Â  pickupEl.value = address;
Â Â Â Â Â Â Â Â Â Â Â  pickupEl.dataset.lat = userLocation[0];
Â Â Â Â Â Â Â Â Â Â Â  pickupEl.dataset.lon = userLocation[1];
Â Â Â Â Â Â Â Â Â Â Â  pickupEl.parentNode.querySelector('.clear-btn').style.display = 'flex'; 

Â Â Â Â Â Â Â Â Â Â Â  if(pickupMarker) map.removeLayer(pickupMarker);
Â Â Â Â Â Â Â Â Â Â Â  pickupMarker = L.marker(userLocation).addTo(map).bindPopup(translations.statusPopup).openPopup(); 

Â Â Â Â Â Â Â Â Â Â Â  locationStatusEl.textContent = translations.statusLocated;
Â Â Â Â Â Â Â Â Â Â Â  locationStatusEl.style.color = 'var(--green)';
Â Â Â Â Â Â Â Â Â Â Â  reloadLocationBtn.style.color = '#007bff';
Â Â Â Â Â Â Â Â Â Â Â  reloadLocationBtn.style.pointerEvents = 'auto';


Â Â Â Â Â Â Â  }, (err)=>{
Â Â Â Â Â Â Â Â Â Â Â  console.warn('Geolocation Error:', err.message);
Â Â Â Â Â Â Â Â Â Â Â  initMap(DEFAULT_CENTER); 
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  let statusText = translations.errorLocating;
Â Â Â Â Â Â Â Â Â Â Â  if (err.code === err.PERMISSION_DENIED) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  statusText = translations.errorDenied;
Â Â Â Â Â Â Â Â Â Â Â  } else if (err.code === err.POSITION_UNAVAILABLE) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  statusText = translations.errorUnavailable;
Â Â Â Â Â Â Â Â Â Â Â  } else if (err.code === err.TIMEOUT) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  statusText = translations.errorTimeoutLoc;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â Â Â Â Â  locationStatusEl.textContent = statusText;
Â Â Â Â Â Â Â Â Â Â Â  locationStatusEl.style.color = '#dc3545';
Â Â Â Â Â Â Â Â Â Â Â  reloadLocationBtn.style.color = '#007bff';
Â Â Â Â Â Â Â Â Â Â Â  reloadLocationBtn.style.pointerEvents = 'auto';


Â Â Â Â Â Â Â  }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
Â Â Â  } else {
Â Â Â Â Â Â Â  initMap(DEFAULT_CENTER); 
Â Â Â Â Â Â Â  locationStatusEl.textContent = translations.errorNotSupported;
Â Â Â Â Â Â Â  locationStatusEl.style.color = '#dc3545';
Â Â Â Â Â Â Â  reloadLocationBtn.style.color = '#ccc';
Â Â Â Â Â Â Â  reloadLocationBtn.style.pointerEvents = 'none';
Â Â Â  }
} 

function debounce(func, timeout = DEBOUNCE_TIME) {
Â  let timer;
Â  return (...args) => {
Â Â Â  clearTimeout(timer);
Â Â Â  timer = setTimeout(() => { func.apply(this, args); }, timeout);
Â  };
} 

function toggleWaitingInput(){
Â Â Â  if(tripTypeEl.value === '1'){
Â Â Â Â Â Â Â  waitingWrapper.style.display = 'none';
Â Â Â  } else {
Â Â Â Â Â Â Â  waitingWrapper.style.display = 'block';
Â Â Â  }
} 

tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput(); 

document.querySelectorAll('.clear-btn').forEach(btn => {
Â Â Â  btn.addEventListener('click', (e) => {
Â Â Â Â Â Â Â  const inputId = e.target.dataset.inputId;
Â Â Â Â Â Â Â  const inputEl = document.getElementById(inputId);
Â Â Â Â Â Â Â  if (inputEl) {
Â Â Â Â Â Â Â Â Â Â Â  inputEl.value = '';
Â Â Â Â Â Â Â Â Â Â Â  delete inputEl.dataset.lat;
Â Â Â Â Â Â Â Â Â Â Â  delete inputEl.dataset.lon;
Â Â Â Â Â Â Â Â Â Â Â  if (inputId === 'pickup' && pickupMarker) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  map.removeLayer(pickupMarker);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  pickupMarker = null;
Â Â Â Â Â Â Â Â Â Â Â  } else if (inputId === 'dropoff' && dropoffMarker) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  map.removeLayer(dropoffMarker);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  dropoffMarker = null;
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  const suggBox = document.getElementById(`${inputId}-suggestions`);
Â Â Â Â Â Â Â Â Â Â Â  if (suggBox) suggBox.style.display = 'none';
Â Â Â Â Â Â Â Â Â Â Â  inputEl.focus(); 
Â Â Â Â Â Â Â  }
Â Â Â  });
});
document.querySelectorAll('input[type="text"]').forEach(inputEl => {
Â Â Â  const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
Â Â Â  if (clearBtn && !inputEl.id.startsWith('stop-')) { /* Bá» qua stop inputs */
Â Â Â Â Â Â Â  inputEl.addEventListener('input', () => {
Â Â Â Â Â Â Â Â Â Â Â  clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  inputEl.addEventListener('focus', () => {
Â Â Â Â Â Â Â Â Â Â Â Â  clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  inputEl.addEventListener('blur', () => {
Â Â Â Â Â Â Â Â Â Â Â Â  setTimeout(() => clearBtn.style.display = 'none', 150); 
Â Â Â Â Â Â Â  });
        // Set initial state
        if (inputEl.value.trim()) clearBtn.style.display = 'flex';
Â Â Â  }
});


async function geocodeOnce(query){
Â  try{
Â Â Â  let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1&accept-language=${currentLang},en`;
Â Â Â  
Â Â Â  // FIX: Removed &bounded=1 to allow searching for locations far from userLocation
Â Â Â  if(userLocation) { 
Â Â Â Â Â Â Â  const [lat, lon] = userLocation;
Â Â Â Â Â Â Â  url += `&viewbox=${lon - 0.5},${lat - 0.5},${lon + 0.5},${lat + 0.5}`;
Â Â Â  } else {
Â Â Â Â Â Â Â  url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
Â Â Â  } 

Â Â Â  const r = await fetch(url);
Â Â Â  const data = await r.json();
Â Â Â  if(Array.isArray(data) && data.length>0) return data[0];
Â  }catch(e){ console.warn('geocode once error', e); }
Â  return null;
} 

function attachAutocomplete(inputEl, boxEl){
Â  let controller = null; 
    const translations = i18n[currentLang];

Â  const doSearch = async ()=>{
Â Â Â  const q = inputEl.value.trim();
Â Â Â  const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
Â Â Â  
Â Â Â  if(!q){ 
Â Â Â Â Â Â Â  boxEl.style.display = 'none'; 
Â Â Â Â Â Â Â  if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'none';
Â Â Â Â Â Â Â  return; 
Â Â Â  }
Â Â Â  if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'flex'; 

Â Â Â  if(controller) controller.abort();
Â Â Â  controller = new AbortController();
Â Â Â  
Â Â Â  boxEl.innerHTML = `<div>${translations.alertSearching}</div>`; 
Â Â Â  boxEl.style.display = 'block'; 

Â Â Â  let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=${currentLang},en`; 
Â Â Â  
Â Â Â  // FIX: Removed &bounded=1 to allow searching for locations far from userLocation
Â Â Â  if(userLocation) {
Â Â Â Â Â Â Â  const [lat, lon] = userLocation;
Â Â Â Â Â Â Â  url += `&viewbox=${lon - 0.3},${lat - 0.3},${lon + 0.3},${lat + 0.3}`;
Â Â Â  } else {
Â Â Â Â Â Â Â  url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
Â Â Â  }


Â Â Â  try{
Â Â Â Â Â  const res = await fetch(url, { signal: controller.signal });
Â Â Â Â Â  const data = await res.json();
Â Â Â Â Â  
Â Â Â Â Â  const fragment = document.createDocumentFragment();
Â Â Â Â Â  
Â Â Â Â Â  if(!Array.isArray(data) || data.length === 0){ 
Â Â Â Â Â Â Â  boxEl.innerHTML = `<div>${translations.alertNoSuggestions}</div>`; 
Â Â Â Â Â Â Â  setTimeout(() => boxEl.style.display = 'none', 1000); 
Â Â Â Â Â Â Â  return; 
Â Â Â Â Â  } 

Â Â Â Â Â  data.forEach(place => {
Â Â Â Â Â Â Â  const d = document.createElement('div');
Â Â Â Â Â Â Â  d.innerHTML = `<span style="font-size:16px">ğŸ“</span><div style="margin-left:8px">${place.display_name}</div>`;
Â Â Â Â Â Â Â  d.addEventListener('click', ()=>{
Â Â Â Â Â Â Â Â Â  inputEl.value = place.display_name;
Â Â Â Â Â Â Â Â Â  inputEl.dataset.lat = place.lat;
Â Â Â Â Â Â Â Â Â  inputEl.dataset.lon = place.lon;
Â Â Â Â Â Â Â Â Â  boxEl.style.display = 'none';
Â Â Â Â Â Â Â Â Â  if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'flex'; 

Â Â Â Â Â Â Â Â Â  const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
Â Â Â Â Â Â Â Â Â  if(map) {
Â Â Â Â Â Â Â Â Â Â Â  if(inputEl.id === 'pickup'){
Â Â Â Â Â Â Â Â Â Â Â Â Â  if(pickupMarker) map.removeLayer(pickupMarker);
Â Â Â Â Â Â Â Â Â Â Â Â Â  pickupMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupPickup).openPopup();
Â Â Â Â Â Â Â Â Â Â Â Â Â  map.setView(latlng, 14);
Â Â Â Â Â Â Â Â Â Â Â  } else if(inputEl.id === 'dropoff'){
Â Â Â Â Â Â Â Â Â Â Â Â Â  if(dropoffMarker) map.removeLayer(dropoffMarker);
Â Â Â Â Â Â Â Â Â Â Â Â Â  dropoffMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupDropoff).openPopup();
Â Â Â Â Â Â Â Â Â Â Â Â Â  map.setView(latlng, 14);
Â Â Â Â Â Â Â Â Â Â Â  } 
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  fragment.appendChild(d);
Â Â Â Â Â  });
Â Â Â Â Â  
Â Â Â Â Â  boxEl.innerHTML = '';
Â Â Â Â Â  boxEl.appendChild(fragment);
Â Â Â Â Â  boxEl.style.display = 'block';
Â Â Â Â Â  
Â Â Â  }catch(err){
Â Â Â Â Â  if(err.name === 'AbortError') return; 
Â Â Â Â Â  console.error('suggest error', err);
Â Â Â Â Â  boxEl.innerHTML = '<div>Lá»—i máº¡ng hoáº·c API. Thá»­ láº¡i</div>'; // Keep in VN for now, assuming mostly network issue
Â Â Â Â Â  setTimeout(() => boxEl.style.display = 'none', 2000); 
Â Â Â  }
Â  }; 

Â  inputEl.addEventListener('input', debounce(doSearch)); 

Â  document.addEventListener('click', (ev)=>{
Â Â Â  if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; 
Â  }); 

Â  inputEl.addEventListener('focus', ()=> {
Â Â Â  const inputId = inputEl.id; 
Â Â Â  if(inputId && inputId.startsWith('stop-')) lastFocusedStopId = inputId;
Â Â Â  else lastFocusedStopId = null;
Â Â Â  
Â Â Â  const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
Â Â Â  if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
Â  });
} 

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg); 

function createStopInput(prefill=''){
Â  stopCount++;
    const translations = i18n[currentLang];
Â  const wrapper = document.createElement('div');
Â  wrapper.className = 'way-wrapper input-row';
Â  const inputId = `stop-${stopCount}`;
Â  const suggId = `${inputId}-suggestions`;
Â  wrapper.innerHTML = `
Â Â Â  <input type="text" id="${inputId}" placeholder="${translations.placeholderPickup.replace('Ä‘iá»ƒm Ä‘Ã³n', 'Ä‘iá»ƒm dá»«ng ' + stopCount).replace('pickup address', 'stopover ' + stopCount).replace('ä¸Šè½¦åœ°å€', 'ç»åœç‚¹ ' + stopCount)}">
Â Â Â  <button class="clear-btn" data-input-id="${inputId}">âœ–</button> 
Â Â Â  <button class="way-remove" title="XÃ³a">âœ–</button>
Â Â Â  <div id="${suggId}" class="suggestions" style="display:none"></div>
Â  `;
Â  stopsContainer.appendChild(wrapper); 

Â  const inputEl = wrapper.querySelector('input');
Â  const boxEl = wrapper.querySelector('.suggestions');
Â  attachAutocomplete(inputEl, boxEl);
Â  
Â  const clearBtn = wrapper.querySelector('.clear-btn');
    /* NOTE: NÃºt clear-btn cho stop input sáº½ bá»‹ áº©n bá»Ÿi CSS vÃ¬ Ä‘Ã£ cÃ³ nÃºt way-remove */
Â  inputEl.addEventListener('input', () => { if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none'; });
Â  inputEl.addEventListener('focus', () => { if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none'; });
Â  inputEl.addEventListener('blur', () => { setTimeout(() => { if(clearBtn) clearBtn.style.display = 'none'; }, 150); });
Â  clearBtn.addEventListener('click', (e) => {
Â Â Â  e.stopPropagation(); 
Â Â Â  inputEl.value = ''; 
Â Â Â  delete inputEl.dataset.lat;
Â Â Â  delete inputEl.dataset.lon;
Â Â Â  boxEl.style.display = 'none';
Â Â Â  inputEl.focus();
Â  });


Â  wrapper.querySelector('.way-remove').addEventListener('click', ()=> wrapper.remove()); 

Â  inputEl.addEventListener('focus', ()=> lastFocusedStopId = inputId); 

Â  return inputEl;
} 

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput()); 

document.getElementById('pick-from-map').addEventListener('click', ()=> { 
    selecting = 'pickup'; 
    alert(i18n[currentLang].alertMapPickPickup); 
});
document.getElementById('pick-to-map').addEventListener('click', ()=> { 
    selecting = 'dropoff'; 
    alert(i18n[currentLang].alertMapPickDropoff); 
}); 

const handleMapClick = async (e) => {
Â  if (!map) return; 
Â  const lat = e.latlng.lat, lon = e.latlng.lng;
    const translations = i18n[currentLang];
Â  
Â  let targetInput, targetMarker; 

Â  if(selecting === 'pickup'){
Â Â Â  targetInput = pickupEl;
Â Â Â  targetMarker = pickupMarker;
Â Â Â  if(pickupMarker) map.removeLayer(pickupMarker);
Â Â Â  pickupMarker = L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupPickup).openPopup();
Â Â Â  selecting = null;
Â  } else if(selecting === 'dropoff'){
Â Â Â  targetInput = dropoffEl;
Â Â Â  targetMarker = dropoffMarker;
Â Â Â  if(dropoffMarker) map.removeLayer(dropoffMarker);
Â Â Â  dropoffMarker = L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupDropoff).openPopup();
Â Â Â  selecting = null;
Â  } else if(lastFocusedStopId){
Â Â Â  targetInput = document.getElementById(lastFocusedStopId);
Â Â Â  if(targetInput){
Â Â Â Â Â  L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupStop).openPopup();
Â Â Â Â Â  lastFocusedStopId = null;
Â Â Â  }
Â  } 

Â  if(targetInput){
Â Â Â  const address = await reverseGeocode(lat, lon);
Â Â Â  targetInput.value = address;
Â Â Â  
Â Â Â  targetInput.dataset.lat = lat; targetInput.dataset.lon = lon;
Â Â Â  const clearBtn = targetInput.parentNode.querySelector('.clear-btn');
Â Â Â  if(clearBtn && !targetInput.id.startsWith('stop-')) clearBtn.style.display = 'flex';
Â Â Â  
Â Â Â  if(targetMarker) map.setView([lat,lon], 14);
Â  }
};


const handleMapDblClick = (e) => {
Â  if (!map) return; 
Â  if(lastFocusedStopId){
Â Â Â  const stopInput = document.getElementById(lastFocusedStopId);
Â Â Â  if(stopInput){
Â Â Â Â Â  stopInput.value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
Â Â Â Â Â  stopInput.dataset.lat = e.latlng.lat; stopInput.dataset.lon = e.latlng.lng;
Â Â Â Â Â  L.marker([e.latlng.lat,e.latlng.lng]).addTo(map).bindPopup(i18n[currentLang].mapPopupStop).openPopup();
Â Â Â Â Â  lastFocusedStopId = null;
Â Â Â  }
Â  }
};


async function resolveCoordForInput(inputEl){
Â  if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon){
Â Â Â  return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
Â  }
Â  const v = inputEl.value.trim();
Â  if(!v) return null;
Â  const parts = v.split(',');
Â  if(parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))){
Â Â Â  // Giáº£ Ä‘á»‹nh nháº­p Lat, Lon náº¿u cÃ³ 2 sá»‘
Â Â Â  return [parseFloat(parts[0]), parseFloat(parts[1])]; 
Â  }
Â  const place = await geocodeOnce(v + ' Viá»‡t Nam');
Â  if(place){
Â Â Â  inputEl.dataset.lat = place.lat;
Â Â Â  inputEl.dataset.lon = place.lon;
Â Â Â  return [parseFloat(place.lat), parseFloat(place.lon)];
Â  }
Â  return null;
} 

function validateRouteInputs() {
    const translations = i18n[currentLang];
Â Â Â  if (pickupEl.value.trim() === '') {
Â Â Â Â Â Â Â  alert(translations.alertPickup);
Â Â Â Â Â Â Â  pickupEl.focus();
Â Â Â Â Â Â Â  return false;
Â Â Â  }
Â Â Â  if (dropoffEl.value.trim() === '') {
Â Â Â Â Â Â Â  alert(translations.alertDropoff);
Â Â Â Â Â Â Â  dropoffEl.focus();
Â Â Â Â Â Â Â  return false;
Â Â Â  }
Â Â Â  const tripType = tripTypeEl.value; 
Â Â Â  const waiting = parseFloat(waitingEl.value); 
Â Â Â  if (tripType === '2') {
Â Â Â Â Â Â Â  if (isNaN(waiting) || waiting < 0) {
Â Â Â Â Â Â Â Â Â Â Â  alert(translations.alertWaiting);
Â Â Â Â Â Â Â Â Â Â Â  waitingEl.focus();
Â Â Â Â Â Â Â Â Â Â Â  return false;
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â  return true;
} 

function validatePhone(phone) {
Â Â Â  const phoneRegex = /^\d{10}$/; 
Â Â Â  return phoneRegex.test(phone);
} 

// HÃ m chÃ­nh tÃ­nh giÃ¡ cÆ°á»›c vÃ  táº¡o tin nháº¯n Zalo
async function calculateAndGenerateMessage() {
    const translations = i18n[currentLang];

Â Â Â  if (!validateRouteInputs()) {
Â Â Â Â Â Â Â  return false; 
Â Â Â  }
Â Â Â  
Â Â Â  const pickupCoord = await resolveCoordForInput(pickupEl);
Â Â Â  if(!pickupCoord){ alert(translations.statusNoCoord + (currentLang === 'en' ? 'Pickup' : (currentLang === 'zh' ? 'ä¸Šè½¦' : 'Ä‘Ã³n')) + '. ' + translations.alertNoCoord); return false; }
Â Â Â  const dropoffCoord = await resolveCoordForInput(dropoffEl);
Â Â Â  if(!dropoffCoord){ alert(translations.statusNoCoord + (currentLang === 'en' ? 'Drop-off' : (currentLang === 'zh' ? 'ç›®çš„åœ°' : 'Ä‘áº¿n')) + '. ' + translations.alertNoCoord); return false; } 

Â Â Â  const coords = [];
Â Â Â  coords.push(pickupCoord);
Â Â Â  const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
Â Â Â  for(const s of stopInputs){
Â Â Â Â Â Â Â  if(s.value.trim()){
Â Â Â Â Â Â Â Â Â Â Â  const sc = await resolveCoordForInput(s);
Â Â Â Â Â Â Â Â Â Â Â  if(!sc){ alert(translations.alertNoStopCoord); return false; }
Â Â Â Â Â Â Â Â Â Â Â  coords.push(sc);
Â Â Â Â Â Â Â  }
Â Â Â  }
Â Â Â  coords.push(dropoffCoord); 

Â Â Â  const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
Â Â Â  const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`; 

Â Â Â  resultBox.style.display = 'block';
Â Â Â  distanceText.textContent = translations.statusCalculatingRoute;
Â Â Â  priceValue.textContent = '...';
Â Â Â  priceBreak.innerHTML = '';
Â Â Â  timeEst.textContent = '';
Â Â Â  finalZaloMessage = ''; 
Â Â Â  finalTotalFee = 0;
Â Â Â  zaloBtn.style.display = 'none'; 
Â Â Â  mailBtn.style.display = 'none';
Â Â Â  instructionText.innerHTML = translations.statusCalculating; 

Â Â Â  try{
Â Â Â Â Â Â Â  const r = await fetch(url);
Â Â Â Â Â Â Â  const data = await r.json();
Â Â Â Â Â Â Â  if(!data.routes || data.routes.length === 0){ distanceText.textContent = translations.statusNoRoute; return false; }
Â Â Â Â Â Â Â  const route = data.routes[0];
Â Â Â Â Â Â Â  const dist = route.distance / 1000; 
Â Â Â Â Â Â Â  const minutes = Math.round((route.duration / 60)); // OSRM gives duration in seconds

Â Â Â Â Â Â Â  if(map) {
Â Â Â Â Â Â Â Â Â Â Â  if(routeLayer) map.removeLayer(routeLayer);
Â Â Â Â Â Â Â Â Â Â Â  routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
Â Â Â Â Â Â Â Â Â Â Â  map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
Â Â Â Â Â Â Â  } 

Â Â Â Â Â Â Â  const tripType = tripTypeEl.value; 
Â Â Â Â Â Â Â  const carType = carTypeEl.value; 
Â Â Â Â Â Â Â  const driverRequest = driverRequestEl.value; // Get driver request
Â Â Â Â Â Â Â  const waiting = parseFloat(waitingEl.value) || 0; 
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  let perKm, carName, carPrice;
Â Â Â Â Â Â Â  if (carType.includes('7 chá»—') || carType.includes('7 Seater') || carType.includes('7åº§è½¦')) { 
                perKm = 12000; 
                carName = translations.car7seater.replace(/ \(.+\)/, '');
                carPrice = '12.000Ä‘/km';
            } else { 
                perKm = 10000; 
                carName = translations.car4seater.replace(/ \(.+\)/, '');
                carPrice = '10.000Ä‘/km';
            }
Â Â Â Â Â Â Â  const perKmReturnDiscount = Math.round(perKm * 0.6); 

Â Â Â Â Â Â Â  const priceGo = Math.round(dist * perKm);
Â Â Â Â Â Â Â  let priceReturn = 0;
Â Â Â Â Â Â Â  let returnNote = ''; 

Â Â Â Â Â Â Â  if(tripType === '2') {
Â Â Â Â Â Â Â Â Â Â Â  if(dist >= 45) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  priceReturn = Math.round(dist * perKmReturnDiscount); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  returnNote = currentLang === 'en' ? `Return trip (40% off due to one-way â‰¥ 45km => ${(perKmReturnDiscount/1000).toLocaleString('en-US')}k/km)` : 
                           (currentLang === 'zh' ? `è¿”ç¨‹ (å•ç¨‹ â‰¥ 45å…¬é‡Œï¼Œå‡40% => ${(perKmReturnDiscount/1000).toLocaleString('zh-CN')}k/å…¬é‡Œ)` : 
                           `Chiá»u vá» (giáº£m 40% do 1 chiá»u â‰¥ 45km => ${perKmReturnDiscount.toLocaleString('vi-VN')}Ä‘/km)`);
Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  priceReturn = Math.round(dist * perKm); 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  returnNote = currentLang === 'en' ? `Return trip (No discount as one-way < 45km => ${(perKm/1000).toLocaleString('en-US')}k/km)` : 
                           (currentLang === 'zh' ? `è¿”ç¨‹ (å•ç¨‹ < 45å…¬é‡Œï¼Œæ— æŠ˜æ‰£ => ${(perKm/1000).toLocaleString('zh-CN')}k/å…¬é‡Œ)` : 
                           `Chiá»u vá» (KhÃ´ng giáº£m giÃ¡ do 1 chiá»u < 45km => ${perKm.toLocaleString('vi-VN')}Ä‘/km)`);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  returnNote = translations.tripOneWay;
Â Â Â Â Â Â Â  } 

Â Â Â Â Â Â Â  const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
Â Â Â Â Â Â Â  const total = priceGo + priceReturn + waitFee;
Â Â Â Â Â Â Â  finalTotalFee = total; // LÆ°u láº¡i tá»•ng phÃ­
Â Â Â Â Â Â Â  const depositAmountValue = Math.round(total * 0.2); // TÃ­nh tiá»n Ä‘áº·t cá»c 

Â Â Â Â Â Â Â  // Cáº­p nháº­t hiá»ƒn thá»‹ káº¿t quáº£
Â Â Â Â Â Â Â  distanceText.textContent = `${translations.resultDistance} ${dist.toFixed(1)} km`;
Â Â Â Â Â Â Â  priceValue.textContent = `${total.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘`;
Â Â Â Â Â Â Â  
            priceBreak.innerHTML = `
                <span style="font-size: 14px; display: block; margin-bottom: 4px;">${carName}: ${carPrice}</span>
                <span>${translations.tripOneWay}: ${priceGo.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘</span><br>
                ${tripType === '2' ? `<span>${returnNote}: ${priceReturn.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘</span><br>` : ''}
                ${waitFee > 0 ? `<span>${translations.labelWaiting.replace(' (giá»)', '')} (${waiting}h): ${waitFee.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘ (+50k/h tá»« giá» thá»© 4)</span><br>` : ''}
                ${tripType === '2' && waitFee === 0 && waiting > 0 ? `<span>${translations.labelWaiting.replace(' (giá»)', '')} (${waiting}h): 0 Ä‘ (Miá»…n phÃ­ 3 giá» Ä‘áº§u)</span><br>` : ''}
            `;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  timeEst.textContent = `${translations.resultTimeEst} ${minutes} ${currentLang === 'en' ? 'minutes' : (currentLang === 'zh' ? 'åˆ†é’Ÿ' : 'phÃºt')}`;
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  const pickupDt = pickupDateTime.value ? new Date(pickupDateTime.value).toLocaleString(currentLang === 'en' ? 'en-US' : 'vi-VN', { dateStyle: 'short', timeStyle: 'short' }) : 'KhÃ´ng cÃ³';
Â Â Â Â Â Â Â  pickupInfo.textContent = `${translations.resultPickupTime} ${pickupDt}`; 

Â Â Â Â Â Â Â  // Cáº­p nháº­t tin nháº¯n Zalo/Mail
Â Â Â Â Â Â Â  const stopAddresses = stopInputs.filter(s => s.value.trim()).map((s, i) => `${currentLang === 'en' ? 'Stopover' : (currentLang === 'zh' ? 'ç»åœç‚¹' : 'Äiá»ƒm dá»«ng')} ${i+1}: ${s.value}`).join('\n');
            
            const zaloMessageLines = [
                `**${translations.modalBookingTitle.replace('âœ… ', '')}**`,
                `---`,
                `${translations.labelPhone.replace('ğŸ“ ', '').split(' (')[0]}: ${customerPhoneEl.value || (currentLang === 'en' ? 'Not provided' : (currentLang === 'zh' ? 'æœªæä¾›' : 'ChÆ°a cung cáº¥p'))}`,
                `${translations.labelPickup.replace('ğŸ“ ', '')}: ${pickupEl.value}`,
                stopAddresses ? stopAddresses : '',
                `${translations.labelDropoff.replace('ğŸ ', '')}: ${dropoffEl.value}`,
                `${translations.labelTime.replace('ğŸ•’ ', '')}: ${pickupDt}`,
                `${translations.labelCarType.replace('ğŸš˜ ', '')}: ${carName}`,
                `${translations.labelTripType.replace('ğŸš— ', '')}: ${tripTypeEl.options[tripTypeEl.selectedIndex].text}`,
                `${translations.labelDriverRequest.replace(/ğŸ§‘â€âœˆï¸|ğŸ‘¤ /, '').split(' (')[0]}: ${driverRequest}`,
                (tripType === '2' && waiting > 0) ? `${translations.labelWaiting.replace('â³ ', '').replace(' (giá»)', '')}: ${waiting} ${currentLang === 'en' ? 'hours' : (currentLang === 'zh' ? 'å°æ—¶' : 'giá»')}` : '',
                `---`,
                `${translations.resultDistance} ${dist.toFixed(1)} km`,
                `${translations.resultPriceTitle.replace('ğŸ’µ ', '')}: ${total.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘ (Æ¯á»›c tÃ­nh)`,
                `(${translations.tripOneWay}: ${priceGo.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘ ${tripType === '2' ? '+ ' + returnNote.split('(')[0].trim() + ' ' + priceReturn.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN')) + ' Ä‘' : ''}${waitFee > 0 ? ' + phÃ­ chá»' : ''})`,
                `---`,
                currentLang === 'en' ? 'Please confirm this information.' : (currentLang === 'zh' ? 'è¯·ç¡®è®¤è¿™äº›ä¿¡æ¯ã€‚' : 'Vui lÃ²ng xÃ¡c nháº­n láº¡i thÃ´ng tin nÃ y.'),
            ];

            finalZaloMessage = zaloMessageLines.filter(line => line.trim() !== '').join('\n');


Â Â Â Â Â Â Â  // Hiá»ƒn thá»‹ nÃºt Ä‘áº·t xe
Â Â Â Â Â Â Â  zaloBtn.style.display = 'block'; 
Â Â Â Â Â Â Â  mailBtn.style.display = 'block';
Â Â Â Â Â Â Â  instructionText.innerHTML = translations.statusActive; 

Â Â Â Â Â Â Â  return true;

Â Â Â  }catch(e){
Â Â Â Â Â Â Â  console.error('Route calculation error:', e);
Â Â Â Â Â Â Â  distanceText.textContent = translations.statusNoRoute;
Â Â Â Â Â Â Â  priceValue.textContent = 'Lá»–I';
Â Â Â Â Â Â Â  priceBreak.innerHTML = '';
Â Â Â Â Â Â Â  instructionText.innerHTML = translations.statusActive;
Â Â Â Â Â Â Â  return false;
Â Â Â  }
}

// Báº¯t Ä‘áº§u
document.addEventListener('DOMContentLoaded', ()=> {
Â Â Â  getGeolocation();
Â Â Â  checkServiceStatus().then(updateUIBasedOnStatus);
});

reloadLocationBtn.addEventListener('click', getGeolocation); 

calcBtn.addEventListener('click', calculateAndGenerateMessage); 


// Logic Modals
function openModal(modalEl){
Â Â Â  modalEl.style.display = 'flex';
}
function closeModal(modalEl){
Â Â Â  modalEl.style.display = 'none';
}

zaloBtn.addEventListener('click', async () => {
Â Â Â  if (!isServiceActive) return;

Â Â Â  const success = await calculateAndGenerateMessage();
Â Â Â  if (!success) return;

Â Â Â  bookingAction = 'zalo';
Â Â Â  const phone = customerPhoneEl.value.trim();

Â Â Â  if (tripTypeEl.value === '2') {
Â Â Â Â Â Â Â  // Show deposit modal first for two-way
Â Â Â Â Â Â Â  depositAmount.textContent = `${Math.round(finalTotalFee * 0.2).toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘`;
Â Â Â Â Â Â Â  openModal(depositModal);
Â Â Â Â Â Â Â  return; // Wait for deposit confirmation
Â Â Â  }

Â Â Â  if (phone && validatePhone(phone)) {
Â Â Â Â Â Â Â  showZaloModal();
Â Â Â  } else {
Â Â Â Â Â Â Â  // Show phone modal
Â Â Â Â Â Â Â  inputPhoneForBooking.value = phone;
Â Â Â Â Â Â Â  openModal(phoneModal);
Â Â Â  }
});

mailBtn.addEventListener('click', async () => {
Â Â Â  if (!isServiceActive) return;

Â Â Â  const success = await calculateAndGenerateMessage();
Â Â Â  if (!success) return;
Â Â Â  
Â Â Â  bookingAction = 'mail';
Â Â Â  const phone = customerPhoneEl.value.trim();
Â Â Â  
Â Â Â  if (tripTypeEl.value === '2') {
Â Â Â Â Â Â Â  // Show deposit modal first for two-way
Â Â Â Â Â Â Â  depositAmount.textContent = `${Math.round(finalTotalFee * 0.2).toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} Ä‘`;
Â Â Â Â Â Â Â  openModal(depositModal);
Â Â Â Â Â Â Â  return; // Wait for deposit confirmation
Â Â Â  }
Â Â Â  
Â Â Â  if (phone && validatePhone(phone)) {
Â Â Â Â Â Â Â  showZaloModal(true); // Re-use modal for mail, but link to email
Â Â Â  } else {
Â Â Â Â Â Â Â  // Show phone modal
Â Â Â Â Â Â Â  inputPhoneForBooking.value = phone;
Â Â Â Â Â Â Â  openModal(phoneModal);
Â Â Â  }
});

confirmDepositBtn.addEventListener('click', () => {
Â Â Â  closeModal(depositModal);
Â Â Â  const phone = customerPhoneEl.value.trim();
Â Â Â  
Â Â Â  if (phone && validatePhone(phone)) {
Â Â Â Â Â Â Â  if (bookingAction === 'zalo') showZaloModal();
Â Â Â Â Â Â Â  else if (bookingAction === 'mail') showZaloModal(true);
Â Â Â  } else {
Â Â Â Â Â Â Â  // Show phone modal
Â Â Â Â Â Â Â  inputPhoneForBooking.value = phone;
Â Â Â Â Â Â Â  openModal(phoneModal);
Â Â Â  }
});

confirmPhoneBtn.addEventListener('click', () => {
Â Â Â  const phone = inputPhoneForBooking.value.trim();
Â Â Â  if (validatePhone(phone)) {
Â Â Â Â Â Â Â  customerPhoneEl.value = phone; // Update the main phone field
Â Â Â Â Â Â Â  closeModal(phoneModal);
Â Â Â Â Â Â Â  
Â Â Â Â Â Â Â  // Re-calculate and open final modal
Â Â Â Â Â Â Â  calculateAndGenerateMessage().then(success => {
Â Â Â Â Â Â Â Â Â Â Â  if (success) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (bookingAction === 'zalo') showZaloModal();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  else if (bookingAction === 'mail') showZaloModal(true);
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â  } else {
Â Â Â Â Â Â Â  alert(currentLang === 'en' ? 'Please enter a valid 10-digit phone number.' : (currentLang === 'zh' ? 'è¯·è¾“å…¥æœ‰æ•ˆçš„10ä½ç”µè¯å·ç ã€‚' : 'Vui lÃ²ng nháº­p SÄT 10 sá»‘ há»£p lá»‡.'));
Â Â Â  }
});

closePhoneModalBtn.addEventListener('click', () => closeModal(phoneModal));
closeModalBtn.addEventListener('click', () => closeModal(zaloModal));

function showZaloModal(isMail = false) {
    const translations = i18n[currentLang];
Â Â Â  modalText.textContent = finalZaloMessage;

Â Â Â  const zaloBtn = document.getElementById('zaloModalBtn');
Â Â Â  const titleEl = zaloModal.querySelector('h3');
Â Â Â  const noticeEl = zaloModal.querySelector('p:nth-of-type(1)'); // The first <p> element

Â Â Â  if (isMail) {
Â Â Â Â Â Â Â  titleEl.textContent = translations.modalBookingTitle.replace('Zalo', 'Mail');
Â Â Â Â Â Â Â  noticeEl.innerHTML = currentLang === 'en' ? 'Copy the information and send via **Email**:' : 
                           (currentLang === 'zh' ? 'å¤åˆ¶ä¿¡æ¯å¹¶é€šè¿‡ **é‚®ä»¶** å‘é€:' : 
                           'Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua **Email**:');
Â Â Â Â Â Â Â  zaloBtn.textContent = currentLang === 'en' ? 'ğŸ“§ Send via Email' : (currentLang === 'zh' ? 'ğŸ“§ é€šè¿‡é‚®ä»¶å‘é€' : 'ğŸ“§ Gá»­i qua Email');
Â Â Â Â Â Â Â  zaloBtn.style.background = '#dc3545';
Â Â Â Â Â Â Â  zaloBtn.onclick = () => {
Â Â Â Â Â Â Â Â Â Â Â  const subject = currentLang === 'en' ? 'Booking Truong An Driving' : (currentLang === 'zh' ? 'é¢„è®¢é•¿å®‰é©¾é©¶' : 'Äáº·t xe TrÆ°á»ng An Driving');
Â Â Â Â Â Â Â Â Â Â Â  window.location.href = `mailto:truongan.driving@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(finalZaloMessage)}`;
Â Â Â Â Â Â Â  };
Â Â Â  } else {
Â Â Â Â Â Â Â  titleEl.textContent = translations.modalBookingTitle;
Â Â Â Â Â Â Â  noticeEl.textContent = translations.modalBookingNotice;
Â Â Â Â Â Â Â  zaloBtn.textContent = translations.modalBtnZalo;
Â Â Â Â Â Â Â  zaloBtn.style.background = '#0068ff';
Â Â Â Â Â Â Â  zaloBtn.onclick = () => window.open(ZALO_URL, '_blank');
Â Â Â  }
Â Â Â  
Â Â Â  openModal(zaloModal);
}

copyModalBtn.addEventListener('click', () => {
Â Â Â  navigator.clipboard.writeText(modalText.textContent).then(() => {
Â Â Â Â Â Â Â  copyModalBtn.textContent = currentLang === 'en' ? 'âœ… Copied!' : (currentLang === 'zh' ? 'âœ… å·²å¤åˆ¶ï¼' : 'âœ… ÄÃ£ Sao ChÃ©p!');
Â Â Â Â Â Â Â  setTimeout(() => copyModalBtn.textContent = i18n[currentLang].modalBtnCopy, 1500);
Â Â Â  }).catch(err => {
Â Â Â Â Â Â Â  console.error('Could not copy text: ', err);
Â Â Â Â Â Â Â  alert(currentLang === 'en' ? 'Copy failed. Please copy manually.' : (currentLang === 'zh' ? 'å¤åˆ¶å¤±è´¥ã€‚è¯·æ‰‹åŠ¨å¤åˆ¶ã€‚' : 'Sao chÃ©p tháº¥t báº¡i. Vui lÃ²ng copy thá»§ cÃ´ng.'));
Â Â Â  });
});
</script>
</body>
</html>
