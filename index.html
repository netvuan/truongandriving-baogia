<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Xe Tr∆∞·ªùng An</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        /* CSS KH√îI PH·ª§C GIAO DI·ªÜN G·ªêC */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0; 
            padding: 0; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
        }
        .container { 
            background-color: #ffffff; 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            max-width: 500px; 
            width: 100%; 
            margin: 20px auto; 
            position: relative; /* Quan tr·ªçng cho Suggestion Box */
        }
        
        /* HEADER - M√†u xanh l√° */
        .header { 
            background-color: #28a745; 
            color: white; 
            padding: 10px 15px; 
            border-radius: 8px 8px 0 0; 
            margin: -25px -25px 20px -25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header h2 { 
            color: white; 
            margin: 0; 
            font-size: 1.2em; 
            font-weight: bold; 
        }
        
        /* Switch ng√¥n ng·ªØ */
        .lang-switch { display: flex; gap: 5px; }
        .lang-btn { 
            background: #eee; 
            border: none; 
            padding: 5px 8px; 
            cursor: pointer; 
            border-radius: 5px; 
            font-size: 0.8em; 
            color: #333; 
        }
        .lang-btn.active { 
            background: white; 
            color: #28a745; 
            font-weight: bold; 
        }

        /* C√°c box ch·ª©c nƒÉng */
        .section-box { 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 20px; 
            background-color: #fff; 
        }
        .section-box h3 { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: #007bff; 
            border-bottom: none; 
            padding-bottom: 0; 
            margin-top: 0; 
            margin-bottom: 15px; 
            font-size: 1.2em; 
            font-weight: bold; 
        }
        .section-box.route h3 { color: #28a745; }
        .section-box.options h3 { color: #dc3545; }

        /* Input Group */
        .input-group { 
            margin-bottom: 15px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
            color: #555; 
            font-size: 0.9em; 
        }
        input[type="text"], input[type="tel"], input[type="datetime-local"], select, textarea {
            width: 100%; 
            padding: 10px 40px 10px 10px; /* Th√™m padding cho c√°c n√∫t icon */
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box; 
            transition: border-color 0.3s; 
            font-size: 1em; 
        }
        input[type="text"]:focus, input[type="tel"]:focus, input[type="datetime-local"]:focus, select:focus, textarea:focus { 
            border-color: #007bff; 
            outline: none; 
        }
        
        /* Box ch·ª©a c√°c n√∫t ch·ª©c nƒÉng (X√≥a, B·∫£n ƒë·ªì) */
        .tools { 
            position: absolute; 
            right: 0; 
            top: 0; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            padding-right: 5px; 
            z-index: 5; 
        }
        /* ƒêi·ªÅu ch·ªânh v·ªã tr√≠ Tools cho input c√≥ label */
        .input-group:not(.select-group) .tools { 
            top: 25px; /* ƒê·∫∑t d∆∞·ªõi Label */
            height: auto;
        }

        .btn-icon { 
            background: none; 
            border: none; 
            cursor: pointer; 
            padding: 5px; 
            font-size: 1.1em; 
            color: #888; 
            transition: color 0.2s; 
        }
        .btn-icon:hover { color: #007bff; }
        .btn-icon.btn-x { color: #dc3545; display: none; }
        .btn-icon.btn-x:hover { color: #c82333; }
        .btn-icon.btn-trash { color: #dc3545; }
        .btn-icon.btn-trash:hover { color: #c82333; }
        .btn-icon.btn-map { 
            background-color: #28a745; 
            color: white; 
            border-radius: 5px; 
            margin-left: 5px; 
            font-size: 1.2em; 
            padding: 6px; 
        }
        .btn-icon.btn-map:hover { background-color: #218838; color: white; }
        
        /* Custom cho input ƒë·ªãa ch·ªâ c√≥ n√∫t Map */
        .input-group input[type="text"] { padding-right: 85px; } /* ƒê·∫£m b·∫£o ƒë·ªß ch·ªó cho 2 n√∫t icon */
        .input-group input[type="tel"] { padding-right: 40px; } /* ƒê·∫£m b·∫£o ƒë·ªß ch·ªó cho n√∫t X */
        
        /* N√∫t V·ªã tr√≠ t√¥i (M√†u ƒê·ªé) */
        #btn-loc { 
            background-color: #dc3545; 
            color: white; 
            padding: 5px 10px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.9em; 
            transition: background-color 0.3s; 
        }
        #btn-loc:hover { background-color: #c82333; }

        /* V√πng b·∫£n ƒë·ªì */
        #main-map { 
            height: 200px; 
            width: 100%; 
            margin-bottom: 15px; 
            border-radius: 8px; 
            border: 1px solid #ccc; 
        }

        /* N√∫t Th√™m ƒëi·ªÉm d·ª´ng */
        #btn-add-stop { 
            background-color: #17a2b8; 
            color: white; 
            padding: 8px 15px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            width: 100%; 
            transition: background-color 0.3s; 
            margin-top: -5px; 
            margin-bottom: 15px; 
        }
        #btn-add-stop:hover { background-color: #138496; }

        /* N√∫t t√≠nh c∆∞·ªõc (M√†u V√ÄNG/XANH L√Å) */
        #btn-calc { 
            background-color: #ffc107; 
            color: #333; 
            padding: 15px 15px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.2em; 
            font-weight: bold; 
            width: 100%; 
            margin-top: 10px; 
            transition: background-color 0.3s; 
        }
        #btn-calc:hover:not(:disabled) { background-color: #e0a800; }

        /* K·∫øt qu·∫£ gi√° c∆∞·ªõc */
        #result-box { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #e9f7ff; 
            border: 1px solid #007bff; 
            border-radius: 10px; 
            display: none; 
        }
        .price-row-detail { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.95em; 
            padding-left: 10px; 
            margin: 5px 0; 
        }
        .price-row-detail strong { color: #dc3545; }
        #res-total { 
            font-size: 1.4em; 
            color: #dc3545; 
            font-weight: bold; 
            margin-top: 10px; 
            text-align: right; 
        }
        #result-box h4 { 
            margin-top: 0; 
            font-size: 1.1em; 
            color: #007bff; 
            text-align: center; 
        }
        
        /* Ghi ch√∫ */
        .notes { 
            font-size: 0.8em; 
            color: #777; 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px dashed #ccc; 
        }
        
        /* N√∫t ƒê·∫∑t xe */
        .btn-book-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-book { 
            padding: 12px 15px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em; 
            font-weight: bold; 
            flex: 1; 
            transition: opacity 0.3s; 
        }
        #btn-zalo { background-color: #007bff; color: white; }
        #btn-zalo:hover:not(:disabled) { background-color: #0056b3; }
        #btn-mail { background-color: #6c757d; color: white; }
        #btn-mail:hover:not(:disabled) { background-color: #5a6268; }

        /* Modal (Gi·ªØ nguy√™n) */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0, 0, 0, 0.4); 
            justify-content: center; 
            align-items: center; 
        }
        .modal-content { 
            background-color: #fefefe; 
            padding: 20px; 
            border-radius: 10px; 
            max-width: 90%; 
        }
        #modal-map .modal-content { 
            width: 500px; 
            max-width: 90%; 
        }
        #picker-map { 
            height: 300px; 
            width: 100%; 
            margin-top: 10px; 
            border-radius: 8px; 
        }
        .modal-buttons { margin-top: 15px; text-align: right; }
        .modal-buttons button { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .modal-buttons .btn-cancel { background-color: #f8f9fa; color: #333; }
        .modal-buttons .btn-confirm { background-color: #28a745; color: white; }

        /* G·ª£i √Ω ƒë·ªãa ch·ªâ */
        .suggestions { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid #ccc; 
            border-top: none; 
            z-index: 10; 
            max-height: 150px; 
            overflow-y: auto; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            border-radius: 0 0 8px 8px; 
            display: none; 
        }
        .sug-item { 
            padding: 10px; 
            cursor: pointer; 
            border-bottom: 1px solid #eee; 
            font-size: 0.9em; 
        }
        .sug-item:hover { background-color: #f0f8ff; }

        /* Custom cho Select */
        .select-group { position: relative; }
        .select-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; padding-right: 30px; }
        .select-group::after { content: '‚ñº'; position: absolute; top: 50%; right: 10px; transform: translateY(-50%); font-size: 0.8em; color: #555; pointer-events: none; }
        /* ƒêi·ªÅu ch·ªânh Tool cho Select Group */
        .select-group .tools { top: 0; }
        
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2 data-i18n="brand">TR∆Ø·ªúNG AN DRIVING</h2>
            <div class="lang-switch">
                <button class="lang-btn active" onclick="setLang('vi')">VN</button>
                <button class="lang-btn" onclick="setLang('en')">EN</button>
                <button class="lang-btn" onclick="setLang('cn')">CN</button>
            </div>
        </div>

        <div class="section-box info">
            <h3 data-i18n="sec_info">üìã TH√îNG TIN</h3>
            <div class="input-group">
                <label for="phone" data-i18n="lbl_phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="tel" id="phone" placeholder="VD: 0912345678">
                <div class="tools"><button class="btn-icon btn-x" onclick="clearInp('phone')">‚úï</button></div>
            </div>
            <div class="input-group">
                <label for="time" data-i18n="lbl_time">Th·ªùi gian ƒë√≥n:</label>
                <input type="datetime-local" id="time">
            </div>
        </div>
        
        <div class="section-box route">
            <h3 data-i18n="sec_route">üó∫Ô∏è L·ªò TR√åNH <button id="btn-loc" data-i18n="btn_myloc">üéØ V·ªã tr√≠ t√¥i</button></h3>
            
            <div id="main-map"></div>

            <div class="input-group">
                <label for="pickup" data-i18n="lbl_pickup">ƒêi·ªÉm ƒë√≥n:</label>
                <input type="text" id="pickup" placeholder="VD: 200 ƒê·ªìng Kh·ªüi, Qu·∫≠n 1">
                <div id="sug-pickup" class="suggestions"></div>
                <div class="tools">
                    <button class="btn-icon btn-x" onclick="clearInp('pickup')">‚úï</button>
                    <button class="btn-icon btn-map" onclick="openMap('pickup')">üó∫Ô∏è</button>
                </div>
            </div>

            <button id="btn-add-stop" data-i18n="btn_add_stop" onclick="addStop()">+ Th√™m ƒëi·ªÉm d·ª´ng</button>
            <div id="stops-box"></div>
            
            <div class="input-group">
                <label for="dropoff" data-i18n="lbl_dropoff">ƒêi·ªÉm ƒë·∫øn:</label>
                <input type="text" id="dropoff" placeholder="VD: S√¢n bay T√¢n S∆°n Nh·∫•t (TSN)">
                <div id="sug-dropoff" class="suggestions"></div>
                <div class="tools">
                    <button class="btn-icon btn-x" onclick="clearInp('dropoff')">‚úï</button>
                    <button class="btn-icon btn-map" onclick="openMap('dropoff')">üó∫Ô∏è</button>
                </div>
            </div>
        </div>

        <div class="section-box options">
            <h3 data-i18n="sec_opt">üöò T√ôY CH·ªåN</h3>
            <div style="display: flex; gap: 15px;">
                <div class="input-group select-group" style="flex: 1;">
                    <label for="carType" data-i18n="lbl_car">Lo·∫°i xe:</label>
                    <select id="carType">
                        <option value="4" data-i18n="opt_4seat">üöó Xe 4 ch·ªó (10k/km)</option>
                        <option value="7" data-i18n="opt_7seat">üöê Xe 7 ch·ªó (12k/km)</option>
                    </select>
                </div>
                <div class="input-group select-group" style="flex: 1;">
                    <label for="tripType" data-i18n="lbl_type">H√¨nh th·ª©c:</label>
                    <select id="tripType" onchange="toggleWait()">
                        <option value="1" data-i18n="opt_1way">‚û°Ô∏è 1 Chi·ªÅu</option>
                        <option value="2" data-i18n="opt_2way">üîÑ 2 Chi·ªÅu (∆Øu ƒë√£i)</option>
                    </select>
                </div>
            </div>

            <div class="input-group" id="wait-area" style="display: none;">
                <label for="waitHour" data-i18n="lbl_wait">‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):</label>
                <input type="number" id="waitHour" value="0" min="0" step="0.5">
            </div>

            <div class="input-group select-group">
                <label for="driver" data-i18n="lbl_driver">T√†i x·∫ø:</label>
                <select id="driver">
                    <option value="system" data-i18n="opt_system">‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="note" data-i18n="lbl_note">üìù Y√™u c·∫ßu/Ghi ch√∫:</label>
                <textarea id="note" rows="3" placeholder="VD: ƒê√≥n ƒë√∫ng gi·ªù, xe s·∫°ch s·∫Ω, c√≥ b·∫≠t nh·∫°c tr·ªØ t√¨nh."></textarea>
            </div>
        </div>

        <button id="btn-calc" onclick="calculate()" data-i18n="btn_calc">üí∞ T√çNH GI√Å C∆Ø·ªöC</button>

        <div id="result-box">
            <h4 data-i18n="lbl_est_price">Gi√° d·ª± ki·∫øn</h4>
            <p class="price-row-detail"><span data-i18n="res_dist">Qu√£ng ƒë∆∞·ªùng:</span> <strong id="res-km">0 km</strong></p>
            <p class="price-row-detail"><span data-i18n="res_time">Th·ªùi gian:</span> <strong id="res-min">0 min</strong></p>
            <hr style="border-style: dashed; margin: 10px 0;">

            <div id="row-go" class="price-row-detail"></div>
            <div id="row-back-full" class="price-row-detail" style="display: none;">
                <span data-i18n="res_back_full">Gi√° chi·ªÅu v·ªÅ (Ch∆∞a gi·∫£m):</span> <strong id="val-back-full">0 ƒë</strong>
            </div>
            <div id="row-back-disc" class="price-row-detail" style="display: none;">
                <span data-i18n="res_return_disc">Gi√° chi·ªÅu v·ªÅ (Sau gi·∫£m):</span> <strong id="val-back-disc">0 ƒë</strong>
            </div>
            <div id="row-wait" class="price-row-detail" style="display: none;">
                <span data-i18n="res_wait_fee">Ph√≠ ch·ªù (sau 3h):</span> <strong id="val-wait">0 ƒë</strong>
            </div>
            
            <p style="font-weight: bold; margin-top: 10px; text-align: center;"><span data-i18n="res_total_final">**T·ªîNG C·ªòNG (Ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i):**</span> <span id="res-total">0 ƒë</span></p>

            <div id="row-deposit" class="price-row-detail" style="display: none; color: #28a745; font-weight: bold;">
                <span data-i18n="res_deposit">ƒê·∫∑t c·ªçc (20%):</span> <strong id="val-deposit">0 ƒë</strong>
            </div>
            
            <div class="notes">
                <p data-i18n="note_price">Gi√° 4 ch·ªó: 10k/km | 7 ch·ªó: 12k/km</p>
                <p data-i18n="note_disc">ƒêi 2 chi·ªÅu (1 chi·ªÅu >45km / T·ªïng >90km) gi·∫£m 40% chi·ªÅu v·ªÅ.</p>
                <p data-i18n="note_wait">Ch·ªù: Mi·ªÖn ph√≠ 3h ƒë·∫ßu. Sau ƒë√≥ 50k/h.</p>
                <p data-i18n="note_fee">Gi√° ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.</p>
            </div>
        </div>

        <div class="btn-book-group">
            <button id="btn-zalo" class="btn-book" onclick="preBook('zalo')">‚úÖ ƒê·∫∂T QUA ZALO</button>
            <button id="btn-mail" class="btn-book" onclick="preBook('mail')">üìß ƒê·∫∂T QUA MAIL</button>
        </div>
    </div>

    <div id="modal-map" class="modal">
        <div class="modal-content">
            <h4 data-i18n="modal_map_title">Ch·ªçn v·ªã tr√≠</h4>
            <div id="picker-map"></div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeMap()" data-i18n="btn_cancel">H·ªßy</button>
                <button class="btn-confirm" onclick="confirmMap()" data-i18n="btn_confirm">X√ÅC NH·∫¨N</button>
            </div>
        </div>
    </div>

    <div id="phone-modal" class="modal">
        <div class="modal-content">
            <h4 data-i18n="modal_phone_title">Nh·∫≠p S·ªë ƒêi·ªán Tho·∫°i</h4>
            <p data-i18n="modal_phone_desc">Nh√† xe c·∫ßn SƒêT ƒë·ªÉ li√™n h·ªá ƒë√≥n b·∫°n:</p>
            <input type="tel" id="quick-phone" placeholder="VD: 0912345678" style="width:100%; margin-bottom:15px;">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closePhoneModal()" data-i18n="btn_cancel">H·ªßy</button>
                <button class="btn-confirm" onclick="savePhoneAndBook()" data-i18n="btn_ok">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <script>
        const LANG={
            vi:{
                brand:"TR∆Ø·ªúNG AN DRIVING",sec_info:"üìã TH√îNG TIN",lbl_phone:"S·ªë ƒëi·ªán tho·∫°i:",lbl_time:"Th·ªùi gian ƒë√≥n:",sec_route:"üó∫Ô∏è L·ªò TR√åNH",btn_myloc:"üéØ V·ªã tr√≠ t√¥i",lbl_pickup:"ƒêi·ªÉm ƒë√≥n:",lbl_dropoff:"ƒêi·ªÉm ƒë·∫øn:",btn_add_stop:"+ Th√™m ƒëi·ªÉm d·ª´ng",sec_opt:"üöò T√ôY CH·ªåN",lbl_car:"Lo·∫°i xe:",opt_4seat:"üöó Xe 4 ch·ªó (10k/km)",opt_7seat:"üöê Xe 7 ch·ªó (12k/km)",lbl_type:"H√¨nh th·ª©c:",opt_1way:"‚û°Ô∏è 1 Chi·ªÅu",opt_2way:"üîÑ 2 Chi·ªÅu (∆Øu ƒë√£i)",lbl_wait:"‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):",lbl_driver:"T√†i x·∫ø:",opt_system:"‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)",lbl_note:"üìù Y√™u c·∫ßu/Ghi ch√∫:",btn_calc:"üí∞ T√çNH GI√Å C∆Ø·ªöC",lbl_est_price:"Gi√° d·ª± ki·∫øn",res_dist:"Qu√£ng ƒë∆∞·ªùng:",res_time:"Th·ªùi gian:",res_go_price:"Gi√° chi·ªÅu ƒëi:",res_back_full:"Gi√° chi·ªÅu v·ªÅ (Ch∆∞a gi·∫£m):",res_return_disc:"Gi√° chi·ªÅu v·ªÅ (Sau gi·∫£m):",res_wait_fee:"Ph√≠ ch·ªù (sau 3h):",res_deposit:"ƒê·∫∑t c·ªçc (20%):",res_total_final:"**T·ªîNG C·ªòNG (Ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i):**",note_price:"Gi√° 4 ch·ªó: 10k/km | 7 ch·ªó: 12k/km",note_disc:"ƒêi 2 chi·ªÅu (1 chi·ªÅu >45km / T·ªïng >90km) gi·∫£m 40% chi·ªÅu v·ªÅ.",note_wait:"Ch·ªù: Mi·ªÖn ph√≠ 3h ƒë·∫ßu. Sau ƒë√≥ 50k/h.",note_fee:"Gi√° ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.",modal_map_title:"Ch·ªçn v·ªã tr√≠",btn_confirm:"X√ÅC NH·∫¨N",modal_phone_title:"Nh·∫≠p S·ªë ƒêi·ªán Tho·∫°i",modal_phone_desc:"Nh√† xe c·∫ßn SƒêT ƒë·ªÉ li√™n h·ªá ƒë√≥n b·∫°n:",btn_cancel:"H·ªßy",btn_ok:"X√°c nh·∫≠n",
                plh_phone:"VD: 0912345678", plh_pickup:"VD: 200 ƒê·ªìng Kh·ªüi, Qu·∫≠n 1", plh_dropoff:"VD: S√¢n bay T√¢n S∆°n Nh·∫•t (TSN)", plh_stop:"ƒê·ªãa ch·ªâ ƒëi·ªÉm d·ª´ng (n·∫øu c√≥)...", plh_note:"VD: ƒê√≥n ƒë√∫ng gi·ªù, xe s·∫°ch s·∫Ω, c√≥ b·∫≠t nh·∫°c tr·ªØ t√¨nh."
            },
            en:{
                brand:"TRUONG AN DRIVING",sec_info:"üìã INFORMATION",lbl_phone:"Phone Number:",lbl_time:"Pickup Time:",sec_route:"üó∫Ô∏è ROUTE",btn_myloc:"üéØ My Location",lbl_pickup:"Pick-up:",lbl_dropoff:"Drop-off:",btn_add_stop:"+ Add Stop",sec_opt:"üöò OPTIONS",lbl_car:"Car Type:",opt_4seat:"üöó 4 Seats (10k/km)",opt_7seat:"üöê 7 Seats (12k/km)",lbl_type:"Trip Type:",opt_1way:"‚û°Ô∏è One way",opt_2way:"üîÑ Round trip",lbl_wait:"‚è≥ Waiting (Free 3h):",lbl_driver:"Driver:",opt_system:"‚≠ê System (Fastest)",lbl_note:"üìù Request/Note:",btn_calc:"üí∞ CALCULATE PRICE",lbl_est_price:"Estimated Price",res_dist:"Distance:",res_time:"Duration:",res_go_price:"One-way Price:",res_back_full:"Return Price (Before Disc.):",res_return_disc:"Return Price (After Discount):",res_wait_fee:"Waiting Fee (After 3h):",res_deposit:"Deposit (20%):",res_total_final:"**TOTAL (Tolls/Parking not included):**",note_price:"4 Seats: 10k/km | 7 Seats: 12k/km",note_disc:"Round trip (One-way >45km / Total >90km) get 40% off return.",note_wait:"Waiting: Free first 3h. Then 50k/h.",note_fee:"Tolls/Parking not included.",modal_map_title:"Pick Location",btn_confirm:"CONFIRM",modal_phone_title:"Enter Phone Number",modal_phone_desc:"We need your phone to contact:",btn_cancel:"Cancel",btn_ok:"Confirm",
                plh_phone:"Ex: 0912345678", plh_pickup:"Ex: 200 Dong Khoi, Dist 1", plh_dropoff:"Ex: Tan Son Nhat Airport (TSN)", plh_stop:"Stop address (if any)...", plh_note:"Ex: Be on time, clean car, soft music."
            },
            cn:{
                brand:"ÈïøÂÆâÈ©æÈ©∂",sec_info:"üìã ‰ø°ÊÅØ",lbl_phone:"ÁîµËØùÂè∑Á†Å:",lbl_time:"Êé•ËΩ¶Êó∂Èó¥:",sec_route:"üó∫Ô∏è Ë∑ØÁ∫ø",btn_myloc:"üéØ ÊàëÁöÑ‰ΩçÁΩÆ",lbl_pickup:"‰∏äËΩ¶Âú∞ÁÇπ:",lbl_dropoff:"‰∏ãËΩ¶Âú∞ÁÇπ:",btn_add_stop:"+ Â¢ûÂä†Á´ôÁÇπ",sec_opt:"üöò ËΩ¶ÂûãÈÄâÊã©",lbl_car:"ËΩ¶Âûã:",opt_4seat:"üöó 4Â∫ß (10k/km)",opt_7seat:"üöê 7Â∫ß (12k/km)",lbl_type:"Ë°åÁ®ãÁ±ªÂûã:",opt_1way:"‚û°Ô∏è ÂçïÁ®ã",opt_2way:"üîÑ ÂæÄËøî",lbl_wait:"‚è≥ Á≠âÂæÖ (ÂÖçË¥π3h):",lbl_driver:"Âè∏Êú∫:",opt_system:"‚≠ê Á≥ªÁªüÂàÜÈÖç (ÊúÄÂø´)",lbl_note:"üìù Ë¶ÅÊ±Ç/Â§áÊ≥®:",btn_calc:"üí∞ ËÆ°ÁÆó‰ª∑Ê†º",lbl_est_price:"È¢ÑËÆ°‰ª∑Ê†º",res_dist:"Ë∑ùÁ¶ª:",res_time:"Êó∂Èó¥:",res_go_price:"ÂçïÁ®ã‰ª∑Ê†º:",res_back_full:"ËøîÁ®ã‰ª∑Ê†º (ÊäòÊâ£Ââç):",res_return_disc:"ËøîÁ®ã‰ª∑Ê†º (ÊäòÊâ£Âêé):",res_wait_fee:"Á≠âÂæÖË¥π (Ë∂ÖËøá3Â∞èÊó∂):",res_deposit:"ÂÆöÈáë (20%):",res_total_final:"**ÊÄª‰ª∑ (‰∏çÂê´ËøáË∑ØË¥π/ÂÅúËΩ¶Ë¥π):**",note_price:"4Â∫ß: 10k/km | 7Â∫ß: 12k/km",note_disc:"ÂæÄËøî (ÂçïÁ®ã>45km / ÊÄªÁ®ã>90km) ËøîÁ®ãÂáè40%„ÄÇ",note_wait:"Á≠âÂæÖ: Ââç3Â∞èÊó∂ÂÖçË¥π„ÄÇ‰πãÂêé 50k/Â∞èÊó∂„ÄÇ",note_fee:"‰ª∑Ê†º‰∏çÂê´ËøáË∑ØË¥π/ÂÅúËΩ¶Ë¥π„ÄÇ",modal_map_title:"ÈÄâÊã©‰ΩçÁΩÆ",btn_confirm:"Á°ÆËÆ§",modal_phone_title:"ËæìÂÖ•ÁîµËØùÂè∑Á†Å",modal_phone_desc:"Êàë‰ª¨ÈúÄË¶ÅÊÇ®ÁöÑÁîµËØùÂè∑Á†Å‰ª•‰æøËÅîÁ≥ª:",btn_cancel:"ÂèñÊ∂à",btn_ok:"Á°ÆËÆ§",
                plh_phone:"‰æã: 0912345678", plh_pickup:"‰æã: 200 ƒê·ªìng Kh·ªüi, 1Âå∫", plh_dropoff:"‰æã: Êñ∞Â±±‰∏ÄÊú∫Âú∫ (TSN)", plh_stop:"ÂÅúÈù†ÁÇπÂú∞ÂùÄ...", plh_note:"‰æã: ÂáÜÊó∂Êé•ËΩ¶ÔºåËΩ¶ÂÜÖÂπ≤ÂáÄÔºåÊí≠ÊîæËàíÁºìÈü≥‰πê„ÄÇ"
            }
        };
        let curLang='vi';
        const CFG={p4:10000,p7:12000,wait:50000};
        
        let map,pickerMap,routeL,activeInp,pendingMethod;
        let cachedPrices = {go: 0, back_full: 0, back_disc: 0, wait: 0, deposit: 0, total: 0, isDiscounted: false, km: 0, time: 0};
        let isSelecting = false; // Bi·∫øn c·ªù ƒë·ªÉ qu·∫£n l√Ω s·ª± ki·ªán ch·ªçn g·ª£i √Ω

        window.onload=()=>{
            // Kh·ªüi t·∫°o b·∫£n ƒë·ªì ch√≠nh (S·ª≠ d·ª•ng OpenStreetMap)
            try {
                map=L.map('main-map').setView([10.7769,106.7009],13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            } catch(e) {
                console.error("L·ªói kh·ªüi t·∫°o Leaflet/B·∫£n ƒë·ªì ch√≠nh:", e);
            }

            let now=new Date(); now.setMinutes(now.getMinutes()+30-now.getTimezoneOffset());
            document.getElementById('time').value=now.toISOString().slice(0,16);
            
            // Setup events
            setupInp('phone');
            setupAddressInputs('pickup');
            setupAddressInputs('dropoff');
            document.getElementById('btn-loc').addEventListener('click', getMyLoc);

            setLang('vi');
        };

        function setLang(lang){
            curLang=lang;
            document.querySelectorAll('[data-i18n]').forEach(el=>{
                const key=el.getAttribute('data-i18n');
                if(LANG[lang][key]){
                    if(el.tagName === 'OPTION' && key.startsWith('opt_')){
                        el.textContent = LANG[lang][key];
                    } else if(el.tagName === 'INPUT' && key.startsWith('plh_')) {
                        el.placeholder = LANG[lang][key];
                    } else if(el.tagName === 'TEXTAREA' && key.startsWith('plh_')) {
                         el.placeholder = LANG[lang][key];
                    } else {
                        el.textContent=LANG[lang][key];
                    }
                }
            });
            // C·∫≠p nh·∫≠t Placeholder
            document.getElementById('phone').placeholder = LANG[lang].plh_phone;
            document.getElementById('pickup').placeholder = LANG[lang].plh_pickup;
            document.getElementById('dropoff').placeholder = LANG[lang].plh_dropoff;
            document.getElementById('note').placeholder = LANG[lang].plh_note;
            document.querySelectorAll('.stop-inp').forEach(inp => inp.placeholder = LANG[lang].plh_stop);


            document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');

            if(cachedPrices.total > 0) updateResultDisplay();
        }

        // --- H√ÄM CHUNG CHO INPUTS ---
        function setupInp(id){
            let el=document.getElementById(id);
            el.addEventListener('input',function(){toggleX(this)}); 
            el.addEventListener('focus',()=>toggleX(el));
        }
        
        // --- C·∫¢I TI·∫æN: H√ÄM G·ª¢I √ù ƒê·ªäA CH·ªà & GEOCoding ---
        function setupAddressInputs(id){
            let el=document.getElementById(id);
            el.addEventListener('input',function(){
                if (isSelecting) { isSelecting = false; return; }
                toggleX(this);
                searchAddr(this); 
            });
            el.addEventListener('focus',function(){
                if (isSelecting) { isSelecting = false; return; }
                toggleX(el);
                if (el.value.trim().length >= 3) searchAddr(el);
            });
            el.addEventListener('blur', function() {
                // ƒê·ª£i 100ms ƒë·ªÉ ki·ªÉm tra xem c√≥ click v√†o g·ª£i √Ω kh√¥ng
                setTimeout(hideSuggestions, 100); 
            });
        }

        function hideSuggestions(){
            document.querySelectorAll('.suggestions').forEach(s=>s.style.display='none');
        }
        
        function toggleX(i){let b=i.parentElement.querySelector('.btn-x');if(b)b.style.display=i.value?'flex':'none'}
        function clearInp(id){let i=document.getElementById(id);i.value='';delete i.dataset.lat;delete i.dataset.lon;toggleX(i);document.getElementById(`sug-${id}`)?.style.display='none';}

        let timer;
        // Logic T√¨m ki·∫øm ƒê·ªãa ch·ªâ b·∫±ng Nominatim (Mi·ªÖn ph√≠)
        function searchAddr(inp){
            clearTimeout(timer);
            let box=inp.parentElement.querySelector('.suggestions');
            let valueToSearch = inp.value.trim();
            box.innerHTML='';
            if(valueToSearch.length<3){box.style.display='none';return}
            
            // B·ªè qua logic t·ªça ƒë·ªô/plus code ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a qu√° tr√¨nh cho ng∆∞·ªùi d√πng
            
            // T√¨m ki·∫øm ƒê·ªãa ch·ªâ th√¥ng th∆∞·ªùng
            timer=setTimeout(()=>{
                let query = valueToSearch;
                
                // Gi·ªõi h·∫°n t√¨m ki·∫øm trong Vi·ªát Nam
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&countrycodes=vn&addressdetails=0`;
                
                fetch(url)
                .then(r=>r.json()).then(d=>{
                    if(!d || d.length===0){box.style.display='none';return}
                    
                    hideSuggestions(); 

                    d.forEach(i=>{
                        let div=document.createElement('div');div.className='sug-item';
                        let name = i.display_name;
                        let lat = parseFloat(i.lat).toFixed(6); 
                        let lon = parseFloat(i.lon).toFixed(6); 

                        div.innerText=`üìç ${name}`;
                        // D√πng onmousedown ƒë·ªÉ ngƒÉn s·ª± ki·ªán blur khi ch·ªçn g·ª£i √Ω
                        div.onmousedown=(e)=>{ 
                            e.preventDefault(); 
                            isSelecting = true; 
                            inp.value=name;
                            inp.dataset.lat=lat;
                            inp.dataset.lon=lon;
                            hideSuggestions(); 
                            toggleX(inp);
                        };
                        box.appendChild(div);
                    });
                    box.style.display='block';
                })
                .catch(e => { console.error("L·ªói t√¨m ki·∫øm ƒë·ªãa ch·ªâ (Nominatim API):", e); box.style.display='none'; });
            },250); 
        }
        
        // Tra ng∆∞·ª£c T·ªça ƒë·ªô sang ƒê·ªãa ch·ªâ (Mi·ªÖn ph√≠)
        function reverseGeocode(lat, lon, inp) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=18&addressdetails=0`;
            fetch(url)
            .then(r=>r.json()).then(d=>{
                const fixedLat = parseFloat(lat).toFixed(6);
                const fixedLon = parseFloat(lon).toFixed(6);
                if(d.display_name) {
                    inp.value = d.display_name;
                } else {
                    inp.value = `${fixedLat}, ${fixedLon}`; 
                }
                inp.dataset.lat = fixedLat;
                inp.dataset.lon = fixedLon;
                toggleX(inp);
            })
            .catch(e => { 
                console.error("L·ªói Reverse Geocoding (Nominatim):", e); 
                inp.value = `${parseFloat(lat).toFixed(6)}, ${parseFloat(lon).toFixed(6)}`; 
                inp.dataset.lat = parseFloat(lat).toFixed(6);
                inp.dataset.lon = parseFloat(lon).toFixed(6);
                toggleX(inp); 
            });
        }

        // --- LOGIC ƒêI·ªÇM D·ª™NG V√Ä MAPS ---
        document.addEventListener('click',e=>{if(!e.target.closest('.input-group'))hideSuggestions()});

        function addStop(){
            let plh = LANG[curLang].plh_stop;
            let newId = 'stop-' + Date.now();
            let div=document.createElement('div');div.className='input-group stop-item';
            
            // C·∫•u tr√∫c HTML cho ƒëi·ªÉm d·ª´ng
            div.innerHTML=`<label for="${newId}">ƒêi·ªÉm d·ª´ng:</label><input type="text" id="${newId}" class="stop-inp" placeholder="${plh}"><div id="sug-${newId}" class="suggestions"></div><div class="tools"><button class="btn-icon btn-x" onclick="clearInp('${newId}')">‚úï</button><button class="btn-icon btn-trash" onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button><button class="btn-icon btn-map" onclick="openMapStop(this)">üó∫Ô∏è</button></div>`;
            
            document.getElementById('stops-box').appendChild(div);
            setupAddressInputs(newId); 
        }

        function openMapStop(btn){activeInp=btn.parentElement.parentElement.querySelector('input');openModalMap()}
        function openMap(id){activeInp=document.getElementById(id);openModalMap()}
        
        // C·∫£i ti·∫øn: T·ªëi ∆∞u kh·ªüi t·∫°o/hi·ªÉn th·ªã b·∫£n ƒë·ªì trong Modal (Kh·∫Øc ph·ª•c l·ªói Maps)
        function openModalMap(){
            document.getElementById('modal-map').style.display='flex';
            try {
                if(!pickerMap){
                    pickerMap=L.map('picker-map').setView([10.7769,106.7009],13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);
                }
                
                // B·∫Øt bu·ªôc g·ªçi invalidateSize khi modal hi·ªán l√™n ƒë·ªÉ b·∫£n ƒë·ªì hi·ªÉn th·ªã ƒë√∫ng
                setTimeout(()=>pickerMap.invalidateSize(), 200); 
                
                // ƒê·∫∑t v·ªã tr√≠ b·∫£n ƒë·ªì
                if (activeInp.dataset.lat && activeInp.dataset.lon) {
                    pickerMap.setView([activeInp.dataset.lat, activeInp.dataset.lon], 15);
                } else if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p=>pickerMap.setView([p.coords.latitude,p.coords.longitude],15));
                } else {
                    pickerMap.setView([10.7769,106.7009],13);
                }
                
            } catch(e) {
                 console.error("L·ªói kh·ªüi t·∫°o Leaflet/B·∫£n ƒë·ªì ch·ªçn:", e);
                 alert("L·ªói kh·ªüi t·∫°o b·∫£n ƒë·ªì. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.");
            }
        }
        function closeMap(){document.getElementById('modal-map').style.display='none'}
        
        function confirmMap(){
            let c=pickerMap.getCenter();
            activeInp.dataset.lat=c.lat.toFixed(6);activeInp.dataset.lon=c.lng.toFixed(6); 
            reverseGeocode(c.lat, c.lng, activeInp); 
            closeMap();
        }
        
        function getMyLoc(){
            let btn=document.getElementById('btn-loc'); btn.innerText=LANG[curLang].btn_myloc.replace('üéØ','‚è≥'); 
            btn.disabled = true; // V√¥ hi·ªáu h√≥a n√∫t trong khi t√¨m ki·∫øm
            if(!navigator.geolocation){
                alert(curLang=='vi'?"L·ªói GPS":"GPS Error");
                btn.innerText=LANG[curLang].btn_myloc; btn.disabled = false;
                return;
            }
            navigator.geolocation.getCurrentPosition(p=>{
                let i=document.getElementById('pickup');
                let lat=p.coords.latitude, lon=p.coords.longitude;
                
                i.dataset.lat=lat.toFixed(6); i.dataset.lon=lon.toFixed(6);
                toggleX(i);
                btn.innerText=LANG[curLang].btn_myloc;
                btn.disabled = false;

                reverseGeocode(lat, lon, i); 

            },()=>{
                alert(curLang=='vi'?"Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng b·∫≠t GPS!":"Cannot get location. Please turn on GPS!");
                btn.innerText=LANG[curLang].btn_myloc;
                btn.disabled = false;
            },{enableHighAccuracy:true,timeout:5000});
        }

        // --- LOGIC T√çNH GI√Å ---
        function toggleWait(){document.getElementById('wait-area').style.display=document.getElementById('tripType').value=='2'?'block':'none'}
        
        function updateResultDisplay() {
            const p = cachedPrices;
            const totalFinal = p.total.toLocaleString() + ' ƒë';

            document.getElementById('res-total').innerText = totalFinal;
            
            // Chi·ªÅu ƒëi
            document.getElementById('row-go').innerHTML = `<span data-i18n="res_go_price">${LANG[curLang].res_go_price}:</span> <strong id="val-go">${p.go.toLocaleString()} ƒë</strong>`;
            
            // Chi·ªÅu v·ªÅ
            if (p.back_full > 0) {
                 document.getElementById('row-back-full').style.display = 'flex'; 
                 const fullPrice = p.back_full.toLocaleString() + ' ƒë';
                 
                 document.getElementById('val-back-full').innerHTML = p.isDiscounted ? `<s>${fullPrice}</s>` : `${fullPrice}`;
                 
                 if (p.isDiscounted) {
                     document.getElementById('row-back-disc').style.display = 'flex';
                     const discountAmount = p.back_full - p.back_disc;
                     document.getElementById('val-back-disc').innerHTML = `${p.back_disc.toLocaleString()} ƒë (-${discountAmount.toLocaleString()}ƒë)`;
                 } else {
                     document.getElementById('row-back-disc').style.display = 'none';
                 }
            } else {
                document.getElementById('row-back-full').style.display = 'none';
                document.getElementById('row-back-disc').style.display = 'none';
            }

            // Ph√≠ ch·ªù
            document.getElementById('row-wait').style.display = p.wait > 0 ? 'flex' : 'none';
            document.getElementById('val-wait').innerText = p.wait.toLocaleString() + ' ƒë';

            // ƒê·∫∑t c·ªçc
            document.getElementById('row-deposit').style.display = p.deposit > 0 ? 'flex' : 'none';
            if (p.deposit > 0) document.getElementById('val-deposit').innerText = p.deposit.toLocaleString() + ' ƒë';
        }


        async function calculate(){
            let p=document.getElementById('pickup'),d=document.getElementById('dropoff');
            
            // Y√™u c·∫ßu t·ªça ƒë·ªô ch√≠nh x√°c cho Pickup v√† Dropoff
            if(!p.dataset.lat||!d.dataset.lat)return alert(LANG[curLang].plh_pickup.includes('VD:') ? "Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ ƒë√≥n/ƒë·∫øn (h·ªá th·ªëng c·∫ßn t·ªça ƒë·ªô ch√≠nh x√°c)!" : "Please select or enter all pickup/drop-off addresses (system needs precise coordinates)!");
            
            let btn=document.getElementById('btn-calc');btn.disabled=true;btn.style.opacity=0.7;
            
            let points=[p,...document.querySelectorAll('.stop-inp')].filter(x=>x.dataset.lat);
            if (d.dataset.lat) points.push(d); 

            if (points.length < 2) {
                 alert(LANG[curLang].plh_pickup.includes('VD:') ? "Vui l√≤ng ch·ªçn √≠t nh·∫•t ƒêi·ªÉm ƒë√≥n v√† ƒêi·ªÉm ƒë·∫øn!" : "Please select at least Pickup and Drop-off points!");
                 btn.disabled=false;btn.style.opacity=1;
                 return;
            }

            // D√πng OSRM (Mi·ªÖn ph√≠) ƒë·ªÉ t√≠nh l·ªô tr√¨nh
            let coord=points.map(x=>`${x.dataset.lon},${x.dataset.lat}`).join(';');
            
            try{
                let res=await fetch(`https://router.project-osrm.org/route/v1/driving/${coord}?overview=full&geometries=geojson`);
                let data=await res.json();
                if(data.code!=='Ok')throw 'API Error: '+data.message;
                
                let r=data.routes[0], km=r.distance/1000, time=Math.round(r.duration/60);
                
                let type=document.getElementById('tripType').value, unit=document.getElementById('carType').value=='4'?CFG.p4:CFG.p7;
                
                let priceGo = Math.round(km * unit);
                let priceBackFull = (type === '2') ? priceGo : 0;
                
                let isDiscounted = (type=='2' && km>=45);
                let priceBackDisc = isDiscounted ? Math.round(priceBackFull * 0.6) : priceBackFull; 
                
                let waitHours = parseFloat(document.getElementById('waitHour').value) || 0;
                let paidWaitHours = Math.max(0, waitHours - 3);
                let priceWait = waitHours > 0 ? Math.round(paidWaitHours * CFG.wait) : 0;
                
                let total = priceGo + priceBackDisc + priceWait; 
                let deposit = (type=='2') ? Math.round(total * 0.2) : 0;

                cachedPrices = {
                    go: priceGo,
                    back_full: priceBackFull,
                    back_disc: priceBackDisc,
                    wait: priceWait,
                    deposit: deposit,
                    total: total,
                    isDiscounted: isDiscounted,
                    km: km,
                    time: time
                };
                
                // V·∫Ω l·∫°i l·ªô tr√¨nh tr√™n b·∫£n ƒë·ªì ch√≠nh
                if(routeL)map.removeLayer(routeL);
                routeL=L.geoJSON(r.geometry).addTo(map);map.fitBounds(routeL.getBounds(),{padding:[30,30]});

                document.getElementById('result-box').style.display='block';
                document.getElementById('res-km').innerText=km.toFixed(1)+' km';
                document.getElementById('res-min').innerText=time+' min';
                
                updateResultDisplay();
                
            }catch(e){
                alert(LANG[curLang].plh_pickup.includes('VD:') ? 'L·ªói t√≠nh c∆∞·ªõc! Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ ho·∫∑c k·∫øt n·ªëi m·∫°ng. (OSRM)' : 'Pricing error! Please check the address or network connection. (OSRM)');
                console.error("L·ªói t√≠nh c∆∞·ªõc OSRM:", e);
            }
            btn.disabled=false;btn.style.opacity=1;
        }

        // --- LOGIC ƒê·∫∂T XE ---
        function preBook(m){
            if(!document.getElementById('phone').value){
                pendingMethod=m;
                document.getElementById('phone-modal').style.display='flex';
                document.getElementById('quick-phone').focus();
            }
            else {
                finalBook(m);
            }
        }
        function closePhoneModal(){document.getElementById('phone-modal').style.display='none'}
        function savePhoneAndBook(){
            let p=document.getElementById('quick-phone').value;
            if(p.length<8)return alert(LANG[curLang].plh_pickup.includes('VD:') ? "SƒêT l·ªói!" : "Phone number invalid!");
            document.getElementById('phone').value=p;closePhoneModal();finalBook(pendingMethod);
        }

        const shortC = (l) => parseFloat(l).toFixed(6); 
        
        // T·∫°o URL Google Maps (Gi·ªØ nguy√™n theo logic c≈©)
        const createMapUrl = (lat, lon) => `https://www.google.com/maps/search/?api=1&query=${shortC(lat)},${shortC(lon)}`;


        function finalBook(method){
            try{
                let p=document.getElementById('pickup'), d=document.getElementById('dropoff');
                if(cachedPrices.total === 0)return alert(LANG[curLang].plh_pickup.includes('VD:') ? "Ch∆∞a t√≠nh gi√°! Vui l√≤ng nh·∫•n n√∫t T√≠nh Gi√° C∆∞·ªõc tr∆∞·ªõc." : "Price not calculated! Please press the Calculate Price button first.");
                
                let lat1=p.dataset.lat, lon1=p.dataset.lon;
                let lat2=d.dataset.lat, lon2=d.dataset.lon;
                const prices = cachedPrices;
                
                let info={
                    ph:document.getElementById('phone').value,
                    t:document.getElementById('time').value.replace('T',' '),
                    p:p.value, d:d.value,
                    km:prices.km.toFixed(1) + ' km',
                    time:prices.time + ' min',
                    car:document.getElementById('carType').selectedOptions[0].text,
                    type:document.getElementById('tripType').selectedOptions[0].text,
                    note:document.getElementById('note').value.trim()
                };
                
                // X·ª≠ l√Ω ƒëi·ªÉm d·ª´ng
                let stopElements = [...document.querySelectorAll('.stop-inp')].filter(el => el.dataset.lat);
                let stopsInfo = stopElements.map((el, index) => {
                    let s_lat = el.dataset.lat;
                    let s_lon = el.dataset.lon;
                    let s_val = el.value;
                    let stopLink = createMapUrl(s_lat, s_lon); 
                    return `\n\nüìå D·ª´ng ${index+1}: ${s_val}\n   ‚îî GPS: ${shortC(s_lat)},${shortC(s_lon)}\n   üëâ Map: ${stopLink}`;
                }).join('');
                
                let mapPickup = createMapUrl(lat1, lon1);
                let mapDropoff = createMapUrl(lat2, lon2);
                
                // X·ª≠ l√Ω chi ti·∫øt gi√°
                let priceDetail = `\n\n--- CHI TI·∫æT GI√Å C∆Ø·ªöC ---\n`;
                priceDetail += `1. Qu√£ng ƒë∆∞·ªùng: ${info.km}\n`;
                priceDetail += `2. Th·ªùi gian: ${info.time}\n`;
                priceDetail += `3. Gi√° chi·ªÅu ƒëi: ${prices.go.toLocaleString()} ƒë\n`;
                
                if (prices.back_full > 0) {
                     if (prices.isDiscounted) {
                         priceDetail += `4. Gi√° chi·ªÅu v·ªÅ (Ch∆∞a gi·∫£m): ${prices.back_full.toLocaleString()} ƒë\n`;
                         priceDetail += `5. Gi·∫£m gi√° 40% (Chi·ªÅu v·ªÅ): -${(prices.back_full - prices.back_disc).toLocaleString()} ƒë\n`;
                         priceDetail += `6. Gi√° chi·ªÅu v·ªÅ (Sau gi·∫£m): ${prices.back_disc.toLocaleString()} ƒë\n`;
                     } else {
                          priceDetail += `4. Gi√° chi·ªÅu v·ªÅ: ${prices.back_full.toLocaleString()} ƒë\n`;
                     }
                }
                if (prices.wait > 0) {
                     let paidWaitHours = Math.max(0, parseFloat(document.getElementById('waitHour').value) - 3);
                     priceDetail += `7. Ph√≠ ch·ªù (Sau 3h - ${paidWaitHours}h): ${prices.wait.toLocaleString()} ƒë\n`;
                }

                priceDetail += `\n**T·ªîNG C·ªòNG (Ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i):** ${prices.total.toLocaleString()} ƒë\n`;
                
                if(prices.deposit > 0)
                    priceDetail += `\nüí≥ C·ªçc (20%): ${prices.deposit.toLocaleString()} ƒë`;

                let msg=`üöñ Y√äU C·∫¶U ƒê·∫∂T XE\n----------------\n`;
                msg += `üìû SƒêT: ${info.ph}\n`;
                msg += `üïí ƒê√≥n l√∫c: ${info.t}\n`;
                msg += `üöò Xe: ${info.car} | ${info.type}\n`;
                msg += `\n--- L·ªò TR√åNH ---\n`;
                msg += `üìç ƒê√≥n: ${info.p}\n   ‚îî GPS: ${shortC(lat1)},${shortC(lon1)}\n   üëâ Map: ${mapPickup}`; 
                msg += stopsInfo; 
                msg += `\n\nüèÅ ƒê·∫øn: ${info.d}\n   ‚îî GPS: ${shortC(lat2)},${shortC(lon2)}\n   üëâ Map: ${mapDropoff}`; 
                msg += priceDetail;
                
                if (info.note) {
                     msg += `\n\n--- Y√äU C·∫¶U KH√ÅCH H√ÄNG ---\n`;
                     msg += `üìù ${info.note}`;
                }

                if(method=='zalo'){
                    navigator.clipboard.writeText(msg).then(()=>{
                        alert(LANG[curLang].plh_pickup.includes('VD:') ? "ƒê√£ copy th√¥ng tin ƒë·∫∑t xe v√†o b·ªô nh·ªõ ƒë·ªám! Vui l√≤ng m·ªü Zalo v√† d√°n tin nh·∫Øn ƒë·ªÉ g·ª≠i ƒë·∫øn Zalo 084.752.6893." : "Booking details copied to clipboard! Please open Zalo and paste the message to send."); 
                        window.open('https://zalo.me/0847526893');
                    }).catch(()=>{alert(LANG[curLang].plh_pickup.includes('VD:') ? "L·ªói copy! Vui l√≤ng copy th·ªß c√¥ng." : "Copy error! Please copy manually.")});
                }else{
                    window.location.href=`mailto:truongan.driving@gmail.com?subject=BOOKING XE TRUONG AN&body=${encodeURIComponent(msg)}`;
                }
            }catch(e){alert(LANG[curLang].plh_pickup.includes('VD:') ? "L·ªói t·∫°o ƒë∆°n h√†ng! Vui l√≤ng T√≠nh Gi√° C∆∞·ªõc tr∆∞·ªõc khi ƒë·∫∑t." : "Order creation error! Please Calculate Price before booking.")}
        }
    </script>
</body>
</html>
