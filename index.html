<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TR∆Ø·ªúNG AN DRIVING</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- C·∫§U H√åNH C∆† B·∫¢N --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; display: flex; justify-content: center; }
        .container { max-width: 600px; width: 100%; background: white; min-height: 100vh; padding-bottom: 80px; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        
        /* HEADER - XANH L√Å CHU·∫®N */
        header { background-color: #28a745; padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .brand-name { font-weight: 900; font-size: 18px; text-transform: uppercase; margin: 0; }
        .hotline { font-size: 14px; color: #ffeb3b; font-weight: bold; text-decoration: none; display: block; margin-top: 2px; }
        .lang-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 3px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; }
        .lang-btn.active { background: white; color: #28a745; font-weight: bold; }

        /* KHUNG CH·ª®A N·ªòI DUNG */
        .section { padding: 15px; border-bottom: 8px solid #f4f6f8; }
        .sec-title { color: #28a745; font-weight: 700; font-size: 15px; text-transform: uppercase; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        /* N√öT V·ªä TR√ç T√îI (ƒê·ªé) */
        .btn-myloc { color: #dc3545; font-size: 13px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; background: none; border: none; }
        .btn-myloc:hover { text-decoration: underline; }

        /* INPUT FORM */
        .form-group { margin-bottom: 15px; position: relative; }
        .form-label { font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; display: block; }
        
        input, select, textarea { width: 100%; padding: 12px; padding-right: 45px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; box-sizing: border-box; background: #fff; transition: border 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #28a745; }
        textarea { resize: none; height: 80px; }

        /* C√îNG C·ª§ INPUT (X√≥a, Map) */
        .input-tools { position: absolute; right: 5px; top: 32px; display: flex; gap: 5px; }
        .tool-btn { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-x { background: #f1f3f5; color: #888; display: none; }
        .btn-map { background: #28a745; color: white; }
        
        /* G·ª¢I √ù ƒê·ªäA CH·ªà (Fix l·ªói hi·ªÉn th·ªã) */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; z-index: 999; max-height: 250px; overflow-y: auto; border-radius: 0 0 8px 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); display: none; }
        .sug-item { padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #333; }
        .sug-item:hover { background: #f0f8ff; }
        .sug-item i { color: #888; }

        /* N√öT B·∫§M */
        .btn-add-stop { width: 100%; background: white; border: 1px dashed #28a745; color: #28a745; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px; }
        
        .btn-calc { width: 100%; background: #28a745; color: white; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: 900; text-transform: uppercase; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; items-align: center; gap: 8px; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3); }
        .btn-calc:active { transform: scale(0.98); }

        /* K·∫æT QU·∫¢ T√çNH TO√ÅN */
        #result-area { display: none; padding: 15px; background: #e8f5e9; border: 1px solid #c8e6c9; border-radius: 10px; margin-top: 20px; animation: fadeIn 0.3s; }
        
        /* CHI TI·∫æT GI√Å - Fix l·ªói hi·ªÉn th·ªã */
        .price-header { text-align: center; color: #28a745; font-weight: bold; font-size: 16px; margin-bottom: 10px; text-transform: uppercase; }
        .total-price-big { font-size: 26px; color: #dc3545; font-weight: 900; text-align: center; margin: 10px 0; border-top: 1px dashed #aaa; padding-top: 10px; }
        
        .detail-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #ddd; }
        .detail-row:last-child { border-bottom: none; }
        .detail-row span { color: #555; }
        .detail-row strong { color: #333; }
        
        /* G·∫°ch b·ªè gi√° c≈© */
        .old-price { text-decoration: line-through; color: #999; font-size: 0.9em; margin-right: 5px; }
        .discount-tag { color: #28a745; font-weight: bold; }

        /* TH√îNG TIN GHI CH√ö CU·ªêI TRANG */
        .footer-notes { margin-top: 15px; font-size: 13px; color: #666; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .note-item { margin-bottom: 4px; display: flex; gap: 6px; }
        .note-item i { color: #28a745; margin-top: 3px; }

        /* N√öT ƒê·∫∂T XE (Fixed Bottom) */
        .bottom-actions { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: white; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); z-index: 100; }
        .act-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 15px; display: flex; justify-content: center; align-items: center; gap: 5px; text-transform: uppercase; }
        .btn-zalo { background: #0068ff; }
        .btn-mail { background: #dc3545; }

        /* MAPS */
        #main-map { height: 250px; width: 100%; border-radius: 8px; margin-top: 15px; border: 1px solid #ccc; display: none; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 70vh; }
        .modal-header { background: #28a745; color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        #picker-map { width: 100%; height: 100%; position: relative; }
        .center-marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 1000; width: 40px; pointer-events: none; }
        .modal-footer { padding: 10px; background: white; text-align: center; }
        .btn-confirm { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <div>
        <div class="brand-name" data-i18n="brand">TR∆Ø·ªúNG AN DRIVING</div>
        <a href="tel:0847526893" class="hotline">‚òéÔ∏è 084.752.6893</a>
    </div>
    <div style="display:flex; gap:5px;">
        <button class="lang-btn active" onclick="setLang('vi')">VN</button>
        <button class="lang-btn" onclick="setLang('en')">EN</button>
        <button class="lang-btn" onclick="setLang('cn')">CN</button>
    </div>
</header>

<div class="container">

    <div class="section">
        <div class="sec-title"><i class="fas fa-user-edit"></i> TH√îNG TIN</div>
        <div class="form-group">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="phone" placeholder="VD: 0912345678">
            <div class="input-tools"><button class="tool-btn btn-x" onclick="clearInp('phone')">‚úï</button></div>
        </div>
        <div class="form-group">
            <label class="form-label">Th·ªùi gian ƒë√≥n:</label>
            <input type="datetime-local" id="time">
        </div>
    </div>

    <div class="section">
        <div class="sec-title">
            <span><i class="fas fa-map-signs"></i> L·ªò TR√åNH</span>
            <button class="btn-myloc" onclick="getMyLoc()" id="btn-loc"><i class="fas fa-crosshairs"></i> V·ªä TR√ç T√îI</button>
        </div>

        <div class="form-group">
            <label class="form-label">ƒêi·ªÉm ƒë√≥n:</label>
            <input type="text" id="pickup" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë√≥n (VD: 200 ƒê·ªìng Kh·ªüi)..." autocomplete="off">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('pickup')">‚úï</button>
                <button class="tool-btn btn-map" onclick="openMap('pickup')"><i class="fas fa-map-marked-alt"></i></button>
            </div>
            <div class="suggestions"></div>
        </div>

        <div id="stops-container"></div>
        <button class="btn-add-stop" onclick="addStop()">+ Th√™m ƒëi·ªÉm d·ª´ng</button>

        <div class="form-group">
            <label class="form-label">ƒêi·ªÉm ƒë·∫øn:</label>
            <input type="text" id="dropoff" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn (VD: B·ªánh vi·ªán)..." autocomplete="off">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('dropoff')">‚úï</button>
                <button class="tool-btn btn-map" onclick="openMap('dropoff')"><i class="fas fa-map-marked-alt"></i></button>
            </div>
            <div class="suggestions"></div>
        </div>
    </div>

    <div class="section">
        <div class="sec-title"><i class="fas fa-sliders-h"></i> T√ôY CH·ªåN</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="form-group">
                <label class="form-label">Lo·∫°i xe:</label>
                <select id="carType">
                    <option value="4">üöó 4 ch·ªó (10k/km)</option>
                    <option value="7">üöê 7 ch·ªó (12k/km)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">H√¨nh th·ª©c:</label>
                <select id="tripType" onchange="toggleWait()">
                    <option value="1">‚û°Ô∏è 1 Chi·ªÅu</option>
                    <option value="2">üîÑ 2 Chi·ªÅu (∆Øu ƒë√£i)</option>
                </select>
            </div>
        </div>
        <div class="form-group" id="wait-area" style="display:none; background:#f8f9fa; padding:10px; border-radius:8px;">
            <label class="form-label">‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):</label>
            <input type="number" id="waitHour" value="0">
        </div>
        <div class="form-group">
            <label class="form-label">T√†i x·∫ø:</label>
            <select id="driver">
                <option value="H·ªá th·ªëng">‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)</option>
                <option value="Thanh Loan">üë©‚Äçü¶∞ Thanh Loan</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">üìù Y√™u c·∫ßu/Ghi ch√∫:</label>
            <textarea id="note" placeholder="VD: Xe s·∫°ch, kh√¥ng m√πi, ƒë√≥n ƒë√∫ng gi·ªù..."></textarea>
        </div>

        <button class="btn-calc" id="btn-calc" onclick="calculate()">
            <i class="fas fa-calculator"></i> T√çNH GI√Å C∆Ø·ªöC
        </button>

        <div id="main-map"></div>

        <div id="result-area">
            <div class="price-header">B·∫¢NG GI√Å D·ª∞ KI·∫æN</div>
            
            <div class="detail-row"><span>üìè Qu√£ng ƒë∆∞·ªùng:</span> <strong id="res-dist">0 km</strong></div>
            <div class="detail-row"><span>‚è± Th·ªùi gian:</span> <strong id="res-time">0 ph√∫t</strong></div>
            
            <hr style="border: 1px dashed #ccc; margin: 8px 0;">
            
            <div class="detail-row" id="row-go"><span>‚û°Ô∏è Chi·ªÅu ƒëi:</span> <strong id="val-go">0 ƒë</strong></div>
            
            <div class="detail-row" id="row-back-full" style="display:none;">
                <span>üîô Chi·ªÅu v·ªÅ (G·ªëc):</span> <strong id="val-back-full" class="old-price">0 ƒë</strong>
            </div>
            
            <div class="detail-row" id="row-back-disc" style="display:none;">
                <span class="discount-tag">üéÅ Chi·ªÅu v·ªÅ (-40%):</span> <strong id="val-back-disc" style="color:#28a745">0 ƒë</strong>
            </div>

            <div class="detail-row" id="row-wait" style="display:none;">
                <span>‚è≥ Ph√≠ ch·ªù:</span> <strong id="val-wait">0 ƒë</strong>
            </div>

            <div class="detail-row" id="row-deposit" style="display:none; background:#fff3cd; padding:5px;">
                <span>üí≥ C·ªçc (20%):</span> <strong style="color:#d32f2f" id="val-deposit">0 ƒë</strong>
            </div>

            <div class="total-price-big" id="res-total">0 ƒë</div>
            <div style="text-align:center; font-size:12px; font-style:italic;">(Ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i)</div>

            <div class="footer-notes">
                <div class="note-item"><i class="fas fa-tag"></i> <span>Gi√° 4 ch·ªó: 10k/km | 7 ch·ªó: 12k/km</span></div>
                <div class="note-item"><i class="fas fa-sync-alt"></i> <span>2 Chi·ªÅu (1 chi·ªÅu >45km ho·∫∑c T·ªïng >90km) gi·∫£m 40% chi·ªÅu v·ªÅ.</span></div>
                <div class="note-item"><i class="fas fa-clock"></i> <span>Ch·ªù: Mi·ªÖn ph√≠ 3h ƒë·∫ßu. Sau ƒë√≥ 50k/h.</span></div>
            </div>
        </div>
    </div>

    <div class="bottom-actions">
        <button class="act-btn btn-zalo" onclick="book('zalo')"><i class="fas fa-comment-dots"></i> ƒê·∫∑t Zalo</button>
        <button class="act-btn btn-mail" onclick="book('mail')"><i class="fas fa-envelope"></i> G·ª≠i Mail</button>
    </div>

</div>

<div id="modal-map" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Ch·ªçn v·ªã tr√≠</span>
            <span style="cursor:pointer; font-size:20px;" onclick="closeMap()">‚úï</span>
        </div>
        <div class="map-container" style="flex:1; position:relative;">
            <div id="picker-map"></div>
            <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="center-marker">
        </div>
        <div class="modal-footer">
            <button class="btn-confirm" onclick="confirmMap()">X√ÅC NH·∫¨N V·ªä TR√ç</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const CFG = { p4: 10000, p7: 12000, wait: 50000 };
    let map, pickerMap, routeLayer, activeInp;
    let cachedPrices = { total: 0 };
    let isSelecting = false;

    // --- INIT ---
    window.onload = () => {
        try {
            map = L.map('main-map').setView([10.7769, 106.7009], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        } catch(e) { console.log("Map init error", e); }

        let now = new Date(); now.setMinutes(now.getMinutes() + 30 - now.getTimezoneOffset());
        document.getElementById('time').value = now.toISOString().slice(0, 16);

        setupInput('phone'); setupAddrInput('pickup'); setupAddrInput('dropoff');
    };

    // --- INPUT HANDLERS ---
    function setupInput(id) {
        let el = document.getElementById(id);
        el.addEventListener('input', () => toggleX(el));
    }
    function setupAddrInput(id) {
        let el = document.getElementById(id);
        el.addEventListener('input', function() {
            if(isSelecting) { isSelecting=false; return; }
            toggleX(this); searchAddr(this);
        });
        el.addEventListener('focus', function() {
            toggleX(this);
            if(this.value.length >= 3) searchAddr(this);
        });
        el.addEventListener('blur', () => setTimeout(hideSug, 200));
    }
    function toggleX(el) {
        let btn = el.parentElement.querySelector('.btn-x');
        if(btn) btn.style.display = el.value ? 'flex' : 'none';
    }
    function clearInp(id) {
        let el = document.getElementById(id);
        el.value = ''; delete el.dataset.lat; delete el.dataset.lon;
        toggleX(el);
    }
    function hideSug() { document.querySelectorAll('.suggestions').forEach(s => s.style.display='none'); }

    // --- SEARCH (NOMINATIM - T·ªêI ∆ØU G·ª¢I √ù) ---
    let timer;
    function searchAddr(inp) {
        clearTimeout(timer);
        let box = inp.parentElement.querySelector('.suggestions');
        if(inp.value.length < 3) { box.style.display='none'; return; }

        timer = setTimeout(() => {
            // TƒÉng limit l√™n 10 v√† th√™m countrycodes=vn ƒë·ªÉ ∆∞u ti√™n VN
            let url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(inp.value)}&format=json&limit=10&countrycodes=vn&addressdetails=1`;
            
            fetch(url).then(r=>r.json()).then(data => {
                box.innerHTML = '';
                if(!data.length) { box.style.display='none'; return; }
                
                data.forEach(item => {
                    let div = document.createElement('div');
                    div.className = 'sug-item';
                    // Hi·ªÉn th·ªã t√™n ng·∫Øn g·ªçn h∆°n
                    let displayName = item.display_name;
                    div.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${displayName}`;
                    
                    div.onmousedown = (e) => {
                        e.preventDefault();
                        isSelecting = true;
                        inp.value = displayName;
                        inp.dataset.lat = item.lat;
                        inp.dataset.lon = item.lon;
                        box.style.display='none';
                        toggleX(inp);
                    };
                    box.appendChild(div);
                });
                box.style.display='block';
            });
        }, 300);
    }

    // --- MAP PICKER ---
    function openMap(id) {
        activeInp = document.getElementById(id);
        document.getElementById('modal-map').style.display = 'flex';
        
        if(!pickerMap) {
            pickerMap = L.map('picker-map', {zoomControl:false}).setView([10.7769, 106.7009], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);
        }
        
        setTimeout(() => {
            pickerMap.invalidateSize();
            if(activeInp.dataset.lat) pickerMap.setView([activeInp.dataset.lat, activeInp.dataset.lon], 16);
            else if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => pickerMap.setView([p.coords.latitude, p.coords.longitude], 15));
        }, 200);
    }
    function closeMap() { document.getElementById('modal-map').style.display='none'; }
    function confirmMap() {
        let c = pickerMap.getCenter();
        activeInp.dataset.lat = c.lat; activeInp.dataset.lon = c.lng;
        // Reverse Geocode ƒë∆°n gi·∫£n
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${c.lat}&lon=${c.lng}&format=json`)
        .then(r=>r.json()).then(d => {
            activeInp.value = d.display_name || `${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
            toggleX(activeInp);
        });
        closeMap();
    }

    // --- ADD STOP ---
    function addStop() {
        let id = 'stop-' + Date.now();
        let div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label class="form-label">ƒêi·ªÉm d·ª´ng:</label>
            <input type="text" id="${id}" placeholder="Nh·∫≠p ƒëi·ªÉm d·ª´ng...">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="this.parentElement.previousElementSibling.value=''">‚úï</button>
                <button class="tool-btn btn-trash" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-trash"></i></button>
                <button class="tool-btn btn-map" onclick="openMap('${id}')"><i class="fas fa-map"></i></button>
            </div>
            <div class="suggestions"></div>
        `;
        document.getElementById('stops-container').appendChild(div);
        setupAddrInput(id);
    }

    // --- T√çNH GI√Å (FIX L·ªñI G·∫†CH B·ªé) ---
    function toggleWait() {
        document.getElementById('wait-area').style.display = document.getElementById('tripType').value == '2' ? 'block' : 'none';
    }

    async function calculate() {
        let p = document.getElementById('pickup'), d = document.getElementById('dropoff');
        if(!p.dataset.lat || !d.dataset.lat) return alert("Vui l√≤ng ch·ªçn ƒë·ªãa ƒëi·ªÉm t·ª´ g·ª£i √Ω ho·∫∑c b·∫£n ƒë·ªì!");
        
        let btn = document.getElementById('btn-calc'); btn.innerHTML = '‚è≥ ƒêANG T√çNH...'; btn.disabled = true;

        // Gom ƒëi·ªÉm
        let points = [p, ...document.querySelectorAll('#stops-container input'), d];
        let coords = points.filter(i => i.dataset.lat).map(i => `${i.dataset.lon},${i.dataset.lat}`).join(';');

        try {
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`);
            let data = await res.json();
            if(data.code !== 'Ok') throw 'Err';
            
            let r = data.routes[0];
            let km = r.distance / 1000;
            let mins = Math.round(r.duration / 60);

            // Map
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(r.geometry).addTo(map);
            map.fitBounds(routeLayer.getBounds(), {padding:[30,30]});
            document.getElementById('main-map').style.display = 'block';

            // Gi√°
            let type = document.getElementById('tripType').value;
            let unit = document.getElementById('carType').value == '4' ? CFG.p4 : CFG.p7;
            let go = Math.round(km * unit);
            let back = 0, wait = 0;
            
            // Reset display
            document.getElementById('row-back-full').style.display = 'none';
            document.getElementById('row-back-disc').style.display = 'none';

            if(type == '2') {
                if(km >= 45) { // ƒêi·ªÅu ki·ªán gi·∫£m gi√°
                    let fullBack = go;
                    back = Math.round(go * 0.6);
                    
                    // Hi·ªán d√≤ng g·∫°ch b·ªè
                    document.getElementById('row-back-full').style.display = 'flex';
                    document.getElementById('val-back-full').innerHTML = `<s style="color:#999">${fullBack.toLocaleString()} ƒë</s>`;
                    
                    // Hi·ªán d√≤ng gi·∫£m gi√°
                    document.getElementById('row-back-disc').style.display = 'flex';
                    document.getElementById('val-back-disc').innerText = back.toLocaleString() + ' ƒë';
                } else {
                    back = go;
                    // N·∫øu kh√¥ng gi·∫£m, c·ªông v√†o t·ªïng ho·∫∑c hi·ªÉn th·ªã d√≤ng ri√™ng t√πy √Ω
                    document.getElementById('row-back-full').style.display = 'flex';
                    document.getElementById('val-back-full').innerHTML = `${back.toLocaleString()} ƒë`;
                }

                let h = parseFloat(document.getElementById('waitHour').value) || 0;
                if(h > 3) wait = (h - 3) * CFG.wait;
            }

            let total = go + back + wait;
            let deposit = (type == '2') ? Math.round(total * 0.2) : 0;

            // Render Text
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('res-km').innerText = km.toFixed(1) + ' km';
            document.getElementById('res-time').innerText = mins + ' ph√∫t';
            document.getElementById('val-go').innerText = go.toLocaleString() + ' ƒë';
            
            document.getElementById('row-wait').style.display = wait > 0 ? 'flex' : 'none';
            document.getElementById('val-wait').innerText = wait.toLocaleString() + ' ƒë';
            
            document.getElementById('row-deposit').style.display = deposit > 0 ? 'flex' : 'none';
            document.getElementById('val-deposit').innerText = deposit.toLocaleString() + ' ƒë';
            
            document.getElementById('res-total').innerText = total.toLocaleString() + ' ƒë';

            cachedPrices = { total, deposit, go, back, km: km.toFixed(1), time: mins + ' ph√∫t' };
            document.getElementById('result-area').scrollIntoView({behavior:'smooth'});

        } catch(e) { alert("L·ªói t√¨m ƒë∆∞·ªùng!"); }
        btn.innerHTML = 'üí∞ T√çNH GI√Å C∆Ø·ªöC'; btn.disabled = false;
    }

    // --- BOOKING ---
    function getMyLoc() {
        if(!navigator.geolocation) return alert("B·∫≠t GPS!");
        let btn = document.getElementById('btn-loc'); btn.innerHTML = '‚è≥...';
        navigator.geolocation.getCurrentPosition(p => {
            let i = document.getElementById('pickup');
            i.dataset.lat = p.coords.latitude; i.dataset.lon = p.coords.longitude;
            
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${p.coords.latitude}&lon=${p.coords.longitude}&format=json`)
            .then(r=>r.json()).then(d=>{ i.value = d.display_name; toggleX(i); btn.innerHTML = 'üéØ V·ªä TR√ç T√îI'; });
        });
    }

    function book(method) {
        let phone = document.getElementById('phone').value;
        if(!phone) return alert("Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!");
        
        let p = document.getElementById('pickup');
        let d = document.getElementById('dropoff');
        
        // Link Google Maps chu·∫©n
        let linkP = `https://www.google.com/maps?q=${p.dataset.lat},${p.dataset.lon}`;
        let linkD = `https://www.google.com/maps?q=${d.dataset.lat},${d.dataset.lon}`;
        
        let msg = `üöñ ƒê·∫∂T XE TR∆Ø·ªúNG AN\nüìû SƒêT: ${phone}\nüïí ${document.getElementById('time').value.replace('T',' ')}\nüöò ${document.getElementById('carType').selectedOptions[0].text}\n`;
        msg += `üìç ƒê√≥n: ${p.value}\nüëâ Map: ${linkP}\n`;
        
        // L·∫•y ƒëi·ªÉm d·ª´ng
        document.querySelectorAll('#stops-container input').forEach((inp, idx) => {
             if(inp.dataset.lat) msg += `üî∏ D·ª´ng ${idx+1}: ${inp.value}\nüëâ Map: https://www.google.com/maps?q=${inp.dataset.lat},${inp.dataset.lon}\n`;
        });

        msg += `üèÅ ƒê·∫øn: ${d.value}\nüëâ Map: ${linkD}\n`;
        msg += `----------------\nüí∞ T·ªîNG: ${cachedPrices.total.toLocaleString()} ƒë\n`;
        if(cachedPrices.deposit) msg += `üí≥ C·ªçc: ${cachedPrices.deposit.toLocaleString()} ƒë\n`;
        
        let note = document.getElementById('note').value;
        if(note) msg += `üìù Ghi ch√∫: ${note}`;

        if(method == 'zalo') {
            navigator.clipboard.writeText(msg);
            window.open('https://zalo.me/0847526893');
        } else {
            window.location.href = `mailto:truongan.driving@gmail.com?body=${encodeURIComponent(msg)}`;
        }
    }
</script>

</body>
</html>
