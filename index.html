<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR∆Ø·ªúNG AN DRIVING</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- C·∫§U H√åNH GIAO DI·ªÜN CHU·∫®N --- */
        :root { --green: #28a745; --red: #dc3545; --blue: #007bff; --gray: #f4f6f8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background-color: var(--gray); margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; min-height: 100vh; padding-bottom: 80px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        
        /* HEADER */
        header { background-color: #008000; padding: 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .brand-col { display: flex; flex-direction: column; }
        .brand-name { font-weight: 900; font-size: 18px; text-transform: uppercase; margin: 0; }
        .hotline { font-size: 14px; color: #ff0000; font-weight: bold; background: yellow; padding: 2px 5px; border-radius: 4px; text-decoration: none; display: inline-block; margin-top: 4px; width: fit-content;}
        
        .lang-grp { display: flex; gap: 5px; }
        .lang-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 2px 8px; font-size: 12px; border-radius: 4px; cursor: pointer; }
        .lang-btn.active { background: white; color: #008000; font-weight: bold; }

        /* SECTION */
        .section { padding: 15px; border-bottom: 8px solid #f4f6f8; }
        .sec-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sec-title { font-weight: 700; font-size: 15px; text-transform: uppercase; display: flex; align-items: center; gap: 6px; }
        
        /* M√ÄU S·∫ÆC TI√äU ƒê·ªÄ */
        .t-info { color: #555; }
        .t-route { color: var(--green); }
        .t-opt { color: var(--red); }

        /* N√öT V·ªä TR√ç T√îI (Text link g√≥c ph·∫£i) */
        .btn-myloc { color: #007bff; font-size: 13px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 4px; border: none; background: none; }
        .btn-myloc i { color: var(--red); }

        /* INPUT FIELDS */
        .form-group { margin-bottom: 12px; position: relative; }
        .form-label { font-size: 12px; font-weight: 600; color: #444; margin-bottom: 5px; display: block; }
        input, select, textarea { 
            width: 100%; padding: 12px; padding-right: 85px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; box-sizing: border-box; background: #fff; transition: 0.3s; 
            /* Lo·∫°i b·ªè in ƒë·∫≠m */
            font-weight: 400; 
            color: #000;
        }
        input:focus { border-color: var(--green); box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.1); }
        textarea { resize: none; height: 80px; padding-right: 10px; }

        /* TOOL BUTTONS (X & MAP) */
        .input-tools { position: absolute; right: 5px; top: 29px; display: flex; gap: 5px; }
        .tool-btn { width: 34px; height: 34px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .btn-x { background: #f0f0f0; color: #888; display: none; }
        .btn-map { background: var(--green); color: white; } /* N√∫t Map Xanh */
        .btn-trash { background: var(--red); color: white; }

        /* ƒêI·ªÇM D·ª™NG */
        .btn-add-stop { width: 100%; color: var(--green); background: none; border: none; font-weight: bold; cursor: pointer; text-align: right; display: block; margin-bottom: 10px; }
        
        /* N√öT T√çNH GI√Å (TO, XANH) */
        .btn-calc { width: 100%; background: var(--green); color: white; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: 900; text-transform: uppercase; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-calc:active { transform: scale(0.98); }

        /* K·∫æT QU·∫¢ */
        #result-area { display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border: 1px solid #c3e6cb; border-radius: 8px; }
        .price-tag { font-size: 26px; color: var(--red); font-weight: 900; text-align: center; margin: 10px 0; border-top: 1px dashed #ccc; padding-top: 10px; }
        .detail-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 6px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        
        /* FOOTER NOTES (Ghi ch√∫ chi ti·∫øt) */
        .footer-notes {
            margin-top: 15px;
            font-size: 13px;
            color: #555;
            background: #f0fff4; /* N·ªÅn nh·∫π ƒë·ªÉ n·ªïi b·∫≠t */
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
        }
        .note-item { margin-bottom: 5px; display: flex; gap: 5px; }
        .note-item i { color: var(--green); margin-top: 3px; }

        /* SUGGESTIONS (G·ª£i √Ω) */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; z-index: 999; max-height: 200px; overflow-y: auto; border-radius: 0 0 8px 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none; }
        .sug-item { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .sug-item:hover { background: #f5f5f5; }

        /* MODAL & MAP */
        #main-map { height: 200px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc; display: none; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; padding: 15px; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; height: 70vh; display: flex; flex-direction: column; }
        .modal-header { background: var(--green); color: white; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        #picker-map { flex: 1; position: relative; }
        .center-marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 1000; width: 40px; pointer-events: none; }
        .modal-footer { padding: 10px; text-align: center; }
        .btn-confirm { width: 100%; padding: 12px; background: var(--green); color: white; border: none; border-radius: 8px; font-weight: bold; }

        /* FOOTER BUTTONS */
        .bottom-bar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: white; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .act-btn { flex: 1; padding: 12px; border-radius: 6px; border: none; color: white; font-weight: bold; cursor: pointer; }
        .zalo { background: #0068ff; }
        .mail { background: var(--red); }
    </style>
</head>
<body>

<header>
    <div class="brand-col">
        <div class="brand-name" data-i18n="brand">TR∆Ø·ªúNG AN DRIVING</div>
        <a href="tel:0847526893" class="hotline">‚òéÔ∏è 084.752.6893</a>
    </div>
    <div class="lang-grp">
        <button class="lang-btn active" onclick="changeLang('vi')">VN</button>
        <button class="lang-btn" onclick="changeLang('en')">EN</button>
        <button class="lang-btn" onclick="changeLang('cn')">CN</button>
    </div>
</header>

<div class="container">
    
    <div class="section">
        <div class="sec-head">
            <div class="sec-title t-info"><i class="fas fa-clipboard-list"></i> <span data-i18n="sec_info">TH√îNG TIN</span></div>
        </div>
        <div class="form-group">
            <label class="form-label" data-i18n="lbl_phone">S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="phone" placeholder="...">
            <div class="input-tools" style="top:28px"><button class="tool-btn btn-x" onclick="clearInp('phone')">‚úï</button></div>
        </div>
        <div class="form-group">
            <label class="form-label" data-i18n="lbl_time">Th·ªùi gian ƒë√≥n:</label>
            <input type="datetime-local" id="time">
        </div>
    </div>

    <div class="section">
        <div class="sec-head">
            <div class="sec-title t-route"><i class="fas fa-map-marked-alt"></i> <span data-i18n="sec_route">L·ªò TR√åNH</span></div>
            <button class="btn-myloc" onclick="getMyLoc()" id="btn-loc"><i class="fas fa-crosshairs"></i> <span data-i18n="btn_myloc">V·ªä TR√ç T√îI</span></button>
        </div>

        <div class="form-group">
            <label class="form-label" data-i18n="lbl_pickup">ƒêi·ªÉm ƒë√≥n:</label>
            <input type="text" id="pickup" placeholder="...">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('pickup')">‚úï</button>
                <button class="tool-btn btn-map" onclick="openMap('pickup')"><i class="fas fa-map"></i></button>
            </div>
            <div class="suggestions"></div>
        </div>

        <div id="stops-container"></div>
        <button class="btn-add-stop" onclick="addStop()" data-i18n="btn_add_stop">+ Th√™m ƒëi·ªÉm d·ª´ng</button>

        <div class="form-group">
            <label class="form-label" data-i18n="lbl_dropoff">ƒêi·ªÉm ƒë·∫øn:</label>
            <input type="text" id="dropoff" placeholder="...">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('dropoff')">‚úï</button>
                <button class="tool-btn btn-map" onclick="openMap('dropoff')"><i class="fas fa-map"></i></button>
            </div>
            <div class="suggestions"></div>
        </div>
        
        <div id="main-map"></div>
    </div>

    <div class="section">
        <div class="sec-head"><div class="sec-title t-opt"><i class="fas fa-car"></i> <span data-i18n="sec_opt">T√ôY CH·ªåN</span></div></div>
        
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1">
                <label class="form-label" data-i18n="lbl_car">Lo·∫°i xe:</label>
                <select id="carType">
                    <option value="4" data-i18n="opt_4seat">Xe 4 ch·ªó (10.000ƒë/km)</option>
                    <option value="7" data-i18n="opt_7seat">Xe 7 ch·ªó (12.000ƒë/km)</option>
                </select>
            </div>
            <div class="form-group" style="flex:1">
                <label class="form-label" data-i18n="lbl_type">H√¨nh th·ª©c:</label>
                <select id="tripType" onchange="toggleWait()">
                     <option value="1" data-i18n="opt_1way">1 Chi·ªÅu</option>
                    <option value="2" data-i18n="opt_2way">2 Chi·ªÅu (Gi·∫£m 40% Chi·ªÅu v·ªÅ > 45km)</option>
                </select>
            </div>
        </div>

        <div class="form-group" id="wait-area" style="display:none; background:#f0fff4; padding:10px; border-radius:8px;">
            <label class="form-label" data-i18n="lbl_wait">‚è≥ Th·ªùi gian ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):</label>
            <input type="number" id="waitHour" value="0">
        </div>

        <div class="form-group">
            <label class="form-label" data-i18n="lbl_driver">T√†i x·∫ø:</label>
            <select id="driver">
                <option value="H·ªá th·ªëng" data-i18n="opt_system">‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)</option>
                <option value="Thanh Loan">üë©‚Äçü¶∞ Thanh Loan</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label" data-i18n="lbl_note">üìù Ghi ch√∫:</label>
            <textarea id="note" placeholder="..."></textarea>
        </div>

        <div class="footer-notes">
            <div style="font-weight:bold; margin-bottom: 5px;" data-i18n="note_policy_title">CH√çNH S√ÅCH GI√Å C∆Ø·ªöC (Chi ti·∫øt)</div>
            <div class="note-item"><i class="fas fa-tag"></i> <span data-i18n="note_price">Gi√° 4 ch·ªó: 10.000ƒë/km | 7 ch·ªó: 12.000ƒë/km.</span></div>
            <div class="note-item"><i class="fas fa-sync"></i> <span data-i18n="note_disc_cond">∆Øu ƒë√£i 2 chi·ªÅu: Gi·∫£m 40% chi·ªÅu v·ªÅ n·∫øu chi·ªÅu ƒëi tr√™n 45km.</span></div>
            <div class="note-item"><i class="fas fa-clock"></i> <span data-i18n="note_wait_fee">Ph√≠ ch·ªù: Mi·ªÖn ph√≠ 3 gi·ªù ƒë·∫ßu ti√™n. Sau ƒë√≥ t√≠nh 50.000ƒë/gi·ªù.</span></div>
            <div class="note-item"><i class="fas fa-exclamation-triangle" style="color:#ffc107;"></i> <span data-i18n="note_toll_fee">‚ö†Ô∏è Gi√° t·∫°m t√≠nh ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.</span></div>
        </div>

        <button class="btn-calc" onclick="calculate()" data-i18n="btn_calc"><i class="fas fa-calculator"></i> T√çNH GI√Å C∆Ø·ªöC</button>

        <div id="result-area">
            <div style="text-align:center; color:#28a745; font-weight:bold; margin-bottom:10px;" data-i18n="lbl_est_price">B·∫¢NG GI√Å CHI TI·∫æT</div>
            <div class="detail-row"><span data-i18n="res_dist">Qu√£ng ƒë∆∞·ªùng:</span> <strong id="res-km">0 km</strong></div>
            <div class="detail-row"><span data-i18n="res_time">Th·ªùi gian:</span> <strong id="res-time">0 min</strong></div>
            <div class="detail-row" id="row-go"><span data-i18n="res_go_price">Chi·ªÅu ƒëi:</span> <strong id="val-go">0</strong></div>
            
            <div class="detail-row" id="row-back-full" style="display:none;">
                <span data-i18n="res_back_full">Chi·ªÅu v·ªÅ (G·ªëc):</span> <strong style="text-decoration:line-through; color:#999" id="val-back-full">0</strong>
            </div>
            <div class="detail-row" id="row-back-disc" style="display:none;">
                <span data-i18n="res_return_disc">Chi·ªÅu v·ªÅ (-40%):</span> <strong style="color:#28a745" id="val-back-disc">0</strong>
            </div>
            <div class="detail-row" id="row-wait" style="display:none;">
                <span data-i18n="res_wait_fee">Ph√≠ ch·ªù:</span> <strong id="val-wait">0</strong>
            </div>
             <div class="detail-row" id="row-deposit" style="display:none; background:#fff3cd; padding:5px;">
                <span data-i18n="res_deposit">C·ªçc (20%):</span> <strong style="color:red" id="val-deposit">0</strong>
            </div>

            <div class="price-tag" id="res-total">0 ƒë</div>
            <div style="font-size:12px; font-style:italic; color:#888; text-align:center; margin-top:-5px; margin-bottom:10px;" data-i18n="note_toll_fee_small">Gi√° ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.</div>
        </div>
    </div>
    
    <div class="bottom-bar">
        <button class="act-btn zalo" onclick="preBook('zalo')" data-i18n="btn_zalo">ƒê·∫∑t chuy·∫øn qua ZALO</button>
        <button class="act-btn mail" onclick="preBook('mail')" data-i18n="btn_mail">ƒê·∫∑t chuy·∫øn qua MAIL</button>
    </div>

</div>

<div id="modal-map" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span data-i18n="modal_map_title">CH·ªåN V·ªä TR√ç</span>
            <span onclick="closeMap()" style="cursor:pointer">‚úï</span>
        </div>
        <div id="picker-map"></div>
        <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="center-marker">
        <div class="modal-footer">
            <button class="btn-confirm" onclick="confirmMap()" data-i18n="btn_confirm">X√ÅC NH·∫¨N</button>
        </div>
    </div>
</div>

<div id="phone-modal" class="modal">
    <div class="modal-content" style="height:auto; padding:20px; text-align:center;">
        <h3 data-i18n="modal_phone_title" style="margin-top:0; color:#28a745;">NH·∫¨P S·ªê ƒêI·ªÜN THO·∫†I</h3>
        <p data-i18n="modal_phone_desc">Vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i li√™n h·ªá:</p>
        <input type="tel" id="quick-phone" style="font-size:18px; text-align:center; margin:10px 0;">
        <div style="display:flex; gap:10px;">
            <button onclick="closePhone()" style="flex:1; padding:10px; border:none; background:#eee;">H·ªßy</button>
            <button onclick="savePhone()" style="flex:1; padding:10px; border:none; background:#28a745; color:white; font-weight:bold;">OK</button>
        </div>
    </div>
</div>

<script>
    // --- I18N DATA ---
    const LANG = {
        vi: {
            brand:"TR∆Ø·ªúNG AN DRIVING", sec_info:"TH√îNG TIN", lbl_phone:"S·ªë ƒëi·ªán tho·∫°i:", lbl_time:"Th·ªùi gian ƒë√≥n:",
            sec_route:"L·ªò TR√åNH", btn_myloc:"V·ªä TR√ç T√îI", lbl_pickup:"ƒêi·ªÉm ƒë√≥n:", lbl_dropoff:"ƒêi·ªÉm ƒë·∫øn:", btn_add_stop:"+ Th√™m ƒëi·ªÉm d·ª´ng",
            sec_opt:"T√ôY CH·ªåN", lbl_car:"Lo·∫°i xe:", opt_4seat:"Xe 4 ch·ªó (10.000ƒë/km)", opt_7seat:"Xe 7 ch·ªó (12.000ƒë/km)",
            lbl_type:"H√¨nh th·ª©c:", opt_1way:"1 Chi·ªÅu", opt_2way:"2 Chi·ªÅu (Gi·∫£m 40% Chi·ªÅu v·ªÅ > 45km)",
            lbl_wait:"‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):",
            lbl_driver:"T√†i x·∫ø:", opt_system:"‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)", lbl_note:"üìù Y√™u c·∫ßu/Ghi ch√∫:", btn_calc:"üí∞ T√çNH GI√Å C∆Ø·ªöC",
            btn_zalo:"ƒê·∫∑t chuy·∫øn qua ZALO", 
            btn_mail:"ƒê·∫∑t chuy·∫øn qua MAIL", 
            lbl_est_price:"B·∫¢NG GI√Å CHI TI·∫æT", res_dist:"Qu√£ng ƒë∆∞·ªùng:", res_time:"Th·ªùi gian:", res_go_price:"Chi·ªÅu ƒëi:",
            res_back_full:"Chi·ªÅu v·ªÅ (G·ªëc):", res_return_disc:"Chi·ªÅu v·ªÅ (-40%):", res_wait_fee:"Ph√≠ ch·ªù:", res_deposit:"C·ªçc (20%):",
            note_policy_title: "CH√çNH S√ÅCH GI√Å C∆Ø·ªöC (Chi ti·∫øt)", 
            note_price:"Gi√° 4 ch·ªó: 10.000ƒë/km | 7 ch·ªó: 12.000ƒë/km.", 
            note_disc_cond:"∆Øu ƒë√£i 2 chi·ªÅu: Gi·∫£m 40% chi·ªÅu v·ªÅ n·∫øu chi·ªÅu ƒëi tr√™n 45km.", 
            note_wait_fee:"Ph√≠ ch·ªù: Mi·ªÖn ph√≠ 3 gi·ªù ƒë·∫ßu ti√™n. Sau ƒë√≥ t√≠nh 50.000ƒë/gi·ªù.",
            note_toll_fee:"‚ö†Ô∏è Gi√° t·∫°m t√≠nh ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.", 
            note_toll_fee_small:"Gi√° ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.", 
            modal_map_title:"CH·ªåN V·ªä TR√ç", btn_confirm:"X√ÅC NH·∫¨N",
            modal_phone_title:"NH·∫¨P S·ªê ƒêI·ªÜN THO·∫†I", modal_phone_desc:"Vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i li√™n h·ªá:",
            plh_phone:"VD: 0912345678", plh_pickup:"Nh·∫≠p ƒëi·ªÉm ƒë√≥n...", plh_dropoff:"Nh·∫≠p ƒëi·ªÉm ƒë·∫øn...", plh_stop:"ƒêi·ªÉm d·ª´ng...", plh_note:"VD: Xe s·∫°ch, ƒë√≥n ƒë√∫ng gi·ªù..."
        },
        en: {
            brand:"TRUONG AN DRIVING", sec_info:"INFORMATION", lbl_phone:"Phone Number:", lbl_time:"Pickup Time:",
            sec_route:"ROUTE", btn_myloc:"MY LOCATION", lbl_pickup:"Pick-up:", lbl_dropoff:"Drop-off:", btn_add_stop:"+ Add Stop",
            sec_opt:"OPTIONS", lbl_car:"Car Type:", opt_4seat:"4 Seats (10,000ƒë/km)", opt_7seat:"7 Seats (12,000ƒë/km)",
            lbl_type:"Trip Type:", opt_1way:"One way", opt_2way:"Round trip (40% Off Return > 45km)", 
            lbl_wait:"‚è≥ Waiting Time (Free 3h):",
            lbl_driver:"Driver:", opt_system:"‚≠ê System (Fastest)", lbl_note:"üìù Note/Request:", btn_calc:"üí∞ CALCULATE PRICE",
            btn_zalo:"Book via ZALO", 
            btn_mail:"Book via MAIL", 
            lbl_est_price:"PRICE DETAILS", res_dist:"Distance:", res_time:"Duration:", res_go_price:"One-way:",
            res_back_full:"Return (Orig):", res_return_disc:"Return (-40%):", res_wait_fee:"Waiting Fee:", res_deposit:"Deposit (20%):",
            note_policy_title: "PRICING POLICY (Details)", 
            note_price:"4 Seats: 10,000ƒë/km | 7 Seats: 12,000ƒë/km.", 
            note_disc_cond:"Round Trip Offer: 40% off return if one-way distance is over 45km.", 
            note_wait_fee:"Waiting Fee: First 3 hours free. After that, 50,000ƒë/hour.",
            note_toll_fee:"‚ö†Ô∏è Estimated price excludes toll fees and parking fees.", 
            note_toll_fee_small:"Price excludes toll fees and parking fees.", 
            modal_map_title:"PICK LOCATION", btn_confirm:"CONFIRM",
            modal_phone_title:"ENTER PHONE", modal_phone_desc:"Please enter phone number:",
            plh_phone:"Ex: 0912345678", plh_pickup:"Enter pick-up...", plh_dropoff:"Enter drop-off...", plh_stop:"Stop point...", plh_note:"Ex: Clean car, on time..."
        },
        cn: {
            brand:"ÈïøÂÆâÈ©æÈ©∂", sec_info:"‰ø°ÊÅØ", lbl_phone:"ÁîµËØùÂè∑Á†Å:", lbl_time:"Êé•ËΩ¶Êó∂Èó¥:",
            sec_route:"Ë∑ØÁ∫ø", btn_myloc:"ÊàëÁöÑ‰ΩçÁΩÆ", lbl_pickup:"‰∏äËΩ¶ÁÇπ:", lbl_dropoff:"‰∏ãËΩ¶ÁÇπ:", btn_add_stop:"+ Â¢ûÂä†Á´ôÁÇπ",
            sec_opt:"ÈÄâÈ°π", lbl_car:"ËΩ¶Âûã:", opt_4seat:"4Â∫ß (10,000ƒë/km)", opt_7seat:"7Â∫ß (12,000ƒë/km)",
            lbl_type:"Ë°åÁ®ã:", opt_1way:"ÂçïÁ®ã", opt_2way:"ÂæÄËøî (ÂõûÁ®ãÂáè40% > 45km)", 
            lbl_wait:"‚è≥ Á≠âÂæÖÊó∂Èó¥ (ÂÖçË¥π3h):",
            lbl_driver:"Âè∏Êú∫:", opt_system:"‚≠ê Á≥ªÁªü (ÊúÄÂø´)", lbl_note:"üìù Â§áÊ≥®/Ë¶ÅÊ±Ç:", btn_calc:"üí∞ ËÆ°ÁÆó‰ª∑Ê†º",
            btn_zalo:"ÈÄöËøáZALOÈ¢ÑËÆ¢", 
            btn_mail:"ÈÄöËøáMAILÈ¢ÑËÆ¢", 
            lbl_est_price:"‰ª∑Ê†ºËØ¶ÊÉÖ", res_dist:"Ë∑ùÁ¶ª:", res_time:"Êó∂Èó¥:", res_go_price:"ÂéªÁ®ã:",
            res_back_full:"ÂõûÁ®ã (Âéü‰ª∑):", res_return_disc:"ÂõûÁ®ã (-40%):", res_wait_fee:"Á≠âÂæÖË¥π:", res_deposit:"ÂÆöÈáë (20%):",
            note_policy_title: "‰ª∑Ê†ºÊîøÁ≠ñ (ËØ¶ÊÉÖ)", 
            note_price:"4Â∫ß: 10,000ƒë/km | 7Â∫ß: 12,000ƒë/km„ÄÇ", 
            note_disc_cond:"ÂæÄËøî‰ºòÊÉ†: ÂçïÁ®ãË∑ùÁ¶ªË∂ÖËøá45ÂÖ¨ÈáåÔºåÂõûÁ®ãÂáè40%„ÄÇ", 
            note_wait_fee:"Á≠âÂæÖË¥π: Ââç3Â∞èÊó∂ÂÖçË¥π„ÄÇ‰πãÂêé50,000ƒë/Â∞èÊó∂„ÄÇ",
            note_toll_fee:"‚ö†Ô∏è È¢Ñ‰º∞‰ª∑Ê†º‰∏çÂåÖÂê´ËøáË∑ØË¥πÂíåÂÅúËΩ¶Ë¥π„ÄÇ", 
            note_toll_fee_small:"È¢Ñ‰º∞‰ª∑Ê†º‰∏çÂåÖÂê´ËøáË∑ØË¥πÂíåÂÅúËΩ¶Ë¥π„ÄÇ",
            modal_map_title:"ÈÄâÊã©‰ΩçÁΩÆ", btn_confirm:"Á°ÆËÆ§",
            modal_phone_title:"ËæìÂÖ•ÁîµËØù", modal_phone_desc:"ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å:",
            plh_phone:"‰æã: 0912345678", plh_pickup:"ËæìÂÖ•‰∏äËΩ¶ÁÇπ...", plh_dropoff:"ËæìÂÖ•‰∏ãËΩ¶ÁÇπ...", plh_stop:"Á´ôÁÇπ...", plh_note:"‰æã: ÂáÜÊó∂, ËΩ¶ÂÜÖÂπ≤ÂáÄ..."
        }
    };

    let curLang = 'vi';
    const CFG = { p4: 10000, p7: 12000, wait: 50000 };
    let map, pickerMap, routeLayer, markerLayer, activeInp, pendingMethod;
    let cachedData = { total:0 };
    let isSelecting = false;

    window.onload = () => {
        // Map hi·ªÉn th·ªã k·∫øt qu·∫£
        map = L.map('main-map').setView([10.7769, 106.7009], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        markerLayer = L.layerGroup().addTo(map); // Layer ch·ª©a markers

        // Map ch·ªçn v·ªã tr√≠ (kh·ªüi t·∫°o nh∆∞ng ch∆∞a hi·ªán)
        pickerMap = L.map('picker-map').setView([10.7769, 106.7009], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);

        let now = new Date(); now.setMinutes(now.getMinutes()+30-now.getTimezoneOffset());
        document.getElementById('time').value = now.toISOString().slice(0,16);
        
        setupInp('phone'); setupAddr('pickup'); setupAddr('dropoff');
        changeLang('vi');
    };

    function changeLang(code) {
        curLang = code;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.lang-btn[onclick="changeLang('${code}')"]`).classList.add('active');
        
        // T·∫£i l·∫°i c√°c option cho Lo·∫°i xe v√† H√¨nh th·ª©c
        const updateSelectOptions = (id, options) => {
            const select = document.getElementById(id);
            const currentVal = select.value;
            select.innerHTML = '';
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.setAttribute('data-i18n', opt.i18nKey);
                option.textContent = LANG[code][opt.i18nKey];
                select.appendChild(option);
            });
            select.value = currentVal; // Gi·ªØ nguy√™n l·ª±a ch·ªçn
        };

        updateSelectOptions('carType', [
            { value: '4', i18nKey: 'opt_4seat' },
            { value: '7', i18nKey: 'opt_7seat' }
        ]);

        updateSelectOptions('tripType', [
            { value: '1', i18nKey: 'opt_1way' },
            { value: '2', i18nKey: 'opt_2way' }
        ]);
        
        // C·∫≠p nh·∫≠t c√°c text/placeholder kh√°c
        document.querySelectorAll('[data-i18n]').forEach(el => {
            let key = el.dataset.i18n;
            if(LANG[code][key]) {
                if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = LANG[code][key];
                else if(el.tagName !== 'OPTION') el.innerText = LANG[code][key];
            }
        });
        
        // Update placeholders specific
        ['phone','pickup','dropoff','note'].forEach(id => {
            document.getElementById(id).placeholder = LANG[code][`plh_${id}`];
        });
        document.querySelectorAll('.stop-inp').forEach(i => i.placeholder = LANG[code].plh_stop);
    }

    // --- INPUT HANDLING ---
    function setupInp(id) {
        let el = document.getElementById(id);
        el.addEventListener('input', () => toggleX(el));
    }
    
    function setupAddr(id) {
        let el = document.getElementById(id);
        el.addEventListener('input', function() {
            if(isSelecting) { isSelecting=false; return; }
            toggleX(this);
            search(this);
        });
        el.addEventListener('focus', function() {
            toggleX(this);
            if(this.value.length > 2) search(this);
        });
        el.addEventListener('blur', () => setTimeout(() => {
            el.parentElement.querySelector('.suggestions').style.display = 'none';
        }, 200));
    }

    function toggleX(el) {
        let btn = el.parentElement.querySelector('.btn-x');
        if(btn) btn.style.display = el.value ? 'flex' : 'none';
    }
    function clearInp(id) {
        let el = document.getElementById(id);
        el.value=''; delete el.dataset.lat; delete el.dataset.lon;
        toggleX(el);
    }

    // --- SEARCH (NOMINATIM) ---
    let timer;
    function search(inp) {
        clearTimeout(timer);
        let box = inp.parentElement.querySelector('.suggestions');
        if(inp.value.length < 3) { box.style.display='none'; return; }

        timer = setTimeout(() => {
            // T·ªëi ∆∞u h√≥a: viewbox=105.0,8.0,109.0,16.0 (∆Øu ti√™n t√¨m ki·∫øm khu v·ª±c Nam v√† Trung Vi·ªát Nam)
            let q = encodeURIComponent(inp.value);
            let url = `https://nominatim.openstreetmap.org/search?q=${q}&format=json&countrycodes=vn&addressdetails=1&limit=10&viewbox=105.0,8.0,109.0,16.0`;
            
            fetch(url).then(r=>r.json()).then(data => {
                box.innerHTML = '';
                if(!data.length) { box.style.display='none'; return; }
                
                data.forEach(item => {
                    let div = document.createElement('div');
                    div.className = 'sug-item';
                    let name = item.display_name; 
                    div.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${name}`;
                    
                    div.onmousedown = (e) => {
                        e.preventDefault();
                        isSelecting = true;
                        inp.value = name;
                        inp.dataset.lat = item.lat;
                        inp.dataset.lon = item.lon;
                        box.style.display = 'none';
                        toggleX(inp);
                        inp.blur(); // ƒê√≥ng b√†n ph√≠m sau khi ch·ªçn
                    };
                    box.appendChild(div);
                });
                box.style.display = 'block';
            });
        }, 300);
    }

    // --- MAP PICKER ---
    function openMap(id) {
        activeInp = document.getElementById(id);
        document.getElementById('modal-map').style.display = 'flex';
        setTimeout(() => {
            pickerMap.invalidateSize();
            if(activeInp.dataset.lat) pickerMap.setView([activeInp.dataset.lat, activeInp.dataset.lon], 16);
            else if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => pickerMap.setView([p.coords.latitude, p.coords.longitude], 15));
        }, 200);
    }
    function closeMap() { document.getElementById('modal-map').style.display = 'none'; }
    
    function confirmMap() {
        let c = pickerMap.getCenter();
        activeInp.dataset.lat = c.lat; activeInp.dataset.lon = c.lng;
        // Reverse Geocode
        fetch(`https://nominatim.openstreetmap.org/reverse?lat=${c.lat}&lon=${c.lng}&format=json`)
        .then(r=>r.json()).then(d => {
            activeInp.value = d.display_name || `${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
            toggleX(activeInp);
        });
        closeMap();
    }

    function getMyLoc() {
        if(!navigator.geolocation) return alert("Vui l√≤ng b·∫≠t GPS!");
        let btn = document.getElementById('btn-loc'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
        navigator.geolocation.getCurrentPosition(p => {
            let i = document.getElementById('pickup');
            i.dataset.lat = p.coords.latitude; i.dataset.lon = p.coords.longitude;
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${p.coords.latitude}&lon=${p.coords.longitude}&format=json`)
            .then(r=>r.json()).then(d => { 
                i.value = d.display_name; 
                toggleX(i); 
                btn.innerHTML = '<i class="fas fa-crosshairs"></i> ' + LANG[curLang].btn_myloc;
            });
        }, () => {
            alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠!");
            btn.innerHTML = '<i class="fas fa-crosshairs"></i> ' + LANG[curLang].btn_myloc;
        });
    }

    // --- ADD STOP ---
    function addStop() {
        let id = 'stop-' + Date.now();
        let div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label class="form-label" data-i18n="lbl_stop_point">ƒêi·ªÉm d·ª´ng:</label>
            <input type="text" id="${id}" class="stop-inp" placeholder="${LANG[curLang].plh_stop}">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('${id}')">‚úï</button>
                <button class="tool-btn btn-trash" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-trash"></i></button>
                <button class="tool-btn btn-map" onclick="openMap('${id}')"><i class="fas fa-map"></i></button>
            </div>
            <div class="suggestions"></div>
        `;
        document.getElementById('stops-container').appendChild(div);
        setupAddr(id);
    }

    // --- CALCULATE ---
    function toggleWait() {
        document.getElementById('wait-area').style.display = document.getElementById('tripType').value=='2' ? 'block' : 'none';
    }

    async function calculate() {
        let p = document.getElementById('pickup'), d = document.getElementById('dropoff');
        if(!p.dataset.lat || !d.dataset.lat) return alert("Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ t·ª´ g·ª£i √Ω ho·∫∑c b·∫£n ƒë·ªì!");
        
        let btn = document.querySelector('.btn-calc');
        let oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...'; btn.disabled=true;

        // 1. Clear previous layers and markers
        if(routeLayer) map.removeLayer(routeLayer);
        markerLayer.clearLayers(); 

        // Gom t·ªça ƒë·ªô
        let points = [p, ...document.querySelectorAll('.stop-inp'), d];
        let validPoints = points.filter(x => x.dataset.lat);
        let coords = validPoints.map(x => `${x.dataset.lon},${x.dataset.lat}`).join(';');

        try {
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`);
            let data = await res.json();
            if(data.code !== 'Ok') throw 'Error';
            
            let r = data.routes[0];
            let km = r.distance / 1000;
            let min = Math.round(r.duration / 60);

            // 2. Map Route
            routeLayer = L.geoJSON(r.geometry).addTo(map);
            // Thi·∫øt l·∫≠p zoom th·ªß c√¥ng, sau ƒë√≥ fitbounds ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªÉn th·ªã h·∫øt c√°c ƒëi·ªÉm
            map.setZoom(10); 
            map.fitBounds(routeLayer.getBounds(), {padding:[30,30]});
            document.getElementById('main-map').style.display = 'block';

            // 3. Add Markers & Permanent Tooltips
            validPoints.forEach((el, index) => {
                let lat = parseFloat(el.dataset.lat);
                let lon = parseFloat(el.dataset.lon);
                let title = el.value;
                
                let label = '';
                if (index === 0) label = 'ƒê√ìN: ';
                else if (index === validPoints.length - 1) label = 'ƒê·∫æN: ';
                else label = `D·ª™NG ${index}: `;
                
                let marker = L.marker([lat, lon])
                    .bindPopup(`<b>${label}${title}</b>`)
                    .bindTooltip(label + title, {
                        permanent: true,
                        direction: 'right',
                        offset: [10, 0] // Offset ƒë·ªÉ tooltip kh√¥ng b·ªã d√≠nh v√†o marker
                    });
                
                // M·ªü tooltip vƒ©nh vi·ªÖn cho ƒëi·ªÉm ƒë√≥n/tr·∫£
                if (index === 0 || index === validPoints.length - 1) {
                    marker.openTooltip();
                }

                markerLayer.addLayer(marker); 
            });


            // Calc Price
            let type = document.getElementById('tripType').value;
            let unit = document.getElementById('carType').value=='4' ? CFG.p4 : CFG.p7;
            
            let go = Math.round(km * unit);
            let back = 0, wait = 0;
            
            // Reset visibility
            document.getElementById('row-back-full').style.display = 'none';
            document.getElementById('row-back-disc').style.display = 'none';
            document.getElementById('row-wait').style.display = 'none';

            if(type == '2') {
                let backFull = go;
                // ƒêi·ªÅu ki·ªán gi·∫£m gi√°: Chi·ªÅu ƒëi >= 45km
                if(km >= 45) { 
                    back = Math.round(go * 0.6); // Gi·∫£m 40%
                    document.getElementById('row-back-full').style.display = 'flex';
                    document.getElementById('val-back-full').innerText = backFull.toLocaleString() + ' ƒë';
                    document.getElementById('row-back-disc').style.display = 'flex';
                    document.getElementById('val-back-disc').innerText = back.toLocaleString() + ' ƒë';
                } else {
                    back = go;
                    // Hi·ªÉn th·ªã gi√° g·ªëc cho chi·ªÅu v·ªÅ (v√¨ kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán gi·∫£m)
                    document.getElementById('row-back-full').style.display = 'flex';
                    document.getElementById('val-back-full').style.textDecoration = 'none'; 
                    document.getElementById('val-back-full').style.color = '#333';
                    document.getElementById('val-back-full').innerText = back.toLocaleString() + ' ƒë';
                }

                let h = parseFloat(document.getElementById('waitHour').value) || 0;
                if(h > 3) wait = (h - 3) * CFG.wait;
                if(wait > 0) {
                    document.getElementById('row-wait').style.display = 'flex';
                    document.getElementById('val-wait').innerText = wait.toLocaleString() + ' ƒë';
                }
            }

            let total = go + back + wait;
            let deposit = (type == '2') ? Math.round(total * 0.2) : 0;

            document.getElementById('result-area').style.display = 'block';
            document.getElementById('res-km').innerText = km.toFixed(1) + ' km';
            document.getElementById('res-time').innerText = min + ' ph√∫t';
            document.getElementById('val-go').innerText = go.toLocaleString() + ' ƒë';
            document.getElementById('res-total').innerText = total.toLocaleString() + ' ƒë';
            
            if(deposit > 0) {
                document.getElementById('row-deposit').style.display = 'flex';
                document.getElementById('val-deposit').innerText = deposit.toLocaleString() + ' ƒë';
            } else {
                document.getElementById('row-deposit').style.display = 'none';
            }

            cachedData = { total, km: km.toFixed(1), time: min, go, back, wait, deposit, type };
            
            document.getElementById('result-area').scrollIntoView({behavior:'smooth'});

        } catch(e) { alert("Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng ƒëi!"); }
        
        btn.innerHTML = oldText; btn.disabled=false;
    }

    // --- BOOK ---
    function preBook(method) {
        if(!document.getElementById('phone').value) {
            pendingMethod = method;
            document.getElementById('phone-modal').style.display = 'flex';
        } else book(method);
    }
    function closePhone() { document.getElementById('phone-modal').style.display='none'; }
    function savePhone() {
        let p = document.getElementById('quick-phone').value;
        if(p.length < 8) return alert("SƒêT kh√¥ng ƒë√∫ng!");
        document.getElementById('phone').value = p;
        closePhone();
        book(pendingMethod);
    }

    function book(method) {
        let p = document.getElementById('pickup'), d = document.getElementById('dropoff');
        if(cachedData.total == 0) return alert("Vui l√≤ng t√≠nh gi√° tr∆∞·ªõc!");

        let info = {
            ph: document.getElementById('phone').value,
            t: document.getElementById('time').value.replace('T',' '),
            c: document.getElementById('carType').selectedOptions[0].text,
            k: document.getElementById('tripType').selectedOptions[0].text,
            dr: document.getElementById('driver').selectedOptions[0].text, 
            n: document.getElementById('note').value
        };

        // D√πng Google Maps link ng·∫Øn g·ªçn
        const linkMap = (el) => `http://maps.google.com/maps?q=${el.dataset.lat},${el.dataset.lon}`;

        // C·∫≠p nh·∫≠t d√≤ng ƒë·∫ßu: TR∆Ø·ªúNG AN DRIVING
        let msg = `TR∆Ø·ªúNG AN DRIVING\n----------------\nüìû ${info.ph}\nüïí ${info.t}\nüöò ${info.c}\nüîÑ ${info.k}\nüßë‚Äç‚úàÔ∏è Y√™u c·∫ßu t√†i x·∫ø: ${info.dr}\n\nüìç ƒê√≥n: ${p.value}\n   üëâ Map: ${linkMap(p)}\n`;
        
        document.querySelectorAll('.stop-inp').forEach((inp, i) => {
            if(inp.dataset.lat) msg += `üî∏ D·ª´ng ${i+1}: ${inp.value}\n   üëâ Map: ${linkMap(inp)}\n`;
        });

        msg += `üèÅ ƒê·∫øn: ${d.value}\n   üëâ Map: ${linkMap(d)}\n\n`;
        
        // Chi ti·∫øt gi√°
        msg += `--- CHI TI·∫æT GI√Å ---\n`;
        // L∆ØU √ù PH√ç C·∫¶U ƒê∆Ø·ªúNG
        msg += `‚ö†Ô∏è L∆∞u √Ω: Gi√° ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.\n`; 
        msg += `1. Qu√£ng ƒë∆∞·ªùng: ${cachedData.km} km\n`;
        msg += `2. Chi·ªÅu ƒëi: ${cachedData.go.toLocaleString()} ƒë\n`;
        if(cachedData.type == '2') {
            msg += `3. Chi·ªÅu v·ªÅ: ${cachedData.back.toLocaleString()} ƒë\n`;
            if(cachedData.wait > 0) msg += `4. Ph√≠ ch·ªù: ${cachedData.wait.toLocaleString()} ƒë\n`;
        }
        msg += `üí∞ T·ªîNG: ${cachedData.total.toLocaleString()} ƒë\n`;
        if(cachedData.deposit > 0) msg += `üí≥ C·ªçc (20%): ${cachedData.deposit.toLocaleString()} ƒë\n`;
        
        if(info.n) msg += `\nüìù Ghi ch√∫: ${info.n}`;

        if(method == 'zalo') {
             // C·∫£i thi·ªán t·ªëc ƒë·ªô: Sao ch√©p v√† m·ªü Zalo ngay
            navigator.clipboard.writeText(msg).then(() => {
                window.open('https://zalo.me/0847526893');
            }).catch(err => {
                 window.open('https://zalo.me/0847526893');
            });
        } else {
            const subject = 'ƒê·∫∂T XE TR∆Ø·ªúNG AN DRIVING'; 
            window.location.href = `mailto:truongan.driving@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(msg)}`;
        }
    }

</script>

</body>
</html>
