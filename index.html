<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªãch V·ª• Taxi Tr∆∞·ªùng An Driving</title>
    <style>
        /* =======================================================
           PH·∫¶N 1: CSS (Giao di·ªán)
           ======================================================= */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }
        .header {
            text-align: center;
            padding: 10px 0;
            background-color: #4CAF50;
            color: white;
            margin: -20px -20px 20px -20px;
        }
        .header h2, .header p {
            margin: 5px 0;
        }
        .status-alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .status-error {
            background-color: #f44336;
            color: white;
            /* Th√™m bi·ªÉu t∆∞·ª£ng c·∫£nh b√°o */
            content: '‚ö†Ô∏è'; 
        }
        .status-success {
            background-color: #4CAF50;
            color: white;
        }
        .input-group, .select-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="tel"], select, input[type="datetime-local"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .input-location-group {
            position: relative;
        }
        .input-location-group input {
            padding-right: 95px; /* ƒê·∫£m b·∫£o ƒë·ªß ch·ªó cho n√∫t B·∫£n ƒë·ªì */
        }
        .map-btn {
            position: absolute;
            right: 0;
            top: 0;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            height: 100%;
        }
        .autocomplete-results {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            z-index: 10;
            background: white;
            position: absolute;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-results div {
            padding: 10px;
            cursor: pointer;
        }
        .autocomplete-results div:hover {
            background-color: #eee;
        }
        .btn-confirm {
            width: 100%;
            padding: 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
        .btn-add-stop {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üöï D·ªãch V·ª• Taxi Tr∆∞·ªùng An Driving</h2>
            <p>üìû 0847526893</p>
        </div>

        <div id="status-message" class="status-alert status-error">
            ƒêang t·∫£i tr·∫°ng th√°i d·ªãch v·ª•...
        </div>

        <form id="order-form">
            <div class="input-group">
                <label>üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n</label>
                <input type="tel" id="phone-number" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" required>
            </div>

            <div class="input-group">
                <label>üìç ƒêi·ªÉm ƒë√≥n</label>
                <div class="input-location-group">
                    <input type="text" id="pickup-point" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n" required>
                    <button type="button" class="map-btn" onclick="openMapSearch(document.getElementById('pickup-point'))">B·∫£n ƒë·ªì</button> 
                    <div id="pickup-autocomplete" class="autocomplete-results"></div>
                </div>
            </div>

            <div class="input-group">
                <label>üïí Ng√†y & Gi·ªù ƒë√≥n</label>
                <input type="datetime-local" id="time-input" value="" required> 
            </div>

            <button type="button" class="btn-add-stop">+ Th√™m ƒëi·ªÉm d·ª´ng</button>
            
            <div class="input-group" style="margin-top: 15px;">
                <label>üèÅ ƒêi·ªÉm ƒë·∫øn</label>
                <div class="input-location-group">
                    <input type="text" id="destination-point" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi" required>
                    <button type="button" class="map-btn" onclick="openMapSearch(document.getElementById('destination-point'))">B·∫£n ƒë·ªì</button>
                    <div id="destination-autocomplete" class="autocomplete-results"></div>
                </div>
            </div>

            <div class="select-group">
                <label>üöó Lo·∫°i xe</label>
                <select id="car-type">
                    <option value="4 ch·ªó (10.000ƒë/km)">Xe 4 ch·ªó (10.000ƒë/km)</option>
                    <option value="7 ch·ªó (12.000ƒë/km)">Xe 7 ch·ªó (12.000ƒë/km)</option>
                </select>
            </div>

            <div class="select-group">
                <label>üîÑ Lo·∫°i chuy·∫øn ƒëi</label>
                <select id="trip-type">
                    <option value="1 chi·ªÅu">1 chi·ªÅu</option>
                    <option value="2 chi·ªÅu">2 chi·ªÅu (Gi√° ∆∞u ƒë√£i)</option>
                </select>
            </div>

            <button type="submit" class="btn-confirm">X√°c nh·∫≠n ƒê·∫∑t xe</button>
        </form>
    </div>

    <script>
        /* =======================================================
           PH·∫¶N 2: JAVASCRIPT LOGIC
           ======================================================= */
        
        // C√ÅC H·∫∞NG S·ªê C·∫§U H√åNH
        const REMOTE_STATUS_URL = "/status-local.json";
        // TƒÉng th·ªùi gian ch·ªù ƒë·ªÉ gi·∫£m t·∫£i cho API, kh·∫Øc ph·ª•c l·ªói 'L·ªói m·∫°ng ho·∫∑c API'
        const DEBOUNCE_TIME = 700; 
        const NOMINATIM = "https://nominatim.openstreetmap.org/search";

        // =======================================================
        // A. LOGIC T·∫†O LINK B·∫¢N ƒê·ªí (THEO Y√äU C·∫¶U)
        // =======================================================

        /**
         * T·∫°o URL t√¨m ki·∫øm Google Maps t·ª´ m·ªôt chu·ªói ƒë·ªãa ch·ªâ.
         * @param {string} address - ƒê·ªãa ch·ªâ c·∫ßn t√¨m ki·∫øm.
         * @returns {string} URL Google Maps Search.
         */
        function createMapLink(address) {
            if (!address) {
                return "Kh√¥ng c√≥ ƒë·ªãa ch·ªâ";
            }
            const encodedAddress = encodeURIComponent(address);
            // ƒê·ªãnh d·∫°ng URL t√¨m ki·∫øm Google Maps
            return `https://www.google.com/maps/search/?api=1&query=$/search/?api=1&query=${encodedAddress}`;
        }

        /**
         * M·ªü Google Maps Search trong c·ª≠a s·ªï m·ªõi khi b·∫•m n√∫t "B·∫£n ƒë·ªì".
         * @param {HTMLElement} inputElement - Tr∆∞·ªùng nh·∫≠p li·ªáu.
         */
        function openMapSearch(inputElement) {
            const query = inputElement.value ? inputElement.value : "t√¨m ki·∫øm ƒë·ªãa ƒëi·ªÉm";
            const mapUrl = createMapLink(query);
            window.open(mapUrl, '_blank');
            alert('Vui l√≤ng t√¨m ki·∫øm v·ªã tr√≠ tr√™n c·ª≠a s·ªï m·ªõi v√† nh·∫≠p ƒë·ªãa ch·ªâ ch√≠nh x√°c v√†o √¥ n√†y.');
        }

        // =======================================================
        // B. LOGIC X·ª¨ L√ù ƒê∆†N H√ÄNG V√Ä G·ª¨I D·ªÆ LI·ªÜU
        // =======================================================

        document.getElementById('order-form').addEventListener('submit', function(e) {
            e.preventDefault(); 
            confirmOrder();
        });

        /**
         * H√†m ch√≠nh x·ª≠ l√Ω logic x√°c nh·∫≠n v√† g·ª≠i ƒë∆°n h√†ng.
         */
        function confirmOrder() {
            // L·∫•y d·ªØ li·ªáu t·ª´ c√°c tr∆∞·ªùng nh·∫≠p li·ªáu
            const phoneNumber = document.getElementById('phone-number').value;
            const pickupAddress = document.getElementById('pickup-point').value;
            const destinationAddress = document.getElementById('destination-point').value;
            const timeInput = document.getElementById('time-input').value;
            const carType = document.getElementById('car-type').value;
            const tripType = document.getElementById('trip-type').value;

            // KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN C∆† B·∫¢N
            if (!phoneNumber || !pickupAddress || !destinationAddress || !timeInput) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin: SƒêT, ƒêi·ªÉm ƒë√≥n, ƒêi·ªÉm tr·∫£ v√† Th·ªùi gian.");
                return;
            }

            // T·∫†O C√ÅC LINK B·∫¢N ƒê·ªí CHO T√ÄI X·∫æ
            const pickupMapLink = createMapLink(pickupAddress);
            const destinationMapLink = createMapLink(destinationAddress);
            
            // T√≠nh to√°n Gi√° c∆∞·ªõc ∆∞·ªõc t√≠nh (C·∫¶N B·ªî SUNG LOGIC T√çNH TO√ÅN C·ª¶A B·∫†N T·∫†I ƒê√ÇY)
            const estimatedPrice = "Vui l√≤ng ƒë·ª£i b√°o gi√°"; 

            // ƒê·ªäNH D·∫†NG N·ªòI DUNG TIN NH·∫ÆN CU·ªêI C√ôNG
            const messageBody = `
                --- ƒê∆†N H√ÄNG TAXI M·ªöI ---
                
                üìû SƒêT Kh√°ch: ${phoneNumber}
                üöó Lo·∫°i xe: ${carType} (${tripType})
                üí∞ Gi√° ∆∞·ªõc t√≠nh: ${estimatedPrice}

                --- TH√îNG TIN CHUY·∫æN ƒêI ---
                üïí Th·ªùi gian ƒë√≥n: ${new Date(timeInput).toLocaleString('vi-VN')}
                
                üìç ƒêI·ªÇM ƒê√ìN:
                - ƒê·ªãa ch·ªâ: ${pickupAddress}
                - Link Maps: ${pickupMapLink}
                
                üèÅ ƒêI·ªÇM TR·∫¢:
                - ƒê·ªãa ch·ªâ: ${destinationAddress}
                - Link Maps: ${destinationMapLink}
                
                Vui l√≤ng x√°c nh·∫≠n v√† li√™n h·ªá kh√°ch!
            `;
            
            // --- PH·∫¶N G·ª¨I ƒê∆†N H√ÄNG TH·ª∞C T·∫æ ---
            // D√πng API Zalo/SMS/Telegram/v.v. ƒë·ªÉ g·ª≠i messageBody ƒë·∫øn s·ªë c·ªßa b·∫°n.
            
            console.log("N·ªôi dung ƒë∆°n h√†ng ƒë√£ t·∫°o:\n", messageBody);
            
            alert("‚úÖ ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! Ch√∫ng t√¥i s·∫Ω li√™n h·ªá l·∫°i ngay.");
        }

        // =======================================================
        // C. LOGIC KI·ªÇM TRA TR·∫†NG TH√ÅI D·ªäCH V·ª§ (Kill Switch)
        // =======================================================
        
        function checkServiceStatus() {
            const statusElement = document.getElementById('status-message');
            fetch(REMOTE_STATUS_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('L·ªói HTTP: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.active) {
                        statusElement.textContent = data.message_vn;
                        statusElement.className = 'status-alert status-success';
                    } else {
                        statusElement.textContent = data.message_vn;
                        statusElement.className = 'status-alert status-error';
                        // V√¥ hi·ªáu h√≥a form n·∫øu d·ªãch v·ª• ƒëang off
                        document.getElementById('order-form').querySelector('.btn-confirm').disabled = true;
                    }
                })
                .catch(error => {
                    console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•:', error);
                    statusElement.textContent = '‚ùå Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.';
                    statusElement.className = 'status-alert status-error';
                });
        }
        
        // G·ªçi h√†m ki·ªÉm tra tr·∫°ng th√°i khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', () => {
             checkServiceStatus();
             // ƒê·∫∑t th·ªùi gian hi·ªán t·∫°i cho input datetime-local
             const now = new Date();
             now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
             document.getElementById('time-input').value = now.toISOString().slice(0, 16);
        });


        // =======================================================
        // D. LOGIC AUTOCOMPLETE ƒê·ªäA CH·ªà
        // =======================================================
        
        // H√†m Debounce ƒë·ªÉ gi·ªõi h·∫°n s·ªë l∆∞·ª£ng y√™u c·∫ßu API
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // H√†m x·ª≠ l√Ω t√¨m ki·∫øm v√† hi·ªÉn th·ªã g·ª£i √Ω
        function handleAutocomplete(input, resultsContainer) {
            const query = input.value.trim();
            if (query.length < 3) {
                resultsContainer.innerHTML = '';
                return;
            }

            // G·∫Øn th√™m 'Vi·ªát Nam' v√†o query
            const fullQuery = query + ", Vi·ªát Nam";

            fetch(`${NOMINATIM}?q=${encodeURIComponent(fullQuery)}&format=json&addressdetails=1&limit=5`)
                .then(response => {
                    if (!response.ok) throw new Error('API Rate Limit ho·∫∑c L·ªói m·∫°ng');
                    return response.json();
                })
                .then(data => {
                    resultsContainer.innerHTML = '';
                    if (data.length === 0) {
                        resultsContainer.innerHTML = '<div style="font-size: 0.8em; color: gray;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</div>';
                        return;
                    }

                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.textContent = item.display_name;
                        div.onclick = () => {
                            // Ch·ªâ l·∫•y ph·∫ßn ƒë·ªãa ch·ªâ ch√≠nh (kh√¥ng c·∫ßn c√°c th√¥ng tin ph·ª•)
                            input.value = item.display_name; 
                            resultsContainer.innerHTML = '';
                        };
                        resultsContainer.appendChild(div);
                    });
                })
                .catch(error => {
                    resultsContainer.innerHTML = '<div style="color: red; font-size: 0.8em; padding: 10px;">L·ªói m·∫°ng ho·∫∑c API. Th·ª≠ l·∫°i.</div>';
                    console.error("L·ªói t√¨m ki·∫øm API:", error);
                });
        }

        // Thi·∫øt l·∫≠p s·ª± ki·ªán l·∫Øng nghe v·ªõi Debounce
        const debouncedPickup = debounce(() => handleAutocomplete(
            document.getElementById('pickup-point'), 
            document.getElementById('pickup-autocomplete')
        ), DEBOUNCE_TIME);

        const debouncedDestination = debounce(() => handleAutocomplete(
            document.getElementById('destination-point'), 
            document.getElementById('destination-autocomplete')
        ), DEBOUNCE_TIME);

        document.getElementById('pickup-point').addEventListener('input', debouncedPickup);
        document.getElementById('destination-point').addEventListener('input', debouncedDestination);

        // ƒê·∫£m b·∫£o ·∫©n g·ª£i √Ω khi click ra ngo√†i
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-location-group')) {
                document.getElementById('pickup-autocomplete').innerHTML = '';
                document.getElementById('destination-autocomplete').innerHTML = '';
            }
        });

    </script>
</body>
</html>
