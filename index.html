<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-lang-key="page_title">ğŸš– Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--green:#28a745;--muted:#6c757d;}
    *{box-sizing:border-box}
    #main-content {
      background:#f4f6f8;
      padding: 0;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    .container{padding:12px}
    .label-row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .label-row h3{margin:0;font-size:16px}

    /* --- NEW: Language Switcher Styles --- */
    .lang-switcher {
      text-align: center;
      padding: 8px 0;
      background-color: #f0f0f0;
    }
    .lang-btn {
      background: none;
      border: 2px solid transparent;
      font-size: 24px;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 8px;
      margin: 0 5px;
      transition: border-color 0.2s;
    }
    .lang-btn:hover {
      border-color: #ccc;
    }
    .lang-btn.active {
      border-color: var(--green);
      background-color: #e9f5ee;
    }
    /* --- End Language Switcher Styles --- */

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    .input-row{position:relative;margin-top:8px}
    .input-row .clear-btn {
        position: absolute; right: 80px; top: 11px; 
        background: #f0f0f0; color: #666; border: none; padding: 3px 6px; 
        border-radius: 4px; font-weight: 700; cursor: pointer; line-height: 1;
        font-size: 14px; display: none; 
        z-index: 1000;
    }
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: block; 
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    .map-btn{position:absolute; right:8px; top:8px; background:var(--green); color:#fff; border:0; padding:6px 8px; border-radius:6px; font-weight:700; cursor:pointer}
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    .suggestions{position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff;border:1px solid #ddd;border-radius:8px;max-height:220px;overflow:auto; -webkit-overflow-scrolling:touch; z-index:1200; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:10px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:8px}
    .way-remove{position:absolute;right:6px;top:6px;background:#ff6b6b;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}
    .kill-switch-styles,.disabled-form{pointer-events:none;opacity:.6;transition:opacity .3s}
    #serviceOffNotice{margin-top:12px;padding:10px;background:#dc3545;color:#fff;border-radius:8px;font-size:15px;font-weight:600;text-align:center}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9999;display:none;justify-content:center;align-items:center;padding:20px;animation:fadeIn .3s}
    .modal-content{background:#fff;border-radius:12px;padding:20px;width:100%;max-width:450px;max-height:90vh;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,.3);animation:slideIn .3s}
    .modal-content h3{margin-top:0;color:var(--green);font-size:20px;text-align:center}
    #modal-text{white-space:pre-wrap;font-family:monospace;font-size:14px;background:#f8f9fa;padding:10px;border-radius:6px;border:1px solid #ddd;margin-bottom:15px}
    .modal-actions{display:flex;gap:10px}
    .modal-actions button{flex:1;padding:12px;border-radius:8px;font-weight:700;border:none;cursor:pointer}
    #copyModalBtn{background:#ffc107;color:#333}
    #zaloModalBtn{background:#0068ff;color:#fff}
    #closeModalBtn{background:#ccc;color:#333}
    #phoneModal .modal-content{background:#f8d7da;border:1px solid #f5c6cb}
    #phoneModal h3{color:#721c24}
    #phoneModal #inputPhoneForBooking{margin-top:15px}
    #phoneModal #confirmPhoneBtn{background:#007bff;color:#fff}
    #depositModal .modal-content{background:#d4edda;border:1px solid #c3e6cb}
    #depositModal h3{color:#155724}
    #depositModal p{margin-bottom:15px}
    #depositModal #depositAmount{font-weight:800;font-size:20px;color:#007bff;background:#fff;padding:5px 10px;border-radius:5px;display:inline-block}
    #depositModal #confirmDepositBtn{background:var(--green);color:#fff}
    #driverRequest{font-size:18px;font-weight:600;border:2px solid var(--green)}
    .driver-option-highlight{color:red;font-weight:900!important;background-color:#f7f7f7}
    .driver-option-avatar{margin-right:5px;font-size:1.1em;vertical-align:middle}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    @media (min-width:700px){.container{max-width:720px;margin:0 auto}}
  </style>
</head>
<body>
<div id="main-content">
  <header>
    <span data-lang-key="header_service">ğŸš– Dá»‹ch Vá»¥ Taxi</span><br>
    <span data-lang-key="header_brand">TrÆ°á»ng An Driving</span><br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">â˜ï¸ 0847526893</a> 
  </header>

  <div class="lang-switcher">
    <button id="lang-vi" class="lang-btn active" data-lang="vi">ğŸ‡»ğŸ‡³</button>
    <button id="lang-en" class="lang-btn" data-lang="en">ğŸ‡¬ğŸ‡§</button>
    <button id="lang-zh" class="lang-btn" data-lang="zh">ğŸ‡¨ğŸ‡³</button>
  </div>
  
  <div class="container">
    
    <div id="serviceOffNotice" style="display:none;"></div>
    
    <div id="instructionText" data-lang-key="instruction_checking" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;">
      ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...
    </div>

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3 data-lang-key="phone_label">ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)</h3></div>
      <input id="customerPhone" type="tel" data-lang-key="phone_placeholder" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel">

      <div class="label-row">
        <h3 data-lang-key="pickup_label">ğŸ“ Äiá»ƒm Ä‘Ã³n</h3>
        <div id="location-status-wrapper" style="display: flex; align-items: center; gap: 8px;">
          <span id="location-status" data-lang-key="location_finding" style="font-size:12px; color:var(--muted); font-weight:bold;">(Äang tÃ¬m vá»‹ trÃ­...)</span>
          <i id="reloadLocationBtn" data-lang-key="location_reload_title" title="Thá»­ láº¥y láº¡i vá»‹ trÃ­">ğŸ”„</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" data-lang-key="pickup_placeholder" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)">
        <button class="clear-btn" data-input-id="pickup">âœ–</button> 
        <button class="map-btn" id="pick-from-map" data-lang-key="map_button">Báº£n Ä‘á»“</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="datetime_label">ğŸ•’ NgÃ y & Giá» Ä‘Ã³n</h3></div>
      <input id="pickupDateTime" type="datetime-local">

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn" data-lang-key="add_stop_button">ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng</button>

      <div class="label-row"><h3 data-lang-key="dropoff_label">ğŸ Äiá»ƒm Ä‘áº¿n</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" data-lang-key="dropoff_placeholder" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i">
        <button class="clear-btn" data-input-id="dropoff">âœ–</button> 
        <button class="map-btn" id="pick-to-map" data-lang-key="map_button">Báº£n Ä‘á»“</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="car_type_label">ğŸš˜ Loáº¡i xe</h3></div>
      <select id="carType">
        <option value="4 chá»— (10.000Ä‘/km)" data-lang-key="car_type_4_seater">Xe 4 chá»— (10.000Ä‘/km)</option> 
        <option value="7 chá»— (12.000Ä‘/km)" data-lang-key="car_type_7_seater">Xe 7 chá»— (12.000Ä‘/km)</option> 
      </select>
      
      <div class="label-row" style="margin-top:12px">
        <h3 data-lang-key="driver_request_label">
            ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿ 
            <span class="driver-option-avatar" title="Icon nÃ y cÃ³ thá»ƒ thay báº±ng Avatar">ğŸ‘¤</span>
        </h3>
      </div>
      <select id="driverRequest">
        <option value="TrÆ°á»ng An Driving" class="driver-option-highlight" data-lang-key="driver_default">
            â­ TrÆ°á»ng An Driving (Máº·c Ä‘á»‹nh)
        </option>
        <option value="Thanh Loan">ğŸ‘¸ Thanh Loan</option>
        <option value="ÄÃ¬nh TÃ¢m">ğŸ§‘â€âœˆï¸ ÄÃ¬nh TÃ¢m</option>
        <option value="Háº£i ÄÄƒng">ğŸ§‘â€âœˆï¸ Háº£i ÄÄƒng</option>
        <option value="LÃª TÃ¢m">ğŸ§‘â€âœˆï¸ LÃª TÃ¢m</option>
        <option value="Nguyá»…n Tháº£o">ğŸ‘¸ Nguyá»…n Tháº£o</option>
        <option value="Quá»‘c DÅ©ng">ğŸ§‘â€âœˆï¸ Quá»‘c DÅ©ng</option>
        <option value="TÃ¢n Há»“">ğŸ§‘â€âœˆï¸ TÃ¢n Há»“</option>
        <option value="Tráº§n Vinh">ğŸ§‘â€âœˆï¸ Tráº§n Vinh</option>
        <option value="XuÃ¢n Phong">ğŸ§‘â€âœˆï¸ XuÃ¢n Phong</option>
      </select>

      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="trip_type_label">ğŸš— Loáº¡i chuyáº¿n Ä‘i</h3></div>
      <select id="tripType">
        <option value="1" data-lang-key="trip_type_one_way">1 chiá»u</option>
        <option value="2" data-lang-key="trip_type_round_trip">2 chiá»u (giáº£m 40% chiá»u vá»)</option>
      </select>

      <div id="waitingWrapper"> 
        <div class="label-row" style="margin-top:12px"><h3 data-lang-key="waiting_time_label">â³ Thá»i gian chá» (giá»)</h3></div>
        <input id="waiting" type="number" min="0" value="0" data-lang-key="waiting_time_placeholder" placeholder="Nháº­p sá»‘ giá» chá»">
      </div>

      <button class="calc-btn" id="calc-btn" data-lang-key="calc_button">ğŸ’° TÃ­nh giÃ¡</button>
    </div> <div id="map"></div>

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText" data-lang-key="result_distance">âœï¸ QuÃ£ng Ä‘Æ°á»ng: â€”</div>
      </div>

      <div class="price-title" data-lang-key="result_price_label">ğŸ’µ GiÃ¡ dá»± kiáº¿n</div>
      <div class="price-value" id="priceValue">â€” Ä‘</div>

      <div class="price-break" id="priceBreak"></div>

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst" data-lang-key="result_time_est">â± Thá»i gian dá»± kiáº¿n: â€” phÃºt</div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo" data-lang-key="result_pickup_time">ğŸ•’ NgÃ y giá» Ä‘Ã³n: â€”</div>
    </div>

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" href="javascript:void(0);" style="display:none;" data-lang-key="book_via_zalo">ğŸ“± Äáº·t qua Zalo</a>
      <a id="mailBtn" class="mail" href="javascript:void(0);" style="display:none;" data-lang-key="book_via_mail">ğŸ“§ Äáº·t qua Mail</a>
    </div>

    <div class="note" data-lang-key="note_html">
      ğŸ“Œ Ghi chÃº: GiÃ¡ 4 chá»—/7 chá»—: **10.000Ä‘/km** / **12.000Ä‘/km**. 2 chiá»u: chiá»u vá» giáº£m 40% (Ã¡p dá»¥ng cho chuyáº¿n 1 chiá»u **â‰¥ 45km**).
      <br>
      **Thá»i gian chá»:**
      <ul>
        <li>Chá» 0â€“3 giá»: **Miá»…n phÃ­**.</li>
        <li>Ká»ƒ tá»« giá» thá»© 4, má»—i giá» tiáº¿p theo phÃ¡t sinh phá»¥ phÃ­ **50.000 VNÄ/giá»**.</li>
        <li>Thá»i gian chá» Ä‘Æ°á»£c tÃ­nh tá»« khi hÃ nh khÃ¡ch **hoÃ n táº¥t viá»‡c xuá»‘ng xe táº¡i Ä‘iá»ƒm Ä‘áº¿n** cho Ä‘áº¿n khi xe quay trá»Ÿ láº¡i Ä‘Ã³n Ä‘á»ƒ vá» Ä‘iá»ƒm xuáº¥t phÃ¡t ban Ä‘áº§u.</li>
      </ul>
      GiÃ¡ Ä‘Ã£ bao gá»“m phÃ­ cáº§u Ä‘Æ°á»ng.
    </div>
  </div>
</div>

<div id="depositModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="deposit_modal_title">ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u</h3>
        <div data-lang-key="deposit_modal_body_html">
            <p>
                **QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:**<br>
                Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i **Hai chiá»u** cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch **Ä‘áº·t cá»c trÆ°á»›c 20%** trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.
            </p>
            <p style="text-align:center; font-size:18px;">
                Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n: <span id="depositAmount">0 Ä‘</span>
            </p>
            <p>
                Khi nhÃ¢n viÃªn **TrÆ°á»ng An Driving** pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i **hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ** (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.
            </p>
            <p style="font-size:14px; color:#555;">
                **LÆ°u Ã½:** Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i.
                Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.
            </p>
        </div>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmDepositBtn" style="width:100%;" data-lang-key="deposit_modal_confirm_btn">ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="phone_modal_title">ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i</h3>
        <p style="text-align:center;" data-lang-key="phone_modal_body">QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.</p>
        <input id="inputPhoneForBooking" type="tel" data-lang-key="phone_placeholder" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel" required>
        <div class="modal-actions" style="margin-top:15px;">
            <button id="confirmPhoneBtn" data-lang-key="phone_modal_confirm_btn">XÃ¡c nháº­n</button> 
        </div>
        <button id="closePhoneModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; background:#ccc; color:#333;" data-lang-key="modal_close_btn">ÄÃ³ng</button>
    </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="zalo_modal_title">âœ… THÃ”NG TIN Äáº¶T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;" data-lang-key="zalo_modal_instruction">Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn" data-lang-key="modal_copy_btn">ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin</button> 
            <button id="zaloModalBtn" data-lang-key="modal_open_zalo_btn">ğŸ“± Má»Ÿ Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;" data-lang-key="modal_close_btn">ÄÃ³ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- START: LANGUAGE TRANSLATION SETUP ---------- */
const translations = {
    "vi": {
        "page_title": "ğŸš– Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving",
        "header_service": "ğŸš– Dá»‹ch Vá»¥ Taxi",
        "header_brand": "TrÆ°á»ng An Driving",
        "instruction_checking": "ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...",
        "phone_label": "ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)",
        "phone_placeholder": "Nháº­p SÄT (10 sá»‘, VD: 0987654321)",
        "pickup_label": "ğŸ“ Äiá»ƒm Ä‘Ã³n",
        "location_finding": "(Äang tÃ¬m vá»‹ trÃ­...)",
        "location_reload_title": "Thá»­ láº¥y láº¡i vá»‹ trÃ­",
        "pickup_placeholder": "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)",
        "map_button": "Báº£n Ä‘á»“",
        "datetime_label": "ğŸ•’ NgÃ y & Giá» Ä‘Ã³n",
        "add_stop_button": "ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng",
        "dropoff_label": "ğŸ Äiá»ƒm Ä‘áº¿n",
        "dropoff_placeholder": "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i",
        "car_type_label": "ğŸš˜ Loáº¡i xe",
        "car_type_4_seater": "Xe 4 chá»— (10.000Ä‘/km)",
        "car_type_7_seater": "Xe 7 chá»— (12.000Ä‘/km)",
        "driver_request_label": "ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿",
        "driver_default": "â­ TrÆ°á»ng An Driving (Máº·c Ä‘á»‹nh)",
        "trip_type_label": "ğŸš— Loáº¡i chuyáº¿n Ä‘i",
        "trip_type_one_way": "1 chiá»u",
        "trip_type_round_trip": "2 chiá»u (giáº£m 40% chiá»u vá»)",
        "waiting_time_label": "â³ Thá»i gian chá» (giá»)",
        "waiting_time_placeholder": "Nháº­p sá»‘ giá» chá»",
        "calc_button": "ğŸ’° TÃ­nh giÃ¡",
        "result_distance": "âœï¸ QuÃ£ng Ä‘Æ°á»ng: â€”",
        "result_price_label": "ğŸ’µ GiÃ¡ dá»± kiáº¿n",
        "result_time_est": "â± Thá»i gian dá»± kiáº¿n: â€” phÃºt",
        "result_pickup_time": "ğŸ•’ NgÃ y giá» Ä‘Ã³n: â€”",
        "book_via_zalo": "ğŸ“± Äáº·t qua Zalo",
        "book_via_mail": "ğŸ“§ Äáº·t qua Mail",
        "note_html": "ğŸ“Œ Ghi chÃº: GiÃ¡ 4 chá»—/7 chá»—: **10.000Ä‘/km** / **12.000Ä‘/km**. 2 chiá»u: chiá»u vá» giáº£m 40% (Ã¡p dá»¥ng cho chuyáº¿n 1 chiá»u **â‰¥ 45km**).<br>**Thá»i gian chá»:**<ul><li>Chá» 0â€“3 giá»: **Miá»…n phÃ­**.</li><li>Ká»ƒ tá»« giá» thá»© 4, má»—i giá» tiáº¿p theo phÃ¡t sinh phá»¥ phÃ­ **50.000 VNÄ/giá»**.</li><li>Thá»i gian chá» Ä‘Æ°á»£c tÃ­nh tá»« khi hÃ nh khÃ¡ch **hoÃ n táº¥t viá»‡c xuá»‘ng xe táº¡i Ä‘iá»ƒm Ä‘áº¿n** cho Ä‘áº¿n khi xe quay trá»Ÿ láº¡i Ä‘Ã³n Ä‘á»ƒ vá» Ä‘iá»ƒm xuáº¥t phÃ¡t ban Ä‘áº§u.</li></ul>GiÃ¡ Ä‘Ã£ bao gá»“m phÃ­ cáº§u Ä‘Æ°á»ng.",
        "deposit_modal_title": "ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u",
        "deposit_modal_body_html": "<p>**QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:**<br>Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i **Hai chiá»u** cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch **Ä‘áº·t cá»c trÆ°á»›c 20%** trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.</p><p style='text-align:center; font-size:18px;'>Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n: <span id='depositAmount'>0 Ä‘</span></p><p>Khi nhÃ¢n viÃªn **TrÆ°á»ng An Driving** pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i **hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ** (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.</p><p style='font-size:14px; color:#555;'>**LÆ°u Ã½:** Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i. Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.</p>",
        "deposit_modal_confirm_btn": "ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c",
        "phone_modal_title": "ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i",
        "phone_modal_body": "QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.",
        "phone_modal_confirm_btn": "XÃ¡c nháº­n",
        "modal_close_btn": "ÄÃ³ng",
        "zalo_modal_title": "âœ… THÃ”NG TIN Äáº¶T XE",
        "zalo_modal_instruction": "Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:",
        "modal_copy_btn": "ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin",
        "modal_open_zalo_btn": "ğŸ“± Má»Ÿ Zalo Chat",
        "alert_map_pickup": "Báº¥m vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n Ä‘iá»ƒm Ä‘Ã³n",
        "alert_map_dropoff": "Báº¥m vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n Ä‘iá»ƒm Ä‘áº¿n",
        "location_found": "âœ… ÄÃ£ tÃ¬m tháº¥y vá»‹ trÃ­",
        "location_error": "âš ï¸ Lá»—i tÃ¬m vá»‹ trÃ­. Nháº­p thá»§ cÃ´ng.",
        "location_denied": "âŒ Bá»‹ tá»« chá»‘i quyá»n truy cáº­p vá»‹ trÃ­.",
        "location_unavailable": "âŒ Vá»‹ trÃ­ khÃ´ng kháº£ dá»¥ng (Báº­t GPS).",
        "location_timeout": "âš ï¸ Háº¿t thá»i gian tÃ¬m vá»‹ trÃ­.",
        "location_unsupported": "âŒ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Geolocation."
    },
    "en": {
        "page_title": "ğŸš– Truong An Driving - Taxi Service",
        "header_service": "ğŸš– Taxi Service",
        "header_brand": "Truong An Driving",
        "instruction_checking": "ğŸ’° Checking service status...",
        "phone_label": "ğŸ“ Your Phone Number (Optional for Price Calculation)",
        "phone_placeholder": "Enter phone no. (10 digits, e.g., 0987654321)",
        "pickup_label": "ğŸ“ Pickup Location",
        "location_finding": "(Finding location...)",
        "location_reload_title": "Retry finding location",
        "pickup_placeholder": "Enter pickup address (or auto-detect)",
        "map_button": "Map",
        "datetime_label": "ğŸ•’ Pickup Date & Time",
        "add_stop_button": "ï¼‹ Add Stop",
        "dropoff_label": "ğŸ Destination",
        "dropoff_placeholder": "Enter final destination address",
        "car_type_label": "ğŸš˜ Vehicle Type",
        "car_type_4_seater": "4-seater (10,000Ä‘/km)",
        "car_type_7_seater": "7-seater (12,000Ä‘/km)",
        "driver_request_label": "ğŸ§‘â€âœˆï¸ Request Driver",
        "driver_default": "â­ Truong An Driving (Default)",
        "trip_type_label": "ğŸš— Trip Type",
        "trip_type_one_way": "One-way",
        "trip_type_round_trip": "Round trip (40% off return leg)",
        "waiting_time_label": "â³ Waiting Time (hours)",
        "waiting_time_placeholder": "Enter waiting hours",
        "calc_button": "ğŸ’° Calculate Price",
        "result_distance": "âœï¸ Distance: â€”",
        "result_price_label": "ğŸ’µ Estimated Fare",
        "result_time_est": "â± Estimated Time: â€” minutes",
        "result_pickup_time": "ğŸ•’ Pickup Time: â€”",
        "book_via_zalo": "ğŸ“± Book via Zalo",
        "book_via_mail": "ğŸ“§ Book via Mail",
        "note_html": "ğŸ“Œ Note: 4-seater/7-seater rates: **10,000Ä‘/km** / **12,000Ä‘/km**. Round trip: 40% discount on return leg (applies to one-way trips **â‰¥ 45km**).<br>**Waiting Time:**<ul><li>0â€“3 hours wait: **Free**.</li><li>From the 4th hour, a surcharge of **50,000 VND/hour** applies.</li><li>Waiting time is calculated from when the passenger alights at the destination until the car returns for the pickup.</li></ul>Price includes all toll fees.",
        "deposit_modal_title": "ğŸ“ Deposit Required for Round Trip",
        "deposit_modal_body_html": "<p>**Dear Customer,**<br>To confirm and ensure service quality for your **Round trip**, we kindly request a **20% deposit** of the estimated total fare.</p><p style='text-align:center; font-size:18px;'>Estimated Deposit: <span id='depositAmount'>0 Ä‘</span></p><p>When our staff from **Truong An Driving** responds via Zalo, we will provide **specific payment instructions** (bank transfer) to complete the deposit process.</p><p style='font-size:14px; color:#555;'>**Note:** The remaining balance is to be paid directly to the driver after the trip. Thank you for your trust in our service.</p>",
        "deposit_modal_confirm_btn": "I Understand and Continue",
        "phone_modal_title": "ğŸ“ Please Enter Your Phone Number",
        "phone_modal_body": "Please provide your phone number so we can contact you to confirm the booking.",
        "phone_modal_confirm_btn": "Confirm",
        "modal_close_btn": "Close",
        "zalo_modal_title": "âœ… BOOKING INFORMATION",
        "zalo_modal_instruction": "Copy this information and send it via Zalo:",
        "modal_copy_btn": "ğŸ“‹ Copy Information",
        "modal_open_zalo_btn": "ğŸ“± Open Zalo Chat",
        "alert_map_pickup": "Click on the map to select a pickup location",
        "alert_map_dropoff": "Click on the map to select a destination",
        "location_found": "âœ… Location found",
        "location_error": "âš ï¸ Error finding location. Please enter manually.",
        "location_denied": "âŒ Location access denied.",
        "location_unavailable": "âŒ Location unavailable (Turn on GPS).",
        "location_timeout": "âš ï¸ Timed out finding location.",
        "location_unsupported": "âŒ Geolocation is not supported by this browser."
    },
    "zh": {
        "page_title": "ğŸš– Truong An Driving - å‡ºç§Ÿè½¦æœåŠ¡",
        "header_service": "ğŸš– å‡ºç§Ÿè½¦æœåŠ¡",
        "header_brand": "Truong An Driving",
        "instruction_checking": "ğŸ’° æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...",
        "phone_label": "ğŸ“ æ‚¨çš„ç”µè¯å·ç  (è®¡ç®—ä»·æ ¼éå¿…å¡«)",
        "phone_placeholder": "è¾“å…¥ç”µè¯å·ç  (10ä½æ•°, ä¾‹å¦‚: 0987654321)",
        "pickup_label": "ğŸ“ ä¸Šè½¦åœ°ç‚¹",
        "location_finding": "(æ­£åœ¨å¯»æ‰¾ä½ç½®...)",
        "location_reload_title": "é‡è¯•å¯»æ‰¾ä½ç½®",
        "pickup_placeholder": "è¾“å…¥ä¸Šè½¦åœ°å€ (æˆ–è‡ªåŠ¨æ£€æµ‹)",
        "map_button": "åœ°å›¾",
        "datetime_label": "ğŸ•’ ä¸Šè½¦æ—¥æœŸå’Œæ—¶é—´",
        "add_stop_button": "ï¼‹ æ·»åŠ ç»åœç‚¹",
        "dropoff_label": "ğŸ ç›®çš„åœ°",
        "dropoff_placeholder": "è¾“å…¥æœ€ç»ˆç›®çš„åœ°åœ°å€",
        "car_type_label": "ğŸš˜ è½¦è¾†ç±»å‹",
        "car_type_4_seater": "4åº§è½¦ (10,000è¶Šå—ç›¾/å…¬é‡Œ)",
        "car_type_7_seater": "7åº§è½¦ (12,000è¶Šå—ç›¾/å…¬é‡Œ)",
        "driver_request_label": "ğŸ§‘â€âœˆï¸ æŒ‡å®šå¸æœº",
        "driver_default": "â­ Truong An Driving (é»˜è®¤)",
        "trip_type_label": "ğŸš— è¡Œç¨‹ç±»å‹",
        "trip_type_one_way": "å•ç¨‹",
        "trip_type_round_trip": "å¾€è¿” (è¿”ç¨‹ä¼˜æƒ 40%)",
        "waiting_time_label": "â³ ç­‰å¾…æ—¶é—´ (å°æ—¶)",
        "waiting_time_placeholder": "è¾“å…¥ç­‰å¾…å°æ—¶æ•°",
        "calc_button": "ğŸ’° è®¡ç®—ä»·æ ¼",
        "result_distance": "âœï¸ è·ç¦»: â€”",
        "result_price_label": "ğŸ’µ é¢„è®¡è´¹ç”¨",
        "result_time_est": "â± é¢„è®¡æ—¶é—´: â€” åˆ†é’Ÿ",
        "result_pickup_time": "ğŸ•’ ä¸Šè½¦æ—¶é—´: â€”",
        "book_via_zalo": "ğŸ“± é€šè¿‡Zaloé¢„è®¢",
        "book_via_mail": "ğŸ“§ é€šè¿‡é‚®ä»¶é¢„è®¢",
        "note_html": "ğŸ“Œ æ³¨æ„: 4åº§/7åº§è½¦è´¹ç‡: **10,000è¶Šå—ç›¾/å…¬é‡Œ** / **12,000è¶Šå—ç›¾/å…¬é‡Œ**ã€‚å¾€è¿”è¡Œç¨‹: è¿”ç¨‹ä¼˜æƒ 40% (é€‚ç”¨äºå•ç¨‹ **â‰¥ 45å…¬é‡Œ** çš„è¡Œç¨‹)ã€‚<br>**ç­‰å¾…æ—¶é—´:**<ul><li>ç­‰å¾…0-3å°æ—¶: **å…è´¹**ã€‚</li><li>ä»ç¬¬4å°æ—¶èµ·ï¼Œæ¯å°æ—¶åŠ æ”¶ **50,000è¶Šå—ç›¾** çš„é™„åŠ è´¹ã€‚</li><li>ç­‰å¾…æ—¶é—´ä»ä¹˜å®¢åœ¨ç›®çš„åœ°å®Œå…¨ä¸‹è½¦æ—¶å¼€å§‹è®¡ç®—ï¼Œç›´åˆ°è½¦è¾†è¿”å›æ¥å®¢ä¸ºæ­¢ã€‚</li></ul>ä»·æ ¼å·²åŒ…å«æ‰€æœ‰è¿‡è·¯è´¹ã€‚",
        "deposit_modal_title": "ğŸ“ å¾€è¿”è¡Œç¨‹éœ€æ”¯ä»˜æŠ¼é‡‘",
        "deposit_modal_body_html": "<p>**å°Šæ•¬çš„å®¢æˆ·,**<br>ä¸ºç¡®è®¤å¹¶ä¿è¯æ‚¨çš„**å¾€è¿”è¡Œç¨‹**æœåŠ¡è´¨é‡ï¼Œæˆ‘ä»¬æ³è¯·æ‚¨é¢„ä»˜é¢„è®¡æ€»è´¹ç”¨çš„**20%ä½œä¸ºæŠ¼é‡‘**ã€‚</p><p style='text-align:center; font-size:18px;'>é¢„è®¡æŠ¼é‡‘: <span id='depositAmount'>0 Ä‘</span></p><p>å½“æˆ‘ä»¬çš„**Truong An Driving**å‘˜å·¥é€šè¿‡Zaloå›å¤æ‚¨æ—¶ï¼Œæˆ‘ä»¬å°†å‘é€**å…·ä½“çš„ä»˜æ¬¾è¯´æ˜** (é“¶è¡Œè½¬è´¦) ä»¥å®ŒæˆæŠ¼é‡‘ç¨‹åºã€‚</p><p style='font-size:14px; color:#555;'>**æ³¨æ„:** å‰©ä½™è´¹ç”¨å°†åœ¨è¡Œç¨‹ç»“æŸåç›´æ¥æ”¯ä»˜ç»™å¸æœºã€‚æ„Ÿè°¢æ‚¨å¯¹æˆ‘ä»¬æœåŠ¡çš„ä¿¡ä»»ã€‚</p>",
        "deposit_modal_confirm_btn": "æˆ‘æ˜ç™½å¹¶ç»§ç»­",
        "phone_modal_title": "ğŸ“ è¯·è¾“å…¥æ‚¨çš„ç”µè¯å·ç ",
        "phone_modal_body": "è¯·è¾“å…¥æ‚¨çš„ç”µè¯å·ç ï¼Œä»¥ä¾¿æˆ‘ä»¬è”ç³»æ‚¨ç¡®è®¤è®¢å•ã€‚",
        "phone_modal_confirm_btn": "ç¡®è®¤",
        "modal_close_btn": "å…³é—­",
        "zalo_modal_title": "âœ… é¢„è®¢ä¿¡æ¯",
        "zalo_modal_instruction": "å¤åˆ¶æ­¤ä¿¡æ¯å¹¶é€šè¿‡Zaloå‘é€:",
        "modal_copy_btn": "ğŸ“‹ å¤åˆ¶ä¿¡æ¯",
        "modal_open_zalo_btn": "ğŸ“± æ‰“å¼€ZaloèŠå¤©",
        "alert_map_pickup": "ç‚¹å‡»åœ°å›¾é€‰æ‹©ä¸Šè½¦åœ°ç‚¹",
        "alert_map_dropoff": "ç‚¹å‡»åœ°å›¾é€‰æ‹©ç›®çš„åœ°",
        "location_found": "âœ… å·²æ‰¾åˆ°ä½ç½®",
        "location_error": "âš ï¸ å¯»æ‰¾ä½ç½®æ—¶å‡ºé”™ã€‚è¯·æ‰‹åŠ¨è¾“å…¥ã€‚",
        "location_denied": "âŒ ä½ç½®è®¿é—®è¢«æ‹’ç»ã€‚",
        "location_unavailable": "âŒ ä½ç½®ä¸å¯ç”¨ (è¯·æ‰“å¼€GPS)ã€‚",
        "location_timeout": "âš ï¸ å¯»æ‰¾ä½ç½®è¶…æ—¶ã€‚",
        "location_unsupported": "âŒ æ­¤æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½ã€‚"
    }
};

function updateLanguage(lang) {
    document.documentElement.lang = lang; // Update html lang attribute
    document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        const translation = translations[lang][key];
        if (translation) {
            // Handle different element types
            if (element.hasAttribute('placeholder')) {
                element.placeholder = translation;
            } else if (element.hasAttribute('title')) {
                element.title = translation;
            } else if (key.endsWith('_html')) { // For elements with complex HTML
                element.innerHTML = translation;
            }
            else {
                // Preserve child nodes like icons (<i>, <span>)
                const firstChild = element.firstChild;
                if (firstChild && (firstChild.nodeType === Node.ELEMENT_NODE)) {
                    // If the first child is an element (like an icon), only change the text part
                     const textNode = firstChild.nextSibling;
                     if(textNode && textNode.nodeType === Node.TEXT_NODE) {
                         textNode.textContent = ' ' + translation;
                     } else {
                         element.innerHTML = element.innerHTML.split('>')[0] + '>' + translation;
                     }
                } else {
                    element.textContent = translation;
                }
            }
        }
    });

    // Update active button style
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });

    // Save language choice
    localStorage.setItem('language', lang);
}
/* ---------- END: LANGUAGE TRANSLATION SETUP ---------- */

/* ---------- Cáº¥u hÃ¬nh Tá»‘i Æ¯u HÃ³a ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving";
const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/"; 
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/"; 
const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const driverRequestEl = document.getElementById('driverRequest');
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn');
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 
const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const phoneModal = document.getElementById('phoneModal');
const inputPhoneForBooking = document.getElementById('inputPhoneForBooking');
const confirmPhoneBtn = document.getElementById('confirmPhoneBtn');
const closePhoneModalBtn = document.getElementById('closePhoneModalBtn');
const depositModal = document.getElementById('depositModal');
const depositAmountEl = document.getElementById('depositAmount'); // Renamed to avoid conflict
const confirmDepositBtn = document.getElementById('confirmDepositBtn');

let finalZaloMessage = ''; 
let finalTotalFee = 0; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;
let bookingAction = null;

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`; 
    const finalUrl = REMOTE_STATUS_URL + cacheBuster;
    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
        if (!response.ok) {
            return { active: false, message_vn: "âš ï¸ Cáº¢NH BÃO Máº NG: KhÃ´ng tÃ¬m tháº¥y file tráº¡ng thÃ¡i dá»‹ch vá»¥ (404/Server Error). Chá»©c nÄƒng Ä‘áº·t xe bá»‹ táº¡m ngÆ°ng." };
        }
        return await response.json();
    } catch (error) {
        let msg = "âš ï¸ Thiáº¿t bá»‹ Ä‘ang OFFLINE hoáº·c Lá»–I Káº¾T Ná»I. KhÃ´ng thá»ƒ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng."
        if (error.name === 'TimeoutError') {
             msg = "âš ï¸ Kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥ quÃ¡ lÃ¢u. Viá»‡c Ä‘áº·t xe bá»‹ táº¡m ngÆ°ng."
        }
        console.error("Lá»—i khi fetch tráº¡ng thÃ¡i dá»‹ch vá»¥:", error);
        return { active: false, message_vn: msg };
    }
}

async function updateUIBasedOnStatus(status) {
    if (status.active !== isServiceActive) {
        isServiceActive = status.active;
    }
    instructionText.style.display = 'block';
    if (!isServiceActive) {
        calcBtn.style.background = '#ccc';
        calcBtn.style.cursor = 'not-allowed';
        calcBtn.disabled = true;
        serviceOffNotice.style.display = 'block';
        serviceOffNotice.innerHTML = status.message_vn;
        bookingFormWrapper.classList.add('disabled-form');
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';
    } else {
        calcBtn.style.background = 'var(--green)';
        calcBtn.style.cursor = 'pointer';
        calcBtn.disabled = false;
        serviceOffNotice.style.display = 'none';
        bookingFormWrapper.classList.remove('disabled-form');
        const lang = localStorage.getItem('language') || 'vi';
        const msgKey = lang === 'en' ? 'message_en' : lang === 'zh' ? 'message_zh' : 'message_vn';
        instructionText.innerHTML = status[msgKey] || status.message_vn || 'ğŸ’° Báº¥m "TÃ­nh giÃ¡" Ä‘á»ƒ xem chi tiáº¿t Ä‘áº·t xe.';
    }
}

function initMap(center) {
    if (!map) {
        map = L.map('map').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        map.on('click', handleMapClick);
        map.on('dblclick', handleMapDblClick);
    } else {
        map.setView(center, 11);
    }
}

async function reverseGeocode(lat, lon) {
    try {
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=vi`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        console.warn('Reverse Geocoding Error', e);
        return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }
}

function getGeolocation() {
    const lang = localStorage.getItem('language') || 'vi';
    locationStatusEl.textContent = translations[lang]['location_finding'];
    locationStatusEl.style.color = 'var(--muted)';
    reloadLocationBtn.style.color = '#ccc'; 
    reloadLocationBtn.style.pointerEvents = 'none';

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            userLocation = [pos.coords.latitude, pos.coords.longitude]; 
            initMap(userLocation); 
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';
            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup('ğŸ“').openPopup();
            locationStatusEl.textContent = translations[lang]['location_found'];
            locationStatusEl.style.color = 'var(--green)';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';
        }, (err)=>{
            console.warn('Geolocation Error:', err.message);
            initMap(DEFAULT_CENTER); 
            let statusKey;
            if (err.code === err.PERMISSION_DENIED) statusKey = 'location_denied';
            else if (err.code === err.POSITION_UNAVAILABLE) statusKey = 'location_unavailable';
            else if (err.code === err.TIMEOUT) statusKey = 'location_timeout';
            else statusKey = 'location_error';
            locationStatusEl.textContent = translations[lang][statusKey];
            locationStatusEl.style.color = '#dc3545';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';
        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
    } else {
        initMap(DEFAULT_CENTER); 
        locationStatusEl.textContent = translations[lang]['location_unsupported'];
        locationStatusEl.style.color = '#dc3545';
        reloadLocationBtn.style.color = '#ccc';
        reloadLocationBtn.style.pointerEvents = 'none';
    }
}

function debounce(func, timeout = 300) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); }; }
function toggleWaitingInput(){ waitingWrapper.style.display = tripTypeEl.value === '1' ? 'none' : 'block'; }
tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput();

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
            inputEl.value = '';
            delete inputEl.dataset.lat;
            delete inputEl.dataset.lon;
            if (inputId === 'pickup' && pickupMarker) { map.removeLayer(pickupMarker); pickupMarker = null; }
            else if (inputId === 'dropoff' && dropoffMarker) { map.removeLayer(dropoffMarker); dropoffMarker = null; }
            const suggBox = document.getElementById(`${inputId}-suggestions`);
            if (suggBox) suggBox.style.display = 'none';
            inputEl.focus(); 
        }
    });
});

document.querySelectorAll('input[type="text"]').forEach(inputEl => {
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if (clearBtn) {
        const toggle = () => { clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; };
        inputEl.addEventListener('input', toggle);
        inputEl.addEventListener('focus', toggle);
        inputEl.addEventListener('blur', () => setTimeout(() => clearBtn.style.display = 'none', 150));
    }
});

async function geocodeOnce(query) {
    try {
        let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1`;
        if (userLocation) {
            const [lat, lon] = userLocation;
            url += `&viewbox=${lon-0.5},${lat-0.5},${lon+0.5},${lat+0.5}`;
        } else {
            url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
        }
        const r = await fetch(url);
        const data = await r.json();
        return (Array.isArray(data) && data.length > 0) ? data[0] : null;
    } catch (e) {
        console.warn('geocode once error', e);
        return null;
    }
}

function attachAutocomplete(inputEl, boxEl) {
    let controller = null;
    const doSearch = async () => {
        const q = inputEl.value.trim();
        const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
        if (!q) { boxEl.style.display = 'none'; if(clearBtn) clearBtn.style.display = 'none'; return; }
        if (clearBtn) clearBtn.style.display = 'block';
        if (controller) controller.abort();
        controller = new AbortController();
        boxEl.innerHTML = '<div>...</div>';
        boxEl.style.display = 'block';
        let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=vi`;
        if (userLocation) {
            const [lat, lon] = userLocation;
            url += `&viewbox=${lon-0.3},${lat-0.3},${lon+0.3},${lat+0.3}`;
        } else {
            url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
        }
        try {
            const res = await fetch(url, { signal: controller.signal });
            const data = await res.json();
            boxEl.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                boxEl.innerHTML = '<div>No results</div>';
                setTimeout(() => boxEl.style.display = 'none', 1000);
                return;
            }
            data.forEach(place => {
                const d = document.createElement('div');
                d.innerHTML = `ğŸ“<div style="margin-left:8px">${place.display_name}</div>`;
                d.addEventListener('click', () => {
                    inputEl.value = place.display_name;
                    inputEl.dataset.lat = place.lat;
                    inputEl.dataset.lon = place.lon;
                    boxEl.style.display = 'none';
                    if (clearBtn) clearBtn.style.display = 'block';
                    const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
                    if (map) {
                        if (inputEl.id === 'pickup') {
                            if (pickupMarker) map.removeLayer(pickupMarker);
                            pickupMarker = L.marker(latlng).addTo(map).bindPopup('ğŸ“').openPopup();
                            map.setView(latlng, 14);
                        } else if (inputEl.id === 'dropoff') {
                            if (dropoffMarker) map.removeLayer(dropoffMarker);
                            dropoffMarker = L.marker(latlng).addTo(map).bindPopup('ğŸ').openPopup();
                            map.setView(latlng, 14);
                        }
                    }
                });
                boxEl.appendChild(d);
            });
        } catch (err) {
            if (err.name !== 'AbortError') console.error('suggest error', err);
        }
    };
    inputEl.addEventListener('input', debounce(doSearch));
    document.addEventListener('click', (ev) => { if (!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; });
    inputEl.addEventListener('focus', () => { if (inputEl.id.startsWith('stop-')) lastFocusedStopId = inputEl.id; else lastFocusedStopId = null; });
}

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

function createStopInput(prefill = '') {
    stopCount++;
    const wrapper = document.createElement('div');
    wrapper.className = 'way-wrapper input-row';
    const inputId = `stop-${stopCount}`;
    wrapper.innerHTML = `<input type="text" id="${inputId}" placeholder="Stop ${stopCount}"><button class="clear-btn" data-input-id="${inputId}">âœ–</button><button class="way-remove" title="Remove">âœ–</button><div id="${inputId}-suggestions" class="suggestions" style="display:none"></div>`;
    stopsContainer.appendChild(wrapper);
    const inputEl = wrapper.querySelector('input');
    attachAutocomplete(inputEl, wrapper.querySelector('.suggestions'));
    inputEl.addEventListener('focus', () => lastFocusedStopId = inputId);
    wrapper.querySelector('.way-remove').addEventListener('click', () => wrapper.remove());
    const clearBtn = wrapper.querySelector('.clear-btn');
    const toggle = () => { clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; };
    inputEl.addEventListener('input', toggle);
    inputEl.addEventListener('focus', toggle);
    inputEl.addEventListener('blur', () => setTimeout(() => clearBtn.style.display = 'none', 150));
    clearBtn.addEventListener('click', (e) => { e.stopPropagation(); inputEl.value = ''; delete inputEl.dataset.lat; delete inputEl.dataset.lon; inputEl.focus(); });
}
document.getElementById('add-stop-btn').addEventListener('click', () => createStopInput());

document.getElementById('pick-from-map').addEventListener('click', () => { selecting = 'pickup'; alert(translations[localStorage.getItem('language') || 'vi']['alert_map_pickup']); });
document.getElementById('pick-to-map').addEventListener('click', () => { selecting = 'dropoff'; alert(translations[localStorage.getItem('language') || 'vi']['alert_map_dropoff']); });

const handleMapClick = async (e) => {
    if (!map) return;
    const { lat, lng: lon } = e.latlng;
    let targetInput;
    if (selecting === 'pickup') {
        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = L.marker([lat, lon]).addTo(map).bindPopup('ğŸ“').openPopup();
        targetInput = pickupEl;
        selecting = null;
    } else if (selecting === 'dropoff') {
        if (dropoffMarker) map.removeLayer(dropoffMarker);
        dropoffMarker = L.marker([lat, lon]).addTo(map).bindPopup('ğŸ').openPopup();
        targetInput = dropoffEl;
        selecting = null;
    } else if (lastFocusedStopId) {
        L.marker([lat, lon]).addTo(map).bindPopup('ğŸ›‘').openPopup();
        targetInput = document.getElementById(lastFocusedStopId);
        lastFocusedStopId = null;
    }
    if (targetInput) {
        const address = await reverseGeocode(lat, lon);
        targetInput.value = address;
        targetInput.dataset.lat = lat;
        targetInput.dataset.lon = lon;
        targetInput.parentNode.querySelector('.clear-btn').style.display = 'block';
    }
};

const handleMapDblClick = (e) => {
    if (!map || !lastFocusedStopId) return;
    const stopInput = document.getElementById(lastFocusedStopId);
    if (stopInput) {
        const { lat, lng } = e.latlng;
        stopInput.value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        stopInput.dataset.lat = lat;
        stopInput.dataset.lon = lng;
        L.marker([lat, lng]).addTo(map).bindPopup('ğŸ›‘').openPopup();
        lastFocusedStopId = null;
    }
};

async function resolveCoordForInput(inputEl) {
    if (inputEl.dataset.lat && inputEl.dataset.lon) return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
    const v = inputEl.value.trim();
    if (!v) return null;
    const parts = v.split(',');
    if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) return [parseFloat(parts[0]), parseFloat(parts[1])];
    const place = await geocodeOnce(v + ' Viá»‡t Nam');
    if (place) {
        inputEl.dataset.lat = place.lat;
        inputEl.dataset.lon = place.lon;
        return [parseFloat(place.lat), parseFloat(place.lon)];
    }
    return null;
}

function validateRouteInputs() {
    if (!pickupEl.value.trim()) { alert('Please enter a pickup location.'); pickupEl.focus(); return false; }
    if (!dropoffEl.value.trim()) { alert('Please enter a destination.'); dropoffEl.focus(); return false; }
    if (tripTypeEl.value === '2' && (isNaN(parseFloat(waitingEl.value)) || parseFloat(waitingEl.value) < 0)) { alert('Please enter a valid waiting time for a round trip.'); waitingEl.focus(); return false; }
    return true;
}

function validatePhone(phone) { return /^\d{10}$/.test(phone); }

async function calculateAndGenerateMessage() {
    if (!validateRouteInputs()) return false;
    
    const [pickupCoord, dropoffCoord] = await Promise.all([resolveCoordForInput(pickupEl), resolveCoordForInput(dropoffEl)]);
    if (!pickupCoord || !dropoffCoord) { alert('Could not find coordinates for pickup or dropoff.'); return false; }

    const coords = [pickupCoord];
    const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
    for (const s of stopInputs) {
        if (s.value.trim()) {
            const sc = await resolveCoordForInput(s);
            if (!sc) { alert('Could not find coordinates for a stop.'); return false; }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord);

    resultBox.style.display = 'block';
    distanceText.textContent = 'Calculating route...';
    try {
        const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
        const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;
        const r = await fetch(url);
        const data = await r.json();
        if (!data.routes || data.routes.length === 0) { distanceText.textContent = 'Could not calculate route.'; return false; }
        
        const route = data.routes[0];
        const dist = route.distance / 1000;
        const minutes = Math.round(dist / 30 * 60);

        if (map) {
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
        }
        
        const tripType = tripTypeEl.value;
        const carType = carTypeEl.value;
        const driverRequest = driverRequestEl.value;
        const waiting = parseFloat(waitingEl.value) || 0;
        const perKm = carType.includes('7 chá»—') ? 12000 : 10000;
        const priceGo = Math.round(dist * perKm);
        let priceReturn = 0;
        if (tripType === '2') {
            priceReturn = dist >= 45 ? Math.round(dist * perKm * 0.6) : priceGo;
        }
        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total;
        
        distanceText.textContent = `QuÃ£ng Ä‘Æ°á»ng: ${dist.toFixed(1)} km (má»™t chiá»u)`;
        priceValue.textContent = total.toLocaleString('vi-VN') + ' Ä‘';
        // Details... (omitted for brevity but logic remains)
        
        const pickupAddress = pickupEl.value.trim();
        const dropoffAddress = dropoffEl.value.trim();
        const pickupLatLon = `${pickupCoord[0]},${pickupCoord[1]}`;
        const dropoffLatLon = `${dropoffCoord[0]},${dropoffCoord[1]}`;
        
        finalZaloMessage = [
            'ğŸš– YÃŠU Cáº¦U Äáº¶T XE', '-------------------------------',
            `ğŸ“ SÄT: [CHÆ¯A CÃ“]`, `Chuyáº¿n: ${tripType === '1' ? '1 Chiá»u' : '2 Chiá»u'}`, `Xe: ${carType}`, `TÃ i xáº¿: ${driverRequest}`,
            `ğŸ“ ÄÃ³n: ${pickupAddress}`, `ğŸ Tráº£: ${dropoffAddress}`, `ğŸ’µ PhÃ­: ${total.toLocaleString('vi-VN')} Ä‘`,
            `ğŸ—ºï¸ Vá»‹ trÃ­ Ä‘Ã³n: ${GOOGLE_MAPS_BASE_URL}${pickupLatLon}`,
            `ğŸ›£ï¸ Chá»‰ Ä‘Æ°á»ng: ${GOOGLE_MAPS_DIR_URL}${pickupLatLon}/${dropoffLatLon}`
        ].join('\n');

        zaloBtn.style.display = 'block';
        mailBtn.style.display = 'block';
        instructionText.innerHTML = 'âœ… Calculation successful! Please click Book via Zalo/Mail to complete.';
        resultBox.scrollIntoView({ behavior: 'smooth' });
        return true;
    } catch (err) {
        console.error('Calculation error', err);
        distanceText.textContent = 'Error calculating route.';
        return false;
    }
}

calcBtn.addEventListener('click', async () => {
    if (!isServiceActive) { alert('Service is currently unavailable.'); return; }
    const success = await calculateAndGenerateMessage();
    if (success && tripTypeEl.value === '2') {
        const deposit = Math.round(finalTotalFee * 0.2);
        depositAmountEl.textContent = deposit.toLocaleString('vi-VN') + ' Ä‘';
        depositModal.style.display = 'flex';
    }
});

function handleBookingClick(action) {
    if (finalTotalFee === 0) { alert('Please calculate the price first.'); return; }
    bookingAction = action;
    const phone = customerPhoneEl.value.trim();
    if (!validatePhone(phone)) {
        inputPhoneForBooking.value = phone;
        phoneModal.style.display = 'flex';
        inputPhoneForBooking.focus();
    } else {
        openFinalZaloModal(phone);
    }
}
zaloBtn.addEventListener('click', () => handleBookingClick('zalo'));
mailBtn.addEventListener('click', () => handleBookingClick('mail'));

confirmPhoneBtn.addEventListener('click', () => {
    const phone = inputPhoneForBooking.value.trim();
    if (!validatePhone(phone)) { alert('Please enter a valid 10-digit phone number.'); return; }
    customerPhoneEl.value = phone;
    phoneModal.style.display = 'none';
    if (bookingAction) openFinalZaloModal(phone);
});

closePhoneModalBtn.addEventListener('click', () => { phoneModal.style.display = 'none'; bookingAction = null; });
confirmDepositBtn.addEventListener('click', () => { depositModal.style.display = 'none'; });

function openFinalZaloModal(phone) {
    const finalMessage = finalZaloMessage.replace('[CHÆ¯A CÃ“]', phone);
    modalText.textContent = finalMessage;
    if (bookingAction === 'mail') {
        const encodedMsg = encodeURIComponent(finalMessage);
        const subject = 'YÃªu cáº§u Äáº·t xe';
        window.location.href = `mailto:netvuan@gmail.com?subject=${subject}&body=${encodedMsg}`;
    } else {
        zaloModal.style.display = 'flex';
        copyToClipboard(finalMessage);
    }
    bookingAction = null;
}

async function copyToClipboard(text) { try { await navigator.clipboard.writeText(text); return true; } catch (err) { return false; } }
copyModalBtn.addEventListener('click', async () => { if (await copyToClipboard(modalText.textContent)) alert('Copied!'); else alert('Copy failed.'); });
zaloModalBtn.addEventListener('click', () => { zaloModal.style.display = 'none'; window.open(ZALO_URL, '_blank'); });
closeModalBtn.addEventListener('click', () => { zaloModal.style.display = 'none'; });

function setMinPickupDateTime() {
    const minTime = new Date(new Date().getTime() + 30 * 60000);
    const format = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    pickupDateTime.min = format(minTime);
    if (!pickupDateTime.value) pickupDateTime.value = format(minTime);
}

document.addEventListener('DOMContentLoaded', async () => {
    const savedLang = localStorage.getItem('language') || 'vi';
    updateLanguage(savedLang);

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            updateLanguage(btn.dataset.lang);
        });
    });

    setMinPickupDateTime();
    getGeolocation();
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
        }
        setMinPickupDateTime();
    }, 15000); 
    
    reloadLocationBtn.addEventListener('click', getGeolocation); 
});

if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed:', err)); }); }
</script>
</body>
</html>
