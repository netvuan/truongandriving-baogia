<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸš– Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--green:#28a745;--muted:#6c757d;}
    *{box-sizing:border-box}
    #main-content {
      background:#f4f6f8;
      padding: 0;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    
    /* NEW: Styling cho Language Select */
    #language-select-wrapper {
        display: flex;
        justify-content: flex-end; /* Äáº©y tháº» chá»n sang pháº£i */
        padding: 0 12px;
        margin-top: 10px;
    }
    #language-select {
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
    }

    .container{padding:12px}
    .label-row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .label-row h3{margin:0;font-size:16px}

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    .input-row{position:relative;margin-top:8px}
    .input-row .clear-btn {
        position: absolute; right: 80px; top: 11px; 
        background: #f0f0f0; color: #666; border: none; padding: 3px 6px; 
        border-radius: 4px; font-weight: 700; cursor: pointer; line-height: 1;
        font-size: 14px; display: none; 
        z-index: 1000;
    }
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: block; 
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    .map-btn{position:absolute; right:8px; top:8px; background:var(--green); color:#fff; border:0; padding:6px 8px; border-radius:6px; font-weight:700; cursor:pointer}
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    .suggestions{position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff;border:1px solid #ddd;border-radius:8px;max-height:220px;overflow:auto; -webkit-overflow-scrolling:touch; z-index:1200; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:10px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:8px}
    .way-remove{position:absolute;right:6px;top:6px;background:#ff6b6b;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}

    /* KILL SWITCH STYLES */
    .disabled-form {
        pointer-events: none;
        opacity: 0.6; 
        transition: opacity 0.3s;
    }
    #serviceOffNotice {
      margin-top: 12px; 
      padding: 10px; 
      background: #dc3545; 
      color: white; 
      border-radius: 8px; 
      font-size: 15px; 
      font-weight: 600; 
      text-align: center;
    }


    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.7); z-index: 9999; display: none;
      justify-content: center; align-items: center; padding: 20px;
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background: #fff; border-radius: 12px; padding: 20px;
      width: 100%; max-width: 450px; 
      max-height: 90vh; 
      overflow-y: auto; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    .modal-content h3 {
      margin-top: 0; color: var(--green); font-size: 20px; text-align: center;
    }
    #modal-text {
      white-space: pre-wrap; 
      font-family: monospace;
      font-size: 14px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .modal-actions {
      display: flex; gap: 10px;
    }
    .modal-actions button {
      flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer;
    }
    #copyModalBtn { background: #ffc107; color: #333; } 
    #zaloModalBtn { background: #0068ff; color: #fff; }
    #closeModalBtn { background: #ccc; color: #333; }
    
    /* Phone Modal Styles */
    #phoneModal .modal-content { background: #f8d7da; border: 1px solid #f5c6cb; }
    #phoneModal h3 { color: #721c24; }
    #phoneModal #inputPhoneForBooking { margin-top: 15px; }
    #phoneModal #confirmPhoneBtn { background: #007bff; color: white; }

    /* Deposit Modal Styles */
    #depositModal .modal-content { background: #d4edda; border: 1px solid #c3e6cb; }
    #depositModal h3 { color: #155724; }
    #depositModal p { margin-bottom: 15px; }
    #depositModal #depositAmount { 
        font-weight: 800; 
        font-size: 20px; 
        color: #007bff; 
        background: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        display: inline-block;
    }
    #depositModal #confirmDepositBtn { background: var(--green); color: white; }
    
    /* NEW: Driver Select Styling */
    #driverRequest {
        font-size: 18px; /* TÄƒng cá»¡ chá»¯ */
        font-weight: 600;
        border: 2px solid var(--green); /* Viá»n ná»•i báº­t */
    }
    .driver-option-highlight {
        color: red; /* MÃ u Ä‘á» ná»•i báº­t cho TrÆ°á»ng An Driving */
        font-weight: 900 !important; /* Äáº£m báº£o ná»•i báº­t */
        background-color: #f7f7f7;
    }
    .driver-option-avatar {
        margin-right: 5px; 
        font-size: 1.1em;
        vertical-align: middle;
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media(min-width:700px){.container{max-width:720px;margin:0 auto}}
  </style>
</head>
<body>
<div id="main-content">
  <header>
    ğŸš– Dá»‹ch Vá»¥ Taxi<br>
    TrÆ°á»ng An Driving<br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">â˜ï¸ 0847526893</a> 
  </header>
  
  <div id="language-select-wrapper">
    <select id="language-select" name="language">
        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (Tiáº¿ng Trung)</option>
    </select>
  </div>
  <div class="container">
    
    <div id="serviceOffNotice" style="display:none;" data-lang-key="service_off_notice">
      </div>
    
    <div id="instructionText" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;" data-lang-key="instruction_text_loading">
      ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...
    </div>

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3 data-lang-key="phone_label">ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)</h3></div>
      <input id="customerPhone" type="tel" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel" data-lang-placeholder="phone_placeholder">

      <div class="label-row">
        <h3 data-lang-key="pickup_label">ğŸ“ Äiá»ƒm Ä‘Ã³n</h3>
        <div id="location-status-wrapper" style="display: flex; align-items: center; gap: 8px;">
          <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;" data-lang-key="location_status_loading">(Äang tÃ¬m vá»‹ trÃ­...)</span>
          <i id="reloadLocationBtn" data-lang-title="reload_location_title">ğŸ”„</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)" data-lang-placeholder="pickup_placeholder">
        <button class="clear-btn" data-input-id="pickup">âœ–</button> 
        <button class="map-btn" id="pick-from-map" data-lang-key="map_button_pickup">Báº£n Ä‘á»“</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="time_label">ğŸ•’ NgÃ y & Giá» Ä‘Ã³n</h3></div>
      <input id="pickupDateTime" type="datetime-local">

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn" data-lang-key="add_stop_button">ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng</button>

      <div class="label-row"><h3 data-lang-key="dropoff_label">ğŸ Äiá»ƒm Ä‘áº¿n</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i" data-lang-placeholder="dropoff_placeholder">
        <button class="clear-btn" data-input-id="dropoff">âœ–</button> 
        <button class="map-btn" id="pick-to-map" data-lang-key="map_button_dropoff">Báº£n Ä‘á»“</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="car_type_label">ğŸš˜ Loáº¡i xe</h3></div>
      <select id="carType">
        <option value="4 chá»— (10.000Ä‘/km)" data-lang-key="car_4_seater">Xe 4 chá»— (10.000Ä‘/km)</option> 
        <option value="7 chá»— (12.000Ä‘/km)" data-lang-key="car_7_seater">Xe 7 chá»— (12.000Ä‘/km)</option> 
      </select>
      
      <div class="label-row" style="margin-top:12px">
        <h3 data-lang-key="driver_request_label">
            ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿ 
            <span class="driver-option-avatar" title="Icon nÃ y cÃ³ thá»ƒ thay báº±ng Avatar">ğŸ‘¤</span>
        </h3>
      </div>
      <select id="driverRequest">
        <option value="TrÆ°á»ng An Driving" class="driver-option-highlight">
            â­ TrÆ°á»ng An Driving (Máº·c Ä‘á»‹nh)
        </option>
        <option value="Thanh Loan">ğŸ‘¸ Thanh Loan</option>
        <option value="ÄÃ¬nh TÃ¢m">ğŸ§‘â€âœˆï¸ ÄÃ¬nh TÃ¢m</option>
        <option value="Háº£i ÄÄƒng">ğŸ§‘â€âœˆï¸ Háº£i ÄÄƒng</option>
        <option value="LÃª TÃ¢m">ğŸ§‘â€âœˆï¸ LÃª TÃ¢m</option>
        <option value="Nguyá»…n Tháº£o">ğŸ‘¸ Nguyá»…n Tháº£o</option>
        <option value="Quá»‘c DÅ©ng">ğŸ§‘â€âœˆï¸ Quá»‘c DÅ©ng</option>
        <option value="TÃ¢n Há»“">ğŸ§‘â€âœˆï¸ TÃ¢n Há»“</option>
        <option value="Tráº§n Vinh">ğŸ§‘â€âœˆï¸ Tráº§n Vinh</option>
        <option value="XuÃ¢n Phong">ğŸ§‘â€âœˆï¸ XuÃ¢n Phong</option>
      </select>
      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="trip_type_label">ğŸš— Loáº¡i chuyáº¿n Ä‘i</h3></div>
      <select id="tripType">
        <option value="1" data-lang-key="trip_type_1">1 chiá»u</option>
        <option value="2" data-lang-key="trip_type_2">2 chiá»u (giáº£m 40% chiá»u vá»)</option>
      </select>

      <div id="waitingWrapper"> 
        <div class="label-row" style="margin-top:12px"><h3 data-lang-key="waiting_label">â³ Thá»i gian chá» (giá»)</h3></div>
        <input id="waiting" type="number" min="0" value="0" placeholder="Nháº­p sá»‘ giá» chá»" data-lang-placeholder="waiting_placeholder">
      </div>

      <button class="calc-btn" id="calc-btn" data-lang-key="calculate_button">ğŸ’° TÃ­nh giÃ¡</button>
    </div> <div id="map"></div>

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText" data-lang-key="result_distance">âœï¸ QuÃ£ng Ä‘Æ°á»ng: â€”</div>
      </div>

      <div class="price-title" data-lang-key="result_price_title">ğŸ’µ GiÃ¡ dá»± kiáº¿n</div>
      <div class="price-value" id="priceValue" data-lang-key="result_price_value">â€” Ä‘</div>

      <div class="price-break" id="priceBreak"></div>

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst" data-lang-key="result_time_est">â± Thá»i gian dá»± kiáº¿n: â€” phÃºt</div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo" data-lang-key="result_pickup_info">ğŸ•’ NgÃ y giá» Ä‘Ã³n: â€”</div>
    </div>

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" href="javascript:void(0);" style="display:none;" data-lang-key="zalo_button">ğŸ“± Äáº·t qua Zalo</a>
      <a id="mailBtn" class="mail" href="javascript:void(0);" style="display:none;" data-lang-key="mail_button">ğŸ“§ Äáº·t qua Mail</a>
    </div>

    <div class="note" data-lang-key="note_content">
      ğŸ“Œ Ghi chÃº: GiÃ¡ 4 chá»—/7 chá»—: **10.000Ä‘/km** / **12.000Ä‘/km**. 2 chiá»u: chiá»u vá» giáº£m 40% (Ã¡p dá»¥ng cho chuyáº¿n 1 chiá»u **â‰¥ 45km**).
      <br>
      **Thá»i gian chá»:**
      <ul>
        <li>Chá» 0â€“3 giá»: **Miá»…n phÃ­**.</li>
        <li>Ká»ƒ tá»« giá» thá»© 4, má»—i giá» tiáº¿p theo phÃ¡t sinh phá»¥ phÃ­ **50.000 VNÄ/giá»**.</li>
        <li>Thá»i gian chá» Ä‘Æ°á»£c tÃ­nh tá»« khi hÃ nh khÃ¡ch **hoÃ n táº¥t viá»‡c xuá»‘ng xe táº¡i Ä‘iá»ƒm Ä‘áº¿n** cho Ä‘áº¿n khi xe quay trá»Ÿ láº¡i Ä‘Ã³n Ä‘á»ƒ vá» Ä‘iá»ƒm xuáº¥t phÃ¡t ban Ä‘áº§u.</li>
      </ul>
      GiÃ¡ Ä‘Ã£ bao gá»“m phÃ­ cáº§u Ä‘Æ°á»ng.
    </div>
  </div>
</div>

<div id="depositModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="deposit_modal_title">ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u</h3>
        <p data-lang-key="deposit_modal_text_1">
            **QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:**<br>
            Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i **Hai chiá»u** cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch **Ä‘áº·t cá»c trÆ°á»›c 20%** trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.
        </p>
        <p style="text-align:center; font-size:18px;" data-lang-key="deposit_modal_amount_label">
            Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n: <span id="depositAmount">0 Ä‘</span>
        </p>
        <p data-lang-key="deposit_modal_text_2">
            Khi nhÃ¢n viÃªn **TrÆ°á»ng An Driving** pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i **hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ** (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.
        </p>
        <p style="font-size:14px; color:#555;" data-lang-key="deposit_modal_note">
            **LÆ°u Ã½:** Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i.
            Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.
        </p>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmDepositBtn" style="width:100%;" data-lang-key="deposit_modal_confirm">ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="phone_modal_title">ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i</h3>
        <p style="text-align:center;" data-lang-key="phone_modal_text">QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.</p>
        <input id="inputPhoneForBooking" type="tel" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel" required>
        <div class="modal-actions" style="margin-top:15px;">
            <button id="confirmPhoneBtn" data-lang-key="phone_modal_confirm">XÃ¡c nháº­n</button> 
        </div>
        <button id="closePhoneModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; background:#ccc; color:#333;" data-lang-key="phone_modal_close">ÄÃ³ng</button>
    </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="zalo_modal_title">âœ… THÃ”NG TIN Äáº¶T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;" data-lang-key="zalo_modal_text">Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn" data-lang-key="zalo_modal_copy">ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin</button> 
            <button id="zaloModalBtn" data-lang-key="zalo_modal_open_zalo">ğŸ“± Má»Ÿ Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;" data-lang-key="phone_modal_close">ÄÃ³ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- Cáº¥u hÃ¬nh Tá»‘i Æ¯u HÃ³a ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving";

const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/"; 
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/"; 

const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const driverRequestEl = document.getElementById('driverRequest');
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn');

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 

const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

// New Modal DOM
const phoneModal = document.getElementById('phoneModal');
const inputPhoneForBooking = document.getElementById('inputPhoneForBooking');
const confirmPhoneBtn = document.getElementById('confirmPhoneBtn');
const closePhoneModalBtn = document.getElementById('closePhoneModalBtn');
const depositModal = document.getElementById('depositModal');
const depositAmount = document.getElementById('depositAmount');
const confirmDepositBtn = document.getElementById('confirmDepositBtn');

const langSelect = document.getElementById('language-select');

let finalZaloMessage = ''; 
let finalTotalFee = 0; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;
let bookingAction = null; // 'zalo' or 'mail'

/* ---------- CHá»¨C NÄ‚NG NGÃ”N NGá»® (I18N) ---------- */

const TRANSLATIONS = {
    // VI: TIáº¾NG VIá»†T (Máº·c Ä‘á»‹nh)
    vi: {
        header_title_1: "Dá»‹ch Vá»¥ Taxi",
        header_title_2: "TrÆ°á»ng An Driving",
        instruction_text_loading: "ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...",
        instruction_text_active: "âœ… TÃ­nh toÃ¡n thÃ nh cÃ´ng! Vui lÃ²ng báº¥m Äáº·t qua Zalo/Mail Ä‘á»ƒ hoÃ n táº¥t Ä‘Æ¡n hÃ ng.",
        instruction_text_calculate: "ğŸ’° Báº¥m \"TÃ­nh giÃ¡\" Ä‘á»ƒ xem chi tiáº¿t Ä‘áº·t xe.",
        service_off_notice: "âš ï¸ Dá»‹ch vá»¥ hiá»‡n Ä‘ang Táº M NGá»ªNG nháº­n Ä‘Æ¡n hÃ ng. Vui lÃ²ng thá»­ láº¡i sau.",
        
        // Form Labels & Placeholders
        phone_label: "ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)",
        phone_placeholder: "Nháº­p SÄT (10 sá»‘, VD: 0987654321)",
        pickup_label: "ğŸ“ Äiá»ƒm Ä‘Ã³n",
        pickup_placeholder: "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)",
        time_label: "ğŸ•’ NgÃ y & Giá» Ä‘Ã³n",
        stop_label: "Äiá»ƒm dá»«ng",
        add_stop_button: "ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng",
        dropoff_label: "ğŸ Äiá»ƒm Ä‘áº¿n",
        dropoff_placeholder: "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i",
        car_type_label: "ğŸš˜ Loáº¡i xe",
        car_4_seater: "Xe 4 chá»— (10.000Ä‘/km)",
        car_7_seater: "Xe 7 chá»— (12.000Ä‘/km)",
        driver_request_label: "ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿",
        trip_type_label: "ğŸš— Loáº¡i chuyáº¿n Ä‘i",
        trip_type_1: "1 chiá»u",
        trip_type_2: "2 chiá»u (giáº£m 40% chiá»u vá»)",
        waiting_label: "â³ Thá»i gian chá» (giá»)",
        waiting_placeholder: "Nháº­p sá»‘ giá» chá»",
        calculate_button: "ğŸ’° TÃ­nh giÃ¡",
        
        // Location Status & Map
        location_status_loading: "(Äang tÃ¬m vá»‹ trÃ­...)",
        location_status_success: "âœ… ÄÃ£ tÃ¬m tháº¥y vá»‹ trÃ­",
        location_status_error_general: "âš ï¸ Lá»—i tÃ¬m vá»‹ trÃ­. Nháº­p thá»§ cÃ´ng.",
        reload_location_title: "Thá»­ láº¥y láº¡i vá»‹ trÃ­",
        map_button_pickup: "Báº£n Ä‘á»“",
        map_button_dropoff: "Báº£n Ä‘á»“",

        // Results
        result_distance: "âœï¸ QuÃ£ng Ä‘Æ°á»ng: â€”",
        result_price_title: "ğŸ’µ GiÃ¡ dá»± kiáº¿n",
        result_price_value: "â€” Ä‘",
        result_time_est: "â± Thá»i gian dá»± kiáº¿n: â€” phÃºt",
        result_pickup_info: "ğŸ•’ NgÃ y giá» Ä‘Ã³n: â€”",
        
        // Actions
        zalo_button: "ğŸ“± Äáº·t qua Zalo",
        mail_button: "ğŸ“§ Äáº·t qua Mail",
        
        // Modals
        deposit_modal_title: "ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u",
        deposit_modal_text_1: "**QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:**<br>Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i **Hai chiá»u** cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch **Ä‘áº·t cá»c trÆ°á»›c 20%** trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.",
        deposit_modal_amount_label: "Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n:",
        deposit_modal_text_2: "Khi nhÃ¢n viÃªn **TrÆ°á»ng An Driving** pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i **hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ** (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.",
        deposit_modal_note: "**LÆ°u Ã½:** Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i. Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.",
        deposit_modal_confirm: "ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c",

        phone_modal_title: "ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i",
        phone_modal_text: "QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.",
        phone_modal_confirm: "XÃ¡c nháº­n",
        phone_modal_close: "ÄÃ³ng",
        
        zalo_modal_title: "âœ… THÃ”NG TIN Äáº¶T XE",
        zalo_modal_text: "Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:",
        zalo_modal_copy: "ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin",
        zalo_modal_open_zalo: "ğŸ“± Má»Ÿ Zalo Chat",
        
        // Alerts
        alert_no_pickup: "âŒ Vui lÃ²ng nháº­p Äá»‹a chá»‰ Äiá»ƒm Ä‘Ã³n.",
        alert_no_dropoff: "âŒ Vui lÃ²ng nháº­p Äá»‹a chá»‰ Äiá»ƒm Ä‘áº¿n.",
        alert_two_way_waiting: "âŒ VÃ¬ báº¡n chá»n chuyáº¿n 2 chiá»u, vui lÃ²ng nháº­p Thá»i gian chá» (sá»‘ giá») Ä‘á»ƒ chÃºng tÃ´i sáº¯p xáº¿p xe. GiÃ¡ trá»‹ pháº£i â‰¥ 0.",
        alert_no_coord: "KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ {0}. HÃ£y chá»n gá»£i Ã½ hoáº·c Ä‘áº·t trÃªn báº£n Ä‘á»“.",
        alert_no_price: "âš ï¸ Vui lÃ²ng báº¥m \"TÃ­nh giÃ¡\" trÆ°á»›c Ä‘á»ƒ táº¡o thÃ´ng tin chuyáº¿n Ä‘i.",
        alert_invalid_phone: "âŒ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i há»£p lá»‡ (chÃ­nh xÃ¡c 10 chá»¯ sá»‘).",
        alert_copied: "ğŸ“‹ ÄÃ£ sao chÃ©p thÃ´ng tin chuyáº¿n xe vÃ o bá»™ nhá»› táº¡m! BÃ¢y giá» báº¡n cÃ³ thá»ƒ Má»Ÿ Zalo Chat vÃ  DÃ¡n (Paste) Ä‘á»ƒ gá»­i.",
        alert_copy_fail: "âš ï¸ Sao chÃ©p tá»± Ä‘á»™ng tháº¥t báº¡i. Vui lÃ²ng báº¥m giá»¯ (hoáº·c Ctrl+C) Ä‘á»ƒ sao chÃ©p vÄƒn báº£n Ä‘Ã£ Ä‘Æ°á»£c bÃ´i Ä‘en vÃ  gá»­i qua Zalo.",
        alert_service_off: "âš ï¸ Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving hiá»‡n Ä‘ang táº¡m ngá»«ng nháº­n Ä‘Æ¡n hÃ ng. Vui lÃ²ng kiá»ƒm tra thÃ´ng bÃ¡o trÃªn mÃ n hÃ¬nh.",
        alert_mail_sent: "âœ… Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin mail Ä‘Ã£ Ä‘Æ°á»£c Ä‘iá»n tá»± Ä‘á»™ng vÃ  báº¥m \"Gá»­i\"",
        
        // Note
        note_content: "ğŸ“Œ Ghi chÃº: GiÃ¡ 4 chá»—/7 chá»—: **10.000Ä‘/km** / **12.000Ä‘/km**. 2 chiá»u: chiá»u vá» giáº£m 40% (Ã¡p dá»¥ng cho chuyáº¿n 1 chiá»u **â‰¥ 45km**).<br>**Thá»i gian chá»:**<ul><li>Chá» 0â€“3 giá»: **Miá»…n phÃ­**.</li><li>Ká»ƒ tá»« giá» thá»© 4, má»—i giá» tiáº¿p theo phÃ¡t sinh phá»¥ phÃ­ **50.000 VNÄ/giá»**.</li><li>Thá»i gian chá» Ä‘Æ°á»£c tÃ­nh tá»« khi hÃ nh khÃ¡ch **hoÃ n táº¥t viá»‡c xuá»‘ng xe táº¡i Ä‘iá»ƒm Ä‘áº¿n** cho Ä‘áº¿n khi xe quay trá»Ÿ láº¡i Ä‘Ã³n Ä‘á»ƒ vá» Ä‘iá»ƒm xuáº¥t phÃ¡t ban Ä‘áº§u.</li></ul>GiÃ¡ Ä‘Ã£ bao gá»“m phÃ­ cáº§u Ä‘Æ°á»ng."
    },

    // EN: TIáº¾NG ANH
    en: {
        header_title_1: "Taxi Service",
        header_title_2: "Truong An Driving",
        instruction_text_loading: "ğŸ’° Checking service status...",
        instruction_text_active: "âœ… Calculation successful! Please click 'Book via Zalo/Mail' to complete the order.",
        instruction_text_calculate: "ğŸ’° Click \"Calculate Price\" for booking details.",
        service_off_notice: "âš ï¸ The service is currently SUSPENDED from receiving orders. Please try again later.",
        
        // Form Labels & Placeholders
        phone_label: "ğŸ“ Your Phone Number (Not required for Price Calculation)",
        phone_placeholder: "Enter Phone No. (10 digits, e.g., 0987654321)",
        pickup_label: "ğŸ“ Pickup Point",
        pickup_placeholder: "Enter pickup address (or auto-locate)",
        time_label: "ğŸ•’ Pickup Date & Time",
        stop_label: "Stopover Point",
        add_stop_button: "ï¼‹ Add Stopover",
        dropoff_label: "ğŸ Dropoff Point",
        dropoff_placeholder: "Enter final dropoff address",
        car_type_label: "ğŸš˜ Vehicle Type",
        car_4_seater: "4-seater Car (10,000VND/km)",
        car_7_seater: "7-seater Car (12,000VND/km)",
        driver_request_label: "ğŸ§‘â€âœˆï¸ Driver Request",
        trip_type_label: "ğŸš— Trip Type",
        trip_type_1: "One-way",
        trip_type_2: "Two-way (40% discount on return trip)",
        waiting_label: "â³ Waiting Time (hours)",
        waiting_placeholder: "Enter waiting time in hours",
        calculate_button: "ğŸ’° Calculate Price",
        
        // Location Status & Map
        location_status_loading: "(Finding location...)",
        location_status_success: "âœ… Location found",
        location_status_error_general: "âš ï¸ Location error. Please enter manually.",
        reload_location_title: "Try to retrieve location",
        map_button_pickup: "Map",
        map_button_dropoff: "Map",

        // Results
        result_distance: "âœï¸ Distance: â€”",
        result_price_title: "ğŸ’µ Estimated Price",
        result_price_value: "â€” VND",
        result_time_est: "â± Estimated Time: â€” minutes",
        result_pickup_info: "ğŸ•’ Pickup Date & Time: â€”",
        
        // Actions
        zalo_button: "ğŸ“± Book via Zalo",
        mail_button: "ğŸ“§ Book via Mail",
        
        // Modals
        deposit_modal_title: "ğŸ“ Two-Way Trip Deposit Request",
        deposit_modal_text_1: "**Please Note:**<br>To confirm and ensure service quality for your **Two-way** trip, we kindly request a **20% advance deposit** of the total estimated fare.",
        deposit_modal_amount_label: "Estimated Deposit Amount:",
        deposit_modal_text_2: "When a **Truong An Driving** staff member responds via Zalo, we will send **specific payment instructions** (bank transfer) to finalize the deposit process.",
        deposit_modal_note: "**Note:** The remaining fare will be paid directly to the driver after the trip ends. Thank you for trusting our service.",
        deposit_modal_confirm: "Understood and Proceed",

        phone_modal_title: "ğŸ“ Please Enter Phone Number",
        phone_modal_text: "Please enter your phone number so we can contact you to confirm the booking.",
        phone_modal_confirm: "Confirm",
        phone_modal_close: "Close",
        
        zalo_modal_title: "âœ… BOOKING INFORMATION",
        zalo_modal_text: "Copy the information and send via Zalo:",
        zalo_modal_copy: "ğŸ“‹ Copy Information",
        zalo_modal_open_zalo: "ğŸ“± Open Zalo Chat",

        // Alerts
        alert_no_pickup: "âŒ Please enter the Pickup Point address.",
        alert_no_dropoff: "âŒ Please enter the Dropoff Point address.",
        alert_two_way_waiting: "âŒ Since you selected a two-way trip, please enter the Waiting Time (in hours) so we can arrange the vehicle. The value must be â‰¥ 0.",
        alert_no_coord: "Coordinates not found for {0}. Please select a suggestion or place on the map.",
        alert_no_price: "âš ï¸ Please click \"Calculate Price\" first to generate trip information.",
        alert_invalid_phone: "âŒ Please enter a valid 10-digit phone number.",
        alert_copied: "ğŸ“‹ Trip information copied to clipboard! You can now Open Zalo Chat and Paste to send.",
        alert_copy_fail: "âš ï¸ Automatic copy failed. Please hold (or Ctrl+C) to copy the highlighted text and send via Zalo.",
        alert_service_off: "âš ï¸ Truong An Driving Taxi service is temporarily not accepting orders. Please check the on-screen notification.",
        alert_mail_sent: "âœ… Please check the pre-filled email information and click \"Send\"",
        
        // Note
        note_content: "ğŸ“Œ Note: 4-seater/7-seater price: **10,000VND/km** / **12,000VND/km**. 2-way: return trip discount 40% (applies to one-way trip **â‰¥ 45km**).<br>**Waiting Time:**<ul><li>Waiting 0â€“3 hours: **Free**.</li><li>From the 4th hour onwards, each subsequent hour incurs a surcharge of **50,000 VND/hour**.</li><li>Waiting time is calculated from the moment the passenger **completes disembarking at the destination** until the vehicle returns to pick up for the initial departure point.</li></ul>Price includes toll fees."
    },
    
    // ZH: TIáº¾NG TRUNG
    zh: {
        header_title_1: "å‡ºç§Ÿè½¦æœåŠ¡",
        header_title_2: "é•·å®‰é§•é§›",
        instruction_text_loading: "ğŸ’° æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...",
        instruction_text_active: "âœ… è®¡ç®—æˆåŠŸ! è¯·ç‚¹å‡»â€œé€šè¿‡ Zalo/é‚®ä»¶é¢„è®¢â€å®Œæˆè®¢å•ã€‚",
        instruction_text_calculate: "ğŸ’° ç‚¹å‡»â€œè®¡ç®—ä»·æ ¼â€æŸ¥çœ‹é¢„è®¢è¯¦æƒ…ã€‚",
        service_off_notice: "âš ï¸ æœåŠ¡ç›®å‰æš‚åœæ¥å•ã€‚è¯·ç¨åå†è¯•ã€‚",
        
        // Form Labels & Placeholders
        phone_label: "ğŸ“ æ‚¨çš„ç”µè¯å·ç  (è®¡ç®—ä»·æ ¼éå¿…éœ€)",
        phone_placeholder: "è¾“å…¥ç”µè¯å·ç  (10ä½ï¼Œä¾‹å¦‚: 0987654321)",
        pickup_label: "ğŸ“ ä¸Šè½¦ç‚¹",
        pickup_placeholder: "è¾“å…¥ä¸Šè½¦åœ°å€ (æˆ–è‡ªåŠ¨å®šä½)",
        time_label: "ğŸ•’ ä¸Šè½¦æ—¥æœŸå’Œæ—¶é—´",
        stop_label: "ä¸­é€”åœç•™ç‚¹",
        add_stop_button: "ï¼‹ æ·»åŠ ä¸­é€”åœç•™ç‚¹",
        dropoff_label: "ğŸ ä¸‹è½¦ç‚¹",
        dropoff_placeholder: "è¾“å…¥æœ€ç»ˆä¸‹è½¦åœ°å€",
        car_type_label: "ğŸš˜ è½¦è¾†ç±»å‹",
        car_4_seater: "4åº§è½¦ (10,000ç›¾/å…¬é‡Œ)",
        car_7_seater: "7åº§è½¦ (12,000ç›¾/å…¬é‡Œ)",
        driver_request_label: "ğŸ§‘â€âœˆï¸ å¸æœºè¦æ±‚",
        trip_type_label: "ğŸš— è¡Œç¨‹ç±»å‹",
        trip_type_1: "å•ç¨‹",
        trip_type_2: "åŒç¨‹ (è¿”ç¨‹äº«6æŠ˜)",
        waiting_label: "â³ ç­‰å¾…æ—¶é—´ (å°æ—¶)",
        waiting_placeholder: "è¾“å…¥ç­‰å¾…æ—¶é—´ (å°æ—¶)",
        calculate_button: "ğŸ’° è®¡ç®—ä»·æ ¼",
        
        // Location Status & Map
        location_status_loading: "(æ­£åœ¨å¯»æ‰¾ä½ç½®...)",
        location_status_success: "âœ… å·²æ‰¾åˆ°ä½ç½®",
        location_status_error_general: "âš ï¸ ä½ç½®é”™è¯¯ã€‚è¯·æ‰‹åŠ¨è¾“å…¥ã€‚",
        reload_location_title: "å°è¯•é‡æ–°è·å–ä½ç½®",
        map_button_pickup: "åœ°å›¾",
        map_button_dropoff: "åœ°å›¾",

        // Results
        result_distance: "âœï¸ è·ç¦»: â€”",
        result_price_title: "ğŸ’µ é¢„è®¡ä»·æ ¼",
        result_price_value: "â€” ç›¾",
        result_time_est: "â± é¢„è®¡æ—¶é—´: â€” åˆ†é’Ÿ",
        result_pickup_info: "ğŸ•’ ä¸Šè½¦æ—¥æœŸå’Œæ—¶é—´: â€”",
        
        // Actions
        zalo_button: "ğŸ“± é€šè¿‡ Zalo é¢„è®¢",
        mail_button: "ğŸ“§ é€šè¿‡é‚®ä»¶é¢„è®¢",
        
        // Modals
        deposit_modal_title: "ğŸ“ åŒç¨‹è¡Œç¨‹æŠ¼é‡‘è¯·æ±‚",
        deposit_modal_text_1: "**è¯·æ³¨æ„ï¼š**<br>ä¸ºäº†ç¡®è®¤å’Œç¡®ä¿æ‚¨**åŒç¨‹**è¡Œç¨‹çš„æœåŠ¡è´¨é‡ï¼Œæˆ‘ä»¬æ³è¯·æ‚¨**é¢„ä»˜**æ€»ä¼°ç®—ç¥¨ä»·çš„ **20%** ä½œä¸ºæŠ¼é‡‘ã€‚",
        deposit_modal_amount_label: "é¢„è®¡æŠ¼é‡‘é‡‘é¢:",
        deposit_modal_text_2: "å½“**é•¿é€”é©¾é©¶**çš„å·¥ä½œäººå‘˜é€šè¿‡ Zalo å›å¤æ—¶ï¼Œæˆ‘ä»¬å°†å‘é€**å…·ä½“çš„ä»˜æ¬¾è¯´æ˜**ï¼ˆé“¶è¡Œè½¬è´¦ï¼‰ä»¥å®ŒæˆæŠ¼é‡‘æ‰‹ç»­ã€‚",
        deposit_modal_note: "**æ³¨æ„ï¼š** å‰©ä½™çš„è½¦è´¹å°†åœ¨è¡Œç¨‹ç»“æŸåç›´æ¥æ”¯ä»˜ç»™å¸æœºã€‚æ„Ÿè°¢æ‚¨ä¿¡ä»»æˆ‘ä»¬çš„æœåŠ¡ã€‚",
        deposit_modal_confirm: "å·²çŸ¥æ™“å¹¶ç»§ç»­",

        phone_modal_title: "ğŸ“ è¯·è¾“å…¥ç”µè¯å·ç ",
        phone_modal_text: "è¯·è¾“å…¥æ‚¨çš„ç”µè¯å·ç ï¼Œä»¥ä¾¿æˆ‘ä»¬è”ç³»æ‚¨ç¡®è®¤è®¢å•ã€‚",
        phone_modal_confirm: "ç¡®è®¤",
        phone_modal_close: "å…³é—­",
        
        zalo_modal_title: "âœ… é¢„è®¢ä¿¡æ¯",
        zalo_modal_text: "å¤åˆ¶ä¿¡æ¯å¹¶é€šè¿‡ Zalo å‘é€:",
        zalo_modal_copy: "ğŸ“‹ å¤åˆ¶ä¿¡æ¯",
        zalo_modal_open_zalo: "ğŸ“± æ‰“å¼€ Zalo èŠå¤©",

        // Alerts
        alert_no_pickup: "âŒ è¯·è¾“å…¥ä¸Šè½¦ç‚¹åœ°å€ã€‚",
        alert_no_dropoff: "âŒ è¯·è¾“å…¥ä¸‹è½¦ç‚¹åœ°å€ã€‚",
        alert_two_way_waiting: "âŒ ç”±äºæ‚¨é€‰æ‹©äº†åŒç¨‹ï¼Œè¯·è¾“å…¥ç­‰å¾…æ—¶é—´ (å°æ—¶)ï¼Œä»¥ä¾¿æˆ‘ä»¬å®‰æ’è½¦è¾†ã€‚å€¼å¿…é¡» â‰¥ 0ã€‚",
        alert_no_coord: "æ‰¾ä¸åˆ° {0} çš„åæ ‡ã€‚è¯·é€‰æ‹©å»ºè®®æˆ–åœ¨åœ°å›¾ä¸Šæ”¾ç½®ã€‚",
        alert_no_price: "âš ï¸ è¯·å…ˆç‚¹å‡»â€œè®¡ç®—ä»·æ ¼â€ä»¥ç”Ÿæˆè¡Œç¨‹ä¿¡æ¯ã€‚",
        alert_invalid_phone: "âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„10ä½ç”µè¯å·ç ã€‚",
        alert_copied: "ğŸ“‹ è¡Œç¨‹ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼æ‚¨ç°åœ¨å¯ä»¥æ‰“å¼€ Zalo èŠå¤©å¹¶ç²˜è´´å‘é€ã€‚",
        alert_copy_fail: "âš ï¸ è‡ªåŠ¨å¤åˆ¶å¤±è´¥ã€‚è¯·é•¿æŒ‰ (æˆ– Ctrl+C) å¤åˆ¶é«˜äº®æ–‡æœ¬å¹¶é€šè¿‡ Zalo å‘é€ã€‚",
        alert_service_off: "âš ï¸ é•·å®‰é§•é§›å‡ºç§Ÿè½¦æœåŠ¡æš‚æ—¶ä¸æ¥å—è®¢å•ã€‚è¯·æŸ¥çœ‹å±å¹•ä¸Šçš„é€šçŸ¥ã€‚",
        alert_mail_sent: "âœ… è¯·æ£€æŸ¥å·²é¢„å¡«çš„ç”µå­é‚®ä»¶ä¿¡æ¯å¹¶ç‚¹å‡»â€œå‘é€â€",
        
        // Note
        note_content: "ğŸ“Œ æ³¨æ„: 4åº§/7åº§ä»·æ ¼: **10,000ç›¾/å…¬é‡Œ** / **12,000ç›¾/å…¬é‡Œ**ã€‚åŒç¨‹: è¿”ç¨‹ä¼˜æƒ 40% (é€‚ç”¨äºå•ç¨‹ **â‰¥ 45å…¬é‡Œ** çš„è¡Œç¨‹)ã€‚<br>**ç­‰å¾…æ—¶é—´:**<ul><li>ç­‰å¾… 0â€“3 å°æ—¶: **å…è´¹**ã€‚</li><li>ä»ç¬¬4å°æ—¶èµ·ï¼Œæ¯å°æ—¶åŠ æ”¶ **50,000 è¶Šå—ç›¾/å°æ—¶**ã€‚</li><li>ç­‰å¾…æ—¶é—´ä»ä¹˜å®¢**åœ¨ç›®çš„åœ°å®Œæˆä¸‹è½¦**æ—¶å¼€å§‹è®¡ç®—ï¼Œç›´åˆ°è½¦è¾†è¿”å›æ¥ä¹˜å®¢å›åˆ°æœ€åˆå‡ºå‘ç‚¹ã€‚</li></ul>ä»·æ ¼å·²å«è¿‡è·¯è´¹ã€‚"
    }
};

let currentLang = 'vi';

function translateElement(el, lang) {
    const key = el.dataset.langKey;
    const placeholderKey = el.dataset.langPlaceholder;
    const titleKey = el.dataset.langTitle;
    const translation = TRANSLATIONS[lang] || TRANSLATIONS['vi']; // Fallback to 'vi'

    if (key && translation[key]) {
        el.innerHTML = translation[key];
    }
    if (placeholderKey && translation[placeholderKey]) {
        el.placeholder = translation[placeholderKey];
    }
    if (titleKey && translation[titleKey]) {
        el.title = translation[titleKey];
    }
}

function updateAllText(lang) {
    // 1. Dá»‹ch TiÃªu Ä‘á» (Headers)
    const headerTitle1 = document.querySelector('header').childNodes[1]; // Dá»‹ch Vá»¥ Taxi
    const headerTitle2 = document.querySelector('header').childNodes[3]; // TrÆ°á»ng An Driving
    if(headerTitle1 && headerTitle1.nodeType === 3) {
      headerTitle1.textContent = 'ğŸš– ' + (TRANSLATIONS[lang].header_title_1 || 'Dá»‹ch Vá»¥ Taxi');
    }
    if(headerTitle2 && headerTitle2.nodeType === 3) {
        headerTitle2.textContent = (TRANSLATIONS[lang].header_title_2 || 'TrÆ°á»ng An Driving');
    }

    // 2. Dá»‹ch cÃ¡c pháº§n tá»­ dÃ¹ng data-lang-key
    document.querySelectorAll('[data-lang-key], [data-lang-placeholder], [data-lang-title]').forEach(el => {
        translateElement(el, lang);
    });

    // 3. Dá»‹ch cÃ¡c pháº§n tá»­ cÃ³ cáº¥u trÃºc Ä‘áº·c biá»‡t (vÃ­ dá»¥: Options)
    // Cáº­p nháº­t Options Loáº¡i xe
    document.querySelector('#carType option[value^="4 chá»—"]').textContent = TRANSLATIONS[lang].car_4_seater;
    document.querySelector('#carType option[value^="7 chá»—"]').textContent = TRANSLATIONS[lang].car_7_seater;
    
    // Cáº­p nháº­t Options Loáº¡i chuyáº¿n
    document.querySelector('#tripType option[value="1"]').textContent = TRANSLATIONS[lang].trip_type_1;
    document.querySelector('#tripType option[value="2"]').textContent = TRANSLATIONS[lang].trip_type_2;
    
    // Cáº­p nháº­t Ghi chÃº
    document.querySelector('.note').innerHTML = TRANSLATIONS[lang].note_content;
    
    // Cáº­p nháº­t InstructionText (tráº¡ng thÃ¡i hoáº¡t Ä‘á»™ng)
    if (isServiceActive) {
        instructionText.innerHTML = TRANSLATIONS[lang].instruction_text_calculate;
    } else {
        serviceOffNotice.innerHTML = TRANSLATIONS[lang].service_off_notice;
    }
    
    // Cáº­p nháº­t cÃ¡c tráº¡ng thÃ¡i khÃ¡c (vÃ­ dá»¥: location status)
    const locStatus = locationStatusEl.dataset.currentStatus || 'loading';
    if (locStatus === 'success') {
        locationStatusEl.textContent = TRANSLATIONS[lang].location_status_success;
    } else if (locStatus === 'error') {
         locationStatusEl.textContent = TRANSLATIONS[lang].location_status_error_general;
    } else {
         locationStatusEl.textContent = TRANSLATIONS[lang].location_status_loading;
    }
}

function initLanguageSwitcher() {
    // Láº¥y ngÃ´n ngá»¯ tá»« localStorage náº¿u cÃ³, náº¿u khÃ´ng thÃ¬ dÃ¹ng máº·c Ä‘á»‹nh 'vi'
    currentLang = localStorage.getItem('appLang') || 'vi'; 
    langSelect.value = currentLang;

    // Dá»‹ch trang láº§n Ä‘áº§u tiÃªn
    updateAllText(currentLang);
    document.documentElement.setAttribute('lang', currentLang);
    
    // Láº¯ng nghe sá»± kiá»‡n thay Ä‘á»•i
    langSelect.addEventListener('change', (e) => {
        currentLang = e.target.value;
        localStorage.setItem('appLang', currentLang);
        updateAllText(currentLang);
        document.documentElement.setAttribute('lang', currentLang);
    });
}


/* ---------- TÃN HIá»†U KILL SWITCH (Polling) ---------- */

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`; 
    const finalUrl = REMOTE_STATUS_URL + cacheBuster;

    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
        
        if (!response.ok) {
            return { 
                active: false, 
                message_vn: "âš ï¸ Cáº¢NH BÃO Máº NG: KhÃ´ng tÃ¬m tháº¥y file tráº¡ng thÃ¡i dá»‹ch vá»¥ (404/Server Error). Chá»©c nÄƒng Ä‘áº·t xe bá»‹ táº¡m ngÆ°ng." 
            };
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        let msg = "âš ï¸ Thiáº¿t bá»‹ Ä‘ang OFFLINE hoáº·c Lá»–I Káº¾T Ná»I. KhÃ´ng thá»ƒ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng."
        if (error.name === 'TimeoutError') {
             msg = "âš ï¸ Kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥ quÃ¡ lÃ¢u. Viá»‡c Ä‘áº·t xe bá»‹ táº¡m ngá»«ng."
        }
        console.error("Lá»—i khi fetch tráº¡ng thÃ¡i dá»‹ch vá»¥:", error);
        return { 
            active: false, 
            message_vn: msg
        };
    }
}


async function updateUIBasedOnStatus(status) {
    const lang = currentLang; 
    const translation = TRANSLATIONS[lang];

    if (status.active !== isServiceActive) {
        isServiceActive = status.active;
    }
    
    instructionText.style.display = 'block'; 

    if (!isServiceActive) {
        // Táº®T Dá»ŠCH Vá»¤
        calcBtn.style.background = '#ccc';
        calcBtn.style.cursor = 'not-allowed';
        calcBtn.disabled = true;
        
        serviceOffNotice.style.display = 'block';
        
        // Sá»­ dá»¥ng tin nháº¯n tá»« JSON náº¿u cÃ³, náº¿u khÃ´ng dÃ¹ng tin nháº¯n máº·c Ä‘á»‹nh Ä‘Ã£ dá»‹ch
        let serviceOffMsg = status[`message_${lang}`] || status.message_vn || translation.service_off_notice;
        serviceOffNotice.innerHTML = serviceOffMsg;
        
        // VÃ´ hiá»‡u hÃ³a form
        bookingFormWrapper.classList.add('disabled-form');
        
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';
        
    } else {
        // Má» Dá»ŠCH Vá»¤
        calcBtn.style.background = 'var(--green)';
        calcBtn.style.cursor = 'pointer';
        calcBtn.disabled = false;
        
        serviceOffNotice.style.display = 'none';
        
        // KÃ­ch hoáº¡t form
        bookingFormWrapper.classList.remove('disabled-form');
        
        instructionText.innerHTML = status[`message_${lang}`] || status.message_vn || translation.instruction_text_calculate;
    }
    
    updateAllText(currentLang); 
}

/* ---------- CÃ¡c hÃ m JS khÃ¡c (InitMap, Geolocation, Autocomplete...) ---------- */
function initMap(center) {
    if (!map) {
        map = L.map('map').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        map.on('click', handleMapClick);
        map.on('dblclick', handleMapDblClick);
    } else {
        map.setView(center, 11);
    }
}

async function reverseGeocode(lat, lon) {
    try {
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=${currentLang}`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        console.warn('Reverse Geocoding Error', e);
        return `${lat.toFixed(6)}, ${lon.toFixed(6)} (${TRANSLATIONS[currentLang].location_status_error_general})`;
    }
}

function getGeolocation() {
    locationStatusEl.dataset.currentStatus = 'loading';
    locationStatusEl.textContent = TRANSLATIONS[currentLang].location_status_loading;
    locationStatusEl.style.color = 'var(--muted)';
    reloadLocationBtn.style.color = '#ccc'; 
    reloadLocationBtn.style.pointerEvents = 'none';

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            userLocation = [pos.coords.latitude, pos.coords.longitude]; 
            initMap(userLocation); 
            
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';

            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup('ğŸ“ ' + TRANSLATIONS[currentLang].pickup_label).openPopup();

            locationStatusEl.dataset.currentStatus = 'success';
            locationStatusEl.textContent = TRANSLATIONS[currentLang].location_status_success;
            locationStatusEl.style.color = 'var(--green)';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, (err)=>{
            console.warn('Geolocation Error:', err.message);
            initMap(DEFAULT_CENTER); 
            
            let statusText = TRANSLATIONS[currentLang].location_status_error_general;
            
            locationStatusEl.dataset.currentStatus = 'error';
            locationStatusEl.textContent = statusText;
            locationStatusEl.style.color = '#dc3545';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
    } else {
        initMap(DEFAULT_CENTER); 
        locationStatusEl.dataset.currentStatus = 'error';
        locationStatusEl.textContent = TRANSLATIONS[currentLang].location_status_error_general;
        locationStatusEl.style.color = '#dc3545';
        reloadLocationBtn.style.color = '#ccc';
        reloadLocationBtn.style.pointerEvents = 'none';
    }
}

function debounce(func, timeout = DEBOUNCE_TIME) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

function toggleWaitingInput(){
    if(tripTypeEl.value === '1'){
        waitingWrapper.style.display = 'none';
    } else {
        waitingWrapper.style.display = 'block';
    }
}

tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput();

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
            inputEl.value = '';
            delete inputEl.dataset.lat;
            delete inputEl.dataset.lon;
            if (inputId === 'pickup' && pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            } else if (inputId === 'dropoff' && dropoffMarker) {
                map.removeLayer(dropoffMarker);
                dropoffMarker = null;
            }
            const suggBox = document.getElementById(`${inputId}-suggestions`);
            if (suggBox) suggBox.style.display = 'none';
            inputEl.focus(); 
        }
    });
});
document.querySelectorAll('input[type="text"]').forEach(inputEl => {
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if (clearBtn) {
        inputEl.addEventListener('input', () => {
            clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        inputEl.addEventListener('focus', () => {
             clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        inputEl.addEventListener('blur', () => {
             setTimeout(() => clearBtn.style.display = 'none', 150); 
        });
    }
});


async function geocodeOnce(query){
  try{
    let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1&accept-language=${currentLang}`;
    
    if(userLocation) { 
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.5},${lat - 0.5},${lon + 0.5},${lat + 0.5}`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }

    const r = await fetch(url);
    const data = await r.json();
    if(Array.isArray(data) && data.length>0) return data[0];
  }catch(e){ console.warn('geocode once error', e); }
  return null;
}

function attachAutocomplete(inputEl, boxEl){
  let controller = null;

  const doSearch = async ()=>{
    const q = inputEl.value.trim();
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    
    if(!q){ 
        boxEl.style.display = 'none'; 
        if(clearBtn) clearBtn.style.display = 'none';
        return; 
    }
    if(clearBtn) clearBtn.style.display = 'block';

    if(controller) controller.abort();
    controller = new AbortController();
    
    boxEl.innerHTML = `<div>${TRANSLATIONS[currentLang].location_status_loading.replace('(','').replace(')','')}</div>`; 
    boxEl.style.display = 'block'; 

    let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=${currentLang}`; 
    
    if(userLocation) {
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.3},${lat - 0.3},${lon + 0.3},${lat + 0.3}`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }


    try{
      const res = await fetch(url, { signal: controller.signal });
      const data = await res.json();
      
      const fragment = document.createDocumentFragment();
      
      if(!Array.isArray(data) || data.length === 0){ 
        boxEl.innerHTML = `<div>${TRANSLATIONS[currentLang].alert_no_coord.replace('{0}', '')}</div>`; 
        setTimeout(() => boxEl.style.display = 'none', 1000); 
        return; 
      }

      data.forEach(place => {
        const d = document.createElement('div');
        d.innerHTML = `<span style="font-size:16px">ğŸ“</span><div style="margin-left:8px">${place.display_name}</div>`;
        d.addEventListener('click', ()=>{
          inputEl.value = place.display_name;
          inputEl.dataset.lat = place.lat;
          inputEl.dataset.lon = place.lon;
          boxEl.style.display = 'none';
          if(clearBtn) clearBtn.style.display = 'block';

          const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
          if(map) {
            if(inputEl.id === 'pickup'){
              if(pickupMarker) map.removeLayer(pickupMarker);
              pickupMarker = L.marker(latlng).addTo(map).bindPopup('ğŸ“ ' + TRANSLATIONS[currentLang].pickup_label).openPopup();
              map.setView(latlng, 14);
            } else if(inputEl.id === 'dropoff'){
              if(dropoffMarker) map.removeLayer(dropoffMarker);
              dropoffMarker = L.marker(latlng).addTo(map).bindPopup('ğŸ ' + TRANSLATIONS[currentLang].dropoff_label).openPopup();
              map.setView(latlng, 14);
            } 
          }
        });
        fragment.appendChild(d);
      });
      
      boxEl.innerHTML = '';
      boxEl.appendChild(fragment);
      boxEl.style.display = 'block';
      
    }catch(err){
      if(err.name === 'AbortError') return; 
      console.error('suggest error', err);
      boxEl.innerHTML = '<div>Lá»—i máº¡ng hoáº·c API. Thá»­ láº¡i</div>'; 
      setTimeout(() => boxEl.style.display = 'none', 2000); 
    }
  }; 

  inputEl.addEventListener('input', debounce(doSearch));

  document.addEventListener('click', (ev)=>{
    if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; 
  });

  inputEl.addEventListener('focus', ()=> {
    const inputId = inputEl.id; 
    if(inputId && inputId.startsWith('stop-')) lastFocusedStopId = inputId;
    else lastFocusedStopId = null;
    
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
  });
}

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

function createStopInput(prefill=''){
  stopCount++;
  const wrapper = document.createElement('div');
  wrapper.className = 'way-wrapper input-row';
  const inputId = `stop-${stopCount}`;
  const suggId = `${inputId}-suggestions`;
  wrapper.innerHTML = `
    <input type="text" id="${inputId}" placeholder="${TRANSLATIONS[currentLang].stop_label} ${stopCount}">
    <button class="clear-btn" data-input-id="${inputId}">âœ–</button> 
    <button class="way-remove" title="${TRANSLATIONS[currentLang].way_remove_title || 'XÃ³a'}">âœ–</button>
    <div id="${suggId}" class="suggestions" style="display:none"></div>
  `;
  stopsContainer.appendChild(wrapper);

  const inputEl = wrapper.querySelector('input');
  const boxEl = wrapper.querySelector('.suggestions');
  attachAutocomplete(inputEl, boxEl);
  
  const clearBtn = wrapper.querySelector('.clear-btn');
  inputEl.addEventListener('input', () => { clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; });
  inputEl.addEventListener('focus', () => { clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; });
  inputEl.addEventListener('blur', () => { setTimeout(() => clearBtn.style.display = 'none', 150); });
  clearBtn.addEventListener('click', (e) => {
    e.stopPropagation(); 
    inputEl.value = ''; 
    delete inputEl.dataset.lat;
    delete inputEl.dataset.lon;
    boxEl.style.display = 'none';
    inputEl.focus();
  });


  wrapper.querySelector('.way-remove').addEventListener('click', ()=> wrapper.remove());

  inputEl.addEventListener('focus', ()=> lastFocusedStopId = inputId);

  return inputEl;
}

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput());

document.getElementById('pick-from-map').addEventListener('click', ()=> { selecting = 'pickup'; alert(TRANSLATIONS[currentLang].alert_map_pickup || 'Báº¥m vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n Ä‘iá»ƒm Ä‘Ã³n'); });
document.getElementById('pick-to-map').addEventListener('click', ()=> { selecting = 'dropoff'; alert(TRANSLATIONS[currentLang].alert_map_dropoff || 'Báº¥m vÃ o báº£n Ä‘á»“ Ä‘á»ƒ chá»n Ä‘iá»ƒm Ä‘áº¿n'); });

const handleMapClick = async (e) => {
  if (!map) return; 
  const lat = e.latlng.lat, lon = e.latlng.lng;
  
  let targetInput, markerPopupText;

  if(selecting === 'pickup'){
    targetInput = pickupEl;
    markerPopupText = 'ğŸ“ ' + TRANSLATIONS[currentLang].pickup_label;
    if(pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([lat,lon]).addTo(map).bindPopup(markerPopupText).openPopup();
    selecting = null;
  } else if(selecting === 'dropoff'){
    targetInput = dropoffEl;
    markerPopupText = 'ğŸ ' + TRANSLATIONS[currentLang].dropoff_label;
    if(dropoffMarker) map.removeLayer(dropoffMarker);
    dropoffMarker = L.marker([lat,lon]).addTo(map).bindPopup(markerPopupText).openPopup();
    selecting = null;
  } else if(lastFocusedStopId){
    targetInput = document.getElementById(lastFocusedStopId);
    if(targetInput){
      markerPopupText = 'ğŸ“ ' + TRANSLATIONS[currentLang].stop_label;
      L.marker([lat,lon]).addTo(map).bindPopup(markerPopupText).openPopup();
      lastFocusedStopId = null;
    }
  }

  if(targetInput){
    const address = await reverseGeocode(lat, lon);
    targetInput.value = address;
    
    targetInput.dataset.lat = lat; targetInput.dataset.lon = lon;
    targetInput.parentNode.querySelector('.clear-btn').style.display = 'block';
    
    if(pickupMarker || dropoffMarker) map.setView([lat,lon], 14);
  }
};


const handleMapDblClick = (e) => {
  if (!map) return; 
  if(lastFocusedStopId){
    const stopInput = document.getElementById(lastFocusedStopId);
    if(stopInput){
      stopInput.value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      stopInput.dataset.lat = e.latlng.lat; stopInput.dataset.lon = e.latlng.lng;
      L.marker([e.latlng.lat,e.latlng.lng]).addTo(map).bindPopup('ğŸ“ ' + TRANSLATIONS[currentLang].stop_label).openPopup();
      lastFocusedStopId = null;
    }
  }
};


async function resolveCoordForInput(inputEl){
  if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon){
    return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
  }
  const v = inputEl.value.trim();
  if(!v) return null;
  const parts = v.split(',');
  if(parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))){
    // Giáº£ Ä‘á»‹nh nháº­p Lat, Lon náº¿u cÃ³ 2 sá»‘
    return [parseFloat(parts[0]), parseFloat(parts[1])]; 
  }
  const place = await geocodeOnce(v + ' Viá»‡t Nam');
  if(place){
    inputEl.dataset.lat = place.lat;
    inputEl.dataset.lon = place.lon;
    return [parseFloat(place.lat), parseFloat(place.lon)];
  }
  return null;
}

function validateRouteInputs() {
    const lang = currentLang;
    const t = TRANSLATIONS[lang];
    
    if (pickupEl.value.trim() === '') {
        alert(t.alert_no_pickup);
        pickupEl.focus();
        return false;
    }
    if (dropoffEl.value.trim() === '') {
        alert(t.alert_no_dropoff);
        dropoffEl.focus();
        return false;
    }
    const tripType = tripTypeEl.value; 
    const waiting = parseFloat(waitingEl.value); 
    if (tripType === '2') {
        if (isNaN(waiting) || waiting < 0) {
            alert(t.alert_two_way_waiting);
            waitingEl.focus();
            return false;
        }
    }
    return true;
}

function validatePhone(phone) {
    const phoneRegex = /^\d{10}$/; 
    return phoneRegex.test(phone);
}

function setMinPickupDateTime() {
    const now = new Date();
    const minTime = new Date(now.getTime() + 30 * 60000); 

    const formatDateTime = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${y}-${m}-${d}T${h}:${min}`;
    };

    const minDateTimeString = formatDateTime(minTime);
    
    pickupDateTime.setAttribute('min', minDateTimeString);
    if (!pickupDateTime.value) {
        pickupDateTime.value = minDateTimeString;
    }
}
/* ---------- CÃ¡c hÃ m JS khÃ¡c (Tiáº¿p theo) ---------- */

// HÃ m chÃ­nh tÃ­nh giÃ¡ cÆ°á»›c vÃ  táº¡o tin nháº¯n Zalo
async function calculateAndGenerateMessage() {
    const lang = currentLang;
    const t = TRANSLATIONS[lang];
    
    if (!validateRouteInputs()) {
        return false; 
    }
    
    // 1. Resolve tá»a Ä‘á»™
    const pickupCoord = await resolveCoordForInput(pickupEl);
    if(!pickupCoord){ alert(t.alert_no_coord.replace('{0}', t.pickup_label)); return false; }
    const dropoffCoord = await resolveCoordForInput(dropoffEl);
    if(!dropoffCoord){ alert(t.alert_no_coord.replace('{0}', t.dropoff_label)); return false; }

    const coords = [];
    coords.push(pickupCoord);
    const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
    for(const s of stopInputs){
        if(s.value.trim()){
            const sc = await resolveCoordForInput(s);
            if(!sc){ 
                 // TÃ¬m label tÆ°Æ¡ng á»©ng cho Ä‘iá»ƒm dá»«ng thá»© i
                let stopLabel = t.stop_label + ' ';
                const match = s.id.match(/\d+/);
                if (match) {
                    stopLabel += match[0];
                }
                alert(t.alert_no_coord.replace('{0}', stopLabel)); 
                return false; 
            }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord);

    const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
    const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

    // 2. Cáº­p nháº­t UI Loading
    resultBox.style.display = 'block';
    distanceText.textContent = t.result_distance.replace('â€”', t.calculating_route || 'Äang tÃ­nh lá»™ trÃ¬nh...');
    priceValue.textContent = '...';
    priceBreak.innerHTML = '';
    timeEst.textContent = t.result_time_est.replace('â€”', '...');
    finalZaloMessage = ''; 
    finalTotalFee = 0;
    zaloBtn.style.display = 'none'; 
    mailBtn.style.display = 'none';
    instructionText.innerHTML = t.instruction_text_loading; 

    try{
        // 3. Gá»i OSRM API
        const r = await fetch(url);
        const data = await r.json();
        
        if(!data.routes || data.routes.length === 0){ 
            distanceText.textContent = t.result_distance.replace('â€”', t.route_error || 'Lá»—i tÃ­nh toÃ¡n lá»™ trÃ¬nh.'); 
            priceValue.textContent = 'â€”';
            instructionText.innerHTML = t.alert_no_coord.replace('{0}', '');
            return false; 
        }
        
        const route = data.routes[0];
        const dist = route.distance / 1000; 
        const durationSec = route.duration;
        const minutes = Math.round(durationSec / 60);

        // 4. Váº½ láº¡i báº£n Ä‘á»“
        if(map) {
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
        }

        // 5. TÃ­nh toÃ¡n giÃ¡ cÆ°á»›c
        const tripType = tripTypeEl.value; 
        const carType = carTypeEl.value; 
        const driverRequest = driverRequestEl.value;
        const waiting = parseFloat(waitingEl.value) || 0; 
        
        let perKm;
        const carTypeKey = carType.includes('7 chá»—') ? 'car_7_seater' : 'car_4_seater';
        // ThÃªm cÃ¡c key cáº§n thiáº¿t vÃ o TRANSLATIONS náº¿u thiáº¿u
        const carTypeText = TRANSLATIONS[lang][carTypeKey] || carType; 
        
        if (carType.includes('7 chá»—')) { perKm = 12000; } else { perKm = 10000; }
        const perKmReturnDiscount = Math.round(perKm * 0.6); 
        const priceGo = Math.round(dist * perKm);
        
        let priceReturn = 0;
        let returnNote = ''; 

        if(tripType === '2') {
            if(dist >= 45) {
                priceReturn = Math.round(dist * perKmReturnDiscount); 
                // Sá»­ dá»¥ng default náº¿u key dá»‹ch thiáº¿u
                const tripType2Text = TRANSLATIONS[lang].trip_type_2 || '2 chiá»u (giáº£m 40% chiá»u vá»)';
                const distanceUnit = TRANSLATIONS[lang].distance_unit || 'km';
                returnNote = `${tripType2Text} (${perKmReturnDiscount.toLocaleString('vi-VN')}Ä‘/${distanceUnit})`;
            } else {
                priceReturn = Math.round(dist * perKm); 
                const tripType2NoDiscount = TRANSLATIONS[lang].trip_type_2_no_discount || '2 chiá»u (KhÃ´ng giáº£m giÃ¡)';
                const distanceUnit = TRANSLATIONS[lang].distance_unit || 'km';
                returnNote = `${tripType2NoDiscount} (${perKm.toLocaleString('vi-VN')}Ä‘/${distanceUnit})`;
            }
        } else {
            returnNote = TRANSLATIONS[lang].trip_type_1 || '1 chiá»u';
        }

        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total; 
        const depositAmountValue = Math.round(total * 0.2); 

        // 6. Cáº­p nháº­t UI Káº¿t quáº£
        const oneWayTrip = TRANSLATIONS[lang].one_way_trip || 'má»™t chiá»u';
        distanceText.textContent = t.result_distance.replace('â€”', `${dist.toFixed(1)} km (${oneWayTrip})`);
        priceValue.textContent = total.toLocaleString('vi-VN') + ' Ä‘';

        let breakdownHtml = '';
        const priceGoLabel = TRANSLATIONS[lang].price_go || 'GiÃ¡ chiá»u Ä‘i';
        const totalLabel = TRANSLATIONS[lang].total_price || 'Tá»•ng cá»™ng';
        const waitFeeLabel = TRANSLATIONS[lang].wait_fee || 'PhÃ­ chá»';
        const waitTimeLabel = TRANSLATIONS[lang].wait_time || 'Thá»i gian chá»';
        const hoursLabel = TRANSLATIONS[lang].hours || 'giá»';
        const waitFreeLabel = TRANSLATIONS[lang].wait_free_label || 'Miá»…n phÃ­';
        const waitFree = TRANSLATIONS[lang].wait_free || 'miá»…n phÃ­ 0â€“3h';

        breakdownHtml += `â€¢ ${priceGoLabel} (${perKm.toLocaleString('vi-VN')}Ä‘/km): <b>${priceGo.toLocaleString('vi-VN')} Ä‘</b><br>`;
        
        if(tripType === '2'){
            breakdownHtml += `â€¢ ${returnNote}: <b>${priceReturn.toLocaleString('vi-VN')} Ä‘</b><br>`;
        }

        let waitDetail;
        if (tripType === '2') {
            if (waiting > 3) {
                waitDetail = `${waitFeeLabel} (${waiting} ${hoursLabel}, ${waitFree}): <b>${waitFee.toLocaleString('vi-VN')} Ä‘</b>`;
                breakdownHtml += `â€¢ ${waitDetail}<br>`;
            } else if (waiting > 0) {
                waitDetail = `${waitTimeLabel} (${waiting} ${hoursLabel}): <b>${waitFreeLabel}</b>`;
                breakdownHtml += `â€¢ ${waitDetail}<br>`;
            } 
        }
        
        breakdownHtml += `<hr style="margin:6px 0">â€¢ <b>${totalLabel}: ${total.toLocaleString('vi-VN')} Ä‘</b>`;
        priceBreak.innerHTML = breakdownHtml;

        timeEst.textContent = t.result_time_est.replace('â€”', `${minutes}`);

        const dateVal = pickupDateTime.value;
        const formattedDate = dateVal ? new Date(dateVal).toLocaleString(lang, { 
            year: 'numeric', month: 'numeric', day: 'numeric', 
            hour: '2-digit', minute: '2-digit', 
            hour12: false 
        }) : TRANSLATIONS[lang].not_selected || '(ChÆ°a chá»n)';
        pickupInfo.textContent = t.result_pickup_info.replace('â€”', formattedDate);
        
        // 7. Táº¡o tin nháº¯n Zalo/Mail
        
        const stopInputsValues = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'))
            .map(s => s.value.trim()).filter(v => v);
        
        const zaloStopLabel = TRANSLATIONS[lang].zalo_stop_label || 'Äiá»ƒm dá»«ng';
        const stopDetails = stopInputsValues.map((v, i) => `ğŸ›£ï¸ ${zaloStopLabel} ${i+1}: ${v}`).join('\n');
        
        let zaloWaitingDetail = '';
        const zaloWaiting = TRANSLATIONS[lang].zalo_waiting || 'Thá»i gian chá»';
        const zaloWaitFee = TRANSLATIONS[lang].zalo_wait_fee || 'PhÃ­ chá» phÃ¡t sinh';
        if (tripType === '2') {
            if (waiting > 3) {
                zaloWaitingDetail = `â³ ${zaloWaiting}: ${waiting} ${hoursLabel} (${zaloWaitFee}: ${waitFee.toLocaleString('vi-VN')} Ä‘)`;
            } else {
                zaloWaitingDetail = `â³ ${zaloWaiting}: ${waiting} ${hoursLabel} (${waitFreeLabel})`;
            }
        }
        
        // Táº¡o Maps Link
        const pickupAddress = pickupEl.value.trim();
        const dropoffAddress = dropoffEl.value.trim();
        const pickupLatLon = `${pickupCoord[0]},${pickupCoord[1]}`;
        const dropoffLatLon = `${dropoffCoord[0]},${dropoffCoord[1]}`;
        // DÃ¹ng Google Maps URL chÃ­nh xÃ¡c hÆ¡n cho chá»‰ Ä‘Æ°á»ng (S, D)
        const mapsDirectionLink = `https://www.google.com/maps/dir/${pickupLatLon}/${dropoffLatLon}`;
        const mapsPickupLink = `https://www.google.com/maps/search/?api=1&query=${pickupLatLon}`; 

        const mapsLinkTitle = TRANSLATIONS[lang].maps_link_title || 'LIÃŠN Káº¾T Báº¢N Äá»’ CHÃNH XÃC';
        const mapsLinkPickup = TRANSLATIONS[lang].maps_link_pickup || 'Vá»‹ trÃ­ Ä‘Ã³n khÃ¡ch (Tá»a Ä‘á»™)';
        const mapsLinkDir = TRANSLATIONS[lang].maps_link_dir || 'Chá»‰ Ä‘Æ°á»ng (ÄÃ³n -> Tráº£)';
        
        let mapsLinksSection = [
            `\n*** ğŸ—ºï¸ ${mapsLinkTitle} ***`,
            `ğŸ“ ${mapsLinkPickup}: ${mapsPickupLink}`,
            `ğŸ›£ï¸ ${mapsLinkDir}: ${mapsDirectionLink}`,
            `\n`
        ].join('\n');
        
        // ThÃªm thÃ´ng tin Ä‘áº·t cá»c (Deposit)
        let depositSection = '';
        const zaloDeposit = TRANSLATIONS[lang].zalo_deposit || 'Äáº¶T Cá»ŒC';
        const zaloTotalFee = TRANSLATIONS[lang].zalo_total_fee || 'Tá»•ng phÃ­';
        if (tripType === '2') {
            depositSection = `\nğŸ’° ${zaloDeposit}: ${depositAmountValue.toLocaleString('vi-VN')} Ä‘ (20% ${zaloTotalFee})`;
        }

        // Táº¡o tin nháº¯n Zalo Táº¡m thá»i (ChÆ°a cÃ³ SÄT)
        const zaloOrderTitle = TRANSLATIONS[lang].zalo_order_title || 'YÃŠU Cáº¦U Äáº¶T XE TRÆ¯á»œNG AN DRIVING';
        const zaloPhoneLabel = TRANSLATIONS[lang].zalo_phone_label || 'SÄT KhÃ¡ch hÃ ng';
        const zaloTripType = TRANSLATIONS[lang].zalo_trip_type || 'Loáº¡i chuyáº¿n';
        const zaloCarType = TRANSLATIONS[lang].zalo_car_type || 'Loáº¡i xe';
        const zaloDriverRequest = TRANSLATIONS[lang].zalo_driver_request || 'YÃªu cáº§u tÃ i xáº¿';
        const zaloPickupPoint = TRANSLATIONS[lang].zalo_pickup_point || 'Äiá»ƒm Ä‘Ã³n';
        const zaloDropoffPoint = TRANSLATIONS[lang].zalo_dropoff_point || 'Äiá»ƒm Ä‘áº¿n';
        const zaloPickupTime = TRANSLATIONS[lang].zalo_pickup_time || 'NgÃ y giá» Ä‘Ã³n';
        const zaloTotalPrice = TRANSLATIONS[lang].zalo_total_price || 'Tá»•ng giÃ¡ dá»± kiáº¿n';
        const zaloNote = TRANSLATIONS[lang].zalo_note || 'Vui lÃ²ng xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.';
        
        finalZaloMessage = [
            `ğŸš– ${zaloOrderTitle}`,
            '-------------------------------',
            `ğŸ“ ${zaloPhoneLabel}: [CHÆ¯A CÃ“]`,
            `âœ… ${zaloTripType}: ${tripType === '1' ? t.trip_type_1 : `${t.trip_type_2} (${dist.toFixed(1)} km/${oneWayTrip})`}`,
            `ğŸš˜ ${zaloCarType}: ${carTypeText}`, 
            `ğŸ§‘â€âœˆï¸ ${zaloDriverRequest}: ${driverRequest}`,
            `ğŸ“ ${zaloPickupPoint}: ${pickupAddress}`,
            ...(stopInputsValues.length ? [stopDetails] : []),
            `ğŸ ${zaloDropoffPoint}: ${dropoffAddress}`,
            `ğŸ•’ ${zaloPickupTime}: ${formattedDate}`,
            ...(tripType === '2' ? [zaloWaitingDetail] : []), 
            `ğŸ’µ ${zaloTotalPrice}: ${total.toLocaleString('vi-VN')} Ä‘`,
            depositSection,
            mapsLinksSection, 
            '-------------------------------',
            zaloNote,
        ].join('\n');

        // 8. Hiá»ƒn thá»‹ nÃºt Ä‘áº·t xe vÃ  cuá»™n Ä‘áº¿n káº¿t quáº£
        zaloBtn.style.display = 'block'; 
        mailBtn.style.display = 'block'; 
        instructionText.style.display = 'block';
        instructionText.innerHTML = t.instruction_text_active;

        resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return true; 
    }catch(err){
        console.error('Route error', err);
        distanceText.textContent = t.alert_no_coord.replace('{0}', '...');
        priceValue.textContent = 'â€”';
        // Reset láº¡i link mail (dÃ¹ng chung cho trÆ°á»ng há»£p lá»—i)
        mailBtn.href = `mailto:netvuan@gmail.com`; 
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        instructionText.innerHTML = t.alert_no_coord.replace('{0}', '');
        return false;
    }
}

// Xá»­ lÃ½ nÃºt TÃ­nh giÃ¡
calcBtn.addEventListener('click', async () => {
  const t = TRANSLATIONS[currentLang];
  if (!isServiceActive) {
      alert(t.alert_service_off);
      return;
  }
  
  const success = await calculateAndGenerateMessage();

  if(success && tripTypeEl.value === '2') {
    const deposit = Math.round(finalTotalFee * 0.2);
    depositAmount.textContent = deposit.toLocaleString('vi-VN') + ' Ä‘';
    depositModal.style.display = 'flex';
  }
});

// Xá»­ lÃ½ nÃºt Äáº·t qua Zalo / Mail
function handleBookingClick(action) {
    const t = TRANSLATIONS[currentLang];
    if (finalTotalFee === 0) {
        alert(t.alert_no_price);
        return;
    }
    
    bookingAction = action;
    const phone = customerPhoneEl.value.trim();

    if (!validatePhone(phone)) {
        inputPhoneForBooking.value = phone;
        phoneModal.style.display = 'flex';
        inputPhoneForBooking.focus();
    } else {
        openFinalZaloModal(phone);
    }
}

zaloBtn.addEventListener('click', () => handleBookingClick('zalo'));
mailBtn.addEventListener('click', () => handleBookingClick('mail'));

// Xá»­ lÃ½ xÃ¡c nháº­n SÄT trong Phone Modal
confirmPhoneBtn.addEventListener('click', () => {
    const t = TRANSLATIONS[currentLang];
    const phone = inputPhoneForBooking.value.trim();
    if (!validatePhone(phone)) {
        alert(t.alert_invalid_phone);
        inputPhoneForBooking.focus();
        return;
    }
    customerPhoneEl.value = phone; 
    phoneModal.style.display = 'none';

    if (bookingAction) {
        openFinalZaloModal(phone);
    }
});

closePhoneModalBtn.addEventListener('click', () => {
    phoneModal.style.display = 'none';
    bookingAction = null; 
});
phoneModal.addEventListener('click', (e) => {
    if (e.target === phoneModal) {
        phoneModal.style.display = 'none';
        bookingAction = null; 
    }
});


// Xá»­ lÃ½ xÃ¡c nháº­n Ä‘áº·t cá»c
confirmDepositBtn.addEventListener('click', () => {
    depositModal.style.display = 'none';
});
depositModal.addEventListener('click', (e) => {
    if (e.target === depositModal) {
        depositModal.style.display = 'none';
    }
});


// Má»Ÿ Modal Zalo/Mail chÃ­nh
function openFinalZaloModal(phone) {
    const t = TRANSLATIONS[currentLang];
    let finalMessage = finalZaloMessage.replace('[CHÆ¯A CÃ“]', phone);
    modalText.textContent = finalMessage;

    if(bookingAction === 'mail') {
        const zaloOrderTitle = TRANSLATIONS[currentLang].zalo_order_title || 'YÃªu cáº§u Äáº·t xe TrÆ°á»ng An';
        const encodedMsg = encodeURIComponent(finalMessage);
        const subject = encodeURIComponent(`${zaloOrderTitle} - ${distanceText.textContent.split(': ')[1]}`);
        mailBtn.href = `mailto:netvuan@gmail.com?subject=${subject}&body=${encodedMsg}`;
        alert(t.alert_mail_sent);
        window.location.href = mailBtn.href;
        zaloModal.style.display = 'none';
        bookingAction = null;
        return;
    }

    zaloModal.style.display = 'flex'; 

    // Tá»± Ä‘á»™ng chá»n (highlight) toÃ n bá»™ ná»™i dung Ä‘á»ƒ ngÆ°á»i dÃ¹ng tiá»‡n copy
    const range = document.createRange();
    range.selectNodeContents(modalText);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Thá»­ tá»± Ä‘á»™ng copy
    copyToClipboard(finalMessage).then(success => {
        if(success) {
            console.log("ÄÃ£ sao chÃ©p tin nháº¯n Zalo thÃ nh cÃ´ng.");
        }
    });

    bookingAction = null; 
}


async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.warn('Fallback: Copying directly from DOM');
        try {
            // DÃ¹ng execCommand fallback (cáº§n pháº£i cÃ³ selection)
            const success = document.execCommand('copy');
            return success;
        } catch (errFallback) {
            console.error('KhÃ´ng thá»ƒ thá»±c hiá»‡n sao chÃ©p:', errFallback);
            return false;
        }
    }
}

copyModalBtn.addEventListener('click', async () => {
    const t = TRANSLATIONS[currentLang];
    // Äáº£m báº£o ná»™i dung Ä‘Æ°á»£c chá»n trÆ°á»›c khi copy
    const range = document.createRange();
    range.selectNodeContents(modalText);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    const success = await copyToClipboard(modalText.textContent);
    
    if (success) {
        alert(t.alert_copied);
        // KhÃ´ng xÃ³a selection Ä‘á»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ kiá»ƒm tra
    } else {
        alert(t.alert_copy_fail);
    }
});

zaloModalBtn.addEventListener('click', () => {
    window.getSelection().removeAllRanges(); 
    zaloModal.style.display = 'none'; 
    window.open(ZALO_URL, '_blank');
});

closeModalBtn.addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    zaloModal.style.display = 'none';
});

zaloModal.addEventListener('click', (e) => {
    if (e.target === zaloModal) {
        window.getSelection().removeAllRanges();
        zaloModal.style.display = 'none';
    }
});

/* ------------------------------------------------------------------
   KHá»I Táº O VÃ€ POLLING (Tá»° Äá»˜NG Cáº¬P NHáº¬T TRáº NG THÃI)
   ------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', async ()=>{
    // Khá»Ÿi táº¡o Language Switcher trÆ°á»›c
    initLanguageSwitcher(); 
    
    setMinPickupDateTime();
    
    getGeolocation();
    
    // Kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥ láº§n Ä‘áº§u
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    // Tá»± Ä‘á»™ng kiá»ƒm tra file JSON ná»™i bá»™ má»—i 15 giÃ¢y
    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
            console.log(`[Kill Switch] Tráº¡ng thÃ¡i Ä‘Ã£ thay Ä‘á»•i vÃ  Ä‘Æ°á»£c cáº­p nháº­t tá»± Ä‘á»™ng! Active: ${newStatus.active}`);
        }
        // Cáº­p nháº­t láº¡i thá»i gian tá»‘i thiá»ƒu má»—i láº§n polling Ä‘á»ƒ luÃ´n theo sÃ¡t thá»i gian thá»±c
        setMinPickupDateTime(); 
    }, 15000); 
    
    reloadLocationBtn.addEventListener('click', getGeolocation); 
});

// PWA: ÄÄƒng kÃ½ Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then((reg) => {
        console.log('Service worker registered.', reg);
      })
      .catch((err) => {
        console.log('Service worker registration failed: ', err);
      });
  });
}
