<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªãch V·ª• Taxi Tr∆∞·ªùng An Driving | T√≠nh Gi√° C∆∞·ªõc & ƒê·∫∑t Xe</title>
    <meta name="description" content="T√≠nh gi√° c∆∞·ªõc taxi hai chi·ªÅu, m·ªôt chi·ªÅu ch√≠nh x√°c, nhanh ch√≥ng. ƒê·∫∑t xe 4 ch·ªó, 7 ch·ªó ƒëi t·ªânh v·ªõi Tr∆∞·ªùng An Driving.">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIINfQ7oWA8x9ppvLG3E8wM6CWTNkmr4SSg=" crossorigin=""/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        /* CSS GIAO DI·ªÜN CH√çNH */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            padding-bottom: 70px; 
        }
        .container {
            max-width: 600px;
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px 0;
            margin: -15px -15px 15px -15px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            text-align: center;
        }
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .form-label {
            font-weight: bold;
            color: #333;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .input-group-text {
            background-color: #e9ecef;
            min-width: 100px;
            justify-content: center;
        }
        #result-box {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        #price-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d9534f; 
        }
        .btn-calculate {
            background-color: #007bff;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .btn-zalo, .btn-mail {
            font-size: 1rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .btn-zalo { background-color: #008cff; border-color: #008cff; color: white; }
        .btn-mail { background-color: #dc3545; border-color: #dc3545; color: white; }
        
        /* CSS MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
        }
        #modal-text {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            user-select: text;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        #offline-alert {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üöï D·ªãch V·ª• Taxi</h1>
        <p>Tr∆∞·ªùng An Driving</p>
        <p style="font-size: 1rem; margin-bottom: 0;">‚òéÔ∏è 0847526893</p>
    </div>

    <div id="offline-alert" class="alert alert-danger" role="alert">
        Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.
    </div>

    <div class="mb-3 d-flex justify-content-end">
        <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
            <option value="en">üá∫üá∏ English</option>
            <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="customer-phone" class="form-label" id="label-phone">üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n</label>
        <div class="input-group">
            <input type="tel" class="form-control" id="customer-phone" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)">
        </div>
    </div>
    
    <div class="mb-3">
        <label for="pickup-address" class="form-label" id="label-pickup">üìç ƒêi·ªÉm ƒë√≥n</label>
        <div class="input-group">
            <span class="input-group-text location-status" id="status-location">T·ª± ƒë·ªông t√¨m v·ªã tr√≠</span>
            <input type="text" class="form-control address-input" id="pickup-address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n">
            <button class="btn btn-outline-secondary" type="button" id="reload-location-btn" title="T·∫£i l·∫°i v·ªã tr√≠">üîÑ</button>
            <button class="btn btn-outline-secondary" type="button" onclick="window.open('https://maps.google.com/', '_blank');" id="btn-map-pickup">B·∫£n ƒë·ªì</button>
        </div>
    </div>

    <div class="mb-3">
        <label for="pickup-date-time" class="form-label" id="label-datetime">üïí Ng√†y & Gi·ªù ƒë√≥n</label>
        <input type="datetime-local" class="form-control" id="pickup-date-time">
    </div>

    <div id="stops-container">
        </div>
    <button class="btn btn-success btn-sm mb-3" id="add-stop-btn">+ Th√™m ƒëi·ªÉm d·ª´ng</button>

    <div class="mb-3">
        <label for="dropoff-address" class="form-label" id="label-dropoff">üèÅ ƒêi·ªÉm ƒë·∫øn</label>
        <div class="input-group">
            <input type="text" class="form-control address-input" id="dropoff-address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
            <button class="btn btn-outline-secondary" type="button" onclick="window.open('https://maps.google.com/', '_blank');" id="btn-map-dropoff">B·∫£n ƒë·ªì</button>
        </div>
    </div>
    
    <div class="mb-3">
        <label for="car-type" class="form-label" id="label-cartype">üöó Lo·∫°i xe</label>
        <select class="form-select" id="car-type">
            <option value="Xe 4 ch·ªó (10.000ƒë/km)" data-lang-vi="Xe 4 ch·ªó (10.000ƒë/km)" data-lang-en="4-seater car (10,000VND/km)" data-lang-ja="4‰∫∫‰πó„ÇäËªä (10,000„Éâ„É≥/km)">Xe 4 ch·ªó (10.000ƒë/km)</option>
            <option value="Xe 7 ch·ªó (12.000ƒë/km)" data-lang-vi="Xe 7 ch·ªó (12.000ƒë/km)" data-lang-en="7-seater car (12,000VND/km)" data-lang-ja="7‰∫∫‰πó„ÇäËªä (12,000„Éâ„É≥/km)">Xe 7 ch·ªó (12.000ƒë/km)</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="trip-type" class="form-label" id="label-triptype">üöñ Lo·∫°i chuy·∫øn ƒëi</label>
        <select class="form-select" id="trip-type">
            <option value="1" data-lang-vi="1 chi·ªÅu" data-lang-en="One way" data-lang-ja="ÁâáÈÅì">1 chi·ªÅu</option>
            <option value="2" data-lang-vi="2 chi·ªÅu (C√≥ gi·∫£m gi√° chi·ªÅu v·ªÅ)" data-lang-en="Round trip (Return discount applies)" data-lang-ja="ÂæÄÂæ© (Âæ©Ë∑ØÂâ≤ÂºïÈÅ©Áî®)">2 chi·ªÅu (C√≥ gi·∫£m gi√° chi·ªÅu v·ªÅ)</option>
        </select>
    </div>

    <div class="mb-3" id="waiting-group">
        <label for="waiting-time" class="form-label" id="label-waiting">‚è≥ Th·ªùi gian ch·ªù (ch·ªâ √°p d·ª•ng 2 chi·ªÅu, mi·ªÖn ph√≠ 0-3 gi·ªù)</label>
        <div class="input-group">
            <input type="number" class="form-control" id="waiting-time" value="0" min="0" step="0.5">
            <span class="input-group-text" id="unit-hours">gi·ªù</span>
        </div>
    </div>

    <div class="mb-3">
        <label for="driver-request" class="form-label" id="label-driver-request">üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu t√†i x·∫ø (L√°i xe h·ªô/Xe kh√°ch/Xe c√¥ng ty)</label>
        <select class="form-select" id="driver-request">
            <option value="Kh√¥ng y√™u c·∫ßu ƒë·∫∑c bi·ªát" data-lang-vi="Kh√¥ng y√™u c·∫ßu ƒë·∫∑c bi·ªát" data-lang-en="No special request" data-lang-ja="ÁâπÂà•„Å™„É™„ÇØ„Ç®„Çπ„Éà„Å™„Åó">Kh√¥ng y√™u c·∫ßu ƒë·∫∑c bi·ªát</option>
            <option value="L√°i xe h·ªô" data-lang-vi="L√°i xe h·ªô" data-lang-en="Designated driver (Drive my car)" data-lang-ja="ÈÅãËª¢‰ª£Ë°å">L√°i xe h·ªô</option>
            <option value="L√°i xe kh√°ch" data-lang-vi="L√°i xe kh√°ch" data-lang-en="Coach driver" data-lang-ja="Ë¶≥ÂÖâ„Éê„ÇπÈÅãËª¢Êâã">L√°i xe kh√°ch</option>
            <option value="L√°i xe c√¥ng ty" data-lang-vi="L√°i xe c√¥ng ty" data-lang-en="Company driver" data-lang-ja="Á§æÁî®ËªäÈÅãËª¢Êâã">L√°i xe c√¥ng ty</option>
            <option value="T√†i x·∫ø m·∫∑c ƒë·ªãnh (Tr∆∞·ªùng An)" data-lang-vi="T√†i x·∫ø m·∫∑c ƒë·ªãnh (Tr∆∞·ªùng An)" data-lang-en="Default driver (Truong An)" data-lang-ja="Â∞ÇÂ±ûÈÅãËª¢Êâã („ÉÅ„É•„Ç™„É≥„Ç¢„É≥)">T√†i x·∫ø m·∫∑c ƒë·ªãnh (Tr∆∞·ªùng An)</option>
        </select>
    </div>

    <button class="btn btn-calculate w-100 mb-3" id="calculate-btn">T√≠nh gi√° & L·ªô tr√¨nh</button>

    <div id="map"></div>

    <div id="result-box">
        <h4 class="text-primary" id="result-title">K·∫æT QU·∫¢ D·ª∞ KI·∫æN</h4>
        <div class="mb-2">
            <p id="distance-text" class="mb-1">Qu√£ng ƒë∆∞·ªùng: ‚Äî</p>
            <p id="time-estimate" class="mb-1">Th·ªùi gian di chuy·ªÉn (∆∞·ªõc t√≠nh): ‚Äî ph√∫t</p>
            <p id="pickup-info" class="mb-1">Ng√†y gi·ªù ƒë√≥n: ‚Äî</p>
            <p class="mb-0" id="label-total-price">T·ªïng gi√° d·ª± ki·∫øn:</p>
            <span id="price-value">‚Äî</span>
        </div>
        <hr>
        <div id="price-breakdown" style="font-size: 0.9em;">
            </div>
        <hr>
        <p id="instruction-text" class="text-success fw-bold">Vui l√≤ng nh·∫•n n√∫t "T√≠nh gi√° & l·ªô tr√¨nh" ƒë·ªÉ xem chi ti·∫øt.</p>
        <button class="btn btn-zalo w-100" id="zalo-btn" style="display: none;"><img src="https://upload.wikimedia.org/wikipedia/commons/9/90/Zalo_logo.svg" alt="Zalo" width="20"> <span id="btn-zalo-text">ƒê·∫∑t qua Zalo</span></button>
        <button class="btn btn-mail w-100 mt-2" id="mail-btn" style="display: none;">‚úâÔ∏è <span id="btn-mail-text">ƒê·∫∑t qua Email</span></button>
    </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20n6a323G3A4f+hT7D4n+y9A9VfG3f/v/G4Q0n9+JvE=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<div id="phone-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="phone-modal-title">X√°c nh·∫≠n S·ªë ƒëi·ªán tho·∫°i</h4>
            <button class="close-btn" id="close-phone-modal">√ó</button>
        </div>
        <p id="phone-modal-instruction">ƒê·ªÉ ho√†n t·∫•t vi·ªác ƒë·∫∑t xe, vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n:</p>
        <input type="tel" class="form-control" id="input-phone-for-booking" placeholder="S·ªë ƒëi·ªán tho·∫°i 10 s·ªë">
        <div class="modal-buttons">
            <button class="btn btn-primary w-100" id="confirm-phone-btn">X√°c nh·∫≠n</button>
        </div>
    </div>
</div>

<div id="deposit-modal" class="modal">
    <div class="modal-content text-center">
        <div class="modal-header d-block">
            <h4 class="text-warning" id="deposit-modal-title">‚ö†Ô∏è L∆ØU √ù ƒê·∫∂T C·ªåC</h4>
        </div>
        <p id="deposit-modal-p1">V·ªõi chuy·∫øn **Hai chi·ªÅu** ƒëi t·ªânh, qu√Ω kh√°ch vui l√≤ng ƒë·∫∑t c·ªçc **20%** t·ªïng gi√° tr·ªã chuy·∫øn ƒëi.</p>
        <p class="fw-bold" id="deposit-modal-p2">S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn: <span id="deposit-amount" class="text-danger">0 ƒë</span></p>
        <p style="font-size: 0.8em; color: #6c757d;" id="deposit-modal-note">(S·ªë ti·ªÅn n√†y s·∫Ω ƒë∆∞·ª£c tr·ª´ v√†o t·ªïng c∆∞·ªõc khi k·∫øt th√∫c chuy·∫øn ƒëi.)</p>
        <div class="modal-buttons">
            <button class="btn btn-success w-100" id="confirm-deposit-btn">ƒê√£ hi·ªÉu</button>
        </div>
    </div>
</div>

<div id="zalo-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="zalo-modal-title">‚úÖ TH√îNG TIN ƒê·∫∂T XE</h4>
            <button class="close-btn" id="close-modal-btn">√ó</button>
        </div>
        <p id="zalo-modal-instruction">Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <div id="modal-text" class="modal-body">
            </div>
        <div class="modal-buttons">
            <button class="btn btn-warning" id="copy-modal-btn">üìã Sao Ch√©p Th√¥ng Tin</button>
            <button class="btn btn-primary" id="zalo-modal-btn">üí¨ M·ªü Zalo Chat</button>
        </div>
        <div class="d-grid mt-2">
            <button class="btn btn-secondary" id="close-modal-btn-bottom">ƒê√≥ng</button>
        </div>
    </div>
</div>


<script>
// Bi·∫øn to√†n c·ª•c
const OSRM = 'https://router.project-osrm.org/route/v1/driving';
const ZALO_URL = 'https://zalo.me/0847526893'; // SƒêT Tr∆∞·ªùng An
const STATUS_FILE = './status-local.json'; // File ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª• (C·∫ßn t·∫°o file n√†y)

let map;
let markerPickup, markerDropoff;
let routeLayer;
let finalZaloMessage = '';
let finalTotalFee = 0;
let bookingAction = null; 
let currentLang = 'vi'; 
let isServiceActive = true; 

// D·ªØ li·ªáu d·ªãch thu·∫≠t
const TRANSLATIONS = {
    'vi': {
        // C√ÅC NH√ÉN CHUNG V√Ä T√ôY CH·ªåN
        trip_type_1: '1 chi·ªÅu',
        trip_type_2: '2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)',
        trip_type_2_no_discount: '2 chi·ªÅu (Kh√¥ng gi·∫£m gi√°)',
        car_4_seater: 'Xe 4 ch·ªó',
        car_7_seater: 'Xe 7 ch·ªó',
        hours: 'gi·ªù',
        distance_unit: 'km',
        not_selected: '(Ch∆∞a ch·ªçn)',
        one_way_trip: 'm·ªôt chi·ªÅu',
        
        // NH√ÉN TRONG FORM (D√πng ƒë·ªÉ c·∫≠p nh·∫≠t UI)
        label_phone: 'üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n',
        status_location: 'T·ª± ƒë·ªông t√¨m v·ªã tr√≠',
        label_pickup: 'üìç ƒêi·ªÉm ƒë√≥n',
        label_datetime: 'üïí Ng√†y & Gi·ªù ƒë√≥n',
        add_stop_btn: '+ Th√™m ƒëi·ªÉm d·ª´ng',
        label_dropoff: 'üèÅ ƒêi·ªÉm ƒë·∫øn',
        label_cartype: 'üöó Lo·∫°i xe',
        label_triptype: 'üöñ Lo·∫°i chuy·∫øn ƒëi',
        label_waiting: '‚è≥ Th·ªùi gian ch·ªù (ch·ªâ √°p d·ª•ng 2 chi·ªÅu, mi·ªÖn ph√≠ 0-3 gi·ªù)',
        unit_hours: 'gi·ªù',
        label_driver_request: 'üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu t√†i x·∫ø (L√°i xe h·ªô/Xe kh√°ch/Xe c√¥ng ty)',
        calculate_btn: 'T√≠nh gi√° & L·ªô tr√¨nh',
        btn_zalo_text: 'ƒê·∫∑t qua Zalo',
        btn_mail_text: 'ƒê·∫∑t qua Email',
        result_title: 'K·∫æT QU·∫¢ D·ª∞ KI·∫æN',
        label_total_price: 'T·ªïng gi√° d·ª± ki·∫øn:',
        
        // K·∫æT QU·∫¢ HI·ªÇN TH·ªä
        result_distance: 'Qu√£ng ƒë∆∞·ªùng: ‚Äî',
        result_time_est: 'Th·ªùi gian di chuy·ªÉn (∆∞·ªõc t√≠nh): ‚Äî ph√∫t',
        result_pickup_info: 'Ng√†y gi·ªù ƒë√≥n: ‚Äî',
        price_go: 'Gi√° chi·ªÅu ƒëi',
        total_price: 'T·ªïng c·ªông',
        wait_fee: 'Ph√≠ ch·ªù ph√°t sinh',
        wait_time: 'Th·ªùi gian ch·ªù',
        wait_free_label: 'Mi·ªÖn ph√≠',
        wait_free: 'mi·ªÖn ph√≠ 0‚Äì3h',
        
        // ALERT V√Ä TH√îNG B√ÅO
        calculating_route: 'ƒêang t√≠nh l·ªô tr√¨nh...',
        route_error: 'L·ªói t√≠nh to√°n l·ªô tr√¨nh.',
        instruction_text_loading: 'ƒêang x·ª≠ l√Ω...',
        instruction_text_active: 'Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin v√† nh·∫•n n√∫t ƒê·∫∑t xe.',
        alert_no_coord: 'Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô/ƒë·ªãa ch·ªâ cho {0}. Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ h∆°n.',
        alert_no_address: 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ ƒêi·ªÉm ƒë√≥n v√† ƒêi·ªÉm ƒë·∫øn.',
        alert_no_date: 'Vui l√≤ng ch·ªçn Ng√†y & Gi·ªù ƒë√≥n.',
        alert_no_price: 'Vui l√≤ng nh·∫•n n√∫t "T√≠nh gi√° & l·ªô tr√¨nh" tr∆∞·ªõc khi ƒê·∫∑t xe.',
        alert_invalid_phone: 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0, VD: 0987654321).',
        alert_copied: 'ƒê√£ sao ch√©p th√¥ng tin ƒë·∫∑t xe th√†nh c√¥ng!',
        alert_copy_fail: 'Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng ch·ªçn v√† sao ch√©p th·ªß c√¥ng.',
        alert_mail_sent: 'Th√¥ng tin s·∫Ω ƒë∆∞·ª£c g·ª≠i qua Email m·∫∑c ƒë·ªãnh c·ªßa b·∫°n.',
        alert_service_off: 'Xin l·ªói, d·ªãch v·ª• t·∫°m th·ªùi kh√¥ng ho·∫°t ƒë·ªông. Vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp qua s·ªë ƒëi·ªán tho·∫°i tr√™n.',
        
        // TIN NH·∫ÆN ZALO/MAIL
        zalo_order_title: 'Y√äU C·∫¶U ƒê·∫∂T XE TR∆Ø·ªúNG AN DRIVING',
        zalo_phone_label: 'SƒêT Kh√°ch h√†ng',
        zalo_trip_type: 'Lo·∫°i chuy·∫øn',
        zalo_car_type: 'Lo·∫°i xe',
        zalo_driver_request: 'Y√™u c·∫ßu t√†i x·∫ø',
        zalo_pickup_point: 'ƒêi·ªÉm ƒë√≥n',
        zalo_dropoff_point: 'ƒêi·ªÉm ƒë·∫øn',
        zalo_pickup_time: 'Ng√†y gi·ªù ƒë√≥n',
        zalo_total_price: 'T·ªïng gi√° d·ª± ki·∫øn',
        zalo_stop_label: 'ƒêi·ªÉm d·ª´ng',
        zalo_waiting: 'Th·ªùi gian ch·ªù',
        zalo_wait_fee: 'Ph√≠ ch·ªù ph√°t sinh',
        zalo_note: 'Vui l√≤ng x√°c nh·∫≠n ƒë∆°n h√†ng.',
        zalo_deposit: 'ƒê·∫∂T C·ªåC',
        zalo_total_fee: 'T·ªïng ph√≠',
        maps_link_title: 'LI√äN K·∫æT B·∫¢N ƒê·ªí CH√çNH X√ÅC',
        maps_link_pickup: 'V·ªã tr√≠ ƒë√≥n kh√°ch (T·ªça ƒë·ªô)',
        maps_link_dir: 'Ch·ªâ ƒë∆∞·ªùng (ƒê√≥n -> Tr·∫£)',

        // MODAL
        phone_modal_title: 'X√°c nh·∫≠n S·ªë ƒëi·ªán tho·∫°i',
        phone_modal_instruction: 'ƒê·ªÉ ho√†n t·∫•t vi·ªác ƒë·∫∑t xe, vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n:',
        deposit_modal_title: '‚ö†Ô∏è L∆ØU √ù ƒê·∫∂T C·ªåC',
        deposit_modal_p1: 'V·ªõi chuy·∫øn **Hai chi·ªÅu** ƒëi t·ªânh, qu√Ω kh√°ch vui l√≤ng ƒë·∫∑t c·ªçc **20%** t·ªïng gi√° tr·ªã chuy·∫øn ƒëi.',
        deposit_modal_p2: 'S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn:',
        deposit_modal_note: '(S·ªë ti·ªÅn n√†y s·∫Ω ƒë∆∞·ª£c tr·ª´ v√†o t·ªïng c∆∞·ªõc khi k·∫øt th√∫c chuy·∫øn ƒëi.)',
        zalo_modal_title: '‚úÖ TH√îNG TIN ƒê·∫∂T XE',
        zalo_modal_instruction: 'Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:',
        stop_label: 'ƒêi·ªÉm d·ª´ng',
    },
    'en': {
        // C√ÅC NH√ÉN CHUNG V√Ä T√ôY CH·ªåN
        trip_type_1: 'One way',
        trip_type_2: 'Round trip (40% discount on return)',
        trip_type_2_no_discount: 'Round trip (No discount)',
        car_4_seater: '4-seater car',
        car_7_seater: '7-seater car',
        hours: 'hours',
        distance_unit: 'km',
        not_selected: '(Not selected)',
        one_way_trip: 'one way',
        
        // NH√ÉN TRONG FORM (D√πng ƒë·ªÉ c·∫≠p nh·∫≠t UI)
        label_phone: 'üìû Your Phone Number',
        status_location: 'Auto-detecting location',
        label_pickup: 'üìç Pickup Location',
        label_datetime: 'üïí Pickup Date & Time',
        add_stop_btn: '+ Add Stop',
        label_dropoff: 'üèÅ Dropoff Location',
        label_cartype: 'üöó Car Type',
        label_triptype: 'üöñ Trip Type',
        label_waiting: '‚è≥ Waiting Time (Round trip only, first 3 hours free)',
        unit_hours: 'hours',
        label_driver_request: 'üßë‚Äç‚úàÔ∏è Driver Request (Designated/Coach/Company Driver)',
        calculate_btn: 'Calculate Price & Route',
        btn_zalo_text: 'Book via Zalo',
        btn_mail_text: 'Book via Email',
        result_title: 'ESTIMATED RESULT',
        label_total_price: 'Estimated Total Price:',
        
        // K·∫æT QU·∫¢ HI·ªÇN TH·ªä
        result_distance: 'Distance: ‚Äî',
        result_time_est: 'Travel Time (Estimate): ‚Äî minutes',
        result_pickup_info: 'Pickup Date & Time: ‚Äî',
        price_go: 'Outbound Price',
        total_price: 'Total',
        wait_fee: 'Waiting Fee',
        wait_time: 'Waiting Time',
        wait_free_label: 'Free',
        wait_free: 'free 0‚Äì3h',
        
        // ALERT V√Ä TH√îNG B√ÅO
        calculating_route: 'Calculating route...',
        route_error: 'Route calculation error.',
        instruction_text_loading: 'Processing...',
        instruction_text_active: 'Please check the information and press the Book button.',
        alert_no_coord: 'Could not find coordinates/address for {0}. Please enter a more specific address.',
        alert_no_address: 'Please enter both Pickup and Dropoff addresses.',
        alert_no_date: 'Please select Pickup Date & Time.',
        alert_no_price: 'Please press "Calculate Price & Route" before booking.',
        alert_invalid_phone: 'Invalid phone number (10 digits, starting with 0, e.g., 0987654321).',
        alert_copied: 'Booking information copied successfully!',
        alert_copy_fail: 'Automatic copy failed. Please select and copy manually.',
        alert_mail_sent: 'Information will be sent via your default email client.',
        alert_service_off: 'Sorry, the service is temporarily inactive. Please contact us directly via the phone number above.',
        
        // TIN NH·∫ÆN ZALO/MAIL
        zalo_order_title: 'TRUONG AN DRIVING BOOKING REQUEST',
        zalo_phone_label: 'Customer Phone',
        zalo_trip_type: 'Trip Type',
        zalo_car_type: 'Car Type',
        zalo_driver_request: 'Driver Request',
        zalo_pickup_point: 'Pickup Point',
        zalo_dropoff_point: 'Dropoff Point',
        zalo_pickup_time: 'Pickup Date/Time',
        zalo_total_price: 'Estimated Total Price',
        zalo_stop_label: 'Stop Point',
        zalo_waiting: 'Waiting Time',
        zalo_wait_fee: 'Extra Waiting Fee',
        zalo_note: 'Please confirm the order.',
        zalo_deposit: 'DEPOSIT',
        zalo_total_fee: 'Total Fee',
        maps_link_title: 'ACCURATE MAP LINKS',
        maps_link_pickup: 'Pickup Location (Coordinates)',
        maps_link_dir: 'Directions (Pickup -> Dropoff)',

        // MODAL
        phone_modal_title: 'Confirm Phone Number',
        phone_modal_instruction: 'To complete the booking, please enter your phone number:',
        deposit_modal_title: '‚ö†Ô∏è DEPOSIT NOTE',
        deposit_modal_p1: 'For **Round trip** inter-provincial travel, please pay a **20%** deposit of the total fee.',
        deposit_modal_p2: 'Estimated deposit amount:',
        deposit_modal_note: '(This amount will be deducted from the total fare upon trip completion.)',
        zalo_modal_title: '‚úÖ BOOKING INFORMATION',
        zalo_modal_instruction: 'Copy the information and send via Zalo:',
        stop_label: 'Stop',
    },
    'ja': {
        // C√ÅC NH√ÉN CHUNG V√Ä T√ôY CH·ªåN
        trip_type_1: 'ÁâáÈÅì',
        trip_type_2: 'ÂæÄÂæ© (Âæ©Ë∑Ø40%Ââ≤Âºï)',
        trip_type_2_no_discount: 'ÂæÄÂæ© (Ââ≤Âºï„Å™„Åó)',
        car_4_seater: '4‰∫∫‰πó„ÇäËªä',
        car_7_seater: '7‰∫∫‰πó„ÇäËªä',
        hours: 'ÊôÇÈñì',
        distance_unit: 'km',
        not_selected: '(Êú™ÈÅ∏Êäû)',
        one_way_trip: 'ÁâáÈÅì',
        
        // NH√ÉN TRONG FORM (D√πng ƒë·ªÉ c·∫≠p nh·∫≠t UI)
        label_phone: 'üìû ÈõªË©±Áï™Âè∑',
        status_location: 'ÁèæÂú®Âú∞„ÇíËá™ÂãïÊ§úÂá∫‰∏≠',
        label_pickup: 'üìç Ëøé„Åà„ÅÆÂ†¥ÊâÄ',
        label_datetime: 'üïí Ëøé„Åà„ÅÆÊó•ÊôÇ',
        add_stop_btn: '+ ÁµåÁî±Âú∞„ÇíËøΩÂä†',
        label_dropoff: 'üèÅ ÁõÆÁöÑÂú∞„ÅÆÂ†¥ÊâÄ',
        label_cartype: 'üöó ËªäÁ®Æ',
        label_triptype: 'üöñ Ëµ∞Ë°å„Çø„Ç§„Éó',
        label_waiting: '‚è≥ ÂæÖÊ©üÊôÇÈñì (ÂæÄÂæ©„ÅÆ„Åø„ÄÅÊúÄÂàù„ÅÆ3ÊôÇÈñì„ÅØÁÑ°Êñô)',
        unit_hours: 'ÊôÇÈñì',
        label_driver_request: 'üßë‚Äç‚úàÔ∏è „Éâ„É©„Ç§„Éê„Éº„Å∏„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà (‰ª£Ë°å/Ë¶≥ÂÖâ/Á§æÁî®Ëªä)',
        calculate_btn: 'ÊñôÈáë„Å®„É´„Éº„Éà„ÇíË®àÁÆó',
        btn_zalo_text: 'Zalo„Åß‰∫àÁ¥Ñ',
        btn_mail_text: 'Email„Åß‰∫àÁ¥Ñ',
        result_title: 'Ë¶ãÁ©ç„ÇÇ„ÇäÁµêÊûú',
        label_total_price: 'Ë¶ãÁ©ç„ÇÇ„ÇäÂêàË®àÊñôÈáë:',
        
        // K·∫æT QU·∫¢ HI·ªÇN TH·ªä
        result_distance: 'Ëµ∞Ë°åË∑ùÈõ¢: ‚Äî',
        result_time_est: 'ÁßªÂãïÊôÇÈñì (ÁõÆÂÆâ): ‚Äî ÂàÜ',
        result_pickup_info: 'Ëøé„Åà„ÅÆÊó•ÊôÇ: ‚Äî',
        price_go: 'ÂæÄË∑ØÊñôÈáë',
        total_price: 'ÂêàË®à',
        wait_fee: 'ÂæÖÊ©üÊñôÈáë',
        wait_time: 'ÂæÖÊ©üÊôÇÈñì',
        wait_free_label: 'ÁÑ°Êñô',
        wait_free: '0„Äú3ÊôÇÈñìÁÑ°Êñô',
        
        // ALERT V√Ä TH√îNG B√ÅO
        calculating_route: '„É´„Éº„Éà„ÇíË®àÁÆó‰∏≠...',
        route_error: '„É´„Éº„ÉàË®àÁÆó„Ç®„É©„Éº„ÄÇ',
        instruction_text_loading: 'Âá¶ÁêÜ‰∏≠...',
        instruction_text_active: 'ÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åó„ÄÅ‰∫àÁ¥Ñ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        alert_no_coord: '{0}„ÅÆÂ∫ßÊ®ô/‰ΩèÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        alert_no_address: 'Ëøé„Åà„Å®ÁõÆÁöÑÂú∞„ÅÆ‰∏°Êñπ„ÅÆ‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        alert_no_date: 'Ëøé„Åà„ÅÆÊó•ÊôÇ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        alert_no_price: '‰∫àÁ¥Ñ„Åô„ÇãÂâç„Å´„ÄåÊñôÈáë„Å®„É´„Éº„Éà„ÇíË®àÁÆó„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        alert_invalid_phone: 'ÁÑ°Âäπ„Å™ÈõªË©±Áï™Âè∑„Åß„Åô (0„Åã„ÇâÂßã„Åæ„Çã10Ê°Å„ÄÅ‰æã: 0987654321)„ÄÇ',
        alert_copied: '‰∫àÁ¥ÑÊÉÖÂ†±„ÅåÊ≠£Â∏∏„Å´„Ç≥„Éî„Éº„Åï„Çå„Åæ„Åó„ÅüÔºÅ',
        alert_copy_fail: 'Ëá™Âãï„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊâãÂãï„ÅßÈÅ∏Êäû„Åó„Å¶„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
        alert_mail_sent: 'ÊÉÖÂ†±„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅÆ„É°„Éº„É´„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÁµåÁî±„ÅßÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ',
        alert_service_off: 'Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅÁèæÂú®„Çµ„Éº„Éì„Çπ„ÅØ‰∏ÄÊôÇÁöÑ„Å´Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„Åô„ÄÇ‰∏äË®ò„ÅÆÈõªË©±Áï™Âè∑„Å´Áõ¥Êé•„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ',
        
        // TIN NH·∫ÆN ZALO/MAIL
        zalo_order_title: '„ÉÅ„É•„Ç™„É≥„Ç¢„É≥ „Éâ„É©„Ç§„Éì„É≥„Ç∞ ‰∫àÁ¥Ñ„É™„ÇØ„Ç®„Çπ„Éà',
        zalo_phone_label: '„ÅäÂÆ¢ÊßòÈõªË©±Áï™Âè∑',
        zalo_trip_type: 'Ëµ∞Ë°å„Çø„Ç§„Éó',
        zalo_car_type: 'ËªäÁ®Æ',
        zalo_driver_request: '„Éâ„É©„Ç§„Éê„Éº„Å∏„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà',
        zalo_pickup_point: 'Ëøé„Åà„ÅÆÂ†¥ÊâÄ',
        zalo_dropoff_point: 'ÁõÆÁöÑÂú∞„ÅÆÂ†¥ÊâÄ',
        zalo_pickup_time: 'Ëøé„Åà„ÅÆÊó•ÊôÇ',
        zalo_total_price: 'Ë¶ãÁ©ç„ÇÇ„ÇäÂêàË®àÊñôÈáë',
        zalo_stop_label: 'ÁµåÁî±Âú∞',
        zalo_waiting: 'ÂæÖÊ©üÊôÇÈñì',
        zalo_wait_fee: 'ËøΩÂä†ÂæÖÊ©üÊñôÈáë',
        zalo_note: '„ÅîÊ≥®Êñá„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ',
        zalo_deposit: '„Éá„Éù„Ç∏„ÉÉ„Éà',
        zalo_total_fee: 'ÂêàË®àÊñôÈáë',
        maps_link_title: 'Ê≠£Á¢∫„Å™Âú∞Âõ≥„É™„É≥„ÇØ',
        maps_link_pickup: 'Ëøé„Åà„ÅÆÂ†¥ÊâÄ (Â∫ßÊ®ô)',
        maps_link_dir: 'ÈÅìÈ†Ü (Ëøé„Åà -> ÁõÆÁöÑÂú∞)',

        // MODAL
        phone_modal_title: 'ÈõªË©±Áï™Âè∑„ÅÆÁ¢∫Ë™ç',
        phone_modal_instruction: '‰∫àÁ¥Ñ„ÇíÂÆå‰∫Ü„Åô„Çã„Åü„ÇÅ„Å´„ÄÅÈõªË©±Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:',
        deposit_modal_title: '‚ö†Ô∏è „Éá„Éù„Ç∏„ÉÉ„Éà„Å´Èñ¢„Åô„ÇãÊ≥®ÊÑè',
        deposit_modal_p1: 'Â∑û„Çí„Åæ„Åü„Åê**ÂæÄÂæ©**„ÅÆÁßªÂãï„ÅÆÂ†¥Âêà„ÄÅÂêàË®àÊñôÈáë„ÅÆ**20%**„ÅÆ„Éá„Éù„Ç∏„ÉÉ„Éà„Çí„ÅäÊîØÊâï„ÅÑ„Åè„Å†„Åï„ÅÑ„ÄÇ',
        deposit_modal_p2: '„Éá„Éù„Ç∏„ÉÉ„Éà„ÅÆË¶ãÁ©ç„ÇÇ„ÇäÈ°ç:',
        deposit_modal_note: '(„Åì„ÅÆÈáëÈ°ç„ÅØ„ÄÅÊóÖË°åÂÆå‰∫ÜÊôÇ„ÅÆÂêàË®àÈÅãË≥É„Åã„ÇâÂ∑Æ„ÅóÂºï„Åã„Çå„Åæ„Åô„ÄÇ)',
        zalo_modal_title: '‚úÖ ‰∫àÁ¥ÑÊÉÖÂ†±',
        zalo_modal_instruction: 'ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº„Åó„Å¶ZaloÁµåÁî±„ÅßÈÄÅ‰ø°„Åó„Å¶„Åè„Å†„Åï„ÅÑ:',
        stop_label: 'ÁµåÁî±Âú∞',
    },
};


// Ch·ªçn c√°c ph·∫ßn t·ª≠ DOM
const DOM_ELEMENTS = [
    'lang-switcher', 'pickup-address', 'dropoff-address', 'pickup-date-time', 'stops-container', 
    'add-stop-btn', 'car-type', 'trip-type', 'waiting-time', 'driver-request', 'calculate-btn', 
    'result-box', 'distance-text', 'price-value', 'price-breakdown', 'time-estimate', 'pickup-info', 
    'zalo-btn', 'mail-btn', 'instruction-text', 'map', 'offline-alert', 'reload-location-btn', 
    'customer-phone', 'phone-modal', 'input-phone-for-booking', 'confirm-phone-btn', 'close-phone-modal',
    'zalo-modal', 'modal-text', 'copy-modal-btn', 'zalo-modal-btn', 'close-modal-btn', 'deposit-modal', 
    'deposit-amount', 'confirm-deposit-btn', 'close-modal-btn-bottom'
];

const elements = {};
DOM_ELEMENTS.forEach(id => { elements[id] = document.getElementById(id); });

// C√°c ph·∫ßn t·ª≠ c·∫ßn d·ªãch thu·∫≠t tr·ª±c ti·∫øp tr√™n UI
const TRANSLATE_UI_IDS = [
    'label-phone', 'status-location', 'label-pickup', 'label-datetime', 'label-dropoff', 
    'label-cartype', 'label-triptype', 'label-waiting', 'unit-hours', 'label-driver-request',
    'calculate-btn', 'btn-zalo-text', 'btn-mail-text', 'result-title', 'label-total-price',
    'phone-modal-title', 'phone-modal-instruction', 'deposit-modal-title', 'deposit-modal-p1',
    'deposit-modal-p2', 'deposit-modal-note', 'zalo-modal-title', 'zalo-modal-instruction'
];

let map, markerPickup, markerDropoff, routeLayer;
let finalZaloMessage = '', finalTotalFee = 0, bookingAction = null, currentLang = 'vi', isServiceActive = true; 
let stopCounter = 0; // ƒê·ªÉ ƒë·∫øm ƒëi·ªÉm d·ª´ng

/* -------------------- PH·∫¶N LOGIC CHUNG V√Ä HELPER -------------------- */

// Kh·ªüi t·∫°o b·∫£n ƒë·ªì
function initMap() {
    if (map) return;
    const defaultCoords = [10.8231, 106.6297]; // TP. HCM
    map = L.map('map').setView(defaultCoords, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
}
initMap();


// H√†m c·∫≠p nh·∫≠t t·∫•t c·∫£ UI khi ƒë·ªïi ng√¥n ng·ªØ
function updateUI(lang) {
    const t = TRANSLATIONS[lang] || TRANSLATIONS['vi'];

    // 1. C·∫≠p nh·∫≠t c√°c nh√£n tƒ©nh (d√πng ID)
    TRANSLATE_UI_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = t[id] || t[id.replace(/-/g, '_')] || el.textContent;
    });

    // 2. C·∫≠p nh·∫≠t c√°c Options trong Select
    const selectElements = [elements['car-type'], elements['trip-type'], elements['driver-request']];
    selectElements.forEach(select => {
        if (select) {
            Array.from(select.options).forEach(option => {
                const langKey = 'data-lang-' + lang;
                if (option.hasAttribute(langKey)) {
                    option.textContent = option.getAttribute(langKey);
                }
            });
        }
    });

    // 3. C·∫≠p nh·∫≠t placeholder v√† label ƒëi·ªÉm d·ª´ng (n·∫øu c√≥)
    const stopInputs = Array.from(elements['stops-container'].querySelectorAll('input[id^="stop-"]'));
    stopInputs.forEach((input, index) => {
        const label = input.closest('.input-group').querySelector('.input-group-text');
        if (label) label.textContent = `${t.stop_label} ${index + 1}`;
        input.placeholder = `${t.stop_label} ${index + 1}`;
    });

    // 4. C·∫≠p nh·∫≠t n√∫t Th√™m ƒëi·ªÉm d·ª´ng
    elements['add-stop-btn'].textContent = t.add_stop_btn || '+ Th√™m ƒëi·ªÉm d·ª´ng';
    
    // 5. C·∫≠p nh·∫≠t tr·∫°ng th√°i Kill Switch n·∫øu ƒëang l·ªói
    if (!isServiceActive) {
         elements['offline-alert'].textContent = t.alert_service_off;
    }
}

// H√†m ƒë·ªïi ng√¥n ng·ªØ
function initLanguageSwitcher() {
    elements['lang-switcher'].addEventListener('change', (e) => {
        currentLang = e.target.value;
        updateUI(currentLang);
        // K√≠ch ho·∫°t l·∫°i vi·ªác t√≠nh to√°n ƒë·ªÉ c·∫≠p nh·∫≠t ng√¥n ng·ªØ tin nh·∫Øn Zalo n·∫øu k·∫øt qu·∫£ ƒë√£ c√≥
        if (finalTotalFee > 0) {
            calculateAndGenerateMessage();
        }
    });
    // Kh·ªüi t·∫°o ng√¥n ng·ªØ ban ƒë·∫ßu
    updateUI(currentLang);
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i d·ªãch v·ª• (Kill Switch)
async function checkServiceStatus() {
    try {
        const response = await fetch(STATUS_FILE + '?t=' + new Date().getTime()); 
        if (!response.ok) {
            throw new Error('L·ªói truy c·∫≠p file tr·∫°ng th√°i.');
        }
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('L·ªói Kill Switch:', error);
        return { active: true }; 
    }
}

async function updateUIBasedOnStatus(status) {
    isServiceActive = status.active;
    const t = TRANSLATIONS[currentLang];

    if (!isServiceActive) {
        elements['offline-alert'].textContent = t.alert_service_off;
        elements['offline-alert'].style.display = 'block';
        elements['calculate-btn'].disabled = true;
        elements['zalo-btn'].style.display = 'none';
        elements['mail-btn'].style.display = 'none';
    } else {
        elements['offline-alert'].style.display = 'none';
        elements['calculate-btn'].disabled = false;
    }
}

// Th√™m/X√≥a ƒëi·ªÉm d·ª´ng
elements['add-stop-btn'].addEventListener('click', () => {
    stopCounter++;
    const t = TRANSLATIONS[currentLang];
    const newStopDiv = document.createElement('div');
    newStopDiv.classList.add('input-group', 'mb-3');
    newStopDiv.innerHTML = `
        <label class="input-group-text">${t.stop_label} ${stopCounter}</label>
        <input type="text" class="form-control address-input stop-input" id="stop-${stopCounter}" placeholder="${t.stop_label} ${stopCounter}">
        <button class="btn btn-danger remove-stop-btn" type="button" onclick="removeStop(this)">X√≥a</button>
    `;
    elements['stops-container'].appendChild(newStopDiv);
});

function removeStop(button) {
    const stopDiv = button.closest('.input-group');
    elements['stops-container'].removeChild(stopDiv);
}


// X·ª≠ l√Ω t·ªça ƒë·ªô v√† b·∫£n ƒë·ªì
async function resolveCoordForInput(inputElement) {
    const address = inputElement.value.trim();
    if (!address) return null;

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
        const data = await response.json();

        if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            return [lat, lon];
        }
        return null;
    } catch (error) {
        console.error('Geocoding error:', error);
        return null;
    }
}

function updateMapMarker(lat, lon, address, isPickup = true) {
    if (!map) initMap();
    const markerText = isPickup ? `ƒê√≥n: ${address}` : `ƒê·∫øn: ${address}`;

    const dropoffIcon = L.icon({ 
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', 
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', 
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] 
    });

    if (isPickup) {
        if (markerPickup) map.removeLayer(markerPickup);
        markerPickup = L.marker([lat, lon]).addTo(map).bindPopup(markerText).openPopup();
    } else {
        if (markerDropoff) map.removeLayer(markerDropoff);
        markerDropoff = L.marker([lat, lon], { icon: dropoffIcon }).addTo(map).bindPopup(markerText).openPopup();
    }

    const markers = [];
    if (markerPickup) markers.push(markerPickup.getLatLng());
    if (markerDropoff) markers.push(markerDropoff.getLatLng());

    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
    } else {
        map.setView([lat, lon], 13);
    }
}

elements['pickup-address'].addEventListener('blur', async () => {
    const coord = await resolveCoordForInput(elements['pickup-address']);
    if (coord) updateMapMarker(coord[0], coord[1], elements['pickup-address'].value, true);
});

elements['dropoff-address'].addEventListener('blur', async () => {
    const coord = await resolveCoordForInput(elements['dropoff-address']);
    if (coord) updateMapMarker(coord[0], coord[1], elements['dropoff-address'].value, false);
});


// L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa kh√°ch h√†ng
function getGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                const address = data.display_name || `${lat}, ${lon}`;
                elements['pickup-address'].value = address;
                
                updateMapMarker(lat, lon, address, true);
                
                document.querySelector('.location-status').innerHTML = `‚úÖ ${TRANSLATIONS[currentLang].status_location.split(' ')[0]} <a href="#" onclick="event.preventDefault(); getGeolocation();" class="ms-1" style="font-size: 0.9em;">[T·∫£i l·∫°i]</a>`;

            } catch (error) {
                elements['pickup-address'].value = `${lat}, ${lon}`;
                document.querySelector('.location-status').textContent = '‚ö†Ô∏è L·ªói t√¨m ƒë·ªãa ch·ªâ. D√πng t·ªça ƒë·ªô.';
                console.error('Reverse Geocoding Error:', error);
            }

        }, (error) => {
            console.error('Geolocation error:', error);
            document.querySelector('.location-status').textContent = '‚ùå L·ªói ho·∫∑c b·ªã t·ª´ ch·ªëi.';
        });
    } else {
        document.querySelector('.location-status').textContent = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£.';
    }
}


// Validation
function validateRouteInputs() {
    const t = TRANSLATIONS[currentLang];
    if (elements['pickup-address'].value.trim() === '' || elements['dropoff-address'].value.trim() === '') {
        alert(t.alert_no_address);
        return false;
    }
    if (elements['pickup-date-time'].value === '') {
        alert(t.alert_no_date);
        return false;
    }
    return true;
}

function validatePhone(phone) {
    return /^0\d{9}$/.test(phone); 
}


// Thi·∫øt l·∫≠p th·ªùi gian ƒë√≥n t·ªëi thi·ªÉu (hi·ªán t·∫°i + 15 ph√∫t)
function formatDateTime(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart('2', '0');
    const d = String(date.getDate()).padStart('2', '0');
    const h = String(date.getHours()).padStart('2', '0');
    const min = String(date.getMinutes()).padStart('2', '0');
    return `${y}-${m}-${d}T${h}:${min}`;
}

function setMinPickupDateTime() {
    const minDate = new Date();
    minDate.setMinutes(minDate.getMinutes() + 15);
    
    const minDateTimeString = formatDateTime(minDate);
    elements['pickup-date-time'].setAttribute('min', minDateTimeString);
    
    if (!elements['pickup-date-time'].value || new Date(elements['pickup-date-time'].value) < minDate) {
        elements['pickup-date-time'].value = minDateTimeString;
    }
}


/* -------------------- LOGIC CH√çNH: T√çNH TO√ÅN V√Ä ƒê·∫∂T XE -------------------- */

async function calculateAndGenerateMessage() {
    const lang = currentLang;
    const t = TRANSLATIONS[lang];
    
    if (!validateRouteInputs()) return false; 
    
    // 1. Resolve t·ªça ƒë·ªô cho t·∫•t c·∫£ c√°c ƒëi·ªÉm
    const pickupCoord = await resolveCoordForInput(elements['pickup-address']);
    if(!pickupCoord){ alert(t.alert_no_coord.replace('{0}', t.pickup_label)); return false; }
    const dropoffCoord = await resolveCoordForInput(elements['dropoff-address']);
    if(!dropoffCoord){ alert(t.alert_no_coord.replace('{0}', t.dropoff_label)); return false; }

    const coords = [pickupCoord];
    const stopInputs = Array.from(elements['stops-container'].querySelectorAll('input[id^="stop-"]'));
    for(const s of stopInputs){
        if(s.value.trim()){
            const sc = await resolveCoordForInput(s);
            if(!sc){ 
                const match = s.id.match(/\d+/);
                const stopLabel = t.stop_label + (match ? ` ${match[0]}` : '');
                alert(t.alert_no_coord.replace('{0}', stopLabel)); 
                return false; 
            }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord);

    const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
    const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

    // 2. C·∫≠p nh·∫≠t UI Loading
    elements['result-box'].style.display = 'block';
    elements['distance-text'].textContent = t.result_distance.replace('‚Äî', t.calculating_route);
    elements['price-value'].textContent = '...';
    elements['price-breakdown'].innerHTML = '';
    elements['time-estimate'].textContent = t.result_time_est.replace('‚Äî', '...');
    finalZaloMessage = ''; finalTotalFee = 0;
    elements['zalo-btn'].style.display = 'none'; 
    elements['mail-btn'].style.display = 'none';
    elements['instruction-text'].innerHTML = t.instruction_text_loading; 

    try{
        // 3. G·ªçi OSRM API
        const r = await fetch(url);
        const data = await r.json();
        
        if(!data.routes || data.routes.length === 0){ 
            elements['distance-text'].textContent = t.result_distance.replace('‚Äî', t.route_error); 
            elements['price-value'].textContent = '‚Äî';
            elements['instruction-text'].innerHTML = t.alert_no_coord.replace('{0}', '');
            return false; 
        }
        
        const route = data.routes[0];
        const dist = route.distance / 1000; 
        const durationSec = route.duration;
        const minutes = Math.round(durationSec / 60);

        // 4. V·∫Ω l·∫°i b·∫£n ƒë·ªì
        if(map) {
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
        }

        // 5. T√≠nh to√°n gi√° c∆∞·ªõc
        const tripType = elements['trip-type'].value; 
        const carType = elements['car-type'].value; 
        const waiting = parseFloat(elements['waiting-time'].value) || 0; 
        
        let perKm;
        const carTypeKey = carType.includes('7 ch·ªó') ? 'car_7_seater' : 'car_4_seater';
        const carTypeText = t[carTypeKey];
        
        if (carType.includes('7 ch·ªó')) { perKm = 12000; } else { perKm = 10000; }
        const perKmReturnDiscount = Math.round(perKm * 0.6); 
        const priceGo = Math.round(dist * perKm);
        
        let priceReturn = 0;
        let returnNote = ''; 

        if(tripType === '2') {
            const finalPerKmReturn = dist >= 45 ? perKmReturnDiscount : perKm;
            priceReturn = Math.round(dist * finalPerKmReturn); 
            const tripTypeLabel = dist >= 45 ? t.trip_type_2 : t.trip_type_2_no_discount;
            returnNote = `${tripTypeLabel} (${finalPerKmReturn.toLocaleString(lang)}ƒë/${t.distance_unit})`;
        } else {
            returnNote = t.trip_type_1;
        }

        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total; 
        const depositAmountValue = Math.round(total * 0.2); 

        // 6. C·∫≠p nh·∫≠t UI K·∫øt qu·∫£
        elements['distance-text'].textContent = t.result_distance.replace('‚Äî', `${dist.toFixed(1)} ${t.distance_unit} (${t.one_way_trip})`);
        elements['price-value'].textContent = total.toLocaleString(lang) + ' ƒë';

        let breakdownHtml = '';
        breakdownHtml += `‚Ä¢ ${t.price_go} (${perKm.toLocaleString(lang)}ƒë/${t.distance_unit}): <b>${priceGo.toLocaleString(lang)} ƒë</b><br>`;
        
        if(tripType === '2'){
            breakdownHtml += `‚Ä¢ ${returnNote}: <b>${priceReturn.toLocaleString(lang)} ƒë</b><br>`;
        }

        if (tripType === '2' && waiting > 0) {
            const waitDetail = (waiting > 3)
                ? `${t.wait_fee} (${waiting} ${t.hours}, ${t.wait_free}): <b>${waitFee.toLocaleString(lang)} ƒë</b>`
                : `${t.wait_time} (${waiting} ${t.hours}): <b>${t.wait_free_label}</b>`;
            breakdownHtml += `‚Ä¢ ${waitDetail}<br>`;
        }
        
        breakdownHtml += `<hr style="margin:6px 0">‚Ä¢ <b>${t.total_price}: ${total.toLocaleString(lang)} ƒë</b>`;
        elements['price-breakdown'].innerHTML = breakdownHtml;

        elements['time-estimate'].textContent = t.result_time_est.replace('‚Äî', `${minutes}`);

        const dateVal = elements['pickup-date-time'].value;
        const formattedDate = dateVal ? new Date(dateVal).toLocaleString(lang, { 
            year: 'numeric', month: 'numeric', day: 'numeric', 
            hour: '2-digit', minute: '2-digit', 
            hour12: false 
        }) : t.not_selected;
        elements['pickup-info'].textContent = t.result_pickup_info.replace('‚Äî', formattedDate);
        
        // 7. T·∫°o tin nh·∫Øn Zalo/Mail
        
        const stopInputsValues = Array.from(elements['stops-container'].querySelectorAll('input[id^="stop-"]'))
            .map(s => s.value.trim()).filter(v => v);
        
        const stopDetails = stopInputsValues.map((v, i) => `üõ£Ô∏è ${t.zalo_stop_label} ${i+1}: ${v}`).join('\n');
        
        let zaloWaitingDetail = '';
        if (tripType === '2') {
            if (waiting > 3) {
                zaloWaitingDetail = `‚è≥ ${t.zalo_waiting}: ${waiting} ${t.hours} (${t.zalo_wait_fee}: ${waitFee.toLocaleString(lang)} ƒë)`;
            } else {
                zaloWaitingDetail = `‚è≥ ${t.zalo_waiting}: ${waiting} ${t.hours} (${t.wait_free_label})`;
            }
        }
        
        const pickupAddress = elements['pickup-address'].value.trim();
        const dropoffAddress = elements['dropoff-address'].value.trim();
        const pickupLatLon = `${pickupCoord[0]},${pickupCoord[1]}`;
        const dropoffLatLon = `${dropoffCoord[0]},${dropoffCoord[1]}`;
        
        let mapsLinksSection = [
            `\n*** üó∫Ô∏è ${t.maps_link_title} ***`,
            `üìç ${t.maps_link_pickup}: https://www.google.com/maps/search/${pickupLatLon}`,
            `üõ£Ô∏è ${t.maps_link_dir}: https://www.google.com/maps/dir/${pickupLatLon}/${dropoffLatLon}`,
            `\n`
        ].join('\n');
        
        let depositSection = '';
        if (tripType === '2') {
            depositSection = `\nüí∞ ${t.zalo_deposit}: ${depositAmountValue.toLocaleString(lang)} ƒë (20% ${t.zalo_total_fee})`;
        }
        
        finalZaloMessage = [
            `üöñ ${t.zalo_order_title}`,
            '-------------------------------',
            `üìû ${t.zalo_phone_label}: [CH∆ØA C√ì]`,
            `‚úÖ ${t.zalo_trip_type}: ${tripType === '1' ? t.trip_type_1 : `${t.trip_type_2.split('(')[0].trim()} (${dist.toFixed(1)} ${t.one_way_trip})`}`,
            `üöò ${t.zalo_car_type}: ${carTypeText}`, 
            `üßë‚Äç‚úàÔ∏è ${t.zalo_driver_request}: ${elements['driver-request'].value}`,
            `üìç ${t.zalo_pickup_point}: ${pickupAddress}`,
            ...(stopInputsValues.length ? [stopDetails] : []),
            `üèÅ ${t.zalo_dropoff_point}: ${dropoffAddress}`,
            `üïí ${t.zalo_pickup_time}: ${formattedDate}`,
            ...(tripType === '2' ? [zaloWaitingDetail] : []), 
            `üíµ ${t.zalo_total_price}: ${total.toLocaleString(lang)} ƒë`,
            depositSection,
            mapsLinksSection, 
            '-------------------------------',
            t.zalo_note,
        ].join('\n');

        // 8. Hi·ªÉn th·ªã n√∫t ƒë·∫∑t xe v√† cu·ªôn ƒë·∫øn k·∫øt qu·∫£
        elements['zalo-btn'].style.display = 'block'; 
        elements['mail-btn'].style.display = 'block'; 
        elements['instruction-text'].style.display = 'block';
        elements['instruction-text'].innerHTML = t.instruction_text_active;

        elements['result-box'].scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return true; 
    }catch(err){
        console.error('Route error', err);
        elements['distance-text'].textContent = t.alert_no_coord.replace('{0}', '...');
        elements['price-value'].textContent = '‚Äî';
        elements['mail-btn'].href = `mailto:netvuan@gmail.com`; 
        elements['zalo-btn'].style.display = 'none';
        elements['mail-btn'].style.display = 'none';
        elements['instruction-text'].innerHTML = t.alert_no_coord.replace('{0}', '');
        return false;
    }
}

// X·ª≠ l√Ω n√∫t T√≠nh gi√°
elements['calculate-btn'].addEventListener('click', async () => {
  const t = TRANSLATIONS[currentLang];
  if (!isServiceActive) {
      alert(t.alert_service_off);
      return;
  }
  
  const success = await calculateAndGenerateMessage();

  if(success && elements['trip-type'].value === '2') {
    const deposit = Math.round(finalTotalFee * 0.2);
    elements['deposit-amount'].textContent = deposit.toLocaleString(currentLang) + ' ƒë';
    elements['deposit-modal'].style.display = 'flex';
  }
});

// X·ª≠ l√Ω n√∫t ƒê·∫∑t qua Zalo / Mail
function handleBookingClick(action) {
    const t = TRANSLATIONS[currentLang];
    if (finalTotalFee === 0) {
        alert(t.alert_no_price);
        return;
    }
    
    bookingAction = action;
    const phone = elements['customer-phone'].value.trim();

    if (!validatePhone(phone)) {
        elements['input-phone-for-booking'].value = phone;
        elements['phone-modal'].style.display = 'flex';
        elements['input-phone-for-booking'].focus();
    } else {
        openFinalZaloModal(phone);
    }
}

elements['zalo-btn'].addEventListener('click', () => handleBookingClick('zalo'));
elements['mail-btn'].addEventListener('click', () => handleBookingClick('mail'));

// X·ª≠ l√Ω x√°c nh·∫≠n SƒêT trong Phone Modal
elements['confirm-phone-btn'].addEventListener('click', () => {
    const t = TRANSLATIONS[currentLang];
    const phone = elements['input-phone-for-booking'].value.trim();
    if (!validatePhone(phone)) {
        alert(t.alert_invalid_phone);
        elements['input-phone-for-booking'].focus();
        return;
    }
    elements['customer-phone'].value = phone; 
    elements['phone-modal'].style.display = 'none';

    if (bookingAction) {
        openFinalZaloModal(phone);
    }
});

elements['close-phone-modal'].addEventListener('click', () => {
    elements['phone-modal'].style.display = 'none';
    bookingAction = null; 
});
elements['phone-modal'].addEventListener('click', (e) => {
    if (e.target === elements['phone-modal']) {
        elements['phone-modal'].style.display = 'none';
        bookingAction = null; 
    }
});

// X·ª≠ l√Ω x√°c nh·∫≠n ƒë·∫∑t c·ªçc
elements['confirm-deposit-btn'].addEventListener('click', () => {
    elements['deposit-modal'].style.display = 'none';
});

// M·ªü Modal Zalo/Mail ch√≠nh
function openFinalZaloModal(phone) {
    const t = TRANSLATIONS[currentLang];
    let finalMessage = finalZaloMessage.replace('[CH∆ØA C√ì]', phone);
    elements['modal-text'].textContent = finalMessage;

    if(bookingAction === 'mail') {
        const zaloOrderTitle = t.zalo_order_title;
        const encodedMsg = encodeURIComponent(finalMessage);
        const subject = encodeURIComponent(`${zaloOrderTitle} - ${elements['distance-text'].textContent.split(': ')[1]}`);
        elements['mail-btn'].href = `mailto:netvuan@gmail.com?subject=${subject}&body=${encodedMsg}`;
        alert(t.alert_mail_sent);
        window.location.href = elements['mail-btn'].href;
        elements['zalo-modal'].style.display = 'none';
        bookingAction = null;
        return;
    }

    elements['zalo-modal'].style.display = 'flex'; 

    const range = document.createRange();
    range.selectNodeContents(elements['modal-text']);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    copyToClipboard(finalMessage).then(success => {
        if(success) console.log("ƒê√£ sao ch√©p tin nh·∫Øn Zalo th√†nh c√¥ng.");
    });

    bookingAction = null; 
}


async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.warn('Fallback: Copying directly from DOM');
        try {
            const success = document.execCommand('copy');
            return success;
        } catch (errFallback) {
            console.error('Kh√¥ng th·ªÉ th·ª±c hi·ªán sao ch√©p:', errFallback);
            return false;
        }
    }
}

elements['copy-modal-btn'].addEventListener('click', async () => {
    const t = TRANSLATIONS[currentLang];
    const range = document.createRange();
    range.selectNodeContents(elements['modal-text']);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    const success = await copyToClipboard(elements['modal-text'].textContent);
    
    if (success) {
        alert(t.alert_copied);
    } else {
        alert(t.alert_copy_fail);
    }
});

elements['zalo-modal-btn'].addEventListener('click', () => {
    window.getSelection().removeAllRanges(); 
    elements['zalo-modal'].style.display = 'none'; 
    window.open(ZALO_URL, '_blank');
});

elements['close-modal-btn'].addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    elements['zalo-modal'].style.display = 'none';
});

elements['close-modal-btn-bottom'].addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    elements['zalo-modal'].style.display = 'none';
});

/* -------------------- KH·ªûI T·∫†O V√Ä POLLING -------------------- */
document.addEventListener('DOMContentLoaded', async ()=>{
    initLanguageSwitcher(); 
    
    setMinPickupDateTime();
    
    getGeolocation();
    
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    // Polling tr·∫°ng th√°i d·ªãch v·ª• m·ªói 15 gi√¢y
    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
            console.log(`[Kill Switch] Tr·∫°ng th√°i ƒë√£ thay ƒë·ªïi. Active: ${newStatus.active}`);
        }
        setMinPickupDateTime(); 
    }, 15000); 
    
    elements['reload-location-btn'].addEventListener('click', getGeolocation); 
});

// PWA: ƒêƒÉng k√Ω Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js') 
      .then((reg) => {
        console.log('Service worker registered.', reg);
      })
      .catch((err) => {
        console.log('Service worker registration failed: ', err);
      });
  });
}
</script>
</body>
</html>
