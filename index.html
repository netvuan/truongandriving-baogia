<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TR∆Ø·ªúNG AN DRIVING</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        /* General Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* Header */
        header { background-color: #27ae60; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        header h1 { margin: 0; font-size: 1.2em; }
        .lang-switcher { display: flex; gap: 5px; }
        .lang-btn { background: none; border: 1px solid rgba(255,255,255,0.5); color: #fff; padding: 3px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em; transition: background-color 0.2s; }
        .lang-btn.active { background-color: #1e8449; border-color: #1e8449; font-weight: bold; }
        
        /* Section Styling */
        .section { padding: 20px; border-bottom: 8px solid #f0f2f5; }
        .section h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: #27ae60; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px; }
        
        /* Input Group */
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 10px 40px 10px 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .input-group select { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%2327ae60" d="M7 10l5 5 5-5z"/></svg>'); background-repeat: no-repeat; background-position: right 10px center; padding-right: 40px; }
        .input-group textarea { resize: vertical; min-height: 80px; padding-right: 10px; }

        /* Tools buttons for inputs */
        .tools { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); display: flex; gap: 5px; }
        .tools-top { position: absolute; right: 5px; top: 5px; display: flex; gap: 5px; }
        .btn-icon { background: none; border: none; color: #27ae60; cursor: pointer; padding: 5px; font-size: 1em; line-height: 1; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { color: #1e8449; }
        .btn-x { font-weight: bold; font-size: 1.2em; color: #aaa; display: none; } /* Clear input button */

        /* Suggestions Box */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background-color: #fff; border: 1px solid #ddd; border-top: none; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; border-radius: 0 0 8px 8px; }
        .sug-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .sug-item:hover { background-color: #f5f5f5; }
        .sug-item:last-child { border-bottom: none; }

        /* Route Section */
        #route-box { position: relative; }
        #stops-box { border-left: 2px dashed #ccc; padding-left: 10px; margin-left: 10px; }
        .stop-item { margin-left: 10px; position: relative; }
        .stop-item input { padding-right: 75px; }
        .stop-item .tools { right: 5px; }
        
        /* Buttons */
        .btn-full { width: 100%; padding: 15px; background-color: #27ae60; color: #fff; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background-color 0.2s; }
        .btn-full:hover:not(:disabled) { background-color: #1e8449; }
        .btn-full:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #btn-myloc { background-color: #3498db; margin-top: 0; }
        #btn-myloc:hover:not(:disabled) { background-color: #2980b9; }

        /* Result Box */
        #result-box { display: none; padding: 20px; background-color: #ecf0f1; border-radius: 8px; margin-top: 20px; }
        #result-box h3 { color: #e67e22; margin-top: 0; font-size: 1.1em; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.95em; }
        .result-row strong { color: #27ae60; font-size: 1.1em; }
        .result-row s { color: #999; text-decoration: line-through; }
        .total-price { text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; }
        .total-price strong { font-size: 1.5em; color: #e74c3c; }
        
        .note-box { font-size: 0.8em; color: #7f8c8d; margin-top: 15px; padding: 10px; background-color: #f9f9f9; border-left: 3px solid #3498db; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn-group .btn-book { flex: 1; padding: 15px 10px; font-size: 1em; border-radius: 8px; font-weight: bold; }
        #btn-zalo { background-color: #3498db; }
        #btn-mail { background-color: #e67e22; }
        #btn-zalo:hover { background-color: #2980b9; }
        #btn-mail:hover { background-color: #d35400; }

        /* Map Section */
        #main-map { height: 250px; width: 100%; margin-top: 20px; border-radius: 8px; border: 1px solid #ccc; }

        /* Modal for Map Picker */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 0; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19); }
        .modal-header { padding: 10px 15px; background-color: #27ae60; color: white; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h4 { margin: 0; font-size: 1em; }
        .modal-body { padding: 15px; }
        #picker-map { height: 300px; width: 100%; margin-bottom: 10px; }
        .map-marker { position: absolute; top: 50%; left: 50%; width: 30px; height: 30px; margin-left: -15px; margin-top: -30px; font-size: 30px; color: #e74c3c; text-align: center; pointer-events: none; z-index: 2001; }
        
        /* Phone Modal */
        #phone-modal .modal-content { max-width: 350px; }
        #phone-modal p { margin-bottom: 15px; font-size: 0.9em; }
        .modal-footer { display: flex; justify-content: flex-end; padding: 10px 15px; border-top: 1px solid #eee; gap: 10px; }
        .modal-footer button { padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #btn-phone-cancel { background-color: #ccc; border: none; }
        #btn-phone-confirm { background-color: #27ae60; color: white; border: none; }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            .container { box-shadow: none; }
            .section { padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 data-i18n="brand">TR∆Ø·ªúNG AN DRIVING</h1>
            <div class="lang-switcher">
                <button class="lang-btn active" onclick="setLang('vi')">VN</button>
                <button class="lang-btn" onclick="setLang('en')">EN</button>
                <button class="lang-btn" onclick="setLang('cn')">CN</button>
            </div>
        </header>

        <div class="section">
            <h2 data-i18n="sec_info">üìã TH√îNG TIN</h2>
            <div class="input-group">
                <label data-i18n="lbl_phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="tel" id="phone" placeholder="VD: 0912345678" data-i18n="plh_phone">
                <div class="tools"><button class="btn-icon btn-x" onclick="clearInp('phone')">‚úï</button></div>
            </div>
            <div class="input-group">
                <label data-i18n="lbl_time">Th·ªùi gian ƒë√≥n:</label>
                <input type="datetime-local" id="time">
            </div>
        </div>
        
        <div class="section" id="route-box">
            <h2 data-i18n="sec_route">üó∫Ô∏è L·ªò TR√åNH</h2>
            
            <button class="btn-full" id="btn-myloc" onclick="getMyLoc()" data-i18n="btn_myloc">üéØ V·ªã tr√≠ t√¥i</button>

            <div class="input-group">
                <label data-i18n="lbl_pickup">ƒêi·ªÉm ƒë√≥n:</label>
                <input type="text" id="pickup" placeholder="VD: 200 ƒê·ªìng Kh·ªüi, Qu·∫≠n 1" data-i18n="plh_pickup">
                <div id="sug-pickup" class="suggestions"></div>
                <div class="tools-top"><button class="btn-icon btn-map" onclick="openMap('pickup')">üó∫Ô∏è</button><button class="btn-icon btn-x" onclick="clearInp('pickup')">‚úï</button></div>
            </div>

            <div id="stops-box"></div>

            <button class="btn-full" onclick="addStop()" data-i18n="btn_add_stop">+ Th√™m ƒëi·ªÉm d·ª´ng</button>

            <div class="input-group">
                <label data-i18n="lbl_dropoff">ƒêi·ªÉm ƒë·∫øn:</label>
                <input type="text" id="dropoff" placeholder="VD: S√¢n bay T√¢n S∆°n Nh·∫•t (TSN)" data-i18n="plh_dropoff">
                <div id="sug-dropoff" class="suggestions"></div>
                <div class="tools-top"><button class="btn-icon btn-map" onclick="openMap('dropoff')">üó∫Ô∏è</button><button class="btn-icon btn-x" onclick="clearInp('dropoff')">‚úï</button></div>
            </div>
        </div>

        <div class="section">
            <h2 data-i18n="sec_opt">üöò T√ôY CH·ªåN</h2>
            
            <div class="input-group">
                <label data-i18n="lbl_car">Lo·∫°i xe:</label>
                <select id="carType">
                    <option value="4" data-i18n="opt_4seat">üöó Xe 4 ch·ªó (10k/km)</option>
                    <option value="7" data-i18n="opt_7seat">üöê Xe 7 ch·ªó (12k/km)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label data-i18n="lbl_type">H√¨nh th·ª©c:</label>
                <select id="tripType" onchange="toggleWait()">
                    <option value="1" data-i18n="opt_1way">‚û°Ô∏è 1 Chi·ªÅu</option>
                    <option value="2" data-i18n="opt_2way">üîÑ 2 Chi·ªÅu (∆Øu ƒë√£i)</option>
                </select>
            </div>

            <div class="input-group" id="wait-area" style="display: none;">
                <label data-i18n="lbl_wait">‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):</label>
                <input type="number" id="waitHour" value="4" min="0" step="1">
            </div>

            <div class="input-group">
                <label data-i18n="lbl_driver">T√†i x·∫ø:</label>
                <select id="driverType">
                    <option value="system" data-i18n="opt_system">‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)</option>
                </select>
            </div>

            <div class="input-group">
                <label data-i18n="lbl_note">üìù Y√™u c·∫ßu/Ghi ch√∫:</label>
                <textarea id="note" placeholder="VD: ƒê√≥n ƒë√∫ng gi·ªù, xe s·∫°ch s·∫Ω, c√≥ b·∫≠t nh·∫°c tr·ªØ t√¨nh." data-i18n="plh_note"></textarea>
            </div>
            
            <button class="btn-full" id="btn-calc" onclick="calculate()" data-i18n="btn_calc">üí∞ T√çNH GI√Å C∆Ø·ªöC</button>

            <div id="main-map"></div>

            <div id="result-box">
                <h3 data-i18n="lbl_est_price">Gi√° d·ª± ki·∫øn</h3>
                
                <div class="result-row"><span data-i18n="res_dist">Qu√£ng ƒë∆∞·ªùng:</span> <strong id="res-km">0 km</strong></div>
                <div class="result-row"><span data-i18n="res_time">Th·ªùi gian:</span> <strong id="res-min">0 min</strong></div>
                
                <hr>
                
                <div class="result-row" id="row-go"><span data-i18n="res_go_price">Gi√° chi·ªÅu ƒëi:</span> <strong id="val-go">0 ƒë</strong></div>
                
                <div class="result-row" id="row-back-full" style="display: none;"><span data-i18n="res_back_full">Gi√° chi·ªÅu v·ªÅ (Ch∆∞a gi·∫£m):</span> <strong id="val-back-full"><s>0 ƒë</s></strong></div>
                <div class="result-row" id="row-back-disc" style="display: none;"><span data-i18n="res_return_disc">Gi√° chi·ªÅu v·ªÅ (Sau gi·∫£m):</span> <strong id="val-back-disc">0 ƒë</strong></div>

                <div class="result-row" id="row-wait" style="display: none;"><span data-i18n="res_wait_fee">Ph√≠ ch·ªù (Sau 3h):</span> <strong id="val-wait">0 ƒë</strong></div>
                
                <div class="result-row" id="row-deposit" style="display: none;"><span data-i18n="res_deposit">C·ªçc (20%):</span> <strong id="val-deposit">0 ƒë</strong></div>
                
                <div class="total-price">
                    <span data-i18n="res_total_final">**T·ªîNG C·ªòNG (Ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i):**</span>
                    <strong id="res-total">0 ƒë</strong>
                </div>

                <div class="note-box">
                    <span data-i18n="note_price">Gi√° 4 ch·ªó: 10k/km | 7 ch·ªó: 12k/km.</span><br>
                    <span data-i18n="note_disc">ƒêi 2 chi·ªÅu (1 chi·ªÅu >45km / T·ªïng >90km) gi·∫£m 40% chi·ªÅu v·ªÅ.</span><br>
                    <span data-i18n="note_wait">Ch·ªù: Mi·ªÖn ph√≠ 3h ƒë·∫ßu. Sau ƒë√≥ 50k/h.</span>
                </div>

                <div class="btn-group">
                    <button class="btn-book" id="btn-zalo" onclick="preBook('zalo')">ƒê·∫∑t qua Zalo</button>
                    <button class="btn-book" id="btn-mail" onclick="preBook('mail')">ƒê·∫∑t qua Mail</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-map" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 data-i18n="modal_map_title">Ch·ªçn v·ªã tr√≠</h4>
                <span class="btn-icon" onclick="closeMap()">‚úï</span>
            </div>
            <div class="modal-body">
                <div id="picker-map"></div>
                <div class="map-marker">üìç</div>
                <button class="btn-full" onclick="confirmMap()" data-i18n="btn_confirm">X√ÅC NH·∫¨N</button>
            </div>
        </div>
    </div>

    <div id="phone-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 data-i18n="modal_phone_title">Nh·∫≠p S·ªë ƒêi·ªán Tho·∫°i</h4>
            </div>
            <div class="modal-body">
                <p data-i18n="modal_phone_desc">Nh√† xe c·∫ßn SƒêT ƒë·ªÉ li√™n h·ªá ƒë√≥n b·∫°n:</p>
                <input type="tel" id="quick-phone" class="input-group" placeholder="VD: 0912345678">
            </div>
            <div class="modal-footer">
                <button id="btn-phone-cancel" onclick="closePhoneModal()" data-i18n="btn_cancel">H·ªßy</button>
                <button id="btn-phone-confirm" onclick="savePhoneAndBook()" data-i18n="btn_ok">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n6n+ByMhPIeT5vJ9Q9gD9P54p2aA6r3sS9W7xLg5E=" crossorigin=""></script>

    <script>
        const LANG={
            vi:{
                brand:"TR∆Ø·ªúNG AN DRIVING",sec_info:"üìã TH√îNG TIN",lbl_phone:"S·ªë ƒëi·ªán tho·∫°i:",lbl_time:"Th·ªùi gian ƒë√≥n:",sec_route:"üó∫Ô∏è L·ªò TR√åNH",btn_myloc:"üéØ V·ªã tr√≠ t√¥i",lbl_pickup:"ƒêi·ªÉm ƒë√≥n:",lbl_dropoff:"ƒêi·ªÉm ƒë·∫øn:",btn_add_stop:"+ Th√™m ƒëi·ªÉm d·ª´ng",sec_opt:"üöò T√ôY CH·ªåN",lbl_car:"Lo·∫°i xe:",opt_4seat:"üöó Xe 4 ch·ªó (10k/km)",opt_7seat:"üöê Xe 7 ch·ªó (12k/km)",lbl_type:"H√¨nh th·ª©c:",opt_1way:"‚û°Ô∏è 1 Chi·ªÅu",opt_2way:"üîÑ 2 Chi·ªÅu (∆Øu ƒë√£i)",lbl_wait:"‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):",lbl_driver:"T√†i x·∫ø:",opt_system:"‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)",lbl_note:"üìù Y√™u c·∫ßu/Ghi ch√∫:",btn_calc:"üí∞ T√çNH GI√Å C∆Ø·ªöC",lbl_est_price:"Gi√° d·ª± ki·∫øn",res_dist:"Qu√£ng ƒë∆∞·ªùng:",res_time:"Th·ªùi gian:",res_go_price:"Gi√° chi·ªÅu ƒëi:",res_back_full:"Gi√° chi·ªÅu v·ªÅ (Ch∆∞a gi·∫£m):",res_return_disc:"Gi√° chi·ªÅu v·ªÅ (Sau gi·∫£m):",res_wait_fee:"Ph√≠ ch·ªù (sau 3h):",res_deposit:"ƒê·∫∑t c·ªçc (20%):",res_total_final:"**T·ªîNG C·ªòNG (Ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i):**",note_price:"Gi√° 4 ch·ªó: 10k/km | 7 ch·ªó: 12k/km",note_disc:"ƒêi 2 chi·ªÅu (1 chi·ªÅu >45km / T·ªïng >90km) gi·∫£m 40% chi·ªÅu v·ªÅ.",note_wait:"Ch·ªù: Mi·ªÖn ph√≠ 3h ƒë·∫ßu. Sau ƒë√≥ 50k/h.",note_fee:"Gi√° ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i.",modal_map_title:"Ch·ªçn v·ªã tr√≠",btn_confirm:"X√ÅC NH·∫¨N",modal_phone_title:"Nh·∫≠p S·ªë ƒêi·ªán Tho·∫°i",modal_phone_desc:"Nh√† xe c·∫ßn SƒêT ƒë·ªÉ li√™n h·ªá ƒë√≥n b·∫°n:",btn_cancel:"H·ªßy",btn_ok:"X√°c nh·∫≠n",
                plh_phone:"VD: 0912345678", plh_pickup:"VD: 200 ƒê·ªìng Kh·ªüi, Qu·∫≠n 1", plh_dropoff:"VD: S√¢n bay T√¢n S∆°n Nh·∫•t (TSN)", plh_stop:"ƒê·ªãa ch·ªâ ƒëi·ªÉm d·ª´ng (n·∫øu c√≥)...", plh_note:"VD: ƒê√≥n ƒë√∫ng gi·ªù, xe s·∫°ch s·∫Ω, c√≥ b·∫≠t nh·∫°c tr·ªØ t√¨nh."
            },
            en:{
                brand:"TRUONG AN DRIVING",sec_info:"üìã INFORMATION",lbl_phone:"Phone Number:",lbl_time:"Pickup Time:",sec_route:"üó∫Ô∏è ROUTE",btn_myloc:"üéØ My Location",lbl_pickup:"Pick-up:",lbl_dropoff:"Drop-off:",btn_add_stop:"+ Add Stop",sec_opt:"üöò OPTIONS",lbl_car:"Car Type:",opt_4seat:"üöó 4 Seats (10k/km)",opt_7seat:"üöê 7 Seats (12k/km)",lbl_type:"Trip Type:",opt_1way:"‚û°Ô∏è One way",opt_2way:"üîÑ Round trip",lbl_wait:"‚è≥ Waiting (Free 3h):",lbl_driver:"Driver:",opt_system:"‚≠ê System (Fastest)",lbl_note:"üìù Request/Note:",btn_calc:"üí∞ CALCULATE PRICE",lbl_est_price:"Estimated Price",res_dist:"Distance:",res_time:"Duration:",res_go_price:"One-way Price:",res_back_full:"Return Price (Before Disc.):",res_return_disc:"Return Price (After Discount):",res_wait_fee:"Waiting Fee (After 3h):",res_deposit:"Deposit (20%):",res_total_final:"**TOTAL (Tolls/Parking not included):**",note_price:"4 Seats: 10k/km | 7 Seats: 12k/km",note_disc:"Round trip (One-way >45km / Total >90km) get 40% off return.",note_wait:"Waiting: Free first 3h. Then 50k/h.",note_fee:"Tolls/Parking not included.",modal_map_title:"Pick Location",btn_confirm:"CONFIRM",modal_phone_title:"Enter Phone Number",modal_phone_desc:"We need your phone to contact:",btn_cancel:"Cancel",btn_ok:"Confirm",
                plh_phone:"Ex: 0912345678", plh_pickup:"Ex: 200 Dong Khoi, Dist 1", plh_dropoff:"Ex: Tan Son Nhat Airport (TSN)", plh_stop:"Stop address (if any)...", plh_note:"Ex: Be on time, clean car, soft music."
            },
            cn:{
                brand:"ÈïøÂÆâÈ©æÈ©∂",sec_info:"üìã ‰ø°ÊÅØ",lbl_phone:"ÁîµËØùÂè∑Á†Å:",lbl_time:"Êé•ËΩ¶Êó∂Èó¥:",sec_route:"üó∫Ô∏è Ë∑ØÁ∫ø",btn_myloc:"üéØ ÊàëÁöÑ‰ΩçÁΩÆ",lbl_pickup:"‰∏äËΩ¶Âú∞ÁÇπ:",lbl_dropoff:"‰∏ãËΩ¶Âú∞ÁÇπ:",btn_add_stop:"+ Â¢ûÂä†Á´ôÁÇπ",sec_opt:"üöò ËΩ¶ÂûãÈÄâÊã©",lbl_car:"ËΩ¶Âûã:",opt_4seat:"üöó 4Â∫ß (10k/km)",opt_7seat:"üöê 7Â∫ß (12k/km)",lbl_type:"Ë°åÁ®ãÁ±ªÂûã:",opt_1way:"‚û°Ô∏è ÂçïÁ®ã",opt_2way:"üîÑ ÂæÄËøî",lbl_wait:"‚è≥ Á≠âÂæÖ (ÂÖçË¥π3h):",lbl_driver:"Âè∏Êú∫:",opt_system:"‚≠ê Á≥ªÁªüÂàÜÈÖç (ÊúÄÂø´)",lbl_note:"üìù Ë¶ÅÊ±Ç/Â§áÊ≥®:",btn_calc:"üí∞ ËÆ°ÁÆó‰ª∑Ê†º",lbl_est_price:"È¢ÑËÆ°‰ª∑Ê†º",res_dist:"Ë∑ùÁ¶ª:",res_time:"Êó∂Èó¥:",res_go_price:"ÂçïÁ®ã‰ª∑Ê†º:",res_back_full:"ËøîÁ®ã‰ª∑Ê†º (ÊäòÊâ£Ââç):",res_return_disc:"ËøîÁ®ã‰ª∑Ê†º (ÊäòÊâ£Âêé):",res_wait_fee:"Á≠âÂæÖË¥π (Ë∂ÖËøá3Â∞èÊó∂):",res_deposit:"ÂÆöÈáë (20%):",res_total_final:"**ÊÄª‰ª∑ (‰∏çÂê´ËøáË∑ØË¥π/ÂÅúËΩ¶Ë¥π):**",note_price:"4Â∫ß: 10k/km | 7Â∫ß: 12k/km",note_disc:"ÂæÄËøî (ÂçïÁ®ã>45km / ÊÄªÁ®ã>90km) ËøîÁ®ãÂáè40%„ÄÇ",note_wait:"Á≠âÂæÖ: Ââç3Â∞èÊó∂ÂÖçË¥π„ÄÇ‰πãÂêé 50k/Â∞èÊó∂„ÄÇ",note_fee:"‰ª∑Ê†º‰∏çÂê´ËøáË∑ØË¥π/ÂÅúËΩ¶Ë¥π„ÄÇ",modal_map_title:"ÈÄâÊã©‰ΩçÁΩÆ",btn_confirm:"Á°ÆËÆ§",modal_phone_title:"ËæìÂÖ•ÁîµËØùÂè∑Á†Å",modal_phone_desc:"Êàë‰ª¨ÈúÄË¶ÅÊÇ®ÁöÑÁîµËØùÂè∑Á†Å‰ª•‰æøËÅîÁ≥ª:",btn_cancel:"ÂèñÊ∂à",btn_ok:"Á°ÆËÆ§",
                plh_phone:"‰æã: 0912345678", plh_pickup:"‰æã: 200 ƒê·ªìng Kh·ªüi, 1Âå∫", plh_dropoff:"‰æã: T√¢n S∆°n Nh·∫•t Airport (TSN)", plh_stop:"ÂÅúÈù†ÁÇπÂú∞ÂùÄ...", plh_note:"‰æã: ÂáÜÊó∂Êé•ËΩ¶ÔºåËΩ¶ÂÜÖÂπ≤ÂáÄÔºåÊí≠ÊîæËàíÁºìÈü≥‰πê„ÄÇ"
            }
        };
        let curLang='vi';
        const CFG={p4:10000,p7:12000,wait:50000};
        
        let map,pickerMap,routeL,activeInp,pendingMethod;
        let cachedPrices = {go: 0, back_full: 0, back_disc: 0, wait: 0, deposit: 0, total: 0, isDiscounted: false, km: 0, time: 0};
        let isSelecting = false; // Bi·∫øn c·ªù m·ªõi ƒë·ªÉ ki·ªÉm so√°t s·ª± ki·ªán sau khi ch·ªçn g·ª£i √Ω (Gi·ªØ l·∫°i c·ªù n√†y ƒë·ªÉ fix mobile)

        window.onload=()=>{
            // Kh·ªüi t·∫°o b·∫£n ƒë·ªì ch√≠nh (S·ª≠ d·ª•ng OpenStreetMap)
            try {
                map=L.map('main-map').setView([10.7769,106.7009],13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            } catch(e) {
                console.error("L·ªói kh·ªüi t·∫°o Leaflet/B·∫£n ƒë·ªì ch√≠nh:", e);
            }

            let now=new Date(); now.setMinutes(now.getMinutes()+30-now.getTimezoneOffset());
            document.getElementById('time').value=now.toISOString().slice(0,16);
            setupInp('phone');setupAddressInputs('pickup');setupAddressInputs('dropoff');
            setLang('vi');
        };

        function setLang(lang){
            curLang=lang;
            document.querySelectorAll('[data-i18n]').forEach(el=>{
                const key=el.getAttribute('data-i18n');
                if(LANG[lang][key]){
                    if(el.tagName === 'OPTION' && key.startsWith('opt_')){
                        el.textContent = LANG[lang][key];
                    } else if(el.tagName === 'INPUT' && key.startsWith('plh_')) {
                        el.placeholder = LANG[lang][key];
                    } else if(el.tagName === 'TEXTAREA' && key.startsWith('plh_')) {
                         el.placeholder = LANG[lang][key];
                    } else {
                        el.textContent=LANG[lang][key];
                    }
                }
            });
            // Update placeholders for specific fields manually
            document.getElementById('phone').placeholder = LANG[lang].plh_phone;
            document.getElementById('pickup').placeholder = LANG[lang].plh_pickup;
            document.getElementById('dropoff').placeholder = LANG[lang].plh_dropoff;
            document.getElementById('note').placeholder = LANG[lang].plh_note;
            document.querySelectorAll('.stop-inp').forEach(inp => inp.placeholder = LANG[lang].plh_stop);


            document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLang('${lang}')"]`).classList.add('active');

            if(cachedPrices.total > 0) updateResultDisplay();
        }


        function setupInp(id){
            let el=document.getElementById(id);
            el.addEventListener('input',function(){toggleX(this)}); 
            el.addEventListener('focus',()=>toggleX(el));
        }
        
        function setupAddressInputs(id){
            let el=document.getElementById(id);
            el.addEventListener('input',function(){
                if (isSelecting) { isSelecting = false; return; }
                toggleX(this);
                searchAddr(this); 
            });
            el.addEventListener('focus',function(){
                if (isSelecting) { isSelecting = false; return; }
                toggleX(el);
                if (el.value.length >= 3) searchAddr(el);
            });
            el.addEventListener('blur', function() {
                setTimeout(hideSuggestions, 100); 
            });
        }

        function hideSuggestions(){
            document.querySelectorAll('.suggestions').forEach(s=>s.style.display='none');
        }
        
        function toggleX(i){let b=i.parentElement.querySelector('.btn-x');if(b)b.style.display=i.value?'flex':'none'}
        function clearInp(id){let i=document.getElementById(id);i.value='';delete i.dataset.lat;delete i.dataset.lon;toggleX(i);document.getElementById(`sug-${id}`).style.display='none';}

        let timer;
        // T√åM KI·∫æM ƒê·ªäA CH·ªà S·ª¨ D·ª§NG NOMINATIM (Phi√™n b·∫£n G·ªêC)
        function searchAddr(inp){
            clearTimeout(timer);
            let box=inp.parentElement.querySelector('.suggestions');
            let valueToSearch = inp.value.trim();
            box.innerHTML='';
            if(valueToSearch.length<3){box.style.display='none';return}
            
            // 1. X·ª≠ l√Ω T·ªça ƒë·ªô d·∫•u ph·∫©y (lat, lon) HO·∫∂C Plus Code (∆Øu ti√™n: nhanh nh·∫•t)
            let coordParts = valueToSearch.match(/^(-?\s*\d+([,.]\d+)*)\s*,\s*(-?\s*\d+([,.]\d+)*)$/);
            
            if (coordParts) {
                let lat = coordParts[1].trim().replace(/,/g, '.').replace(/\s/g, '');
                let lon = coordParts[3].trim().replace(/,/g, '.').replace(/\s/g, '');
                if (!isNaN(parseFloat(lat)) && !isNaN(parseFloat(lon))) {
                    reverseGeocode(lat, lon, inp); 
                    box.style.display = 'none';
                    return;
                }
            }
            
            // 2. T√¨m ki·∫øm ƒê·ªãa ch·ªâ th√¥ng th∆∞·ªùng: D√πng Nominatim API
            timer=setTimeout(()=>{
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(valueToSearch)}&format=json&limit=5&addressdetails=0`; // URL G·ªêC, KH√îNG C√ì countrycodes=vn
                
                fetch(url)
                .then(r=>r.json()).then(d=>{
                    if(!d || d.length===0){box.style.display='none';return}
                    
                    hideSuggestions();

                    d.forEach(i=>{
                        let div=document.createElement('div');div.className='sug-item';
                        let name = i.display_name;
                        let lat = parseFloat(i.lat).toFixed(6); 
                        let lon = parseFloat(i.lon).toFixed(6); 

                        div.innerText=`üìç ${name}`;
                        div.onmousedown=(e)=>{ 
                            e.preventDefault(); 
                            isSelecting = true; 
                            inp.value=name;
                            inp.dataset.lat=lat;
                            inp.dataset.lon=lon;
                            hideSuggestions(); 
                            toggleX(inp);
                            inp.dispatchEvent(new Event('input')); 
                        };
                        box.appendChild(div);
                    });
                    box.style.display='block';
                })
                .catch(e => { console.error("L·ªói t√¨m ki·∫øm ƒë·ªãa ch·ªâ (Nominatim API):", e); box.style.display='none'; });
            },250); 
        }
        
        // TRA NG∆Ø·ª¢C T·ªåA ƒê·ªò S·ª¨ D·ª§NG NOMINATIM (Phi√™n b·∫£n G·ªêC)
        function reverseGeocode(lat, lon, inp) {
            const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=18&addressdetails=0`;
            fetch(url)
            .then(r=>r.json()).then(d=>{
                const fixedLat = parseFloat(lat).toFixed(6);
                const fixedLon = parseFloat(lon).toFixed(6);
                if(d.display_name) {
                    inp.value = d.display_name;
                } else {
                    inp.value = `${fixedLat}, ${fixedLon}`; 
                }
                inp.dataset.lat = fixedLat;
                inp.dataset.lon = fixedLon;
                toggleX(inp);
            })
            .catch(e => { 
                console.error("L·ªói Reverse Geocoding (Nominatim):", e); 
                inp.value = `${parseFloat(lat).toFixed(6)}, ${parseFloat(lon).toFixed(6)}`; 
                inp.dataset.lat = parseFloat(lat).toFixed(6);
                inp.dataset.lon = parseFloat(lon).toFixed(6);
                toggleX(inp); 
            });
        }

        document.addEventListener('click',e=>{if(!e.target.closest('.input-group'))hideSuggestions()});

        function addStop(){
            let plh = LANG[curLang].plh_stop;
            let newId = 'stop-' + Date.now();
            let div=document.createElement('div');div.className='input-group stop-item';
            
            div.innerHTML=`<input type="text" id="${newId}" class="stop-inp" placeholder="${plh}"><div id="sug-${newId}" class="suggestions"></div><div class="tools"><button class="btn-icon btn-trash" onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button><button class="btn-icon btn-map" onclick="openMapStop(this)">üó∫Ô∏è</button></div>`;
            document.getElementById('stops-box').appendChild(div);
            setupAddressInputs(newId); 
        }
        function openMapStop(btn){activeInp=btn.parentElement.parentElement.querySelector('input');openModalMap()}
        function openMap(id){activeInp=document.getElementById(id);openModalMap()}
        function openModalMap(){
            document.getElementById('modal-map').style.display='flex';
            try {
                if(!pickerMap){
                    pickerMap=L.map('picker-map').setView([10.7769,106.7009],13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);
                }
                setTimeout(()=>pickerMap.invalidateSize(),200);
                
                // ƒê·∫∑t v·ªã tr√≠ b·∫£n ƒë·ªì v·ªÅ t·ªça ƒë·ªô ƒë√£ ch·ªçn ho·∫∑c v·ªã tr√≠ hi·ªán t·∫°i
                if (activeInp.dataset.lat && activeInp.dataset.lon) {
                    pickerMap.setView([activeInp.dataset.lat, activeInp.dataset.lon], 15);
                } else if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(p=>pickerMap.setView([p.coords.latitude,p.coords.longitude],15));
                } else {
                    pickerMap.setView([10.7769,106.7009],13);
                }
                
            } catch(e) {
                 console.error("L·ªói kh·ªüi t·∫°o Leaflet/B·∫£n ƒë·ªì ch·ªçn:", e);
            }
        }
        function closeMap(){document.getElementById('modal-map').style.display='none'}
        
        function confirmMap(){
            let c=pickerMap.getCenter();
            activeInp.dataset.lat=c.lat.toFixed(6);activeInp.dataset.lon=c.lng.toFixed(6); 
            reverseGeocode(c.lat, c.lng, activeInp); 
            closeMap();
        }
        
        function getMyLoc(){
            let btn=document.getElementById('btn-myloc'); btn.innerText=LANG[curLang].btn_myloc.replace('üéØ','‚è≥'); 
            if(!navigator.geolocation)return alert(curLang=='vi'?"L·ªói GPS":"GPS Error");
            navigator.geolocation.getCurrentPosition(p=>{
                let i=document.getElementById('pickup');
                let lat=p.coords.latitude, lon=p.coords.longitude;
                
                i.dataset.lat=lat.toFixed(6); i.dataset.lon=lon.toFixed(6);
                toggleX(i);
                btn.innerText=LANG[curLang].btn_myloc;

                reverseGeocode(lat, lon, i); 

            },()=>{alert(curLang=='vi'?"B·∫≠t GPS!":"Turn on GPS!");btn.innerText=LANG[curLang].btn_myloc},{enableHighAccuracy:true,timeout:5000});
        }

        function toggleWait(){document.getElementById('wait-area').style.display=document.getElementById('tripType').value=='2'?'block':'none'}
        
        function updateResultDisplay() {
            const p = cachedPrices;
            const totalFinal = p.total.toLocaleString() + ' ƒë';

            document.getElementById('res-total').innerText = totalFinal;
            
            // Chi·ªÅu ƒëi
            document.getElementById('row-go').innerHTML = `<span data-i18n="res_go_price">${LANG[curLang].res_go_price}:</span> <strong id="val-go">${p.go.toLocaleString()} ƒë</strong>`;
            
            // Chi·ªÅu v·ªÅ
            if (p.back_full > 0) {
                 document.getElementById('row-back-full').style.display = 'flex'; 
                 const fullPrice = p.back_full.toLocaleString() + ' ƒë';
                 document.getElementById('val-back-full').innerHTML = p.isDiscounted ? `<s>${fullPrice}</s>` : `${fullPrice}`;
                 
                 if (p.isDiscounted) {
                     document.getElementById('row-back-disc').style.display = 'flex';
                     const discountAmount = p.back_full - p.back_disc;
                     document.getElementById('val-back-disc').innerHTML = `${p.back_disc.toLocaleString()} ƒë (-${discountAmount.toLocaleString()}ƒë)`;
                 } else {
                     document.getElementById('row-back-disc').style.display = 'none';
                 }
            } else {
                document.getElementById('row-back-full').style.display = 'none';
                document.getElementById('row-back-disc').style.display = 'none';
            }

            // Ph√≠ ch·ªù
            document.getElementById('row-wait').style.display = p.wait > 0 ? 'flex' : 'none';
            document.getElementById('val-wait').innerText = p.wait.toLocaleString() + ' ƒë';

            // ƒê·∫∑t c·ªçc
            document.getElementById('row-deposit').style.display = p.deposit > 0 ? 'flex' : 'none';
            if (p.deposit > 0) document.getElementById('val-deposit').innerText = p.deposit.toLocaleString() + ' ƒë';
        }


        async function calculate(){
            let p=document.getElementById('pickup'),d=document.getElementById('dropoff');
            // Ki·ªÉm tra ƒë·ªãa ch·ªâ ph·∫£i c√≥ t·ªça ƒë·ªô ch√≠nh x√°c
            if(!p.dataset.lat||!d.dataset.lat)return alert(LANG[curLang].plh_pickup.includes('VD:') ? "Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ ƒë√≥n/ƒë·∫øn (h·ªá th·ªëng c·∫ßn t·ªça ƒë·ªô ch√≠nh x√°c)!" : "Please select or enter all pickup/drop-off addresses (system needs precise coordinates)!");
            
            let btn=document.getElementById('btn-calc');btn.disabled=true;btn.style.opacity=0.7;
            
            // Ch·ªâ l·∫•y c√°c ƒëi·ªÉm c√≥ t·ªça ƒë·ªô ƒë√£ l∆∞u (ƒë√£ ƒë∆∞·ª£c geocode th√†nh c√¥ng)
            let points=[p,...document.querySelectorAll('.stop-inp')].filter(x=>x.dataset.lat);
            if (d.dataset.lat) points.push(d); 

            if (points.length < 2) {
                 alert(LANG[curLang].plh_pickup.includes('VD:') ? "Vui l√≤ng ch·ªçn √≠t nh·∫•t ƒêi·ªÉm ƒë√≥n v√† ƒêi·ªÉm ƒë·∫øn!" : "Please select at least Pickup and Drop-off points!");
                 btn.disabled=false;btn.style.opacity=1;
                 return;
            }

            // D√πng OSRM (Mi·ªÖn ph√≠) ƒë·ªÉ t√≠nh l·ªô tr√¨nh
            // T·ªëi ∆∞u: D√πng t·ªça ƒë·ªô ƒë√£ l∆∞u v·ªõi 6 ch·ªØ s·ªë th·∫≠p ph√¢n
            let coord=points.map(x=>`${x.dataset.lon},${x.dataset.lat}`).join(';');
            
            try{
                let res=await fetch(`https://router.project-osrm.org/route/v1/driving/${coord}?overview=full&geometries=geojson`);
                let data=await res.json();
                if(data.code!=='Ok')throw 'API Error: '+data.message;
                
                let r=data.routes[0], km=r.distance/1000, time=Math.round(r.duration/60);
                
                let type=document.getElementById('tripType').value, unit=document.getElementById('carType').value=='4'?CFG.p4:CFG.p7;
                
                let priceGo = Math.round(km * unit);
                let priceBackFull = (type === '2') ? priceGo : 0;
                
                // Logic gi·∫£m gi√° 2 chi·ªÅu: √Åp d·ª•ng khi 1 chi·ªÅu >= 45km
                let isDiscounted = (type=='2' && km>=45);
                let priceBackDisc = isDiscounted ? Math.round(priceBackFull * 0.6) : priceBackFull; 
                
                let waitHours = parseFloat(document.getElementById('waitHour').value) || 0;
                let paidWaitHours = Math.max(0, waitHours - 3);
                let priceWait = waitHours > 0 ? Math.round(paidWaitHours * CFG.wait) : 0;
                
                // T√≠nh t·ªïng: Chi·ªÅu ƒëi + (Chi·ªÅu v·ªÅ ƒë√£ gi·∫£m/ch∆∞a gi·∫£m) + Ph√≠ ch·ªù
                let total = priceGo + priceBackDisc + priceWait; 
                let deposit = (type=='2') ? Math.round(total * 0.2) : 0;

                cachedPrices = {
                    go: priceGo,
                    back_full: priceBackFull,
                    back_disc: priceBackDisc,
                    wait: priceWait,
                    deposit: deposit,
                    total: total,
                    isDiscounted: isDiscounted,
                    km: km,
                    time: time
                };
                
                // X√≥a l·ªô tr√¨nh c≈© v√† v·∫Ω l·ªô tr√¨nh m·ªõi
                if(routeL)map.removeLayer(routeL);
                routeL=L.geoJSON(r.geometry).addTo(map);map.fitBounds(routeL.getBounds(),{padding:[30,30]});

                document.getElementById('result-box').style.display='block';
                document.getElementById('res-km').innerText=km.toFixed(1)+' km';
                document.getElementById('res-min').innerText=time+' min';
                
                updateResultDisplay();
                
            }catch(e){
                alert(LANG[curLang].plh_pickup.includes('VD:') ? 'L·ªói t√≠nh c∆∞·ªõc! Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ ho·∫∑c k·∫øt n·ªëi m·∫°ng. (OSRM)' : 'Pricing error! Please check the address or network connection. (OSRM)');
                console.error("L·ªói t√≠nh c∆∞·ªõc OSRM:", e);
            }
            btn.disabled=false;btn.style.opacity=1;
        }

        function preBook(m){
            if(!document.getElementById('phone').value){
                pendingMethod=m;
                document.getElementById('phone-modal').style.display='flex';
                document.getElementById('quick-phone').focus();
            }
            else {
                finalBook(m);
            }
        }
        function closePhoneModal(){document.getElementById('phone-modal').style.display='none'}
        function savePhoneAndBook(){
            let p=document.getElementById('quick-phone').value;
            if(p.length<8)return alert(LANG[curLang].plh_pickup.includes('VD:') ? "SƒêT l·ªói!" : "Phone number invalid!");
            document.getElementById('phone').value=p;closePhoneModal();finalBook(pendingMethod);
        }

        const shortC = (l) => parseFloat(l).toFixed(6); // D√πng 6 ch·ªØ s·ªë th·∫≠p ph√¢n
        // Helper ƒë·ªÉ t·∫°o Maps URL
        const createMapUrl = (lat, lon) => `http://googleusercontent.com/maps.google.com/3${shortC(lat)},${shortC(lon)}`;

        function finalBook(method){
            try{
                let p=document.getElementById('pickup'), d=document.getElementById('dropoff');
                if(cachedPrices.total === 0)return alert(LANG[curLang].plh_pickup.includes('VD:') ? "Ch∆∞a t√≠nh gi√°! Vui l√≤ng nh·∫•n n√∫t T√≠nh Gi√° C∆∞·ªõc tr∆∞·ªõc." : "Price not calculated! Please press the Calculate Price button first.");
                
                let lat1=p.dataset.lat, lon1=p.dataset.lon;
                let lat2=d.dataset.lat, lon2=d.dataset.lon;
                const prices = cachedPrices;
                
                let info={
                    ph:document.getElementById('phone').value,
                    t:document.getElementById('time').value.replace('T',' '),
                    p:p.value, d:d.value,
                    km:prices.km.toFixed(1) + ' km',
                    time:prices.time + ' min',
                    car:document.getElementById('carType').selectedOptions[0].text,
                    type:document.getElementById('tripType').selectedOptions[0].text,
                    note:document.getElementById('note').value.trim()
                };
                
                // X·ª≠ l√Ω ƒëi·ªÉm d·ª´ng
                let stopElements = [...document.querySelectorAll('.stop-inp')].filter(el => el.dataset.lat);
                let stopsInfo = stopElements.map((el, index) => {
                    let s_lat = el.dataset.lat;
                    let s_lon = el.dataset.lon;
                    let s_val = el.value;
                    let stopLink = createMapUrl(s_lat, s_lon); 
                    return `\n\nüìå D·ª´ng ${index+1}: ${s_val}\n   ‚îî GPS: ${shortC(s_lat)},${shortC(s_lon)}\n   üëâ Map: ${stopLink}`;
                }).join('');
                
                let mapPickup = createMapUrl(lat1, lon1);
                let mapDropoff = createMapUrl(lat2, lon2);
                
                // X·ª≠ l√Ω chi ti·∫øt gi√°
                let priceDetail = `\n\n--- CHI TI·∫æT GI√Å C∆Ø·ªöC ---\n`;
                priceDetail += `1. Qu√£ng ƒë∆∞·ªùng: ${info.km}\n`;
                priceDetail += `2. Th·ªùi gian: ${info.time}\n`;
                priceDetail += `3. Gi√° chi·ªÅu ƒëi: ${prices.go.toLocaleString()} ƒë\n`;
                
                if (prices.back_full > 0) {
                     if (prices.isDiscounted) {
                         // Ghi r√µ c·∫£ 3 d√≤ng gi√° chi·ªÅu v·ªÅ: ch∆∞a gi·∫£m, gi·∫£m, sau gi·∫£m
                         priceDetail += `4. Gi√° chi·ªÅu v·ªÅ (Ch∆∞a gi·∫£m): ${prices.back_full.toLocaleString()} ƒë\n`;
                         priceDetail += `5. Gi·∫£m gi√° 40% (Chi·ªÅu v·ªÅ): -${(prices.back_full - prices.back_disc).toLocaleString()} ƒë\n`;
                         priceDetail += `6. Gi√° chi·ªÅu v·ªÅ (Sau gi·∫£m): ${prices.back_disc.toLocaleString()} ƒë\n`;
                     } else {
                          priceDetail += `4. Gi√° chi·ªÅu v·ªÅ: ${prices.back_full.toLocaleString()} ƒë\n`;
                     }
                }
                if (prices.wait > 0) {
                     let paidWaitHours = Math.max(0, parseFloat(document.getElementById('waitHour').value) - 3);
                     priceDetail += `7. Ph√≠ ch·ªù (Sau 3h - ${paidWaitHours}h): ${prices.wait.toLocaleString()} ƒë\n`;
                }

                priceDetail += `\n**T·ªîNG C·ªòNG (Ch∆∞a g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng, b·∫øn b√£i):** ${prices.total.toLocaleString()} ƒë\n`;
                
                if(prices.deposit > 0)
                    priceDetail += `\nüí≥ C·ªçc (20%): ${prices.deposit.toLocaleString()} ƒë`;

                let msg=`üöñ Y√äU C·∫¶U ƒê·∫∂T XE\n----------------\n`;
                msg += `üìû SƒêT: ${info.ph}\n`;
                msg += `üïí ƒê√≥n l√∫c: ${info.t}\n`;
                msg += `üöò Xe: ${info.car} | ${info.type}\n`;
                msg += `\n--- L·ªò TR√åNH ---\n`;
                msg += `üìç ƒê√≥n: ${info.p}\n   ‚îî GPS: ${shortC(lat1)},${shortC(lon1)}\n   üëâ Map: ${mapPickup}`; 
                msg += stopsInfo; // stopsInfo ƒë√£ c√≥ s·∫µn map link v√† d·∫•u xu·ªëng d√≤ng
                msg += `\n\nüèÅ ƒê·∫øn: ${info.d}\n   ‚îî GPS: ${shortC(lat2)},${shortC(lon2)}\n   üëâ Map: ${mapDropoff}`; 
                msg += priceDetail;
                
                if (info.note) {
                     msg += `\n\n--- Y√äU C·∫¶U KH√ÅCH H√ÄNG ---\n`;
                     msg += `üìù ${info.note}`;
                }

                if(method=='zalo'){
                    navigator.clipboard.writeText(msg).then(()=>{
                        alert(LANG[curLang].plh_pickup.includes('VD:') ? "ƒê√£ copy th√¥ng tin ƒë·∫∑t xe v√†o b·ªô nh·ªõ ƒë·ªám! Vui l√≤ng m·ªü Zalo v√† d√°n tin nh·∫Øn ƒë·ªÉ g·ª≠i ƒë·∫øn Zalo 084.752.6893." : "Booking details copied to clipboard! Please open Zalo and paste the message to send."); 
                        window.open('https://zalo.me/0847526893');
                    }).catch(()=>{alert(LANG[curLang].plh_pickup.includes('VD:') ? "L·ªói copy! Vui l√≤ng copy th·ªß c√¥ng." : "Copy error! Please copy manually.")});
                }else{
                    window.location.href=`mailto:truongan.driving@gmail.com?subject=BOOKING XE TRUONG AN&body=${encodeURIComponent(msg)}`;
                }
            }catch(e){alert(LANG[curLang].plh_pickup.includes('VD:') ? "L·ªói t·∫°o ƒë∆°n h√†ng! Vui l√≤ng T√≠nh Gi√° C∆∞·ªõc tr∆∞·ªõc khi ƒë·∫∑t." : "Order creation error! Please Calculate Price before booking.")}
        }
    </script>
</body>
</html>
