<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-lang-key="page_title">üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--green:#28a745;--muted:#6c757d;}
    *{box-sizing:border-box}
    #main-content {
      background:#f4f6f8;
      padding: 0;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    .container{padding:12px}
    .label-row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .label-row h3{margin:0;font-size:16px}

    /* --- NEW: Language Switcher Styles --- */
    .lang-switcher {
      text-align: center;
      padding: 8px 0;
      background-color: #f0f0f0;
    }
    .lang-btn {
      background: none;
      border: 2px solid transparent;
      font-size: 24px;
      cursor: pointer;
      padding: 2px 8px;
      border-radius: 8px;
      margin: 0 5px;
      transition: border-color 0.2s;
    }
    .lang-btn:hover {
      border-color: #ccc;
    }
    .lang-btn.active {
      border-color: var(--green);
      background-color: #e9f5ee;
    }
    /* --- End Language Switcher Styles --- */

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    .input-row{position:relative;margin-top:8px}
    .input-row .clear-btn {
        position: absolute; right: 80px; top: 11px; 
        background: #f0f0f0; color: #666; border: none; padding: 3px 6px; 
        border-radius: 4px; font-weight: 700; cursor: pointer; line-height: 1;
        font-size: 14px; display: none; 
        z-index: 1000;
    }
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: block; 
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    .map-btn{position:absolute; right:8px; top:8px; background:var(--green); color:#fff; border:0; padding:6px 8px; border-radius:6px; font-weight:700; cursor:pointer}
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    .suggestions{position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff;border:1px solid #ddd;border-radius:8px;max-height:220px;overflow:auto; -webkit-overflow-scrolling:touch; z-index:1200; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:10px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:8px}
    .way-remove{position:absolute;right:6px;top:6px;background:#ff6b6b;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}
    .kill-switch-styles,.disabled-form{pointer-events:none;opacity:.6;transition:opacity .3s}
    #serviceOffNotice{margin-top:12px;padding:10px;background:#dc3545;color:#fff;border-radius:8px;font-size:15px;font-weight:600;text-align:center}
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9999;display:none;justify-content:center;align-items:center;padding:20px;animation:fadeIn .3s}
    .modal-content{background:#fff;border-radius:12px;padding:20px;width:100%;max-width:450px;max-height:90vh;overflow-y:auto;box-shadow:0 5px 15px rgba(0,0,0,.3);animation:slideIn .3s}
    .modal-content h3{margin-top:0;color:var(--green);font-size:20px;text-align:center}
    #modal-text{white-space:pre-wrap;font-family:monospace;font-size:14px;background:#f8f9fa;padding:10px;border-radius:6px;border:1px solid #ddd;margin-bottom:15px}
    .modal-actions{display:flex;gap:10px}
    .modal-actions button{flex:1;padding:12px;border-radius:8px;font-weight:700;border:none;cursor:pointer}
    #copyModalBtn{background:#ffc107;color:#333}
    #zaloModalBtn{background:#0068ff;color:#fff}
    #closeModalBtn{background:#ccc;color:#333}
    #phoneModal .modal-content{background:#f8d7da;border:1px solid #f5c6cb}
    #phoneModal h3{color:#721c24}
    #phoneModal #inputPhoneForBooking{margin-top:15px}
    #phoneModal #confirmPhoneBtn{background:#007bff;color:#fff}
    #depositModal .modal-content{background:#d4edda;border:1px solid #c3e6cb}
    #depositModal h3{color:#155724}
    #depositModal p{margin-bottom:15px}
    #depositModal #depositAmount{font-weight:800;font-size:20px;color:#007bff;background:#fff;padding:5px 10px;border-radius:5px;display:inline-block}
    #depositModal #confirmDepositBtn{background:var(--green);color:#fff}
    #driverRequest{font-size:18px;font-weight:600;border:2px solid var(--green)}
    .driver-option-highlight{color:red;font-weight:900!important;background-color:#f7f7f7}
    .driver-option-avatar{margin-right:5px;font-size:1.1em;vertical-align:middle}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}
    @media (min-width:700px){.container{max-width:720px;margin:0 auto}}
  </style>
</head>
<body>
<div id="main-content">
  <header>
    <span data-lang-key="header_service">üöñ D·ªãch V·ª• Taxi</span><br>
    <span data-lang-key="header_brand">Tr∆∞·ªùng An Driving</span><br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">‚òéÔ∏è 0847526893</a> 
  </header>

  <div class="lang-switcher">
    <button id="lang-vi" class="lang-btn active" data-lang="vi">üáªüá≥</button>
    <button id="lang-en" class="lang-btn" data-lang="en">üá¨üáß</button>
    <button id="lang-zh" class="lang-btn" data-lang="zh">üá®üá≥</button>
  </div>
  
  <div class="container">
    
    <div id="serviceOffNotice" style="display:none;"></div>
    
    <div id="instructionText" data-lang-key="instruction_checking" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;">
      üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...
    </div>

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3 data-lang-key="phone_label">üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n (Kh√¥ng b·∫Øt bu·ªôc ƒë·ªÉ T√≠nh gi√°)</h3></div>
      <input id="customerPhone" type="tel" data-lang-key="phone_placeholder" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel">

      <div class="label-row">
        <h3 data-lang-key="pickup_label">üìç ƒêi·ªÉm ƒë√≥n</h3>
        <div id="location-status-wrapper" style="display: flex; align-items: center; gap: 8px;">
          <span id="location-status" data-lang-key="location_finding" style="font-size:12px; color:var(--muted); font-weight:bold;">(ƒêang t√¨m v·ªã tr√≠...)</span>
          <i id="reloadLocationBtn" data-lang-key="location_reload_title" title="Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠">üîÑ</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" data-lang-key="pickup_placeholder" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)">
        <button class="clear-btn" data-input-id="pickup">‚úñ</button> 
        <button class="map-btn" id="pick-from-map" data-lang-key="map_button">B·∫£n ƒë·ªì</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="datetime_label">üïí Ng√†y & Gi·ªù ƒë√≥n</h3></div>
      <input id="pickupDateTime" type="datetime-local">

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn" data-lang-key="add_stop_button">Ôºã Th√™m ƒëi·ªÉm d·ª´ng</button>

      <div class="label-row"><h3 data-lang-key="dropoff_label">üèÅ ƒêi·ªÉm ƒë·∫øn</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" data-lang-key="dropoff_placeholder" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
        <button class="clear-btn" data-input-id="dropoff">‚úñ</button> 
        <button class="map-btn" id="pick-to-map" data-lang-key="map_button">B·∫£n ƒë·ªì</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="car_type_label">üöò Lo·∫°i xe</h3></div>
      <select id="carType">
        <option value="4 ch·ªó (10.000ƒë/km)" data-lang-key="car_type_4_seater">Xe 4 ch·ªó (10.000ƒë/km)</option> 
        <option value="7 ch·ªó (12.000ƒë/km)" data-lang-key="car_type_7_seater">Xe 7 ch·ªó (12.000ƒë/km)</option> 
      </select>
      
      <div class="label-row" style="margin-top:12px">
        <h3 data-lang-key="driver_request_label">
            üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu T√†i x·∫ø 
            <span class="driver-option-avatar" title="Icon n√†y c√≥ th·ªÉ thay b·∫±ng Avatar">üë§</span>
        </h3>
      </div>
      <select id="driverRequest">
        <option value="Tr∆∞·ªùng An Driving" class="driver-option-highlight" data-lang-key="driver_default">
            ‚≠ê Tr∆∞·ªùng An Driving (M·∫∑c ƒë·ªãnh)
        </option>
        <option value="Thanh Loan">üë∏ Thanh Loan</option>
        <option value="ƒê√¨nh T√¢m">üßë‚Äç‚úàÔ∏è ƒê√¨nh T√¢m</option>
        <option value="H·∫£i ƒêƒÉng">üßë‚Äç‚úàÔ∏è H·∫£i ƒêƒÉng</option>
        <option value="L√™ T√¢m">üßë‚Äç‚úàÔ∏è L√™ T√¢m</option>
        <option value="Nguy·ªÖn Th·∫£o">üë∏ Nguy·ªÖn Th·∫£o</option>
        <option value="Qu·ªëc D≈©ng">üßë‚Äç‚úàÔ∏è Qu·ªëc D≈©ng</option>
        <option value="T√¢n H·ªì">üßë‚Äç‚úàÔ∏è T√¢n H·ªì</option>
        <option value="Tr·∫ßn Vinh">üßë‚Äç‚úàÔ∏è Tr·∫ßn Vinh</option>
        <option value="Xu√¢n Phong">üßë‚Äç‚úàÔ∏è Xu√¢n Phong</option>
      </select>

      <div class="label-row" style="margin-top:12px"><h3 data-lang-key="trip_type_label">üöó Lo·∫°i chuy·∫øn ƒëi</h3></div>
      <select id="tripType">
        <option value="1" data-lang-key="trip_type_one_way">1 chi·ªÅu</option>
        <option value="2" data-lang-key="trip_type_round_trip">2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)</option>
      </select>

      <div id="waitingWrapper"> 
        <div class="label-row" style="margin-top:12px"><h3 data-lang-key="waiting_time_label">‚è≥ Th·ªùi gian ch·ªù (gi·ªù)</h3></div>
        <input id="waiting" type="number" min="0" value="0" data-lang-key="waiting_time_placeholder" placeholder="Nh·∫≠p s·ªë gi·ªù ch·ªù">
      </div>

      <button class="calc-btn" id="calc-btn" data-lang-key="calc_button">üí∞ T√≠nh gi√°</button>
    </div> <div id="map"></div>

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText" data-lang-key="result_distance">‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng: ‚Äî</div>
      </div>

      <div class="price-title" data-lang-key="result_price_label">üíµ Gi√° d·ª± ki·∫øn</div>
      <div class="price-value" id="priceValue">‚Äî ƒë</div>

      <div class="price-break" id="priceBreak"></div>

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst" data-lang-key="result_time_est">‚è± Th·ªùi gian d·ª± ki·∫øn: ‚Äî ph√∫t</div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo" data-lang-key="result_pickup_time">üïí Ng√†y gi·ªù ƒë√≥n: ‚Äî</div>
    </div>

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" href="javascript:void(0);" style="display:none;" data-lang-key="book_via_zalo">üì± ƒê·∫∑t qua Zalo</a>
      <a id="mailBtn" class="mail" href="javascript:void(0);" style="display:none;" data-lang-key="book_via_mail">üìß ƒê·∫∑t qua Mail</a>
    </div>

    <div class="note" data-lang-key="note_html">
      üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).
      <br>
      **Th·ªùi gian ch·ªù:**
      <ul>
        <li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li>
        <li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li>
        <li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li>
      </ul>
      Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.
    </div>
  </div>
</div>

<div id="depositModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="deposit_modal_title">üìù Y√™u c·∫ßu ƒê·∫∑t c·ªçc cho Chuy·∫øn 2 Chi·ªÅu</h3>
        <div data-lang-key="deposit_modal_body_html">
            <p>
                **Qu√Ω kh√°ch vui l√≤ng l∆∞u √Ω:**<br>
                ƒê·ªÉ x√°c nh·∫≠n v√† ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• cho chuy·∫øn ƒëi **Hai chi·ªÅu** c·ªßa Qu√Ω kh√°ch, ch√∫ng t√¥i k√≠nh mong Qu√Ω kh√°ch **ƒë·∫∑t c·ªçc tr∆∞·ªõc 20%** tr√™n t·ªïng gi√° c∆∞·ªõc d·ª± ki·∫øn.
            </p>
            <p style="text-align:center; font-size:18px;">
                S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn: <span id="depositAmount">0 ƒë</span>
            </p>
            <p>
                Khi nh√¢n vi√™n **Tr∆∞·ªùng An Driving** ph·∫£n h·ªìi qua Zalo, ch√∫ng t√¥i s·∫Ω g·ª≠i **h∆∞·ªõng d·∫´n thanh to√°n c·ª• th·ªÉ** (chuy·ªÉn kho·∫£n) ƒë·ªÉ ho√†n t·∫•t th·ªß t·ª•c ƒë·∫∑t c·ªçc.
            </p>
            <p style="font-size:14px; color:#555;">
                **L∆∞u √Ω:** Ph·∫ßn c√≤n l·∫°i c·ªßa c∆∞·ªõc ph√≠ s·∫Ω ƒë∆∞·ª£c thanh to√°n tr·ª±c ti·∫øp cho t√†i x·∫ø sau khi k·∫øt th√∫c chuy·∫øn ƒëi.
                Xin ch√¢n th√†nh c·∫£m ∆°n Qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng d·ªãch v·ª•.
            </p>
        </div>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmDepositBtn" style="width:100%;" data-lang-key="deposit_modal_confirm_btn">ƒê√£ hi·ªÉu v√† Ti·∫øp t·ª•c</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="phone_modal_title">üìû Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i</h3>
        <p style="text-align:center;" data-lang-key="phone_modal_body">Qu√Ω kh√°ch vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i ti·ªán li√™n h·ªá x√°c nh·∫≠n ƒë∆°n h√†ng.</p>
        <input id="inputPhoneForBooking" type="tel" data-lang-key="phone_placeholder" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel" required>
        <div class="modal-actions" style="margin-top:15px;">
            <button id="confirmPhoneBtn" data-lang-key="phone_modal_confirm_btn">X√°c nh·∫≠n</button> 
        </div>
        <button id="closePhoneModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; background:#ccc; color:#333;" data-lang-key="modal_close_btn">ƒê√≥ng</button>
    </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-lang-key="zalo_modal_title">‚úÖ TH√îNG TIN ƒê·∫∂T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;" data-lang-key="zalo_modal_instruction">Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn" data-lang-key="modal_copy_btn">üìã Sao Ch√©p Th√¥ng Tin</button> 
            <button id="zaloModalBtn" data-lang-key="modal_open_zalo_btn">üì± M·ªü Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;" data-lang-key="modal_close_btn">ƒê√≥ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- START: LANGUAGE TRANSLATION SETUP ---------- */
const translations = {
    "vi": {
        "page_title": "üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving",
        "header_service": "üöñ D·ªãch V·ª• Taxi",
        "header_brand": "Tr∆∞·ªùng An Driving",
        "instruction_checking": "üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...",
        "phone_label": "üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n (Kh√¥ng b·∫Øt bu·ªôc ƒë·ªÉ T√≠nh gi√°)",
        "phone_placeholder": "Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)",
        "pickup_label": "üìç ƒêi·ªÉm ƒë√≥n",
        "location_finding": "(ƒêang t√¨m v·ªã tr√≠...)",
        "location_reload_title": "Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠",
        "pickup_placeholder": "Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)",
        "map_button": "B·∫£n ƒë·ªì",
        "datetime_label": "üïí Ng√†y & Gi·ªù ƒë√≥n",
        "add_stop_button": "Ôºã Th√™m ƒëi·ªÉm d·ª´ng",
        "dropoff_label": "üèÅ ƒêi·ªÉm ƒë·∫øn",
        "dropoff_placeholder": "Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi",
        "car_type_label": "üöò Lo·∫°i xe",
        "car_type_4_seater": "Xe 4 ch·ªó (10.000ƒë/km)",
        "car_type_7_seater": "Xe 7 ch·ªó (12.000ƒë/km)",
        "driver_request_label": "üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu T√†i x·∫ø",
        "driver_default": "‚≠ê Tr∆∞·ªùng An Driving (M·∫∑c ƒë·ªãnh)",
        "trip_type_label": "üöó Lo·∫°i chuy·∫øn ƒëi",
        "trip_type_one_way": "1 chi·ªÅu",
        "trip_type_round_trip": "2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)",
        "waiting_time_label": "‚è≥ Th·ªùi gian ch·ªù (gi·ªù)",
        "waiting_time_placeholder": "Nh·∫≠p s·ªë gi·ªù ch·ªù",
        "calc_button": "üí∞ T√≠nh gi√°",
        "result_distance": "‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng: ‚Äî",
        "result_price_label": "üíµ Gi√° d·ª± ki·∫øn",
        "result_time_est": "‚è± Th·ªùi gian d·ª± ki·∫øn: ‚Äî ph√∫t",
        "result_pickup_time": "üïí Ng√†y gi·ªù ƒë√≥n: ‚Äî",
        "book_via_zalo": "üì± ƒê·∫∑t qua Zalo",
        "book_via_mail": "üìß ƒê·∫∑t qua Mail",
        "note_html": "üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).<br>**Th·ªùi gian ch·ªù:**<ul><li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li><li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li><li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li></ul>Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.",
        "deposit_modal_title": "üìù Y√™u c·∫ßu ƒê·∫∑t c·ªçc cho Chuy·∫øn 2 Chi·ªÅu",
        "deposit_modal_body_html": "<p>**Qu√Ω kh√°ch vui l√≤ng l∆∞u √Ω:**<br>ƒê·ªÉ x√°c nh·∫≠n v√† ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• cho chuy·∫øn ƒëi **Hai chi·ªÅu** c·ªßa Qu√Ω kh√°ch, ch√∫ng t√¥i k√≠nh mong Qu√Ω kh√°ch **ƒë·∫∑t c·ªçc tr∆∞·ªõc 20%** tr√™n t·ªïng gi√° c∆∞·ªõc d·ª± ki·∫øn.</p><p style='text-align:center; font-size:18px;'>S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn: <span id='depositAmount'>0 ƒë</span></p><p>Khi nh√¢n vi√™n **Tr∆∞·ªùng An Driving** ph·∫£n h·ªìi qua Zalo, ch√∫ng t√¥i s·∫Ω g·ª≠i **h∆∞·ªõng d·∫´n thanh to√°n c·ª• th·ªÉ** (chuy·ªÉn kho·∫£n) ƒë·ªÉ ho√†n t·∫•t th·ªß t·ª•c ƒë·∫∑t c·ªçc.</p><p style='font-size:14px; color:#555;'>**L∆∞u √Ω:** Ph·∫ßn c√≤n l·∫°i c·ªßa c∆∞·ªõc ph√≠ s·∫Ω ƒë∆∞·ª£c thanh to√°n tr·ª±c ti·∫øp cho t√†i x·∫ø sau khi k·∫øt th√∫c chuy·∫øn ƒëi. Xin ch√¢n th√†nh c·∫£m ∆°n Qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng d·ªãch v·ª•.</p>",
        "deposit_modal_confirm_btn": "ƒê√£ hi·ªÉu v√† Ti·∫øp t·ª•c",
        "phone_modal_title": "üìû Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i",
        "phone_modal_body": "Qu√Ω kh√°ch vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i ti·ªán li√™n h·ªá x√°c nh·∫≠n ƒë∆°n h√†ng.",
        "phone_modal_confirm_btn": "X√°c nh·∫≠n",
        "modal_close_btn": "ƒê√≥ng",
        "zalo_modal_title": "‚úÖ TH√îNG TIN ƒê·∫∂T XE",
        "zalo_modal_instruction": "Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:",
        "modal_copy_btn": "üìã Sao Ch√©p Th√¥ng Tin",
        "modal_open_zalo_btn": "üì± M·ªü Zalo Chat",
        "alert_map_pickup": "B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë√≥n",
        "alert_map_dropoff": "B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn",
        "location_found": "‚úÖ ƒê√£ t√¨m th·∫•y v·ªã tr√≠",
        "location_error": "‚ö†Ô∏è L·ªói t√¨m v·ªã tr√≠. Nh·∫≠p th·ªß c√¥ng.",
        "location_denied": "‚ùå B·ªã t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠.",
        "location_unavailable": "‚ùå V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng (B·∫≠t GPS).",
        "location_timeout": "‚ö†Ô∏è H·∫øt th·ªùi gian t√¨m v·ªã tr√≠.",
        "location_unsupported": "‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation."
    },
    "en": {
        "page_title": "üöñ Truong An Driving - Taxi Service",
        "header_service": "üöñ Taxi Service",
        "header_brand": "Truong An Driving",
        "instruction_checking": "üí∞ Checking service status...",
        "phone_label": "üìû Your Phone Number (Optional for Price Calculation)",
        "phone_placeholder": "Enter phone no. (10 digits, e.g., 0987654321)",
        "pickup_label": "üìç Pickup Location",
        "location_finding": "(Finding location...)",
        "location_reload_title": "Retry finding location",
        "pickup_placeholder": "Enter pickup address (or auto-detect)",
        "map_button": "Map",
        "datetime_label": "üïí Pickup Date & Time",
        "add_stop_button": "Ôºã Add Stop",
        "dropoff_label": "üèÅ Destination",
        "dropoff_placeholder": "Enter final destination address",
        "car_type_label": "üöò Vehicle Type",
        "car_type_4_seater": "4-seater (10,000ƒë/km)",
        "car_type_7_seater": "7-seater (12,000ƒë/km)",
        "driver_request_label": "üßë‚Äç‚úàÔ∏è Request Driver",
        "driver_default": "‚≠ê Truong An Driving (Default)",
        "trip_type_label": "üöó Trip Type",
        "trip_type_one_way": "One-way",
        "trip_type_round_trip": "Round trip (40% off return leg)",
        "waiting_time_label": "‚è≥ Waiting Time (hours)",
        "waiting_time_placeholder": "Enter waiting hours",
        "calc_button": "üí∞ Calculate Price",
        "result_distance": "‚úèÔ∏è Distance: ‚Äî",
        "result_price_label": "üíµ Estimated Fare",
        "result_time_est": "‚è± Estimated Time: ‚Äî minutes",
        "result_pickup_time": "üïí Pickup Time: ‚Äî",
        "book_via_zalo": "üì± Book via Zalo",
        "book_via_mail": "üìß Book via Mail",
        "note_html": "üìå Note: 4-seater/7-seater rates: **10,000ƒë/km** / **12,000ƒë/km**. Round trip: 40% discount on return leg (applies to one-way trips **‚â• 45km**).<br>**Waiting Time:**<ul><li>0‚Äì3 hours wait: **Free**.</li><li>From the 4th hour, a surcharge of **50,000 VND/hour** applies.</li><li>Waiting time is calculated from when the passenger alights at the destination until the car returns for the pickup.</li></ul>Price includes all toll fees.",
        "deposit_modal_title": "üìù Deposit Required for Round Trip",
        "deposit_modal_body_html": "<p>**Dear Customer,**<br>To confirm and ensure service quality for your **Round trip**, we kindly request a **20% deposit** of the estimated total fare.</p><p style='text-align:center; font-size:18px;'>Estimated Deposit: <span id='depositAmount'>0 ƒë</span></p><p>When our staff from **Truong An Driving** responds via Zalo, we will provide **specific payment instructions** (bank transfer) to complete the deposit process.</p><p style='font-size:14px; color:#555;'>**Note:** The remaining balance is to be paid directly to the driver after the trip. Thank you for your trust in our service.</p>",
        "deposit_modal_confirm_btn": "I Understand and Continue",
        "phone_modal_title": "üìû Please Enter Your Phone Number",
        "phone_modal_body": "Please provide your phone number so we can contact you to confirm the booking.",
        "phone_modal_confirm_btn": "Confirm",
        "modal_close_btn": "Close",
        "zalo_modal_title": "‚úÖ BOOKING INFORMATION",
        "zalo_modal_instruction": "Copy this information and send it via Zalo:",
        "modal_copy_btn": "üìã Copy Information",
        "modal_open_zalo_btn": "üì± Open Zalo Chat",
        "alert_map_pickup": "Click on the map to select a pickup location",
        "alert_map_dropoff": "Click on the map to select a destination",
        "location_found": "‚úÖ Location found",
        "location_error": "‚ö†Ô∏è Error finding location. Please enter manually.",
        "location_denied": "‚ùå Location access denied.",
        "location_unavailable": "‚ùå Location unavailable (Turn on GPS).",
        "location_timeout": "‚ö†Ô∏è Timed out finding location.",
        "location_unsupported": "‚ùå Geolocation is not supported by this browser."
    },
    "zh": {
        "page_title": "üöñ Truong An Driving - Âá∫ÁßüËΩ¶ÊúçÂä°",
        "header_service": "üöñ Âá∫ÁßüËΩ¶ÊúçÂä°",
        "header_brand": "Truong An Driving",
        "instruction_checking": "üí∞ Ê≠£Âú®Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ...",
        "phone_label": "üìû ÊÇ®ÁöÑÁîµËØùÂè∑Á†Å (ËÆ°ÁÆó‰ª∑Ê†ºÈùûÂøÖÂ°´)",
        "phone_placeholder": "ËæìÂÖ•ÁîµËØùÂè∑Á†Å (10‰ΩçÊï∞, ‰æãÂ¶Ç: 0987654321)",
        "pickup_label": "üìç ‰∏äËΩ¶Âú∞ÁÇπ",
        "location_finding": "(Ê≠£Âú®ÂØªÊâæ‰ΩçÁΩÆ...)",
        "location_reload_title": "ÈáçËØïÂØªÊâæ‰ΩçÁΩÆ",
        "pickup_placeholder": "ËæìÂÖ•‰∏äËΩ¶Âú∞ÂùÄ (ÊàñËá™Âä®Ê£ÄÊµã)",
        "map_button": "Âú∞Âõæ",
        "datetime_label": "üïí ‰∏äËΩ¶Êó•ÊúüÂíåÊó∂Èó¥",
        "add_stop_button": "Ôºã Ê∑ªÂä†ÁªèÂÅúÁÇπ",
        "dropoff_label": "üèÅ ÁõÆÁöÑÂú∞",
        "dropoff_placeholder": "ËæìÂÖ•ÊúÄÁªàÁõÆÁöÑÂú∞Âú∞ÂùÄ",
        "car_type_label": "üöò ËΩ¶ËæÜÁ±ªÂûã",
        "car_type_4_seater": "4Â∫ßËΩ¶ (10,000Ë∂äÂçóÁõæ/ÂÖ¨Èáå)",
        "car_type_7_seater": "7Â∫ßËΩ¶ (12,000Ë∂äÂçóÁõæ/ÂÖ¨Èáå)",
        "driver_request_label": "üßë‚Äç‚úàÔ∏è ÊåáÂÆöÂè∏Êú∫",
        "driver_default": "‚≠ê Truong An Driving (ÈªòËÆ§)",
        "trip_type_label": "üöó Ë°åÁ®ãÁ±ªÂûã",
        "trip_type_one_way": "ÂçïÁ®ã",
        "trip_type_round_trip": "ÂæÄËøî (ËøîÁ®ã‰ºòÊÉ†40%)",
        "waiting_time_label": "‚è≥ Á≠âÂæÖÊó∂Èó¥ (Â∞èÊó∂)",
        "waiting_time_placeholder": "ËæìÂÖ•Á≠âÂæÖÂ∞èÊó∂Êï∞",
        "calc_button": "üí∞ ËÆ°ÁÆó‰ª∑Ê†º",
        "result_distance": "‚úèÔ∏è Ë∑ùÁ¶ª: ‚Äî",
        "result_price_label": "üíµ È¢ÑËÆ°Ë¥πÁî®",
        "result_time_est": "‚è± È¢ÑËÆ°Êó∂Èó¥: ‚Äî ÂàÜÈíü",
        "result_pickup_time": "üïí ‰∏äËΩ¶Êó∂Èó¥: ‚Äî",
        "book_via_zalo": "üì± ÈÄöËøáZaloÈ¢ÑËÆ¢",
        "book_via_mail": "üìß ÈÄöËøáÈÇÆ‰ª∂È¢ÑËÆ¢",
        "note_html": "üìå Ê≥®ÊÑè: 4Â∫ß/7Â∫ßËΩ¶Ë¥πÁéá: **10,000Ë∂äÂçóÁõæ/ÂÖ¨Èáå** / **12,000Ë∂äÂçóÁõæ/ÂÖ¨Èáå**„ÄÇÂæÄËøîË°åÁ®ã: ËøîÁ®ã‰ºòÊÉ†40% (ÈÄÇÁî®‰∫éÂçïÁ®ã **‚â• 45ÂÖ¨Èáå** ÁöÑË°åÁ®ã)„ÄÇ<br>**Á≠âÂæÖÊó∂Èó¥:**<ul><li>Á≠âÂæÖ0-3Â∞èÊó∂: **ÂÖçË¥π**„ÄÇ</li><li>‰ªéÁ¨¨4Â∞èÊó∂Ëµ∑ÔºåÊØèÂ∞èÊó∂Âä†Êî∂ **50,000Ë∂äÂçóÁõæ** ÁöÑÈôÑÂä†Ë¥π„ÄÇ</li><li>Á≠âÂæÖÊó∂Èó¥‰ªé‰πòÂÆ¢Âú®ÁõÆÁöÑÂú∞ÂÆåÂÖ®‰∏ãËΩ¶Êó∂ÂºÄÂßãËÆ°ÁÆóÔºåÁõ¥Âà∞ËΩ¶ËæÜËøîÂõûÊé•ÂÆ¢‰∏∫Ê≠¢„ÄÇ</li></ul>‰ª∑Ê†ºÂ∑≤ÂåÖÂê´ÊâÄÊúâËøáË∑ØË¥π„ÄÇ",
        "deposit_modal_title": "üìù ÂæÄËøîË°åÁ®ãÈúÄÊîØ‰ªòÊäºÈáë",
        "deposit_modal_body_html": "<p>**Â∞äÊï¨ÁöÑÂÆ¢Êà∑,**<br>‰∏∫Á°ÆËÆ§Âπ∂‰øùËØÅÊÇ®ÁöÑ**ÂæÄËøîË°åÁ®ã**ÊúçÂä°Ë¥®ÈáèÔºåÊàë‰ª¨ÊÅ≥ËØ∑ÊÇ®È¢Ñ‰ªòÈ¢ÑËÆ°ÊÄªË¥πÁî®ÁöÑ**20%‰Ωú‰∏∫ÊäºÈáë**„ÄÇ</p><p style='text-align:center; font-size:18px;'>È¢ÑËÆ°ÊäºÈáë: <span id='depositAmount'>0 ƒë</span></p><p>ÂΩìÊàë‰ª¨ÁöÑ**Truong An Driving**ÂëòÂ∑•ÈÄöËøáZaloÂõûÂ§çÊÇ®Êó∂ÔºåÊàë‰ª¨Â∞ÜÂèëÈÄÅ**ÂÖ∑‰ΩìÁöÑ‰ªòÊ¨æËØ¥Êòé** (Èì∂Ë°åËΩ¨Ë¥¶) ‰ª•ÂÆåÊàêÊäºÈáëÁ®ãÂ∫è„ÄÇ</p><p style='font-size:14px; color:#555;'>**Ê≥®ÊÑè:** Ââ©‰ΩôË¥πÁî®Â∞ÜÂú®Ë°åÁ®ãÁªìÊùüÂêéÁõ¥Êé•ÊîØ‰ªòÁªôÂè∏Êú∫„ÄÇÊÑüË∞¢ÊÇ®ÂØπÊàë‰ª¨ÊúçÂä°ÁöÑ‰ø°‰ªª„ÄÇ</p>",
        "deposit_modal_confirm_btn": "ÊàëÊòéÁôΩÂπ∂ÁªßÁª≠",
        "phone_modal_title": "üìû ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁîµËØùÂè∑Á†Å",
        "phone_modal_body": "ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁîµËØùÂè∑Á†ÅÔºå‰ª•‰æøÊàë‰ª¨ËÅîÁ≥ªÊÇ®Á°ÆËÆ§ËÆ¢Âçï„ÄÇ",
        "phone_modal_confirm_btn": "Á°ÆËÆ§",
        "modal_close_btn": "ÂÖ≥Èó≠",
        "zalo_modal_title": "‚úÖ È¢ÑËÆ¢‰ø°ÊÅØ",
        "zalo_modal_instruction": "Â§çÂà∂Ê≠§‰ø°ÊÅØÂπ∂ÈÄöËøáZaloÂèëÈÄÅ:",
        "modal_copy_btn": "üìã Â§çÂà∂‰ø°ÊÅØ",
        "modal_open_zalo_btn": "üì± ÊâìÂºÄZaloËÅäÂ§©",
        "alert_map_pickup": "ÁÇπÂáªÂú∞ÂõæÈÄâÊã©‰∏äËΩ¶Âú∞ÁÇπ",
        "alert_map_dropoff": "ÁÇπÂáªÂú∞ÂõæÈÄâÊã©ÁõÆÁöÑÂú∞",
        "location_found": "‚úÖ Â∑≤ÊâæÂà∞‰ΩçÁΩÆ",
        "location_error": "‚ö†Ô∏è ÂØªÊâæ‰ΩçÁΩÆÊó∂Âá∫Èîô„ÄÇËØ∑ÊâãÂä®ËæìÂÖ•„ÄÇ",
        "location_denied": "‚ùå ‰ΩçÁΩÆËÆøÈóÆË¢´ÊãíÁªù„ÄÇ",
        "location_unavailable": "‚ùå ‰ΩçÁΩÆ‰∏çÂèØÁî® (ËØ∑ÊâìÂºÄGPS)„ÄÇ",
        "location_timeout": "‚ö†Ô∏è ÂØªÊâæ‰ΩçÁΩÆË∂ÖÊó∂„ÄÇ",
        "location_unsupported": "‚ùå Ê≠§ÊµèËßàÂô®‰∏çÊîØÊåÅÂú∞ÁêÜÂÆö‰Ωç„ÄÇ"
    }
};

function updateLanguage(lang) {
    document.documentElement.lang = lang; // Update html lang attribute
    document.querySelectorAll('[data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        const translation = translations[lang][key];
        if (translation) {
            // Handle different element types
            if (element.hasAttribute('placeholder')) {
                element.placeholder = translation;
            } else if (element.hasAttribute('title')) {
                element.title = translation;
            } else if (key.endsWith('_html')) { // For elements with complex HTML
                element.innerHTML = translation;
            }
            else {
                // Preserve child nodes like icons (<i>, <span>)
                const firstChild = element.firstChild;
                if (firstChild && (firstChild.nodeType === Node.ELEMENT_NODE)) {
                    // If the first child is an element (like an icon), only change the text part
                     const textNode = firstChild.nextSibling;
                     if(textNode && textNode.nodeType === Node.TEXT_NODE) {
                         textNode.textContent = ' ' + translation;
                     } else {
                         element.innerHTML = element.innerHTML.split('>')[0] + '>' + translation;
                     }
                } else {
                    element.textContent = translation;
                }
            }
        }
    });

    // Update active button style
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });

    // Save language choice
    localStorage.setItem('language', lang);
}
/* ---------- END: LANGUAGE TRANSLATION SETUP ---------- */

/* ---------- C·∫•u h√¨nh T·ªëi ∆Øu H√≥a ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving";
const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/"; 
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/"; 
const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const driverRequestEl = document.getElementById('driverRequest');
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn');
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 
const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const phoneModal = document.getElementById('phoneModal');
const inputPhoneForBooking = document.getElementById('inputPhoneForBooking');
const confirmPhoneBtn = document.getElementById('confirmPhoneBtn');
const closePhoneModalBtn = document.getElementById('closePhoneModalBtn');
const depositModal = document.getElementById('depositModal');
const depositAmountEl = document.getElementById('depositAmount'); // Renamed to avoid conflict
const confirmDepositBtn = document.getElementById('confirmDepositBtn');

let finalZaloMessage = ''; 
let finalTotalFee = 0; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;
let bookingAction = null;

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`; 
    const finalUrl = REMOTE_STATUS_URL + cacheBuster;
    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
        if (!response.ok) {
            return { active: false, message_vn: "‚ö†Ô∏è C·∫¢NH B√ÅO M·∫†NG: Kh√¥ng t√¨m th·∫•y file tr·∫°ng th√°i d·ªãch v·ª• (404/Server Error). Ch·ª©c nƒÉng ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng." };
        }
        return await response.json();
    } catch (error) {
        let msg = "‚ö†Ô∏è Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng."
        if (error.name === 'TimeoutError') {
             msg = "‚ö†Ô∏è Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª• qu√° l√¢u. Vi·ªác ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng."
        }
        console.error("L·ªói khi fetch tr·∫°ng th√°i d·ªãch v·ª•:", error);
        return { active: false, message_vn: msg };
    }
}

async function updateUIBasedOnStatus(status) {
    if (status.active !== isServiceActive) {
        isServiceActive = status.active;
    }
    instructionText.style.display = 'block';
    if (!isServiceActive) {
        calcBtn.style.background = '#ccc';
        calcBtn.style.cursor = 'not-allowed';
        calcBtn.disabled = true;
        serviceOffNotice.style.display = 'block';
        serviceOffNotice.innerHTML = status.message_vn;
        bookingFormWrapper.classList.add('disabled-form');
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';
    } else {
        calcBtn.style.background = 'var(--green)';
        calcBtn.style.cursor = 'pointer';
        calcBtn.disabled = false;
        serviceOffNotice.style.display = 'none';
        bookingFormWrapper.classList.remove('disabled-form');
        const lang = localStorage.getItem('language') || 'vi';
        const msgKey = lang === 'en' ? 'message_en' : lang === 'zh' ? 'message_zh' : 'message_vn';
        instructionText.innerHTML = status[msgKey] || status.message_vn || 'üí∞ B·∫•m "T√≠nh gi√°" ƒë·ªÉ xem chi ti·∫øt ƒë·∫∑t xe.';
    }
}

function initMap(center) {
    if (!map) {
        map = L.map('map').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        map.on('click', handleMapClick);
        map.on('dblclick', handleMapDblClick);
    } else {
        map.setView(center, 11);
    }
}

async function reverseGeocode(lat, lon) {
    try {
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=vi`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        console.warn('Reverse Geocoding Error', e);
        return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }
}

function getGeolocation() {
    const lang = localStorage.getItem('language') || 'vi';
    locationStatusEl.textContent = translations[lang]['location_finding'];
    locationStatusEl.style.color = 'var(--muted)';
    reloadLocationBtn.style.color = '#ccc'; 
    reloadLocationBtn.style.pointerEvents = 'none';

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            userLocation = [pos.coords.latitude, pos.coords.longitude]; 
            initMap(userLocation); 
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';
            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup('üìç').openPopup();
            locationStatusEl.textContent = translations[lang]['location_found'];
            locationStatusEl.style.color = 'var(--green)';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';
        }, (err)=>{
            console.warn('Geolocation Error:', err.message);
            initMap(DEFAULT_CENTER); 
            let statusKey;
            if (err.code === err.PERMISSION_DENIED) statusKey = 'location_denied';
            else if (err.code === err.POSITION_UNAVAILABLE) statusKey = 'location_unavailable';
            else if (err.code === err.TIMEOUT) statusKey = 'location_timeout';
            else statusKey = 'location_error';
            locationStatusEl.textContent = translations[lang][statusKey];
            locationStatusEl.style.color = '#dc3545';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';
        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
    } else {
        initMap(DEFAULT_CENTER); 
        locationStatusEl.textContent = translations[lang]['location_unsupported'];
        locationStatusEl.style.color = '#dc3545';
        reloadLocationBtn.style.color = '#ccc';
        reloadLocationBtn.style.pointerEvents = 'none';
    }
}

function debounce(func, timeout = 300) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); }; }
function toggleWaitingInput(){ waitingWrapper.style.display = tripTypeEl.value === '1' ? 'none' : 'block'; }
tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput();

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
            inputEl.value = '';
            delete inputEl.dataset.lat;
            delete inputEl.dataset.lon;
            if (inputId === 'pickup' && pickupMarker) { map.removeLayer(pickupMarker); pickupMarker = null; }
            else if (inputId === 'dropoff' && dropoffMarker) { map.removeLayer(dropoffMarker); dropoffMarker = null; }
            const suggBox = document.getElementById(`${inputId}-suggestions`);
            if (suggBox) suggBox.style.display = 'none';
            inputEl.focus(); 
        }
    });
});

document.querySelectorAll('input[type="text"]').forEach(inputEl => {
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if (clearBtn) {
        const toggle = () => { clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; };
        inputEl.addEventListener('input', toggle);
        inputEl.addEventListener('focus', toggle);
        inputEl.addEventListener('blur', () => setTimeout(() => clearBtn.style.display = 'none', 150));
    }
});

async function geocodeOnce(query) {
    try {
        let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1`;
        if (userLocation) {
            const [lat, lon] = userLocation;
            url += `&viewbox=${lon-0.5},${lat-0.5},${lon+0.5},${lat+0.5}`;
        } else {
            url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
        }
        const r = await fetch(url);
        const data = await r.json();
        return (Array.isArray(data) && data.length > 0) ? data[0] : null;
    } catch (e) {
        console.warn('geocode once error', e);
        return null;
    }
}

function attachAutocomplete(inputEl, boxEl) {
    let controller = null;
    const doSearch = async () => {
        const q = inputEl.value.trim();
        const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
        if (!q) { boxEl.style.display = 'none'; if(clearBtn) clearBtn.style.display = 'none'; return; }
        if (clearBtn) clearBtn.style.display = 'block';
        if (controller) controller.abort();
        controller = new AbortController();
        boxEl.innerHTML = '<div>...</div>';
        boxEl.style.display = 'block';
        let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=vi`;
        if (userLocation) {
            const [lat, lon] = userLocation;
            url += `&viewbox=${lon-0.3},${lat-0.3},${lon+0.3},${lat+0.3}`;
        } else {
            url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
        }
        try {
            const res = await fetch(url, { signal: controller.signal });
            const data = await res.json();
            boxEl.innerHTML = '';
            if (!Array.isArray(data) || data.length === 0) {
                boxEl.innerHTML = '<div>No results</div>';
                setTimeout(() => boxEl.style.display = 'none', 1000);
                return;
            }
            data.forEach(place => {
                const d = document.createElement('div');
                d.innerHTML = `üìç<div style="margin-left:8px">${place.display_name}</div>`;
                d.addEventListener('click', () => {
                    inputEl.value = place.display_name;
                    inputEl.dataset.lat = place.lat;
                    inputEl.dataset.lon = place.lon;
                    boxEl.style.display = 'none';
                    if (clearBtn) clearBtn.style.display = 'block';
                    const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
                    if (map) {
                        if (inputEl.id === 'pickup') {
                            if (pickupMarker) map.removeLayer(pickupMarker);
                            pickupMarker = L.marker(latlng).addTo(map).bindPopup('üìç').openPopup();
                            map.setView(latlng, 14);
                        } else if (inputEl.id === 'dropoff') {
                            if (dropoffMarker) map.removeLayer(dropoffMarker);
                            dropoffMarker = L.marker(latlng).addTo(map).bindPopup('üèÅ').openPopup();
                            map.setView(latlng, 14);
                        }
                    }
                });
                boxEl.appendChild(d);
            });
        } catch (err) {
            if (err.name !== 'AbortError') console.error('suggest error', err);
        }
    };
    inputEl.addEventListener('input', debounce(doSearch));
    document.addEventListener('click', (ev) => { if (!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; });
    inputEl.addEventListener('focus', () => { if (inputEl.id.startsWith('stop-')) lastFocusedStopId = inputEl.id; else lastFocusedStopId = null; });
}

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

function createStopInput(prefill = '') {
    stopCount++;
    const wrapper = document.createElement('div');
    wrapper.className = 'way-wrapper input-row';
    const inputId = `stop-${stopCount}`;
    wrapper.innerHTML = `<input type="text" id="${inputId}" placeholder="Stop ${stopCount}"><button class="clear-btn" data-input-id="${inputId}">‚úñ</button><button class="way-remove" title="Remove">‚úñ</button><div id="${inputId}-suggestions" class="suggestions" style="display:none"></div>`;
    stopsContainer.appendChild(wrapper);
    const inputEl = wrapper.querySelector('input');
    attachAutocomplete(inputEl, wrapper.querySelector('.suggestions'));
    inputEl.addEventListener('focus', () => lastFocusedStopId = inputId);
    wrapper.querySelector('.way-remove').addEventListener('click', () => wrapper.remove());
    const clearBtn = wrapper.querySelector('.clear-btn');
    const toggle = () => { clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; };
    inputEl.addEventListener('input', toggle);
    inputEl.addEventListener('focus', toggle);
    inputEl.addEventListener('blur', () => setTimeout(() => clearBtn.style.display = 'none', 150));
    clearBtn.addEventListener('click', (e) => { e.stopPropagation(); inputEl.value = ''; delete inputEl.dataset.lat; delete inputEl.dataset.lon; inputEl.focus(); });
}
document.getElementById('add-stop-btn').addEventListener('click', () => createStopInput());

document.getElementById('pick-from-map').addEventListener('click', () => { selecting = 'pickup'; alert(translations[localStorage.getItem('language') || 'vi']['alert_map_pickup']); });
document.getElementById('pick-to-map').addEventListener('click', () => { selecting = 'dropoff'; alert(translations[localStorage.getItem('language') || 'vi']['alert_map_dropoff']); });

const handleMapClick = async (e) => {
    if (!map) return;
    const { lat, lng: lon } = e.latlng;
    let targetInput;
    if (selecting === 'pickup') {
        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = L.marker([lat, lon]).addTo(map).bindPopup('üìç').openPopup();
        targetInput = pickupEl;
        selecting = null;
    } else if (selecting === 'dropoff') {
        if (dropoffMarker) map.removeLayer(dropoffMarker);
        dropoffMarker = L.marker([lat, lon]).addTo(map).bindPopup('üèÅ').openPopup();
        targetInput = dropoffEl;
        selecting = null;
    } else if (lastFocusedStopId) {
        L.marker([lat, lon]).addTo(map).bindPopup('üõë').openPopup();
        targetInput = document.getElementById(lastFocusedStopId);
        lastFocusedStopId = null;
    }
    if (targetInput) {
        const address = await reverseGeocode(lat, lon);
        targetInput.value = address;
        targetInput.dataset.lat = lat;
        targetInput.dataset.lon = lon;
        targetInput.parentNode.querySelector('.clear-btn').style.display = 'block';
    }
};

const handleMapDblClick = (e) => {
    if (!map || !lastFocusedStopId) return;
    const stopInput = document.getElementById(lastFocusedStopId);
    if (stopInput) {
        const { lat, lng } = e.latlng;
        stopInput.value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
        stopInput.dataset.lat = lat;
        stopInput.dataset.lon = lng;
        L.marker([lat, lng]).addTo(map).bindPopup('üõë').openPopup();
        lastFocusedStopId = null;
    }
};

async function resolveCoordForInput(inputEl) {
    if (inputEl.dataset.lat && inputEl.dataset.lon) return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
    const v = inputEl.value.trim();
    if (!v) return null;
    const parts = v.split(',');
    if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) return [parseFloat(parts[0]), parseFloat(parts[1])];
    const place = await geocodeOnce(v + ' Vi·ªát Nam');
    if (place) {
        inputEl.dataset.lat = place.lat;
        inputEl.dataset.lon = place.lon;
        return [parseFloat(place.lat), parseFloat(place.lon)];
    }
    return null;
}

function validateRouteInputs() {
    if (!pickupEl.value.trim()) { alert('Please enter a pickup location.'); pickupEl.focus(); return false; }
    if (!dropoffEl.value.trim()) { alert('Please enter a destination.'); dropoffEl.focus(); return false; }
    if (tripTypeEl.value === '2' && (isNaN(parseFloat(waitingEl.value)) || parseFloat(waitingEl.value) < 0)) { alert('Please enter a valid waiting time for a round trip.'); waitingEl.focus(); return false; }
    return true;
}

function validatePhone(phone) { return /^\d{10}$/.test(phone); }

async function calculateAndGenerateMessage() {
    if (!validateRouteInputs()) return false;
    
    const [pickupCoord, dropoffCoord] = await Promise.all([resolveCoordForInput(pickupEl), resolveCoordForInput(dropoffEl)]);
    if (!pickupCoord || !dropoffCoord) { alert('Could not find coordinates for pickup or dropoff.'); return false; }

    const coords = [pickupCoord];
    const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
    for (const s of stopInputs) {
        if (s.value.trim()) {
            const sc = await resolveCoordForInput(s);
            if (!sc) { alert('Could not find coordinates for a stop.'); return false; }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord);

    resultBox.style.display = 'block';
    distanceText.textContent = 'Calculating route...';
    try {
        const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
        const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;
        const r = await fetch(url);
        const data = await r.json();
        if (!data.routes || data.routes.length === 0) { distanceText.textContent = 'Could not calculate route.'; return false; }
        
        const route = data.routes[0];
        const dist = route.distance / 1000;
        const minutes = Math.round(dist / 30 * 60);

        if (map) {
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
        }
        
        const tripType = tripTypeEl.value;
        const carType = carTypeEl.value;
        const driverRequest = driverRequestEl.value;
        const waiting = parseFloat(waitingEl.value) || 0;
        const perKm = carType.includes('7 ch·ªó') ? 12000 : 10000;
        const priceGo = Math.round(dist * perKm);
        let priceReturn = 0;
        if (tripType === '2') {
            priceReturn = dist >= 45 ? Math.round(dist * perKm * 0.6) : priceGo;
        }
        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total;
        
        distanceText.textContent = `Qu√£ng ƒë∆∞·ªùng: ${dist.toFixed(1)} km (m·ªôt chi·ªÅu)`;
        priceValue.textContent = total.toLocaleString('vi-VN') + ' ƒë';
        // Details... (omitted for brevity but logic remains)
        
        const pickupAddress = pickupEl.value.trim();
        const dropoffAddress = dropoffEl.value.trim();
        const pickupLatLon = `${pickupCoord[0]},${pickupCoord[1]}`;
        const dropoffLatLon = `${dropoffCoord[0]},${dropoffCoord[1]}`;
        
        finalZaloMessage = [
            'üöñ Y√äU C·∫¶U ƒê·∫∂T XE', '-------------------------------',
            `üìû SƒêT: [CH∆ØA C√ì]`, `Chuy·∫øn: ${tripType === '1' ? '1 Chi·ªÅu' : '2 Chi·ªÅu'}`, `Xe: ${carType}`, `T√†i x·∫ø: ${driverRequest}`,
            `üìç ƒê√≥n: ${pickupAddress}`, `üèÅ Tr·∫£: ${dropoffAddress}`, `üíµ Ph√≠: ${total.toLocaleString('vi-VN')} ƒë`,
            `üó∫Ô∏è V·ªã tr√≠ ƒë√≥n: ${GOOGLE_MAPS_BASE_URL}${pickupLatLon}`,
            `üõ£Ô∏è Ch·ªâ ƒë∆∞·ªùng: ${GOOGLE_MAPS_DIR_URL}${pickupLatLon}/${dropoffLatLon}`
        ].join('\n');

        zaloBtn.style.display = 'block';
        mailBtn.style.display = 'block';
        instructionText.innerHTML = '‚úÖ Calculation successful! Please click Book via Zalo/Mail to complete.';
        resultBox.scrollIntoView({ behavior: 'smooth' });
        return true;
    } catch (err) {
        console.error('Calculation error', err);
        distanceText.textContent = 'Error calculating route.';
        return false;
    }
}

calcBtn.addEventListener('click', async () => {
    if (!isServiceActive) { alert('Service is currently unavailable.'); return; }
    const success = await calculateAndGenerateMessage();
    if (success && tripTypeEl.value === '2') {
        const deposit = Math.round(finalTotalFee * 0.2);
        depositAmountEl.textContent = deposit.toLocaleString('vi-VN') + ' ƒë';
        depositModal.style.display = 'flex';
    }
});

function handleBookingClick(action) {
    if (finalTotalFee === 0) { alert('Please calculate the price first.'); return; }
    bookingAction = action;
    const phone = customerPhoneEl.value.trim();
    if (!validatePhone(phone)) {
        inputPhoneForBooking.value = phone;
        phoneModal.style.display = 'flex';
        inputPhoneForBooking.focus();
    } else {
        openFinalZaloModal(phone);
    }
}
zaloBtn.addEventListener('click', () => handleBookingClick('zalo'));
mailBtn.addEventListener('click', () => handleBookingClick('mail'));

confirmPhoneBtn.addEventListener('click', () => {
    const phone = inputPhoneForBooking.value.trim();
    if (!validatePhone(phone)) { alert('Please enter a valid 10-digit phone number.'); return; }
    customerPhoneEl.value = phone;
    phoneModal.style.display = 'none';
    if (bookingAction) openFinalZaloModal(phone);
});

closePhoneModalBtn.addEventListener('click', () => { phoneModal.style.display = 'none'; bookingAction = null; });
confirmDepositBtn.addEventListener('click', () => { depositModal.style.display = 'none'; });

function openFinalZaloModal(phone) {
    const finalMessage = finalZaloMessage.replace('[CH∆ØA C√ì]', phone);
    modalText.textContent = finalMessage;
    if (bookingAction === 'mail') {
        const encodedMsg = encodeURIComponent(finalMessage);
        const subject = 'Y√™u c·∫ßu ƒê·∫∑t xe';
        window.location.href = `mailto:netvuan@gmail.com?subject=${subject}&body=${encodedMsg}`;
    } else {
        zaloModal.style.display = 'flex';
        copyToClipboard(finalMessage);
    }
    bookingAction = null;
}

async function copyToClipboard(text) { try { await navigator.clipboard.writeText(text); return true; } catch (err) { return false; } }
copyModalBtn.addEventListener('click', async () => { if (await copyToClipboard(modalText.textContent)) alert('Copied!'); else alert('Copy failed.'); });
zaloModalBtn.addEventListener('click', () => { zaloModal.style.display = 'none'; window.open(ZALO_URL, '_blank'); });
closeModalBtn.addEventListener('click', () => { zaloModal.style.display = 'none'; });

function setMinPickupDateTime() {
    const minTime = new Date(new Date().getTime() + 30 * 60000);
    const format = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    pickupDateTime.min = format(minTime);
    if (!pickupDateTime.value) pickupDateTime.value = format(minTime);
}

document.addEventListener('DOMContentLoaded', async () => {
    const savedLang = localStorage.getItem('language') || 'vi';
    updateLanguage(savedLang);

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            updateLanguage(btn.dataset.lang);
        });
    });

    setMinPickupDateTime();
    getGeolocation();
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
        }
        setMinPickupDateTime();
    }, 15000); 
    
    reloadLocationBtn.addEventListener('click', getGeolocation); 
});

if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('SW registered.')).catch(err => console.log('SW registration failed:', err)); }); }
</script>
</body>
</html>
