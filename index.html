<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-i18n="appTitle">üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#28a745">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* COLOR PALETTE & VARIABLES */
        :root{
            --green: #28a745; /* M√†u th∆∞∆°ng hi·ªáu ch√≠nh */
            --green-dark: #1e7e34; /* M√†u hover */
            --muted: #6c757d;
            --light-gray: #f4f6f8;
            --white: #ffffff;
            --primary: var(--green);
            --danger: #dc3545;
        }

        /* RESET & BASE */
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: 'Roboto', Arial, Helvetica, sans-serif; /* √Åp d·ª•ng font m·ªõi */
            color:#111;
            background: var(--light-gray);
        }
        #main-content {
            background:var(--light-gray);
            padding: 0;
        }

        /* HEADER */
        header{
            background:var(--green);
            color:var(--white);
            padding:12px 16px;
            text-align:center;
            font-weight:700;
            line-height:1.4;
            display: flex; /* D√πng flex cho b·ªë c·ª•c hi·ªán ƒë·∫°i */
            flex-direction: column;
            align-items: center;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 720px; /* Gi·ªØ gi·ªõi h·∫°n cho m√†n h√¨nh l·ªõn */
        }
        .header-title {
            font-size:22px;
            text-align: left;
            flex-grow: 1;
        }
        .header-info {
            font-size: 14px;
            font-weight: 500;
            margin-top: 4px;
        }
        .phone-number{
            font-size:18px;
            font-weight:900;
            margin-top:4px;
        }
        #language-switcher {
            /* V·ªã tr√≠ ban ƒë·∫ßu: T√°ch kh·ªèi SƒêT, sang ph·∫£i */
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: #34c759;
            color: white;
            font-weight: 500;
            font-size: 14px;
        }
        /* C·∫£i ti·∫øn b·ªë c·ª•c header - cƒÉn gi·ªØa cho m√†n h√¨nh nh·ªè */
        header .header-top {
            flex-direction: column;
            align-items: center;
        }
        header .header-title {
            text-align: center;
            font-size: 20px;
        }
        header .phone-number {
            margin-top: 8px;
        }
        header .header-info {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }
        header #language-switcher {
            margin-left: 15px; /* Th√™m kho·∫£ng c√°ch n·∫øu kh√¥ng ph·∫£i l√† ph·∫ßn c·ªßa title */
        }

        /* CONTAINER & LAYOUT */
        .container{
            padding:16px 12px; /* TƒÉng padding t·ªïng th·ªÉ */
        }
        .label-row{
            display:flex;
            align-items:center;
            gap:8px;
            margin-top:18px; /* TƒÉng kho·∫£ng c√°ch gi·ªØa c√°c ph·∫ßn ch√≠nh */
        }
        .label-row:first-of-type { margin-top: 6px; }
        .label-row h3{
            margin:0;
            font-size:17px; /* TƒÉng c·ª° ch·ªØ label */
            font-weight: 700;
            color: #333;
            /* FIX: Th√™m margin cho c√°c icon/emoji ƒë·ªÉ tr√°nh l·ªói m·∫•t icon */
            display: flex;
            align-items: center;
        }
        .label-row h3 > span:first-child {
            margin-right: 8px; /* Kho·∫£ng c√°ch gi·ªØa icon v√† ch·ªØ */
            font-size: 1.2em; /* TƒÉng k√≠ch th∆∞·ªõc icon */
            line-height: 1;
        }
        #location-status-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        #reloadLocationBtn {
            cursor: pointer;
            font-style: normal;
            font-size: 20px;
            color: #007bff;
            transition: transform 0.2s;
        }
        #reloadLocationBtn:hover {
            transform: rotate(45deg);
        }

        /* INPUTS & CONTROLS */
        .input-row{position:relative;margin-top:8px}
        input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
            width:100%;
            padding:14px 16px; /* TƒÉng padding input */
            border-radius:12px; /* Bo tr√≤n h∆°n */
            border:1px solid #ddd;
            font-size:16px;
            background:var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2); /* Th√™m box shadow n·ªïi b·∫≠t */
            outline: none;
        }

        /* Clear Button (X) - ƒê√£ t·ªëi ∆∞u */
        .input-row .clear-btn {
            position: absolute;
            right: 80px;
            top: 50%;
            transform: translateY(-50%); /* CƒÉn gi·ªØa d·ªçc */
            height: 36px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh */
            width: 36px;
            background: #e9ecef;
            color: #6c757d;
            border: none;
            padding: 0;
            border-radius: 8px; /* Bo tr√≤n h√¨nh vu√¥ng */
            font-weight: 700;
            cursor: pointer;
            line-height: 1;
            font-size: 16px;
            display: none;
            z-index: 1000;
            transition: background 0.1s;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }
        .input-row input:focus + .clear-btn, .input-row .clear-btn:hover {
            display: flex;
            opacity: 1;
        }
        .input-row .clear-btn:hover { background: #dee2e6; color: #495057; }
        input[type="text"]{
            padding-right: 140px;
        }

        /* Map Button - ƒê√£ t·ªëi ∆∞u */
        .map-btn{
            position:absolute;
            right:8px;
            top: 50%;
            transform: translateY(-50%); /* CƒÉn gi·ªØa d·ªçc */
            background:var(--primary);
            color:var(--white);
            border:0;
            padding:8px 10px; /* TƒÉng padding n√∫t b·∫£n ƒë·ªì */
            border-radius:10px; /* Bo tr√≤n h∆°n */
            font-weight:700;
            cursor:pointer;
            line-height: 1.2;
            transition: background 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .map-btn:hover {
            background: var(--green-dark);
        }

        /* Stop Input/Remove */
        .way-wrapper input[type="text"] {
            padding-right: 50px;
        }
        .way-remove{
            position:absolute;
            right:8px;
            top:50%;
            transform: translateY(-50%);
            background:#ff4d4d; /* M√†u ƒë·ªè n·ªïi b·∫≠t h∆°n */
            color:var(--white);
            border:0;
            padding:6px 10px;
            border-radius:8px;
            cursor:pointer;
            font-weight: 700;
            line-height: 1.5;
            transition: background 0.2s;
        }
        .way-remove:hover { background: #cc0000; }
        .way-wrapper .clear-btn { display: none !important; }

        /* General Buttons */
        .add-stop, .calc-btn {
            display:block;
            background:var(--primary);
            color:var(--white);
            border:none;
            border-radius:12px;
            font-weight:700;
            cursor:pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
            width: 100%;
        }
        .add-stop {
            padding:14px;
            font-size:16px;
            margin-top:16px;
        }
        .calc-btn {
            padding:16px;
            font-size:20px;
            margin-top:20px; /* TƒÉng kho·∫£ng c√°ch */
        }
        .add-stop:hover, .calc-btn:hover {
            background: var(--green-dark);
            transform: translateY(-1px);
        }
        .calc-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* MAP & SUGGESTIONS */
        #map{
            height:320px;
            margin-top:16px; /* TƒÉng margin */
            border-radius:12px;
            overflow:hidden;
            border: 1px solid #ddd;
        }
        .suggestions{
            position:absolute;
            left:0;
            right:0;
            top: calc(100% + 4px);
            background:var(--white);
            border:1px solid #ddd;
            border-radius:12px;
            max-height:240px; /* TƒÉng chi·ªÅu cao t·ªëi ƒëa */
            overflow:auto;
            -webkit-overflow-scrolling:touch;
            z-index:2000;
            box-shadow:0 8px 20px rgba(0,0,0,0.15);
        }
        .suggestions div{
            padding:12px;
            border-bottom:1px solid #f0f0f0;
            cursor:pointer;
            display:flex;
            gap:10px;
            align-items: center;
        }
        .suggestions div:last-child{border-bottom:0}
        .suggestions div:hover{background:#e9ecef}

        /* RESULT BOX - ƒê√£ T·ªëi ∆Øu */
        .result-box{
            margin-top:20px;
            padding:16px; /* TƒÉng padding */
            border-radius:12px;
            background:#e6f3e6; /* M√†u xanh nh·∫°t h∆°n, ph√π h·ª£p v·ªõi brand green */
            border:1px solid #c8e6c9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .result-row{
            display:flex;
            align-items:center;
            gap:8px;
            margin-bottom: 8px;
        }
        .distance-text{font-size:16px; font-weight: 500;}
        .price-title{
            font-weight:800;
            font-size: 18px;
            margin-top:10px;
            color: #333;
        }
        .price-value{
            font-size:30px; /* TƒÉng c·ª° ch·ªØ gi√° */
            color: var(--primary); /* ƒê·ªïi m√†u th∆∞∆°ng hi·ªáu */
            font-weight:900;
            display: block;
            margin-top: 4px;
        }
        .price-break{
            margin-top:10px;
            font-size:14px;
            line-height: 1.6;
            color: #555;
            border-top: 1px solid #c8e6c9;
            padding-top: 8px;
        }

        /* ACTIONS (Booking Buttons) */
        .actions{display:flex;gap:12px;margin-top:20px}
        .actions a{
            flex:1;
            text-align:center;
            padding:14px;
            border-radius:10px;
            color:var(--white);
            text-decoration:none;
            font-weight:700;
            border: none;
            cursor:pointer;
            transition: opacity 0.2s, transform 0.1s, background 0.2s; /* Th√™m transition cho background */
            /* opacity: 0.5; */ /* FIX: Lo·∫°i b·ªè opacity m·∫∑c ƒë·ªãnh ƒë·ªÉ ki·ªÉm so√°t b·∫±ng class */
        }
        .actions a.active-booking {
            opacity: 1; /* N√∫t k√≠ch ho·∫°t */
            pointer-events: auto;
        }
        .actions a.inactive-booking {
            background: #ccc !important; /* M√†u x√°m khi ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·∫∑t */
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
            transform: none !important;
        }
        .actions a:not(.inactive-booking):hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .zalo-btn {background:#007bff; box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);} /* M√†u xanh Zalo */
        .mail{background:#dc3545; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);} /* M√†u ƒë·ªè Email */

        /* NOTE & STATUS */
        .note{
            margin-top:20px;
            font-size:14px;
            color:#333;
            background:var(--white);
            padding:15px;
            border-radius:12px;
            border: 1px solid #ddd;
        }
        .note ul {
            margin-top: 8px;
            padding-left: 20px;
        }
        #instructionText {
            margin-top: 16px !important;
            padding: 12px !important;
            background: #d1ecf1; /* M√†u xanh nh·∫°t cho th√¥ng b√°o */
            border-radius: 10px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            color: #0c5460;
            text-align: center;
        }
        #serviceOffNotice {
            margin-top: 16px;
            padding: 12px;
            background: #f8d7da; /* M√†u ƒë·ªè nh·∫°t cho c·∫£nh b√°o t·∫Øt d·ªãch v·ª• */
            color: #721c24;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            border: 1px solid #f5c6cb;
        }

        /* NEW: Driver Select Styling - C·∫£i ti·∫øn nh·∫π */
        #driverRequest {
            font-size: 16px;
            font-weight: 500;
            border: 1px solid var(--primary); /* Vi·ªÅn m√†u th∆∞∆°ng hi·ªáu */
        }
        .driver-option-highlight {
            color: var(--primary);
            font-weight: 900 !important;
            background-color: #f7fcf7;
        }
        .driver-option-avatar {
            margin-right: 5px;
            font-size: 1.1em;
            vertical-align: middle;
        }

        /* Modal Styling - ƒê√£ gi·ªØ nguy√™n v√† b·ªï sung hover/focus */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; display: none;
            justify-content: center; align-items: center; padding: 20px;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: #fff; border-radius: 16px; padding: 25px; /* TƒÉng padding */
            width: 100%; max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            animation: slideIn 0.3s;
        }
        .modal-content h3 {
            margin-top: 0; color: var(--green); font-size: 24px; text-align: center;
            font-weight: 800;
        }
        #modal-text {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            overflow-x: auto;
        }
        .modal-actions {
            display: flex; gap: 10px;
        }
        .modal-actions button {
            flex: 1; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .modal-actions button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        #copyModalBtn { background: #ffc107; color: #333; }
        #zaloModalBtn { background: #007bff; color: #fff; }
        #closeModalBtn { background: #ccc; color: #333; }

        /* Deposit Modal Styles */
        #depositModal .modal-content { background: #e6f3e6; border: 1px solid #c8e6c9; }
        #depositModal h3 { color: #155724; }
        #depositModal #depositAmount {
            font-weight: 900;
            font-size: 22px;
            color: #007bff;
            background: #fff;
            padding: 5px 12px;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #depositModal #confirmDepositBtn { background: var(--green); color: white; }

        /* Loading Overlay Style - CƒÉn gi·ªØa v·ªõi icon loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: var(--primary);
        }
        .loading-overlay::after {
            content: '‚öôÔ∏è'; /* Bi·ªÉu t∆∞·ª£ng loading */
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        @media(min-width:700px){
            .container{max-width:720px;margin:0 auto}
            header .header-top {
                flex-direction: row;
                justify-content: space-between;
                padding: 0 16px;
            }
            header .header-title {
                text-align: left;
                font-size: 22px;
                flex-grow: 0;
            }
            header .header-info {
                margin-top: 0;
            }
            header #language-switcher {
                margin-left: 15px;
            }
        }
    </style>
</head>
<body>
<div id="main-content">
    <header>
        <div class="header-top">
            <div class="header-title" data-i18n="headerService">üöñ D·ªãch V·ª• Taxi</div>
            <div class="header-info">
                <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">‚òéÔ∏è 0847526893</a>
                <select id="language-switcher">
                    <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
                    <option value="en">üá¨üáß English</option>
                    <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                </select>
            </div>
        </div>
        <div style="font-size: 16px;">Tr∆∞·ªùng An Driving</div>
    </header>

    <div class="container">

        <div id="serviceOffNotice" style="display:none;"></div>

        <div id="instructionText" data-i18n="statusChecking">
            üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...
        </div>

        <div id="booking-form-wrapper">

            <div class="label-row" style="margin-top:6px">
                <h3 data-i18n="labelPhone"><span>üìû</span> S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n (Kh√¥ng b·∫Øt bu·ªôc ƒë·ªÉ T√≠nh gi√°)</h3>
            </div>
            <input id="customerPhone" type="tel" data-i18n-placeholder="placeholderPhone" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel">

            <div class="label-row">
                <h3 data-i18n="labelPickup"><span>üìç</span> ƒêi·ªÉm ƒë√≥n</h3>
                <div id="location-status-wrapper">
                    <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;" data-i18n="statusLocating">(ƒêang t√¨m v·ªã tr√≠...)</span>
                    <i id="reloadLocationBtn" data-i18n-title="titleReloadLocation" title="Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠">üîÑ</i>
                </div>
            </div>
            <div class="input-row">
                <input id="pickup" type="text" data-i18n-placeholder="placeholderPickup" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)">
                <button class="clear-btn" data-input-id="pickup">‚úñ</button>
                <button class="map-btn" id="pick-from-map" data-i18n="btnMap">B·∫£n ƒë·ªì</button>
                <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
            </div>

            <div class="label-row">
                <h3 data-i18n="labelTime"><span>üïí</span> Ng√†y & Gi·ªù ƒë√≥n</h3>
            </div>
            <input id="pickupDateTime" type="datetime-local">

            <div id="stops"></div>
            <button class="add-stop" id="add-stop-btn" data-i18n="btnAddStop">Ôºã Th√™m ƒëi·ªÉm d·ª´ng</button>

            <div class="label-row">
                <h3 data-i18n="labelDropoff"><span>üèÅ</span> ƒêi·ªÉm ƒë·∫øn</h3>
            </div>
            <div class="input-row">
                <input id="dropoff" type="text" data-i18n-placeholder="placeholderDropoff" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
                <button class="clear-btn" data-input-id="dropoff">‚úñ</button>
                <button class="map-btn" id="pick-to-map" data-i18n="btnMap">B·∫£n ƒë·ªì</button>
                <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
            </div>

            <div class="label-row">
                <h3 data-i18n="labelCarType"><span>üöò</span> Lo·∫°i xe</h3>
            </div>
            <select id="carType">
                <option value="4 ch·ªó (10.000ƒë/km)" data-i18n="car4seater">Xe 4 ch·ªó (10.000ƒë/km)</option>
                <option value="7 ch·ªó (12.000ƒë/km)" data-i18n="car7seater">Xe 7 ch·ªó (12.000ƒë/km)</option>
            </select>

            <div class="label-row">
                <h3 data-i18n="labelDriverRequest">
                    <span>üßë‚Äç‚úàÔ∏è</span> Y√™u c·∫ßu T√†i x·∫ø
                </h3>
            </div>
            <select id="driverRequest">
                <option value="Tr∆∞·ªùng An Driving" class="driver-option-highlight" data-i18n="driverDefault">
                    ‚≠ê Tr∆∞·ªùng An Driving (M·∫∑c ƒë·ªãnh)
                </option>
                <option value="Thanh Loan">üë∏ Thanh Loan</option>
                <option value="ƒê√¨nh T√¢m">üßë‚Äç‚úàÔ∏è ƒê√¨nh T√¢m</option>
                <option value="H·∫£i ƒêƒÉng">üßë‚Äç‚úàÔ∏è H·∫£i ƒêƒÉng</option>
                <option value="L√™ T√¢m">üßë‚Äç‚úàÔ∏è L√™ T√¢m</option>
                <option value="Nguy·ªÖn Th·∫£o">üë∏ Nguy·ªÖn Th·∫£o</option>
                <option value="Qu·ªëc D≈©ng">üßë‚Äç‚úàÔ∏è Qu·ªëc D≈©ng</option>
                <option value="T√¢n H·ªì">üßë‚Äç‚úàÔ∏è T√¢n H·ªì</option>
                <option value="Tr·∫ßn Vinh">üßë‚Äç‚úàÔ∏è Tr·∫ßn Vinh</option>
                <option value="Xu√¢n Phong">üßë‚Äç‚úàÔ∏è Xu√¢n Phong</option>
            </select>
            <div class="label-row">
                <h3 data-i18n="labelTripType"><span>üöó</span> Lo·∫°i chuy·∫øn ƒëi</h3>
            </div>
            <select id="tripType">
                <option value="1" data-i18n="tripOneWay">1 chi·ªÅu</option>
                <option value="2" data-i18n="tripTwoWay">2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)</option>
            </select>

            <div id="waitingWrapper">
                <div class="label-row">
                    <h3 data-i18n="labelWaiting"><span>‚è≥</span> Th·ªùi gian ch·ªù (gi·ªù)</h3>
                </div>
                <input id="waiting" type="number" min="0" value="0" data-i18n-placeholder="placeholderWaiting" placeholder="Nh·∫≠p s·ªë gi·ªù ch·ªù">
            </div>

            <button class="calc-btn" id="calc-btn" data-i18n="btnCalculate">üí∞ T√≠nh gi√°</button>
        </div>

        <div id="map"></div>

        <div id="result" class="result-box" style="display:none">
            <div class="result-row">
                <div class="distance-text" id="distanceText"></div>
            </div>

            <div class="price-title" data-i18n="resultPriceTitle">üíµ Gi√° d·ª± ki·∫øn</div>
            <div class="price-value" id="priceValue">‚Äî ƒë</div>

            <div class="price-break" id="priceBreak"></div>

            <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst"></div>
            <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo"></div>
        </div>

        <div class="actions">
            <a id="zaloBtn" class="zalo-btn inactive-booking" href="javascript:void(0);" style="display:none;" data-i18n="btnBookZalo">üì± ƒê·∫∑t qua Zalo</a>
            <a id="mailBtn" class="mail inactive-booking" href="javascript:void(0);" style="display:none;" data-i18n="btnBookMail">üìß ƒê·∫∑t qua Mail</a>
        </div>

        <div class="note" data-i18n="noteMain">
            üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).
            <br>
            **Th·ªùi gian ch·ªù:**
            <ul>
                <li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li>
                <li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li>
                <li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li>
            </ul>
            Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.
        </div>
    </div>
</div>

<div id="depositModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalDepositTitle">üìù Y√™u c·∫ßu ƒê·∫∑t c·ªçc cho Chuy·∫øn 2 Chi·ªÅu</h3>
        <p data-i18n="modalDepositNotice1">
            **Qu√Ω kh√°ch vui l√≤ng l∆∞u √Ω:**<br>
            ƒê·ªÉ x√°c nh·∫≠n v√† ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• cho chuy·∫øn ƒëi **Hai chi·ªÅu** c·ªßa Qu√Ω kh√°ch, ch√∫ng t√¥i k√≠nh mong Qu√Ω kh√°ch **ƒë·∫∑t c·ªçc tr∆∞·ªõc 20%** tr√™n t·ªïng gi√° c∆∞·ªõc d·ª± ki·∫øn.
        </p>
        <p style="text-align:center; font-size:18px;">
            <span data-i18n="modalDepositAmountText">S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn:</span> <span id="depositAmount">0 ƒë</span>
        </p>
        <p data-i18n="modalDepositNotice2">
            Khi nh√¢n vi√™n **Tr∆∞·ªùng An Driving** ph·∫£n h·ªìi qua Zalo, ch√∫ng t√¥i s·∫Ω g·ª≠i **h∆∞·ªõng d·∫´n thanh to√°n c·ª• th·ªÉ** (chuy·ªÉn kho·∫£n) ƒë·ªÉ ho√†n t·∫•t th·ªß t·ª•c ƒë·∫∑t c·ªçc.
        </p>
        <p style="font-size:14px; color:#555;" data-i18n="modalDepositNote">
            **L∆∞u √Ω:** Ph·∫ßn c√≤n l·∫°i c·ªßa c∆∞·ªõc ph√≠ s·∫Ω ƒë∆∞·ª£c thanh to√°n tr·ª±c ti·∫øp cho t√†i x·∫ø sau khi k·∫øt th√∫c chuy·∫øn ƒëi.
            Xin ch√¢n th√†nh c·∫£m ∆°n Qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng d·ªãch v·ª•.
        </p>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmDepositBtn" style="width:100%;" data-i18n="modalDepositConfirm">ƒê√£ hi·ªÉu v√† Ti·∫øp t·ª•c</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalPhoneTitle">üìû Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i</h3>
        <p style="text-align:center;" data-i18n="modalPhoneNotice">Qu√Ω kh√°ch vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i ti·ªán li√™n h·ªá x√°c nh·∫≠n ƒë∆°n h√†ng.</p>
        <input id="inputPhoneForBooking" type="tel" data-i18n-placeholder="placeholderPhone" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel" required>
        <div class="modal-actions" style="margin-top:15px;">
            <button id="confirmPhoneBtn" data-i18n="modalPhoneConfirm">X√°c nh·∫≠n</button>
        </div>
        <button id="closePhoneModalBtn" style="width:100%; margin-top:10px; padding:12px; border-radius:10px; background:#ccc; color:#333;" data-i18n="modalClose">ƒê√≥ng</button>
    </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalBookingTitle">‚úÖ TH√îNG TIN ƒê·∫∂T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;" data-i18n="modalBookingNotice">Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn" data-i18n="modalBtnCopy">üìã Sao Ch√©p Th√¥ng Tin</button>
            <button id="zaloModalBtn" data-i18n="modalBtnZalo">üì± M·ªü Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:12px; border-radius:10px;" data-i18n="modalClose">ƒê√≥ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- I18N CONFIGURATION START ---------- */
const i18n = {
    vi: {
        appTitle: "üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving",
        headerService: "üöñ D·ªãch V·ª• Taxi",
        statusChecking: "üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...",
        statusActive: 'üí∞ B·∫•m "T√≠nh gi√°" ƒë·ªÉ xem chi ti·∫øt ƒë·∫∑t xe.',
        statusLocating: "(ƒêang t√¨m v·ªã tr√≠...)",
        titleReloadLocation: "Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠",

        // Form Labels & Placeholders
        labelPhone: "üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n (Kh√¥ng b·∫Øt bu·ªôc ƒë·ªÉ T√≠nh gi√°)",
        placeholderPhone: "Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)",
        labelPickup: "üìç ƒêi·ªÉm ƒë√≥n",
        placeholderPickup: "Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)",
        labelTime: "üïí Ng√†y & Gi·ªù ƒë√≥n",
        btnAddStop: "Ôºã Th√™m ƒëi·ªÉm d·ª´ng",
        labelDropoff: "üèÅ ƒêi·ªÉm ƒë·∫øn",
        placeholderDropoff: "Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi",
        labelCarType: "üöò Lo·∫°i xe",
        car4seater: "Xe 4 ch·ªó (10.000ƒë/km)",
        car7seater: "Xe 7 ch·ªó (12.000ƒë/km)",
        labelDriverRequest: "üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu T√†i x·∫ø",
        titleDriverIcon: "Icon n√†y c√≥ th·ªÉ thay b·∫±ng Avatar",
        driverDefault: "‚≠ê Tr∆∞·ªùng An Driving (M·∫∑c ƒë·ªãnh)",
        labelTripType: "üöó Lo·∫°i chuy·∫øn ƒëi",
        tripOneWay: "1 chi·ªÅu",
        tripTwoWay: "2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)",
        labelWaiting: "‚è≥ Th·ªùi gian ch·ªù (gi·ªù)",
        placeholderWaiting: "Nh·∫≠p s·ªë gi·ªù ch·ªù",
        btnCalculate: "üí∞ T√≠nh gi√°",
        btnMap: "B·∫£n ƒë·ªì",

        // Calculation Status & Results
        statusCalculating: "ƒêang t√≠nh to√°n...",
        statusCalculatingRoute: "ƒêang t√≠nh l·ªô tr√¨nh...",
        statusNoRoute: "Kh√¥ng t√≠nh ƒë∆∞·ª£c l·ªô tr√¨nh",
        statusNoCoord: "Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô ƒêi·ªÉm ", // + 'ƒë√≥n'/'ƒë·∫øn'
        resultPriceTitle: "üíµ Gi√° d·ª± ki·∫øn",
        resultDistance: "‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng:",
        resultTimeEst: "‚è± Th·ªùi gian d·ª± ki·∫øn:",
        resultPickupTime: "üïí Ng√†y gi·ªù ƒë√≥n:",

        // Notes
        noteMain: `üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).
¬†¬†¬†¬†¬† <br>
¬†¬†¬†¬†¬† **Th·ªùi gian ch·ªù:**
¬†¬†¬†¬†¬† <ul>
¬†¬†¬†¬†¬†¬†¬† <li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li>
¬†¬†¬†¬†¬†¬†¬† <li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li>
¬†¬†¬†¬†¬†¬†¬† <li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li>
¬†¬†¬†¬†¬† </ul>
¬†¬†¬†¬†¬† Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.`,

        // Booking Buttons
        btnBookZalo: "üì± ƒê·∫∑t qua Zalo",
        btnBookMail: "üìß ƒê·∫∑t qua Mail",

        // Modals
        modalClose: "ƒê√≥ng",
        modalBookingTitle: "‚úÖ TH√îNG TIN ƒê·∫∂T XE",
        modalBookingNotice: "Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:",
        modalBtnCopy: "üìã Sao Ch√©p Th√¥ng Tin",
        modalBtnZalo: "üì± M·ªü Zalo Chat",

        // Phone Modal
        modalPhoneTitle: "üìû Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i",
        modalPhoneNotice: "Qu√Ω kh√°ch vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i ti·ªán li√™n h·ªá x√°c nh·∫≠n ƒë∆°n h√†ng.",
        modalPhoneConfirm: "X√°c nh·∫≠n",

        // Deposit Modal
        modalDepositTitle: "üìù Y√™u c·∫ßu ƒê·∫∑t c·ªçc cho Chuy·∫øn 2 Chi·ªÅu",
        modalDepositNotice1: "**Qu√Ω kh√°ch vui l√≤ng l∆∞u √Ω:**<br>ƒê·ªÉ x√°c nh·∫≠n v√† ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• cho chuy·∫øn ƒëi **Hai chi·ªÅu** c·ªßa Qu√Ω kh√°ch, ch√∫ng t√¥i k√≠nh mong Qu√Ω kh√°ch **ƒë·∫∑t c·ªçc tr∆∞·ªõc 20%** tr√™n t·ªïng gi√° c∆∞·ªõc d·ª± ki·∫øn.",
        modalDepositAmountText: "S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn:",
        modalDepositNotice2: "Khi nh√¢n vi√™n **Tr∆∞·ªùng An Driving** ph·∫£n h·ªìi qua Zalo, ch√∫ng t√¥i s·∫Ω g·ª≠i **h∆∞·ªõng d·∫´n thanh to√°n c·ª• th·ªÉ** (chuy·ªÉn kho·∫£n) ƒë·ªÉ ho√†n t·∫•t th·ªß t·ª•c ƒë·∫∑t c·ªçc.",
        modalDepositNote: "**L∆∞u √Ω:** Ph·∫ßn c√≤n l·∫°i c·ªßa c∆∞·ªõc ph√≠ s·∫Ω ƒë∆∞·ª£c thanh to√°n tr·ª±c ti·∫øp cho t√†i x·∫ø sau khi k·∫øt th√∫c chuy·∫øn ƒëi. Xin ch√¢n th√†nh c·∫£m ∆°n Qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng d·ªãch v·ª•.",
        modalDepositConfirm: "ƒê√£ hi·ªÉu v√† Ti·∫øp t·ª•c",

        // Geolocation Errors
        errorNetwork: "‚ö†Ô∏è Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.",
        errorTimeout: "‚ö†Ô∏è Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª• qu√° l√¢u. Vi·ªác ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng.",
        errorServiceFetch: "‚ö†Ô∏è C·∫¢NH B√ÅO M·∫†NG: Kh√¥ng t√¨m th·∫•y file tr·∫°ng th√°i d·ªãch v·ª• (404/Server Error). Ch·ª©c nƒÉng ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng.",
        errorLocating: "‚ö†Ô∏è L·ªói t√¨m v·ªã tr√≠. Nh·∫≠p th·ªß c√¥ng.",
        errorDenied: "‚ùå B·ªã t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠.",
        errorUnavailable: "‚ùå V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng (B·∫≠t GPS).",
        errorTimeoutLoc: "‚ö†Ô∏è H·∫øt th·ªùi gian t√¨m v·ªã tr√≠.",
        errorNotSupported: "‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.",
        statusLocated: "‚úÖ ƒê√£ t√¨m th·∫•y v·ªã tr√≠",
        statusPopup: "üìç V·ªã tr√≠ hi·ªán t·∫°i",
        mapPopupPickup: "üìç ƒêi·ªÉm ƒë√≥n",
        mapPopupDropoff: "üèÅ ƒêi·ªÉm ƒë·∫øn",
        mapPopupStop: "üìç ƒêi·ªÉm d·ª´ng",
        alertPickup: '‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë√≥n.',
        alertDropoff: '‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë·∫øn.',
        alertWaiting: '‚ùå V√¨ b·∫°n ch·ªçn chuy·∫øn 2 chi·ªÅu, vui l√≤ng nh·∫≠p Th·ªùi gian ch·ªù (s·ªë gi·ªù) ƒë·ªÉ ch√∫ng t√¥i s·∫Øp x·∫øp xe. Gi√° tr·ªã ph·∫£i ‚â• 0.',
        alertNoCoord: 'Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô. H√£y ch·ªçn g·ª£i √Ω ho·∫∑c ƒë·∫∑t tr√™n b·∫£n ƒë·ªì.',
        alertNoStopCoord: 'Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô cho m·ªôt ƒêi·ªÉm d·ª´ng.',
        alertNoSuggestions: 'Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm',
        alertSearching: 'ƒêang t√¨m ki·∫øm...',
        alertMapPickPickup: 'B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë√≥n',
        alertMapPickDropoff: 'B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn',

    },
    en: {
        appTitle: "üöñ Truong An Driving Taxi Service",
        headerService: "üöñ Taxi Service",
        statusChecking: "üí∞ Checking service status...",
        statusActive: 'üí∞ Click "Calculate Price" for booking details.',
        statusLocating: "(Locating...)",
        titleReloadLocation: "Try to get location again",

        // Form Labels & Placeholders
        labelPhone: "üìû Your Phone Number (Optional for Price Calculation)",
        placeholderPhone: "Enter Phone No. (10 digits, e.g.: 0987654321)",
        labelPickup: "üìç Pickup Location",
        placeholderPickup: "Enter pickup address (or auto-locate)",
        labelTime: "üïí Pickup Date & Time",
        btnAddStop: "Ôºã Add Stopover",
        labelDropoff: "üèÅ Drop-off Location",
        placeholderDropoff: "Enter final drop-off address",
        labelCarType: "üöò Car Type",
        car4seater: "4 Seater (10,000ƒë/km)",
        car7seater: "7 Seater (12,000ƒë/km)",
        labelDriverRequest: "üßë‚Äç‚úàÔ∏è Driver Request",
        titleDriverIcon: "This icon can be replaced by an Avatar",
        driverDefault: "‚≠ê Truong An Driving (Default)",
        labelTripType: "üöó Trip Type",
        tripOneWay: "One-Way",
        tripTwoWay: "Two-Way (40% off return trip)",
        labelWaiting: "‚è≥ Waiting Time (hours)",
        placeholderWaiting: "Enter waiting time in hours",
        btnCalculate: "üí∞ Calculate Price",
        btnMap: "Map",

        // Calculation Status & Results
        statusCalculating: "Calculating...",
        statusCalculatingRoute: "Calculating route...",
        statusNoRoute: "Could not calculate route",
        statusNoCoord: "Could not find coordinates for ", // + 'Pickup'/'Drop-off'
        resultPriceTitle: "üíµ Estimated Price",
        resultDistance: "‚úèÔ∏è Distance:",
        resultTimeEst: "‚è± Estimated Time:",
        resultPickupTime: "üïí Pickup Date & Time:",

        // Notes
        noteMain: `üìå Note: Price 4-seater/7-seater: **10,000 VND/km** / **12,000 VND/km**. Two-way trip: 40% off return leg (applies to one-way trips **‚â• 45km**).
¬†¬†¬†¬†¬† <br>
¬†¬†¬†¬†¬† **Waiting Time:**
¬†¬†¬†¬†¬† <ul>
¬†¬†¬†¬†¬†¬†¬† <li>0‚Äì3 hours waiting: **Free**.</li>
¬†¬†¬†¬†¬†¬†¬† <li>From the 4th hour onwards, a surcharge of **50,000 VND/hour** applies.</li>
¬†¬†¬†¬†¬†¬†¬† <li>Waiting time is calculated from when the passenger **completes drop-off at the destination** until the car returns to pick up for the original starting point.</li>
¬†¬†¬†¬†¬† </ul>
¬†¬†¬†¬†¬† Price includes all road/toll fees.`,

        // Booking Buttons
        btnBookZalo: "üì± Book via Zalo",
        btnBookMail: "üìß Book via Mail",

        // Modals
        modalClose: "Close",
        modalBookingTitle: "‚úÖ BOOKING INFORMATION",
        modalBookingNotice: "Copy the information and send via Zalo:",
        modalBtnCopy: "üìã Copy Information",
        modalBtnZalo: "üì± Open Zalo Chat",

        // Phone Modal
        modalPhoneTitle: "üìû Please Enter Your Phone Number",
        modalPhoneNotice: "Please enter your phone number so we can contact you to confirm the order.",
        modalPhoneConfirm: "Confirm",

        // Deposit Modal
        modalDepositTitle: "üìù Deposit Required for Two-Way Trip",
        modalDepositNotice1: "**Dear customer, please note:**<br>To confirm and ensure service quality for your **Two-way** trip, we kindly request a **20% deposit** on the estimated total fare.",
        modalDepositAmountText: "Estimated deposit amount:",
        modalDepositNotice2: "When a **Truong An Driving** staff member responds via Zalo, we will send **specific payment instructions** (bank transfer) to finalize the deposit.",
        modalDepositNote: "**Note:** The remaining fare will be paid directly to the driver after the trip is completed. Thank you for trusting our service.",
        modalDepositConfirm: "I Understand and Continue",

        // Geolocation Errors
        errorNetwork: "‚ö†Ô∏è Device is OFFLINE or CONNECTION ERROR. Order confirmation is not possible.",
        errorTimeout: "‚ö†Ô∏è Service status check took too long. Booking is temporarily suspended.",
        errorServiceFetch: "‚ö†Ô∏è NETWORK WARNING: Service status file not found (404/Server Error). Booking functionality is suspended.",
        errorLocating: "‚ö†Ô∏è Location search error. Please enter manually.",
        errorDenied: "‚ùå Location access permission denied.",
        errorUnavailable: "‚ùå Location unavailable (Turn on GPS).",
        errorTimeoutLoc: "‚ö†Ô∏è Location search timed out.",
        errorNotSupported: "‚ùå Browser does not support Geolocation.",
        statusLocated: "‚úÖ Location found",
        statusPopup: "üìç Current Location",
        mapPopupPickup: "üìç Pickup Point",
        mapPopupDropoff: "üèÅ Drop-off Point",
        mapPopupStop: "üìç Stopover Point",
        alertPickup: '‚ùå Please enter the Pickup address.',
        alertDropoff: '‚ùå Please enter the Drop-off address.',
        alertWaiting: '‚ùå Since you chose a two-way trip, please enter the Waiting Time (hours) for us to arrange the car. Value must be ‚â• 0.',
        alertNoCoord: 'Coordinates not found. Please choose a suggestion or set on the map.',
        alertNoStopCoord: 'Coordinates not found for a Stopover.',
        alertNoSuggestions: 'No locations found',
        alertSearching: 'Searching...',
        alertMapPickPickup: 'Click on the map to select the pickup point',
        alertMapPickDropoff: 'Click on the map to select the drop-off point',
    },
    zh: {
        appTitle: "üöñ ÈïøÂÆâÈ©æÈ©∂Âá∫ÁßüËΩ¶ÊúçÂä°",
        headerService: "üöñ Âá∫ÁßüËΩ¶ÊúçÂä°",
        statusChecking: "üí∞ Ê≠£Âú®Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ...",
        statusActive: 'üí∞ ÁÇπÂáª‚ÄúËÆ°ÁÆó‰ª∑Ê†º‚ÄùÊü•ÁúãÈ¢ÑËÆ¢ËØ¶ÊÉÖ„ÄÇ',
        statusLocating: "(Ê≠£Âú®ÂÆö‰Ωç...)",
        titleReloadLocation: "Â∞ùËØïÈáçÊñ∞Ëé∑Âèñ‰ΩçÁΩÆ",

        // Form Labels & Placeholders
        labelPhone: "üìû ÊÇ®ÁöÑÁîµËØùÂè∑Á†Å (ËÆ°ÁÆó‰ª∑Ê†ºÂèØÈÄâ)",
        placeholderPhone: "ËæìÂÖ•ÁîµËØùÂè∑Á†Å (10‰ΩçÔºå‰æãÂ¶ÇÔºö0987654321)",
        labelPickup: "üìç ‰∏äËΩ¶Âú∞ÁÇπ",
        placeholderPickup: "ËæìÂÖ•‰∏äËΩ¶Âú∞ÂùÄ (ÊàñËá™Âä®ÂÆö‰Ωç)",
        labelTime: "üïí ‰∏äËΩ¶Êó•ÊúüÂíåÊó∂Èó¥",
        btnAddStop: "Ôºã Ê∑ªÂä†ÁªèÂÅúÁÇπ",
        labelDropoff: "üèÅ ÁõÆÁöÑÂú∞",
        placeholderDropoff: "ËæìÂÖ•ÊúÄÁªàÁõÆÁöÑÂú∞Âú∞ÂùÄ",
        labelCarType: "üöò ËΩ¶Âûã",
        car4seater: "4Â∫ßËΩ¶ (10,000ƒë/ÂÖ¨Èáå)",
        car7seater: "7Â∫ßËΩ¶ (12,000ƒë/ÂÖ¨Èáå)",
        labelDriverRequest: "üßë‚Äç‚úàÔ∏è Âè∏Êú∫Ë¶ÅÊ±Ç",
        titleDriverIcon: "Ê≠§ÂõæÊ†áÂèØÊõøÊç¢‰∏∫Â§¥ÂÉè",
        driverDefault: "‚≠ê ÈïøÂÆâÈ©æÈ©∂ (ÈªòËÆ§)",
        labelTripType: "üöó Ë°åÁ®ãÁ±ªÂûã",
        tripOneWay: "ÂçïÁ®ã",
        tripTwoWay: "ÂèåÁ®ã (ËøîÁ®ãÂáè40%)",
        labelWaiting: "‚è≥ Á≠âÂæÖÊó∂Èó¥ (Â∞èÊó∂)",
        placeholderWaiting: "ËæìÂÖ•Á≠âÂæÖÊó∂Èó¥(Â∞èÊó∂)",
        btnCalculate: "üí∞ ËÆ°ÁÆó‰ª∑Ê†º",
        btnMap: "Âú∞Âõæ",

        // Calculation Status & Results
        statusCalculating: "Ê≠£Âú®ËÆ°ÁÆó...",
        statusCalculatingRoute: "Ê≠£Âú®ËÆ°ÁÆóË∑ØÁ∫ø...",
        statusNoRoute: "Êó†Ê≥ïËÆ°ÁÆóË∑ØÁ∫ø",
        statusNoCoord: "Êâæ‰∏çÂà∞ÂùêÊ†áÔºö", // + '‰∏äËΩ¶'/'ÁõÆÁöÑÂú∞'
        resultPriceTitle: "üíµ È¢ÑËÆ°‰ª∑Ê†º",
        resultDistance: "‚úèÔ∏è Ë∑ùÁ¶ª:",
        resultTimeEst: "‚è± È¢ÑËÆ°Êó∂Èó¥:",
        resultPickupTime: "üïí ‰∏äËΩ¶Êó•ÊúüÂíåÊó∂Èó¥:",

        // Notes
        noteMain: `üìå Ê≥®ÊÑèÔºö4Â∫ß/7Â∫ßËΩ¶‰ª∑Ê†º: **10,000 Ë∂äÂçóÁõæ/ÂÖ¨Èáå** / **12,000 Ë∂äÂçóÁõæ/ÂÖ¨Èáå**„ÄÇÂèåÁ®ã: ËøîÁ®ãÂáè40% (ÈÄÇÁî®‰∫éÂçïÁ®ã **‚â• 45ÂÖ¨Èáå**)„ÄÇ
¬†¬†¬†¬†¬† <br>
¬†¬†¬†¬†¬† **Á≠âÂæÖÊó∂Èó¥:**
¬†¬†¬†¬†¬† <ul>
¬†¬†¬†¬†¬†¬†¬† <li>Á≠âÂæÖ 0‚Äì3 Â∞èÊó∂: **ÂÖçË¥π**„ÄÇ</li>
¬†¬†¬†¬†¬†¬†¬† <li>‰ªéÁ¨¨4Â∞èÊó∂Ëµ∑ÔºåÊØèÂ∞èÊó∂Âä†Êî∂ **50,000 Ë∂äÂçóÁõæ/Â∞èÊó∂**„ÄÇ</li>
¬†¬†¬†¬†¬†¬†¬† <li>Á≠âÂæÖÊó∂Èó¥‰ªé‰πòÂÆ¢Âú®**ÁõÆÁöÑÂú∞ÂÆåÊàê‰∏ãËΩ¶**ÂºÄÂßãËÆ°ÁÆóÔºåÁõ¥Âà∞ËΩ¶ËæÜËøîÂõûÊé•‰πòÂÆ¢ÂõûÂà∞ÊúÄÂàùÁöÑËµ∑ÁÇπ„ÄÇ</li>
¬†¬†¬†¬†¬† </ul>
¬†¬†¬†¬†¬† ‰ª∑Ê†ºÂ∑≤ÂåÖÂê´ÊâÄÊúâËøáË∑Ø/ËøáÊ°•Ë¥π„ÄÇ`,

        // Booking Buttons
        btnBookZalo: "üì± ÈÄöËøá Zalo È¢ÑËÆ¢",
        btnBookMail: "üìß ÈÄöËøáÈÇÆ‰ª∂È¢ÑËÆ¢",

        // Modals
        modalClose: "ÂÖ≥Èó≠",
        modalBookingTitle: "‚úÖ È¢ÑËÆ¢‰ø°ÊÅØ",
        modalBookingNotice: "Â§çÂà∂‰ø°ÊÅØÂπ∂ÈÄöËøá Zalo ÂèëÈÄÅ:",
        modalBtnCopy: "üìã Â§çÂà∂‰ø°ÊÅØ",
        modalBtnZalo: "üì± ÊâìÂºÄ Zalo ËÅäÂ§©",

        // Phone Modal
        modalPhoneTitle: "üìû ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å",
        modalPhoneNotice: "ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁîµËØùÂè∑Á†ÅÔºå‰ª•‰æøÊàë‰ª¨ËÅîÁ≥ªÊÇ®Á°ÆËÆ§ËÆ¢Âçï„ÄÇ",
        modalPhoneConfirm: "Á°ÆËÆ§",

        // Deposit Modal
        modalDepositTitle: "üìù ÂèåÁ®ãÊóÖË°åÈúÄÊîØ‰ªòÊäºÈáë",
        modalDepositNotice1: "**Â∞äÊï¨ÁöÑÂÆ¢Êà∑ÔºåËØ∑Ê≥®ÊÑè:**<br>‰∏∫Á°ÆËÆ§Âπ∂Á°Æ‰øùÊÇ®**ÂèåÁ®ã**ÊóÖË°åÁöÑÊúçÂä°Ë¥®ÈáèÔºåÊàë‰ª¨ÊÅ≥ËØ∑ÊÇ®È¢ÑÂÖàÊîØ‰ªòÈ¢Ñ‰º∞ÊÄªË¥πÁî®ÁöÑ **20% ÊäºÈáë**„ÄÇ",
        modalDepositAmountText: "È¢ÑËÆ°ÊäºÈáëÈáëÈ¢ù:",
        modalDepositNotice2: "ÂΩì **ÈïøÂÆâÈ©æÈ©∂** ÂëòÂ∑•ÈÄöËøá Zalo ÂõûÂ§çÊÇ®Êó∂ÔºåÊàë‰ª¨Â∞ÜÂèëÈÄÅ**ÂÖ∑‰ΩìÁöÑ‰ªòÊ¨æÊåáÁ§∫** (Èì∂Ë°åËΩ¨Ë¥¶) ‰ª•ÂÆåÊàêÊäºÈáëÊâãÁª≠„ÄÇ",
        modalDepositNote: "**Ê≥®ÊÑè:** Ââ©‰ΩôËΩ¶Ë¥πÂ∞ÜÂú®Ë°åÁ®ãÁªìÊùüÂêéÁõ¥Êé•ÊîØ‰ªòÁªôÂè∏Êú∫„ÄÇË°∑ÂøÉÊÑüË∞¢ÊÇ®ÂØπÊàë‰ª¨ÊúçÂä°ÁöÑ‰ø°‰ªª„ÄÇ",
        modalDepositConfirm: "ÊàëÂ∑≤‰∫ÜËß£Âπ∂ÁªßÁª≠",

        // Geolocation Errors
        errorNetwork: "‚ö†Ô∏è ËÆæÂ§áÂ§Ñ‰∫éÁ¶ªÁ∫øÁä∂ÊÄÅÊàñËøûÊé•ÈîôËØØ„ÄÇÊó†Ê≥ïÁ°ÆËÆ§ËÆ¢Âçï„ÄÇ",
        errorTimeout: "‚ö†Ô∏è ÊúçÂä°Áä∂ÊÄÅÊ£ÄÊü•Ë∂ÖÊó∂„ÄÇÈ¢ÑËÆ¢ÊöÇÊó∂ÂÅúÊ≠¢„ÄÇ",
        errorServiceFetch: "‚ö†Ô∏è ÁΩëÁªúË≠¶ÂëäÔºöÊâæ‰∏çÂà∞ÊúçÂä°Áä∂ÊÄÅÊñá‰ª∂ (404/ÊúçÂä°Âô®ÈîôËØØ)„ÄÇÈ¢ÑËÆ¢ÂäüËÉΩÂ∑≤ÊöÇÂÅú„ÄÇ",
        errorLocating: "‚ö†Ô∏è ÂÆö‰ΩçÈîôËØØ„ÄÇËØ∑ÊâãÂä®ËæìÂÖ•„ÄÇ",
        errorDenied: "‚ùå ‰ΩçÁΩÆËÆøÈóÆÊùÉÈôêË¢´ÊãíÁªù„ÄÇ",
        errorUnavailable: "‚ùå ‰ΩçÁΩÆ‰∏çÂèØÁî® (ËØ∑ÊâìÂºÄGPS)„ÄÇ",
        errorTimeoutLoc: "‚ö†Ô∏è ‰ΩçÁΩÆÊêúÁ¥¢Ë∂ÖÊó∂„ÄÇ",
        errorNotSupported: "‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅÂú∞ÁêÜÂÆö‰Ωç„ÄÇ",
        statusLocated: "‚úÖ Â∑≤ÊâæÂà∞‰ΩçÁΩÆ",
        statusPopup: "üìç ÂΩìÂâç‰ΩçÁΩÆ",
        mapPopupPickup: "üìç ‰∏äËΩ¶ÁÇπ",
        mapPopupDropoff: "üèÅ ‰∏ãËΩ¶ÁÇπ",
        mapPopupStop: "üìç ÁªèÂÅúÁÇπ",
        alertPickup: '‚ùå ËØ∑ËæìÂÖ•‰∏äËΩ¶Âú∞ÂùÄ„ÄÇ',
        alertDropoff: '‚ùå ËØ∑ËæìÂÖ•ÁõÆÁöÑÂú∞Âú∞ÂùÄ„ÄÇ',
        alertWaiting: '‚ùå ÊÇ®ÈÄâÊã©‰∫ÜÂèåÁ®ãÊóÖË°åÔºåËØ∑ËæìÂÖ•Á≠âÂæÖÊó∂Èó¥ (Â∞èÊó∂) ‰ª•‰æøÊàë‰ª¨ÂÆâÊéíËΩ¶ËæÜ„ÄÇËØ•ÂÄºÂøÖÈ°ª ‚â• 0„ÄÇ',
        alertNoCoord: 'Êâæ‰∏çÂà∞ÂùêÊ†á„ÄÇËØ∑ÈÄâÊã©Âª∫ËÆÆÊàñÂú®Âú∞Âõæ‰∏äËÆæÁΩÆ„ÄÇ',
        alertNoStopCoord: 'Êâæ‰∏çÂà∞Êüê‰∏™ÁªèÂÅúÁÇπÁöÑÂùêÊ†á„ÄÇ',
        alertNoSuggestions: 'Êú™ÊâæÂà∞Âú∞ÁÇπ',
        alertSearching: 'Ê≠£Âú®ÊêúÁ¥¢...',
        alertMapPickPickup: 'ÁÇπÂáªÂú∞ÂõæÈÄâÊã©‰∏äËΩ¶ÁÇπ',
        alertMapPickDropoff: 'ÁÇπÂáªÂú∞ÂõæÈÄâÊã©‰∏ãËΩ¶ÁÇπ',
    }
};

let currentLang = localStorage.getItem('lang') || 'vi';

function updateContent() {
    const translations = i18n[currentLang];

    // 1. Update text content
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[key]) {
            element.textContent = translations[key];
        }
    });

    // 2. Update attributes (placeholder, title)
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[key]) {
            element.setAttribute('placeholder', translations[key]);
        }
    });

    document.querySelectorAll('[data-i18n-title]').forEach(element => {
        const key = element.getAttribute('data-i18n-title');
        if (translations[key]) {
            element.setAttribute('title', translations[key]);
        }
    });

    // 3. Update <title> separately
    const titleEl = document.querySelector('title');
    if (titleEl) {
        const key = titleEl.getAttribute('data-i18n');
        if (translations[key]) {
            titleEl.textContent = translations[key];
        }
    }

    // 4. Update the select options for car type
    document.getElementById('carType').querySelector('option[data-i18n="car4seater"]').textContent = translations.car4seater;
    document.getElementById('carType').querySelector('option[data-i18n="car7seater"]').textContent = translations.car7seater;

    // 5. Update the select options for trip type
    document.getElementById('tripType').querySelector('option[data-i18n="tripOneWay"]').textContent = translations.tripOneWay;
    document.getElementById('tripType').querySelector('option[data-i18n="tripTwoWay"]').textContent = translations.tripTwoWay;

    // 6. Update HTML lang attribute
    document.documentElement.setAttribute('lang', currentLang);

    // 7. Update status/popup texts that are dynamically set elsewhere
    document.getElementById('location-status').textContent = translations.statusLocating;
    document.getElementById('instructionText').innerHTML = translations.statusChecking;

    // Update placeholder for stop inputs (since they are created dynamically)
    document.querySelectorAll('input[id^="stop-"]').forEach((input, index) => {
        input.setAttribute('placeholder', translations.placeholderPickup.replace('ƒëi·ªÉm ƒë√≥n', 'ƒëi·ªÉm d·ª´ng ' + (index + 1)).replace('pickup address', 'stopover ' + (index + 1)).replace('‰∏äËΩ¶Âú∞ÂùÄ', 'ÁªèÂÅúÁÇπ ' + (index + 1)));
    });

}

document.getElementById('language-switcher').addEventListener('change', (e) => {
    currentLang = e.target.value;
    localStorage.setItem('lang', currentLang);
    updateContent();
    // Re-check service status to update instruction text with new language
    checkServiceStatus().then(updateUIBasedOnStatus);
    // Re-validate phone status
    checkPhoneStatus();
});

// Set initial language in the switcher and update content
document.getElementById('language-switcher').value = currentLang;
updateContent();
/* ---------- I18N CONFIGURATION END ---------- */


/* ---------- C·∫•u h√¨nh T·ªëi ∆Øu H√≥a ---------- */
const REMOTE_STATUS_URL = "/status-local.json";
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse";
const OSRM = "https://router.project-osrm.org/route/v1/driving";

/* FIX: ƒê∆∞·ªùng link Google Maps b·ªã l·ªói. Thay th·∫ø b·∫±ng ƒë∆∞·ªùng link chu·∫©n (d√πng cho Zalo/Mail) */
const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/?api=1&query=";
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/?api=1&destination=";

const TAXI_PHONE = "0847526893";
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`;
const DEBOUNCE_TIME = 300;
const DEFAULT_CENTER = [10.77653, 106.70098];
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0';
let userLocation = null;
let isServiceActive = false;

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone');
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType');
const driverRequestEl = document.getElementById('driverRequest'); // New Driver Select
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper');
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn');
const mailBtn = document.getElementById('mailBtn');

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice');
const bookingFormWrapper = document.getElementById('booking-form-wrapper');

const locationStatusEl = document.getElementById('location-status');
const reloadLocationBtn = document.getElementById('reloadLocationBtn');

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn');
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

// New Modal DOM
const phoneModal = document.getElementById('phoneModal');
const inputPhoneForBooking = document.getElementById('inputPhoneForBooking');
const confirmPhoneBtn = document.getElementById('confirmPhoneBtn');
const closePhoneModalBtn = document.getElementById('closePhoneModalBtn');
const depositModal = document.getElementById('depositModal');
const depositAmount = document.getElementById('depositAmount');
const confirmDepositBtn = document.getElementById('confirmDepositBtn');

let finalZaloMessage = '';
let finalTotalFee = 0;
let map;
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null;
let stopCount = 0;
let lastFocusedStopId = null;
let bookingAction = null; // 'zalo' or 'mail'

/* ---------- T√çN HI·ªÜU KILL SWITCH (Polling) ---------- */

async function checkServiceStatus() {
¬†¬†¬† const cacheBuster = `?t=${Date.now()}`;
¬†¬†¬† const finalUrl = REMOTE_STATUS_URL + cacheBuster;

¬†¬†¬† try {
¬†¬†¬†¬†¬†¬†¬† const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) });

¬†¬†¬†¬†¬†¬†¬† if (!response.ok) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† return {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† active: false,
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† message_vn: i18n[currentLang].errorServiceFetch
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† };
¬†¬†¬†¬†¬†¬†¬† }

¬†¬†¬†¬†¬†¬†¬† const data = await response.json();
        // Use the current language version of the message
        let statusMessage = data[`message_${currentLang}`] || data.message_vn;
¬†¬†¬†¬†¬†¬†¬† return { active: data.active, message_vn: statusMessage };
¬†¬†¬† } catch (error) {
¬†¬†¬†¬†¬†¬†¬† let msg = i18n[currentLang].errorNetwork;
¬†¬†¬†¬†¬†¬†¬† if (error.name === 'TimeoutError') {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† msg = i18n[currentLang].errorTimeout;
¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬†¬†¬†¬†¬† console.error("L·ªói khi fetch tr·∫°ng th√°i d·ªãch v·ª•:", error);
¬†¬†¬†¬†¬†¬†¬† return {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† active: false,
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† message_vn: msg
¬†¬†¬†¬†¬†¬†¬† };
¬†¬†¬† }
}


async function updateUIBasedOnStatus(status) {
¬†¬†¬† if (status.active !== isServiceActive) {
¬†¬†¬†¬†¬†¬†¬† isServiceActive = status.active;
¬†¬†¬† }

¬†¬†¬† instructionText.style.display = 'block'; // Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh

¬†¬†¬† if (!isServiceActive) {
¬†¬†¬†¬†¬†¬†¬† // T·∫ÆT D·ªäCH V·ª§
¬†¬†¬†¬†¬†¬†¬† calcBtn.style.background = '#ccc';
¬†¬†¬†¬†¬†¬†¬† calcBtn.style.cursor = 'not-allowed';
¬†¬†¬†¬†¬†¬†¬† calcBtn.disabled = true;

¬†¬†¬†¬†¬†¬†¬† serviceOffNotice.style.display = 'block';
¬†¬†¬†¬†¬†¬†¬† serviceOffNotice.innerHTML = status.message_vn;

¬†¬†¬†¬†¬†¬†¬† // V√¥ hi·ªáu h√≥a form
¬†¬†¬†¬†¬†¬†¬† bookingFormWrapper.classList.add('disabled-form');

¬†¬†¬†¬†¬†¬†¬† zaloBtn.style.display = 'none';
¬†¬†¬†¬†¬†¬†¬† mailBtn.style.display = 'none';
¬†¬†¬†¬†¬†¬†¬† resultBox.style.display = 'none';
¬†¬†¬†¬†¬†¬†¬† instructionText.style.display = 'none';

¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† // M·ªû D·ªäCH V·ª§
¬†¬†¬†¬†¬†¬†¬† calcBtn.style.background = 'var(--green)';
¬†¬†¬†¬†¬†¬†¬† calcBtn.style.cursor = 'pointer';
¬†¬†¬†¬†¬†¬†¬† calcBtn.disabled = false;

¬†¬†¬†¬†¬†¬†¬† serviceOffNotice.style.display = 'none';

¬†¬†¬†¬†¬†¬†¬† // K√≠ch ho·∫°t form
¬†¬†¬†¬†¬†¬†¬† bookingFormWrapper.classList.remove('disabled-form');

¬†¬†¬†¬†¬†¬†¬† instructionText.innerHTML = status.message_vn || i18n[currentLang].statusActive;

        // Ensure buttons are visible
        zaloBtn.style.display = 'block';
        mailBtn.style.display = 'block';
¬†¬†¬† }
    checkPhoneStatus(); // Update booking button state based on phone
}

/* FIX: Regex validation cho SƒêT Vi·ªát Nam (10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0) */
function validatePhone(phone) {
¬†¬†¬† const phoneRegex = /^0\d{9}$/;
¬†¬†¬† return phoneRegex.test(phone);
}

/* FIX: H√†m ki·ªÉm tra v√† k√≠ch ho·∫°t/v√¥ hi·ªáu h√≥a n√∫t ƒë·∫∑t xe */
function checkPhoneStatus() {
    const phone = customerPhoneEl.value.trim();
    const isValid = validatePhone(phone);
    const hasPrice = resultBox.style.display === 'block';

    if (isValid && hasPrice) {
        zaloBtn.classList.remove('inactive-booking');
        mailBtn.classList.remove('inactive-booking');
    } else {
        zaloBtn.classList.add('inactive-booking');
        mailBtn.classList.add('inactive-booking');
    }
}

// L·∫Øng nghe s·ª± ki·ªán input tr√™n SƒêT ƒë·ªÉ ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
customerPhoneEl.addEventListener('input', checkPhoneStatus);


/* ---------- C√°c h√†m JS kh√°c (InitMap, Geolocation, Autocomplete, Calculate...) ƒê√£ c·∫≠p nh·∫≠t I18N ---------- */
function initMap(center) {
¬†¬†¬† if (!map) {
¬†¬†¬†¬†¬†¬†¬† map = L.map('map').setView(center, 11);
¬†¬†¬†¬†¬†¬†¬† L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

¬†¬†¬†¬†¬†¬†¬† map.on('click', handleMapClick);
¬†¬†¬†¬†¬†¬†¬† map.on('dblclick', handleMapDblClick);
¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† map.setView(center, 11);
¬†¬†¬† }
}

async function reverseGeocode(lat, lon) {
¬†¬†¬† try {
¬†¬†¬†¬†¬†¬†¬† // Use the current language in the Nominatim request
¬†¬†¬†¬†¬†¬†¬† const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=${currentLang},en`;
¬†¬†¬†¬†¬†¬†¬† const r = await fetch(url);
¬†¬†¬†¬†¬†¬†¬† const data = await r.json();
¬†¬†¬†¬†¬†¬†¬† return data.display_name;
¬†¬†¬† } catch (e) {
¬†¬†¬†¬†¬†¬†¬† console.warn('Reverse Geocoding Error', e);
¬†¬†¬†¬†¬†¬†¬† return `${lat.toFixed(6)}, ${lon.toFixed(6)} (${i18n[currentLang].statusNoCoord + i18n[currentLang].labelPickup})`;
¬†¬†¬† }
}

function getGeolocation() {
    const translations = i18n[currentLang];
¬†¬†¬† locationStatusEl.textContent = translations.statusLocating;
¬†¬†¬† locationStatusEl.style.color = 'var(--muted)';
¬†¬†¬† reloadLocationBtn.style.color = '#ccc';
¬†¬†¬† reloadLocationBtn.style.pointerEvents = 'none';

¬†¬†¬† if(navigator.geolocation){
¬†¬†¬†¬†¬†¬†¬† navigator.geolocation.getCurrentPosition(async (pos)=>{
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† userLocation = [pos.coords.latitude, pos.coords.longitude];
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† initMap(userLocation);

¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const address = await reverseGeocode(userLocation[0], userLocation[1]);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† pickupEl.value = address;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† pickupEl.dataset.lat = userLocation[0];
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† pickupEl.dataset.lon = userLocation[1];
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† pickupEl.parentNode.querySelector('.clear-btn').style.display = 'flex';

¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if(pickupMarker) map.removeLayer(pickupMarker);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† pickupMarker = L.marker(userLocation).addTo(map).bindPopup(translations.statusPopup).openPopup();

¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† locationStatusEl.textContent = translations.statusLocated;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† locationStatusEl.style.color = 'var(--green)';
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† reloadLocationBtn.style.color = '#007bff';
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† reloadLocationBtn.style.pointerEvents = 'auto';


¬†¬†¬†¬†¬†¬†¬† }, (err)=>{
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† console.warn('Geolocation Error:', err.message);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† initMap(DEFAULT_CENTER);

¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† let statusText = translations.errorLocating;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if (err.code === err.PERMISSION_DENIED) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† statusText = translations.errorDenied;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† } else if (err.code === err.POSITION_UNAVAILABLE) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† statusText = translations.errorUnavailable;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† } else if (err.code === err.TIMEOUT) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† statusText = translations.errorTimeoutLoc;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† }

¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† locationStatusEl.textContent = statusText;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† locationStatusEl.style.color = '#dc3545';
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† reloadLocationBtn.style.color = '#007bff';
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† reloadLocationBtn.style.pointerEvents = 'auto';


¬†¬†¬†¬†¬†¬†¬† }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 });
¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† initMap(DEFAULT_CENTER);
¬†¬†¬†¬†¬†¬†¬† locationStatusEl.textContent = translations.errorNotSupported;
¬†¬†¬†¬†¬†¬†¬† locationStatusEl.style.color = '#dc3545';
¬†¬†¬†¬†¬†¬†¬† reloadLocationBtn.style.color = '#ccc';
¬†¬†¬†¬†¬†¬†¬† reloadLocationBtn.style.pointerEvents = 'none';
¬†¬†¬† }
}

function debounce(func, timeout = DEBOUNCE_TIME) {
¬† let timer;
¬† return (...args) => {
¬†¬†¬† clearTimeout(timer);
¬†¬†¬† timer = setTimeout(() => { func.apply(this, args); }, timeout);
¬† };
}

function toggleWaitingInput(){
¬†¬†¬† if(tripTypeEl.value === '1'){
¬†¬†¬†¬†¬†¬†¬† waitingWrapper.style.display = 'none';
¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† waitingWrapper.style.display = 'block';
¬†¬†¬† }
}

tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput();

document.querySelectorAll('.clear-btn').forEach(btn => {
¬†¬†¬† btn.addEventListener('click', (e) => {
¬†¬†¬†¬†¬†¬†¬† const inputId = e.target.dataset.inputId;
¬†¬†¬†¬†¬†¬†¬† const inputEl = document.getElementById(inputId);
¬†¬†¬†¬†¬†¬†¬† if (inputEl) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† inputEl.value = '';
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† delete inputEl.dataset.lat;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† delete inputEl.dataset.lon;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if (inputId === 'pickup' && pickupMarker) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† map.removeLayer(pickupMarker);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† pickupMarker = null;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† } else if (inputId === 'dropoff' && dropoffMarker) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† map.removeLayer(dropoffMarker);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† dropoffMarker = null;
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const suggBox = document.getElementById(`${inputId}-suggestions`);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if (suggBox) suggBox.style.display = 'none';
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† inputEl.focus();
¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬† });
});
document.querySelectorAll('input[type="text"]').forEach(inputEl => {
¬†¬†¬† const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
¬†¬†¬† if (clearBtn && !inputEl.id.startsWith('stop-')) { /* B·ªè qua stop inputs */
¬†¬†¬†¬†¬†¬†¬† inputEl.addEventListener('input', () => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
¬†¬†¬†¬†¬†¬†¬† });
¬†¬†¬†¬†¬†¬†¬† inputEl.addEventListener('focus', () => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
¬†¬†¬†¬†¬†¬†¬† });
¬†¬†¬†¬†¬†¬†¬† inputEl.addEventListener('blur', () => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† setTimeout(() => clearBtn.style.display = 'none', 150);
¬†¬†¬†¬†¬†¬†¬† });
        // Set initial state
        if (inputEl.value.trim()) clearBtn.style.display = 'flex';
¬†¬†¬† }
});


async function geocodeOnce(query){
¬† try{
¬†¬†¬† let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1&accept-language=${currentLang},en`;

¬†¬†¬† // FIX: Removed &bounded=1 to allow searching for locations far from userLocation
¬†¬†¬† if(userLocation) {
¬†¬†¬†¬†¬†¬†¬† const [lat, lon] = userLocation;
¬†¬†¬†¬†¬†¬†¬† url += `&viewbox=${lon - 0.5},${lat - 0.5},${lon + 0.5},${lat + 0.5}`;
¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
¬†¬†¬† }

¬†¬†¬† const r = await fetch(url);
¬†¬†¬† const data = await r.json();
¬†¬†¬† if(Array.isArray(data) && data.length>0) return data[0];
¬† }catch(e){ console.warn('geocode once error', e); }
¬† return null;
}

function attachAutocomplete(inputEl, boxEl){
¬† let controller = null;
    const translations = i18n[currentLang];

¬† const doSearch = async ()=>{
¬†¬†¬† const q = inputEl.value.trim();
¬†¬†¬† const clearBtn = inputEl.parentNode.querySelector('.clear-btn');

¬†¬†¬† if(!q){
¬†¬†¬†¬†¬†¬†¬† boxEl.style.display = 'none';
¬†¬†¬†¬†¬†¬†¬† if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'none';
¬†¬†¬†¬†¬†¬†¬† return;
¬†¬†¬† }
¬†¬†¬† if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'flex';

¬†¬†¬† if(controller) controller.abort();
¬†¬†¬† controller = new AbortController();

¬†¬†¬† boxEl.innerHTML = `<div>${translations.alertSearching}</div>`;
¬†¬†¬† boxEl.style.display = 'block';

¬†¬†¬† let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=${currentLang},en`;

¬†¬†¬† // FIX: Removed &bounded=1 to allow searching for locations far from userLocation
¬†¬†¬† if(userLocation) {
¬†¬†¬†¬†¬†¬†¬† const [lat, lon] = userLocation;
¬†¬†¬†¬†¬†¬†¬† url += `&viewbox=${lon - 0.3},${lat - 0.3},${lon + 0.3},${lat + 0.3}`;
¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
¬†¬†¬† }


¬†¬†¬† try{
¬†¬†¬†¬†¬† const res = await fetch(url, { signal: controller.signal });
¬†¬†¬†¬†¬† const data = await res.json();

¬†¬†¬†¬†¬† const fragment = document.createDocumentFragment();

¬†¬†¬†¬†¬† if(!Array.isArray(data) || data.length === 0){
¬†¬†¬†¬†¬†¬†¬† boxEl.innerHTML = `<div>${translations.alertNoSuggestions}</div>`;
¬†¬†¬†¬†¬†¬†¬† setTimeout(() => boxEl.style.display = 'none', 1000);
¬†¬†¬†¬†¬†¬†¬† return;
¬†¬†¬†¬†¬† }

¬†¬†¬†¬†¬† data.forEach(place => {
¬†¬†¬†¬†¬†¬†¬† const d = document.createElement('div');
¬†¬†¬†¬†¬†¬†¬† d.innerHTML = `<span style="font-size:16px">üìç</span><div style="margin-left:8px">${place.display_name}</div>`;
¬†¬†¬†¬†¬†¬†¬† d.addEventListener('click', ()=>{
¬†¬†¬†¬†¬†¬†¬†¬†¬† inputEl.value = place.display_name;
¬†¬†¬†¬†¬†¬†¬†¬†¬† inputEl.dataset.lat = place.lat;
¬†¬†¬†¬†¬†¬†¬†¬†¬† inputEl.dataset.lon = place.lon;
¬†¬†¬†¬†¬†¬†¬†¬†¬† boxEl.style.display = 'none';
¬†¬†¬†¬†¬†¬†¬†¬†¬† if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'flex';

¬†¬†¬†¬†¬†¬†¬†¬†¬† const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
¬†¬†¬†¬†¬†¬†¬†¬†¬† if(map) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if(inputEl.id === 'pickup'){
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if(pickupMarker) map.removeLayer(pickupMarker);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† pickupMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupPickup).openPopup();
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† map.setView(latlng, 14);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† } else if(inputEl.id === 'dropoff'){
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if(dropoffMarker) map.removeLayer(dropoffMarker);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† dropoffMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupDropoff).openPopup();
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† map.setView(latlng, 14);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬†¬†¬†¬†¬† });
¬†¬†¬†¬†¬†¬†¬† fragment.appendChild(d);
¬†¬†¬†¬†¬† });

¬†¬†¬†¬†¬† boxEl.innerHTML = '';
¬†¬†¬†¬†¬† boxEl.appendChild(fragment);
¬†¬†¬†¬†¬† boxEl.style.display = 'block';

¬†¬†¬† }catch(err){
¬†¬†¬†¬†¬† if(err.name === 'AbortError') return;
¬†¬†¬†¬†¬† console.error('suggest error', err);
¬†¬†¬†¬†¬† boxEl.innerHTML = '<div>L·ªói m·∫°ng ho·∫∑c API. Th·ª≠ l·∫°i</div>'; // Keep in VN for now, assuming mostly network issue
¬†¬†¬†¬†¬† setTimeout(() => boxEl.style.display = 'none', 2000);
¬†¬†¬† }
¬† };

¬† inputEl.addEventListener('input', debounce(doSearch));

¬† document.addEventListener('click', (ev)=>{
¬†¬†¬† if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none';
¬† });

¬† inputEl.addEventListener('focus', ()=> {
¬†¬†¬† const inputId = inputEl.id;
¬†¬†¬† if(inputId && inputId.startsWith('stop-')) lastFocusedStopId = inputId;
¬†¬†¬† else lastFocusedStopId = null;

¬†¬†¬† const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
¬†¬†¬† if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
¬† });
}

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

function createStopInput(prefill=''){
¬† stopCount++;
    const translations = i18n[currentLang];
¬† const wrapper = document.createElement('div');
¬† wrapper.className = 'way-wrapper input-row';
¬† const inputId = `stop-${stopCount}`;
¬† const suggId = `${inputId}-suggestions`;
¬† wrapper.innerHTML = `
¬†¬†¬† <input type="text" id="${inputId}" placeholder="${translations.placeholderPickup.replace('ƒëi·ªÉm ƒë√≥n', 'ƒëi·ªÉm d·ª´ng ' + stopCount).replace('pickup address', 'stopover ' + stopCount).replace('‰∏äËΩ¶Âú∞ÂùÄ', 'ÁªèÂÅúÁÇπ ' + stopCount)}">
¬†¬†¬† <button class="clear-btn" data-input-id="${inputId}">‚úñ</button>
¬†¬†¬† <button class="way-remove" title="X√≥a">‚úñ</button>
¬†¬†¬† <div id="${suggId}" class="suggestions" style="display:none"></div>
¬† `;
¬† stopsContainer.appendChild(wrapper);

¬† const inputEl = wrapper.querySelector('input');
¬† const boxEl = wrapper.querySelector('.suggestions');
¬† attachAutocomplete(inputEl, boxEl);

¬† const clearBtn = wrapper.querySelector('.clear-btn');
    /* NOTE: N√∫t clear-btn cho stop input s·∫Ω b·ªã ·∫©n b·ªüi CSS v√¨ ƒë√£ c√≥ n√∫t way-remove */
¬† inputEl.addEventListener('input', () => { if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none'; });
¬† inputEl.addEventListener('focus', () => { if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none'; });
¬† inputEl.addEventListener('blur', () => { setTimeout(() => { if(clearBtn) clearBtn.style.display = 'none'; }, 150); });
¬† clearBtn.addEventListener('click', (e) => {
¬†¬†¬† e.stopPropagation();
¬†¬†¬† inputEl.value = '';
¬†¬†¬† delete inputEl.dataset.lat;
¬†¬†¬† delete inputEl.dataset.lon;
¬†¬†¬† boxEl.style.display = 'none';
¬†¬†¬† inputEl.focus();
¬† });


¬† wrapper.querySelector('.way-remove').addEventListener('click', ()=> wrapper.remove());

¬† inputEl.addEventListener('focus', ()=> lastFocusedStopId = inputId);

¬† return inputEl;
}

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput());

document.getElementById('pick-from-map').addEventListener('click', ()=> {
    selecting = 'pickup';
    alert(i18n[currentLang].alertMapPickPickup);
});
document.getElementById('pick-to-map').addEventListener('click', ()=> {
    selecting = 'dropoff';
    alert(i18n[currentLang].alertMapPickDropoff);
});

const handleMapClick = async (e) => {
¬† if (!map) return;
¬† const lat = e.latlng.lat, lon = e.latlng.lng;
    const translations = i18n[currentLang];

¬† let targetInput, targetMarker;

¬† if(selecting === 'pickup'){
¬†¬†¬† targetInput = pickupEl;
¬†¬†¬† targetMarker = pickupMarker;
¬†¬†¬† if(pickupMarker) map.removeLayer(pickupMarker);
¬†¬†¬† pickupMarker = L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupPickup).openPopup();
¬†¬†¬† selecting = null;
¬† } else if(selecting === 'dropoff'){
¬†¬†¬† targetInput = dropoffEl;
¬†¬†¬† targetMarker = dropoffMarker;
¬†¬†¬† if(dropoffMarker) map.removeLayer(dropoffMarker);
¬†¬†¬† dropoffMarker = L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupDropoff).openPopup();
¬†¬†¬† selecting = null;
¬† } else if(lastFocusedStopId){
¬†¬†¬† targetInput = document.getElementById(lastFocusedStopId);
¬†¬†¬† if(targetInput){
¬†¬†¬†¬†¬† L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupStop).openPopup();
¬†¬†¬†¬†¬† lastFocusedStopId = null;
¬†¬†¬† }
¬† }

¬† if(targetInput){
¬†¬†¬† const address = await reverseGeocode(lat, lon);
¬†¬†¬† targetInput.value = address;

¬†¬†¬† targetInput.dataset.lat = lat; targetInput.dataset.lon = lon;
¬†¬†¬† const clearBtn = targetInput.parentNode.querySelector('.clear-btn');
¬†¬†¬† if(clearBtn && !targetInput.id.startsWith('stop-')) clearBtn.style.display = 'flex';

¬†¬†¬† if(targetMarker) map.setView([lat,lon], 14);
¬† }
};


const handleMapDblClick = (e) => {
¬† if (!map) return;
¬† if(lastFocusedStopId){
¬†¬†¬† const stopInput = document.getElementById(lastFocusedStopId);
¬†¬†¬† if(stopInput){
¬†¬†¬†¬†¬† stopInput.value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
¬†¬†¬†¬†¬† stopInput.dataset.lat = e.latlng.lat; stopInput.dataset.lon = e.latlng.lng;
¬†¬†¬†¬†¬† L.marker([e.latlng.lat,e.latlng.lng]).addTo(map).bindPopup(i18n[currentLang].mapPopupStop).openPopup();
¬†¬†¬†¬†¬† lastFocusedStopId = null;
¬†¬†¬† }
¬† }
};


async function resolveCoordForInput(inputEl){
¬† if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon){
¬†¬†¬† return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
¬† }
¬† const v = inputEl.value.trim();
¬† if(!v) return null;
¬† const parts = v.split(',');
¬† if(parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))){
¬†¬†¬† // Gi·∫£ ƒë·ªãnh nh·∫≠p Lat, Lon n·∫øu c√≥ 2 s·ªë
¬†¬†¬† return [parseFloat(parts[0]), parseFloat(parts[1])];
¬† }
¬† const place = await geocodeOnce(v + ' Vi·ªát Nam');
¬† if(place){
¬†¬†¬† inputEl.dataset.lat = place.lat;
¬†¬†¬† inputEl.dataset.lon = place.lon;
¬†¬†¬† return [parseFloat(place.lat), parseFloat(place.lon)];
¬† }
¬† return null;
}

function validateRouteInputs() {
    const translations = i18n[currentLang];
¬†¬†¬† if (pickupEl.value.trim() === '') {
¬†¬†¬†¬†¬†¬†¬† alert(translations.alertPickup);
¬†¬†¬†¬†¬†¬†¬† pickupEl.focus();
¬†¬†¬†¬†¬†¬†¬† return false;
¬†¬†¬† }
¬†¬†¬† if (dropoffEl.value.trim() === '') {
¬†¬†¬†¬†¬†¬†¬† alert(translations.alertDropoff);
¬†¬†¬†¬†¬†¬†¬† dropoffEl.focus();
¬†¬†¬†¬†¬†¬†¬† return false;
¬†¬†¬† }
¬†¬†¬† const tripType = tripTypeEl.value;
¬†¬†¬† const waiting = parseFloat(waitingEl.value);
¬†¬†¬† if (tripType === '2') {
¬†¬†¬†¬†¬†¬†¬† if (isNaN(waiting) || waiting < 0) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† alert(translations.alertWaiting);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† waitingEl.focus();
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† return false;
¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬† }
¬†¬†¬† return true;
}


// H√†m ch√≠nh t√≠nh gi√° c∆∞·ªõc v√† t·∫°o tin nh·∫Øn Zalo
async function calculateAndGenerateMessage() {
    const translations = i18n[currentLang];

¬†¬†¬† if (!validateRouteInputs()) {
¬†¬†¬†¬†¬†¬†¬† return false;
¬†¬†¬† }

¬†¬†¬† const pickupCoord = await resolveCoordForInput(pickupEl);
¬†¬†¬† if(!pickupCoord){ alert(translations.statusNoCoord + (currentLang === 'en' ? 'Pickup' : (currentLang === 'zh' ? '‰∏äËΩ¶' : 'ƒë√≥n')) + '. ' + translations.alertNoCoord); return false; }
¬†¬†¬† const dropoffCoord = await resolveCoordForInput(dropoffEl);
¬†¬†¬† if(!dropoffCoord){ alert(translations.statusNoCoord + (currentLang === 'en' ? 'Drop-off' : (currentLang === 'zh' ? 'ÁõÆÁöÑÂú∞' : 'ƒë·∫øn')) + '. ' + translations.alertNoCoord); return false; }

¬†¬†¬† const coords = [];
¬†¬†¬† coords.push(pickupCoord);
¬†¬†¬† const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
    const stopCoords = [];
¬†¬†¬† for(const s of stopInputs){
¬†¬†¬†¬†¬†¬†¬† if(s.value.trim()){
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const sc = await resolveCoordForInput(s);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if(!sc){ alert(translations.alertNoStopCoord); return false; }
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† coords.push(sc);
            stopCoords.push({input: s, coord: sc});
¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬† }
¬†¬†¬† coords.push(dropoffCoord);

¬†¬†¬† const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
¬†¬†¬† const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

¬†¬†¬† resultBox.style.display = 'block';
    // FIX: T·ª± ƒë·ªông cu·ªôn xu·ªëng k·∫øt qu·∫£ khi t√≠nh gi√°
    resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });

¬†¬†¬† distanceText.textContent = translations.statusCalculatingRoute;
¬†¬†¬† priceValue.textContent = '...';
¬†¬†¬† priceBreak.innerHTML = '';
¬†¬†¬† timeEst.textContent = '';
¬†¬†¬† finalZaloMessage = '';
¬†¬†¬† finalTotalFee = 0;
¬†¬†¬† instructionText.innerHTML = translations.statusCalculating;
    // V√¥ hi·ªáu h√≥a n√∫t ƒë·∫∑t xe trong khi t√≠nh to√°n
    zaloBtn.classList.add('inactive-booking');
    mailBtn.classList.add('inactive-booking');


¬†¬†¬† try{
¬†¬†¬†¬†¬†¬†¬† const r = await fetch(url);
¬†¬†¬†¬†¬†¬†¬† const data = await r.json();
¬†¬†¬†¬†¬†¬†¬† if(!data.routes || data.routes.length === 0){ distanceText.textContent = translations.statusNoRoute; return false; }
¬†¬†¬†¬†¬†¬†¬† const route = data.routes[0];
¬†¬†¬†¬†¬†¬†¬† const dist = route.distance / 1000;
¬†¬†¬†¬†¬†¬†¬† const minutes = Math.round((route.duration / 60)); // OSRM gives duration in seconds

¬†¬†¬†¬†¬†¬†¬† if(map) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if(routeLayer) map.removeLayer(routeLayer);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
¬†¬†¬†¬†¬†¬†¬† }

¬†¬†¬†¬†¬†¬†¬† const tripType = tripTypeEl.value;
¬†¬†¬†¬†¬†¬†¬† const carType = carTypeEl.value;
¬†¬†¬†¬†¬†¬†¬† const driverRequest = driverRequestEl.value; // Get driver request
¬†¬†¬†¬†¬†¬†¬† const waiting = parseFloat(waitingEl.value) || 0;

¬†¬†¬†¬†¬†¬†¬† let perKm, carName, carPrice;
¬†¬†¬†¬†¬†¬†¬† if (carType.includes('7 ch·ªó') || carType.includes('7 Seater') || carType.includes('7Â∫ßËΩ¶')) {
                perKm = 12000;
                carName = translations.car7seater.replace(/ \(.+\)/, '');
                carPrice = '12.000ƒë/km';
            } else {
                perKm = 10000;
                carName = translations.car4seater.replace(/ \(.+\)/, '');
                carPrice = '10.000ƒë/km';
            }
¬†¬†¬†¬†¬†¬†¬† const perKmReturnDiscount = Math.round(perKm * 0.6);

¬†¬†¬†¬†¬†¬†¬† const priceGo = Math.round(dist * perKm);
¬†¬†¬†¬†¬†¬†¬† let priceReturn = 0;
¬†¬†¬†¬†¬†¬†¬† let returnNote = '';

¬†¬†¬†¬†¬†¬†¬† if(tripType === '2') {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if(dist >= 45) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† priceReturn = Math.round(dist * perKmReturnDiscount);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† returnNote = currentLang === 'en' ? `Return trip (40% off due to one-way ‚â• 45km => ${(perKmReturnDiscount/1000).toLocaleString('en-US')}k/km)` :
                           (currentLang === 'zh' ? `ËøîÁ®ã (ÂçïÁ®ã ‚â• 45ÂÖ¨ÈáåÔºåÂáè40% => ${(perKmReturnDiscount/1000).toLocaleString('zh-CN')}k/ÂÖ¨Èáå)` :
                           `Chi·ªÅu v·ªÅ (gi·∫£m 40% do 1 chi·ªÅu ‚â• 45km => ${perKmReturnDiscount.toLocaleString('vi-VN')}ƒë/km)`);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† priceReturn = Math.round(dist * perKm);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† returnNote = currentLang === 'en' ? `Return trip (No discount as one-way < 45km => ${(perKm/1000).toLocaleString('en-US')}k/km)` :
                           (currentLang === 'zh' ? `ËøîÁ®ã (ÂçïÁ®ã < 45ÂÖ¨ÈáåÔºåÊó†ÊäòÊâ£ => ${(perKm/1000).toLocaleString('zh-CN')}k/ÂÖ¨Èáå)` :
                           `Chi·ªÅu v·ªÅ (Kh√¥ng gi·∫£m gi√° do 1 chi·ªÅu < 45km => ${perKm.toLocaleString('vi-VN')}ƒë/km)`);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬†¬†¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† returnNote = translations.tripOneWay;
¬†¬†¬†¬†¬†¬†¬† }

¬†¬†¬†¬†¬†¬†¬† const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
¬†¬†¬†¬†¬†¬†¬† const total = priceGo + priceReturn + waitFee;
¬†¬†¬†¬†¬†¬†¬† finalTotalFee = total; // L∆∞u l·∫°i t·ªïng ph√≠
¬†¬†¬†¬†¬†¬†¬† const depositAmountValue = Math.round(total * 0.2); // T√≠nh ti·ªÅn ƒë·∫∑t c·ªçc

¬†¬†¬†¬†¬†¬†¬† // C·∫≠p nh·∫≠t hi·ªÉn th·ªã k·∫øt qu·∫£
¬†¬†¬†¬†¬†¬†¬† distanceText.textContent = `${translations.resultDistance} ${dist.toFixed(1)} km`;
¬†¬†¬†¬†¬†¬†¬† priceValue.textContent = `${total.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë`;

            priceBreak.innerHTML = `
                <span style="font-size: 14px; display: block; margin-bottom: 4px;">${carName}: ${carPrice}</span>
                <span>${translations.tripOneWay}: ${priceGo.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë</span><br>
                ${tripType === '2' ? `<span>${returnNote}: ${priceReturn.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë</span><br>` : ''}
                ${waitFee > 0 ? `<span>${translations.labelWaiting.replace(' (gi·ªù)', '')} (${waiting}h): ${waitFee.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë (+50k/h t·ª´ gi·ªù th·ª© 4)</span><br>` : ''}
                ${tripType === '2' && waitFee === 0 && waiting > 0 ? `<span>${translations.labelWaiting.replace(' (gi·ªù)', '')} (${waiting}h): 0 ƒë (Mi·ªÖn ph√≠ 3 gi·ªù ƒë·∫ßu)</span><br>` : ''}
            `;

¬†¬†¬†¬†¬†¬†¬† timeEst.textContent = `${translations.resultTimeEst} ${minutes} ${currentLang === 'en' ? 'minutes' : (currentLang === 'zh' ? 'ÂàÜÈíü' : 'ph√∫t')}`;

¬†¬†¬†¬†¬†¬†¬† const pickupDt = pickupDateTime.value ? new Date(pickupDateTime.value).toLocaleString(currentLang === 'en' ? 'en-US' : 'vi-VN', { dateStyle: 'short', timeStyle: 'short' }) : 'Kh√¥ng c√≥';
¬†¬†¬†¬†¬†¬†¬† pickupInfo.textContent = `${translations.resultPickupTime} ${pickupDt}`;

            /* FIX: C·∫≠p nh·∫≠t tin nh·∫Øn Zalo/Mail c√≥ th√™m link Google Maps */
            const getMapLink = (lat, lon) => `${GOOGLE_MAPS_BASE_URL}${lat},${lon}`;

¬†¬†¬†¬†¬†¬†¬† const stopAddresses = stopCoords.map((item, i) => {
                const mapLink = getMapLink(item.coord[0], item.coord[1]);
                const label = `${currentLang === 'en' ? 'Stopover' : (currentLang === 'zh' ? 'ÁªèÂÅúÁÇπ' : 'ƒêi·ªÉm d·ª´ng')} ${i+1}:`;
                return `${label} ${item.input.value}\n   [Link V·ªã Tr√≠: ${mapLink}]`;
            }).join('\n');

            const pickupMapLink = getMapLink(pickupCoord[0], pickupCoord[1]);
            const dropoffMapLink = getMapLink(dropoffCoord[0], dropoffCoord[1]);

            const zaloMessageLines = [
                `**${translations.modalBookingTitle.replace('‚úÖ ', '')}**`,
                `---`,
                `${translations.labelPhone.replace('üìû ', '').split(' (')[0]}: ${customerPhoneEl.value || (currentLang === 'en' ? 'Not provided' : (currentLang === 'zh' ? 'Êú™Êèê‰æõ' : 'Ch∆∞a cung c·∫•p'))}`,
                `${translations.labelPickup.replace('üìç ', '')}: ${pickupEl.value}`,
                `   [Link V·ªã Tr√≠ ƒê√≥n: ${pickupMapLink}]`,
                stopAddresses ? `\n${stopAddresses}\n` : '',
                `${translations.labelDropoff.replace('üèÅ ', '')}: ${dropoffEl.value}`,
                `   [Link V·ªã Tr√≠ Tr·∫£: ${dropoffMapLink}]`,
                `${translations.labelTime.replace('üïí ', '')}: ${pickupDt}`,
                `${translations.labelCarType.replace('üöò ', '')}: ${carName}`,
                `${translations.labelTripType.replace('üöó ', '')}: ${tripTypeEl.options[tripTypeEl.selectedIndex].text}`,
                `${translations.labelDriverRequest.replace(/üßë‚Äç‚úàÔ∏è|üë§ /, '').split(' (')[0]}: ${driverRequest}`,
                (tripType === '2' && waiting > 0) ? `${translations.labelWaiting.replace('‚è≥ ', '').replace(' (gi·ªù)', '')}: ${waiting} ${currentLang === 'en' ? 'hours' : (currentLang === 'zh' ? 'Â∞èÊó∂' : 'gi·ªù')}` : '',
                `---`,
                `${translations.resultDistance} ${dist.toFixed(1)} km`,
                `${translations.resultPriceTitle.replace('üíµ ', '')}: ${total.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë (∆Ø·ªõc t√≠nh)`,
                `(${translations.tripOneWay}: ${priceGo.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë ${tripType === '2' ? '+ ' + returnNote.split('(')[0].trim() + ' ' + priceReturn.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN')) + ' ƒë' : ''}${waitFee > 0 ? ' + ph√≠ ch·ªù' : ''})`,
                `---`,
                currentLang === 'en' ? 'Please confirm this information.' : (currentLang === 'zh' ? 'ËØ∑Á°ÆËÆ§Ëøô‰∫õ‰ø°ÊÅØ„ÄÇ' : 'Vui l√≤ng x√°c nh·∫≠n l·∫°i th√¥ng tin n√†y.'),
            ];

            finalZaloMessage = zaloMessageLines.filter(line => line.trim() !== '').join('\n');


¬†¬†¬†¬†¬†¬†¬† // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ƒë·∫∑t xe
            checkPhoneStatus();
¬†¬†¬†¬†¬†¬†¬† instructionText.innerHTML = translations.statusActive;

¬†¬†¬†¬†¬†¬†¬† return true;

¬†¬†¬† }catch(e){
¬†¬†¬†¬†¬†¬†¬† console.error('Route calculation error:', e);
¬†¬†¬†¬†¬†¬†¬† distanceText.textContent = translations.statusNoRoute;
¬†¬†¬†¬†¬†¬†¬† priceValue.textContent = 'L·ªñI';
¬†¬†¬†¬†¬†¬†¬† priceBreak.innerHTML = '';
¬†¬†¬†¬†¬†¬†¬† instructionText.innerHTML = translations.statusActive;
¬†¬†¬†¬†¬†¬†¬† return false;
¬†¬†¬† }
}

// B·∫Øt ƒë·∫ßu
document.addEventListener('DOMContentLoaded', ()=> {
¬†¬†¬† getGeolocation();
¬†¬†¬† checkServiceStatus().then(updateUIBasedOnStatus);
    // Set default pickup time to current time
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    pickupDateTime.value = now.toISOString().slice(0, 16);
});

reloadLocationBtn.addEventListener('click', getGeolocation);

calcBtn.addEventListener('click', calculateAndGenerateMessage);


// Logic Modals
function openModal(modalEl){
¬†¬†¬† modalEl.style.display = 'flex';
}
function closeModal(modalEl){
¬†¬†¬† modalEl.style.display = 'none';
}

zaloBtn.addEventListener('click', async (e) => {
¬†¬†¬† if (!isServiceActive) return;
    if (e.currentTarget.classList.contains('inactive-booking')) {
        alert(currentLang === 'en' ? 'Please enter a valid 10-digit phone number (e.g., 0987654321) to place an order.' : (currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ10‰ΩçÁîµËØùÂè∑Á†Å (‰æãÂ¶Ç 0987654321) Êù•‰∏ãËÆ¢Âçï„ÄÇ' : 'Vui l√≤ng nh·∫≠p SƒêT 10 s·ªë h·ª£p l·ªá (VD: 0987654321) ƒë·ªÉ ƒë·∫∑t xe.'));
        customerPhoneEl.focus();
        return;
    }

¬†¬†¬† const success = await calculateAndGenerateMessage();
¬†¬†¬† if (!success) return;

¬†¬†¬† bookingAction = 'zalo';
¬†¬†¬† const phone = customerPhoneEl.value.trim();

¬†¬†¬† if (tripTypeEl.value === '2') {
¬†¬†¬†¬†¬†¬†¬† // Show deposit modal first for two-way
¬†¬†¬†¬†¬†¬†¬† depositAmount.textContent = `${Math.round(finalTotalFee * 0.2).toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë`;
¬†¬†¬†¬†¬†¬†¬† openModal(depositModal);
¬†¬†¬†¬†¬†¬†¬† return; // Wait for deposit confirmation
¬†¬†¬† }

    // After price calculated and one-way trip, show Zalo modal
¬†¬†¬† showZaloModal();
});

mailBtn.addEventListener('click', async (e) => {
¬†¬†¬† if (!isServiceActive) return;
    if (e.currentTarget.classList.contains('inactive-booking')) {
        alert(currentLang === 'en' ? 'Please enter a valid 10-digit phone number (e.g., 0987654321) to place an order.' : (currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ10‰ΩçÁîµËØùÂè∑Á†Å (‰æãÂ¶Ç 0987654321) Êù•‰∏ãËÆ¢Âçï„ÄÇ' : 'Vui l√≤ng nh·∫≠p SƒêT 10 s·ªë h·ª£p l·ªá (VD: 0987654321) ƒë·ªÉ ƒë·∫∑t xe.'));
        customerPhoneEl.focus();
        return;
    }

¬†¬†¬† const success = await calculateAndGenerateMessage();
¬†¬†¬† if (!success) return;

¬†¬†¬† bookingAction = 'mail';

¬†¬†¬† if (tripTypeEl.value === '2') {
¬†¬†¬†¬†¬†¬†¬† // Show deposit modal first for two-way
¬†¬†¬†¬†¬†¬†¬† depositAmount.textContent = `${Math.round(finalTotalFee * 0.2).toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} ƒë`;
¬†¬†¬†¬†¬†¬†¬† openModal(depositModal);
¬†¬†¬†¬†¬†¬†¬† return; // Wait for deposit confirmation
¬†¬†¬† }

    // After price calculated and one-way trip, show mail modal
    showZaloModal(true);
});

confirmDepositBtn.addEventListener('click', () => {
¬†¬†¬† closeModal(depositModal);
¬†¬†¬† // Phone validation is already done before confirming deposit (via checkPhoneStatus/click handler)
¬†¬†¬† 
¬†¬†¬† if (bookingAction === 'zalo') showZaloModal();
¬†¬†¬† else if (bookingAction === 'mail') showZaloModal(true);
});

confirmPhoneBtn.addEventListener('click', () => {
¬†¬†¬† const phone = inputPhoneForBooking.value.trim();
¬†¬†¬† if (validatePhone(phone)) {
¬†¬†¬†¬†¬†¬†¬† customerPhoneEl.value = phone; // Update the main phone field
¬†¬†¬†¬†¬†¬†¬† closeModal(phoneModal);

¬†¬†¬†¬†¬†¬†¬† // Re-calculate and open final modal (in case price calc was skipped)
¬†¬†¬†¬†¬†¬†¬† calculateAndGenerateMessage().then(success => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if (success) {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† if (bookingAction === 'zalo') showZaloModal();
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† else if (bookingAction === 'mail') showZaloModal(true);
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† }
¬†¬†¬†¬†¬†¬†¬† });
¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† alert(currentLang === 'en' ? 'Please enter a valid 10-digit phone number (e.g., 0987654321).' : (currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ10‰ΩçÁîµËØùÂè∑Á†Å (‰æãÂ¶Ç 0987654321)„ÄÇ' : 'Vui l√≤ng nh·∫≠p SƒêT 10 s·ªë h·ª£p l·ªá (VD: 0987654321).'));
¬†¬†¬† }
});

closePhoneModalBtn.addEventListener('click', () => closeModal(phoneModal));
closeModalBtn.addEventListener('click', () => closeModal(zaloModal));

function showZaloModal(isMail = false) {
    const translations = i18n[currentLang];
¬†¬†¬† modalText.textContent = finalZaloMessage;

¬†¬†¬† const zaloBtn = document.getElementById('zaloModalBtn');
¬†¬†¬† const titleEl = zaloModal.querySelector('h3');
¬†¬†¬† const noticeEl = zaloModal.querySelector('p:nth-of-type(1)'); // The first <p> element

¬†¬†¬† if (isMail) {
¬†¬†¬†¬†¬†¬†¬† titleEl.textContent = translations.modalBookingTitle.replace('Zalo', 'Mail');
¬†¬†¬†¬†¬†¬†¬† noticeEl.innerHTML = currentLang === 'en' ? 'Copy the information and send via **Email**:' :
                           (currentLang === 'zh' ? 'Â§çÂà∂‰ø°ÊÅØÂπ∂ÈÄöËøá **ÈÇÆ‰ª∂** ÂèëÈÄÅ:' :
                           'Sao ch√©p th√¥ng tin v√† g·ª≠i qua **Email**:');
¬†¬†¬†¬†¬†¬†¬† zaloBtn.textContent = currentLang === 'en' ? 'üìß Send via Email' : (currentLang === 'zh' ? 'üìß ÈÄöËøáÈÇÆ‰ª∂ÂèëÈÄÅ' : 'üìß G·ª≠i qua Email');
¬†¬†¬†¬†¬†¬†¬† zaloBtn.style.background = '#dc3545';
¬†¬†¬†¬†¬†¬†¬† zaloBtn.onclick = () => {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† const subject = currentLang === 'en' ? 'Booking Truong An Driving' : (currentLang === 'zh' ? 'È¢ÑËÆ¢ÈïøÂÆâÈ©æÈ©∂' : 'ƒê·∫∑t xe Tr∆∞·ªùng An Driving');
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬† window.location.href = `mailto:truongan.driving@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(finalZaloMessage)}`;
¬†¬†¬†¬†¬†¬†¬† };
¬†¬†¬† } else {
¬†¬†¬†¬†¬†¬†¬† titleEl.textContent = translations.modalBookingTitle;
¬†¬†¬†¬†¬†¬†¬† noticeEl.textContent = translations.modalBookingNotice;
¬†¬†¬†¬†¬†¬†¬† zaloBtn.textContent = translations.modalBtnZalo;
¬†¬†¬†¬†¬†¬†¬† zaloBtn.style.background = '#007bff';
¬†¬†¬†¬†¬†¬†¬† zaloBtn.onclick = () => window.open(ZALO_URL, '_blank');
¬†¬†¬† }

¬†¬†¬† openModal(zaloModal);
}

copyModalBtn.addEventListener('click', () => {
¬†¬†¬† navigator.clipboard.writeText(modalText.textContent).then(() => {
¬†¬†¬†¬†¬†¬†¬† copyModalBtn.textContent = currentLang === 'en' ? '‚úÖ Copied!' : (currentLang === 'zh' ? '‚úÖ Â∑≤Â§çÂà∂ÔºÅ' : '‚úÖ ƒê√£ Sao Ch√©p!');
¬†¬†¬†¬†¬†¬†¬† setTimeout(() => copyModalBtn.textContent = i18n[currentLang].modalBtnCopy, 1500);
¬†¬†¬† }).catch(err => {
¬†¬†¬†¬†¬†¬†¬† console.error('Could not copy text: ', err);
¬†¬†¬†¬†¬†¬†¬† alert(currentLang === 'en' ? 'Copy failed. Please copy manually.' : (currentLang === 'zh' ? 'Â§çÂà∂Â§±Ë¥•„ÄÇËØ∑ÊâãÂä®Â§çÂà∂„ÄÇ' : 'Sao ch√©p th·∫•t b·∫°i. Vui l√≤ng copy th·ªß c√¥ng.'));
¬†¬†¬† });
});
</script>
</body>
</html>
