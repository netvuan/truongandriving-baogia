<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TR∆Ø·ªúNG AN DRIVING - H·ªÜ TH·ªêNG ƒê·∫∂T XE CHUY√äN NGHI·ªÜP</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* ============================================================
           CSS: GI·ªÆ NGUY√äN GIAO DI·ªÜN CHU·∫®N (APP MOBILE STYLE)
           ============================================================ */
        :root {
            --primary: #008000;    /* Xanh l√° Header */
            --danger: #dc3545;     /* ƒê·ªè gi√° ti·ªÅn */
            --info: #007bff;       /* Xanh Zalo/V·ªã tr√≠ */
            --bg-light: #f4f7f6;
            --price-bg: #e8f5e9;   /* N·ªÅn b·∫£ng gi√° xanh nh·∫°t */
            --yellow-hotline: #ffeb3b;
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-light);
            color: #333;
            line-height: 1.5;
        }

        /* Header */
        header {
            background-color: var(--primary);
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .brand-box .name { font-weight: 900; font-size: 17px; text-transform: uppercase; letter-spacing: 0.5px; }
        .hotline {
            display: inline-block; background: var(--yellow-hotline); color: #d00;
            font-weight: 800; padding: 3px 10px; border-radius: 4px;
            text-decoration: none; font-size: 13px; margin-top: 4px;
        }

        .lang-switcher { display: flex; gap: 5px; }
        .btn-lang {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
            color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;
        }
        .btn-lang.active { background: white; color: var(--primary); font-weight: bold; }

        /* Card Container */
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        .section-card { background: white; margin-bottom: 10px; padding: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sec-title {
            font-size: 14px; font-weight: 700; color: #666; margin-bottom: 15px;
            text-transform: uppercase; display: flex; align-items: center; gap: 8px;
        }
        .sec-title i { color: var(--primary); width: 18px; text-align: center; }

        /* Form Inputs */
        .form-group { margin-bottom: 15px; position: relative; }
        label { font-size: 13px; font-weight: 700; color: #444; margin-bottom: 6px; display: block; }
        
        input, select, textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 15px; outline: none; box-sizing: border-box;
            background: #fff; transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); }

        /* Input Icons/Buttons */
        .input-tools { position: absolute; right: 8px; top: 30px; display: flex; gap: 5px; }
        .tool-btn {
            width: 32px; height: 32px; border: none; border-radius: 6px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .btn-x { background: #f0f0f0; color: #999; display: none; }
        .btn-map-picker { background: var(--primary); color: white; }

        /* Search Feedback */
        .loading-text { font-size: 11px; color: var(--danger); font-style: italic; margin-top: 4px; display: none; }
        .suggestions {
            position: absolute; top: 100%; left: 0; right: 0; background: white;
            border: 1px solid #ddd; z-index: 1100; max-height: 250px; overflow-y: auto;
            border-radius: 0 0 8px 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none;
        }
        .sug-item {
            padding: 12px; border-bottom: 1px solid #f5f5f5; font-size: 14px;
            display: flex; gap: 10px; cursor: pointer;
        }
        .sug-item:hover { background: #f9f9f9; }

        /* Action Buttons */
        .btn-location {
            float: right; background: none; border: none; color: var(--info);
            font-weight: bold; font-size: 12px; cursor: pointer; margin-top: -28px;
        }
        .add-stop-btn {
            color: var(--primary); font-size: 13px; font-weight: bold; cursor: pointer;
            display: inline-block; margin-top: 5px; text-decoration: underline;
        }

        /* Maps */
        #main-map { height: 200px; border-radius: 10px; border: 1px solid #ddd; margin-top: 15px; display: none; }

        /* Results Area */
        #result-box { margin-top: 15px; display: none; }
        .price-panel {
            background: var(--price-bg); border: 1px solid #c8e6c9; border-radius: 10px;
            padding: 15px; position: relative;
        }
        .p-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .p-total {
            border-top: 1px dashed #aaa; margin-top: 10px; padding-top: 10px;
            text-align: center; font-size: 28px; font-weight: 900; color: var(--danger);
        }
        .deposit-notice {
            background: #fff3cd; color: #856404; padding: 8px; border-radius: 6px;
            font-size: 13px; font-weight: bold; display: flex; justify-content: space-between; margin-top: 10px;
        }

        /* Footer Nav */
        .footer-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            padding: 12px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1200;
        }
        .btn-action {
            flex: 1; padding: 14px; border: none; border-radius: 8px;
            color: white; font-weight: bold; font-size: 15px; text-transform: uppercase; cursor: pointer;
        }
        .btn-calc { background: var(--primary); }
        .btn-zalo { background: #0088ff; }
        .btn-mail { background: #ea4335; }

        /* Modal Map */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; padding: 20px; }
        .modal-content {
            background: white; width: 100%; height: 100%; border-radius: 15px;
            overflow: hidden; display: flex; flex-direction: column; position: relative;
        }
        #picker-map { flex: 1; width: 100%; }
        .modal-footer { padding: 15px; display: flex; gap: 10px; }
    </style>
</head>
<body>

<header>
    <div class="brand-box">
        <div class="name">TR∆Ø·ªúNG AN DRIVING</div>
        <a href="tel:0847526893" class="hotline">‚òé 084.752.6893</a>
    </div>
    <div class="lang-switcher">
        <button class="btn-lang active" onclick="setLang('vi')">VN</button>
        <button class="btn-lang" onclick="setLang('en')">EN</button>
        <button class="btn-lang" onclick="setLang('cn')">CN</button>
    </div>
</header>

<div class="container">
    <div class="section-card">
        <div class="sec-title"><i class="fas fa-user-edit"></i> TH√îNG TIN ƒê·∫∂T XE</div>
        <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i:</label>
            <input type="tel" id="u-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
            <div class="input-tools"><button class="tool-btn btn-x" onclick="clearInp('u-phone')">‚úï</button></div>
        </div>
        <div class="form-group">
            <label>Th·ªùi gian ƒë√≥n:</label>
            <input type="datetime-local" id="u-time">
        </div>
    </div>

    <div class="section-card">
        <div class="sec-title"><i class="fas fa-route"></i> L·ªò TR√åNH DI CHUY·ªÇN</div>
        <button class="btn-location" onclick="useCurrentLocation()"><i class="fas fa-crosshairs"></i> V·ªä TR√ç T√îI</button>
        
        <div class="form-group">
            <label>ƒêi·ªÉm ƒë√≥n:</label>
            <input type="text" id="loc-pickup" placeholder="T√¨m ƒëi·ªÉm ƒë√≥n..." autocomplete="off">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('loc-pickup')">‚úï</button>
                <button class="tool-btn btn-map-picker" onclick="showMapPicker('loc-pickup')"><i class="fas fa-map-marker-alt"></i></button>
            </div>
            <div class="loading-text" id="load-pickup">‚è≥ ƒêang t√¨m ki·∫øm... (Vui l√≤ng ƒë·ª£i 1s)</div>
            <div class="suggestions" id="sug-pickup"></div>
        </div>

        <div id="extra-stops"></div>
        <div class="add-stop-btn" onclick="addNewStop()">+ Th√™m ƒëi·ªÉm d·ª´ng (N·∫øu c√≥)</div>

        <div class="form-group" style="margin-top:15px;">
            <label>ƒêi·ªÉm ƒë·∫øn:</label>
            <input type="text" id="loc-dropoff" placeholder="T√¨m ƒëi·ªÉm ƒë·∫øn..." autocomplete="off">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('loc-dropoff')">‚úï</button>
                <button class="tool-btn btn-map-picker" onclick="showMapPicker('loc-dropoff')"><i class="fas fa-map-marker-alt"></i></button>
            </div>
            <div class="loading-text" id="load-dropoff">‚è≥ ƒêang t√¨m ki·∫øm... (Vui l√≤ng ƒë·ª£i 1s)</div>
            <div class="suggestions" id="sug-dropoff"></div>
        </div>

        <div id="main-map"></div>
    </div>

    <div class="section-card">
        <div class="sec-title"><i class="fas fa-car"></i> T√ôY CH·ªåN D·ªäCH V·ª§</div>
        <div style="display: flex; gap: 10px;">
            <div class="form-group" style="flex:1">
                <label>Lo·∫°i xe:</label>
                <select id="car-type" onchange="resetPrice()">
                    <option value="4">Xe 4 ch·ªó (10k/km)</option>
                    <option value="7">Xe 7 ch·ªó (12k/km)</option>
                </select>
            </div>
            <div class="form-group" style="flex:1">
                <label>H√¨nh th·ª©c:</label>
                <select id="trip-type" onchange="resetPrice()">
                    <option value="1">1 Chi·ªÅu</option>
                    <option value="2">2 Chi·ªÅu (-40% chi·ªÅu v·ªÅ)</option>
                </select>
            </div>
        </div>

        <div id="result-box">
            <div class="price-panel">
                <div class="p-row"><span>T·ªïng qu√£ng ƒë∆∞·ªùng:</span> <b id="res-km">0 km</b></div>
                <div class="p-row"><span>Gi√° chi·ªÅu ƒëi:</span> <b id="res-go">0 ƒë</b></div>
                <div id="res-back-row" style="display:none;" class="p-row">
                    <span>Chi·ªÅu v·ªÅ (Gi·∫£m 40%):</span> <b style="color:var(--primary)" id="res-back">0 ƒë</b>
                </div>
                <div id="res-deposit-row" style="display:none;" class="deposit-notice">
                    <span>C·ªçc gi·ªØ xe (20%):</span> <span id="res-deposit">0 ƒë</span>
                </div>
                <div class="p-total" id="res-total">0 ƒë</div>
                <p style="font-size: 11px; text-align: center; color: #777; margin-top: 10px;">
                    * Gi√° mang t√≠nh ch·∫•t tham kh·∫£o, ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="footer-nav">
    <button class="btn-action btn-calc" id="master-btn" onclick="mainCalculation()">T√çNH GI√Å C∆Ø·ªöC</button>
    <div id="booking-actions" style="display:none; width:100%; gap:10px;">
        <button class="btn-action btn-zalo" onclick="bookingAction('zalo')">ƒê·∫∂T QUA ZALO</button>
        <button class="btn-action btn-mail" onclick="bookingAction('email')">G·ª¨I EMAIL</button>
    </div>
</div>

<div class="modal" id="map-modal">
    <div class="modal-content">
        <div style="padding: 10px; background: var(--primary); color: white; font-weight: bold; text-align: center;">CH·ªåN V·ªä TR√ç TR√äN B·∫¢N ƒê·ªí</div>
        <div id="picker-map"></div>
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); z-index: 2001; pointer-events: none;">
            <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" alt="marker">
        </div>
        <div class="modal-footer">
            <button class="btn-action" style="background: #999;" onclick="closeMapPicker()">H·ª¶Y</button>
            <button class="btn-action btn-calc" onclick="confirmPickedLocation()">X√ÅC NH·∫¨N</button>
        </div>
    </div>
</div>

<script>
    /* ============================================================
       JAVASCRIPT: T√çCH H·ª¢P DEBOUNCE 1S & SESSION TOKEN
       ============================================================ */
    
    const GOONG_KEY = 'Lrrqqduqt0pfhNfmh0bzjN9lqwEqqY8rSpCs3gcG';
    
    // BI·∫æN TO√ÄN C·ª§C CHO SESSION TOKEN & DEBOUNCE
    let sessionToken = generateUUID(); // Kh·ªüi t·∫°o token khi m·ªü trang
    let debounceTimer = null;
    
    let map, pickerMap, routeLayer, activeInpId;

    // 1. T·∫°o Session Token (UUID)
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            let r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // 2. Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    function initMaps() {
        map = L.map('main-map').setView([10.8231, 106.6297], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        pickerMap = L.map('picker-map').setView([10.8231, 106.6297], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);
    }
    initMaps();

    // 3. T√çNH NƒÇNG T·ªêI ∆ØU: DEBOUNCE 1S V√Ä SEARCH V·ªöI SESSION TOKEN
    function setupAutocomplete(id) {
        const inp = document.getElementById(id);
        const load = inp.parentElement.querySelector('.loading-text');
        const sug = inp.parentElement.querySelector('.suggestions');

        inp.addEventListener('input', function() {
            toggleClearBtn(this);
            resetPrice();
            
            // X√≥a timer c≈© n·∫øu ng∆∞·ªùi d√πng v·∫´n ƒëang g√µ
            clearTimeout(debounceTimer);
            sug.style.display = 'none';

            if (this.value.length > 2) {
                load.style.display = 'block';
                
                // [DEBOUNCE 1S]: ƒê·ª£i kh√°ch d·ª´ng g√µ 1 gi√¢y m·ªõi g·ªçi API
                debounceTimer = setTimeout(() => {
                    fetchSuggestions(this, sug, load);
                }, 1000);
            } else {
                load.style.display = 'none';
            }
        });
    }

    async function fetchSuggestions(inp, sugBox, loadIcon) {
        // [SESSION TOKEN]: G·ª≠i k√®m token ƒë·ªÉ Goong gom nh√≥m c√°c request t√¨m ki·∫øm th√†nh 1 l·∫ßn t√≠nh ph√≠
        const url = `https://rsapi.goong.io/Place/AutoComplete?api_key=${GOONG_KEY}&input=${encodeURIComponent(inp.value)}&session_token=${sessionToken}`;
        
        try {
            const res = await fetch(url);
            const data = await res.json();
            loadIcon.style.display = 'none';
            
            if (data.predictions && data.predictions.length > 0) {
                sugBox.innerHTML = data.predictions.map(p => `
                    <div class="sug-item" onclick="selectPlace('${inp.id}', '${p.place_id}', '${p.description}')">
                        <i class="fas fa-map-marker-alt" style="color:#aaa"></i>
                        <div><b>${p.structured_formatting.main_text}</b><br><small>${p.structured_formatting.secondary_text}</small></div>
                    </div>
                `).join('');
                sugBox.style.display = 'block';
            }
        } catch (e) {
            console.error("L·ªói Autocomplete:", e);
        }
    }

    async function selectPlace(inpId, placeId, desc) {
        const inp = document.getElementById(inpId);
        inp.value = desc;
        inp.parentElement.querySelector('.suggestions').style.display = 'none';

        // L·∫•y t·ªça ƒë·ªô - V·∫´n d√πng Session Token c≈© ƒë·ªÉ ho√†n t·∫•t phi√™n l√†m vi·ªác
        const url = `https://rsapi.goong.io/Place/Detail?place_id=${placeId}&api_key=${GOONG_KEY}&session_token=${sessionToken}`;
        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.result) {
                inp.dataset.lat = data.result.geometry.location.lat;
                inp.dataset.lng = data.result.geometry.location.lng;
                
                // [RESET TOKEN]: Sau khi ƒë√£ ch·ªçn xong ƒë·ªãa ƒëi·ªÉm th√†nh c√¥ng, t·∫°o Token m·ªõi cho l·∫ßn t√¨m ƒë·ªãa ƒëi·ªÉm ti·∫øp theo
                sessionToken = generateUUID();
            }
        } catch (e) { console.error("L·ªói Detail:", e); }
    }

    // 4. C√°c ch·ª©c nƒÉng b·ªï tr·ª£ kh√°c
    setupAutocomplete('loc-pickup');
    setupAutocomplete('loc-dropoff');

    function toggleClearBtn(inp) {
        const btn = inp.parentElement.querySelector('.btn-x');
        btn.style.display = inp.value ? 'flex' : 'none';
    }

    function clearInp(id) {
        const i = document.getElementById(id); i.value = '';
        delete i.dataset.lat; delete i.dataset.lng;
        toggleClearBtn(i); resetPrice();
    }

    function addNewStop() {
        const id = 'stop-' + Date.now();
        const html = `
            <div class="form-group" style="margin-top:10px;">
                <label>ƒêi·ªÉm d·ª´ng:</label>
                <input type="text" id="${id}" class="extra-stop-input" placeholder="Nh·∫≠p ƒëi·ªÉm d·ª´ng..." autocomplete="off">
                <div class="input-tools">
                    <button class="tool-btn btn-x" onclick="this.parentElement.parentElement.remove(); resetPrice();">‚úï</button>
                </div>
                <div class="loading-text">‚è≥ ƒêang t√¨m...</div>
                <div class="suggestions"></div>
            </div>`;
        document.getElementById('extra-stops').insertAdjacentHTML('beforeend', html);
        setupAutocomplete(id);
    }

    // 5. T√≠nh gi√° c∆∞·ªõc
    async function mainCalculation() {
        const pickup = document.getElementById('loc-pickup');
        const dropoff = document.getElementById('loc-dropoff');
        const stops = document.querySelectorAll('.extra-stop-input');

        let points = [];
        if (pickup.dataset.lat) points.push([pickup.dataset.lng, pickup.dataset.lat]);
        stops.forEach(s => { if(s.dataset.lat) points.push([s.dataset.lng, s.dataset.lat]); });
        if (dropoff.dataset.lat) points.push([dropoff.dataset.lng, dropoff.dataset.lat]);

        if (points.length < 2) return alert("Vui l√≤ng ch·ªçn ƒë·ªãa ƒëi·ªÉm t·ª´ danh s√°ch g·ª£i √Ω!");

        const btn = document.getElementById('master-btn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêANG T√çNH...';
        btn.disabled = true;

        const coords = points.map(p => p.join(',')).join(';');
        const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const km = route.distance / 1000;
                
                // Logic t√≠nh ti·ªÅn
                const carPrice = document.getElementById('car-type').value == '4' ? 10000 : 12000;
                let go = Math.round(km * carPrice);
                let total = go;

                document.getElementById('res-km').innerText = km.toFixed(1) + " km";
                document.getElementById('res-go').innerText = go.toLocaleString() + " ƒë";

                if (document.getElementById('trip-type').value == '2') {
                    let back = Math.round(go * 0.6); // Gi·∫£m 40%
                    total = go + back;
                    document.getElementById('res-back').innerText = back.toLocaleString() + " ƒë";
                    document.getElementById('res-back-row').style.display = 'flex';
                    document.getElementById('res-deposit').innerText = Math.round(total * 0.2).toLocaleString() + " ƒë";
                    document.getElementById('res-deposit-row').style.display = 'flex';
                } else {
                    document.getElementById('res-back-row').style.display = 'none';
                    document.getElementById('res-deposit-row').style.display = 'none';
                }

                document.getElementById('res-total').innerText = total.toLocaleString() + " ƒë";
                document.getElementById('result-box').style.display = 'block';
                
                // Update Map
                document.getElementById('main-map').style.display = 'block';
                if(routeLayer) map.removeLayer(routeLayer);
                routeLayer = L.geoJSON(route.geometry, {style: {color: '#008000', weight: 6}}).addTo(map);
                map.fitBounds(routeLayer.getBounds(), {padding: [30,30]});
                
                // Show actions
                document.getElementById('master-btn').style.display = 'none';
                document.getElementById('booking-actions').style.display = 'flex';
                document.getElementById('result-box').scrollIntoView({behavior: "smooth"});
            }
        } catch (e) { alert("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!"); }
        
        btn.innerHTML = 'T√çNH GI√Å C∆Ø·ªöC';
        btn.disabled = false;
    }

    function resetPrice() {
        document.getElementById('result-box').style.display = 'none';
        document.getElementById('master-btn').style.display = 'block';
        document.getElementById('booking-actions').style.display = 'none';
    }

    // B·∫£n ƒë·ªì ch·ªçn v·ªã tr√≠
    function showMapPicker(id) {
        activeInpId = id;
        document.getElementById('map-modal').style.display = 'block';
        setTimeout(() => pickerMap.invalidateSize(), 300);
    }
    function closeMapPicker() { document.getElementById('map-modal').style.display = 'none'; }
    function confirmPickedLocation() {
        const center = pickerMap.getCenter();
        const inp = document.getElementById(activeInpId);
        inp.dataset.lat = center.lat;
        inp.dataset.lng = center.lng;
        inp.value = `üìç V·ªã tr√≠ ghim: ${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}`;
        toggleClearBtn(inp); closeMapPicker(); resetPrice();
    }

    function useCurrentLocation() {
        if (!navigator.geolocation) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS");
        navigator.geolocation.getCurrentPosition(p => {
            const inp = document.getElementById('loc-pickup');
            inp.dataset.lat = p.coords.latitude;
            inp.dataset.lng = p.coords.longitude;
            inp.value = "üìç V·ªã tr√≠ hi·ªán t·∫°i c·ªßa t√¥i";
            toggleClearBtn(inp); resetPrice();
        });
    }

    function bookingAction(type) {
        alert("ƒêang chuy·ªÉn h∆∞·ªõng y√™u c·∫ßu ƒë·∫∑t xe...");
    }
</script>

</body>
</html>
