<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫∑t Xe Tr∆∞·ªùng An</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --primary-green: #008000; /* M√†u header theo ·∫£nh */
            --light-green-bg: #e8f5e9; /* M√†u n·ªÅn khung gi√° */
            --border-green: #c8e6c9;
            --zalo-blue: #0068ff;
            --mail-red: #dc3545;
            --text-dark: #333;
            --bg-gray: #f5f5f5;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background: var(--bg-gray); color: var(--text-dark); padding-bottom: 80px; }

        /* HEADER GI·ªêNG ·∫¢NH 2 */
        .header {
            background: var(--primary-green);
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-left { display: flex; flex-direction: column; }
        .brand { font-size: 16px; font-weight: 700; text-transform: uppercase; margin: 0; line-height: 1.2; }
        .phone-badge {
            background: #ffff00;
            color: #d00000;
            font-weight: 700;
            font-size: 13px;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 4px;
            width: fit-content;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .phone-badge i { margin-right: 3px; }
        
        .lang-bar { display: flex; gap: 5px; }
        .lang-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.5);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 500;
        }
        .lang-btn.active { background: white; color: var(--primary-green); font-weight: 700; border-color: white; }

        /* SECTIONS */
        .container { max-width: 600px; margin: 0 auto; padding: 10px; }
        
        .card-header {
            display: flex; align-items: center; gap: 8px;
            font-size: 14px; font-weight: 700; color: var(--primary-green);
            margin-bottom: 8px; margin-top: 15px;
            text-transform: uppercase;
        }
        .card-header i { font-size: 16px; }

        .white-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-bottom: 10px;
        }

        /* FORM ELEMENTS */
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { flex: 1; position: relative; margin-bottom: 10px; }
        .form-group:last-child { margin-bottom: 0; }
        
        .form-label { display: block; font-size: 12px; font-weight: 500; color: #666; margin-bottom: 4px; }
        
        input, select, textarea {
            width: 100%; padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            background: #fff;
            font-family: 'Roboto', sans-serif;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-green); }
        textarea { resize: none; height: 60px; }

        /* INPUT C√ì ICON B√äN PH·∫¢I (Gi·ªëng ·∫£nh 2) */
        .input-wrapper { position: relative; }
        .input-wrapper input { padding-right: 70px; }
        .input-tools {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            display: flex; gap: 4px;
        }
        .tool-btn {
            border: none; background: #eee;
            width: 28px; height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: #555;
        }
        .btn-map { background: var(--primary-green); color: white; } /* N√∫t map m√†u xanh */
        .btn-x { background: transparent; color: #999; font-size: 16px; display: none;}

        /* SUGGESTIONS */
        .suggestions {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ddd; border-top: none;
            border-radius: 0 0 6px 6px; z-index: 999;
            max-height: 200px; overflow-y: auto; display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .sug-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; display: flex; gap: 10px; }
        .sug-item i { color: #888; margin-top: 3px; }

        /* MAP */
        #main-map { height: 200px; width: 100%; border-radius: 8px; margin-top: 10px; display: none; z-index: 1; border: 1px solid #ddd; }

        /* POLICY CARD (GI·ªêNG ·∫¢NH 1) */
        .policy-card {
            background: var(--light-green-bg);
            border: 1px solid var(--border-green);
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
        }
        .policy-title { font-weight: 700; font-size: 13px; color: #2e7d32; margin-bottom: 8px; text-transform: uppercase; }
        .policy-item { display: flex; gap: 6px; font-size: 12px; color: #444; margin-bottom: 4px; align-items: flex-start; }
        .policy-item i { color: var(--primary-green); margin-top: 2px; width: 14px; }
        .policy-item.warning i { color: #f57f17; }

        /* RESULT AREA (GI·ªêNG ·∫¢NH 1) */
        #result-area { display: none; margin-top: 15px; }
        .price-details-card {
            background: var(--light-green-bg);
            border: 1px solid var(--border-green);
            border-radius: 8px;
            padding: 15px;
        }
        .price-title {
            text-align: center; font-weight: 700; color: var(--primary-green);
            font-size: 14px; text-transform: uppercase; margin-bottom: 10px;
        }
        .res-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; color: #333; }
        
        .divider { border-top: 1px dashed #aaa; margin: 10px 0; }
        
        .total-price-row { text-align: center; margin-top: 10px; }
        .total-price {
            display: block;
            font-size: 24px; font-weight: 700;
            color: #d32f2f; /* ƒê·ªè ƒë·∫≠m gi·ªëng ·∫£nh */
            margin-top: 5px;
        }
        
        .note-small { font-size: 11px; color: #777; font-style: italic; text-align: center; margin-top: 8px; display: block; }

        /* BUTTONS */
        .btn-full { width: 100%; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; height: 44px; text-transform: uppercase; font-size: 14px; }
        
        .btn-calc { background: #ffc107; color: #333; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-add-stop { background: #f0f0f0; color: #333; font-size: 12px; padding: 6px; width: auto; display: inline-block; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }
        
        .btn-myloc { border: 1px solid #ccc; background: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; float: right; margin-top: -2px; }

        /* STICKY BOTTOM BAR */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 10px 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; gap: 10px; z-index: 900;
            display: none; /* Hi·ªán khi c√≥ k·∫øt qu·∫£ */
        }
        .btn-zalo { background: var(--zalo-blue); color: white; flex: 1; }
        .btn-mail { background: var(--mail-red); color: white; flex: 1; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; display: flex; flex-direction: column; }
        #picker-map { height: 300px; width: 100%; border-radius: 6px; margin-bottom: 10px; }
        .close-modal { align-self: flex-end; font-size: 24px; cursor: pointer; color: #555; line-height: 1; margin-bottom: 10px; }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <div class="brand" data-i18n="brand">TR∆Ø·ªúNG AN DRIVING</div>
            <a href="tel:0847526893" style="text-decoration: none;">
                <div class="phone-badge"><i class="fas fa-phone-alt"></i> 084.752.6893</div>
            </a>
        </div>
        <div class="lang-bar">
            <div class="lang-btn active" onclick="changeLang('vi')">VN</div>
            <div class="lang-btn" onclick="changeLang('en')">EN</div>
            <div class="lang-btn" onclick="changeLang('cn')">CN</div>
        </div>
    </div>

    <div class="container">
        
        <div class="card-header"><i class="fas fa-clipboard-list"></i> <span data-i18n="sec_info">TH√îNG TIN</span></div>
        <div class="white-card">
            <div class="form-group">
                <label class="form-label" data-i18n="lbl_phone">S·ªë ƒëi·ªán tho·∫°i:</label>
                <input type="tel" id="phone" placeholder="09xxxx..." pattern="[0-9]*">
            </div>
            <div class="form-group">
                <label class="form-label" data-i18n="lbl_time">Th·ªùi gian ƒë√≥n:</label>
                <input type="datetime-local" id="time">
            </div>
        </div>

        <div class="card-header">
            <i class="fas fa-map-marked-alt"></i> 
            <span data-i18n="sec_route" style="flex:1">L·ªò TR√åNH</span>
            <button class="btn-myloc" onclick="getMyLoc()" id="btn-loc"><i class="fas fa-crosshairs"></i> <span data-i18n="btn_myloc">V·ªã tr√≠ t√¥i</span></button>
        </div>
        
        <div class="white-card">
            <div class="form-group">
                <label class="form-label" data-i18n="lbl_pickup">ƒêi·ªÉm ƒë√≥n:</label>
                <div class="input-wrapper">
                    <input type="text" id="pickup" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë√≥n...">
                    <div class="input-tools">
                        <button class="tool-btn btn-x" onclick="clearInp('pickup')">‚úï</button>
                        <button class="tool-btn btn-map" onclick="openMap('pickup')"><i class="fas fa-map"></i></button>
                    </div>
                </div>
                <div class="suggestions"></div>
            </div>

            <div id="stops-container"></div>
            <div style="text-align: right;">
                <button class="btn-add-stop" onclick="addStop()" data-i18n="btn_add_stop">+ Th√™m ƒëi·ªÉm d·ª´ng</button>
            </div>

            <div class="form-group" style="margin-top:10px;">
                <label class="form-label" data-i18n="lbl_dropoff">ƒêi·ªÉm ƒë·∫øn:</label>
                <div class="input-wrapper">
                    <input type="text" id="dropoff" placeholder="Nh·∫≠p ƒëi·ªÉm ƒë·∫øn...">
                    <div class="input-tools">
                        <button class="tool-btn btn-x" onclick="clearInp('dropoff')">‚úï</button>
                        <button class="tool-btn btn-map" onclick="openMap('dropoff')"><i class="fas fa-map"></i></button>
                    </div>
                </div>
                <div class="suggestions"></div>
            </div>
            
            <div id="main-map"></div>
        </div>

        <div class="white-card" style="margin-top: 15px;">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" data-i18n="lbl_car">Lo·∫°i xe:</label>
                    <select id="carType" onchange="updatePolicyUI(); resetButtonsAndMap()">
                        <option value="4" data-i18n="opt_4seat_disp">Xe 4 ch·ªó</option>
                        <option value="7" data-i18n="opt_7seat_disp">Xe 7 ch·ªó</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="lbl_type">H√¨nh th·ª©c:</label>
                    <select id="tripType" onchange="toggleWait(); updatePolicyUI(); resetButtonsAndMap()">
                        <option value="1" data-i18n="opt_1way_disp">One way (1 Chi·ªÅu)</option>
                        <option value="2" data-i18n="opt_2way_disp">Round Trip (2 Chi·ªÅu)</option>
                    </select>
                </div>
            </div>

            <div class="form-group" id="wait-area" style="display:none;">
                <label class="form-label" data-i18n="lbl_wait">‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):</label>
                <input type="number" id="waitHour" value="3" min="0" onchange="resetButtonsAndMap()">
            </div>

            <div class="form-group">
                <label class="form-label" data-i18n="lbl_driver">T√†i x·∫ø:</label>
                <select id="driver">
                    <option value="system" data-i18n="opt_system">‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)</option>
                    <option value="Tai">Anh T√†i</option>
                    <option value="Tam">Anh T√¢m</option>
                    <option value="An">Anh An</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label" data-i18n="lbl_note">üìù Y√™u c·∫ßu/Ghi ch√∫:</label>
                <textarea id="note" placeholder="..."></textarea>
            </div>

            <div class="policy-card">
                <div class="policy-title" data-i18n="note_policy_title">PRICING POLICY (Details)</div>
                <div class="policy-item"><i class="fas fa-tag"></i> <span id="policy-rate">4 Seats: 10,000ƒë/km</span></div>
                <div class="policy-item"><i class="fas fa-sync-alt"></i> <span data-i18n="note_disc_cond">Round Trip Offer: 40% off return if one-way distance is over 45km.</span></div>
                <div class="policy-item"><i class="fas fa-clock"></i> <span data-i18n="note_wait_fee">Waiting Fee: First 3 hours free. After that, 50,000ƒë/hour.</span></div>
                <div class="policy-item warning"><i class="fas fa-exclamation-triangle"></i> <span data-i18n="note_toll_fee">Estimated price excludes toll fees and parking fees.</span></div>
            </div>

            <div id="result-area">
                <div class="price-details-card">
                    <div class="price-title" data-i18n="lbl_est_price">PRICE DETAILS</div>
                    
                    <div class="res-row">
                        <span data-i18n="res_dist">Distance:</span> 
                        <strong id="res-km">0 km</strong>
                    </div>
                    <div class="res-row">
                        <span data-i18n="res_time">Duration:</span> 
                        <strong id="res-time">0 ph√∫t</strong>
                    </div>
                    
                    <div class="divider"></div>

                    <div class="res-row">
                        <span data-i18n="res_go_price">One-way:</span> 
                        <strong id="val-go">0 ƒë</strong>
                    </div>
                    
                    <div class="res-row" id="row-back-full" style="display:none">
                        <span data-i18n="res_back_full">Return (Orig):</span> 
                        <span id="val-back-full">0 ƒë</span>
                    </div>
                    <div class="res-row" id="row-back-disc" style="display:none; color:#d63384">
                        <span data-i18n="res_return_disc">Return (-40%):</span> 
                        <strong id="val-back-disc">0 ƒë</strong>
                    </div>
                    <div class="res-row" id="row-wait" style="display:none">
                        <span data-i18n="res_wait_fee">Waiting Fee:</span> 
                        <span id="val-wait">0 ƒë</span>
                    </div>
                    
                    <div class="total-price-row">
                        <div id="res-total" class="total-price">0 ƒë</div>
                    </div>
                    
                    <div class="res-row" id="row-deposit" style="justify-content:center; color:#666; font-size:12px; margin-top:5px; display:none">
                        <span data-i18n="res_deposit" style="margin-right:5px">Deposit (20%):</span> <span id="val-deposit">0 ƒë</span>
                    </div>

                    <small class="note-small" data-i18n="note_toll_fee">Price excludes toll fees and parking fees.</small>
                </div>
            </div>

            <button class="btn-full btn-calc" id="btn-calc-main" onclick="calculate()" data-i18n="btn_calc">üí∞ T√çNH GI√Å C∆Ø·ªöC</button>
        </div>
    </div>

    <div class="bottom-bar" id="book-buttons-bar">
        <button class="btn-full btn-zalo" onclick="preBook('zalo')">Book via ZALO</button>
        <button class="btn-full btn-mail" onclick="preBook('mail')">Book via MAIL</button>
    </div>

    <div class="modal" id="modal-map">
        <div class="modal-content">
            <span class="close-modal" onclick="closeMap()">√ó</span>
            <h3 style="margin-top:0; text-align:center; color:var(--primary-green)" data-i18n="modal_map_title">CH·ªåN V·ªä TR√ç</h3>
            <div id="picker-map"></div>
            <button class="btn-full btn-zalo" onclick="confirmMap()" data-i18n="btn_confirm">X√ÅC NH·∫¨N</button>
        </div>
    </div>

    <div class="modal" id="phone-modal">
        <div class="modal-content" style="max-width:300px">
            <span class="close-modal" onclick="closePhone()">√ó</span>
            <h3 style="margin-top:0; font-size:16px" data-i18n="modal_phone_title">NH·∫¨P S·ªê ƒêI·ªÜN THO·∫†I</h3>
            <p style="font-size:13px" data-i18n="modal_phone_desc">Vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i li√™n h·ªá:</p>
            <input type="tel" id="quick-phone" style="margin-bottom:15px">
            <button class="btn-full btn-zalo" onclick="savePhone()" data-i18n="btn_confirm">X√ÅC NH·∫¨N</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- GI·ªÆ NGUY√äN TO√ÄN B·ªò LOGIC JS C≈® ---
        const GOONG_API_KEY = 'Lrrqqduqt0pfhNfmh0bzjN9lqwEqqY8rSpCs3gcG'; 
        const DEBOUNCE_DELAY = 1000; 

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        let sessionToken = generateUUID();

        // I18N DATA (Updated with image text)
        const LANG = {
            vi: {
                brand:"TR∆Ø·ªúNG AN DRIVING", sec_info:"TH√îNG TIN", lbl_phone:"S·ªë ƒëi·ªán tho·∫°i:", lbl_time:"Th·ªùi gian ƒë√≥n:",
                sec_route:"L·ªò TR√åNH", btn_myloc:"V·ªã tr√≠ t√¥i", lbl_pickup:"ƒêi·ªÉm ƒë√≥n:", lbl_dropoff:"ƒêi·ªÉm ƒë·∫øn:", btn_add_stop:"+ Th√™m ƒëi·ªÉm d·ª´ng",
                sec_opt:"T√ôY CH·ªåN", lbl_car:"Lo·∫°i xe:", 
                opt_4seat_disp:"Xe 4 ch·ªó", opt_7seat_disp:"Xe 7 ch·ªó",
                opt_1way_disp:"1 Chi·ªÅu", opt_2way_disp:"2 Chi·ªÅu",
                lbl_type:"H√¨nh th·ª©c:", lbl_wait:"‚è≥ Gi·ªù ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):",
                lbl_driver:"T√†i x·∫ø:", opt_system:"‚≠ê H·ªá th·ªëng (Nhanh nh·∫•t)", lbl_note:"üìù Y√™u c·∫ßu/Ghi ch√∫:", btn_calc:"üí∞ T√çNH GI√Å C∆Ø·ªöC",
                lbl_est_price:"CHI TI·∫æT GI√Å", res_dist:"Qu√£ng ƒë∆∞·ªùng:", res_time:"Th·ªùi gian:", res_go_price:"Chi·ªÅu ƒëi:",
                res_back_full:"Chi·ªÅu v·ªÅ (G·ªëc):", res_return_disc:"Chi·ªÅu v·ªÅ (-40%):", res_wait_fee:"Ph√≠ ch·ªù:", res_deposit:"C·ªçc (20%):",
                note_policy_title: "CH√çNH S√ÅCH GI√Å C∆Ø·ªöC (Chi ti·∫øt)", 
                note_price_4:"Gi√° 4 ch·ªó: 10.000ƒë/km.", note_price_7:"Gi√° 7 ch·ªó: 12.000ƒë/km.",
                note_disc_cond:"∆Øu ƒë√£i 2 chi·ªÅu: Gi·∫£m 40% chi·ªÅu v·ªÅ n·∫øu chi·ªÅu ƒëi tr√™n 45km.", 
                note_wait_fee:"Ph√≠ ch·ªù: Mi·ªÖn ph√≠ 3 gi·ªù ƒë·∫ßu ti√™n. Sau ƒë√≥ t√≠nh 50.000ƒë/gi·ªù.",
                note_toll_fee:"‚ö†Ô∏è Gi√° ∆∞·ªõc t√≠nh ch∆∞a bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng v√† b·∫øn b√£i.", 
                modal_map_title:"CH·ªåN V·ªä TR√ç", btn_confirm:"X√ÅC NH·∫¨N",
                modal_phone_title:"NH·∫¨P S·ªê ƒêI·ªÜN THO·∫†I", modal_phone_desc:"Vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i li√™n h·ªá:",
                plh_phone:"VD: 0912345678", plh_pickup:"Nh·∫≠p ƒëi·ªÉm ƒë√≥n...", plh_dropoff:"Nh·∫≠p ƒëi·ªÉm ƒë·∫øn...", plh_stop:"ƒêi·ªÉm d·ª´ng...", plh_note:"VD: Xe s·∫°ch, ƒë√≥n ƒë√∫ng gi·ªù..."
            },
            en: {
                brand:"TRUONG AN DRIVING", sec_info:"INFORMATION", lbl_phone:"Phone Number:", lbl_time:"Pickup Time:",
                sec_route:"ROUTE", btn_myloc:"My Location", lbl_pickup:"Pick-up:", lbl_dropoff:"Drop-off:", btn_add_stop:"+ Add Stop",
                sec_opt:"OPTIONS", lbl_car:"Car Type:", 
                opt_4seat_disp:"4 Seats", opt_7seat_disp:"7 Seats",
                opt_1way_disp:"One way", opt_2way_disp:"Round trip",
                lbl_type:"Trip Type:", lbl_wait:"‚è≥ Waiting Time (Free 3h):",
                lbl_driver:"Driver:", opt_system:"‚≠ê System (Fastest)", lbl_note:"üìù Note/Request:", btn_calc:"üí∞ CALCULATE PRICE",
                lbl_est_price:"PRICE DETAILS", res_dist:"Distance:", res_time:"Duration:", res_go_price:"One-way:",
                res_back_full:"Return (Orig):", res_return_disc:"Return (-40%):", res_wait_fee:"Waiting Fee:", res_deposit:"Deposit (20%):",
                note_policy_title: "PRICING POLICY (Details)", 
                note_price_4:"4 Seats: 10,000ƒë/km.", note_price_7:"7 Seats: 12,000ƒë/km.",
                note_disc_cond:"Round Trip Offer: 40% off return if one-way distance is over 45km.", 
                note_wait_fee:"Waiting Fee: First 3 hours free. After that, 50,000ƒë/hour.",
                note_toll_fee:"‚ö†Ô∏è Estimated price excludes toll fees and parking fees.", 
                modal_map_title:"PICK LOCATION", btn_confirm:"CONFIRM",
                modal_phone_title:"ENTER PHONE", modal_phone_desc:"Please enter phone number:",
                plh_phone:"Ex: 0912345678", plh_pickup:"Enter pick-up...", plh_dropoff:"Enter drop-off...", plh_stop:"Stop point...", plh_note:"Ex: Clean car, on time..."
            },
            cn: {
                brand:"ÈïøÂÆâÈ©æÈ©∂", sec_info:"‰ø°ÊÅØ", lbl_phone:"ÁîµËØùÂè∑Á†Å:", lbl_time:"Êé•ËΩ¶Êó∂Èó¥:",
                sec_route:"Ë∑ØÁ∫ø", btn_myloc:"ÊàëÁöÑ‰ΩçÁΩÆ", lbl_pickup:"‰∏äËΩ¶ÁÇπ:", lbl_dropoff:"‰∏ãËΩ¶ÁÇπ:", btn_add_stop:"+ Â¢ûÂä†Á´ôÁÇπ",
                sec_opt:"ÈÄâÈ°π", lbl_car:"ËΩ¶Âûã:", 
                opt_4seat_disp:"4Â∫ß", opt_7seat_disp:"7Â∫ß",
                opt_1way_disp:"ÂçïÁ®ã", opt_2way_disp:"ÂæÄËøî",
                lbl_type:"Ë°åÁ®ã:", lbl_wait:"‚è≥ Á≠âÂæÖÊó∂Èó¥ (ÂÖçË¥π3h):",
                lbl_driver:"Âè∏Êú∫:", opt_system:"‚≠ê Á≥ªÁªü (ÊúÄÂø´)", lbl_note:"üìù Â§áÊ≥®/Ë¶ÅÊ±Ç:", btn_calc:"üí∞ ËÆ°ÁÆó‰ª∑Ê†º",
                lbl_est_price:"‰ª∑Ê†ºËØ¶ÊÉÖ", res_dist:"Ë∑ùÁ¶ª:", res_time:"Êó∂Èó¥:", res_go_price:"ÂéªÁ®ã:",
                res_back_full:"ÂõûÁ®ã (Âéü‰ª∑):", res_return_disc:"ÂõûÁ®ã (-40%):", res_wait_fee:"Á≠âÂæÖË¥π:", res_deposit:"ÂÆöÈáë (20%):",
                note_policy_title: "‰ª∑Ê†ºÊîøÁ≠ñ (ËØ¶ÊÉÖ)", 
                note_price_4:"4Â∫ß: 10,000ƒë/km.", note_price_7:"7Â∫ß: 12,000ƒë/km.",
                note_disc_cond:"ÂæÄËøî‰ºòÊÉ†: ÂçïÁ®ãË∑ùÁ¶ªË∂ÖËøá45ÂÖ¨ÈáåÔºåÂõûÁ®ãÂáè40%„ÄÇ", 
                note_wait_fee:"Á≠âÂæÖË¥π: Ââç3Â∞èÊó∂ÂÖçË¥π„ÄÇ‰πãÂêé50,000ƒë/Â∞èÊó∂„ÄÇ",
                note_toll_fee:"‚ö†Ô∏è È¢Ñ‰º∞‰ª∑Ê†º‰∏çÂåÖÂê´ËøáË∑ØË¥πÂíåÂÅúËΩ¶Ë¥π„ÄÇ", 
                modal_map_title:"ÈÄâÊã©‰ΩçÁΩÆ", btn_confirm:"Á°ÆËÆ§",
                modal_phone_title:"ËæìÂÖ•ÁîµËØù", modal_phone_desc:"ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å:",
                plh_phone:"‰æã: 0912345678", plh_pickup:"ËæìÂÖ•‰∏äËΩ¶ÁÇπ...", plh_dropoff:"ËæìÂÖ•‰∏ãËΩ¶ÁÇπ...", plh_stop:"Á´ôÁÇπ...", plh_note:"‰æã: ÂáÜÊó∂, ËΩ¶ÂÜÖÂπ≤ÂáÄ..."
            }
        };

        let curLang = 'vi';
        const CFG = { p4: 10000, p7: 12000, wait: 50000 };
        let map, pickerMap, routeLayer, markerLayer, activeInp, pendingMethod;
        let cachedData = { total:0 };
        let isSelecting = false;

        window.onload = () => {
            map = L.map('main-map').setView([10.7769, 106.7009], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markerLayer = L.layerGroup().addTo(map);

            pickerMap = L.map('picker-map').setView([10.7769, 106.7009], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);

            let now = new Date(); now.setMinutes(now.getMinutes()+30-now.getTimezoneOffset());
            document.getElementById('time').value = now.toISOString().slice(0,16);
            
            document.getElementById('phone').addEventListener('input', resetButtonsAndMap);
            document.getElementById('time').addEventListener('change', resetButtonsAndMap);
            document.getElementById('note').addEventListener('input', resetButtonsAndMap);
            setupInp('phone');
            
            setupAddr('pickup'); setupAddr('dropoff');
            changeLang('vi'); 
            
            checkIfReadyToCalculate();
        };
        
        // --- LOGIC HELPER FUNCTIONS ---
        function updatePolicyUI() {
            const car = document.getElementById('carType').value;
            const rateTxt = (car === '4') ? LANG[curLang].note_price_4 : LANG[curLang].note_price_7;
            document.getElementById('policy-rate').innerText = rateTxt;
        }

        function parseCoordinates(str) {
            let matches = str.match(/-?\d+[,.]\d+/g);
            if (matches && matches.length >= 2) {
                let lat = parseFloat(matches[0].replace(',', '.'));
                let lon = parseFloat(matches[1].replace(',', '.'));
                if (!isNaN(lat) && !isNaN(lon) && Math.abs(lat) <= 90 && Math.abs(lon) <= 180) {
                    return { lat: lat, lon: lon };
                }
            }
            return null;
        }

        let timer;
        function search(inp) {
            clearTimeout(timer);
            let box = inp.closest('.form-group').querySelector('.suggestions') || inp.parentElement.parentElement.querySelector('.suggestions');
            
            if(inp.value.length < 2) { box.style.display='none'; return; }

            let coords = parseCoordinates(inp.value);
            if (coords) {
                box.innerHTML = '';
                let div = document.createElement('div');
                div.className = 'sug-item';
                div.innerHTML = `<i class="fas fa-crosshairs" style="color:red"></i> 
                                 <div><strong>S·ª≠ d·ª•ng t·ªça ƒë·ªô n√†y</strong><br>
                                 <small>${coords.lat}, ${coords.lon}</small></div>`;
                
                div.onmousedown = (e) => {
                    e.preventDefault();
                    isSelecting = true;
                    fetch(`https://rsapi.goong.io/Geocode?latlng=${coords.lat},${coords.lon}&api_key=${GOONG_API_KEY}`)
                        .then(r=>r.json()).then(d=>{
                            if(d.results && d.results.length > 0) inp.value = d.results[0].formatted_address;
                            else inp.value = `${coords.lat}, ${coords.lon}`;
                        });
                    inp.dataset.lat = coords.lat;
                    inp.dataset.lon = coords.lon;
                    box.style.display = 'none';
                    toggleX(inp);
                    inp.blur();
                    resetButtonsAndMap();
                };
                box.appendChild(div);
                box.style.display = 'block';
                return; 
            }

            timer = setTimeout(() => {
                if(!GOONG_API_KEY) return;
                if (!sessionToken) sessionToken = generateUUID();

                let url = `https://rsapi.goong.io/Place/AutoComplete?api_key=${GOONG_API_KEY}&input=${encodeURIComponent(inp.value)}&session_token=${sessionToken}`;
                
                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        box.innerHTML = '';
                        if (!data.predictions || !data.predictions.length) { 
                            box.style.display='none'; return; 
                        }
                        
                        data.predictions.forEach(item => {
                            let div = document.createElement('div');
                            div.className = 'sug-item';
                            div.innerHTML = `<i class="fas fa-map-marker-alt"></i> <div><strong>${item.structured_formatting.main_text}</strong><br><small style="color:#666">${item.structured_formatting.secondary_text || ''}</small></div>`;
                            
                            div.onmousedown = (e) => {
                                e.preventDefault();
                                isSelecting = true;
                                inp.value = item.description;
                                getPlaceDetail(item.place_id, inp);
                                box.style.display = 'none';
                                toggleX(inp);
                                inp.blur();
                            };
                            box.appendChild(div);
                        });
                        box.style.display = 'block';
                    })
                    .catch(err => console.error(err));
            }, DEBOUNCE_DELAY);
        }

        function changeLang(code) {
            curLang = code;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="changeLang('${code}')"]`).classList.add('active');
            
            const updateSelectOptions = (id, options) => {
                const select = document.getElementById(id);
                const currentVal = select.value;
                select.innerHTML = '';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.setAttribute('data-i18n', opt.i18nKey);
                    option.textContent = LANG[code][opt.i18nKey]; 
                    select.appendChild(option);
                });
                select.value = currentVal;
            };

            updateSelectOptions('carType', [
                { value: '4', i18nKey: 'opt_4seat_disp' },
                { value: '7', i18nKey: 'opt_7seat_disp' }
            ]);

            updateSelectOptions('tripType', [
                { value: '1', i18nKey: 'opt_1way_disp' },
                { value: '2', i18nKey: 'opt_2way_disp' }
            ]);
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                let key = el.dataset.i18n;
                if(LANG[code][key]) {
                    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = LANG[code][`plh_${el.id}`] || LANG[code][key];
                    else if(el.tagName !== 'OPTION' && el.tagName !== 'SELECT') el.innerText = LANG[code][key];
                }
            });
            
            ['phone','pickup','dropoff','note'].forEach(id => {
                document.getElementById(id).placeholder = LANG[code][`plh_${id}`] || LANG[code][`plh_${id}`.replace('_disp','')];
            });
            document.querySelectorAll('.stop-inp').forEach(i => i.placeholder = LANG[code].plh_stop);
            
            updatePolicyUI();
        }

        function resetButtonsAndMap() {
            document.getElementById('book-buttons-bar').style.display = 'none'; 
            document.getElementById('result-area').style.display = 'none'; 
            if(routeLayer) map.removeLayer(routeLayer);
            markerLayer.clearLayers();
            document.getElementById('main-map').style.display = 'none'; 
            checkIfReadyToCalculate(); 
        }
        
        function checkIfReadyToCalculate() {
            const p = document.getElementById('pickup');
            const d = document.getElementById('dropoff');
            const stops = document.querySelectorAll('.stop-inp');
            const btnCalc = document.getElementById('btn-calc-main');
            
            const isPickupReady = (p.dataset.lat && p.value) || (p.value.length > 0);
            const isDropoffReady = (d.dataset.lat && d.value) || (d.value.length > 0);
            const isStopReady = Array.from(stops).some(s => (s.dataset.lat && s.value) || (s.value.length > 0));
            
            const isReady = isPickupReady || isDropoffReady || isStopReady;
            btnCalc.style.display = (isReady && document.getElementById('book-buttons-bar').style.display === 'none') ? 'flex' : 'none';
        }

        function setupInp(id) {
            let el = document.getElementById(id);
            el.addEventListener('input', () => toggleX(el));
        }
        
        function setupAddr(id) {
            let el = document.getElementById(id);
            el.addEventListener('input', function() {
                if(isSelecting) { isSelecting=false; return; }
                toggleX(this);
                search(this);
                resetButtonsAndMap();
            });
            el.addEventListener('focus', function() {
                toggleX(this);
                if(this.value.length > 2) search(this);
            });
            el.addEventListener('blur', () => setTimeout(() => {
                let box = el.closest('.form-group').querySelector('.suggestions') || el.parentElement.parentElement.querySelector('.suggestions');
                if(box) box.style.display = 'none';
            }, 200));
        }

        function toggleX(el) {
            let wrapper = el.parentElement;
            let btn = wrapper.querySelector('.btn-x');
            if(btn) btn.style.display = el.value ? 'flex' : 'none';
        }
        function clearInp(id) {
            let el = document.getElementById(id);
            el.value=''; delete el.dataset.lat; delete el.dataset.lon;
            toggleX(el);
            resetButtonsAndMap();
        }

        function getPlaceDetail(placeId, inpElement) {
            let url = `https://rsapi.goong.io/Place/Detail?place_id=${placeId}&api_key=${GOONG_API_KEY}&session_token=${sessionToken}`;
            fetch(url).then(r => r.json()).then(data => {
                if(data.result && data.result.geometry) {
                    inpElement.dataset.lat = data.result.geometry.location.lat;
                    inpElement.dataset.lon = data.result.geometry.location.lng;
                    sessionToken = generateUUID();
                    resetButtonsAndMap();
                }
            });
        }

        function openMap(id) {
            activeInp = document.getElementById(id);
            document.getElementById('modal-map').style.display = 'flex';
            activeInp.blur(); 
            setTimeout(() => {
                pickerMap.invalidateSize();
                if(activeInp.dataset.lat) pickerMap.setView([activeInp.dataset.lat, activeInp.dataset.lon], 16);
                else if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p => pickerMap.setView([p.coords.latitude, p.coords.longitude], 15));
            }, 200);
        }
        function closeMap() { document.getElementById('modal-map').style.display = 'none'; }
        
        function confirmMap() {
            let c = pickerMap.getCenter();
            activeInp.dataset.lat = c.lat; 
            activeInp.dataset.lon = c.lng;
            
            fetch(`https://rsapi.goong.io/Geocode?latlng=${c.lat},${c.lng}&api_key=${GOONG_API_KEY}`)
            .then(r=>r.json()).then(d => {
                if(d.results && d.results.length > 0) activeInp.value = d.results[0].formatted_address;
                else activeInp.value = `${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
                toggleX(activeInp);
            });
            closeMap();
            resetButtonsAndMap(); 
        }

        function getMyLoc() {
            if(!navigator.geolocation) return alert("Vui l√≤ng b·∫≠t GPS!");
            let btn = document.getElementById('btn-loc'); btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            navigator.geolocation.getCurrentPosition(p => {
                let lat = p.coords.latitude, lon = p.coords.longitude;
                let i = document.getElementById('pickup');
                i.dataset.lat = lat; i.dataset.lon = lon;
                
                fetch(`https://rsapi.goong.io/Geocode?latlng=${lat},${lon}&api_key=${GOONG_API_KEY}`)
                .then(r=>r.json()).then(d => { 
                    if(d.results && d.results.length > 0) i.value = d.results[0].formatted_address;
                    else i.value = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
                    toggleX(i); 
                    btn.innerHTML = '<i class="fas fa-crosshairs"></i> ' + LANG[curLang].btn_myloc;
                    resetButtonsAndMap();
                });
            }, (error) => {
                alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠!");
                btn.innerHTML = '<i class="fas fa-crosshairs"></i> ' + LANG[curLang].btn_myloc;
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        function addStop() {
            let id = 'stop-' + Date.now();
            let div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label class="form-label" data-i18n="lbl_stop_point">ƒêi·ªÉm d·ª´ng:</label>
                <div class="input-wrapper">
                    <input type="text" id="${id}" class="stop-inp" placeholder="${LANG[curLang].plh_stop}">
                    <div class="input-tools">
                        <button class="tool-btn btn-x" onclick="clearInp('${id}')">‚úï</button>
                        <button class="tool-btn btn-trash" onclick="this.closest('.form-group').remove(); resetButtonsAndMap()" style="color:#dc3545"><i class="fas fa-trash"></i></button>
                        <button class="tool-btn btn-map" onclick="openMap('${id}')"><i class="fas fa-map"></i></button>
                    </div>
                </div>
                <div class="suggestions"></div>
            `;
            document.getElementById('stops-container').appendChild(div);
            setupAddr(id);
            resetButtonsAndMap(); 
        }

        function toggleWait() {
            document.getElementById('wait-area').style.display = document.getElementById('tripType').value=='2' ? 'block' : 'none';
        }

        async function calculate() {
            let p = document.getElementById('pickup'), d = document.getElementById('dropoff');
            
            if(!p.dataset.lat && !d.dataset.lat) return alert("Vui l√≤ng ch·ªçn ƒêi·ªÉm ƒë√≥n v√† ƒêi·ªÉm ƒë·∫øn t·ª´ g·ª£i √Ω/b·∫£n ƒë·ªì!");
            
            let points = [p, ...document.querySelectorAll('.stop-inp'), d];
            let validPoints = points.filter(x => x.dataset.lat);
            if (validPoints.length < 2) return alert("Thi·∫øu ƒëi·ªÉm ƒëi ho·∫∑c ƒëi·ªÉm ƒë·∫øn!");

            let btn = document.getElementById('btn-calc-main');
            let oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...'; btn.disabled=true;

            if(routeLayer) map.removeLayer(routeLayer);
            markerLayer.clearLayers(); 

            let coords = validPoints.map(x => `${x.dataset.lon},${x.dataset.lat}`).join(';');

            try {
                let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`);
                let data = await res.json();
                if(data.code !== 'Ok') throw 'Error';
                
                let r = data.routes[0];
                let km = r.distance / 1000;
                let min = Math.round(r.duration / 60);

                routeLayer = L.geoJSON(r.geometry, { style: { color: '#007bff', weight: 6, opacity: 1.0 } }).addTo(map);
                
                document.getElementById('main-map').style.display = 'block';
                map.invalidateSize(); 

                const bounds = routeLayer.getBounds(); 
                validPoints.forEach(el => bounds.extend(new L.LatLng(el.dataset.lat, el.dataset.lon)));
                map.fitBounds(bounds, {padding:[60, 60]}); 

                validPoints.forEach((el, index) => {
                    let lat = parseFloat(el.dataset.lat), lon = parseFloat(el.dataset.lon);
                    let label = (index === 0) ? 'ƒê√ìN' : (index === validPoints.length - 1) ? 'ƒê·∫æN' : `D·ª™NG ${index}`;
                    let marker = L.marker([lat, lon]).bindTooltip(`${label}: ${el.value}`, { permanent: true, direction: 'right', offset: [10, 0] });
                    markerLayer.addLayer(marker); 
                });

                let type = document.getElementById('tripType').value;
                let unit = document.getElementById('carType').value=='4' ? CFG.p4 : CFG.p7;
                let go = Math.round(km * unit);
                let back = 0, wait = 0;
                
                document.getElementById('row-back-full').style.display = 'none';
                document.getElementById('row-back-disc').style.display = 'none';
                document.getElementById('row-wait').style.display = 'none';

                if(type == '2') {
                    let backFull = go;
                    if(km >= 45) { 
                        back = Math.round(go * 0.6); 
                        document.getElementById('row-back-full').style.display = 'flex';
                        document.getElementById('val-back-full').innerText = backFull.toLocaleString() + ' ƒë';
                        document.getElementById('row-back-disc').style.display = 'flex';
                        document.getElementById('val-back-disc').innerText = back.toLocaleString() + ' ƒë';
                    } else {
                        back = go;
                        document.getElementById('row-back-full').style.display = 'flex';
                        document.getElementById('val-back-full').style.textDecoration = 'none'; 
                        document.getElementById('val-back-full').style.color = '#333';
                        document.getElementById('val-back-full').innerText = back.toLocaleString() + ' ƒë';
                    }

                    let h = parseFloat(document.getElementById('waitHour').value) || 0;
                    if(h > 3) wait = (h - 3) * CFG.wait;
                    if(wait > 0) {
                        document.getElementById('row-wait').style.display = 'flex';
                        document.getElementById('val-wait').innerText = wait.toLocaleString() + ' ƒë';
                    }
                }

                let total = go + back + wait;
                let deposit = (type == '2') ? Math.round(total * 0.2) : 0;

                document.getElementById('result-area').style.display = 'block';
                document.getElementById('res-km').innerText = km.toFixed(1) + ' km';
                document.getElementById('res-time').innerText = min + ' ph√∫t';
                document.getElementById('val-go').innerText = go.toLocaleString() + ' ƒë';
                document.getElementById('res-total').innerText = total.toLocaleString() + ' ƒë';
                
                if(deposit > 0) {
                    document.getElementById('row-deposit').style.display = 'flex';
                    document.getElementById('val-deposit').innerText = deposit.toLocaleString() + ' ƒë';
                } else {
                    document.getElementById('row-deposit').style.display = 'none';
                }

                cachedData = { total, km: km.toFixed(1), time: min, go, back, wait, deposit, type };
                
                // Cu·ªôn xu·ªëng k·∫øt qu·∫£
                setTimeout(() => {
                    document.getElementById('result-area').scrollIntoView({behavior:'smooth', block:'center'});
                }, 300);
                
                btn.style.display = 'none'; 
                document.getElementById('book-buttons-bar').style.display = 'flex';

            } catch(e) { 
                alert("Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng ƒëi ho·∫∑c l·ªói d·ªãch v·ª•!"); 
                resetButtonsAndMap();
                checkIfReadyToCalculate();
            }
            btn.innerHTML = oldText; btn.disabled=false;
        }

        function preBook(method) {
            if(!document.getElementById('phone').value) {
                pendingMethod = method;
                document.getElementById('phone-modal').style.display = 'flex';
            } else book(method);
        }
        function closePhone() { document.getElementById('phone-modal').style.display='none'; }
        function savePhone() {
            let p = document.getElementById('quick-phone').value;
            if(p.length < 8) return alert("SƒêT kh√¥ng ƒë√∫ng!");
            document.getElementById('phone').value = p;
            closePhone();
            book(pendingMethod);
        }

        function book(method) {
            let p = document.getElementById('pickup'), d = document.getElementById('dropoff');
            if(cachedData.total == 0) return alert("Vui l√≤ng t√≠nh gi√° tr∆∞·ªõc!");

            let info = {
                ph: document.getElementById('phone').value,
                t: document.getElementById('time').value.replace('T',' '),
                c: document.getElementById('carType').selectedOptions[0].text,
                k: document.getElementById('tripType').selectedOptions[0].text,
                dr: document.getElementById('driver').selectedOptions[0].text, 
                n: document.getElementById('note').value
            };

            const linkMap = (el) => `https://www.google.com/maps?q=${el.dataset.lat},${el.dataset.lon}`;

            let msg = `TR∆Ø·ªúNG AN DRIVING\n----------------\nüìû ${info.ph}\nüïí ${info.t}\nüöò ${info.c}\nüîÑ ${info.k}\nüßë‚Äç‚úàÔ∏è T√†i x·∫ø: ${info.dr}\n\nüìç ƒê√≥n: ${p.value}\n   üëâ Map: ${linkMap(p)}\n`;
            document.querySelectorAll('.stop-inp').forEach((inp, i) => msg += `üî∏ D·ª´ng ${i+1}: ${inp.value}\n   üëâ Map: ${linkMap(inp)}\n`);
            msg += `üèÅ ƒê·∫øn: ${d.value}\n   üëâ Map: ${linkMap(d)}\n\n`;
            
            msg += `--- CHI TI·∫æT GI√Å ---\n`;
            msg += `1. Qu√£ng ƒë∆∞·ªùng: ${cachedData.km} km\n`;
            msg += `2. Chi·ªÅu ƒëi: ${cachedData.go.toLocaleString()} ƒë\n`;
            if(cachedData.type == '2') {
                msg += `3. Chi·ªÅu v·ªÅ: ${cachedData.back.toLocaleString()} ƒë\n`;
                if(cachedData.wait > 0) msg += `4. Ph√≠ ch·ªù: ${cachedData.wait.toLocaleString()} ƒë\n`;
            }
            msg += `üí∞ T·ªîNG: ${cachedData.total.toLocaleString()} ƒë\n`;
            if(cachedData.deposit > 0) msg += `üí≥ C·ªçc (20%): ${cachedData.deposit.toLocaleString()} ƒë\n`;
            if(info.n) msg += `\nüìù Ghi ch√∫: ${info.n}`;

            if(method == 'zalo') {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(msg).then(() => {
                         window.open('https://zalo.me/0847526893');
                    }).catch(() => { window.open('https://zalo.me/0847526893'); });
                } else {
                    window.open('https://zalo.me/0847526893');
                }
            } else {
                window.location.href = `mailto:truongan.driving@gmail.com?subject=ƒê·∫∂T XE TR∆Ø·ªúNG AN&body=${encodeURIComponent(msg)}`;
            }
        }
    </script>
</body>
</html>
