<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--green:#28a745;--muted:#6c757d;}
    *{box-sizing:border-box}
    #main-content {
      background:#f4f6f8;
      padding: 0;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    .container{padding:12px}
    .label-row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .label-row h3{margin:0;font-size:16px}

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    .input-row{position:relative;margin-top:8px}
    .input-row .clear-btn {
        position: absolute; right: 80px; top: 11px; 
        background: #f0f0f0; color: #666; border: none; padding: 3px 6px; 
        border-radius: 4px; font-weight: 700; cursor: pointer; line-height: 1;
        font-size: 14px; display: none; 
        z-index: 1000;
    }
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: block; 
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    .map-btn{position:absolute; right:8px; top:8px; background:var(--green); color:#fff; border:0; padding:6px 8px; border-radius:6px; font-weight:700; cursor:pointer}
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    .suggestions{position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff;border:1px solid #ddd;border-radius:8px;max-height:220px;overflow:auto; -webkit-overflow-scrolling:touch; z-index:1200; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:10px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:8px}
    .way-remove{position:absolute;right:6px;top:6px;background:#ff6b6b;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}

    /* KILL SWITCH STYLES */
    /* V√¥ hi·ªáu h√≥a form v√† l√†m m·ªù khi d·ªãch v·ª• t·∫Øt */
    .disabled-form {
        pointer-events: none;
        opacity: 0.6; 
        transition: opacity 0.3s;
    }
    #serviceOffNotice {
      margin-top: 12px; 
      padding: 10px; 
      background: #dc3545; 
      color: white; 
      border-radius: 8px; 
      font-size: 15px; 
      font-weight: 600; 
      text-align: center;
    }


    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.7); z-index: 9999; display: none;
      justify-content: center; align-items: center; padding: 20px;
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background: #fff; border-radius: 12px; padding: 20px;
      width: 100%; max-width: 450px; 
      max-height: 90vh; 
      overflow-y: auto; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    .modal-content h3 {
      margin-top: 0; color: var(--green); font-size: 20px; text-align: center;
    }
    #modal-text {
      white-space: pre-wrap; 
      font-family: monospace;
      font-size: 14px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .modal-actions {
      display: flex; gap: 10px;
    }
    .modal-actions button {
      flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer;
    }
    #copyModalBtn { background: #ffc107; color: #333; } 
    #zaloModalBtn { background: #0068ff; color: #fff; }
    #closeModalBtn { background: #ccc; color: #333; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media(min-width:700px){.container{max-width:720px;margin:0 auto}}
  </style>
</head>
<body>
<div id="main-content">
  <header>
    üöñ D·ªãch V·ª• Taxi<br>
    Tr∆∞·ªùng An Driving<br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">‚òéÔ∏è 0847526893</a> 
  </header>

  <div class="container">
    
    <div id="serviceOffNotice" style="display:none;">
      </div>
    
    <div id="instructionText" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;">
      üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...
    </div>

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3>üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n</h3></div>
      <input id="customerPhone" type="tel" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel" required>

      <div class="label-row">
        <h3>üìç ƒêi·ªÉm ƒë√≥n</h3>
        <div id="location-status-wrapper" style="display: flex; align-items: center; gap: 8px;">
          <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;">(ƒêang t√¨m v·ªã tr√≠...)</span>
          <i id="reloadLocationBtn" title="Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠">üîÑ</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)">
        <button class="clear-btn" data-input-id="pickup">‚úñ</button> 
        <button class="map-btn" id="pick-from-map">B·∫£n ƒë·ªì</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div class="label-row" style="margin-top:12px"><h3>üïí Ng√†y & Gi·ªù ƒë√≥n</h3></div>
      <input id="pickupDateTime" type="datetime-local">

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn">Ôºã Th√™m ƒëi·ªÉm d·ª´ng</button>

      <div class="label-row"><h3>üèÅ ƒêi·ªÉm ƒë·∫øn</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
        <button class="clear-btn" data-input-id="dropoff">‚úñ</button> 
        <button class="map-btn" id="pick-to-map">B·∫£n ƒë·ªì</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row" style="margin-top:12px"><h3>üöò Lo·∫°i xe</h3></div>
      <select id="carType">
        <option value="4 ch·ªó (10.000ƒë/km)">Xe 4 ch·ªó (10.000ƒë/km)</option> 
        <option value="7 ch·ªó (12.000ƒë/km)">Xe 7 ch·ªó (12.000ƒë/km)</option> 
      </select>

      <div class="label-row" style="margin-top:12px"><h3>üöó Lo·∫°i chuy·∫øn ƒëi</h3></div>
      <select id="tripType">
        <option value="1">1 chi·ªÅu</option>
        <option value="2">2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)</option>
      </select>

      <div id="waitingWrapper"> 
        <div class="label-row" style="margin-top:12px"><h3>‚è≥ Th·ªùi gian ch·ªù (gi·ªù)</h3></div>
        <input id="waiting" type="number" min="0" value="0" placeholder="Nh·∫≠p s·ªë gi·ªù ch·ªù">
      </div>

      <button class="calc-btn" id="calc-btn">üí∞ T√≠nh gi√°</button>
    </div> <div id="map"></div>

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText">‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng: ‚Äî</div>
      </div>

      <div class="price-title">üíµ Gi√° d·ª± ki·∫øn</div>
      <div class="price-value" id="priceValue">‚Äî ƒë</div>

      <div class="price-break" id="priceBreak"></div>

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst">‚è± Th·ªùi gian d·ª± ki·∫øn: ‚Äî ph√∫t</div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo">üïí Ng√†y gi·ªù ƒë√≥n: ‚Äî</div>
    </div>

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" style="display:none;" href="javascript:void(0);">üì± ƒê·∫∑t qua Zalo</a>
      <a id="mailBtn" class="mail" href="mailto:netvuan@gmail.com" style="display:none;">üìß ƒê·∫∑t qua Mail</a>
    </div>

    <div class="note">
      üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).
      <br>
      **Th·ªùi gian ch·ªù:**
      <ul>
        <li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li>
        <li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li>
        <li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li>
      </ul>
      Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.
    </div>
  </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>‚úÖ TH√îNG TIN ƒê·∫∂T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;">Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn">üìã Sao Ch√©p Th√¥ng Tin</button> 
            <button id="zaloModalBtn">üì± M·ªü Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;">ƒê√≥ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- C·∫•u h√¨nh T·ªëi ∆Øu H√≥a ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving";
const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn');

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 

const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--green:#28a745;--muted:#6c757d;}
    *{box-sizing:border-box}
    #main-content {
      background:#f4f6f8;
      padding: 0;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    .container{padding:12px}
    .label-row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .label-row h3{margin:0;font-size:16px}

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    .input-row{position:relative;margin-top:8px}
    .input-row .clear-btn {
        position: absolute; right: 80px; top: 11px; 
        background: #f0f0f0; color: #666; border: none; padding: 3px 6px; 
        border-radius: 4px; font-weight: 700; cursor: pointer; line-height: 1;
        font-size: 14px; display: none; 
        z-index: 1000;
    }
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: block; 
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    .map-btn{position:absolute; right:8px; top:8px; background:var(--green); color:#fff; border:0; padding:6px 8px; border-radius:6px; font-weight:700; cursor:pointer}
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    .suggestions{position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff;border:1px solid #ddd;border-radius:8px;max-height:220px;overflow:auto; -webkit-overflow-scrolling:touch; z-index:1200; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:10px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:8px}
    .way-remove{position:absolute;right:6px;top:6px;background:#ff6b6b;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}

    /* KILL SWITCH STYLES */
    /* V√¥ hi·ªáu h√≥a form v√† l√†m m·ªù khi d·ªãch v·ª• t·∫Øt */
    .disabled-form {
        pointer-events: none;
        opacity: 0.6; 
        transition: opacity 0.3s;
    }
    #serviceOffNotice {
      margin-top: 12px; 
      padding: 10px; 
      background: #dc3545; 
      color: white; 
      border-radius: 8px; 
      font-size: 15px; 
      font-weight: 600; 
      text-align: center;
    }


    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.7); z-index: 9999; display: none;
      justify-content: center; align-items: center; padding: 20px;
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background: #fff; border-radius: 12px; padding: 20px;
      width: 100%; max-width: 450px; 
      max-height: 90vh; 
      overflow-y: auto; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    .modal-content h3 {
      margin-top: 0; color: var(--green); font-size: 20px; text-align: center;
    }
    #modal-text {
      white-space: pre-wrap; 
      font-family: monospace;
      font-size: 14px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .modal-actions {
      display: flex; gap: 10px;
    }
    .modal-actions button {
      flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer;
    }
    #copyModalBtn { background: #ffc107; color: #333; } 
    #zaloModalBtn { background: #0068ff; color: #fff; }
    #closeModalBtn { background: #ccc; color: #333; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media(min-width:700px){.container{max-width:720px;margin:0 auto}}
  </style>
</head>
<body>
<div id="main-content">
  <header>
    üöñ D·ªãch V·ª• Taxi<br>
    Tr∆∞·ªùng An Driving<br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">‚òéÔ∏è 0847526893</a> 
  </header>

  <div class="container">
    
    <div id="serviceOffNotice" style="display:none;">
      </div>
    
    <div id="instructionText" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;">
      üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...
    </div>

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3>üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n</h3></div>
      <input id="customerPhone" type="tel" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel" required>

      <div class="label-row">
        <h3>üìç ƒêi·ªÉm ƒë√≥n</h3>
        <div id="location-status-wrapper" style="display: flex; align-items: center; gap: 8px;">
          <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;">(ƒêang t√¨m v·ªã tr√≠...)</span>
          <i id="reloadLocationBtn" title="Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠">üîÑ</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)">
        <button class="clear-btn" data-input-id="pickup">‚úñ</button> 
        <button class="map-btn" id="pick-from-map">B·∫£n ƒë·ªì</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div class="label-row" style="margin-top:12px"><h3>üïí Ng√†y & Gi·ªù ƒë√≥n</h3></div>
      <input id="pickupDateTime" type="datetime-local">

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn">Ôºã Th√™m ƒëi·ªÉm d·ª´ng</button>

      <div class="label-row"><h3>üèÅ ƒêi·ªÉm ƒë·∫øn</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
        <button class="clear-btn" data-input-id="dropoff">‚úñ</button> 
        <button class="map-btn" id="pick-to-map">B·∫£n ƒë·ªì</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row" style="margin-top:12px"><h3>üöò Lo·∫°i xe</h3></div>
      <select id="carType">
        <option value="4 ch·ªó (10.000ƒë/km)">Xe 4 ch·ªó (10.000ƒë/km)</option> 
        <option value="7 ch·ªó (12.000ƒë/km)">Xe 7 ch·ªó (12.000ƒë/km)</option> 
      </select>

      <div class="label-row" style="margin-top:12px"><h3>üöó Lo·∫°i chuy·∫øn ƒëi</h3></div>
      <select id="tripType">
        <option value="1">1 chi·ªÅu</option>
        <option value="2">2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)</option>
      </select>

      <div id="waitingWrapper"> 
        <div class="label-row" style="margin-top:12px"><h3>‚è≥ Th·ªùi gian ch·ªù (gi·ªù)</h3></div>
        <input id="waiting" type="number" min="0" value="0" placeholder="Nh·∫≠p s·ªë gi·ªù ch·ªù">
      </div>

      <button class="calc-btn" id="calc-btn">üí∞ T√≠nh gi√°</button>
    </div> <div id="map"></div>

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText">‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng: ‚Äî</div>
      </div>

      <div class="price-title">üíµ Gi√° d·ª± ki·∫øn</div>
      <div class="price-value" id="priceValue">‚Äî ƒë</div>

      <div class="price-break" id="priceBreak"></div>

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst">‚è± Th·ªùi gian d·ª± ki·∫øn: ‚Äî ph√∫t</div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo">üïí Ng√†y gi·ªù ƒë√≥n: ‚Äî</div>
    </div>

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" style="display:none;" href="javascript:void(0);">üì± ƒê·∫∑t qua Zalo</a>
      <a id="mailBtn" class="mail" href="mailto:netvuan@gmail.com" style="display:none;">üìß ƒê·∫∑t qua Mail</a>
    </div>

    <div class="note">
      üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).
      <br>
      **Th·ªùi gian ch·ªù:**
      <ul>
        <li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li>
        <li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li>
        <li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li>
      </ul>
      Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.
    </div>
  </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>‚úÖ TH√îNG TIN ƒê·∫∂T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;">Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn">üìã Sao Ch√©p Th√¥ng Tin</button> 
            <button id="zaloModalBtn">üì± M·ªü Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;">ƒê√≥ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- C·∫•u h√¨nh T·ªëi ∆Øu H√≥a ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving";
const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/?api=1&query=";
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/?api=1&origin=";
const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn');

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 

const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

let finalZaloMessage = ''; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;

/* ---------- T√çN HI·ªÜU KILL SWITCH (Polling) ---------- */

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`; 
    const finalUrl = REMOTE_STATUS_URL + cacheBuster;

    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
        
        if (!response.ok) {
            return { 
                active: false, 
                message_vn: "‚ö†Ô∏è C·∫¢NH B√ÅO M·∫†NG: Kh√¥ng t√¨m th·∫•y file tr·∫°ng th√°i d·ªãch v·ª• (404/Server Error). Ch·ª©c nƒÉng ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng." 
            };
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        let msg = "‚ö†Ô∏è Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng."
        if (error.name === 'TimeoutError') {
             msg = "‚ö†Ô∏è Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª• qu√° l√¢u. Vi·ªác ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng."
        }
        console.error("L·ªói khi fetch tr·∫°ng th√°i d·ªãch v·ª•:", error);
        return { 
            active: false, 
            message_vn: msg
        };
    }
}


async function updateUIBasedOnStatus(status) {
    if (status.active !== isServiceActive) {
        isServiceActive = status.active;
    }
    
    instructionText.style.display = 'block'; // Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh

    if (!isServiceActive) {
        // T·∫ÆT D·ªäCH V·ª§
        calcBtn.style.background = '#ccc';
        calcBtn.style.cursor = 'not-allowed';
        calcBtn.disabled = true;
        
        serviceOffNotice.style.display = 'block';
        serviceOffNotice.innerHTML = status.message_vn;
        
        // V√¥ hi·ªáu h√≥a form
        bookingFormWrapper.classList.add('disabled-form');
        
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';
        
    } else {
        // M·ªû D·ªäCH V·ª§
        calcBtn.style.background = 'var(--green)';
        calcBtn.style.cursor = 'pointer';
        calcBtn.disabled = false;
        
        serviceOffNotice.style.display = 'none';
        
        // K√≠ch ho·∫°t form
        bookingFormWrapper.classList.remove('disabled-form');
        
        instructionText.innerHTML = status.message_vn || 'üí∞ B·∫•m "T√≠nh gi√°" ƒë·ªÉ xem chi ti·∫øt ƒë·∫∑t xe.';
    }
}

/* ---------- C√°c h√†m JS kh√°c (InitMap, Geolocation, Autocomplete, Calculate...) GI·ªÆ NGUY√äN ---------- */
function initMap(center) {
    if (!map) {
        map = L.map('map').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        map.on('click', handleMapClick);
        map.on('dblclick', handleMapDblClick);
    } else {
        map.setView(center, 11);
    }
}

async function reverseGeocode(lat, lon) {
    try {
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=vi`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        console.warn('Reverse Geocoding Error', e);
        return `${lat.toFixed(6)}, ${lon.toFixed(6)} (Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ)`;
    }
}

function getGeolocation() {
    locationStatusEl.textContent = '(ƒêang t√¨m v·ªã tr√≠...)';
    locationStatusEl.style.color = 'var(--muted)';
    reloadLocationBtn.style.color = '#ccc'; 
    reloadLocationBtn.style.pointerEvents = 'none';

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            userLocation = [pos.coords.latitude, pos.coords.longitude]; 
            initMap(userLocation); 
            
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';

            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup('üìç V·ªã tr√≠ hi·ªán t·∫°i').openPopup();

            locationStatusEl.textContent = '‚úÖ ƒê√£ t√¨m th·∫•y v·ªã tr√≠';
            locationStatusEl.style.color = 'var(--green)';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, (err)=>{
            console.warn('Geolocation Error:', err.message);
            initMap(DEFAULT_CENTER); 
            
            let statusText = '‚ö†Ô∏è L·ªói t√¨m v·ªã tr√≠. Nh·∫≠p th·ªß c√¥ng.';
            if (err.code === err.PERMISSION_DENIED) {
                 statusText = '‚ùå B·ªã t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠.';
            } else if (err.code === err.POSITION_UNAVAILABLE) {
                 statusText = '‚ùå V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng (B·∫≠t GPS).';
            } else if (err.code === err.TIMEOUT) {
                 statusText = '‚ö†Ô∏è H·∫øt th·ªùi gian t√¨m v·ªã tr√≠.';
            }
            
            locationStatusEl.textContent = statusText;
            locationStatusEl.style.color = '#dc3545';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
    } else {
        initMap(DEFAULT_CENTER); 
        locationStatusEl.textContent = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.';
        locationStatusEl.style.color = '#dc3545';
        reloadLocationBtn.style.color = '#ccc';
        reloadLocationBtn.style.pointerEvents = 'none';
    }
}

function debounce(func, timeout = DEBOUNCE_TIME) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

function toggleWaitingInput(){
    if(tripTypeEl.value === '1'){
        waitingWrapper.style.display = 'none';
    } else {
        waitingWrapper.style.display = 'block';
    }
}

tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput();

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
            inputEl.value = '';
            delete inputEl.dataset.lat;
            delete inputEl.dataset.lon;
            if (inputId === 'pickup' && pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            } else if (inputId === 'dropoff' && dropoffMarker) {
                map.removeLayer(dropoffMarker);
                dropoffMarker = null;
            }
            const suggBox = document.getElementById(`${inputId}-suggestions`);
            if (suggBox) suggBox.style.display = 'none';
            inputEl.focus(); 
        }
    });
});
document.querySelectorAll('input[type="text"]').forEach(inputEl => {
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if (clearBtn) {
        inputEl.addEventListener('input', () => {
            clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        inputEl.addEventListener('focus', () => {
             clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        inputEl.addEventListener('blur', () => {
             setTimeout(() => clearBtn.style.display = 'none', 150); 
        });
    }
});


async function geocodeOnce(query){
  try{
    let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1`;
    
    if(userLocation) {
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.5},${lat - 0.5},${lon + 0.5},${lat + 0.5}&bounded=1`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }

    const r = await fetch(url);
    const data = await r.json();
    if(Array.isArray(data) && data.length>0) return data[0];
  }catch(e){ console.warn('geocode once error', e); }
  return null;
}

function attachAutocomplete(inputEl, boxEl){
  let controller = null;

  const doSearch = async ()=>{
    const q = inputEl.value.trim();
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    
    if(!q){ 
        boxEl.style.display = 'none'; 
        if(clearBtn) clearBtn.style.display = 'none';
        return; 
    }
    if(clearBtn) clearBtn.style.display = 'block';

    if(controller) controller.abort();
    controller = new AbortController();
    
    boxEl.innerHTML = '<div>ƒêang t√¨m ki·∫øm...</div>'; 
    boxEl.style.display = 'block'; 

    let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=vi`; 
    
    if(userLocation) {
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.3},${lat - 0.3},${lon + 0.3},${lat + 0.3}&bounded=1`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }


    try{
      const res = await fetch(url, { signal: controller.signal });
      const data = await res.json();
      
      const fragment = document.createDocumentFragment();
      
      if(!Array.isArray(data) || data.length === 0){ 
        boxEl.innerHTML = '<div>Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm</div>'; 
        setTimeout(() => boxEl.style.display = 'none', 1000); 
        return; 
      }

      data.forEach(place => {
        const d = document.createElement('div');
        d.innerHTML = `<span style="font-size:16px">üìç</span><div style="margin-left:8px">${place.display_name}</div>`;
        d.addEventListener('click', ()=>{
          inputEl.value = place.display_name;
          inputEl.dataset.lat = place.lat;
          inputEl.dataset.lon = place.lon;
          boxEl.style.display = 'none';
          if(clearBtn) clearBtn.style.display = 'block';

          const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
          if(map) {
            if(inputEl.id === 'pickup'){
              if(pickupMarker) map.removeLayer(pickupMarker);
              pickupMarker = L.marker(latlng).addTo(map).bindPopup('üìç ƒêi·ªÉm ƒë√≥n').openPopup();
              map.setView(latlng, 14);
            } else if(inputEl.id === 'dropoff'){
              if(dropoffMarker) map.removeLayer(dropoffMarker);
              dropoffMarker = L.marker(latlng).addTo(map).bindPopup('üèÅ ƒêi·ªÉm ƒë·∫øn').openPopup();
              map.setView(latlng, 14);
            } 
          }
        });
        fragment.appendChild(d);
      });
      
      boxEl.innerHTML = '';
      boxEl.appendChild(fragment);
      boxEl.style.display = 'block';
      
    }catch(err){
      if(err.name === 'AbortError') return; 
      console.error('suggest error', err);
      boxEl.innerHTML = '<div>L·ªói m·∫°ng ho·∫∑c API. Th·ª≠ l·∫°i</div>'; 
      setTimeout(() => boxEl.style.display = 'none', 2000); 
    }
  }; 

  inputEl.addEventListener('input', debounce(doSearch));

  document.addEventListener('click', (ev)=>{
    if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; 
  });

  inputEl.addEventListener('focus', ()=> {
    const inputId = inputEl.id; 
    if(inputId && inputId.startsWith('stop-')) lastFocusedStopId = inputId;
    else lastFocusedStopId = null;
    
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
  });
}

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

function createStopInput(prefill=''){
  stopCount++;
  const wrapper = document.createElement('div');
  wrapper.className = 'way-wrapper input-row';
  const inputId = `stop-${stopCount}`;
  const suggId = `${inputId}-suggestions`;
  wrapper.innerHTML = `
    <input type="text" id="${inputId}" placeholder="Nh·∫≠p ƒëi·ªÉm d·ª´ng ${stopCount}">
    <button class="way-remove" title="X√≥a">‚úñ</button>
    <div id="${suggId}" class="suggestions" style="display:none"></div>
  `;
  stopsContainer.appendChild(wrapper);

  const inputEl = wrapper.querySelector('input');
  const boxEl = wrapper.querySelector('.suggestions');
  attachAutocomplete(inputEl, boxEl);

  wrapper.querySelector('.way-remove').addEventListener('click', ()=> wrapper.remove());

  inputEl.addEventListener('focus', ()=> lastFocusedStopId = inputId);

  return inputEl;
}

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput());

document.getElementById('pick-from-map').addEventListener('click', ()=> { selecting = 'pickup'; alert('B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë√≥n'); });
document.getElementById('pick-to-map').addEventListener('click', ()=> { selecting = 'dropoff'; alert('B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn'); });

const handleMapClick = async (e) => {
  if (!map) return; 
  const lat = e.latlng.lat, lon = e.latlng.lng;
  if(selecting === 'pickup'){
    if(pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([lat,lon]).addTo(map).bindPopup('üìç ƒêi·ªÉm ƒë√≥n').openPopup();
    
    const address = await reverseGeocode(lat, lon);
    pickupEl.value = address;
    
    pickupEl.dataset.lat = lat; pickupEl.dataset.lon = lon;
    pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';
    selecting = null;
    return;
  }
  if(selecting === 'dropoff'){
    if(dropoffMarker) map.removeLayer(dropoffMarker);
    dropoffMarker = L.marker([lat,lon]).addTo(map).bindPopup('üèÅ ƒêi·ªÉm ƒë·∫øn').openPopup();
    
    const address = await reverseGeocode(lat, lon);
    dropoffEl.value = address;
    
    dropoffEl.dataset.lat = lat; dropoffEl.dataset.lon = lon;
    dropoffEl.parentNode.querySelector('.clear-btn').style.display = 'block';
    selecting = null;
    return;
  }
  if(lastFocusedStopId){
    const stopInput = document.getElementById(lastFocusedStopId);
    if(stopInput){
      const address = await reverseGeocode(lat, lon);
      stopInput.value = address;
      
      stopInput.dataset.lat = lat; stopInput.dataset.lon = lon;
      L.marker([lat,lon]).addTo(map).bindPopup('üìç ƒêi·ªÉm d·ª´ng').openPopup();
      lastFocusedStopId = null;
    }
  }
};

const handleMapDblClick = (e) => {
  if (!map) return; 
  if(lastFocusedStopId){
    const stopInput = document.getElementById(lastFocusedStopId);
    if(stopInput){
      stopInput.value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      stopInput.dataset.lat = e.latlng.lat; stopInput.dataset.lon = e.latlng.lng;
      L.marker([e.latlng.lat,e.latlng.lng]).addTo(map).bindPopup('üìç ƒêi·ªÉm d·ª´ng').openPopup();
      lastFocusedStopId = null;
    }
  }
};


async function resolveCoordForInput(inputEl){
  if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon){
    return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
  }
  const v = inputEl.value.trim();
  if(!v) return null;
  const parts = v.split(',');
  if(parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))){
    return [parseFloat(parts[0]), parseFloat(parts[1])];
  }
  const place = await geocodeOnce(v + ' Vi·ªát Nam');
  if(place){
    inputEl.dataset.lat = place.lat;
    inputEl.dataset.lon = place.lon;
    return [parseFloat(place.lat), parseFloat(place.lon)];
  }
  return null;
}

function validateInputs() {
    const phone = customerPhoneEl.value.trim();
    const phoneRegex = /^\d{10}$/; 
    if (!phoneRegex.test(phone)) {
        alert('‚ùå Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (ch√≠nh x√°c 10 ch·ªØ s·ªë).');
        customerPhoneEl.focus();
        return false;
    }
    if (pickupEl.value.trim() === '') {
        alert('‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë√≥n.');
        pickupEl.focus();
        return false;
    }
    if (dropoffEl.value.trim() === '') {
        alert('‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë·∫øn.');
        dropoffEl.focus();
        return false;
    }
    const tripType = tripTypeEl.value; 
    const waiting = parseFloat(waitingEl.value); 
    if (tripType === '2') {
        if (isNaN(waiting) || waiting < 0) {
            alert('‚ùå V√¨ b·∫°n ch·ªçn chuy·∫øn 2 chi·ªÅu, vui l√≤ng nh·∫≠p Th·ªùi gian ch·ªù (s·ªë gi·ªù) ƒë·ªÉ ch√∫ng t√¥i s·∫Øp x·∫øp xe. Gi√° tr·ªã ph·∫£i ‚â• 0.');
            waitingEl.focus();
            return false;
        }
    }
    return true;
}

calcBtn.addEventListener('click', async () => {
  if (!isServiceActive) {
      alert('‚ö†Ô∏è D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving hi·ªán ƒëang t·∫°m ng·ª´ng nh·∫≠n ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra th√¥ng b√°o tr√™n m√†n h√¨nh.');
      return;
  }
  
  if (!validateInputs()) {
    return;
  }
  
  const customerPhone = customerPhoneEl.value.trim(); 

  const pickupCoord = await resolveCoordForInput(pickupEl);
  if(!pickupCoord){ alert('Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô ƒêi·ªÉm ƒë√≥n. H√£y ch·ªçn g·ª£i √Ω ho·∫∑c ƒë·∫∑t tr√™n b·∫£n ƒë·ªì.'); return; }
  const dropoffCoord = await resolveCoordForInput(dropoffEl);
  if(!dropoffCoord){ alert('Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô ƒêi·ªÉm ƒë·∫øn. H√£y ch·ªçn g·ª£i √Ω ho·∫∑c ƒë·∫∑t tr√™n b·∫£n ƒë·ªì.'); return; }

  const coords = [];
  coords.push(pickupCoord);
  const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
  for(const s of stopInputs){
    if(s.value.trim()){
      const sc = await resolveCoordForInput(s);
      if(!sc){ alert('Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô cho m·ªôt ƒêi·ªÉm d·ª´ng.'); return; }
      coords.push(sc);
    }
  }
  coords.push(dropoffCoord);

  const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
  const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

  resultBox.style.display = 'block';
  distanceText.textContent = 'ƒêang t√≠nh l·ªô tr√¨nh...';
  priceValue.textContent = '...';
  priceBreak.innerHTML = '';
  timeEst.textContent = '';
  finalZaloMessage = ''; 
  zaloBtn.style.display = 'none'; 
  mailBtn.style.display = 'none';
  instructionText.innerHTML = 'ƒêang t√≠nh to√°n...';

  try{
    const r = await fetch(url);
    const data = await r.json();
    if(!data.routes || data.routes.length === 0){ distanceText.textContent = 'Kh√¥ng t√≠nh ƒë∆∞·ª£c l·ªô tr√¨nh'; return; }
    const route = data.routes[0];
    const dist = route.distance / 1000; 
    const minutes = Math.round((dist / 30) * 60);

    if(map) {
      if(routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
      map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
    }

    const tripType = tripTypeEl.value; 
    const carType = carTypeEl.value; 
    const waiting = parseFloat(waitingEl.value) || 0; 
    
    let perKm;
    if (carType.includes('7 ch·ªó')) { 
        perKm = 12000;
    } else { 
        perKm = 10000; 
    }
    const perKmReturnDiscount = Math.round(perKm * 0.6); 

    const priceGo = Math.round(dist * perKm);
    let priceReturn = 0;
    let returnNote = ''; 

    if(tripType === '2') {
        if(dist >= 45) {
            priceReturn = Math.round(dist * perKmReturnDiscount); 
            returnNote = `Chi·ªÅu v·ªÅ (gi·∫£m 40% do 1 chi·ªÅu ‚â• 45km => ${perKmReturnDiscount.toLocaleString('vi-VN')}ƒë/km)`;
        } else {
            priceReturn = Math.round(dist * perKm); 
            returnNote = `Chi·ªÅu v·ªÅ (Kh√¥ng gi·∫£m gi√° do 1 chi·ªÅu < 45km => ${perKm.toLocaleString('vi-VN')}ƒë/km)`;
        }
    } else {
        returnNote = '1 Chi·ªÅu';
    }

    const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
    const total = priceGo + priceReturn + waitFee;

    distanceText.textContent = `Qu√£ng ƒë∆∞·ªùng: ${dist.toFixed(1)} km (m·ªôt chi·ªÅu)`;
    priceValue.textContent = total.toLocaleString('vi-VN') + ' ƒë';

    let breakdownHtml = '';
    breakdownHtml += `‚Ä¢ Gi√° chi·ªÅu ƒëi (${perKm.toLocaleString('vi-VN')}ƒë/km): <b>${priceGo.toLocaleString('vi-VN')} ƒë</b><br>`;
    
    if(tripType === '2'){
      breakdownHtml += `‚Ä¢ ${returnNote}: <b>${priceReturn.toLocaleString('vi-VN')} ƒë</b><br>`;
    }

    let waitDetail;
    if (tripType === '2') {
        if (waiting > 3) {
            waitDetail = `Ph√≠ ch·ªù (${waiting} gi·ªù, mi·ªÖn ph√≠ 0‚Äì3h): <b>${waitFee.toLocaleString('vi-VN')} ƒë</b>`;
            breakdownHtml += `‚Ä¢ ${waitDetail}<br>`;
        } else if (waiting > 0) {
            waitDetail = `Th·ªùi gian ch·ªù (${waiting} gi·ªù): <b>Mi·ªÖn ph√≠</b>`;
            breakdownHtml += `‚Ä¢ ${waitDetail}<br>`;
        } 
    } else {
        waitDetail = ``; 
    }
    
    breakdownHtml += `<hr style="margin:6px 0">‚Ä¢ <b>T·ªïng c·ªông: ${total.toLocaleString('vi-VN')} ƒë</b>`;
    priceBreak.innerHTML = breakdownHtml;
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--green:#28a745;--muted:#6c757d;}
    *{box-sizing:border-box}
    #main-content {
      background:#f4f6f8;
      padding: 0;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    .container{padding:12px}
    .label-row{display:flex;align-items:center;gap:8px;margin-top:6px}
    .label-row h3{margin:0;font-size:16px}

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    .input-row{position:relative;margin-top:8px}
    .input-row .clear-btn {
        position: absolute; right: 80px; top: 11px; 
        background: #f0f0f0; color: #666; border: none; padding: 3px 6px; 
        border-radius: 4px; font-weight: 700; cursor: pointer; line-height: 1;
        font-size: 14px; display: none; 
        z-index: 1000;
    }
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: block; 
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    .map-btn{position:absolute; right:8px; top:8px; background:var(--green); color:#fff; border:0; padding:6px 8px; border-radius:6px; font-weight:700; cursor:pointer}
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    .suggestions{position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff;border:1px solid #ddd;border-radius:8px;max-height:220px;overflow:auto; -webkit-overflow-scrolling:touch; z-index:1200; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:10px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:8px}
    .way-remove{position:absolute;right:6px;top:6px;background:#ff6b6b;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}

    /* KILL SWITCH STYLES */
    /* V√¥ hi·ªáu h√≥a form v√† l√†m m·ªù khi d·ªãch v·ª• t·∫Øt */
    .disabled-form {
        pointer-events: none;
        opacity: 0.6; 
        transition: opacity 0.3s;
    }
    #serviceOffNotice {
      margin-top: 12px; 
      padding: 10px; 
      background: #dc3545; 
      color: white; 
      border-radius: 8px; 
      font-size: 15px; 
      font-weight: 600; 
      text-align: center;
    }


    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.7); z-index: 9999; display: none;
      justify-content: center; align-items: center; padding: 20px;
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background: #fff; border-radius: 12px; padding: 20px;
      width: 100%; max-width: 450px; 
      max-height: 90vh; 
      overflow-y: auto; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    .modal-content h3 {
      margin-top: 0; color: var(--green); font-size: 20px; text-align: center;
    }
    #modal-text {
      white-space: pre-wrap; 
      font-family: monospace;
      font-size: 14px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .modal-actions {
      display: flex; gap: 10px;
    }
    .modal-actions button {
      flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer;
    }
    #copyModalBtn { background: #ffc107; color: #333; } 
    #zaloModalBtn { background: #0068ff; color: #fff; }
    #closeModalBtn { background: #ccc; color: #333; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media(min-width:700px){.container{max-width:720px;margin:0 auto}}
  </style>
</head>
<body>
<div id="main-content">
  <header>
    üöñ D·ªãch V·ª• Taxi<br>
    Tr∆∞·ªùng An Driving<br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">‚òéÔ∏è 0847526893</a> 
  </header>

  <div class="container">
    
    <div id="serviceOffNotice" style="display:none;">
      </div>
    
    <div id="instructionText" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;">
      üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...
    </div>

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3>üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n</h3></div>
      <input id="customerPhone" type="tel" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel" required>

      <div class="label-row">
        <h3>üìç ƒêi·ªÉm ƒë√≥n</h3>
        <div id="location-status-wrapper" style="display: flex; align-items: center; gap: 8px;">
          <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;">(ƒêang t√¨m v·ªã tr√≠...)</span>
          <i id="reloadLocationBtn" title="Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠">üîÑ</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)">
        <button class="clear-btn" data-input-id="pickup">‚úñ</button> 
        <button class="map-btn" id="pick-from-map">B·∫£n ƒë·ªì</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div class="label-row" style="margin-top:12px"><h3>üïí Ng√†y & Gi·ªù ƒë√≥n</h3></div>
      <input id="pickupDateTime" type="datetime-local">

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn">Ôºã Th√™m ƒëi·ªÉm d·ª´ng</button>

      <div class="label-row"><h3>üèÅ ƒêi·ªÉm ƒë·∫øn</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
        <button class="clear-btn" data-input-id="dropoff">‚úñ</button> 
        <button class="map-btn" id="pick-to-map">B·∫£n ƒë·ªì</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row" style="margin-top:12px"><h3>üöò Lo·∫°i xe</h3></div>
      <select id="carType">
        <option value="4 ch·ªó (10.000ƒë/km)">Xe 4 ch·ªó (10.000ƒë/km)</option> 
        <option value="7 ch·ªó (12.000ƒë/km)">Xe 7 ch·ªó (12.000ƒë/km)</option> 
      </select>

      <div class="label-row" style="margin-top:12px"><h3>üöó Lo·∫°i chuy·∫øn ƒëi</h3></div>
      <select id="tripType">
        <option value="1">1 chi·ªÅu</option>
        <option value="2">2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)</option>
      </select>

      <div id="waitingWrapper"> 
        <div class="label-row" style="margin-top:12px"><h3>‚è≥ Th·ªùi gian ch·ªù (gi·ªù)</h3></div>
        <input id="waiting" type="number" min="0" value="0" placeholder="Nh·∫≠p s·ªë gi·ªù ch·ªù">
      </div>

      <button class="calc-btn" id="calc-btn">üí∞ T√≠nh gi√°</button>
    </div> <div id="map"></div>

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText">‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng: ‚Äî</div>
      </div>

      <div class="price-title">üíµ Gi√° d·ª± ki·∫øn</div>
      <div class="price-value" id="priceValue">‚Äî ƒë</div>

      <div class="price-break" id="priceBreak"></div>

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst">‚è± Th·ªùi gian d·ª± ki·∫øn: ‚Äî ph√∫t</div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo">üïí Ng√†y gi·ªù ƒë√≥n: ‚Äî</div>
    </div>

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" style="display:none;" href="javascript:void(0);">üì± ƒê·∫∑t qua Zalo</a>
      <a id="mailBtn" class="mail" href="mailto:netvuan@gmail.com" style="display:none;">üìß ƒê·∫∑t qua Mail</a>
    </div>

    <div class="note">
      üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).
      <br>
      **Th·ªùi gian ch·ªù:**
      <ul>
        <li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li>
        <li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li>
        <li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li>
      </ul>
      Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.
    </div>
  </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>‚úÖ TH√îNG TIN ƒê·∫∂T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;">Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn">üìã Sao Ch√©p Th√¥ng Tin</button> 
            <button id="zaloModalBtn">üì± M·ªü Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;">ƒê√≥ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- C·∫•u h√¨nh T·ªëi ∆Øu H√≥a ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving";
// URL Maps ng·∫Øn g·ªçn (S·ª≠ d·ª•ng l·ªánh t√¨m ki·∫øm ƒë·ªãa ch·ªâ)
const GOOGLE_MAPS_SHORT_URL = "https://www.google.com/maps/dir/?api=1&origin=3"; 
const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn');

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 

const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

let finalZaloMessage = ''; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;

/* ---------- T√çN HI·ªÜU KILL SWITCH (Polling) ---------- */

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`; 
    const finalUrl = REMOTE_STATUS_URL + cacheBuster;

    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
        
        if (!response.ok) {
            return { 
                active: false, 
                message_vn: "‚ö†Ô∏è C·∫¢NH B√ÅO M·∫†NG: Kh√¥ng t√¨m th·∫•y file tr·∫°ng th√°i d·ªãch v·ª• (404/Server Error). Ch·ª©c nƒÉng ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng." 
            };
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        let msg = "‚ö†Ô∏è Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng."
        if (error.name === 'TimeoutError') {
             msg = "‚ö†Ô∏è Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª• qu√° l√¢u. Vi·ªác ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng."
        }
        console.error("L·ªói khi fetch tr·∫°ng th√°i d·ªãch v·ª•:", error);
        return { 
            active: false, 
            message_vn: msg
        };
    }
}


async function updateUIBasedOnStatus(status) {
    if (status.active !== isServiceActive) {
        isServiceActive = status.active;
    }
    
    instructionText.style.display = 'block'; // Hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh

    if (!isServiceActive) {
        // T·∫ÆT D·ªäCH V·ª§
        calcBtn.style.background = '#ccc';
        calcBtn.style.cursor = 'not-allowed';
        calcBtn.disabled = true;
        
        serviceOffNotice.style.display = 'block';
        serviceOffNotice.innerHTML = status.message_vn;
        
        // V√¥ hi·ªáu h√≥a form
        bookingFormWrapper.classList.add('disabled-form');
        
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';
        
    } else {
        // M·ªû D·ªäCH V·ª§
        calcBtn.style.background = 'var(--green)';
        calcBtn.style.cursor = 'pointer';
        calcBtn.disabled = false;
        
        serviceOffNotice.style.display = 'none';
        
        // K√≠ch ho·∫°t form
        bookingFormWrapper.classList.remove('disabled-form');
        
        instructionText.innerHTML = status.message_vn || 'üí∞ B·∫•m "T√≠nh gi√°" ƒë·ªÉ xem chi ti·∫øt ƒë·∫∑t xe.';
    }
}

/* ---------- C√°c h√†m JS kh√°c (InitMap, Geolocation, Autocomplete, Calculate...) GI·ªÆ NGUY√äN ---------- */
function initMap(center) {
    if (!map) {
        map = L.map('map').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        map.on('click', handleMapClick);
        map.on('dblclick', handleMapDblClick);
    } else {
        map.setView(center, 11);
    }
}

async function reverseGeocode(lat, lon) {
    try {
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=vi`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        console.warn('Reverse Geocoding Error', e);
        return `${lat.toFixed(6)}, ${lon.toFixed(6)} (Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ)`;
    }
}

function getGeolocation() {
    locationStatusEl.textContent = '(ƒêang t√¨m v·ªã tr√≠...)';
    locationStatusEl.style.color = 'var(--muted)';
    reloadLocationBtn.style.color = '#ccc'; 
    reloadLocationBtn.style.pointerEvents = 'none';

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            userLocation = [pos.coords.latitude, pos.coords.longitude]; 
            initMap(userLocation); 
            
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';

            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup('üìç V·ªã tr√≠ hi·ªán t·∫°i').openPopup();

            locationStatusEl.textContent = '‚úÖ ƒê√£ t√¨m th·∫•y v·ªã tr√≠';
            locationStatusEl.style.color = 'var(--green)';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, (err)=>{
            console.warn('Geolocation Error:', err.message);
            initMap(DEFAULT_CENTER); 
            
            let statusText = '‚ö†Ô∏è L·ªói t√¨m v·ªã tr√≠. Nh·∫≠p th·ªß c√¥ng.';
            if (err.code === err.PERMISSION_DENIED) {
                 statusText = '‚ùå B·ªã t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠.';
            } else if (err.code === err.POSITION_UNAVAILABLE) {
                 statusText = '‚ùå V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng (B·∫≠t GPS).';
            } else if (err.code === err.TIMEOUT) {
                 statusText = '‚ö†Ô∏è H·∫øt th·ªùi gian t√¨m v·ªã tr√≠.';
            }
            
            locationStatusEl.textContent = statusText;
            locationStatusEl.style.color = '#dc3545';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
    } else {
        initMap(DEFAULT_CENTER); 
        locationStatusEl.textContent = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.';
        locationStatusEl.style.color = '#dc3545';
        reloadLocationBtn.style.color = '#ccc';
        reloadLocationBtn.style.pointerEvents = 'none';
    }
}

function debounce(func, timeout = DEBOUNCE_TIME) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

function toggleWaitingInput(){
    if(tripTypeEl.value === '1'){
        waitingWrapper.style.display = 'none';
    } else {
        waitingWrapper.style.display = 'block';
    }
}

tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput();

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
            inputEl.value = '';
            delete inputEl.dataset.lat;
            delete inputEl.dataset.lon;
            if (inputId === 'pickup' && pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            } else if (inputId === 'dropoff' && dropoffMarker) {
                map.removeLayer(dropoffMarker);
                dropoffMarker = null;
            }
            const suggBox = document.getElementById(`${inputId}-suggestions`);
            if (suggBox) suggBox.style.display = 'none';
            inputEl.focus(); 
        }
    });
});
document.querySelectorAll('input[type="text"]').forEach(inputEl => {
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if (clearBtn) {
        inputEl.addEventListener('input', () => {
            clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        inputEl.addEventListener('focus', () => {
             clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        inputEl.addEventListener('blur', () => {
             setTimeout(() => clearBtn.style.display = 'none', 150); 
        });
    }
});


async function geocodeOnce(query){
  try{
    let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1`;
    
    if(userLocation) {
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.5},${lat - 0.5},${lon + 0.5},${lat + 0.5}&bounded=1`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }

    const r = await fetch(url);
    const data = await r.json();
    if(Array.isArray(data) && data.length>0) return data[0];
  }catch(e){ console.warn('geocode once error', e); }
  return null;
}

function attachAutocomplete(inputEl, boxEl){
  let controller = null;

  const doSearch = async ()=>{
    const q = inputEl.value.trim();
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    
    if(!q){ 
        boxEl.style.display = 'none'; 
        if(clearBtn) clearBtn.style.display = 'none';
        return; 
    }
    if(clearBtn) clearBtn.style.display = 'block';

    if(controller) controller.abort();
    controller = new AbortController();
    
    boxEl.innerHTML = '<div>ƒêang t√¨m ki·∫øm...</div>'; 
    boxEl.style.display = 'block'; 

    let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=vi`; 
    
    if(userLocation) {
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.3},${lat - 0.3},${lon + 0.3},${lat + 0.3}&bounded=1`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }


    try{
      const res = await fetch(url, { signal: controller.signal });
      const data = await res.json();
      
      const fragment = document.createDocumentFragment();
      
      if(!Array.isArray(data) || data.length === 0){ 
        boxEl.innerHTML = '<div>Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm</div>'; 
        setTimeout(() => boxEl.style.display = 'none', 1000); 
        return; 
      }

      data.forEach(place => {
        const d = document.createElement('div');
        d.innerHTML = `<span style="font-size:16px">üìç</span><div style="margin-left:8px">${place.display_name}</div>`;
        d.addEventListener('click', ()=>{
          inputEl.value = place.display_name;
          inputEl.dataset.lat = place.lat;
          inputEl.dataset.lon = place.lon;
          boxEl.style.display = 'none';
          if(clearBtn) clearBtn.style.display = 'block';

          const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
          if(map) {
            if(inputEl.id === 'pickup'){
              if(pickupMarker) map.removeLayer(pickupMarker);
              pickupMarker = L.marker(latlng).addTo(map).bindPopup('üìç ƒêi·ªÉm ƒë√≥n').openPopup();
              map.setView(latlng, 14);
            } else if(inputEl.id === 'dropoff'){
              if(dropoffMarker) map.removeLayer(dropoffMarker);
              dropoffMarker = L.marker(latlng).addTo(map).bindPopup('üèÅ ƒêi·ªÉm ƒë·∫øn').openPopup();
              map.setView(latlng, 14);
            } 
          }
        });
        fragment.appendChild(d);
      });
      
      boxEl.innerHTML = '';
      boxEl.appendChild(fragment);
      boxEl.style.display = 'block';
      
    }catch(err){
      if(err.name === 'AbortError') return; 
      console.error('suggest error', err);
      boxEl.innerHTML = '<div>L·ªói m·∫°ng ho·∫∑c API. Th·ª≠ l·∫°i</div>'; 
      setTimeout(() => boxEl.style.display = 'none', 2000); 
    }
  }; 

  inputEl.addEventListener('input', debounce(doSearch));

  document.addEventListener('click', (ev)=>{
    if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; 
  });

  inputEl.addEventListener('focus', ()=> {
    const inputId = inputEl.id; 
    if(inputId && inputId.startsWith('stop-')) lastFocusedStopId = inputId;
    else lastFocusedStopId = null;
    
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
  });
}

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

function createStopInput(prefill=''){
  stopCount++;
  const wrapper = document.createElement('div');
  wrapper.className = 'way-wrapper input-row';
  const inputId = `stop-${stopCount}`;
  const suggId = `${inputId}-suggestions`;
  wrapper.innerHTML = `
    <input type="text" id="${inputId}" placeholder="Nh·∫≠p ƒëi·ªÉm d·ª´ng ${stopCount}">
    <button class="way-remove" title="X√≥a">‚úñ</button>
    <div id="${suggId}" class="suggestions" style="display:none"></div>
  `;
  stopsContainer.appendChild(wrapper);

  const inputEl = wrapper.querySelector('input');
  const boxEl = wrapper.querySelector('.suggestions');
  attachAutocomplete(inputEl, boxEl);

  wrapper.querySelector('.way-remove').addEventListener('click', ()=> wrapper.remove());

  inputEl.addEventListener('focus', ()=> lastFocusedStopId = inputId);

  return inputEl;
}

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput());

document.getElementById('pick-from-map').addEventListener('click', ()=> { selecting = 'pickup'; alert('B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë√≥n'); });
document.getElementById('pick-to-map').addEventListener('click', ()=> { selecting = 'dropoff'; alert('B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn'); });

const handleMapClick = async (e) => {
  if (!map) return; 
  const lat = e.latlng.lat, lon = e.latlng.lng;
  if(selecting === 'pickup'){
    if(pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([lat,lon]).addTo(map).bindPopup('üìç ƒêi·ªÉm ƒë√≥n').openPopup();
    
    const address = await reverseGeocode(lat, lon);
    pickupEl.value = address;
    
    pickupEl.dataset.lat = lat; pickupEl.dataset.lon = lon;
    pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';
    selecting = null;
    return;
  }
  if(selecting === 'dropoff'){
    if(dropoffMarker) map.removeLayer(dropoffMarker);
    dropoffMarker = L.marker([lat,lon]).addTo(map).bindPopup('üèÅ ƒêi·ªÉm ƒë·∫øn').openPopup();
    
    const address = await reverseGeocode(lat, lon);
    dropoffEl.value = address;
    
    dropoffEl.dataset.lat = lat; dropoffEl.dataset.lon = lon;
    dropoffEl.parentNode.querySelector('.clear-btn').style.display = 'block';
    selecting = null;
    return;
  }
  if(lastFocusedStopId){
    const stopInput = document.getElementById(lastFocusedStopId);
    if(stopInput){
      const address = await reverseGeocode(lat, lon);
      stopInput.value = address;
      
      stopInput.dataset.lat = lat; stopInput.dataset.lon = lon;
      L.marker([lat,lon]).addTo(map).bindPopup('üìç ƒêi·ªÉm d·ª´ng').openPopup();
      lastFocusedStopId = null;
    }
  }
};

const handleMapDblClick = (e) => {
  if (!map) return; 
  if(lastFocusedStopId){
    const stopInput = document.getElementById(lastFocusedStopId);
    if(stopInput){
      stopInput.value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      stopInput.dataset.lat = e.latlng.lat; stopInput.dataset.lon = e.latlng.lng;
      L.marker([e.latlng.lat,e.latlng.lng]).addTo(map).bindPopup('üìç ƒêi·ªÉm d·ª´ng').openPopup();
      lastFocusedStopId = null;
    }
  }
};


async function resolveCoordForInput(inputEl){
  if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon){
    return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
  }
  const v = inputEl.value.trim();
  if(!v) return null;
  const parts = v.split(',');
  if(parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))){
    return [parseFloat(parts[0]), parseFloat(parts[1])];
  }
  const place = await geocodeOnce(v + ' Vi·ªát Nam');
  if(place){
    inputEl.dataset.lat = place.lat;
    inputEl.dataset.lon = place.lon;
    return [parseFloat(place.lat), parseFloat(place.lon)];
  }
  return null;
}

function validateInputs() {
    const phone = customerPhoneEl.value.trim();
    const phoneRegex = /^\d{10}$/; 
    if (!phoneRegex.test(phone)) {
        alert('‚ùå Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (ch√≠nh x√°c 10 ch·ªØ s·ªë).');
        customerPhoneEl.focus();
        return false;
    }
    if (pickupEl.value.trim() === '') {
        alert('‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë√≥n.');
        pickupEl.focus();
        return false;
    }
    if (dropoffEl.value.trim() === '') {
        alert('‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë·∫øn.');
        dropoffEl.focus();
        return false;
    }
    const tripType = tripTypeEl.value; 
    const waiting = parseFloat(waitingEl.value); 
    if (tripType === '2') {
        if (isNaN(waiting) || waiting < 0) {
            alert('‚ùå V√¨ b·∫°n ch·ªçn chuy·∫øn 2 chi·ªÅu, vui l√≤ng nh·∫≠p Th·ªùi gian ch·ªù (s·ªë gi·ªù) ƒë·ªÉ ch√∫ng t√¥i s·∫Øp x·∫øp xe. Gi√° tr·ªã ph·∫£i ‚â• 0.');
            waitingEl.focus();
            return false;
        }
    }
    return true;
}

calcBtn.addEventListener('click', async () => {
  if (!isServiceActive) {
      alert('‚ö†Ô∏è D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving hi·ªán ƒëang t·∫°m ng·ª´ng nh·∫≠n ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra th√¥ng b√°o tr√™n m√†n h√¨nh.');
      return;
  }
  
  if (!validateInputs()) {
    return;
  }
  
  const customerPhone = customerPhoneEl.value.trim(); 

  const pickupCoord = await resolveCoordForInput(pickupEl);
  if(!pickupCoord){ alert('Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô ƒêi·ªÉm ƒë√≥n. H√£y ch·ªçn g·ª£i √Ω ho·∫∑c ƒë·∫∑t tr√™n b·∫£n ƒë·ªì.'); return; }
  const dropoffCoord = await resolveCoordForInput(dropoffEl);
  if(!dropoffCoord){ alert('Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô ƒêi·ªÉm ƒë·∫øn. H√£y ch·ªçn g·ª£i √Ω ho·∫∑c ƒë·∫∑t tr√™n b·∫£n ƒë·ªì.'); return; }

  const coords = [];
  coords.push(pickupCoord);
  const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
  for(const s of stopInputs){
    if(s.value.trim()){
      const sc = await resolveCoordForInput(s);
      if(!sc){ alert('Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô cho m·ªôt ƒêi·ªÉm d·ª´ng.'); return; }
      coords.push(sc);
    }
  }
  coords.push(dropoffCoord);

  const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
  const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

  resultBox.style.display = 'block';
  distanceText.textContent = 'ƒêang t√≠nh l·ªô tr√¨nh...';
  priceValue.textContent = '...';
  priceBreak.innerHTML = '';
  timeEst.textContent = '';
  finalZaloMessage = ''; 
  zaloBtn.style.display = 'none'; 
  mailBtn.style.display = 'none';
  instructionText.innerHTML = 'ƒêang t√≠nh to√°n...';

  try{
    const r = await fetch(url);
    const data = await r.json();
    if(!data.routes || data.routes.length === 0){ distanceText.textContent = 'Kh√¥ng t√≠nh ƒë∆∞·ª£c l·ªô tr√¨nh'; return; }
    const route = data.routes[0];
    const dist = route.distance / 1000; 
    const minutes = Math.round((dist / 30) * 60);

    if(map) {
      if(routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
      map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
    }

    const tripType = tripTypeEl.value; 
    const carType = carTypeEl.value; 
    const waiting = parseFloat(waitingEl.value) || 0; 
    
    let perKm;
    if (carType.includes('7 ch·ªó')) { 
        perKm = 12000;
    } else { 
        perKm = 10000; 
    }
    const perKmReturnDiscount = Math.round(perKm * 0.6); 

    const priceGo = Math.round(dist * perKm);
    let priceReturn = 0;
    let returnNote = ''; 

    if(tripType === '2') {
        if(dist >= 45) {
            priceReturn = Math.round(dist * perKmReturnDiscount); 
            returnNote = `Chi·ªÅu v·ªÅ (gi·∫£m 40% do 1 chi·ªÅu ‚â• 45km => ${perKmReturnDiscount.toLocaleString('vi-VN')}ƒë/km)`;
        } else {
            priceReturn = Math.round(dist * perKm); 
            returnNote = `Chi·ªÅu v·ªÅ (Kh√¥ng gi·∫£m gi√° do 1 chi·ªÅu < 45km => ${perKm.toLocaleString('vi-VN')}ƒë/km)`;
        }
    } else {
        returnNote = '1 Chi·ªÅu';
    }

    const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
    const total = priceGo + priceReturn + waitFee;

    distanceText.textContent = `Qu√£ng ƒë∆∞·ªùng: ${dist.toFixed(1)} km (m·ªôt chi·ªÅu)`;
    priceValue.textContent = total.toLocaleString('vi-VN') + ' ƒë';

    let breakdownHtml = '';
    breakdownHtml += `‚Ä¢ Gi√° chi·ªÅu ƒëi (${perKm.toLocaleString('vi-VN')}ƒë/km): <b>${priceGo.toLocaleString('vi-VN')} ƒë</b><br>`;
    
    if(tripType === '2'){
      breakdownHtml += `‚Ä¢ ${returnNote}: <b>${priceReturn.toLocaleString('vi-VN')} ƒë</b><br>`;
    }

    let waitDetail;
    if (tripType === '2') {
        if (waiting > 3) {
            waitDetail = `Ph√≠ ch·ªù (${waiting} gi·ªù, mi·ªÖn ph√≠ 0‚Äì3h): <b>${waitFee.toLocaleString('vi-VN')} ƒë</b>`;
            breakdownHtml += `‚Ä¢ ${waitDetail}<br>`;
        } else if (waiting > 0) {
            waitDetail = `Th·ªùi gian ch·ªù (${waiting} gi·ªù): <b>Mi·ªÖn ph√≠</b>`;
            breakdownHtml += `‚Ä¢ ${waitDetail}<br>`;
        } 
    } else {
        waitDetail = ``; 
    }
    
    breakdownHtml += `<hr style="margin:6px 0">‚Ä¢ <b>T·ªïng c·ªông: ${total.toLocaleString('vi-VN')} ƒë</b>`;
    priceBreak.innerHTML = breakdownHtml;

    timeEst.textContent = `‚è± Th·ªùi gian d·ª± ki·∫øn (t√≠nh theo 30 km/h): ${minutes} ph√∫t`;

    const dateVal = pickupDateTime.value;
    const formattedDate = dateVal ? new Date(dateVal).toLocaleString('vi-VN', { 
        year: 'numeric', month: 'numeric', day: 'numeric', 
        hour: '2-digit', minute: '2-digit', 
        hour12: false 
    }) : '(Ch∆∞a ch·ªçn)';
    pickupInfo.textContent = `üïí Ng√†y gi·ªù ƒë√≥n: ${formattedDate}`;
    
    const stopInputsValues = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'))
        .map(s => s.value.trim()).filter(v => v);
    
    const stopDetails = stopInputsValues.map((v, i) => `üõ£Ô∏è ƒêi·ªÉm d·ª´ng ${i+1}: ${v}`).join('\n');
    
    let zaloWaitingDetail;
    if (tripType === '2') {
        if (waiting > 3) {
            zaloWaitingDetail = `‚è≥ Th·ªùi gian ch·ªù: ${waiting} gi·ªù (Ph√≠ ch·ªù ph√°t sinh: ${waitFee.toLocaleString('vi-VN')} ƒë)`;
        } else if (waiting > 0) {
            zaloWaitingDetail = `‚è≥ Th·ªùi gian ch·ªù: ${waiting} gi·ªù (Mi·ªÖn ph√≠)`;
        } else {
             zaloWaitingDetail = `‚è≥ Th·ªùi gian ch·ªù: 0 gi·ªù (Mi·ªÖn ph√≠)`;
        }
    }
    
    // ----------- T√çNH NƒÇNG MAPS LINK (R√öT G·ªåN) -----------
    const pickupAddress = pickupEl.value.trim();
    // M√£ h√≥a ƒë·ªãa ch·ªâ ƒë√≥n
    const encodedPickUp = encodeURIComponent(pickupAddress); 
    
    // Link R√∫t g·ªçn: Ch·ªâ c·∫ßn ƒë∆∞·ªùng link T√¨m ki·∫øm (Search) ƒë·∫øn ƒêi·ªÉm ƒë√≥n 
    // Link n√†y ng·∫Øn h∆°n r·∫•t nhi·ªÅu v√† ƒë·ªß cho t√†i x·∫ø ƒë·∫øn ƒë√≥n kh√°ch.
    const mapsPickupLink = `${GOOGLE_MAPS_SHORT_URL}${encodedPickUp}`;
    
    let mapsLinksSection = [
        `\n*** üó∫Ô∏è LI√äN K·∫æT B·∫¢N ƒê·ªí CHO T√ÄI X·∫æ ***`,
        `üìç V·ªã tr√≠ ƒë√≥n kh√°ch (NG·∫ÆN G·ªåN): ${mapsPickupLink}`,
        `\n`
    ].join('\n');
    // ----------- K·∫æT TH√öC T√çNH NƒÇNG MAPS LINK (R√öT G·ªåN) -----------
    
    finalZaloMessage = [
        'üöñ Y√äU C·∫¶U ƒê·∫∂T XE TR∆Ø·ªúNG AN DRIVING',
        '-------------------------------',
        `üìû SƒêT Kh√°ch h√†ng: ${customerPhone}`, 
        `‚úÖ Lo·∫°i chuy·∫øn: ${tripType === '1' ? '1 Chi·ªÅu' : `2 Chi·ªÅu (${dist.toFixed(1)} km/chi·ªÅu)`}`,
        `üöò Lo·∫°i xe: ${carType}`, 
        `üìç ƒêi·ªÉm ƒë√≥n: ${pickupAddress}`,
        ...(stopInputsValues.length ? [stopDetails] : []),
        `üèÅ ƒêi·ªÉm ƒë·∫øn: ${dropoffEl.value.trim()}`,
        `üïí Ng√†y gi·ªù ƒë√≥n: ${formattedDate}`,
        ...(tripType === '2' ? [zaloWaitingDetail] : []), 
        `üíµ T·ªïng gi√° d·ª± ki·∫øn: ${total.toLocaleString('vi-VN')} ƒë`,
        mapsLinksSection, // Ch√®n ƒëo·∫°n Maps link ng·∫Øn
        '-------------------------------',
        'Vui l√≤ng x√°c nh·∫≠n ƒë∆°n h√†ng.',
    ].join('\n');

    const encodedMsg = encodeURIComponent(finalZaloMessage);
    mailBtn.href = `mailto:netvuan@gmail.com?subject=${encodeURIComponent('Y√™u c·∫ßu ƒê·∫∑t xe Tr∆∞·ªùng An')} - ${dist.toFixed(1)} km&body=${encodedMsg}`;

    zaloBtn.style.display = 'block'; 
    mailBtn.style.display = 'block'; 
    instructionText.style.display = 'block';
    instructionText.innerHTML = '‚úÖ **T√≠nh to√°n th√†nh c√¥ng!** B·∫•m n√∫t **ƒê·∫∑t qua Zalo** ƒë·ªÉ g·ª≠i th√¥ng tin ƒë∆°n h√†ng.';

    resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }catch(err){
    console.error('Route error', err);
    distanceText.textContent = 'L·ªói khi t√≠nh l·ªô tr√¨nh. Th·ª≠ l·∫°i.';
    priceValue.textContent = '‚Äî';
    mailBtn.href = `mailto:netvuan@gmail.com`;
    zaloBtn.style.display = 'none';
    mailBtn.style.display = 'none';
    instructionText.innerHTML = 'L·ªói t√≠nh to√°n.';
  }
});

async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.warn('Fallback: Copying directly from DOM');
        try {
            const range = document.createRange();
            range.selectNodeContents(modalText);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges(); 
            return true;
        } catch (errFallback) {
            console.error('Kh√¥ng th·ªÉ th·ª±c hi·ªán sao ch√©p:', errFallback);
            return false;
        }
    }
}

zaloBtn.addEventListener('click', () => {
    if (!finalZaloMessage) {
        alert('Vui l√≤ng b·∫•m "T√≠nh gi√°" tr∆∞·ªõc ƒë·ªÉ t·∫°o th√¥ng tin chuy·∫øn ƒëi.');
        return;
    }
    modalText.textContent = finalZaloMessage;
    zaloModal.style.display = 'flex'; 

    const range = document.createRange();
    range.selectNodeContents(modalText);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
});

copyModalBtn.addEventListener('click', async () => {
    const success = await copyToClipboard(finalZaloMessage);
    
    if (success) {
        alert('üìã ƒê√£ sao ch√©p th√¥ng tin chuy·∫øn xe v√†o b·ªô nh·ªõ t·∫°m! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ M·ªü Zalo Chat v√† D√°n (Paste) ƒë·ªÉ g·ª≠i.');
        window.getSelection().removeAllRanges();
        
    } else {
        alert('‚ö†Ô∏è Sao ch√©p t·ª± ƒë·ªông th·∫•t b·∫°i. Vui l√≤ng b·∫•m gi·ªØ (ho·∫∑c Ctrl+C) ƒë·ªÉ sao ch√©p vƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c b√¥i ƒëen v√† g·ª≠i qua Zalo.');
    }
});

zaloModalBtn.addEventListener('click', () => {
    window.getSelection().removeAllRanges(); 
    zaloModal.style.display = 'none'; 
    window.open(ZALO_URL, '_blank');
});

closeModalBtn.addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    zaloModal.style.display = 'none';
});

zaloModal.addEventListener('click', (e) => {
    if (e.target === zaloModal) {
        window.getSelection().removeAllRanges();
        zaloModal.style.display = 'none';
    }
});

/* ------------------------------------------------------------------
   KH·ªûI T·∫†O V√Ä POLLING (T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI)
   ------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', async ()=>{
    getGeolocation();
    
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    // T·ª± ƒë·ªông ki·ªÉm tra file JSON n·ªôi b·ªô m·ªói 15 gi√¢y
    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
            console.log(`[Kill Switch] Tr·∫°ng th√°i ƒë√£ thay ƒë·ªïi v√† ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông! Active: ${newStatus.active}`);
        } else {
            console.log(`[Kill Switch] Tr·∫°ng th√°i kh√¥ng ƒë·ªïi (${newStatus.active}). Ti·∫øp t·ª•c polling...`);
        }
    }, 15000); 
    
    reloadLocationBtn.addEventListener('click', getGeolocation); 
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then((reg) => {
        console.log('Service worker registered.', reg);
      })
      .catch((err) => {
        console.log('Service worker registration failed: ', err);
      });
  });
}
</script>
</body>
</html>
