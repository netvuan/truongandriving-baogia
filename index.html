<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dịch Vụ Taxi Trường An Driving | Tính Giá Cước & Đặt Xe</title>
    <meta name="description" content="Tính giá cước taxi hai chiều, một chiều chính xác, nhanh chóng. Đặt xe 4 chỗ, 7 chỗ đi tỉnh với Trường An Driving.">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIINfQ7oWA8x9ppvLG3E8wM6CWTNkmr4SSg=" crossorigin=""/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        /* CSS GIAO DIỆN CHÍNH */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            padding-bottom: 70px; 
        }
        .container {
            max-width: 600px;
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px 0;
            margin: -15px -15px 15px -15px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            text-align: center;
        }
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .form-label {
            font-weight: bold;
            color: #333;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .input-group-text {
            background-color: #e9ecef;
            min-width: 100px;
            justify-content: center;
        }
        #result-box {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        #price-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d9534f; 
        }
        .btn-calculate {
            background-color: #007bff;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .btn-zalo, .btn-mail {
            font-size: 1rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .btn-zalo { background-color: #008cff; border-color: #008cff; color: white; }
        .btn-mail { background-color: #dc3545; border-color: #dc3545; color: white; }
        
        /* CSS MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
        }
        #modal-text {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            user-select: text;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        #offline-alert {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>🚕 Dịch Vụ Taxi</h1>
        <p>Trường An Driving</p>
        <p style="font-size: 1rem; margin-bottom: 0;">☎️ 0847526893</p>
    </div>

    <div id="offline-alert" class="alert alert-danger" role="alert">
        Thiết bị đang OFFLINE hoặc LỖI KẾT NỐI. Không thể xác nhận đơn hàng.
    </div>

    <div class="mb-3 d-flex justify-content-end">
        <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="vi">🇻🇳 Tiếng Việt</option>
            <option value="en">🇺🇸 English</option>
            <option value="ja">🇯🇵 日本語</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="customer-phone" class="form-label" id="label-phone">📞 Số điện thoại của bạn</label>
        <div class="input-group">
            <input type="tel" class="form-control" id="customer-phone" placeholder="Nhập SĐT (10 số, VD: 0987654321)">
        </div>
    </div>
    
    <div class="mb-3">
        <label for="pickup-address" class="form-label" id="label-pickup">📍 Điểm đón</label>
        <div class="input-group">
            <span class="input-group-text location-status" id="status-location">Tự động tìm vị trí</span>
            <input type="text" class="form-control address-input" id="pickup-address" placeholder="Nhập địa chỉ điểm đón">
            <button class="btn btn-outline-secondary" type="button" id="reload-location-btn" title="Tải lại vị trí">🔄</button>
            <button class="btn btn-outline-secondary" type="button" onclick="window.open('https://maps.google.com/', '_blank');" id="btn-map-pickup">Bản đồ</button>
        </div>
    </div>

    <div class="mb-3">
        <label for="pickup-date-time" class="form-label" id="label-datetime">🕒 Ngày & Giờ đón</label>
        <input type="datetime-local" class="form-control" id="pickup-date-time">
    </div>

    <div id="stops-container">
        </div>
    <button class="btn btn-success btn-sm mb-3" id="add-stop-btn">+ Thêm điểm dừng</button>

    <div class="mb-3">
        <label for="dropoff-address" class="form-label" id="label-dropoff">🏁 Điểm đến</label>
        <div class="input-group">
            <input type="text" class="form-control address-input" id="dropoff-address" placeholder="Nhập địa chỉ điểm đến cuối">
            <button class="btn btn-outline-secondary" type="button" onclick="window.open('https://maps.google.com/', '_blank');" id="btn-map-dropoff">Bản đồ</button>
        </div>
    </div>
    
    <div class="mb-3">
        <label for="car-type" class="form-label" id="label-cartype">🚗 Loại xe</label>
        <select class="form-select" id="car-type">
            <option value="Xe 4 chỗ (10.000đ/km)" data-lang-vi="Xe 4 chỗ (10.000đ/km)" data-lang-en="4-seater car (10,000VND/km)" data-lang-ja="4人乗り車 (10,000ドン/km)">Xe 4 chỗ (10.000đ/km)</option>
            <option value="Xe 7 chỗ (12.000đ/km)" data-lang-vi="Xe 7 chỗ (12.000đ/km)" data-lang-en="7-seater car (12,000VND/km)" data-lang-ja="7人乗り車 (12,000ドン/km)">Xe 7 chỗ (12.000đ/km)</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="trip-type" class="form-label" id="label-triptype">🚖 Loại chuyến đi</label>
        <select class="form-select" id="trip-type">
            <option value="1" data-lang-vi="1 chiều" data-lang-en="One way" data-lang-ja="片道">1 chiều</option>
            <option value="2" data-lang-vi="2 chiều (Có giảm giá chiều về)" data-lang-en="Round trip (Return discount applies)" data-lang-ja="往復 (復路割引適用)">2 chiều (Có giảm giá chiều về)</option>
        </select>
    </div>

    <div class="mb-3" id="waiting-group">
        <label for="waiting-time" class="form-label" id="label-waiting">⏳ Thời gian chờ (chỉ áp dụng 2 chiều, miễn phí 0-3 giờ)</label>
        <div class="input-group">
            <input type="number" class="form-control" id="waiting-time" value="0" min="0" step="0.5">
            <span class="input-group-text" id="unit-hours">giờ</span>
        </div>
    </div>

    <div class="mb-3">
        <label for="driver-request" class="form-label" id="label-driver-request">🧑‍✈️ Yêu cầu tài xế (Lái xe hộ/Xe khách/Xe công ty)</label>
        <select class="form-select" id="driver-request">
            <option value="Không yêu cầu đặc biệt" data-lang-vi="Không yêu cầu đặc biệt" data-lang-en="No special request" data-lang-ja="特別なリクエストなし">Không yêu cầu đặc biệt</option>
            <option value="Lái xe hộ" data-lang-vi="Lái xe hộ" data-lang-en="Designated driver (Drive my car)" data-lang-ja="運転代行">Lái xe hộ</option>
            <option value="Lái xe khách" data-lang-vi="Lái xe khách" data-lang-en="Coach driver" data-lang-ja="観光バス運転手">Lái xe khách</option>
            <option value="Lái xe công ty" data-lang-vi="Lái xe công ty" data-lang-en="Company driver" data-lang-ja="社用車運転手">Lái xe công ty</option>
            <option value="Tài xế mặc định (Trường An)" data-lang-vi="Tài xế mặc định (Trường An)" data-lang-en="Default driver (Truong An)" data-lang-ja="専属運転手 (チュオンアン)">Tài xế mặc định (Trường An)</option>
        </select>
    </div>

    <button class="btn btn-calculate w-100 mb-3" id="calculate-btn">Tính giá & Lộ trình</button>

    <div id="map"></div>

    <div id="result-box">
        <h4 class="text-primary" id="result-title">KẾT QUẢ DỰ KIẾN</h4>
        <div class="mb-2">
            <p id="distance-text" class="mb-1">Quãng đường: —</p>
            <p id="time-estimate" class="mb-1">Thời gian di chuyển (ước tính): — phút</p>
            <p id="pickup-info" class="mb-1">Ngày giờ đón: —</p>
            <p class="mb-0" id="label-total-price">Tổng giá dự kiến:</p>
            <span id="price-value">—</span>
        </div>
        <hr>
        <div id="price-breakdown" style="font-size: 0.9em;">
            </div>
        <hr>
        <p id="instruction-text" class="text-success fw-bold">Vui lòng nhấn nút "Tính giá & lộ trình" để xem chi tiết.</p>
        <button class="btn btn-zalo w-100" id="zalo-btn" style="display: none;"><img src="https://upload.wikimedia.org/wikipedia/commons/9/90/Zalo_logo.svg" alt="Zalo" width="20"> <span id="btn-zalo-text">Đặt qua Zalo</span></button>
        <button class="btn btn-mail w-100 mt-2" id="mail-btn" style="display: none;">✉️ <span id="btn-mail-text">Đặt qua Email</span></button>
    </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20n6a323G3A4f+hT7D4n+y9A9VfG3f/v/G4Q0n9+JvE=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<div id="phone-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="phone-modal-title">Xác nhận Số điện thoại</h4>
            <button class="close-btn" id="close-phone-modal">×</button>
        </div>
        <p id="phone-modal-instruction">Để hoàn tất việc đặt xe, vui lòng nhập số điện thoại của bạn:</p>
        <input type="tel" class="form-control" id="input-phone-for-booking" placeholder="Số điện thoại 10 số">
        <div class="modal-buttons">
            <button class="btn btn-primary w-100" id="confirm-phone-btn">Xác nhận</button>
        </div>
    </div>
</div>

<div id="deposit-modal" class="modal">
    <div class="modal-content text-center">
        <div class="modal-header d-block">
            <h4 class="text-warning" id="deposit-modal-title">⚠️ LƯU Ý ĐẶT CỌC</h4>
        </div>
        <p id="deposit-modal-p1">Với chuyến **Hai chiều** đi tỉnh, quý khách vui lòng đặt cọc **20%** tổng giá trị chuyến đi.</p>
        <p class="fw-bold" id="deposit-modal-p2">Số tiền đặt cọc dự kiến: <span id="deposit-amount" class="text-danger">0 đ</span></p>
        <p style="font-size: 0.8em; color: #6c757d;" id="deposit-modal-note">(Số tiền này sẽ được trừ vào tổng cước khi kết thúc chuyến đi.)</p>
        <div class="modal-buttons">
            <button class="btn btn-success w-100" id="confirm-deposit-btn">Đã hiểu</button>
        </div>
    </div>
</div>

<div id="zalo-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4 id="zalo-modal-title">✅ THÔNG TIN ĐẶT XE</h4>
            <button class="close-btn" id="close-modal-btn">×</button>
        </div>
        <p id="zalo-modal-instruction">Sao chép thông tin và gửi qua Zalo:</p>
        <div id="modal-text" class="modal-body">
            </div>
        <div class="modal-buttons">
            <button class="btn btn-warning" id="copy-modal-btn">📋 Sao Chép Thông Tin</button>
            <button class="btn btn-primary" id="zalo-modal-btn">💬 Mở Zalo Chat</button>
        </div>
        <div class="d-grid mt-2">
            <button class="btn btn-secondary" id="close-modal-btn-bottom">Đóng</button>
        </div>
    </div>
</div>


<script>
// Biến toàn cục
const OSRM = 'https://router.project-osrm.org/route/v1/driving';
const ZALO_URL = 'https://zalo.me/0847526893'; // SĐT Trường An
const STATUS_FILE = './status-local.json'; // File kiểm tra trạng thái dịch vụ (Cần tạo file này)

let map;
let markerPickup, markerDropoff;
let routeLayer;
let finalZaloMessage = '';
let finalTotalFee = 0;
let bookingAction = null; 
let currentLang = 'vi'; 
let isServiceActive = true; 

// Dữ liệu dịch thuật
const TRANSLATIONS = {
    'vi': {
        // CÁC NHÃN CHUNG VÀ TÙY CHỌN
        trip_type_1: '1 chiều',
        trip_type_2: '2 chiều (giảm 40% chiều về)',
        trip_type_2_no_discount: '2 chiều (Không giảm giá)',
        car_4_seater: 'Xe 4 chỗ',
        car_7_seater: 'Xe 7 chỗ',
        hours: 'giờ',
        distance_unit: 'km',
        not_selected: '(Chưa chọn)',
        one_way_trip: 'một chiều',
        
        // NHÃN TRONG FORM (Dùng để cập nhật UI)
        label_phone: '📞 Số điện thoại của bạn',
        status_location: 'Tự động tìm vị trí',
        label_pickup: '📍 Điểm đón',
        label_datetime: '🕒 Ngày & Giờ đón',
        add_stop_btn: '+ Thêm điểm dừng',
        label_dropoff: '🏁 Điểm đến',
        label_cartype: '🚗 Loại xe',
        label_triptype: '🚖 Loại chuyến đi',
        label_waiting: '⏳ Thời gian chờ (chỉ áp dụng 2 chiều, miễn phí 0-3 giờ)',
        unit_hours: 'giờ',
        label_driver_request: '🧑‍✈️ Yêu cầu tài xế (Lái xe hộ/Xe khách/Xe công ty)',
        calculate_btn: 'Tính giá & Lộ trình',
        btn_zalo_text: 'Đặt qua Zalo',
        btn_mail_text: 'Đặt qua Email',
        result_title: 'KẾT QUẢ DỰ KIẾN',
        label_total_price: 'Tổng giá dự kiến:',
        
        // KẾT QUẢ HIỂN THỊ
        result_distance: 'Quãng đường: —',
        result_time_est: 'Thời gian di chuyển (ước tính): — phút',
        result_pickup_info: 'Ngày giờ đón: —',
        price_go: 'Giá chiều đi',
        total_price: 'Tổng cộng',
        wait_fee: 'Phí chờ phát sinh',
        wait_time: 'Thời gian chờ',
        wait_free_label: 'Miễn phí',
        wait_free: 'miễn phí 0–3h',
        
        // ALERT VÀ THÔNG BÁO
        calculating_route: 'Đang tính lộ trình...',
        route_error: 'Lỗi tính toán lộ trình.',
        instruction_text_loading: 'Đang xử lý...',
        instruction_text_active: 'Vui lòng kiểm tra lại thông tin và nhấn nút Đặt xe.',
        alert_no_coord: 'Không tìm thấy tọa độ/địa chỉ cho {0}. Vui lòng nhập địa chỉ cụ thể hơn.',
        alert_no_address: 'Vui lòng nhập địa chỉ Điểm đón và Điểm đến.',
        alert_no_date: 'Vui lòng chọn Ngày & Giờ đón.',
        alert_no_price: 'Vui lòng nhấn nút "Tính giá & lộ trình" trước khi Đặt xe.',
        alert_invalid_phone: 'Số điện thoại không hợp lệ (10 số, bắt đầu bằng 0, VD: 0987654321).',
        alert_copied: 'Đã sao chép thông tin đặt xe thành công!',
        alert_copy_fail: 'Không thể sao chép tự động. Vui lòng chọn và sao chép thủ công.',
        alert_mail_sent: 'Thông tin sẽ được gửi qua Email mặc định của bạn.',
        alert_service_off: 'Xin lỗi, dịch vụ tạm thời không hoạt động. Vui lòng liên hệ trực tiếp qua số điện thoại trên.',
        
        // TIN NHẮN ZALO/MAIL
        zalo_order_title: 'YÊU CẦU ĐẶT XE TRƯỜNG AN DRIVING',
        zalo_phone_label: 'SĐT Khách hàng',
        zalo_trip_type: 'Loại chuyến',
        zalo_car_type: 'Loại xe',
        zalo_driver_request: 'Yêu cầu tài xế',
        zalo_pickup_point: 'Điểm đón',
        zalo_dropoff_point: 'Điểm đến',
        zalo_pickup_time: 'Ngày giờ đón',
        zalo_total_price: 'Tổng giá dự kiến',
        zalo_stop_label: 'Điểm dừng',
        zalo_waiting: 'Thời gian chờ',
        zalo_wait_fee: 'Phí chờ phát sinh',
        zalo_note: 'Vui lòng xác nhận đơn hàng.',
        zalo_deposit: 'ĐẶT CỌC',
        zalo_total_fee: 'Tổng phí',
        maps_link_title: 'LIÊN KẾT BẢN ĐỒ CHÍNH XÁC',
        maps_link_pickup: 'Vị trí đón khách (Tọa độ)',
        maps_link_dir: 'Chỉ đường (Đón -> Trả)',

        // MODAL
        phone_modal_title: 'Xác nhận Số điện thoại',
        phone_modal_instruction: 'Để hoàn tất việc đặt xe, vui lòng nhập số điện thoại của bạn:',
        deposit_modal_title: '⚠️ LƯU Ý ĐẶT CỌC',
        deposit_modal_p1: 'Với chuyến **Hai chiều** đi tỉnh, quý khách vui lòng đặt cọc **20%** tổng giá trị chuyến đi.',
        deposit_modal_p2: 'Số tiền đặt cọc dự kiến:',
        deposit_modal_note: '(Số tiền này sẽ được trừ vào tổng cước khi kết thúc chuyến đi.)',
        zalo_modal_title: '✅ THÔNG TIN ĐẶT XE',
        zalo_modal_instruction: 'Sao chép thông tin và gửi qua Zalo:',
        stop_label: 'Điểm dừng',
    },
    'en': {
        // CÁC NHÃN CHUNG VÀ TÙY CHỌN
        trip_type_1: 'One way',
        trip_type_2: 'Round trip (40% discount on return)',
        trip_type_2_no_discount: 'Round trip (No discount)',
        car_4_seater: '4-seater car',
        car_7_seater: '7-seater car',
        hours: 'hours',
        distance_unit: 'km',
        not_selected: '(Not selected)',
        one_way_trip: 'one way',
        
        // NHÃN TRONG FORM (Dùng để cập nhật UI)
        label_phone: '📞 Your Phone Number',
        status_location: 'Auto-detecting location',
        label_pickup: '📍 Pickup Location',
        label_datetime: '🕒 Pickup Date & Time',
        add_stop_btn: '+ Add Stop',
        label_dropoff: '🏁 Dropoff Location',
        label_cartype: '🚗 Car Type',
        label_triptype: '🚖 Trip Type',
        label_waiting: '⏳ Waiting Time (Round trip only, first 3 hours free)',
        unit_hours: 'hours',
        label_driver_request: '🧑‍✈️ Driver Request (Designated/Coach/Company Driver)',
        calculate_btn: 'Calculate Price & Route',
        btn_zalo_text: 'Book via Zalo',
        btn_mail_text: 'Book via Email',
        result_title: 'ESTIMATED RESULT',
        label_total_price: 'Estimated Total Price:',
        
        // KẾT QUẢ HIỂN THỊ
        result_distance: 'Distance: —',
        result_time_est: 'Travel Time (Estimate): — minutes',
        result_pickup_info: 'Pickup Date & Time: —',
        price_go: 'Outbound Price',
        total_price: 'Total',
        wait_fee: 'Waiting Fee',
        wait_time: 'Waiting Time',
        wait_free_label: 'Free',
        wait_free: 'free 0–3h',
        
        // ALERT VÀ THÔNG BÁO
        calculating_route: 'Calculating route...',
        route_error: 'Route calculation error.',
        instruction_text_loading: 'Processing...',
        instruction_text_active: 'Please check the information and press the Book button.',
        alert_no_coord: 'Could not find coordinates/address for {0}. Please enter a more specific address.',
        alert_no_address: 'Please enter both Pickup and Dropoff addresses.',
        alert_no_date: 'Please select Pickup Date & Time.',
        alert_no_price: 'Please press "Calculate Price & Route" before booking.',
        alert_invalid_phone: 'Invalid phone number (10 digits, starting with 0, e.g., 0987654321).',
        alert_copied: 'Booking information copied successfully!',
        alert_copy_fail: 'Automatic copy failed. Please select and copy manually.',
        alert_mail_sent: 'Information will be sent via your default email client.',
        alert_service_off: 'Sorry, the service is temporarily inactive. Please contact us directly via the phone number above.',
        
        // TIN NHẮN ZALO/MAIL
        zalo_order_title: 'TRUONG AN DRIVING BOOKING REQUEST',
        zalo_phone_label: 'Customer Phone',
        zalo_trip_type: 'Trip Type',
        zalo_car_type: 'Car Type',
        zalo_driver_request: 'Driver Request',
        zalo_pickup_point: 'Pickup Point',
        zalo_dropoff_point: 'Dropoff Point',
        zalo_pickup_time: 'Pickup Date/Time',
        zalo_total_price: 'Estimated Total Price',
        zalo_stop_label: 'Stop Point',
        zalo_waiting: 'Waiting Time',
        zalo_wait_fee: 'Extra Waiting Fee',
        zalo_note: 'Please confirm the order.',
        zalo_deposit: 'DEPOSIT',
        zalo_total_fee: 'Total Fee',
        maps_link_title: 'ACCURATE MAP LINKS',
        maps_link_pickup: 'Pickup Location (Coordinates)',
        maps_link_dir: 'Directions (Pickup -> Dropoff)',

        // MODAL
        phone_modal_title: 'Confirm Phone Number',
        phone_modal_instruction: 'To complete the booking, please enter your phone number:',
        deposit_modal_title: '⚠️ DEPOSIT NOTE',
        deposit_modal_p1: 'For **Round trip** inter-provincial travel, please pay a **20%** deposit of the total fee.',
        deposit_modal_p2: 'Estimated deposit amount:',
        deposit_modal_note: '(This amount will be deducted from the total fare upon trip completion.)',
        zalo_modal_title: '✅ BOOKING INFORMATION',
        zalo_modal_instruction: 'Copy the information and send via Zalo:',
        stop_label: 'Stop',
    },
    'ja': {
        // CÁC NHÃN CHUNG VÀ TÙY CHỌN
        trip_type_1: '片道',
        trip_type_2: '往復 (復路40%割引)',
        trip_type_2_no_discount: '往復 (割引なし)',
        car_4_seater: '4人乗り車',
        car_7_seater: '7人乗り車',
        hours: '時間',
        distance_unit: 'km',
        not_selected: '(未選択)',
        one_way_trip: '片道',
        
        // NHÃN TRONG FORM (Dùng để cập nhật UI)
        label_phone: '📞 電話番号',
        status_location: '現在地を自動検出中',
        label_pickup: '📍 迎えの場所',
        label_datetime: '🕒 迎えの日時',
        add_stop_btn: '+ 経由地を追加',
        label_dropoff: '🏁 目的地の場所',
        label_cartype: '🚗 車種',
        label_triptype: '🚖 走行タイプ',
        label_waiting: '⏳ 待機時間 (往復のみ、最初の3時間は無料)',
        unit_hours: '時間',
        label_driver_request: '🧑‍✈️ ドライバーへのリクエスト (代行/観光/社用車)',
        calculate_btn: '料金とルートを計算',
        btn_zalo_text: 'Zaloで予約',
        btn_mail_text: 'Emailで予約',
        result_title: '見積もり結果',
        label_total_price: '見積もり合計料金:',
        
        // KẾT QUẢ HIỂN THỊ
        result_distance: '走行距離: —',
        result_time_est: '移動時間 (目安): — 分',
        result_pickup_info: '迎えの日時: —',
        price_go: '往路料金',
        total_price: '合計',
        wait_fee: '待機料金',
        wait_time: '待機時間',
        wait_free_label: '無料',
        wait_free: '0〜3時間無料',
        
        // ALERT VÀ THÔNG BÁO
        calculating_route: 'ルートを計算中...',
        route_error: 'ルート計算エラー。',
        instruction_text_loading: '処理中...',
        instruction_text_active: '情報を確認し、予約ボタンを押してください。',
        alert_no_coord: '{0}の座標/住所が見つかりませんでした。より具体的な住所を入力してください。',
        alert_no_address: '迎えと目的地の両方の住所を入力してください。',
        alert_no_date: '迎えの日時を選択してください。',
        alert_no_price: '予約する前に「料金とルートを計算」ボタンを押してください。',
        alert_invalid_phone: '無効な電話番号です (0から始まる10桁、例: 0987654321)。',
        alert_copied: '予約情報が正常にコピーされました！',
        alert_copy_fail: '自動コピーに失敗しました。手動で選択してコピーしてください。',
        alert_mail_sent: '情報はデフォルトのメールクライアント経由で送信されます。',
        alert_service_off: '申し訳ありませんが、現在サービスは一時的に非アクティブです。上記の電話番号に直接ご連絡ください。',
        
        // TIN NHẮN ZALO/MAIL
        zalo_order_title: 'チュオンアン ドライビング 予約リクエスト',
        zalo_phone_label: 'お客様電話番号',
        zalo_trip_type: '走行タイプ',
        zalo_car_type: '車種',
        zalo_driver_request: 'ドライバーへのリクエスト',
        zalo_pickup_point: '迎えの場所',
        zalo_dropoff_point: '目的地の場所',
        zalo_pickup_time: '迎えの日時',
        zalo_total_price: '見積もり合計料金',
        zalo_stop_label: '経由地',
        zalo_waiting: '待機時間',
        zalo_wait_fee: '追加待機料金',
        zalo_note: 'ご注文をご確認ください。',
        zalo_deposit: 'デポジット',
        zalo_total_fee: '合計料金',
        maps_link_title: '正確な地図リンク',
        maps_link_pickup: '迎えの場所 (座標)',
        maps_link_dir: '道順 (迎え -> 目的地)',

        // MODAL
        phone_modal_title: '電話番号の確認',
        phone_modal_instruction: '予約を完了するために、電話番号を入力してください:',
        deposit_modal_title: '⚠️ デポジットに関する注意',
        deposit_modal_p1: '州をまたぐ**往復**の移動の場合、合計料金の**20%**のデポジットをお支払いください。',
        deposit_modal_p2: 'デポジットの見積もり額:',
        deposit_modal_note: '(この金額は、旅行完了時の合計運賃から差し引かれます。)',
        zalo_modal_title: '✅ 予約情報',
        zalo_modal_instruction: '情報をコピーしてZalo経由で送信してください:',
        stop_label: '経由地',
    },
};


// Chọn các phần tử DOM
const DOM_ELEMENTS = [
    'lang-switcher', 'pickup-address', 'dropoff-address', 'pickup-date-time', 'stops-container', 
    'add-stop-btn', 'car-type', 'trip-type', 'waiting-time', 'driver-request', 'calculate-btn', 
    'result-box', 'distance-text', 'price-value', 'price-breakdown', 'time-estimate', 'pickup-info', 
    'zalo-btn', 'mail-btn', 'instruction-text', 'map', 'offline-alert', 'reload-location-btn', 
    'customer-phone', 'phone-modal', 'input-phone-for-booking', 'confirm-phone-btn', 'close-phone-modal',
    'zalo-modal', 'modal-text', 'copy-modal-btn', 'zalo-modal-btn', 'close-modal-btn', 'deposit-modal', 
    'deposit-amount', 'confirm-deposit-btn', 'close-modal-btn-bottom'
];

const elements = {};
DOM_ELEMENTS.forEach(id => { elements[id] = document.getElementById(id); });

// Các phần tử cần dịch thuật trực tiếp trên UI
const TRANSLATE_UI_IDS = [
    'label-phone', 'status-location', 'label-pickup', 'label-datetime', 'label-dropoff', 
    'label-cartype', 'label-triptype', 'label-waiting', 'unit-hours', 'label-driver-request',
    'calculate-btn', 'btn-zalo-text', 'btn-mail-text', 'result-title', 'label-total-price',
    'phone-modal-title', 'phone-modal-instruction', 'deposit-modal-title', 'deposit-modal-p1',
    'deposit-modal-p2', 'deposit-modal-note', 'zalo-modal-title', 'zalo-modal-instruction'
];

let map, markerPickup, markerDropoff, routeLayer;
let finalZaloMessage = '', finalTotalFee = 0, bookingAction = null, currentLang = 'vi', isServiceActive = true; 
let stopCounter = 0; // Để đếm điểm dừng

/* -------------------- PHẦN LOGIC CHUNG VÀ HELPER -------------------- */

// Khởi tạo bản đồ
function initMap() {
    if (map) return;
    const defaultCoords = [10.8231, 106.6297]; // TP. HCM
    map = L.map('map').setView(defaultCoords, 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
}
initMap();


// Hàm cập nhật tất cả UI khi đổi ngôn ngữ
function updateUI(lang) {
    const t = TRANSLATIONS[lang] || TRANSLATIONS['vi'];

    // 1. Cập nhật các nhãn tĩnh (dùng ID)
    TRANSLATE_UI_IDS.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = t[id] || t[id.replace(/-/g, '_')] || el.textContent;
    });

    // 2. Cập nhật các Options trong Select
    const selectElements = [elements['car-type'], elements['trip-type'], elements['driver-request']];
    selectElements.forEach(select => {
        if (select) {
            Array.from(select.options).forEach(option => {
                const langKey = 'data-lang-' + lang;
                if (option.hasAttribute(langKey)) {
                    option.textContent = option.getAttribute(langKey);
                }
            });
        }
    });

    // 3. Cập nhật placeholder và label điểm dừng (nếu có)
    const stopInputs = Array.from(elements['stops-container'].querySelectorAll('input[id^="stop-"]'));
    stopInputs.forEach((input, index) => {
        const label = input.closest('.input-group').querySelector('.input-group-text');
        if (label) label.textContent = `${t.stop_label} ${index + 1}`;
        input.placeholder = `${t.stop_label} ${index + 1}`;
    });

    // 4. Cập nhật nút Thêm điểm dừng
    elements['add-stop-btn'].textContent = t.add_stop_btn || '+ Thêm điểm dừng';
    
    // 5. Cập nhật trạng thái Kill Switch nếu đang lỗi
    if (!isServiceActive) {
         elements['offline-alert'].textContent = t.alert_service_off;
    }
}

// Hàm đổi ngôn ngữ
function initLanguageSwitcher() {
    elements['lang-switcher'].addEventListener('change', (e) => {
        currentLang = e.target.value;
        updateUI(currentLang);
        // Kích hoạt lại việc tính toán để cập nhật ngôn ngữ tin nhắn Zalo nếu kết quả đã có
        if (finalTotalFee > 0) {
            calculateAndGenerateMessage();
        }
    });
    // Khởi tạo ngôn ngữ ban đầu
    updateUI(currentLang);
}

// Cập nhật trạng thái dịch vụ (Kill Switch)
async function checkServiceStatus() {
    try {
        const response = await fetch(STATUS_FILE + '?t=' + new Date().getTime()); 
        if (!response.ok) {
            throw new Error('Lỗi truy cập file trạng thái.');
        }
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Lỗi Kill Switch:', error);
        return { active: true }; 
    }
}

async function updateUIBasedOnStatus(status) {
    isServiceActive = status.active;
    const t = TRANSLATIONS[currentLang];

    if (!isServiceActive) {
        elements['offline-alert'].textContent = t.alert_service_off;
        elements['offline-alert'].style.display = 'block';
        elements['calculate-btn'].disabled = true;
        elements['zalo-btn'].style.display = 'none';
        elements['mail-btn'].style.display = 'none';
    } else {
        elements['offline-alert'].style.display = 'none';
        elements['calculate-btn'].disabled = false;
    }
}

// Thêm/Xóa điểm dừng
elements['add-stop-btn'].addEventListener('click', () => {
    stopCounter++;
    const t = TRANSLATIONS[currentLang];
    const newStopDiv = document.createElement('div');
    newStopDiv.classList.add('input-group', 'mb-3');
    newStopDiv.innerHTML = `
        <label class="input-group-text">${t.stop_label} ${stopCounter}</label>
        <input type="text" class="form-control address-input stop-input" id="stop-${stopCounter}" placeholder="${t.stop_label} ${stopCounter}">
        <button class="btn btn-danger remove-stop-btn" type="button" onclick="removeStop(this)">Xóa</button>
    `;
    elements['stops-container'].appendChild(newStopDiv);
});

function removeStop(button) {
    const stopDiv = button.closest('.input-group');
    elements['stops-container'].removeChild(stopDiv);
}


// Xử lý tọa độ và bản đồ
async function resolveCoordForInput(inputElement) {
    const address = inputElement.value.trim();
    if (!address) return null;

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
        const data = await response.json();

        if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            return [lat, lon];
        }
        return null;
    } catch (error) {
        console.error('Geocoding error:', error);
        return null;
    }
}

function updateMapMarker(lat, lon, address, isPickup = true) {
    if (!map) initMap();
    const markerText = isPickup ? `Đón: ${address}` : `Đến: ${address}`;

    const dropoffIcon = L.icon({ 
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', 
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', 
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] 
    });

    if (isPickup) {
        if (markerPickup) map.removeLayer(markerPickup);
        markerPickup = L.marker([lat, lon]).addTo(map).bindPopup(markerText).openPopup();
    } else {
        if (markerDropoff) map.removeLayer(markerDropoff);
        markerDropoff = L.marker([lat, lon], { icon: dropoffIcon }).addTo(map).bindPopup(markerText).openPopup();
    }

    const markers = [];
    if (markerPickup) markers.push(markerPickup.getLatLng());
    if (markerDropoff) markers.push(markerDropoff.getLatLng());

    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
    } else {
        map.setView([lat, lon], 13);
    }
}

elements['pickup-address'].addEventListener('blur', async () => {
    const coord = await resolveCoordForInput(elements['pickup-address']);
    if (coord) updateMapMarker(coord[0], coord[1], elements['pickup-address'].value, true);
});

elements['dropoff-address'].addEventListener('blur', async () => {
    const coord = await resolveCoordForInput(elements['dropoff-address']);
    if (coord) updateMapMarker(coord[0], coord[1], elements['dropoff-address'].value, false);
});


// Lấy vị trí hiện tại của khách hàng
function getGeolocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                const address = data.display_name || `${lat}, ${lon}`;
                elements['pickup-address'].value = address;
                
                updateMapMarker(lat, lon, address, true);
                
                document.querySelector('.location-status').innerHTML = `✅ ${TRANSLATIONS[currentLang].status_location.split(' ')[0]} <a href="#" onclick="event.preventDefault(); getGeolocation();" class="ms-1" style="font-size: 0.9em;">[Tải lại]</a>`;

            } catch (error) {
                elements['pickup-address'].value = `${lat}, ${lon}`;
                document.querySelector('.location-status').textContent = '⚠️ Lỗi tìm địa chỉ. Dùng tọa độ.';
                console.error('Reverse Geocoding Error:', error);
            }

        }, (error) => {
            console.error('Geolocation error:', error);
            document.querySelector('.location-status').textContent = '❌ Lỗi hoặc bị từ chối.';
        });
    } else {
        document.querySelector('.location-status').textContent = '❌ Trình duyệt không hỗ trợ.';
    }
}


// Validation
function validateRouteInputs() {
    const t = TRANSLATIONS[currentLang];
    if (elements['pickup-address'].value.trim() === '' || elements['dropoff-address'].value.trim() === '') {
        alert(t.alert_no_address);
        return false;
    }
    if (elements['pickup-date-time'].value === '') {
        alert(t.alert_no_date);
        return false;
    }
    return true;
}

function validatePhone(phone) {
    return /^0\d{9}$/.test(phone); 
}


// Thiết lập thời gian đón tối thiểu (hiện tại + 15 phút)
function formatDateTime(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart('2', '0');
    const d = String(date.getDate()).padStart('2', '0');
    const h = String(date.getHours()).padStart('2', '0');
    const min = String(date.getMinutes()).padStart('2', '0');
    return `${y}-${m}-${d}T${h}:${min}`;
}

function setMinPickupDateTime() {
    const minDate = new Date();
    minDate.setMinutes(minDate.getMinutes() + 15);
    
    const minDateTimeString = formatDateTime(minDate);
    elements['pickup-date-time'].setAttribute('min', minDateTimeString);
    
    if (!elements['pickup-date-time'].value || new Date(elements['pickup-date-time'].value) < minDate) {
        elements['pickup-date-time'].value = minDateTimeString;
    }
}


/* -------------------- LOGIC CHÍNH: TÍNH TOÁN VÀ ĐẶT XE -------------------- */

async function calculateAndGenerateMessage() {
    const lang = currentLang;
    const t = TRANSLATIONS[lang];
    
    if (!validateRouteInputs()) return false; 
    
    // 1. Resolve tọa độ cho tất cả các điểm
    const pickupCoord = await resolveCoordForInput(elements['pickup-address']);
    if(!pickupCoord){ alert(t.alert_no_coord.replace('{0}', t.pickup_label)); return false; }
    const dropoffCoord = await resolveCoordForInput(elements['dropoff-address']);
    if(!dropoffCoord){ alert(t.alert_no_coord.replace('{0}', t.dropoff_label)); return false; }

    const coords = [pickupCoord];
    const stopInputs = Array.from(elements['stops-container'].querySelectorAll('input[id^="stop-"]'));
    for(const s of stopInputs){
        if(s.value.trim()){
            const sc = await resolveCoordForInput(s);
            if(!sc){ 
                const match = s.id.match(/\d+/);
                const stopLabel = t.stop_label + (match ? ` ${match[0]}` : '');
                alert(t.alert_no_coord.replace('{0}', stopLabel)); 
                return false; 
            }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord);

    const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
    const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

    // 2. Cập nhật UI Loading
    elements['result-box'].style.display = 'block';
    elements['distance-text'].textContent = t.result_distance.replace('—', t.calculating_route);
    elements['price-value'].textContent = '...';
    elements['price-breakdown'].innerHTML = '';
    elements['time-estimate'].textContent = t.result_time_est.replace('—', '...');
    finalZaloMessage = ''; finalTotalFee = 0;
    elements['zalo-btn'].style.display = 'none'; 
    elements['mail-btn'].style.display = 'none';
    elements['instruction-text'].innerHTML = t.instruction_text_loading; 

    try{
        // 3. Gọi OSRM API
        const r = await fetch(url);
        const data = await r.json();
        
        if(!data.routes || data.routes.length === 0){ 
            elements['distance-text'].textContent = t.result_distance.replace('—', t.route_error); 
            elements['price-value'].textContent = '—';
            elements['instruction-text'].innerHTML = t.alert_no_coord.replace('{0}', '');
            return false; 
        }
        
        const route = data.routes[0];
        const dist = route.distance / 1000; 
        const durationSec = route.duration;
        const minutes = Math.round(durationSec / 60);

        // 4. Vẽ lại bản đồ
        if(map) {
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
        }

        // 5. Tính toán giá cước
        const tripType = elements['trip-type'].value; 
        const carType = elements['car-type'].value; 
        const waiting = parseFloat(elements['waiting-time'].value) || 0; 
        
        let perKm;
        const carTypeKey = carType.includes('7 chỗ') ? 'car_7_seater' : 'car_4_seater';
        const carTypeText = t[carTypeKey];
        
        if (carType.includes('7 chỗ')) { perKm = 12000; } else { perKm = 10000; }
        const perKmReturnDiscount = Math.round(perKm * 0.6); 
        const priceGo = Math.round(dist * perKm);
        
        let priceReturn = 0;
        let returnNote = ''; 

        if(tripType === '2') {
            const finalPerKmReturn = dist >= 45 ? perKmReturnDiscount : perKm;
            priceReturn = Math.round(dist * finalPerKmReturn); 
            const tripTypeLabel = dist >= 45 ? t.trip_type_2 : t.trip_type_2_no_discount;
            returnNote = `${tripTypeLabel} (${finalPerKmReturn.toLocaleString(lang)}đ/${t.distance_unit})`;
        } else {
            returnNote = t.trip_type_1;
        }

        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total; 
        const depositAmountValue = Math.round(total * 0.2); 

        // 6. Cập nhật UI Kết quả
        elements['distance-text'].textContent = t.result_distance.replace('—', `${dist.toFixed(1)} ${t.distance_unit} (${t.one_way_trip})`);
        elements['price-value'].textContent = total.toLocaleString(lang) + ' đ';

        let breakdownHtml = '';
        breakdownHtml += `• ${t.price_go} (${perKm.toLocaleString(lang)}đ/${t.distance_unit}): <b>${priceGo.toLocaleString(lang)} đ</b><br>`;
        
        if(tripType === '2'){
            breakdownHtml += `• ${returnNote}: <b>${priceReturn.toLocaleString(lang)} đ</b><br>`;
        }

        if (tripType === '2' && waiting > 0) {
            const waitDetail = (waiting > 3)
                ? `${t.wait_fee} (${waiting} ${t.hours}, ${t.wait_free}): <b>${waitFee.toLocaleString(lang)} đ</b>`
                : `${t.wait_time} (${waiting} ${t.hours}): <b>${t.wait_free_label}</b>`;
            breakdownHtml += `• ${waitDetail}<br>`;
        }
        
        breakdownHtml += `<hr style="margin:6px 0">• <b>${t.total_price}: ${total.toLocaleString(lang)} đ</b>`;
        elements['price-breakdown'].innerHTML = breakdownHtml;

        elements['time-estimate'].textContent = t.result_time_est.replace('—', `${minutes}`);

        const dateVal = elements['pickup-date-time'].value;
        const formattedDate = dateVal ? new Date(dateVal).toLocaleString(lang, { 
            year: 'numeric', month: 'numeric', day: 'numeric', 
            hour: '2-digit', minute: '2-digit', 
            hour12: false 
        }) : t.not_selected;
        elements['pickup-info'].textContent = t.result_pickup_info.replace('—', formattedDate);
        
        // 7. Tạo tin nhắn Zalo/Mail
        
        const stopInputsValues = Array.from(elements['stops-container'].querySelectorAll('input[id^="stop-"]'))
            .map(s => s.value.trim()).filter(v => v);
        
        const stopDetails = stopInputsValues.map((v, i) => `🛣️ ${t.zalo_stop_label} ${i+1}: ${v}`).join('\n');
        
        let zaloWaitingDetail = '';
        if (tripType === '2') {
            if (waiting > 3) {
                zaloWaitingDetail = `⏳ ${t.zalo_waiting}: ${waiting} ${t.hours} (${t.zalo_wait_fee}: ${waitFee.toLocaleString(lang)} đ)`;
            } else {
                zaloWaitingDetail = `⏳ ${t.zalo_waiting}: ${waiting} ${t.hours} (${t.wait_free_label})`;
            }
        }
        
        const pickupAddress = elements['pickup-address'].value.trim();
        const dropoffAddress = elements['dropoff-address'].value.trim();
        const pickupLatLon = `${pickupCoord[0]},${pickupCoord[1]}`;
        const dropoffLatLon = `${dropoffCoord[0]},${dropoffCoord[1]}`;
        
        let mapsLinksSection = [
            `\n*** 🗺️ ${t.maps_link_title} ***`,
            `📍 ${t.maps_link_pickup}: https://www.google.com/maps/search/${pickupLatLon}`,
            `🛣️ ${t.maps_link_dir}: https://www.google.com/maps/dir/${pickupLatLon}/${dropoffLatLon}`,
            `\n`
        ].join('\n');
        
        let depositSection = '';
        if (tripType === '2') {
            depositSection = `\n💰 ${t.zalo_deposit}: ${depositAmountValue.toLocaleString(lang)} đ (20% ${t.zalo_total_fee})`;
        }
        
        finalZaloMessage = [
            `🚖 ${t.zalo_order_title}`,
            '-------------------------------',
            `📞 ${t.zalo_phone_label}: [CHƯA CÓ]`,
            `✅ ${t.zalo_trip_type}: ${tripType === '1' ? t.trip_type_1 : `${t.trip_type_2.split('(')[0].trim()} (${dist.toFixed(1)} ${t.one_way_trip})`}`,
            `🚘 ${t.zalo_car_type}: ${carTypeText}`, 
            `🧑‍✈️ ${t.zalo_driver_request}: ${elements['driver-request'].value}`,
            `📍 ${t.zalo_pickup_point}: ${pickupAddress}`,
            ...(stopInputsValues.length ? [stopDetails] : []),
            `🏁 ${t.zalo_dropoff_point}: ${dropoffAddress}`,
            `🕒 ${t.zalo_pickup_time}: ${formattedDate}`,
            ...(tripType === '2' ? [zaloWaitingDetail] : []), 
            `💵 ${t.zalo_total_price}: ${total.toLocaleString(lang)} đ`,
            depositSection,
            mapsLinksSection, 
            '-------------------------------',
            t.zalo_note,
        ].join('\n');

        // 8. Hiển thị nút đặt xe và cuộn đến kết quả
        elements['zalo-btn'].style.display = 'block'; 
        elements['mail-btn'].style.display = 'block'; 
        elements['instruction-text'].style.display = 'block';
        elements['instruction-text'].innerHTML = t.instruction_text_active;

        elements['result-box'].scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return true; 
    }catch(err){
        console.error('Route error', err);
        elements['distance-text'].textContent = t.alert_no_coord.replace('{0}', '...');
        elements['price-value'].textContent = '—';
        elements['mail-btn'].href = `mailto:netvuan@gmail.com`; 
        elements['zalo-btn'].style.display = 'none';
        elements['mail-btn'].style.display = 'none';
        elements['instruction-text'].innerHTML = t.alert_no_coord.replace('{0}', '');
        return false;
    }
}

// Xử lý nút Tính giá
elements['calculate-btn'].addEventListener('click', async () => {
  const t = TRANSLATIONS[currentLang];
  if (!isServiceActive) {
      alert(t.alert_service_off);
      return;
  }
  
  const success = await calculateAndGenerateMessage();

  if(success && elements['trip-type'].value === '2') {
    const deposit = Math.round(finalTotalFee * 0.2);
    elements['deposit-amount'].textContent = deposit.toLocaleString(currentLang) + ' đ';
    elements['deposit-modal'].style.display = 'flex';
  }
});

// Xử lý nút Đặt qua Zalo / Mail
function handleBookingClick(action) {
    const t = TRANSLATIONS[currentLang];
    if (finalTotalFee === 0) {
        alert(t.alert_no_price);
        return;
    }
    
    bookingAction = action;
    const phone = elements['customer-phone'].value.trim();

    if (!validatePhone(phone)) {
        elements['input-phone-for-booking'].value = phone;
        elements['phone-modal'].style.display = 'flex';
        elements['input-phone-for-booking'].focus();
    } else {
        openFinalZaloModal(phone);
    }
}

elements['zalo-btn'].addEventListener('click', () => handleBookingClick('zalo'));
elements['mail-btn'].addEventListener('click', () => handleBookingClick('mail'));

// Xử lý xác nhận SĐT trong Phone Modal
elements['confirm-phone-btn'].addEventListener('click', () => {
    const t = TRANSLATIONS[currentLang];
    const phone = elements['input-phone-for-booking'].value.trim();
    if (!validatePhone(phone)) {
        alert(t.alert_invalid_phone);
        elements['input-phone-for-booking'].focus();
        return;
    }
    elements['customer-phone'].value = phone; 
    elements['phone-modal'].style.display = 'none';

    if (bookingAction) {
        openFinalZaloModal(phone);
    }
});

elements['close-phone-modal'].addEventListener('click', () => {
    elements['phone-modal'].style.display = 'none';
    bookingAction = null; 
});
elements['phone-modal'].addEventListener('click', (e) => {
    if (e.target === elements['phone-modal']) {
        elements['phone-modal'].style.display = 'none';
        bookingAction = null; 
    }
});

// Xử lý xác nhận đặt cọc
elements['confirm-deposit-btn'].addEventListener('click', () => {
    elements['deposit-modal'].style.display = 'none';
});

// Mở Modal Zalo/Mail chính
function openFinalZaloModal(phone) {
    const t = TRANSLATIONS[currentLang];
    let finalMessage = finalZaloMessage.replace('[CHƯA CÓ]', phone);
    elements['modal-text'].textContent = finalMessage;

    if(bookingAction === 'mail') {
        const zaloOrderTitle = t.zalo_order_title;
        const encodedMsg = encodeURIComponent(finalMessage);
        const subject = encodeURIComponent(`${zaloOrderTitle} - ${elements['distance-text'].textContent.split(': ')[1]}`);
        elements['mail-btn'].href = `mailto:netvuan@gmail.com?subject=${subject}&body=${encodedMsg}`;
        alert(t.alert_mail_sent);
        window.location.href = elements['mail-btn'].href;
        elements['zalo-modal'].style.display = 'none';
        bookingAction = null;
        return;
    }

    elements['zalo-modal'].style.display = 'flex'; 

    const range = document.createRange();
    range.selectNodeContents(elements['modal-text']);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    copyToClipboard(finalMessage).then(success => {
        if(success) console.log("Đã sao chép tin nhắn Zalo thành công.");
    });

    bookingAction = null; 
}


async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.warn('Fallback: Copying directly from DOM');
        try {
            const success = document.execCommand('copy');
            return success;
        } catch (errFallback) {
            console.error('Không thể thực hiện sao chép:', errFallback);
            return false;
        }
    }
}

elements['copy-modal-btn'].addEventListener('click', async () => {
    const t = TRANSLATIONS[currentLang];
    const range = document.createRange();
    range.selectNodeContents(elements['modal-text']);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    const success = await copyToClipboard(elements['modal-text'].textContent);
    
    if (success) {
        alert(t.alert_copied);
    } else {
        alert(t.alert_copy_fail);
    }
});

elements['zalo-modal-btn'].addEventListener('click', () => {
    window.getSelection().removeAllRanges(); 
    elements['zalo-modal'].style.display = 'none'; 
    window.open(ZALO_URL, '_blank');
});

elements['close-modal-btn'].addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    elements['zalo-modal'].style.display = 'none';
});

elements['close-modal-btn-bottom'].addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    elements['zalo-modal'].style.display = 'none';
});

/* -------------------- KHỞI TẠO VÀ POLLING -------------------- */
document.addEventListener('DOMContentLoaded', async ()=>{
    initLanguageSwitcher(); 
    
    setMinPickupDateTime();
    
    getGeolocation();
    
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    // Polling trạng thái dịch vụ mỗi 15 giây
    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
            console.log(`[Kill Switch] Trạng thái đã thay đổi. Active: ${newStatus.active}`);
        }
        setMinPickupDateTime(); 
    }, 15000); 
    
    elements['reload-location-btn'].addEventListener('click', getGeolocation); 
});

// PWA: Đăng ký Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js') 
      .then((reg) => {
        console.log('Service worker registered.', reg);
      })
      .catch((err) => {
        console.log('Service worker registration failed: ', err);
      });
  });
}
</script>
</body>
</html>
