<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªãch V·ª• Taxi Tr∆∞·ªùng An Driving | T√≠nh Gi√° C∆∞·ªõc & ƒê·∫∑t Xe</title>
    <meta name="description" content="T√≠nh gi√° c∆∞·ªõc taxi hai chi·ªÅu, m·ªôt chi·ªÅu ch√≠nh x√°c, nhanh ch√≥ng. ƒê·∫∑t xe 4 ch·ªó, 7 ch·ªó ƒëi t·ªânh v·ªõi Tr∆∞·ªùng An Driving.">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIINfQ7oWA8x9ppvLG3E8wM6CWTNkmr4SSg=" crossorigin=""/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            padding-bottom: 70px; /* D√†nh cho footer c·ªë ƒë·ªãnh */
        }
        .container {
            max-width: 600px;
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px 0;
            margin: -15px -15px 15px -15px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            text-align: center;
        }
        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .form-group label {
            font-weight: bold;
            color: #333;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .input-group-text {
            background-color: #e9ecef;
            min-width: 100px;
            justify-content: center;
        }
        #result-box {
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        #price-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #d9534f; /* M√†u ƒë·ªè n·ªïi b·∫≠t */
        }
        .btn-calculate {
            background-color: #007bff;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
        }
        .btn-calculate:hover {
            background-color: #0056b3;
        }
        .btn-zalo, .btn-mail {
            font-size: 1rem;
            font-weight: bold;
            margin-top: 10px;
        }
        .btn-zalo { background-color: #008cff; border-color: #008cff; color: white; }
        .btn-zalo:hover { background-color: #007bff; border-color: #007bff; }
        .btn-mail { background-color: #dc3545; border-color: #dc3545; color: white; }
        .btn-mail:hover { background-color: #c82333; border-color: #c82333; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 450px;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h4 {
            margin: 0;
            color: #007bff;
            font-weight: bold;
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
        }
        .close-btn:hover, .close-btn:focus {
            color: #000;
            text-decoration: none;
        }
        #modal-text {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px dashed #ced4da;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            user-select: text; /* Cho ph√©p ch·ªçn vƒÉn b·∫£n */
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .modal-buttons button {
            flex-grow: 1;
            margin: 0 5px;
        }
        #offline-alert {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üöï D·ªãch V·ª• Taxi</h1>
        <p>Tr∆∞·ªùng An Driving</p>
        <p style="font-size: 1rem; margin-bottom: 0;">‚òéÔ∏è 0847526893</p>
    </div>

    <div id="offline-alert" class="alert alert-danger" role="alert">
        Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng.
    </div>

    <div class="mb-3 d-flex justify-content-end">
        <select id="lang-switcher" class="form-select form-select-sm" style="width: auto;">
            <option value="vi">üáªüá≥ Ti·∫øng Vi·ªát</option>
            </select>
    </div>

    <div class="mb-3">
        <label for="customer-phone" class="form-label">üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n</label>
        <div class="input-group">
            <input type="tel" class="form-control" id="customer-phone" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)">
        </div>
    </div>
    
    <div class="mb-3">
        <label for="pickup-address" class="form-label">üìç ƒêi·ªÉm ƒë√≥n</label>
        <div class="input-group">
            <span class="input-group-text location-status">T·ª± ƒë·ªông t√¨m v·ªã tr√≠</span>
            <input type="text" class="form-control address-input" id="pickup-address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n">
            <button class="btn btn-outline-secondary" type="button" id="reload-location-btn" title="T·∫£i l·∫°i v·ªã tr√≠">üîÑ</button>
            <button class="btn btn-outline-secondary" type="button" onclick="window.open('https://maps.google.com/', '_blank');">B·∫£n ƒë·ªì</button>
        </div>
    </div>

    <div class="mb-3">
        <label for="pickup-date-time" class="form-label">üïí Ng√†y & Gi·ªù ƒë√≥n</label>
        <input type="datetime-local" class="form-control" id="pickup-date-time">
    </div>

    <div id="stops-container">
        </div>
    <button class="btn btn-success btn-sm mb-3" id="add-stop-btn">+ Th√™m ƒëi·ªÉm d·ª´ng</button>

    <div class="mb-3">
        <label for="dropoff-address" class="form-label">üèÅ ƒêi·ªÉm ƒë·∫øn</label>
        <div class="input-group">
            <input type="text" class="form-control address-input" id="dropoff-address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
            <button class="btn btn-outline-secondary" type="button" onclick="window.open('https://maps.google.com/', '_blank');">B·∫£n ƒë·ªì</button>
        </div>
    </div>
    
    <div class="mb-3">
        <label for="car-type" class="form-label">üöó Lo·∫°i xe</label>
        <select class="form-select" id="car-type">
            <option value="Xe 4 ch·ªó (10.000ƒë/km)">Xe 4 ch·ªó (10.000ƒë/km)</option>
            <option value="Xe 7 ch·ªó (12.000ƒë/km)">Xe 7 ch·ªó (12.000ƒë/km)</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="trip-type" class="form-label">üöñ Lo·∫°i chuy·∫øn ƒëi</label>
        <select class="form-select" id="trip-type">
            <option value="1">1 chi·ªÅu</option>
            <option value="2">2 chi·ªÅu (C√≥ gi·∫£m gi√° chi·ªÅu v·ªÅ)</option>
        </select>
    </div>

    <div class="mb-3" id="waiting-group">
        <label for="waiting-time" class="form-label">‚è≥ Th·ªùi gian ch·ªù (ch·ªâ √°p d·ª•ng 2 chi·ªÅu, mi·ªÖn ph√≠ 0-3 gi·ªù)</label>
        <div class="input-group">
            <input type="number" class="form-control" id="waiting-time" value="0" min="0" step="0.5">
            <span class="input-group-text">gi·ªù</span>
        </div>
    </div>

    <div class="mb-3">
        <label for="driver-request" class="form-label">üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu t√†i x·∫ø (L√°i xe h·ªô/Xe kh√°ch/Xe c√¥ng ty)</label>
        <select class="form-select" id="driver-request">
            <option value="Kh√¥ng y√™u c·∫ßu ƒë·∫∑c bi·ªát">Kh√¥ng y√™u c·∫ßu ƒë·∫∑c bi·ªát</option>
            <option value="L√°i xe h·ªô">L√°i xe h·ªô</option>
            <option value="L√°i xe kh√°ch">L√°i xe kh√°ch</option>
            <option value="L√°i xe c√¥ng ty">L√°i xe c√¥ng ty</option>
            <option value="T√†i x·∫ø m·∫∑c ƒë·ªãnh (Tr∆∞·ªùng An)">T√†i x·∫ø m·∫∑c ƒë·ªãnh (Tr∆∞·ªùng An)</option>
        </select>
    </div>

    <button class="btn btn-calculate w-100 mb-3" id="calculate-btn">T√≠nh gi√° & L·ªô tr√¨nh</button>

    <div id="map"></div>

    <div id="result-box">
        <h4 class="text-primary">K·∫æT QU·∫¢ D·ª∞ KI·∫æN</h4>
        <div class="mb-2">
            <p id="distance-text" class="mb-1">Qu√£ng ƒë∆∞·ªùng: ‚Äî</p>
            <p id="time-estimate" class="mb-1">Th·ªùi gian di chuy·ªÉn (∆∞·ªõc t√≠nh): ‚Äî ph√∫t</p>
            <p id="pickup-info" class="mb-1">Ng√†y gi·ªù ƒë√≥n: ‚Äî</p>
            <p class="mb-0">T·ªïng gi√° d·ª± ki·∫øn:</p>
            <span id="price-value">‚Äî</span>
        </div>
        <hr>
        <div id="price-breakdown" style="font-size: 0.9em;">
            </div>
        <hr>
        <p id="instruction-text" class="text-success fw-bold">Vui l√≤ng nh·∫•n n√∫t "T√≠nh gi√° & l·ªô tr√¨nh" ƒë·ªÉ xem chi ti·∫øt.</p>
        <button class="btn btn-zalo w-100" id="zalo-btn" style="display: none;"><img src="https://upload.wikimedia.org/wikipedia/commons/9/90/Zalo_logo.svg" alt="Zalo" width="20"> ƒê·∫∑t qua Zalo</button>
        <button class="btn btn-mail w-100 mt-2" id="mail-btn" style="display: none;">‚úâÔ∏è ƒê·∫∑t qua Email</button>
    </div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20n6a323G3A4f+hT7D4n+y9A9VfG3f/v/G4Q0n9+JvE=" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<div id="phone-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>X√°c nh·∫≠n S·ªë ƒëi·ªán tho·∫°i</h4>
            <button class="close-btn" id="close-phone-modal">&times;</button>
        </div>
        <p>ƒê·ªÉ ho√†n t·∫•t vi·ªác ƒë·∫∑t xe, vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n:</p>
        <input type="tel" class="form-control" id="input-phone-for-booking" placeholder="S·ªë ƒëi·ªán tho·∫°i 10 s·ªë">
        <div class="modal-buttons">
            <button class="btn btn-primary w-100" id="confirm-phone-btn">X√°c nh·∫≠n</button>
        </div>
    </div>
</div>

<div id="deposit-modal" class="modal">
    <div class="modal-content text-center">
        <div class="modal-header d-block">
            <h4 class="text-warning">‚ö†Ô∏è L∆ØU √ù ƒê·∫∂T C·ªåC</h4>
        </div>
        <p>V·ªõi chuy·∫øn **Hai chi·ªÅu** ƒëi t·ªânh, qu√Ω kh√°ch vui l√≤ng ƒë·∫∑t c·ªçc **20%** t·ªïng gi√° tr·ªã chuy·∫øn ƒëi.</p>
        <p class="fw-bold">S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn: <span id="deposit-amount" class="text-danger">0 ƒë</span></p>
        <p style="font-size: 0.8em; color: #6c757d;">(S·ªë ti·ªÅn n√†y s·∫Ω ƒë∆∞·ª£c tr·ª´ v√†o t·ªïng c∆∞·ªõc khi k·∫øt th√∫c chuy·∫øn ƒëi.)</p>
        <div class="modal-buttons">
            <button class="btn btn-success w-100" id="confirm-deposit-btn">ƒê√£ hi·ªÉu</button>
        </div>
    </div>
</div>

<div id="zalo-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>‚úÖ TH√îNG TIN ƒê·∫∂T XE</h4>
            <button class="close-btn" id="close-modal-btn">&times;</button>
        </div>
        <p>Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <div id="modal-text" class="modal-body">
            </div>
        <div class="modal-buttons">
            <button class="btn btn-warning" id="copy-modal-btn">üìã Sao Ch√©p Th√¥ng Tin</button>
            <button class="btn btn-primary" id="zalo-modal-btn">üí¨ M·ªü Zalo Chat</button>
        </div>
        <div class="d-grid mt-2">
            <button class="btn btn-secondary" id="close-modal-btn-bottom">ƒê√≥ng</button>
        </div>
    </div>
</div>


<script>
// Bi·∫øn to√†n c·ª•c
const OSRM = 'https://router.project-osrm.org/route/v1/driving';
const ZALO_URL = 'https://zalo.me/0847526893'; // SƒêT Tr∆∞·ªùng An
// Quan tr·ªçng: B·∫°n c·∫ßn t·∫°o file status-local.json tr√™n host/server c·ªßa m√¨nh
const STATUS_FILE = './status-local.json'; // File ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•

let map;
let markerPickup, markerDropoff;
let routeLayer;
let finalZaloMessage = '';
let finalTotalFee = 0;
let bookingAction = null; // 'zalo' ho·∫∑c 'mail'
let currentLang = 'vi'; // M·∫∑c ƒë·ªãnh ti·∫øng Vi·ªát
let isServiceActive = true; // M·∫∑c ƒë·ªãnh d·ªãch v·ª• ho·∫°t ƒë·ªông

// D·ªãch thu·∫≠t (C·∫ßn th√™m c√°c key b·ªã thi·∫øu)
const TRANSLATIONS = {
    'vi': {
        // C√ÅC NH√ÉN CHUNG
        trip_type_1: '1 chi·ªÅu',
        trip_type_2: '2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)',
        trip_type_2_no_discount: '2 chi·ªÅu (Kh√¥ng gi·∫£m gi√°)',
        car_4_seater: 'Xe 4 ch·ªó',
        car_7_seater: 'Xe 7 ch·ªó',
        hours: 'gi·ªù',
        distance_unit: 'km',
        not_selected: '(Ch∆∞a ch·ªçn)',
        one_way_trip: 'm·ªôt chi·ªÅu',
        
        // NH√ÉN TRONG FORM
        pickup_label: 'ƒêi·ªÉm ƒë√≥n',
        dropoff_label: 'ƒêi·ªÉm ƒë·∫øn',
        stop_label: 'ƒêi·ªÉm d·ª´ng',
        
        // K·∫æT QU·∫¢ HI·ªÇN TH·ªä
        result_distance: 'Qu√£ng ƒë∆∞·ªùng: ‚Äî',
        result_time_est: 'Th·ªùi gian di chuy·ªÉn (∆∞·ªõc t√≠nh): ‚Äî ph√∫t',
        result_pickup_info: 'Ng√†y gi·ªù ƒë√≥n: ‚Äî',
        price_go: 'Gi√° chi·ªÅu ƒëi',
        total_price: 'T·ªïng c·ªông',
        wait_fee: 'Ph√≠ ch·ªù ph√°t sinh',
        wait_time: 'Th·ªùi gian ch·ªù',
        wait_free_label: 'Mi·ªÖn ph√≠',
        wait_free: 'mi·ªÖn ph√≠ 0‚Äì3h',
        
        // ALERT V√Ä TH√îNG B√ÅO
        calculating_route: 'ƒêang t√≠nh l·ªô tr√¨nh...',
        route_error: 'L·ªói t√≠nh to√°n l·ªô tr√¨nh.',
        instruction_text_loading: 'ƒêang x·ª≠ l√Ω...',
        instruction_text_active: 'Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin v√† nh·∫•n n√∫t ƒê·∫∑t xe.',
        alert_no_coord: 'Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô/ƒë·ªãa ch·ªâ cho {0}. Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ h∆°n.',
        alert_no_address: 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ ƒêi·ªÉm ƒë√≥n v√† ƒêi·ªÉm ƒë·∫øn.',
        alert_no_date: 'Vui l√≤ng ch·ªçn Ng√†y & Gi·ªù ƒë√≥n.',
        alert_no_price: 'Vui l√≤ng nh·∫•n n√∫t "T√≠nh gi√° & l·ªô tr√¨nh" tr∆∞·ªõc khi ƒê·∫∑t xe.',
        alert_invalid_phone: 'S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (10 s·ªë, VD: 0987654321).',
        alert_copied: 'ƒê√£ sao ch√©p th√¥ng tin ƒë·∫∑t xe th√†nh c√¥ng!',
        alert_copy_fail: 'Kh√¥ng th·ªÉ sao ch√©p t·ª± ƒë·ªông. Vui l√≤ng ch·ªçn v√† sao ch√©p th·ªß c√¥ng.',
        alert_mail_sent: 'Th√¥ng tin s·∫Ω ƒë∆∞·ª£c g·ª≠i qua Email m·∫∑c ƒë·ªãnh c·ªßa b·∫°n.',
        alert_service_off: 'Xin l·ªói, d·ªãch v·ª• t·∫°m th·ªùi kh√¥ng ho·∫°t ƒë·ªông. Vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp qua s·ªë ƒëi·ªán tho·∫°i tr√™n.',
        
        // TIN NH·∫ÆN ZALO/MAIL
        zalo_order_title: 'Y√äU C·∫¶U ƒê·∫∂T XE TR∆Ø·ªúNG AN DRIVING',
        zalo_phone_label: 'SƒêT Kh√°ch h√†ng',
        zalo_trip_type: 'Lo·∫°i chuy·∫øn',
        zalo_car_type: 'Lo·∫°i xe',
        zalo_driver_request: 'Y√™u c·∫ßu t√†i x·∫ø',
        zalo_pickup_point: 'ƒêi·ªÉm ƒë√≥n',
        zalo_dropoff_point: 'ƒêi·ªÉm ƒë·∫øn',
        zalo_pickup_time: 'Ng√†y gi·ªù ƒë√≥n',
        zalo_total_price: 'T·ªïng gi√° d·ª± ki·∫øn',
        zalo_stop_label: 'ƒêi·ªÉm d·ª´ng',
        zalo_waiting: 'Th·ªùi gian ch·ªù',
        zalo_wait_fee: 'Ph√≠ ch·ªù ph√°t sinh',
        zalo_note: 'Vui l√≤ng x√°c nh·∫≠n ƒë∆°n h√†ng.',
        zalo_deposit: 'ƒê·∫∂T C·ªåC',
        zalo_total_fee: 'T·ªïng ph√≠',
        maps_link_title: 'LI√äN K·∫æT B·∫¢N ƒê·ªí CH√çNH X√ÅC',
        maps_link_pickup: 'V·ªã tr√≠ ƒë√≥n kh√°ch (T·ªça ƒë·ªô)',
        maps_link_dir: 'Ch·ªâ ƒë∆∞·ªùng (ƒê√≥n -> Tr·∫£)',
    },
    // C√°c ng√¥n ng·ªØ kh√°c (n·∫øu c√≥)
};


// Ch·ªçn c√°c ph·∫ßn t·ª≠ DOM
const langSwitcher = document.getElementById('lang-switcher');
const pickupEl = document.getElementById('pickup-address');
const dropoffEl = document.getElementById('dropoff-address');
const pickupDateTime = document.getElementById('pickup-date-time');
const stopsContainer = document.getElementById('stops-container');
const addStopBtn = document.getElementById('add-stop-btn');
const carTypeEl = document.getElementById('car-type');
const tripTypeEl = document.getElementById('trip-type');
const waitingEl = document.getElementById('waiting-time');
const driverRequestEl = document.getElementById('driver-request');
const calcBtn = document.getElementById('calculate-btn');
const resultBox = document.getElementById('result-box');
const distanceText = document.getElementById('distance-text');
const priceValue = document.getElementById('price-value');
const priceBreak = document.getElementById('price-breakdown');
const timeEst = document.getElementById('time-estimate');
const pickupInfo = document.getElementById('pickup-info');
const zaloBtn = document.getElementById('zalo-btn');
const mailBtn = document.getElementById('mail-btn');
const instructionText = document.getElementById('instruction-text');
const mapContainer = document.getElementById('map');
const offlineAlert = document.getElementById('offline-alert');
const reloadLocationBtn = document.getElementById('reload-location-btn');
const customerPhoneEl = document.getElementById('customer-phone');

// Modal SƒêT
const phoneModal = document.getElementById('phone-modal');
const inputPhoneForBooking = document.getElementById('input-phone-for-booking');
const confirmPhoneBtn = document.getElementById('confirm-phone-btn');
const closePhoneModalBtn = document.getElementById('close-phone-modal');

// Modal Zalo
const zaloModal = document.getElementById('zalo-modal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copy-modal-btn');
const zaloModalBtn = document.getElementById('zalo-modal-btn');
const closeModalBtn = document.getElementById('close-modal-btn');
const closeModalBtnBottom = document.getElementById('close-modal-btn-bottom');

// Modal ƒê·∫∑t c·ªçc
const depositModal = document.getElementById('deposit-modal');
const depositAmount = document.getElementById('deposit-amount');
const confirmDepositBtn = document.getElementById('confirm-deposit-btn');


/* ---------- PH·∫¶N LOGIC CHUNG V√Ä HELPER ---------- */

// Kh·ªüi t·∫°o b·∫£n ƒë·ªì
function initMap() {
    if (map) return;
    // T·ªça ƒë·ªô trung t√¢m m·∫∑c ƒë·ªãnh: TP. HCM
    const defaultCoords = [10.8231, 106.6297]; 
    map = L.map('map').setView(defaultCoords, 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
}
initMap();


// C·∫≠p nh·∫≠t tr·∫°ng th√°i d·ªãch v·ª• (Kill Switch)
async function checkServiceStatus() {
    try {
        // Th√™m tham s·ªë ng·∫´u nhi√™n ƒë·ªÉ tr√°nh cache
        const response = await fetch(STATUS_FILE + '?t=' + new Date().getTime()); 
        if (!response.ok) {
            throw new Error('L·ªói truy c·∫≠p file tr·∫°ng th√°i.');
        }
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('L·ªói Kill Switch:', error);
        // M·∫∑c ƒë·ªãnh cho ph√©p ho·∫°t ƒë·ªông n·∫øu kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i
        return { active: true }; 
    }
}

async function updateUIBasedOnStatus(status) {
    isServiceActive = status.active;
    const t = TRANSLATIONS[currentLang];

    if (!isServiceActive) {
        offlineAlert.textContent = t.alert_service_off;
        offlineAlert.style.display = 'block';
        calcBtn.disabled = true;
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
    } else {
        offlineAlert.style.display = 'none';
        calcBtn.disabled = false;
    }
}


// H√†m ƒë·ªïi ng√¥n ng·ªØ
function initLanguageSwitcher() {
    langSwitcher.addEventListener('change', (e) => {
        currentLang = e.target.value;
        // K√≠ch ho·∫°t l·∫°i vi·ªác t√≠nh to√°n ƒë·ªÉ c·∫≠p nh·∫≠t ng√¥n ng·ªØ tin nh·∫Øn Zalo n·∫øu k·∫øt qu·∫£ ƒë√£ c√≥
        if (finalTotalFee > 0) {
            calculateAndGenerateMessage();
        }
    });
}


// Th√™m/X√≥a ƒëi·ªÉm d·ª´ng
let stopCounter = 0;
addStopBtn.addEventListener('click', () => {
    stopCounter++;
    const t = TRANSLATIONS[currentLang];
    const newStopDiv = document.createElement('div');
    newStopDiv.classList.add('input-group', 'mb-3');
    newStopDiv.innerHTML = `
        <label class="input-group-text">${t.stop_label} ${stopCounter}</label>
        <input type="text" class="form-control address-input stop-input" id="stop-${stopCounter}" placeholder="${t.stop_label} ${stopCounter}">
        <button class="btn btn-danger remove-stop-btn" type="button" onclick="removeStop(this)">X√≥a</button>
    `;
    stopsContainer.appendChild(newStopDiv);
});

function removeStop(button) {
    const stopDiv = button.closest('.input-group');
    stopsContainer.removeChild(stopDiv);
    // L∆∞u √Ω: Vi·ªác kh√¥ng reset stopCounter c√≥ th·ªÉ t·∫°o ra ID kh√¥ng li√™n t·ª•c (v√≠ d·ª•: stop-1, stop-3), 
    // nh∆∞ng kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn logic t√≠nh to√°n.
}


// X·ª≠ l√Ω t·ªça ƒë·ªô v√† b·∫£n ƒë·ªì
async function resolveCoordForInput(inputElement) {
    const address = inputElement.value.trim();
    if (!address) return null;

    try {
        // S·ª≠ d·ª•ng Nominatim/OpenStreetMap ƒë·ªÉ t√¨m t·ªça ƒë·ªô
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
        const data = await response.json();

        if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            return [lat, lon];
        }
        return null;
    } catch (error) {
        console.error('Geocoding error:', error);
        return null;
    }
}

function updateMapMarker(lat, lon, address, isPickup = true) {
    if (!map) initMap();
    const markerText = isPickup ? `ƒê√≥n: ${address}` : `ƒê·∫øn: ${address}`;

    // T√πy ch·ªânh m√†u marker cho ƒêi·ªÉm ƒë·∫øn (Dropoff)
    const dropoffIcon = L.icon({ 
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', 
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', 
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] 
    });

    if (isPickup) {
        if (markerPickup) map.removeLayer(markerPickup);
        markerPickup = L.marker([lat, lon]).addTo(map).bindPopup(markerText).openPopup();
    } else {
        if (markerDropoff) map.removeLayer(markerDropoff);
        markerDropoff = L.marker([lat, lon], { icon: dropoffIcon }).addTo(map).bindPopup(markerText).openPopup();
    }

    // C·∫≠p nh·∫≠t t·∫ßm nh√¨n b·∫£n ƒë·ªì ƒë·ªÉ bao g·ªìm c√°c ƒëi·ªÉm
    const markers = [];
    if (markerPickup) markers.push(markerPickup.getLatLng());
    if (markerDropoff) markers.push(markerDropoff.getLatLng());

    if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds(), { padding: [50, 50] });
    } else {
        map.setView([lat, lon], 13);
    }
}

// L·∫Øng nghe s·ª± ki·ªán blur ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£n ƒë·ªì
pickupEl.addEventListener('blur', async () => {
    const coord = await resolveCoordForInput(pickupEl);
    if (coord) updateMapMarker(coord[0], coord[1], pickupEl.value, true);
});

dropoffEl.addEventListener('blur', async () => {
    const coord = await resolveCoordForInput(dropoffEl);
    if (coord) updateMapMarker(coord[0], coord[1], dropoffEl.value, false);
});


// L·∫•y v·ªã tr√≠ hi·ªán t·∫°i c·ªßa kh√°ch h√†ng
function getGeolocation() {
    const t = TRANSLATIONS[currentLang];
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            try {
                // Reverse Geocoding ƒë·ªÉ l·∫•y ƒë·ªãa ch·ªâ
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();
                
                const address = data.display_name || `${lat}, ${lon}`;
                pickupEl.value = address;
                
                updateMapMarker(lat, lon, address, true);
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                document.querySelector('.location-status').innerHTML = `‚úÖ ƒê√£ t√¨m th·∫•y v·ªã tr√≠ <a href="#" onclick="event.preventDefault(); getGeolocation();" class="ms-1" style="font-size: 0.9em;">[T·∫£i l·∫°i]</a>`;

            } catch (error) {
                pickupEl.value = `${lat}, ${lon}`;
                document.querySelector('.location-status').textContent = '‚ö†Ô∏è L·ªói t√¨m ƒë·ªãa ch·ªâ. D√πng t·ªça ƒë·ªô.';
                console.error('Reverse Geocoding Error:', error);
            }

        }, (error) => {
            console.error('Geolocation error:', error);
            document.querySelector('.location-status').textContent = '‚ùå L·ªói ho·∫∑c b·ªã t·ª´ ch·ªëi.';
        });
    } else {
        document.querySelector('.location-status').textContent = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£.';
    }
}


// Validation
function validateRouteInputs() {
    const t = TRANSLATIONS[currentLang];
    if (pickupEl.value.trim() === '' || dropoffEl.value.trim() === '') {
        alert(t.alert_no_address);
        return false;
    }
    if (pickupDateTime.value === '') {
        alert(t.alert_no_date);
        return false;
    }
    return true;
}

function validatePhone(phone) {
    // Ki·ªÉm tra l√† 10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0
    return /^0\d{9}$/.test(phone); 
}


// Thi·∫øt l·∫≠p th·ªùi gian ƒë√≥n t·ªëi thi·ªÉu (hi·ªán t·∫°i + 15 ph√∫t)
function formatDateTime(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart('2', '0');
    const d = String(date.getDate()).padStart('2', '0');
    const h = String(date.getHours()).padStart('2', '0');
    const min = String(date.getMinutes()).padStart('2', '0');
    return `${y}-${m}-${d}T${h}:${min}`;
}

function setMinPickupDateTime() {
    const minDate = new Date();
    minDate.setMinutes(minDate.getMinutes() + 15); // ƒê·∫∑t t·ªëi thi·ªÉu 15 ph√∫t sau
    
    const minDateTimeString = formatDateTime(minDate);
    pickupDateTime.setAttribute('min', minDateTimeString);
    
    // Ch·ªâ set gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu ng∆∞·ªùi d√πng ch∆∞a ch·ªçn
    if (!pickupDateTime.value || new Date(pickupDateTime.value) < minDate) {
        pickupDateTime.value = minDateTimeString;
    }
}


/* ---------- LOGIC CH√çNH: T√çNH TO√ÅN V√Ä ƒê·∫∂T XE ---------- */

// H√†m ch√≠nh t√≠nh gi√° c∆∞·ªõc v√† t·∫°o tin nh·∫Øn Zalo
async function calculateAndGenerateMessage() {
    const lang = currentLang;
    const t = TRANSLATIONS[lang];
    
    if (!validateRouteInputs()) {
        return false; 
    }
    
    // 1. Resolve t·ªça ƒë·ªô
    const pickupCoord = await resolveCoordForInput(pickupEl);
    if(!pickupCoord){ alert(t.alert_no_coord.replace('{0}', t.pickup_label)); return false; }
    const dropoffCoord = await resolveCoordForInput(dropoffEl);
    if(!dropoffCoord){ alert(t.alert_no_coord.replace('{0}', t.dropoff_label)); return false; }

    const coords = [];
    coords.push(pickupCoord);
    const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
    for(const s of stopInputs){
        if(s.value.trim()){
            const sc = await resolveCoordForInput(s);
            if(!sc){ 
                 // T√¨m label t∆∞∆°ng ·ª©ng cho ƒëi·ªÉm d·ª´ng th·ª© i
                let stopLabel = t.stop_label + ' ';
                const match = s.id.match(/\d+/);
                if (match) {
                    stopLabel += match[0];
                }
                alert(t.alert_no_coord.replace('{0}', stopLabel)); 
                return false; 
            }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord);

    // Chuy·ªÉn ƒë·ªïi t·ªça ƒë·ªô sang ƒë·ªãnh d·∫°ng OSRM (lon,lat;lon,lat)
    const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
    const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

    // 2. C·∫≠p nh·∫≠t UI Loading
    resultBox.style.display = 'block';
    distanceText.textContent = t.result_distance.replace('‚Äî', t.calculating_route || 'ƒêang t√≠nh l·ªô tr√¨nh...');
    priceValue.textContent = '...';
    priceBreak.innerHTML = '';
    timeEst.textContent = t.result_time_est.replace('‚Äî', '...');
    finalZaloMessage = ''; 
    finalTotalFee = 0;
    zaloBtn.style.display = 'none'; 
    mailBtn.style.display = 'none';
    instructionText.innerHTML = t.instruction_text_loading; 

    try{
        // 3. G·ªçi OSRM API
        const r = await fetch(url);
        const data = await r.json();
        
        if(!data.routes || data.routes.length === 0){ 
            distanceText.textContent = t.result_distance.replace('‚Äî', t.route_error || 'L·ªói t√≠nh to√°n l·ªô tr√¨nh.'); 
            priceValue.textContent = '‚Äî';
            instructionText.innerHTML = t.alert_no_coord.replace('{0}', '');
            return false; 
        }
        
        const route = data.routes[0];
        const dist = route.distance / 1000; // Kilometers
        const durationSec = route.duration;
        const minutes = Math.round(durationSec / 60);

        // 4. V·∫Ω l·∫°i b·∫£n ƒë·ªì
        if(map) {
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
        }

        // 5. T√≠nh to√°n gi√° c∆∞·ªõc
        const tripType = tripTypeEl.value; 
        const carType = carTypeEl.value; 
        const driverRequest = driverRequestEl.value;
        const waiting = parseFloat(waitingEl.value) || 0; 
        
        let perKm;
        const carTypeKey = carType.includes('7 ch·ªó') ? 'car_7_seater' : 'car_4_seater';
        const carTypeText = TRANSLATIONS[lang][carTypeKey] || carType; 
        
        if (carType.includes('7 ch·ªó')) { perKm = 12000; } else { perKm = 10000; }
        const perKmReturnDiscount = Math.round(perKm * 0.6); 
        const priceGo = Math.round(dist * perKm);
        
        let priceReturn = 0;
        let returnNote = ''; 

        if(tripType === '2') {
            if(dist >= 45) {
                priceReturn = Math.round(dist * perKmReturnDiscount); 
                const tripType2Text = TRANSLATIONS[lang].trip_type_2 || '2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)';
                const distanceUnit = TRANSLATIONS[lang].distance_unit || 'km';
                returnNote = `${tripType2Text} (${perKmReturnDiscount.toLocaleString('vi-VN')}ƒë/${distanceUnit})`;
            } else {
                priceReturn = Math.round(dist * perKm); 
                const tripType2NoDiscount = TRANSLATIONS[lang].trip_type_2_no_discount || '2 chi·ªÅu (Kh√¥ng gi·∫£m gi√°)';
                const distanceUnit = TRANSLATIONS[lang].distance_unit || 'km';
                returnNote = `${tripType2NoDiscount} (${perKm.toLocaleString('vi-VN')}ƒë/${distanceUnit})`;
            }
        } else {
            returnNote = TRANSLATIONS[lang].trip_type_1 || '1 chi·ªÅu';
        }

        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0; // Ph√≠ ch·ªù 50k/h sau 3h mi·ªÖn ph√≠
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total; 
        const depositAmountValue = Math.round(total * 0.2); 

        // 6. C·∫≠p nh·∫≠t UI K·∫øt qu·∫£
        const oneWayTrip = TRANSLATIONS[lang].one_way_trip || 'm·ªôt chi·ªÅu';
        distanceText.textContent = t.result_distance.replace('‚Äî', `${dist.toFixed(1)} km (${oneWayTrip})`);
        priceValue.textContent = total.toLocaleString('vi-VN') + ' ƒë';

        let breakdownHtml = '';
        const priceGoLabel = TRANSLATIONS[lang].price_go || 'Gi√° chi·ªÅu ƒëi';
        const totalLabel = TRANSLATIONS[lang].total_price || 'T·ªïng c·ªông';
        const waitFeeLabel = TRANSLATIONS[lang].wait_fee || 'Ph√≠ ch·ªù';
        const waitTimeLabel = TRANSLATIONS[lang].wait_time || 'Th·ªùi gian ch·ªù';
        const hoursLabel = TRANSLATIONS[lang].hours || 'gi·ªù';
        const waitFreeLabel = TRANSLATIONS[lang].wait_free_label || 'Mi·ªÖn ph√≠';
        const waitFree = TRANSLATIONS[lang].wait_free || 'mi·ªÖn ph√≠ 0‚Äì3h';

        breakdownHtml += `‚Ä¢ ${priceGoLabel} (${perKm.toLocaleString('vi-VN')}ƒë/km): <b>${priceGo.toLocaleString('vi-VN')} ƒë</b><br>`;
        
        if(tripType === '2'){
            breakdownHtml += `‚Ä¢ ${returnNote}: <b>${priceReturn.toLocaleString('vi-VN')} ƒë</b><br>`;
        }

        let waitDetail;
        if (tripType === '2') {
            if (waiting > 3) {
                waitDetail = `${waitFeeLabel} (${waiting} ${hoursLabel}, ${waitFree}): <b>${waitFee.toLocaleString('vi-VN')} ƒë</b>`;
                breakdownHtml += `‚Ä¢ ${waitDetail}<br>`;
            } else if (waiting > 0) {
                waitDetail = `${waitTimeLabel} (${waiting} ${hoursLabel}): <b>${waitFreeLabel}</b>`;
                breakdownHtml += `‚Ä¢ ${waitDetail}<br>`;
            } 
        }
        
        breakdownHtml += `<hr style="margin:6px 0">‚Ä¢ <b>${totalLabel}: ${total.toLocaleString('vi-VN')} ƒë</b>`;
        priceBreak.innerHTML = breakdownHtml;

        timeEst.textContent = t.result_time_est.replace('‚Äî', `${minutes}`);

        const dateVal = pickupDateTime.value;
        const formattedDate = dateVal ? new Date(dateVal).toLocaleString(lang, { 
            year: 'numeric', month: 'numeric', day: 'numeric', 
            hour: '2-digit', minute: '2-digit', 
            hour12: false 
        }) : TRANSLATIONS[lang].not_selected || '(Ch∆∞a ch·ªçn)';
        pickupInfo.textContent = t.result_pickup_info.replace('‚Äî', formattedDate);
        
        // 7. T·∫°o tin nh·∫Øn Zalo/Mail
        
        const stopInputsValues = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'))
            .map(s => s.value.trim()).filter(v => v);
        
        const zaloStopLabel = TRANSLATIONS[lang].zalo_stop_label || 'ƒêi·ªÉm d·ª´ng';
        const stopDetails = stopInputsValues.map((v, i) => `üõ£Ô∏è ${zaloStopLabel} ${i+1}: ${v}`).join('\n');
        
        let zaloWaitingDetail = '';
        const zaloWaiting = TRANSLATIONS[lang].zalo_waiting || 'Th·ªùi gian ch·ªù';
        const zaloWaitFee = TRANSLATIONS[lang].zalo_wait_fee || 'Ph√≠ ch·ªù ph√°t sinh';
        if (tripType === '2') {
            if (waiting > 3) {
                zaloWaitingDetail = `‚è≥ ${zaloWaiting}: ${waiting} ${hoursLabel} (Ph√≠ ch·ªù ph√°t sinh: ${waitFee.toLocaleString('vi-VN')} ƒë)`;
            } else {
                zaloWaitingDetail = `‚è≥ ${zaloWaiting}: ${waiting} ${hoursLabel} (${waitFreeLabel})`;
            }
        }
        
        // T·∫°o Maps Link (Ch√∫ √Ω: ƒê∆∞·ªùng link Google Maps c·∫ßn ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng c√°ch ƒë·ªÉ ho·∫°t ƒë·ªông tr√™n Zalo/Mobile)
        const pickupAddress = pickupEl.value.trim();
        const dropoffAddress = dropoffEl.value.trim();
        const pickupLatLon = `${pickupCoord[0]},${pickupCoord[1]}`;
        const dropoffLatLon = `${dropoffCoord[0]},${dropoffCoord[1]}`;
        // D√πng Google Maps URL ch√≠nh x√°c h∆°n cho ch·ªâ ƒë∆∞·ªùng
        const mapsDirectionLink = `https://www.google.com/maps/dir/${pickupLatLon}/${dropoffLatLon}`;
        const mapsPickupLink = `https://www.google.com/maps/search/${pickupLatLon}`; 

        const mapsLinkTitle = TRANSLATIONS[lang].maps_link_title || 'LI√äN K·∫æT B·∫¢N ƒê·ªí CH√çNH X√ÅC';
        const mapsLinkPickup = TRANSLATIONS[lang].maps_link_pickup || 'V·ªã tr√≠ ƒë√≥n kh√°ch (T·ªça ƒë·ªô)';
        const mapsLinkDir = TRANSLATIONS[lang].maps_link_dir || 'Ch·ªâ ƒë∆∞·ªùng (ƒê√≥n -> Tr·∫£)';
        
        let mapsLinksSection = [
            `\n*** üó∫Ô∏è ${mapsLinkTitle} ***`,
            `üìç ${mapsLinkPickup}: ${mapsPickupLink}`,
            `üõ£Ô∏è ${mapsLinkDir}: ${mapsDirectionLink}`,
            `\n`
        ].join('\n');
        
        // Th√™m th√¥ng tin ƒë·∫∑t c·ªçc (Deposit)
        let depositSection = '';
        const zaloDeposit = TRANSLATIONS[lang].zalo_deposit || 'ƒê·∫∂T C·ªåC';
        const zaloTotalFee = TRANSLATIONS[lang].zalo_total_fee || 'T·ªïng ph√≠';
        if (tripType === '2') {
            depositSection = `\nüí∞ ${zaloDeposit}: ${depositAmountValue.toLocaleString('vi-VN')} ƒë (20% ${zaloTotalFee})`;
        }

        // T·∫°o tin nh·∫Øn Zalo T·∫°m th·ªùi (Ch∆∞a c√≥ SƒêT)
        const zaloOrderTitle = TRANSLATIONS[lang].zalo_order_title || 'Y√äU C·∫¶U ƒê·∫∂T XE TR∆Ø·ªúNG AN DRIVING';
        const zaloPhoneLabel = TRANSLATIONS[lang].zalo_phone_label || 'SƒêT Kh√°ch h√†ng';
        const zaloTripType = TRANSLATIONS[lang].zalo_trip_type || 'Lo·∫°i chuy·∫øn';
        const zaloCarType = TRANSLATIONS[lang].zalo_car_type || 'Lo·∫°i xe';
        const zaloDriverRequest = TRANSLATIONS[lang].zalo_driver_request || 'Y√™u c·∫ßu t√†i x·∫ø';
        const zaloPickupPoint = TRANSLATIONS[lang].zalo_pickup_point || 'ƒêi·ªÉm ƒë√≥n';
        const zaloDropoffPoint = TRANSLATIONS[lang].zalo_dropoff_point || 'ƒêi·ªÉm ƒë·∫øn';
        const zaloPickupTime = TRANSLATIONS[lang].zalo_pickup_time || 'Ng√†y gi·ªù ƒë√≥n';
        const zaloTotalPrice = TRANSLATIONS[lang].zalo_total_price || 'T·ªïng gi√° d·ª± ki·∫øn';
        const zaloNote = TRANSLATIONS[lang].zalo_note || 'Vui l√≤ng x√°c nh·∫≠n ƒë∆°n h√†ng.';
        
        finalZaloMessage = [
            `üöñ ${zaloOrderTitle}`,
            '-------------------------------',
            `üìû ${zaloPhoneLabel}: [CH∆ØA C√ì]`,
            `‚úÖ ${zaloTripType}: ${tripType === '1' ? t.trip_type_1 : `${t.trip_type_2} (${dist.toFixed(1)} ${oneWayTrip})`}`,
            `üöò ${zaloCarType}: ${carTypeText}`, 
            `üßë‚Äç‚úàÔ∏è ${zaloDriverRequest}: ${driverRequest}`,
            `üìç ${zaloPickupPoint}: ${pickupAddress}`,
            ...(stopInputsValues.length ? [stopDetails] : []),
            `üèÅ ${zaloDropoffPoint}: ${dropoffAddress}`,
            `üïí ${zaloPickupTime}: ${formattedDate}`,
            ...(tripType === '2' ? [zaloWaitingDetail] : []), 
            `üíµ ${zaloTotalPrice}: ${total.toLocaleString('vi-VN')} ƒë`,
            depositSection,
            mapsLinksSection, 
            '-------------------------------',
            zaloNote,
        ].join('\n');

        // 8. Hi·ªÉn th·ªã n√∫t ƒë·∫∑t xe v√† cu·ªôn ƒë·∫øn k·∫øt qu·∫£
        zaloBtn.style.display = 'block'; 
        mailBtn.style.display = 'block'; 
        instructionText.style.display = 'block';
        instructionText.innerHTML = t.instruction_text_active;

        resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return true; 
    }catch(err){
        console.error('Route error', err);
        distanceText.textContent = t.alert_no_coord.replace('{0}', '...');
        priceValue.textContent = '‚Äî';
        mailBtn.href = `mailto:netvuan@gmail.com`; 
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        instructionText.innerHTML = t.alert_no_coord.replace('{0}', '');
        return false;
    }
}

// X·ª≠ l√Ω n√∫t T√≠nh gi√°
calcBtn.addEventListener('click', async () => {
  const t = TRANSLATIONS[currentLang];
  if (!isServiceActive) {
      alert(t.alert_service_off);
      return;
  }
  
  const success = await calculateAndGenerateMessage();

  if(success && tripTypeEl.value === '2') {
    const deposit = Math.round(finalTotalFee * 0.2);
    depositAmount.textContent = deposit.toLocaleString('vi-VN') + ' ƒë';
    depositModal.style.display = 'flex';
  }
});

// X·ª≠ l√Ω n√∫t ƒê·∫∑t qua Zalo / Mail
function handleBookingClick(action) {
    const t = TRANSLATIONS[currentLang];
    if (finalTotalFee === 0) {
        alert(t.alert_no_price);
        return;
    }
    
    bookingAction = action;
    const phone = customerPhoneEl.value.trim();

    if (!validatePhone(phone)) {
        inputPhoneForBooking.value = phone;
        phoneModal.style.display = 'flex';
        inputPhoneForBooking.focus();
    } else {
        openFinalZaloModal(phone);
    }
}

zaloBtn.addEventListener('click', () => handleBookingClick('zalo'));
mailBtn.addEventListener('click', () => handleBookingClick('mail'));

// X·ª≠ l√Ω x√°c nh·∫≠n SƒêT trong Phone Modal
confirmPhoneBtn.addEventListener('click', () => {
    const t = TRANSLATIONS[currentLang];
    const phone = inputPhoneForBooking.value.trim();
    if (!validatePhone(phone)) {
        alert(t.alert_invalid_phone);
        inputPhoneForBooking.focus();
        return;
    }
    customerPhoneEl.value = phone; 
    phoneModal.style.display = 'none';

    if (bookingAction) {
        openFinalZaloModal(phone);
    }
});

closePhoneModalBtn.addEventListener('click', () => {
    phoneModal.style.display = 'none';
    bookingAction = null; 
});
phoneModal.addEventListener('click', (e) => {
    if (e.target === phoneModal) {
        phoneModal.style.display = 'none';
        bookingAction = null; 
    }
});


// X·ª≠ l√Ω x√°c nh·∫≠n ƒë·∫∑t c·ªçc
confirmDepositBtn.addEventListener('click', () => {
    depositModal.style.display = 'none';
});
depositModal.addEventListener('click', (e) => {
    if (e.target === depositModal) {
        depositModal.style.display = 'none';
    }
});


// M·ªü Modal Zalo/Mail ch√≠nh
function openFinalZaloModal(phone) {
    const t = TRANSLATIONS[currentLang];
    let finalMessage = finalZaloMessage.replace('[CH∆ØA C√ì]', phone);
    modalText.textContent = finalMessage;

    if(bookingAction === 'mail') {
        const zaloOrderTitle = TRANSLATIONS[currentLang].zalo_order_title || 'Y√™u c·∫ßu ƒê·∫∑t xe Tr∆∞·ªùng An';
        const encodedMsg = encodeURIComponent(finalMessage);
        const subject = encodeURIComponent(`${zaloOrderTitle} - ${distanceText.textContent.split(': ')[1]}`);
        mailBtn.href = `mailto:netvuan@gmail.com?subject=${subject}&body=${encodedMsg}`;
        alert(t.alert_mail_sent);
        window.location.href = mailBtn.href;
        zaloModal.style.display = 'none';
        bookingAction = null;
        return;
    }

    zaloModal.style.display = 'flex'; 

    // T·ª± ƒë·ªông ch·ªçn (highlight) to√†n b·ªô n·ªôi dung ƒë·ªÉ ng∆∞·ªùi d√πng ti·ªán copy
    const range = document.createRange();
    range.selectNodeContents(modalText);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Th·ª≠ t·ª± ƒë·ªông copy
    copyToClipboard(finalMessage).then(success => {
        if(success) {
            console.log("ƒê√£ sao ch√©p tin nh·∫Øn Zalo th√†nh c√¥ng.");
        }
    });

    bookingAction = null; 
}


async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.warn('Fallback: Copying directly from DOM');
        try {
            // D√πng execCommand fallback (c·∫ßn ph·∫£i c√≥ selection)
            const success = document.execCommand('copy');
            return success;
        } catch (errFallback) {
            console.error('Kh√¥ng th·ªÉ th·ª±c hi·ªán sao ch√©p:', errFallback);
            return false;
        }
    }
}

copyModalBtn.addEventListener('click', async () => {
    const t = TRANSLATIONS[currentLang];
    // ƒê·∫£m b·∫£o n·ªôi dung ƒë∆∞·ª£c ch·ªçn tr∆∞·ªõc khi copy
    const range = document.createRange();
    range.selectNodeContents(modalText);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    const success = await copyToClipboard(modalText.textContent);
    
    if (success) {
        alert(t.alert_copied);
    } else {
        alert(t.alert_copy_fail);
    }
});

zaloModalBtn.addEventListener('click', () => {
    window.getSelection().removeAllRanges(); 
    zaloModal.style.display = 'none'; 
    window.open(ZALO_URL, '_blank');
});

closeModalBtn.addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    zaloModal.style.display = 'none';
});

closeModalBtnBottom.addEventListener('click', () => {
    window.getSelection().removeAllRanges();
    zaloModal.style.display = 'none';
});

zaloModal.addEventListener('click', (e) => {
    if (e.target === zaloModal) {
        window.getSelection().removeAllRanges();
        zaloModal.style.display = 'none';
    }
});

/* ------------------------------------------------------------------
   KH·ªûI T·∫†O V√Ä POLLING (T·ª∞ ƒê·ªòNG C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI)
   ------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', async ()=>{
    // Kh·ªüi t·∫°o Language Switcher tr∆∞·ªõc
    initLanguageSwitcher(); 
    
    setMinPickupDateTime();
    
    getGeolocation();
    
    // Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª• l·∫ßn ƒë·∫ßu
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    // T·ª± ƒë·ªông ki·ªÉm tra file JSON n·ªôi b·ªô m·ªói 15 gi√¢y
    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
            console.log(`[Kill Switch] Tr·∫°ng th√°i ƒë√£ thay ƒë·ªïi v√† ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông! Active: ${newStatus.active}`);
        }
        // C·∫≠p nh·∫≠t l·∫°i th·ªùi gian t·ªëi thi·ªÉu m·ªói l·∫ßn polling ƒë·ªÉ lu√¥n theo s√°t th·ªùi gian th·ª±c
        setMinPickupDateTime(); 
    }, 15000); 
    
    reloadLocationBtn.addEventListener('click', getGeolocation); 
});

// PWA: ƒêƒÉng k√Ω Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // L∆∞u √Ω: B·∫°n c·∫ßn file service-worker.js ƒë·ªÉ ƒëo·∫°n code n√†y ho·∫°t ƒë·ªông
    navigator.serviceWorker.register('./service-worker.js') 
      .then((reg) => {
        console.log('Service worker registered.', reg);
      })
      .catch((err) => {
        console.log('Service worker registration failed: ', err);
      });
  });
}
</script>
</body>
</html>
