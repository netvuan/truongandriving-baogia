<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>üöñ Tr∆∞·ªùng An Driving - D·ªãch V·ª• Taxi Cao C·∫•p</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#006400">
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* =========================================
           1. CORE STYLES (GIAO DI·ªÜN CAO C·∫§P)
           ========================================= */
        :root {
            --primary-color: #006400; /* Xanh ƒë·∫≠m Tr∆∞·ªùng An */
            --primary-light: #28a745;
            --accent-color: #ffc107; /* V√†ng taxi */
            --text-dark: #2c3e50;
            --text-light: #ecf0f1;
            --bg-color: #f4f7f6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            margin: 0; padding: 0; font-family: 'Roboto', sans-serif;
            background: var(--bg-color); color: var(--text-dark);
            padding-bottom: 80px; /* Ch·ª´a ch·ªó cho footer n·∫øu c√≥ */
        }

        /* --- HEADER --- */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white; padding: 20px 15px;
            text-align: center;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,100,0,0.3);
            position: relative;
            z-index: 1000;
        }
        .app-title { font-size: 22px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        .app-subtitle { font-size: 13px; opacity: 0.9; margin-top: 5px; font-weight: 300; }
        .hotline-btn {
            display: inline-block; background: white; color: var(--primary-color);
            padding: 5px 15px; border-radius: 20px; font-weight: 700;
            margin-top: 10px; text-decoration: none; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- CONTAINER --- */
        .container { max-width: 700px; margin: -20px auto 0; padding: 15px; position: relative; z-index: 2; }
        
        /* --- CARD STYLES --- */
        .card {
            background: white; border-radius: var(--radius);
            padding: 20px; margin-bottom: 15px;
            box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05);
        }
        .section-title {
            font-size: 16px; font-weight: 700; color: var(--primary-color);
            margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
            text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 8px;
        }

        /* --- INPUT FIELDS (N√ÇNG C·∫§P) --- */
        .input-group { position: relative; margin-bottom: 15px; }
        .input-wrapper { position: relative; display: flex; align-items: center; }
        
        input, select {
            width: 100%; padding: 14px 16px; padding-right: 90px; /* Ch·ª´a ch·ªó cho n√∫t */
            border: 1px solid #e0e0e0; border-radius: 10px;
            font-size: 16px; transition: all 0.3s ease;
            background: #fafafa;
        }
        input:focus, select:focus {
            border-color: var(--primary-light); background: #fff;
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.1);
        }
        
        /* --- N√öT X V√Ä N√öT MAP --- */
        .input-tools {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            display: flex; align-items: center; gap: 6px;
        }
        .btn-clear {
            width: 24px; height: 24px; border-radius: 50%; border: none;
            background: #e0e0e0; color: #555; font-size: 12px;
            cursor: pointer; display: none; align-items: center; justify-content: center;
        }
        .btn-clear.show { display: flex; }
        
        .btn-map {
            background: var(--primary-light); color: white; border: none;
            padding: 6px 10px; border-radius: 6px; font-size: 12px; font-weight: bold;
            cursor: pointer; display: flex; align-items: center; gap: 4px;
        }
        
        /* --- G·ª¢I √ù ƒê·ªäA CH·ªà --- */
        .autocomplete-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            z-index: 999; max-height: 250px; overflow-y: auto;
            display: none; border: 1px solid #eee; border-top: none;
        }
        .autocomplete-item {
            padding: 12px; border-bottom: 1px solid #f1f1f1;
            font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .autocomplete-item i { color: var(--primary-light); }
        .autocomplete-item:hover { background: #f9f9f9; }

        /* --- N√öT B·∫§M CH√çNH --- */
        .btn-main {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            color: white; font-size: 18px; font-weight: 900;
            text-transform: uppercase; cursor: pointer;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
            transition: transform 0.2s; margin-top: 10px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* --- K·∫æT QU·∫¢ T√çNH TO√ÅN --- */
        #result-panel { display: none; animation: slideUp 0.4s ease; }
        .price-display {
            background: #e8f5e9; color: var(--primary-color);
            padding: 15px; border-radius: 10px; text-align: center;
            margin-bottom: 15px; border: 1px dashed var(--primary-light);
        }
        .big-price { font-size: 32px; font-weight: 900; display: block; margin-top: 5px; }
        
        .trip-details { list-style: none; padding: 0; margin: 0; font-size: 14px; }
        .trip-details li {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        /* --- ACTION BUTTONS --- */
        .action-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn-action {
            flex: 1; padding: 14px; border-radius: 10px; text-align: center;
            text-decoration: none; color: white; font-weight: bold; border: none; cursor: pointer;
        }
        .zalo-bg { background: #0068ff; }
        .mail-bg { background: #db4437; }

        /* --- MAP CONTAINER --- */
        #map-display { height: 350px; width: 100%; border-radius: 12px; margin-top: 20px; border: 2px solid white; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }

        /* --- MODAL FULLSCREEN (MAP PICKER) --- */
        .modal-fs {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: none; flex-direction: column;
        }
        .modal-head {
            padding: 15px; background: var(--primary-color); color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-body { flex: 1; position: relative; }
        .center-pin {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%);
            z-index: 1000; width: 40px; height: 40px; pointer-events: none;
        }
        .modal-foot { padding: 15px; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }

        /* --- KILL SWITCH SCREEN --- */
        #maintenance-screen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: white; z-index: 10000; display: none;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="maintenance-screen">
    <i class="fas fa-tools" style="font-size: 60px; color: #ffc107; margin-bottom: 20px;"></i>
    <h2>H·ªá Th·ªëng ƒêang B·∫£o Tr√¨</h2>
    <p>Vui l√≤ng quay l·∫°i sau ho·∫∑c li√™n h·ªá Hotline.</p>
    <a href="tel:0847526893" class="hotline-btn">‚òéÔ∏è 0847526893</a>
</div>

<header>
    <div class="app-title">TR∆Ø·ªúNG AN DRIVING</div>
    <div class="app-subtitle">Uy T√≠n - An To√†n - Chuy√™n Nghi·ªáp</div>
    <a href="tel:0847526893" class="hotline-btn"><i class="fas fa-phone-alt"></i> 084.752.6893</a>
</header>

<div class="container">
    
    <div class="card">
        <div class="section-title"><i class="fas fa-user"></i> Th√¥ng tin li√™n h·ªá</div>
        <div class="input-group">
            <div class="input-wrapper">
                <input type="tel" id="phone" placeholder="Nh·∫≠p S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n">
                <div class="input-tools">
                    <button class="btn-clear" onclick="clearField('phone')"><i class="fas fa-times"></i></button>
                </div>
            </div>
        </div>
        <div class="input-group">
             <div class="input-wrapper">
                <input type="datetime-local" id="pickupTime">
             </div>
        </div>
    </div>

    <div class="card">
        <div class="section-title">
            <i class="fas fa-map-marker-alt"></i> L·ªô tr√¨nh
            <span style="font-size: 11px; margin-left: auto; color: #007bff; cursor: pointer;" onclick="getUserLocation()">
                <i class="fas fa-crosshairs"></i> V·ªã tr√≠ hi·ªán t·∫°i
            </span>
        </div>

        <label style="font-size: 13px; font-weight: bold; color: #666;">ƒêi·ªÉm ƒë√≥n:</label>
        <div class="input-group">
            <div class="input-wrapper">
                <input type="text" id="pickup" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c ch·ªçn b·∫£n ƒë·ªì..." autocomplete="off">
                <div class="input-tools">
                    <button class="btn-clear" onclick="clearField('pickup')"><i class="fas fa-times"></i></button>
                    <button class="btn-map" onclick="openMapModal('pickup')"><i class="fas fa-map"></i> B·∫£n ƒë·ªì</button>
                </div>
            </div>
            <div id="suggest-pickup" class="autocomplete-list"></div>
        </div>

        <div id="stops-list"></div>
        <button onclick="addStopInput()" style="background: none; border: 1px dashed var(--primary-color); width: 100%; padding: 10px; color: var(--primary-color); border-radius: 8px; cursor: pointer; font-weight: 600; margin-bottom: 15px;">
            <i class="fas fa-plus-circle"></i> Th√™m ƒëi·ªÉm d·ª´ng
        </button>

        <label style="font-size: 13px; font-weight: bold; color: #666;">ƒêi·ªÉm ƒë·∫øn:</label>
        <div class="input-group">
            <div class="input-wrapper">
                <input type="text" id="dropoff" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c ch·ªçn b·∫£n ƒë·ªì..." autocomplete="off">
                <div class="input-tools">
                    <button class="btn-clear" onclick="clearField('dropoff')"><i class="fas fa-times"></i></button>
                    <button class="btn-map" onclick="openMapModal('dropoff')"><i class="fas fa-map"></i> B·∫£n ƒë·ªì</button>
                </div>
            </div>
            <div id="suggest-dropoff" class="autocomplete-list"></div>
        </div>
    </div>

    <div class="card">
        <div class="section-title"><i class="fas fa-car"></i> T√πy ch·ªçn xe</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <select id="carType">
                <option value="4">üöó Xe 4 ch·ªó (10k/km)</option>
                <option value="7">üöê Xe 7 ch·ªó (12k/km)</option>
            </select>
            <select id="tripType" onchange="toggleWaitOption()">
                <option value="1">‚û°Ô∏è 1 Chi·ªÅu</option>
                <option value="2">üîÑ 2 Chi·ªÅu (-40% v·ªÅ)</option>
            </select>
        </div>

        <div id="wait-option" style="display: none; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 10px;">
            <label style="font-size: 12px; font-weight: bold;">‚è≥ Th·ªùi gian ch·ªù (Mi·ªÖn ph√≠ 3h ƒë·∫ßu):</label>
            <div class="input-wrapper" style="margin-top: 5px;">
                <input type="number" id="waitingTime" placeholder="Nh·∫≠p s·ªë gi·ªù ch·ªù..." min="0">
            </div>
        </div>

        <div style="margin-top: 10px;">
            <label style="font-size: 12px; font-weight: bold;">üßë‚Äç‚úàÔ∏è Ch·ªçn t√†i x·∫ø:</label>
            <select id="driverSelect" style="margin-top: 5px;">
                <option value="Tr∆∞·ªùng An">‚≠ê H·ªá th·ªëng Tr∆∞·ªùng An (Nhanh nh·∫•t)</option>
                <option value="Thanh Loan">üë©‚Äçü¶∞ Thanh Loan</option>
                <option value="ƒê√¨nh T√¢m">üë®‚Äç‚úàÔ∏è ƒê√¨nh T√¢m</option>
            </select>
        </div>
    </div>

    <button class="btn-main" id="btn-calc" onclick="calculateRoute()">
        <i class="fas fa-calculator"></i> T√≠nh Gi√° C∆∞·ªõc
    </button>

    <div id="map-display"></div>

    <div id="result-panel" class="card" style="margin-top: 20px;">
        <div class="price-display">
            <span>üí∞ T·ªîNG CHI PH√ç D·ª∞ KI·∫æN</span>
            <span class="big-price" id="total-price">0 ƒë</span>
            <small id="price-note" style="display: block; margin-top: 5px; color: #666;">(ƒê√£ bao g·ªìm c√°c ∆∞u ƒë√£i)</small>
        </div>
        
        <ul class="trip-details">
            <li><span>üìè Qu√£ng ƒë∆∞·ªùng:</span> <strong id="res-dist">0 km</strong></li>
            <li><span>‚è± Th·ªùi gian d·ª± ki·∫øn:</span> <strong id="res-time">0 ph√∫t</strong></li>
            <li id="row-return" style="display: none; color: var(--primary-color);">
                <span>üéÅ ∆Øu ƒë√£i 2 chi·ªÅu:</span> <strong>Gi·∫£m 40% chi·ªÅu v·ªÅ</strong>
            </li>
            <li id="row-wait" style="display: none;">
                <span>‚è≥ Ph√≠ ch·ªù:</span> <strong id="res-wait-fee">0 ƒë</strong>
            </li>
        </ul>

        <div class="action-row">
            <button class="btn-action zalo-bg" onclick="bookNow('zalo')"><i class="fas fa-comment-dots"></i> ƒê·∫∑t Zalo</button>
            <button class="btn-action mail-bg" onclick="bookNow('mail')"><i class="fas fa-envelope"></i> G·ª≠i Email</button>
        </div>
    </div>
</div>

<div id="map-modal" class="modal-fs">
    <div class="modal-head">
        <span><i class="fas fa-map-marked-alt"></i> Ch·ªçn v·ªã tr√≠</span>
        <button onclick="closeMapModal()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
        <div id="picker-map" style="width:100%; height:100%;"></div>
        <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="center-pin" alt="pin">
    </div>
    <div class="modal-foot">
        <p style="text-align:center; margin:0 0 10px 0; font-size:13px; color:#666;">Di chuy·ªÉn b·∫£n ƒë·ªì ƒë·ªÉ ghim v·ªã tr√≠ ch√≠nh x√°c</p>
        <button class="btn-main" onclick="confirmLocation()">‚úÖ X√ÅC NH·∫¨N V·ªä TR√ç N√ÄY</button>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH H·ªÜ TH·ªêNG ---
    const CFG = {
        price4: 10000,
        price7: 12000,
        waitFee: 50000, // Sau 3h
        freeWait: 3,
        discountDist: 45, // km
        phone: "0847526893"
    };

    // --- BI·∫æN TO√ÄN C·ª§C ---
    let mainMap, routeLayer;
    let pickerMap, currentInputId;
    let stopCounter = 0;

    // --- 1. KH·ªûI T·∫†O KHI LOAD TRANG ---
    window.onload = function() {
        initMainMap();
        checkKillSwitch(); // Ki·ªÉm tra tr·∫°ng th√°i server
        setupInputs();
        
        // Set th·ªùi gian m·∫∑c ƒë·ªãnh
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30 - now.getTimezoneOffset());
        document.getElementById('pickupTime').value = now.toISOString().slice(0,16);
    };

    // --- 2. LOGIC KILL SWITCH (M√î PH·ªéNG) ---
    function checkKillSwitch() {
        // ·ªû ƒë√¢y b·∫°n c√≥ th·ªÉ d√πng fetch() g·ªçi ƒë·∫øn JSONBin.
        // Hi·ªán t·∫°i t√¥i ƒë·ªÉ m·∫∑c ƒë·ªãnh l√† TRUE (Ho·∫°t ƒë·ªông).
        // N·∫øu mu·ªën t·∫Øt web, ƒë·ªïi isLive = false;
        const isLive = true; 
        if(!isLive) {
            document.getElementById('maintenance-screen').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }

    // --- 3. X·ª¨ L√ù INPUT & N√öT X√ìA ---
    function setupInputs() {
        const inputs = ['phone', 'pickup', 'dropoff'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', function() {
                toggleClearBtn(this);
                if(id !== 'phone') searchAddress(this);
            });
            // Focus s·ª± ki·ªán
            el.addEventListener('focus', () => toggleClearBtn(el));
        });
    }

    function toggleClearBtn(input) {
        const btn = input.parentElement.querySelector('.btn-clear');
        if(btn) {
            if(input.value.trim().length > 0) btn.classList.add('show');
            else btn.classList.remove('show');
        }
    }

    function clearField(id) {
        const input = document.getElementById(id);
        input.value = '';
        // X√≥a data ·∫©n
        delete input.dataset.lat;
        delete input.dataset.lon;
        toggleClearBtn(input);
        input.focus();
    }

    // --- 4. T√åM KI·∫æM ƒê·ªäA CH·ªà (NOMINATIM) ---
    let debounce;
    function searchAddress(input) {
        clearTimeout(debounce);
        const listId = input.id === 'pickup' ? 'suggest-pickup' : 
                       input.id === 'dropoff' ? 'suggest-dropoff' : 
                       `suggest-${input.id}`;
        
        const list = document.getElementById(listId);
        if(!list) return;

        if(input.value.length < 3) { list.style.display = 'none'; return; }

        debounce = setTimeout(() => {
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input.value)}&countrycodes=vn&limit=5`)
            .then(r => r.json())
            .then(data => {
                list.innerHTML = '';
                if(data.length === 0) { list.style.display = 'none'; return; }
                
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item';
                    div.innerHTML = `<i class="fas fa-map-marker-alt"></i> <span>${item.display_name}</span>`;
                    div.onclick = () => {
                        input.value = item.display_name;
                        input.dataset.lat = item.lat;
                        input.dataset.lon = item.lon;
                        list.style.display = 'none';
                        toggleClearBtn(input);
                    };
                    list.appendChild(div);
                });
                list.style.display = 'block';
            });
        }, 400);
    }
    
    // ·∫®n g·ª£i √Ω khi click ra ngo√†i
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.input-group')) {
            document.querySelectorAll('.autocomplete-list').forEach(l => l.style.display = 'none');
        }
    });

    // --- 5. ƒêI·ªÇM D·ª™NG ---
    function addStopInput() {
        stopCounter++;
        const id = `stop-${stopCounter}`;
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `
            <div class="input-wrapper">
                <input type="text" id="${id}" placeholder="ƒêi·ªÉm d·ª´ng ${stopCounter}..." oninput="toggleClearBtn(this); searchAddress(this)">
                <div class="input-tools">
                    <button class="btn-clear" onclick="this.parentElement.parentElement.parentElement.remove()"><i class="fas fa-trash-alt" style="color:red"></i></button>
                    <button class="btn-map" onclick="openMapModal('${id}')"><i class="fas fa-map"></i></button>
                </div>
            </div>
            <div id="suggest-${id}" class="autocomplete-list"></div>
        `;
        document.getElementById('stops-list').appendChild(div);
    }

    // --- 6. B·∫¢N ƒê·ªí CH√çNH & B·∫¢N ƒê·ªí CH·ªåN (LEAFLET) ---
    function initMainMap() {
        mainMap = L.map('map-display').setView([10.7769, 106.7009], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(mainMap);
    }

    function openMapModal(inputId) {
        currentInputId = inputId;
        document.getElementById('map-modal').style.display = 'flex';
        
        if(!pickerMap) {
            pickerMap = L.map('picker-map').setView([10.7769, 106.7009], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);
        }
        
        setTimeout(() => pickerMap.invalidateSize(), 200);
        
        // N·∫øu input ƒë√£ c√≥ t·ªça ƒë·ªô, bay t·ªõi ƒë√≥
        const inp = document.getElementById(inputId);
        if(inp.dataset.lat) {
            pickerMap.setView([inp.dataset.lat, inp.dataset.lon], 16);
        } else if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                pickerMap.setView([p.coords.latitude, p.coords.longitude], 15);
            });
        }
    }

    function closeMapModal() {
        document.getElementById('map-modal').style.display = 'none';
    }

    function confirmLocation() {
        const center = pickerMap.getCenter();
        const inp = document.getElementById(currentInputId);
        
        inp.dataset.lat = center.lat;
        inp.dataset.lon = center.lng;
        inp.value = `ƒêang l·∫•y ƒë·ªãa ch·ªâ...`; // T·∫°m th·ªùi
        
        // Reverse Geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`)
        .then(r => r.json())
        .then(data => {
            inp.value = data.display_name || `${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}`;
            toggleClearBtn(inp);
        })
        .catch(() => {
            inp.value = `${center.lat.toFixed(5)}, ${center.lng.toFixed(5)}`;
        });
        
        closeMapModal();
    }
    
    function getUserLocation() {
        if(!navigator.geolocation) { alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS"); return; }
        const inp = document.getElementById('pickup');
        inp.placeholder = "ƒêang ƒë·ªãnh v·ªã...";
        
        navigator.geolocation.getCurrentPosition(p => {
            const {latitude, longitude} = p.coords;
            inp.dataset.lat = latitude;
            inp.dataset.lon = longitude;
            
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`)
            .then(r => r.json())
            .then(d => {
                inp.value = d.display_name;
                toggleClearBtn(inp);
            });
        }, () => alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. H√£y b·∫≠t GPS!"));
    }

    // --- 7. T√çNH GI√Å V√Ä V·∫º ƒê∆Ø·ªúNG (OSRM API) ---
    function toggleWaitOption() {
        const type = document.getElementById('tripType').value;
        document.getElementById('wait-option').style.display = (type === '2') ? 'block' : 'none';
    }

    async function calculateRoute() {
        const p = document.getElementById('pickup');
        const d = document.getElementById('dropoff');
        
        if(!p.dataset.lat || !d.dataset.lat) {
            alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒêi·ªÉm ƒê√≥n v√† ƒêi·ªÉm ƒê·∫øn t·ª´ g·ª£i √Ω ho·∫∑c b·∫£n ƒë·ªì!");
            return;
        }

        const btn = document.getElementById('btn-calc');
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...`;
        btn.disabled = true;

        // X√¢y d·ª±ng chu·ªói t·ªça ƒë·ªô
        let points = [];
        points.push(`${p.dataset.lon},${p.dataset.lat}`);
        
        document.querySelectorAll('#stops-list input').forEach(s => {
            if(s.dataset.lat) points.push(`${s.dataset.lon},${s.dataset.lat}`);
        });
        
        points.push(`${d.dataset.lon},${d.dataset.lat}`);
        const coordString = points.join(';');

        try {
            const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coordString}?overview=full&geometries=geojson`);
            const data = await res.json();

            if(data.code !== 'Ok') throw new Error("Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng");

            const route = data.routes[0];
            const km = route.distance / 1000;
            const mins = Math.round(route.duration / 60);

            // V·∫Ω b·∫£n ƒë·ªì
            if(routeLayer) mainMap.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, {
                style: { color: '#006400', weight: 6, opacity: 0.8 }
            }).addTo(mainMap);
            mainMap.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

            // --- T√çNH TI·ªÄN ---
            const carType = document.getElementById('carType').value;
            const tripType = document.getElementById('tripType').value;
            const unitPrice = (carType === '4') ? CFG.price4 : CFG.price7;
            const waitH = parseFloat(document.getElementById('waitingTime').value) || 0;

            let total = Math.round(km * unitPrice);
            let returnFee = 0;
            let waitCost = 0;

            // Logic 2 chi·ªÅu
            if(tripType === '2') {
                if(km >= CFG.discountDist) {
                    returnFee = Math.round(total * 0.6); // Gi·∫£m 40%
                    document.querySelector('#row-return strong').innerText = "Gi·∫£m 40% chi·ªÅu v·ªÅ";
                } else {
                    returnFee = total;
                    document.querySelector('#row-return strong').innerText = "Nguy√™n gi√°";
                }
                total += returnFee;

                // Logic ch·ªù
                if(waitH > CFG.freeWait) {
                    waitCost = (waitH - CFG.freeWait) * CFG.waitFee;
                    total += waitCost;
                }
            }

            // Hi·ªÉn th·ªã
            document.getElementById('result-panel').style.display = 'block';
            document.getElementById('total-price').innerText = total.toLocaleString('vi-VN') + ' ƒë';
            document.getElementById('res-dist').innerText = km.toFixed(1) + ' km';
            document.getElementById('res-time').innerText = mins + ' ph√∫t';
            
            document.getElementById('row-return').style.display = (tripType === '2') ? 'flex' : 'none';
            
            if(waitCost > 0) {
                document.getElementById('row-wait').style.display = 'flex';
                document.getElementById('res-wait-fee').innerText = waitCost.toLocaleString() + ' ƒë';
            } else {
                document.getElementById('row-wait').style.display = 'none';
            }

            // Scroll xu·ªëng
            document.getElementById('result-panel').scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            alert("Kh√¥ng th·ªÉ t√≠nh l·ªô tr√¨nh. Vui l√≤ng th·ª≠ l·∫°i ƒë·ªãa ch·ªâ g·∫ßn h∆°n.");
        } finally {
            btn.innerHTML = `<i class="fas fa-calculator"></i> T√≠nh Gi√° C∆∞·ªõc`;
            btn.disabled = false;
        }
    }

    // --- 8. ƒê·∫∂T XE (G·ª¨I TIN) ---
    function bookNow(method) {
        const phone = document.getElementById('phone').value || "Ch∆∞a nh·∫≠p";
        const pickup = document.getElementById('pickup').value;
        const dropoff = document.getElementById('dropoff').value;
        const time = document.getElementById('pickupTime').value.replace('T', ' ');
        const car = document.getElementById('carType').selectedOptions[0].text;
        const trip = document.getElementById('tripType').selectedOptions[0].text;
        const driver = document.getElementById('driverSelect').value;
        const price = document.getElementById('total-price').innerText;

        let msg = `üöñ ƒê·∫∂T XE TR∆Ø·ªúNG AN\n-------------------\nüìû Kh√°ch: ${phone}\nüïí Gi·ªù: ${time}\nüìç ƒê√≥n: ${pickup}\nüèÅ ƒê·∫øn: ${dropoff}\nüöò Xe: ${car}\nüîÑ Lo·∫°i: ${trip}\nüßë‚Äç‚úàÔ∏è T√†i x·∫ø: ${driver}\nüí∞ T·ªîNG: ${price}`;
        
        if(document.getElementById('tripType').value === '2') {
            const rawPrice = parseInt(price.replace(/\D/g,''));
            msg += `\nüí≥ C·ªçc (20%): ${(rawPrice * 0.2).toLocaleString('vi-VN')} ƒë`;
        }

        if(method === 'zalo') {
            navigator.clipboard.writeText(msg);
            alert("ƒê√£ copy ƒë∆°n h√†ng! ƒêang chuy·ªÉn sang Zalo...");
            window.open(`https://zalo.me/${CFG.phone}`, '_blank');
        } else {
            window.location.href = `mailto:truongan.driving@gmail.com?subject=ƒê·∫∂T XE TAXI&body=${encodeURIComponent(msg)}`;
        }
    }
</script>

</body>
</html>
