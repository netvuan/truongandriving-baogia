<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* CƒÇN CH·ªàNH CSS KH·∫ÆC PH·ª§C L·ªñI GIAO DI·ªÜN V√Ä MINI MAP */
    :root{--green:#28a745;--muted:#6c757d;}
    *{box-sizing:border-box}
    /* ƒê·∫£m b·∫£o n·ªôi dung ch√≠nh r·ªông 100% */
    #main-content {
      background:#f4f6f8;
      padding: 0;
      width: 100%;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    /* CƒÉn gi·ªØa cho thi·∫øt b·ªã l·ªõn */
    .container{padding:12px; max-width:720px; margin:0 auto;} 
    
    /* C·∫£i thi·ªán cƒÉn ch·ªânh chung */
    .label-row{display:flex;align-items:center;gap:8px;margin-top:10px}
    .label-row h3{margin:0;font-size:16px}

    /* FIX L·ªñI L·ªÜCH H√ÄNG NG√îN NG·ªÆ */
    .language-row-fix {
        display: flex;
        justify-content: space-between; /* ƒê·∫©y hai ph·∫ßn t·ª≠ sang hai b√™n */
        align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
        margin-bottom:12px;
    }
    #languageSelector {
        padding: 8px 10px !important; /* Tinh ch·ªânh padding ri√™ng */
        border-radius: 6px; 
        font-size:16px;
        width: auto; 
        min-width: 120px;
        max-width: 50%;
    }

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    /* FIX L·ªñI L·ªÜCH TR∆Ø·ªúNG NH·∫¨P LI·ªÜU: ƒê·∫£m b·∫£o Input row cƒÉn ch·ªânh ƒë√∫ng */
    .input-row{position:relative;margin-top:8px;}
    .input-row .clear-btn {
        position: absolute; 
        right: 80px; /* Di chuy·ªÉn xa h∆°n ƒë·ªÉ tr√°nh Map button */
        top: 50%; 
        transform: translateY(-50%); /* CƒÉn gi·ªØa d·ªçc */
        background: #f0f0f0; color: #666; border: none; padding: 3px 6px; 
        border-radius: 4px; font-weight: 700; cursor: pointer; line-height: 1;
        font-size: 14px; display: none; 
        z-index: 1000;
    }
    /* FIX L·ªñI MAP BUTTON */
    .map-btn{
        position:absolute; 
        right:8px; /* C·ªë ƒë·ªãnh v·ªã tr√≠ b√™n ph·∫£i */
        top: 8px; 
        background:var(--green); 
        color:#fff; border:0; padding:6px 8px; border-radius:6px; 
        font-weight:700; cursor:pointer;
        line-height: 1.5; /* ƒê·∫£m b·∫£o chi·ªÅu cao n√∫t kh·ªõp */
        z-index: 1000; /* ƒê·∫£m b·∫£o n√∫t lu√¥n n·∫±m tr√™n input */
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 85px 12px 14px; /* TƒÉng padding ph·∫£i ƒë·ªÉ tr√°nh n√∫t Map/Clear */
      border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    /* S·ª≠a padding cho c√°c input kh√¥ng c√≥ n√∫t Map */
    /* ƒê√£ th√™m #languageSelector v√†o ƒë√¢y, nh∆∞ng ƒë√£ fix b·∫±ng CSS ri√™ng b√™n tr√™n */
    #customerPhone, #pickupDateTime, #carType, #driverRequest, #tripType, #waiting {
        padding: 12px 14px !important;
    }
    /* ƒê·∫£m b·∫£o n√∫t clear kh√¥ng b·ªã ·∫©n b·ªüi input */
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: block; 
    }
    
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn:disabled { background-color: #6c757d !important; cursor: not-allowed !important; opacity: 0.7; } /* TH√äM FIX N√öT DISABLED */

    
    /* KH·∫ÆC PH·ª§C L·ªñI MINI MAP M·∫§T: ƒê·∫£m b·∫£o chi·ªÅu cao ƒë∆∞·ª£c thi·∫øt l·∫≠p */
    #map{
        height:320px;
        margin-top:12px;
        border-radius:8px;
        overflow:hidden;
        z-index: 1; /* ƒê·∫£m b·∫£o b·∫£n ƒë·ªì kh√¥ng b·ªã ·∫©n b·ªüi c√°c ph·∫ßn t·ª≠ kh√°c */
    }
    
    .suggestions{position:absolute; left:0; right:0; top:calc(100% + 6px); background:#fff;border:1px solid #ddd;border-radius:8px;max-height:220px;overflow:auto; -webkit-overflow-scrolling:touch; z-index:1200; box-shadow:0 8px 20px rgba(0,0,0,0.08)}
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:10px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:8px}
    .way-remove{position:absolute;right:6px;top:6px;background:#ff6b6b;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer; z-index: 1000;}

    /* ... C√°c style modal v√† driver-select gi·ªØ nguy√™n ... */
    .disabled-form { pointer-events: none; opacity: 0.6; transition: opacity 0.3s; }
    #serviceOffNotice { margin-top: 12px; padding: 10px; background: #dc3545; color: white; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; padding: 20px; animation: fadeIn 0.3s; }
    .modal-content { background: #fff; border-radius: 12px; padding: 20px; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s; }
    .modal-content h3 { margin-top: 0; color: var(--green); font-size: 20px; text-align: center; }
    #modal-text { white-space: pre-wrap; font-family: monospace; font-size: 14px; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 15px; }
    .modal-actions { display: flex; gap: 10px; }
    .modal-actions button { flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; }
    #copyModalBtn { background: #ffc107; color: #333; } 
    #zaloModalBtn { background: #0068ff; color: #fff; }
    #closeModalBtn { background: #ccc; color: #333; }
    #phoneModal .modal-content { background: #f8d7da; border: 1px solid #f5c6cb; }
    #phoneModal h3 { color: #721c24; }
    #phoneModal #inputPhoneForBooking { margin-top: 15px; }
    #phoneModal #confirmPhoneBtn { background: #007bff; color: white; }
    #depositModal .modal-content { background: #d4edda; border: 1px solid #c3e6cb; }
    #depositModal h3 { color: #155724; }
    #depositModal p { margin-bottom: 15px; }
    #depositModal #depositAmount { font-weight: 800; font-size: 20px; color: #007bff; background: #fff; padding: 5px 10px; border-radius: 5px; display: inline-block; }
    #depositModal #confirmDepositBtn { background: var(--green); color: white; }
    #driverRequest { font-size: 18px; font-weight: 600; border: 2px solid var(--green); }
    .driver-option-highlight { color: red; font-weight: 900 !important; background-color: #f7f7f7; }
    .driver-option-avatar { margin-right: 5px; font-size: 1.1em; vertical-align: middle; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  </style>
</head>
<body>
<div id="main-content">
  <header>
    üöñ D·ªãch V·ª• Taxi<br>
    Tr∆∞·ªùng An Driving<br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">‚òéÔ∏è 0847526893</a> 
  </header>

  <div class="container">

    <div class="language-row-fix">
        <h3 style="margin:0;">üåé Ch·ªçn Ng√¥n ng·ªØ / Language</h3>
        <select id="languageSelector">
            <option value="vn">üáªüá≥ Ti·∫øng Vi·ªát</option>
            <option value="en">üá¨üáß English</option>
            <option value="cn">üá®üá≥ ‰∏≠Êñá (Chinese)</option>
        </select>
    </div>
    <div id="serviceOffNotice" style="display:none;">
      </div>
    
    <div id="instructionText" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;">
      üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...
    </div>

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3>üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n (Kh√¥ng b·∫Øt bu·ªôc ƒë·ªÉ T√≠nh gi√°)</h3></div>
      <input id="customerPhone" type="tel" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel">

      <div class="label-row">
        <h3>üìç ƒêi·ªÉm ƒë√≥n</h3>
        <div id="location-status-wrapper" style="display: flex; align-items: center; gap: 8px;">
          <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;">(ƒêang t√¨m v·ªã tr√≠...)</span>
          <i id="reloadLocationBtn" title="Th·ª≠ l·∫•y l·∫°i v·ªã tr√≠">üîÑ</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)">
        <button class="clear-btn" data-input-id="pickup">‚úñ</button> 
        <button class="map-btn" id="pick-from-map">B·∫£n ƒë·ªì</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div>

      <div class="label-row" style="margin-top:12px"><h3>üïí Ng√†y & Gi·ªù ƒë√≥n</h3></div>
      <input id="pickupDateTime" type="datetime-local">

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn">Ôºã Th√™m ƒëi·ªÉm d·ª´ng</button>

      <div class="label-row"><h3>üèÅ ƒêi·ªÉm ƒë·∫øn</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi">
        <button class="clear-btn" data-input-id="dropoff">‚úñ</button> 
        <button class="map-btn" id="pick-to-map">B·∫£n ƒë·ªì</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row" style="margin-top:12px"><h3>üöò Lo·∫°i xe</h3></div>
      <select id="carType">
        <option value="4 ch·ªó (10.000ƒë/km)">Xe 4 ch·ªó (10.000ƒë/km)</option> 
        <option value="7 ch·ªó (12.000ƒë/km)">Xe 7 ch·ªó (12.000ƒë/km)</option> 
      </select>
      
      <div class="label-row" style="margin-top:12px">
        <h3>
            üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu T√†i x·∫ø 
            <span class="driver-option-avatar" title="Icon n√†y c√≥ th·ªÉ thay b·∫±ng Avatar">üë§</span>
        </h3>
      </div>
      <select id="driverRequest">
        <option value="Tr∆∞·ªùng An Driving" class="driver-option-highlight">
            ‚≠ê Tr∆∞·ªùng An Driving (M·∫∑c ƒë·ªãnh)
        </option>
        <option value="Thanh Loan">üë∏ Thanh Loan</option>
        <option value="ƒê√¨nh T√¢m">üßë‚Äç‚úàÔ∏è ƒê√¨nh T√¢m</option>
        <option value="H·∫£i ƒêƒÉng">üßë‚Äç‚úàÔ∏è H·∫£i ƒêƒÉng</option>
        <option value="L√™ T√¢m">üßë‚Äç‚úàÔ∏è L√™ T√¢m</option>
        <option value="Nguy·ªÖn Th·∫£o">üë∏ Nguy·ªÖn Th·∫£o</option>
        <option value="Qu·ªëc D≈©ng">üßë‚Äç‚úàÔ∏è Qu·ªëc D≈©ng</option>
        <option value="T√¢n H·ªì">üßë‚Äç‚úàÔ∏è T√¢n H·ªì</option>
        <option value="Tr·∫ßn Vinh">üßë‚Äç‚úàÔ∏è Tr·∫ßn Vinh</option>
        <option value="Xu√¢n Phong">üßë‚Äç‚úàÔ∏è Xu√¢n Phong</option>
      </select>
      <div class="label-row" style="margin-top:12px"><h3>üöó Lo·∫°i chuy·∫øn ƒëi</h3></div>
      <select id="tripType">
        <option value="1">1 chi·ªÅu</option>
        <option value="2">2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)</option>
      </select>

      <div id="waitingWrapper"> 
        <div class="label-row" style="margin-top:12px"><h3>‚è≥ Th·ªùi gian ch·ªù (gi·ªù)</h3></div>
        <input id="waiting" type="number" min="0" value="0" placeholder="Nh·∫≠p s·ªë gi·ªù ch·ªù">
      </div>

      <button class="calc-btn" id="calc-btn" disabled>üí∞ T√≠nh gi√°</button>
    </div> 
    
    <div id="map"></div>

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText">‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng: ‚Äî</div>
      </div>

      <div class="price-title">üíµ Gi√° d·ª± ki·∫øn</div>
      <div class="price-value" id="priceValue">‚Äî ƒë</div>

      <div class="price-break" id="priceBreak"></div>

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst">‚è± Th·ªùi gian d·ª± ki·∫øn: ‚Äî ph√∫t</div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo">üïí Ng√†y gi·ªù ƒë√≥n: ‚Äî</div>
    </div>

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" href="javascript:void(0);" style="display:none;">üì± ƒê·∫∑t qua Zalo</a>
      <a id="mailBtn" class="mail" href="javascript:void(0);" style="display:none;">üìß ƒê·∫∑t qua Mail</a>
    </div>

    <div class="note">
      üìå Ghi ch√∫: Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).
      <br>
      **Th·ªùi gian ch·ªù:**
      <ul>
        <li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li>
        <li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li>
        <li>Th·ªùi gian ch·ªù ƒë∆∞·ª£c t√≠nh t·ª´ khi h√†nh kh√°ch **ho√†n t·∫•t vi·ªác xu·ªëng xe t·∫°i ƒëi·ªÉm ƒë·∫øn** cho ƒë·∫øn khi xe quay tr·ªü l·∫°i ƒë√≥n ƒë·ªÉ v·ªÅ ƒëi·ªÉm xu·∫•t ph√°t ban ƒë·∫ßu.</li>
      </ul>
      Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.
    </div>
  </div>
</div>

<div id="depositModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>üìù Y√™u c·∫ßu ƒê·∫∑t c·ªçc cho Chuy·∫øn 2 Chi·ªÅu</h3>
        <p>
            **Qu√Ω kh√°ch vui l√≤ng l∆∞u √Ω:**<br>
            ƒê·ªÉ x√°c nh·∫≠n v√† ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• cho chuy·∫øn ƒëi **Hai chi·ªÅu** c·ªßa Qu√Ω kh√°ch, ch√∫ng t√¥i k√≠nh mong Qu√Ω kh√°ch **ƒë·∫∑t c·ªçc tr∆∞·ªõc 20%** tr√™n t·ªïng gi√° c∆∞·ªõc d·ª± ki·∫øn.
        </p>
        <p style="text-align:center; font-size:18px;">
            S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn: <span id="depositAmount">0 ƒë</span>
        </p>
        <p>
            Khi nh√¢n vi√™n **Tr∆∞·ªùng An Driving** ph·∫£n h·ªìi qua Zalo, ch√∫ng t√¥i s·∫Ω g·ª≠i **h∆∞·ªõng d·∫´n thanh to√°n c·ª• th·ªÉ** (chuy·ªÉn kho·∫£n) ƒë·ªÉ ho√†n t·∫•t th·ªß t·ª•c ƒë·∫∑t c·ªçc.
        </p>
        <p style="font-size:14px; color:#555;">
            **L∆∞u √Ω:** Ph·∫ßn c√≤n l·∫°i c·ªßa c∆∞·ªõc ph√≠ s·∫Ω ƒë∆∞·ª£c thanh to√°n tr·ª±c ti·∫øp cho t√†i x·∫ø sau khi k·∫øt th√∫c chuy·∫øn ƒëi.
            Xin ch√¢n th√†nh c·∫£m ∆°n Qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng d·ªãch v·ª•.
        </p>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmDepositBtn" style="width:100%;">ƒê√£ hi·ªÉu v√† Ti·∫øp t·ª•c</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>üìû Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i</h3>
        <p style="text-align:center;">Qu√Ω kh√°ch vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i ti·ªán li√™n h·ªá x√°c nh·∫≠n ƒë∆°n h√†ng.</p>
        <input id="inputPhoneForBooking" type="tel" placeholder="Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)" inputmode="tel" required>
        <div class="modal-actions" style="margin-top:15px;">
            <button id="confirmPhoneBtn">X√°c nh·∫≠n</button> 
        </div>
        <button id="closePhoneModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; background:#ccc; color:#333;">ƒê√≥ng</button>
    </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3>‚úÖ TH√îNG TIN ƒê·∫∂T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;">Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn">üìã Sao Ch√©p Th√¥ng Tin</button> 
            <button id="zaloModalBtn">üì± M·ªü Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;">ƒê√≥ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ------------------------------------------------------------------
   C·∫§U H√åNH NG√îN NG·ªÆ V√Ä TR·∫†NG TH√ÅI (MULTI-LANGUAGE & KILL SWITCH CONFIG)
   ------------------------------------------------------------------ */
// L∆ØU √ù QUAN TR·ªåNG: OSRM Public Server c√≥ th·ªÉ b·ªã qu√° t·∫£i, g√¢y l·ªói Route
// N·∫øu l·ªói t√≠nh l·ªô tr√¨nh v·∫´n x·∫£y ra, b·∫°n c·∫ßn xem x√©t s·ª≠ d·ª•ng m·ªôt d·ªãch v·ª• ƒë·ªãnh tuy·∫øn kh√°c.
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving"; // API ƒê·ªãnh tuy·∫øn
const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/"; 
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/"; 
const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 

let userLocation = null; 
let isServiceActive = false; 

/* DOM Elements */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const driverRequestEl = document.getElementById('driverRequest');
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const pickupInfo = document.getElementById('pickupInfo');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn');

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 
const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const phoneModal = document.getElementById('phoneModal');
const inputPhoneForBooking = document.getElementById('inputPhoneForBooking');
const confirmPhoneBtn = document.getElementById('confirmPhoneBtn');
const closePhoneModalBtn = document.getElementById('closePhoneModalBtn');
const depositModal = document.getElementById('depositModal');
const depositAmount = document.getElementById('depositAmount');
const confirmDepositBtn = document.getElementById('confirmDepositBtn');

// Language DOM
const langSelector = document.getElementById('languageSelector');
let currentLang = 'vn';

let finalZaloMessage = ''; 
let finalTotalFee = 0; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;
let bookingAction = null; // 'zalo' or 'mail'

/* ---------- D·ªÆ LI·ªÜU NG√îN NG·ªÆ (LANGUAGE DATA) - Gi·ªØ nguy√™n ---------- */
const LANGUAGES = {
    'vn': {
        title: 'üöñ D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving', headerPhone: '‚òéÔ∏è', headerText1: 'D·ªãch V·ª• Taxi', headerText2: 'Tr∆∞·ªùng An Driving', instruction_loading: 'üí∞ ƒêang ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•...', instruction_active: 'üí∞ B·∫•m "T√≠nh gi√°" ƒë·ªÉ xem chi ti·∫øt ƒë·∫∑t xe.', phone_label: 'üìû S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n', phone_label_optional: '(Kh√¥ng b·∫Øt bu·ªôc ƒë·ªÉ T√≠nh gi√°)', phone_placeholder: 'Nh·∫≠p SƒêT (10 s·ªë, VD: 0987654321)', pickup_label: 'üìç ƒêi·ªÉm ƒë√≥n', pickup_status_loading: '(ƒêang t√¨m v·ªã tr√≠...)', pickup_status_success: '‚úÖ ƒê√£ t√¨m th·∫•y v·ªã tr√≠', pickup_status_fail: '‚ö†Ô∏è L·ªói t√¨m v·ªã tr√≠. Nh·∫≠p th·ªß c√¥ng.', pickup_status_denied: '‚ùå B·ªã t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠.', pickup_status_unavailable: '‚ùå V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng (B·∫≠t GPS).', pickup_status_timeout: '‚ö†Ô∏è H·∫øt th·ªùi gian t√¨m v·ªã tr√≠.', pickup_status_notsup: '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.', pickup_placeholder: 'Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë√≥n (ho·∫∑c t·ª± ƒë·ªông l·∫•y)', map_btn: 'B·∫£n ƒë·ªì', datetime_label: 'üïí Ng√†y & Gi·ªù ƒë√≥n', add_stop_btn: 'Ôºã Th√™m ƒëi·ªÉm d·ª´ng', dropoff_label: 'üèÅ ƒêi·ªÉm ƒë·∫øn', dropoff_placeholder: 'Nh·∫≠p ƒë·ªãa ch·ªâ ƒëi·ªÉm ƒë·∫øn cu·ªëi', car_type_label: 'üöò Lo·∫°i xe', car_4_option: 'Xe 4 ch·ªó (10.000ƒë/km)', car_7_option: 'Xe 7 ch·ªó (12.000ƒë/km)', driver_request_label: 'üßë‚Äç‚úàÔ∏è Y√™u c·∫ßu T√†i x·∫ø', trip_type_label: 'üöó Lo·∫°i chuy·∫øn ƒëi', trip_1: '1 chi·ªÅu', trip_2: '2 chi·ªÅu (gi·∫£m 40% chi·ªÅu v·ªÅ)', waiting_label: '‚è≥ Th·ªùi gian ch·ªù (gi·ªù)', waiting_placeholder: 'Nh·∫≠p s·ªë gi·ªù ch·ªù', calc_btn: 'üí∞ T√≠nh gi√°', distance_text: '‚úèÔ∏è Qu√£ng ƒë∆∞·ªùng: ‚Äî', price_title: 'üíµ Gi√° d·ª± ki·∫øn', time_est: '‚è± Th·ªùi gian d·ª± ki·∫øn: ‚Äî ph√∫t', pickup_info: 'üïí Ng√†y gi·ªù ƒë√≥n: ‚Äî', zalo_btn: 'üì± ƒê·∫∑t qua Zalo', mail_btn: 'üìß ƒê·∫∑t qua Mail', note_title: 'üìå Ghi ch√∫:', note_detail: 'Gi√° 4 ch·ªó/7 ch·ªó: **10.000ƒë/km** / **12.000ƒë/km**. 2 chi·ªÅu: chi·ªÅu v·ªÅ gi·∫£m 40% (√°p d·ª•ng cho chuy·∫øn 1 chi·ªÅu **‚â• 45km**).<br>**Th·ªùi gian ch·ªù:**<ul><li>Ch·ªù 0‚Äì3 gi·ªù: **Mi·ªÖn ph√≠**.</li><li>K·ªÉ t·ª´ gi·ªù th·ª© 4, m·ªói gi·ªù ti·∫øp theo ph√°t sinh ph·ª• ph√≠ **50.000 VNƒê/gi·ªù**.</li></ul>Gi√° ƒë√£ bao g·ªìm ph√≠ c·∫ßu ƒë∆∞·ªùng.', modal_title: '‚úÖ TH√îNG TIN ƒê·∫∂T XE', modal_copy_instr: 'Sao ch√©p th√¥ng tin v√† g·ª≠i qua Zalo:', modal_copy_btn: 'üìã Sao Ch√©p Th√¥ng Tin', modal_zalo_btn: 'üì± M·ªü Zalo Chat', modal_close_btn: 'ƒê√≥ng', alert_pickup_empty: '‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë√≥n.', alert_dropoff_empty: '‚ùå Vui l√≤ng nh·∫≠p ƒê·ªãa ch·ªâ ƒêi·ªÉm ƒë·∫øn.', alert_waiting_invalid: '‚ùå V√¨ b·∫°n ch·ªçn chuy·∫øn 2 chi·ªÅu, vui l√≤ng nh·∫≠p Th·ªùi gian ch·ªù (s·ªë gi·ªù) ƒë·ªÉ ch√∫ng t√¥i s·∫Øp x·∫øp xe. Gi√° tr·ªã ph·∫£i ‚â• 0.', alert_pickup_coord_fail: 'Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô ƒêi·ªÉm ƒë√≥n. H√£y ch·ªçn g·ª£i √Ω ho·∫∑c ƒë·∫∑t tr√™n b·∫£n ƒë·ªì.', alert_dropoff_coord_fail: 'Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô ƒêi·ªÉm ƒë·∫øn. H√£y ch·ªçn g·ª£i √Ω ho·∫∑c ƒë·∫∑t tr√™n b·∫£n ƒë·ªì.', alert_stop_coord_fail: 'Kh√¥ng t√¨m th·∫•y t·ªça ƒë·ªô cho m·ªôt ƒêi·ªÉm d·ª´ng.', alert_route_fail: 'Kh√¥ng t√≠nh ƒë∆∞·ª£c l·ªô tr√¨nh', alert_route_error: 'L·ªói khi t√≠nh l·ªô tr√¨nh. Th·ª≠ l·∫°i.', alert_calc_first: '‚ö†Ô∏è Vui l√≤ng b·∫•m "T√≠nh gi√°" tr∆∞·ªõc ƒë·ªÉ t·∫°o th√¥ng tin chuy·∫øn ƒëi.', alert_invalid_phone: '‚ùå Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (ch√≠nh x√°c 10 ch·ªØ s·ªë).', alert_map_pickup: 'B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë√≥n', alert_map_dropoff: 'B·∫•m v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn ƒëi·ªÉm ƒë·∫øn', alert_service_off: '‚ö†Ô∏è D·ªãch v·ª• Taxi Tr∆∞·ªùng An Driving hi·ªán ƒëang t·∫°m ng·ª´ng nh·∫≠n ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra th√¥ng b√°o tr√™n m√†n h√¨nh.', alert_copy_success: 'üìã ƒê√£ sao ch√©p th√¥ng tin chuy·∫øn xe v√†o b·ªô nh·ªõ t·∫°m! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ M·ªü Zalo Chat v√† D√°n (Paste) ƒë·ªÉ g·ª≠i.', alert_copy_fail: '‚ö†Ô∏è Sao ch√©p t·ª± ƒë·ªông th·∫•t b·∫°i. Vui l√≤ng b·∫•m gi·ªØ (ho·∫∑c Ctrl+C) ƒë·ªÉ sao ch√©p vƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c b√¥i ƒëen v√† g·ª≠i qua Zalo.', alert_mail_success: '‚úÖ Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin mail ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn t·ª± ƒë·ªông v√† b·∫•m "G·ª≠i"', deposit_title: 'üìù Y√™u c·∫ßu ƒê·∫∑t c·ªçc cho Chuy·∫øn 2 Chi·ªÅu', deposit_text1: 'Qu√Ω kh√°ch vui l√≤ng l∆∞u √Ω:', deposit_text2: 'ƒê·ªÉ x√°c nh·∫≠n v√† ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• cho chuy·∫øn ƒëi **Hai chi·ªÅu** c·ªßa Qu√Ω kh√°ch, ch√∫ng t√¥i k√≠nh mong Qu√Ω kh√°ch **ƒë·∫∑t c·ªçc tr∆∞·ªõc 20%** tr√™n t·ªïng gi√° c∆∞·ªõc d·ª± ki·∫øn.', deposit_text3: 'S·ªë ti·ªÅn ƒë·∫∑t c·ªçc d·ª± ki·∫øn:', deposit_text4: 'Khi nh√¢n vi√™n **Tr∆∞·ªùng An Driving** ph·∫£n h·ªìi qua Zalo, ch√∫ng t√¥i s·∫Ω g·ª≠i **h∆∞·ªõng d·∫´n thanh to√°n c·ª• th·ªÉ** (chuy·ªÉn kho·∫£n) ƒë·ªÉ ho√†n t·∫•t th·ªß t·ª•c ƒë·∫∑t c·ªçc.', deposit_text5: '**L∆∞u √Ω:** Ph·∫ßn c√≤n l·∫°i c·ªßa c∆∞·ªõc ph√≠ s·∫Ω ƒë∆∞·ª£c thanh to√°n tr·ª±c ti·∫øp cho t√†i x·∫ø sau khi k·∫øt th√∫c chuy·∫øn ƒëi. Xin ch√¢n th√†nh c·∫£m ∆°n Qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng d·ªãch v·ª•.', deposit_confirm: 'ƒê√£ hi·ªÉu v√† Ti·∫øp t·ª•c', phone_modal_title: 'üìû Vui l√≤ng nh·∫≠p S·ªë ƒëi·ªán tho·∫°i', phone_modal_instr: 'Qu√Ω kh√°ch vui l√≤ng nh·∫≠p SƒêT ƒë·ªÉ ch√∫ng t√¥i ti·ªán li√™n h·ªá x√°c nh·∫≠n ƒë∆°n h√†ng.', phone_modal_confirm: 'X√°c nh·∫≠n', phone_modal_close: 'ƒê√≥ng',
    },
    'en': {
        title: 'üöñ Truong An Driving Taxi Service', headerPhone: '‚òéÔ∏è', headerText1: 'Taxi Service', headerText2: 'Truong An Driving', instruction_loading: 'üí∞ Checking service status...', instruction_active: 'üí∞ Press "Calculate Price" for booking details.', phone_label: 'üìû Your Phone Number', phone_label_optional: '(Optional for Price Calculation)', phone_placeholder: 'Enter phone number (10 digits, e.g.: 0987654321)', pickup_label: 'üìç Pickup Location', pickup_status_loading: '(Finding location...)', pickup_status_success: '‚úÖ Location found', pickup_status_fail: '‚ö†Ô∏è Location search error. Enter manually.', pickup_status_denied: '‚ùå Access denied to location.', pickup_status_unavailable: '‚ùå Location unavailable (Turn on GPS).', pickup_status_timeout: '‚ö†Ô∏è Location search timed out.', pickup_status_notsup: '‚ùå Browser does not support Geolocation.', pickup_placeholder: 'Enter pickup address (or auto-detect)', map_btn: 'Map', datetime_label: 'üïí Pickup Date & Time', add_stop_btn: 'Ôºã Add Stopover', dropoff_label: 'üèÅ Dropoff Location', dropoff_placeholder: 'Enter final dropoff address', car_type_label: 'üöò Car Type', car_4_option: '4-seater (10,000ƒë/km)', car_7_option: '7-seater (12,000ƒë/km)', driver_request_label: 'üßë‚Äç‚úàÔ∏è Driver Request', trip_type_label: 'üöó Trip Type', trip_1: 'One Way', trip_2: 'Two Way (40% discount on return leg)', waiting_label: '‚è≥ Waiting Time (hours)', waiting_placeholder: 'Enter waiting hours', calc_btn: 'üí∞ Calculate Price', distance_text: '‚úèÔ∏è Distance: ‚Äî', price_title: 'üíµ Estimated Price', time_est: '‚è± Estimated Travel Time: ‚Äî minutes', pickup_info: 'üïí Pickup Date & Time: ‚Äî', zalo_btn: 'üì± Book via Zalo', mail_btn: 'üìß Book via Email', note_title: 'üìå Note:', note_detail: 'Price 4/7 seater: **10,000ƒë/km** / **12,000ƒë/km**. Two way: 40% discount on return leg (applies to one-way trips **‚â• 45km**).<br>**Waiting Time:**<ul><li>Wait 0‚Äì3 hours: **Free**.</li><li>From the 4th hour, a surcharge of **50,000 VND/hour** applies.</li></ul>Price includes toll fees.', modal_title: '‚úÖ BOOKING INFORMATION', modal_copy_instr: 'Copy information and send via Zalo:', modal_copy_btn: 'üìã Copy Info', modal_zalo_btn: 'üì± Open Zalo Chat', modal_close_btn: 'Close', alert_pickup_empty: '‚ùå Please enter Pickup Address.', alert_dropoff_empty: '‚ùå Please enter Dropoff Address.', alert_waiting_invalid: '‚ùå Since you selected two-way, please enter Waiting Time (hours) to arrange the car. Value must be ‚â• 0.', alert_pickup_coord_fail: 'Could not find Pickup coordinates. Select a suggestion or mark on the map.', alert_dropoff_coord_fail: 'Could not find Dropoff coordinates. Select a suggestion or mark on the map.', alert_stop_coord_fail: 'Could not find coordinates for a Stopover.', alert_route_fail: 'Could not calculate route', alert_route_error: 'Error calculating route. Try again.', alert_calc_first: '‚ö†Ô∏è Please press "Calculate Price" first to generate trip details.', alert_invalid_phone: '‚ùå Please enter a valid 10-digit Phone Number.', alert_map_pickup: 'Click on the map to select pickup location', alert_map_dropoff: 'Click on the map to select dropoff location', alert_service_off: '‚ö†Ô∏è Truong An Driving Taxi Service is currently suspending bookings. Please check the on-screen notification.', alert_copy_success: 'üìã Trip information copied to clipboard! You can now Open Zalo Chat and Paste to send.', alert_copy_fail: '‚ö†Ô∏è Automatic copy failed. Please hold (or Ctrl+C) to copy the highlighted text and send via Zalo.', alert_mail_success: '‚úÖ Please check the mail information which has been filled automatically and press "Send"', deposit_title: 'üìù Deposit Request for Two-Way Trip', deposit_text1: 'Dear Customer, please note:', deposit_text2: 'To confirm and ensure service quality for your **Two-way** trip, we kindly request a **20% deposit** on the total estimated fare.', deposit_text3: 'Estimated Deposit Amount:', deposit_text4: 'When a **Truong An Driving** staff member responds via Zalo, we will send **specific payment instructions** (bank transfer) to complete the deposit procedure.', deposit_text5: '**Note:** The remaining fare will be paid directly to the driver after the trip ends. Thank you for trusting our service.', deposit_confirm: 'Understood and Proceed', phone_modal_title: 'üìû Please Enter Phone Number', phone_modal_instr: 'Please enter your phone number so we can contact you to confirm the booking.', phone_modal_confirm: 'Confirm', phone_modal_close: 'Close',
    },
    'cn': {
        title: 'üöñ ÈïøÂÆâÈ©æÈ©∂Âá∫ÁßüËΩ¶ÊúçÂä°', headerPhone: '‚òéÔ∏è', headerText1: 'Âá∫ÁßüËΩ¶ÊúçÂä°', headerText2: 'ÈïøÂÆâÈ©æÈ©∂', instruction_loading: 'üí∞ Ê≠£Âú®Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ...', instruction_active: 'üí∞ ÁÇπÂáª‚ÄúËÆ°ÁÆó‰ª∑Ê†º‚ÄùÊü•ÁúãÈ¢ÑËÆ¢ËØ¶ÊÉÖ„ÄÇ', phone_label: 'üìû ÊÇ®ÁöÑÁîµËØùÂè∑Á†Å', phone_label_optional: '(ËÆ°ÁÆó‰ª∑Ê†ºÂèØÈÄâ)', phone_placeholder: 'ËæìÂÖ•ÁîµËØùÂè∑Á†Å (10‰ΩçÊï∞Â≠ó, ‰æã: 0987654321)', pickup_label: 'üìç ‰∏äËΩ¶Âú∞ÁÇπ', pickup_status_loading: '(Ê≠£Âú®Êü•Êâæ‰ΩçÁΩÆ...)', pickup_status_success: '‚úÖ Â∑≤ÊâæÂà∞‰ΩçÁΩÆ', pickup_status_fail: '‚ö†Ô∏è ‰ΩçÁΩÆÊêúÁ¥¢ÈîôËØØ„ÄÇËØ∑ÊâãÂä®ËæìÂÖ•„ÄÇ', pickup_status_denied: '‚ùå ÊãíÁªù‰ΩçÁΩÆËÆøÈóÆ„ÄÇ', pickup_status_unavailable: '‚ùå ‰ΩçÁΩÆ‰∏çÂèØÁî® (ÊâìÂºÄ GPS)„ÄÇ', pickup_status_timeout: '‚ö†Ô∏è ‰ΩçÁΩÆÊêúÁ¥¢Ë∂ÖÊó∂„ÄÇ', pickup_status_notsup: '‚ùå ÊµèËßàÂô®‰∏çÊîØÊåÅÂú∞ÁêÜÂÆö‰Ωç„ÄÇ', pickup_placeholder: 'ËæìÂÖ•‰∏äËΩ¶Âú∞ÂùÄ (ÊàñËá™Âä®ÂÆö‰Ωç)', map_btn: 'Âú∞Âõæ', datetime_label: 'üïí ‰∏äËΩ¶Êó•ÊúüÂíåÊó∂Èó¥', add_stop_btn: 'Ôºã Ê∑ªÂä†‰∏≠ÈÄîÁ´ô', dropoff_label: 'üèÅ ‰∏ãËΩ¶Âú∞ÁÇπ', dropoff_placeholder: 'ËæìÂÖ•ÊúÄÁªà‰∏ãËΩ¶Âú∞ÂùÄ', car_type_label: 'üöò ËΩ¶Âûã', car_4_option: '4Â∫ßËΩ¶ (10,000Áõæ/ÂÖ¨Èáå)', car_7_option: '7Â∫ßËΩ¶ (12,000Áõæ/ÂÖ¨Èáå)', driver_request_label: 'üßë‚Äç‚úàÔ∏è Âè∏Êú∫Ë¶ÅÊ±Ç', trip_type_label: 'üöó Ë°åÁ®ãÁ±ªÂûã', trip_1: 'ÂçïÁ®ã', trip_2: 'ÂèåÁ®ã (ËøîÁ®ã‰∫´6Êäò)', waiting_label: '‚è≥ Á≠âÂæÖÊó∂Èó¥ (Â∞èÊó∂)', waiting_placeholder: 'ËæìÂÖ•Á≠âÂæÖÂ∞èÊó∂Êï∞', calc_btn: 'üí∞ ËÆ°ÁÆó‰ª∑Ê†º', distance_text: '‚úèÔ∏è ÈáåÁ®ã: ‚Äî', price_title: 'üíµ È¢Ñ‰º∞‰ª∑Ê†º', time_est: '‚è± È¢Ñ‰º∞Ë°åÁ®ãÊó∂Èó¥: ‚Äî ÂàÜÈíü', pickup_info: 'üïí ‰∏äËΩ¶Êó•ÊúüÂíåÊó∂Èó¥: ‚Äî', zalo_btn: 'üì± ÈÄöËøáZaloÈ¢ÑËÆ¢', mail_btn: 'üìß ÈÄöËøáÈÇÆ‰ª∂È¢ÑËÆ¢', note_title: 'üìå Ê≥®ÊÑè:', note_detail: '4Â∫ß/7Â∫ß‰ª∑Ê†º: **10,000ƒë/ÂÖ¨Èáå** / **12,000ƒë/ÂÖ¨Èáå**„ÄÇÂèåÁ®ã: ËøîÁ®ã‰∫´6Êäò (ÈÄÇÁî®‰∫éÂçïÁ®ã **‚â• 45ÂÖ¨Èáå**)„ÄÇ<br>**Á≠âÂæÖÊó∂Èó¥:**<ul><li>Á≠âÂæÖ 0‚Äì3Â∞èÊó∂: **ÂÖçË¥π**„ÄÇ</li><li>‰ªéÁ¨¨4Â∞èÊó∂Ëµ∑, ‰∫ßÁîüÈôÑÂä†Ë¥π **50,000 VND/Â∞èÊó∂**„ÄÇ</li></ul>‰ª∑Ê†ºÂ∑≤ÂåÖÂê´ËøáË∑ØË¥π„ÄÇ', modal_title: '‚úÖ È¢ÑËÆ¢‰ø°ÊÅØ', modal_copy_instr: 'Â§çÂà∂‰ø°ÊÅØÂπ∂ÈÄöËøá Zalo ÂèëÈÄÅ:', modal_copy_btn: 'üìã Â§çÂà∂‰ø°ÊÅØ', modal_zalo_btn: 'üì± ÊâìÂºÄ Zalo ËÅäÂ§©', modal_close_btn: 'ÂÖ≥Èó≠', alert_pickup_empty: '‚ùå ËØ∑ËæìÂÖ•‰∏äËΩ¶Âú∞ÂùÄ„ÄÇ', alert_dropoff_empty: '‚ùå ËØ∑ËæìÂÖ•‰∏ãËΩ¶Âú∞ÂùÄ„ÄÇ', alert_waiting_invalid: '‚ùå Áî±‰∫éÊÇ®ÈÄâÊã©‰∫ÜÂèåÁ®ã, ËØ∑ËæìÂÖ•Á≠âÂæÖÊó∂Èó¥ (Â∞èÊó∂) ‰ª•ÂÆâÊéíËΩ¶ËæÜ„ÄÇÊï∞ÂÄºÂøÖÈ°ª ‚â• 0„ÄÇ', alert_pickup_coord_fail: 'Êâæ‰∏çÂà∞‰∏äËΩ¶ÂùêÊ†á„ÄÇËØ∑ÈÄâÊã©Âª∫ËÆÆÊàñÂú®Âú∞Âõæ‰∏äÊ†áËÆ∞„ÄÇ', alert_dropoff_coord_fail: 'Êâæ‰∏çÂà∞‰∏ãËΩ¶ÂùêÊ†á„ÄÇËØ∑ÈÄâÊã©Âª∫ËÆÆÊàñÂú®Âú∞Âõæ‰∏äÊ†áËÆ∞„ÄÇ', alert_stop_coord_fail: 'Êâæ‰∏çÂà∞‰∏≠ÈÄîÁ´ôÂùêÊ†á„ÄÇ', alert_route_fail: 'Êó†Ê≥ïËÆ°ÁÆóË∑ØÁ∫ø', alert_route_error: 'ËÆ°ÁÆóË∑ØÁ∫øÊó∂Âá∫Èîô„ÄÇËØ∑ÈáçËØï„ÄÇ', alert_calc_first: '‚ö†Ô∏è ËØ∑ÂÖàÁÇπÂáª‚ÄúËÆ°ÁÆó‰ª∑Ê†º‚Äù‰ª•ÁîüÊàêË°åÁ®ãËØ¶ÊÉÖ„ÄÇ', alert_invalid_phone: '‚ùå ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ10‰ΩçÊï∞Â≠óÁîµËØùÂè∑Á†Å„ÄÇ', alert_map_pickup: 'ÁÇπÂáªÂú∞ÂõæÈÄâÊã©‰∏äËΩ¶Âú∞ÁÇπ', alert_map_dropoff: 'ÁÇπÂáªÂú∞ÂõæÈÄâÊã©‰∏ãËΩ¶Âú∞ÁÇπ', alert_service_off: '‚ö†Ô∏è ÈïøÂÆâÈ©æÈ©∂Âá∫ÁßüËΩ¶ÊúçÂä°ÁõÆÂâçÊöÇÂÅúÈ¢ÑËÆ¢„ÄÇËØ∑Êü•ÁúãÂ±èÂπïÈÄöÁü•„ÄÇ', alert_copy_success: 'üìã Ë°åÁ®ã‰ø°ÊÅØÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅÊÇ®Áé∞Âú®ÂèØ‰ª•ÊâìÂºÄZaloËÅäÂ§©Âπ∂Á≤òË¥¥ÂèëÈÄÅ„ÄÇ', alert_copy_fail: '‚ö†Ô∏è Ëá™Âä®Â§çÂà∂Â§±Ë¥•„ÄÇËØ∑ÈïøÊåâÔºàÊàñ Ctrl+CÔºâÂ§çÂà∂Á™ÅÂá∫ÊòæÁ§∫ÁöÑÊñáÊú¨Âπ∂ÈÄöËøá Zalo ÂèëÈÄÅ„ÄÇ', alert_mail_success: '‚úÖ ËØ∑Ê£ÄÊü•Â∑≤Ëá™Âä®Â°´ÂÜôÁöÑÈÇÆ‰ª∂‰ø°ÊÅØÔºåÂπ∂ÁÇπÂáª‚ÄúÂèëÈÄÅ‚Äù', deposit_title: 'üìù ÂèåÁ®ãË°åÁ®ãÊäºÈáëË¶ÅÊ±Ç', deposit_text1: 'Â∞äÊï¨ÁöÑÂÆ¢Êà∑ÔºåËØ∑Ê≥®ÊÑè:', deposit_text2: '‰∏∫Á°ÆËÆ§Âπ∂Á°Æ‰øùÊÇ®**ÂèåÁ®ã**Ë°åÁ®ãÁöÑÊúçÂä°Ë¥®Èáè, Êàë‰ª¨ÊÅ≥ËØ∑ÊÇ®ÊîØ‰ªòÈ¢Ñ‰º∞ÊÄªË¥πÁî®ÁöÑ**20%**‰Ωú‰∏∫ÊäºÈáë„ÄÇ', deposit_text3: 'È¢Ñ‰º∞ÊäºÈáëÈáëÈ¢ù:', deposit_text4: 'ÂΩì**ÈïøÂÆâÈ©æÈ©∂**ÁöÑÂ∑•‰Ωú‰∫∫ÂëòÈÄöËøáZaloÂõûÂ§çÊó∂, Êàë‰ª¨Â∞ÜÂèëÈÄÅ**ÂÖ∑‰ΩìÁöÑ‰ªòÊ¨æÊåáÁ§∫** (Èì∂Ë°åËΩ¨Ë¥¶) ‰ª•ÂÆåÊàêÊäºÈáëÊâãÁª≠„ÄÇ', deposit_text5: '**Ê≥®ÊÑè:** Ââ©‰ΩôË¥πÁî®Â∞ÜÂú®Ë°åÁ®ãÁªìÊùüÂêéÁõ¥Êé•ÊîØ‰ªòÁªôÂè∏Êú∫„ÄÇË°∑ÂøÉÊÑüË∞¢ÊÇ®ÂØπÊàë‰ª¨ÊúçÂä°ÁöÑ‰ø°‰ªª„ÄÇ', deposit_confirm: '‰∫ÜËß£Âπ∂ÁªßÁª≠', phone_modal_title: 'üìû ËØ∑ËæìÂÖ•ÁîµËØùÂè∑Á†Å', phone_modal_instr: 'ËØ∑ÊÇ®ËæìÂÖ•ÁîµËØùÂè∑Á†ÅÔºå‰ª•‰æøÊàë‰ª¨ËÅîÁ≥ªÊÇ®Á°ÆËÆ§ËÆ¢Âçï„ÄÇ', phone_modal_confirm: 'Á°ÆËÆ§', phone_modal_close: 'Close',
    }
};


/* ------------------------------------------------------------------
   C·∫¨P NH·∫¨T GIAO DI·ªÜN THEO NG√îN NG·ªÆ (LANGUAGE UI UPDATE) - Gi·ªØ nguy√™n
   ------------------------------------------------------------------ */

function updateUIWithLanguage(langKey) {
    const L = LANGUAGES[langKey];
    if (!L) return;

    // 1. C·∫≠p nh·∫≠t Head v√† Title
    document.title = L.title;
    document.querySelector('header').innerHTML = 
        `üöñ ${L.headerText1}<br>${L.headerText2}<br><a href="tel:${TAXI_PHONE}" class="phone-number" style="color:white; text-decoration: none;">${L.headerPhone} ${TAXI_PHONE}</a>`;
    
    // 2. C·∫≠p nh·∫≠t c√°c Label/Placeholder
    // C·∫≠p nh·∫≠t H√†ng Ng√¥n ng·ªØ
    document.querySelector('.language-row-fix h3').innerHTML = `üåé ${L.title.split(' ')[0]} / Language`; 

    document.querySelectorAll('.label-row h3')[0].innerHTML = L.phone_label + `<span style="font-size:14px; font-weight:normal; color:#6c757d;"> ${L.phone_label_optional}</span>`;
    customerPhoneEl.placeholder = L.phone_placeholder;

    // FIX: ƒê·∫£m b·∫£o ch·ªçn ƒë√∫ng label cho ƒêi·ªÉm ƒë√≥n v√† ƒêi·ªÉm ƒë·∫øn
    const labels = document.querySelectorAll('.label-row h3');
    if (labels[1]) labels[1].textContent = L.pickup_label;
    if (labels[2]) labels[2].textContent = L.datetime_label;
    
    pickupEl.placeholder = L.pickup_placeholder;
    document.getElementById('pick-from-map').textContent = L.map_btn;
    
    document.getElementById('add-stop-btn').textContent = L.add_stop_btn;
    
    if (labels[3]) labels[3].textContent = L.dropoff_label;
    dropoffEl.placeholder = L.dropoff_placeholder;
    document.getElementById('pick-to-map').textContent = L.map_btn;

    if (labels[4]) labels[4].textContent = L.car_type_label;
    carTypeEl.options[0].textContent = L.car_4_option;
    carTypeEl.options[1].textContent = L.car_7_option;
    
    if (labels[5]) labels[5].innerHTML = L.driver_request_label + `<span class="driver-option-avatar" title="Icon n√†y c√≥ th·ªÉ thay b·∫±ng Avatar">üë§</span>`;
    
    if (labels[6]) labels[6].textContent = L.trip_type_label;
    tripTypeEl.options[0].textContent = L.trip_1;
    tripTypeEl.options[1].textContent = L.trip_2;
    
    if (labels[7]) labels[7].textContent = L.waiting_label;
    waitingEl.placeholder = L.waiting_placeholder;

    calcBtn.textContent = L.calc_btn;
    
    // C·∫≠p nh·∫≠t Placeholder cho Stop input
    stopsContainer.querySelectorAll('input[id^="stop-"]').forEach((input, index) => {
        input.placeholder = `${L.add_stop_btn.replace('Ôºã ', '')} ${index + 1}`;
    });

    // 3. C·∫≠p nh·∫≠t K·∫øt qu·∫£
    const distanceTextVal = distanceText.textContent.includes('Qu√£ng ƒë∆∞·ªùng') || distanceText.textContent.includes('Distance') || distanceText.textContent.includes('ÈáåÁ®ã') ? L.distance_text : distanceText.textContent;
    distanceText.textContent = distanceTextVal; 
    priceValue.previousElementSibling.textContent = L.price_title; 
    timeEst.textContent = L.time_est;
    pickupInfo.textContent = L.pickup_info;

    // 4. C·∫≠p nh·∫≠t N√∫t H√†nh ƒë·ªông
    zaloBtn.textContent = L.zalo_btn;
    mailBtn.textContent = L.mail_btn;
    
    // 5. C·∫≠p nh·∫≠t Ghi ch√∫
    document.querySelector('.note').innerHTML = `üìå ${L.note_title} ${L.note_detail}`;

    // 6. C·∫≠p nh·∫≠t Modal
    zaloModal.querySelector('h3').textContent = L.modal_title;
    zaloModal.querySelector('p').textContent = L.modal_copy_instr;
    copyModalBtn.textContent = L.modal_copy_btn;
    zaloModalBtn.textContent = L.modal_zalo_btn;
    closeModalBtn.textContent = L.modal_close_btn;

    // 7. C·∫≠p nh·∫≠t Deposit Modal
    depositModal.querySelector('h3').textContent = L.deposit_title;
    depositModal.querySelector('p:nth-child(2)').innerHTML = `**${L.deposit_text1}**<br>${L.deposit_text2}`;
    depositModal.querySelector('p:nth-child(3)').innerHTML = `${L.deposit_text3} <span id="depositAmount">0 ƒë</span>`;
    depositModal.querySelector('p:nth-child(4)').textContent = L.deposit_text4;
    depositModal.querySelector('p:nth-child(5)').innerHTML = L.deposit_text5;
    confirmDepositBtn.textContent = L.deposit_confirm;
    
    // 8. C·∫≠p nh·∫≠t Phone Modal
    phoneModal.querySelector('h3').textContent = L.phone_modal_title;
    phoneModal.querySelector('p').textContent = L.phone_modal_instr;
    inputPhoneForBooking.placeholder = L.phone_placeholder;
    confirmPhoneBtn.textContent = L.phone_modal_confirm;
    closePhoneModalBtn.textContent = L.phone_modal_close;
    
    // 9. C·∫≠p nh·∫≠t tr·∫°ng th√°i v·ªã tr√≠ (ch·ªâ n·∫øu ƒëang ·ªü tr·∫°ng th√°i loading/fail)
    if(locationStatusEl.textContent.includes('ƒêang t√¨m v·ªã tr√≠') || locationStatusEl.textContent.includes('Location') || locationStatusEl.textContent.includes('‰ΩçÁΩÆ')) {
        locationStatusEl.textContent = L.pickup_status_loading;
    }
    
    // 10. C·∫≠p nh·∫≠t instructionText (Tr·∫°ng th√°i d·ªãch v·ª•)
    if (!isServiceActive) {
      // Gi·ªØ nguy√™n th√¥ng b√°o l·ªói n·∫øu d·ªãch v·ª• off
    } else if (instructionText.innerHTML.includes('ƒêang ki·ªÉm tra') || instructionText.innerHTML.includes('Checking') || instructionText.innerHTML.includes('Ê≠£Âú®Ê£ÄÊü•')) {
      instructionText.innerHTML = L.instruction_loading;
    } else if (instructionText.innerHTML.includes('th√†nh c√¥ng') || instructionText.innerHTML.includes('success') || instructionText.innerHTML.includes('ÊàêÂäü')) {
      instructionText.innerHTML = `‚úÖ **${L.calc_btn.replace('üí∞ ', '')} th√†nh c√¥ng!** Vui l√≤ng b·∫•m **${L.zalo_btn.split(' ')[1]}/${L.mail_btn.split(' ')[1]}** ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng.`;
    } else {
      instructionText.innerHTML = L.instruction_active;
    }
}

/* ------------------------------------------------------------------
   CH·ª®C NƒÇNG C∆† B·∫¢N V√Ä KILL SWITCH (CORE FUNCTIONS) - Gi·ªØ nguy√™n
   ------------------------------------------------------------------ */

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`; 
    const finalUrl = REMOTE_STATUS_URL + cacheBuster;

    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
        
        if (!response.ok) {
            return { 
                active: false, 
                message_vn: "‚ö†Ô∏è C·∫¢NH B√ÅO M·∫†NG: Kh√¥ng t√¨m th·∫•y file tr·∫°ng th√°i d·ªãch v·ª• (404/Server Error). Ch·ª©c nƒÉng ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng." 
            };
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        let msg_vn = "‚ö†Ô∏è Thi·∫øt b·ªã ƒëang OFFLINE ho·∫∑c L·ªñI K·∫æT N·ªêI. Kh√¥ng th·ªÉ x√°c nh·∫≠n ƒë∆°n h√†ng."
        let msg_en = "‚ö†Ô∏è Device is OFFLINE or CONNECTION ERROR. Cannot confirm booking."
        let msg_cn = "‚ö†Ô∏è ËÆæÂ§áÁ¶ªÁ∫øÊàñËøûÊé•ÈîôËØØ„ÄÇÊó†Ê≥ïÁ°ÆËÆ§ËÆ¢Âçï„ÄÇ"
        if (error.name === 'TimeoutError') {
             msg_vn = "‚ö†Ô∏è Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª• qu√° l√¢u. Vi·ªác ƒë·∫∑t xe b·ªã t·∫°m ng∆∞ng."
             msg_en = "‚ö†Ô∏è Service status check timed out. Booking is suspended."
             msg_cn = "‚ö†Ô∏è ÊúçÂä°Áä∂ÊÄÅÊ£ÄÊü•Ë∂ÖÊó∂„ÄÇÈ¢ÑËÆ¢ÊöÇÂÅú„ÄÇ"
        }
        console.error("L·ªói khi fetch tr·∫°ng th√°i d·ªãch v·ª•:", error);
        return { 
            active: false, 
            message_vn: msg_vn,
            message_en: msg_en,
            message_cn: msg_cn,
        };
    }
}

async function updateUIBasedOnStatus(status) {
    const L = LANGUAGES[currentLang];
    const wasActive = isServiceActive;
    isServiceActive = status.active;
    
    instructionText.style.display = 'block';

    if (!isServiceActive) {
        calcBtn.style.background = '#ccc';
        calcBtn.style.cursor = 'not-allowed';
        calcBtn.disabled = true;
        
        serviceOffNotice.style.display = 'block';
        
        let msg = status.message_vn; 
        if (currentLang === 'en' && status.message_en) msg = status.message_en;
        else if (currentLang === 'cn' && status.message_cn) msg = status.message_cn;
        
        serviceOffNotice.innerHTML = msg;
        
        bookingFormWrapper.classList.add('disabled-form');
        
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';
        
    } else {
        calcBtn.style.background = 'var(--green)';
        calcBtn.style.cursor = 'pointer';
        
        // Lu√¥n g·ªçi h√†m ki·ªÉm tra tr·∫°ng th√°i input cu·ªëi c√πng
        updateCalcButtonState(); 
        
        serviceOffNotice.style.display = 'none';
        
        let active_msg = status.message_active 
            ? status[`message_${currentLang}`] || status.message_vn 
            : L.instruction_active;

        instructionText.innerHTML = active_msg;
        bookingFormWrapper.classList.remove('disabled-form');
        
        if (!wasActive && isServiceActive && map) {
            // FIX: G·ªçi invalidateSize khi d·ªãch v·ª• ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i
            setTimeout(() => map.invalidateSize(), 500);
        }
    }
}

function initMap(center) {
    // FIX MINI MAP: ƒê·∫£m b·∫£o b·∫£n ƒë·ªì ƒë∆∞·ª£c kh·ªüi t·∫°o
    if (!map) {
        const mapElement = document.getElementById('map');
        if (mapElement) {
             map = L.map('map').setView(center, 11);
             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

             map.on('click', handleMapClick);
             map.on('dblclick', handleMapDblClick);
             // Quan tr·ªçng: Sau khi kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu, c·∫ßn g·ªçi invalidateSize 
             map.invalidateSize(); 
        } else {
             console.error("L·ªói: Kh√¥ng t√¨m th·∫•y div #map.");
        }
    } else {
        map.setView(center, 11);
        map.invalidateSize(); // G·ªçi l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o map hi·ªÉn th·ªã l·∫°i sau khi chuy·ªÉn ƒë·ªïi UI
    }
}


async function reverseGeocode(lat, lon) {
    try {
        // FIX: Th√™m accept-language ƒë·ªÉ ∆∞u ti√™n ng√¥n ng·ªØ hi·ªán t·∫°i
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=${currentLang}`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        console.warn('Reverse Geocoding Error', e);
        return `${lat.toFixed(6)}, ${lon.toFixed(6)} (${LANGUAGES[currentLang].pickup_status_fail})`;
    }
}

function getGeolocation() {
    const L = LANGUAGES[currentLang];
    locationStatusEl.textContent = L.pickup_status_loading;
    locationStatusEl.style.color = 'var(--muted)';
    reloadLocationBtn.style.color = '#ccc'; 
    reloadLocationBtn.style.pointerEvents = 'none'; 
    // X√≥a t·ªça ƒë·ªô c≈© khi t√¨m l·∫°i v·ªã tr√≠
    delete pickupEl.dataset.lat;
    delete pickupEl.dataset.lon;

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            // --- LOGIC TH√ÄNH C√îNG ---
            userLocation = [pos.coords.latitude, pos.coords.longitude]; 
            initMap(userLocation); 
            
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            pickupEl.parentNode.querySelector('.clear-btn').style.display = 'block';

            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup(L.pickup_label.replace('üìç ','')).openPopup(); 

            locationStatusEl.textContent = L.pickup_status_success;
            locationStatusEl.style.color = 'var(--green)';
            
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';

            updateCalcButtonState();


        }, (err)=>{
            // --- LOGIC TH·∫§T B·∫†I ---
            console.warn('Geolocation Error:', err.message, err.code);
            initMap(DEFAULT_CENTER); 
            
            let statusText = L.pickup_status_fail;
            if (err.code === err.PERMISSION_DENIED) {
                 statusText = L.pickup_status_denied;
                 // X√≥a lu√¥n n·ªôi dung input n·∫øu b·ªã t·ª´ ch·ªëi truy c·∫≠p v·ªã tr√≠
                 pickupEl.value = '';
            } else if (err.code === err.POSITION_UNAVAILABLE) {
                 statusText = L.pickup_status_unavailable;
            } else if (err.code === err.TIMEOUT) {
                 statusText = L.pickup_status_timeout;
            }
            
            locationStatusEl.textContent = statusText;
            locationStatusEl.style.color = '#dc3545';
            
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
    } else {
        // --- LOGIC TR√åNH DUY·ªÜT KH√îNG H·ªñ TR·ª¢ ---
        initMap(DEFAULT_CENTER); 
        locationStatusEl.textContent = L.pickup_status_notsup;
        locationStatusEl.style.color = '#dc3545';
        
        reloadLocationBtn.style.color = '#ccc';
        reloadLocationBtn.style.pointerEvents = 'none';
    }
}


function debounce(func, timeout = DEBOUNCE_TIME) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

function toggleWaitingInput(){
    if(tripTypeEl.value === '1'){
        waitingWrapper.style.display = 'none';
    } else {
        waitingWrapper.style.display = 'block';
    }
}

tripTypeEl.addEventListener('change', () => {
    toggleWaitingInput();
    updateCalcButtonState(); 
});
toggleWaitingInput();


async function geocodeOnce(query){
  try{
    let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1`;
    
    if(userLocation) { 
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.5},${lat - 0.5},${lon + 0.5},${lat + 0.5}`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }

    const r = await fetch(url);
    const data = await r.json();
    if(Array.isArray(data) && data.length>0) return data[0];
  }catch(e){ console.warn('geocode once error', e); }
  return null;
}

function attachAutocomplete(inputEl, boxEl){
  let controller = null;

  const doSearch = async ()=>{
    const q = inputEl.value.trim();
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    
    if(!q){ 
        boxEl.style.display = 'none'; 
        if(clearBtn) clearBtn.style.display = 'none';
        delete inputEl.dataset.lat;
        delete inputEl.dataset.lon;
        updateCalcButtonState(); 
        return; 
    }
    if(clearBtn) clearBtn.style.display = 'block';

    if(controller) controller.abort();
    controller = new AbortController();
    
    boxEl.innerHTML = `<div>${LANGUAGES[currentLang].instruction_loading}</div>`; 
    boxEl.style.display = 'block'; 

    let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=${currentLang}`; 
    
    if(userLocation) {
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.3},${lat - 0.3},${lon + 0.3},${lat + 0.3}`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }


    try{
      const res = await fetch(url, { signal: controller.signal });
      const data = await res.json();
      
      const fragment = document.createDocumentFragment();
      
      if(!Array.isArray(data) || data.length === 0){ 
        boxEl.innerHTML = `<div>${LANGUAGES[currentLang].alert_route_fail}</div>`; 
        setTimeout(() => boxEl.style.display = 'none', 1000); 
        return; 
      }

      data.forEach(place => {
        const d = document.createElement('div');
        d.innerHTML = `<span style="font-size:16px">üìç</span><div style="margin-left:8px">${place.display_name}</div>`;
        d.addEventListener('click', ()=>{
          inputEl.value = place.display_name;
          inputEl.dataset.lat = place.lat;
          inputEl.dataset.lon = place.lon;
          boxEl.style.display = 'none';
          if(clearBtn) clearBtn.style.display = 'block';

          const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
          if(map) {
            const L = LANGUAGES[currentLang];
            // X√≥a h·∫øt marker c≈© (FIX: ƒê√£ lo·∫°i b·ªè marker stop c≈© ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
            if(inputEl.id === 'pickup'){
              if(pickupMarker) map.removeLayer(pickupMarker);
              pickupMarker = L.marker(latlng).addTo(map).bindPopup(L.pickup_label.replace('üìç ','')).openPopup(); 
              map.setView(latlng, 14);
            } else if(inputEl.id === 'dropoff'){
              if(dropoffMarker) map.removeLayer(dropoffMarker);
              dropoffMarker = L.marker(latlng).addTo(map).bindPopup(L.dropoff_label.replace('üèÅ ','')).openPopup(); 
              map.setView(latlng, 14);
            } else if(inputEl.id.startsWith('stop-')){
                 // Th√™m marker cho ƒëi·ªÉm d·ª´ng (L∆∞u √Ω: Marker stop s·∫Ω b·ªã x√≥a khi t√≠nh l·ªô tr√¨nh)
                 L.marker(latlng).addTo(map).bindPopup(L.add_stop_btn.replace('Ôºã ','')).openPopup();
            }
          }
          // G·ªåI TH√äM S·ª∞ KI·ªÜN CHANGE (FIX L·ªñI K√çCH HO·∫†T N√öT)
          inputEl.dispatchEvent(new Event('change'));
          updateCalcButtonState(); 
        });
        fragment.appendChild(d);
      });
      
      boxEl.innerHTML = '';
      boxEl.appendChild(fragment);
      boxEl.style.display = 'block';
      
    }catch(err){
      if(err.name === 'AbortError') return; 
      console.error('suggest error', err);
      boxEl.innerHTML = `<div>${LANGUAGES[currentLang].alert_route_error}</div>`; 
      setTimeout(() => boxEl.style.display = 'none', 2000); 
    }
  }; 

  inputEl.addEventListener('input', debounce(doSearch));
  // FIX: Th√™m listener cho s·ª± ki·ªán change ƒë·ªÉ ƒë·∫£m b·∫£o updateCalcButtonState() ƒë∆∞·ª£c g·ªçi
  inputEl.addEventListener('change', updateCalcButtonState);

  document.addEventListener('click', (ev)=>{
    if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; 
  });
}

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

// =========================================================================
// !!! CODE KH·∫ÆC PH·ª§C L·ªñI T√çNH L·ªò TR√åNH START !!!
// =========================================================================

/**
 * Ki·ªÉm tra xem c·∫£ ƒêi·ªÉm ƒë√≥n v√† ƒêi·ªÉm ƒë·∫øn ƒë√£ c√≥ gi√° tr·ªã ch∆∞a.
 * D√πng ƒë·ªÉ B·∫≠t/T·∫Øt n√∫t T√≠nh gi√°.
 */
function updateCalcButtonState() {
    const isPickupReady = pickupEl.value.trim() !== '';
    const isDropoffReady = dropoffEl.value.trim() !== '';
    
    // N√∫t T√≠nh gi√° ch·ªâ ƒë∆∞·ª£c b·∫≠t n·∫øu d·ªãch v·ª• ƒëang ho·∫°t ƒë·ªông V√Ä c√≥ ƒë·ªß ƒêi·ªÉm ƒë√≥n & ƒêi·ªÉm ƒë·∫øn.
    calcBtn.disabled = !(isServiceActive && isPickupReady && isDropoffReady);
    return isServiceActive && isPickupReady && isDropoffReady;
}

// G·∫Øn s·ª± ki·ªán ƒë·ªÉ ki·ªÉm tra v√† k√≠ch ho·∫°t n√∫t ngay l·∫≠p t·ª©c khi ng∆∞·ªùi d√πng nh·∫≠p li·ªáu
pickupEl.addEventListener('input', updateCalcButtonState);
dropoffEl.addEventListener('input', updateCalcButtonState);
stopsContainer.addEventListener('input', updateCalcButtonState); 
// ƒê√£ th√™m 'change' trong attachAutocomplete()

// =========================================================================
// !!! CODE KH·∫ÆC PH·ª§C L·ªñI T√çNH L·ªò TR√åNH END !!!
// =========================================================================


function createStopInput(prefill=''){
  stopCount++;
  const wrapper = document.createElement('div');
  wrapper.className = 'way-wrapper input-row';
  const inputId = `stop-${stopCount}`;
  const suggId = `${inputId}-suggestions`;
  wrapper.innerHTML = `
    <input type="text" id="${inputId}" placeholder="${LANGUAGES[currentLang].add_stop_btn.replace('Ôºã ', '')} ${stopCount}">
    <button class="clear-btn" data-input-id="${inputId}">‚úñ</button> 
    <button class="way-remove" title="X√≥a">‚úñ</button>
    <div id="${suggId}" class="suggestions" style="display:none"></div>
  `;
  stopsContainer.appendChild(wrapper);

  const inputEl = wrapper.querySelector('input');
  const boxEl = wrapper.querySelector('.suggestions');
  attachAutocomplete(inputEl, boxEl);
  
  const clearBtn = wrapper.querySelector('.clear-btn');
  inputEl.addEventListener('input', () => { 
    clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; 
    updateCalcButtonState(); 
  });
  inputEl.addEventListener('change', updateCalcButtonState); // FIX
  inputEl.addEventListener('focus', () => { 
    clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none'; 
  });
  inputEl.addEventListener('blur', () => { 
    setTimeout(() => clearBtn.style.display = 'none', 150); 
  });
  clearBtn.addEventListener('click', (e) => {
    e.stopPropagation(); 
    inputEl.value = ''; 
    delete inputEl.dataset.lat;
    delete inputEl.dataset.lon;
    boxEl.style.display = 'none';
    inputEl.focus();
    updateCalcButtonState(); 
  });


  wrapper.querySelector('.way-remove').addEventListener('click', ()=> {
    wrapper.remove();
    updateCalcButtonState(); 
  });

  inputEl.addEventListener('focus', ()=> lastFocusedStopId = inputId);
  
  updateCalcButtonState(); 

  return inputEl;
}

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput());

document.getElementById('pick-from-map').addEventListener('click', ()=> { selecting = 'pickup'; alert(LANGUAGES[currentLang].alert_map_pickup); });
document.getElementById('pick-to-map').addEventListener('click', ()=> { selecting = 'dropoff'; alert(LANGUAGES[currentLang].alert_map_dropoff); });

const handleMapClick = async (e) => {
  if (!map) return; 
  const L = LANGUAGES[currentLang];
  const lat = e.latlng.lat, lon = e.latlng.lng;
  
  let targetInput;

  if(selecting === 'pickup'){
    targetInput = pickupEl;
    if(pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([lat,lon]).addTo(map).bindPopup(L.pickup_label.replace('üìç ','')).openPopup();
    selecting = null;
  } else if(selecting === 'dropoff'){
    targetInput = dropoffEl;
    if(dropoffMarker) map.removeLayer(dropoffMarker);
    dropoffMarker = L.marker([lat,lon]).addTo(map).bindPopup(L.dropoff_label.replace('üèÅ ','')).openPopup();
    selecting = null;
  } else if(lastFocusedStopId){
    targetInput = document.getElementById(lastFocusedStopId);
    if(targetInput){
      L.marker([lat,lon]).addTo(map).bindPopup(L.add_stop_btn.replace('Ôºã ','')).openPopup();
      lastFocusedStopId = null;
    }
  }

  if(targetInput){
    const address = await reverseGeocode(lat, lon);
    targetInput.value = address;
    
    targetInput.dataset.lat = lat; targetInput.dataset.lon = lon;
    targetInput.parentNode.querySelector('.clear-btn').style.display = 'block';
    
    if(targetInput === pickupEl || targetInput === dropoffEl) map.setView([lat,lon], 14);
    
    // B·∫ÆN S·ª∞ KI·ªÜN CHANGE ƒê·ªÇ K√çCH HO·∫†T N√öT T√çNH GI√Å
    targetInput.dispatchEvent(new Event('change'));
    updateCalcButtonState(); 
  }
};


const handleMapDblClick = (e) => {
  if (!map) return; 
  const L = LANGUAGES[currentLang];
  if(lastFocusedStopId){
    const stopInput = document.getElementById(lastFocusedStopId);
    if(stopInput){
      stopInput.value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      stopInput.dataset.lat = e.latlng.lat; stopInput.dataset.lon = e.latlng.lng;
      L.marker([e.latlng.lat,e.latlng.lng]).addTo(map).bindPopup(L.add_stop_btn.replace('Ôºã ','')).openPopup();
      lastFocusedStopId = null;
      // B·∫ÆN S·ª∞ KI·ªÜN CHANGE
      stopInput.dispatchEvent(new Event('change'));
      updateCalcButtonState(); 
    }
  }
};


async function resolveCoordForInput(inputEl){
  if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon){
    return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
  }
  const v = inputEl.value.trim();
  if(!v) return null;
  const parts = v.split(',');
  if(parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))){
    return [parseFloat(parts[0]), parseFloat(parts[1])]; 
  }
  // N·∫øu kh√¥ng c√≥ data-lat/lon, c·ªë g·∫Øng geocode (ch·ªâ x·∫£y ra khi ng∆∞·ªùi d√πng nh·∫≠p tay)
  const place = await geocodeOnce(v + ' Vi·ªát Nam');
  if(place){
    inputEl.dataset.lat = place.lat;
    inputEl.dataset.lon = place.lon;
    return [parseFloat(place.lat), parseFloat(place.lon)];
  }
  return null;
}

function validateRouteInputs() {
    const L = LANGUAGES[currentLang];
    if (pickupEl.value.trim() === '') {
        alert(L.alert_pickup_empty);
        pickupEl.focus();
        return false;
    }
    if (dropoffEl.value.trim() === '') {
        alert(L.alert_dropoff_empty);
        dropoffEl.focus();
        return false;
    }
    const tripType = tripTypeEl.value; 
    const waiting = parseFloat(waitingEl.value); 
    if (tripType === '2') {
        if (isNaN(waiting) || waiting < 0) {
            alert(L.alert_waiting_invalid);
            waitingEl.focus();
            return false;
        }
    }
    return true;
}

function validatePhone(phone) {
    const phoneRegex = /^\d{10}$/; 
    return phoneRegex.test(phone);
}

// H√†m ch√≠nh t√≠nh gi√° c∆∞·ªõc v√† t·∫°o tin nh·∫Øn Zalo
async function calculateAndGenerateMessage() {
    const L = LANGUAGES[currentLang];

    if (!validateRouteInputs()) {
        return false; 
    }
    
    // B·∫Øt ƒë·∫ßu t√≠nh to√°n, n·∫øu thi·∫øu t·ªça ƒë·ªô s·∫Ω b√°o l·ªói chi ti·∫øt
    const pickupCoord = await resolveCoordForInput(pickupEl);
    if(!pickupCoord){ alert(L.alert_pickup_coord_fail); return false; }
    const dropoffCoord = await resolveCoordForInput(dropoffEl);
    if(!dropoffCoord){ alert(L.alert_dropoff_coord_fail); return false; }

    const coords = [];
    coords.push(pickupCoord);
    const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
    for(const s of stopInputs){
        if(s.value.trim()){
            const sc = await resolveCoordForInput(s);
            if(!sc){ alert(L.alert_stop_coord_fail); return false; }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord);

    const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
    const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

    resultBox.style.display = 'block';
    distanceText.textContent = L.instruction_loading.replace('üí∞ ', '');
    priceValue.textContent = '...';
    priceBreak.innerHTML = '';
    timeEst.textContent = L.time_est;
    finalZaloMessage = ''; 
    finalTotalFee = 0;
    zaloBtn.style.display = 'none'; 
    mailBtn.style.display = 'none';
    instructionText.innerHTML = L.instruction_loading;

    try{
        const r = await fetch(url);
        // FIX: B·∫Øt l·ªói JSON parse n·∫øu OSRM tr·∫£ v·ªÅ response l·ªói (th∆∞·ªùng l√† 404/500)
        if (!r.ok) {
             throw new Error(`OSRM API error: ${r.statusText}`);
        }
        const data = await r.json();
        
        if(!data.routes || data.routes.length === 0){ distanceText.textContent = L.alert_route_fail; return false; }
        
        const route = data.routes[0];
        const dist = route.distance / 1000; 
        const minutes = Math.round((route.duration / 60)); 

        if(map) {
            // FIX: X√≥a t·∫•t c·∫£ markers/layers c≈© tr∆∞·ªõc khi v·∫Ω l·∫°i route v√† markers
            if(routeLayer) map.removeLayer(routeLayer);
            if(pickupMarker) map.removeLayer(pickupMarker);
            if(dropoffMarker) map.removeLayer(dropoffMarker);
            
            // X√≥a c√°c marker stop c≈©
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker && layer !== pickupMarker && layer !== dropoffMarker && !layer.getPopup()?.getContent()?.includes('ƒêi·ªÉm ƒë·∫øn') && !layer.getPopup()?.getContent()?.includes('ƒêi·ªÉm ƒë√≥n')) {
                    map.removeLayer(layer);
                }
            });
            
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            
            // Th√™m l·∫°i markers cho ƒëi·ªÉm ƒë·∫ßu v√† cu·ªëi
            const startCoord = coords[0];
            const endCoord = coords[coords.length - 1];
            
            pickupMarker = L.marker(startCoord).addTo(map).bindPopup(L.pickup_label.replace('üìç ','')).openPopup();
            dropoffMarker = L.marker(endCoord).addTo(map).bindPopup(L.dropoff_label.replace('üèÅ ','')).openPopup();
            
            map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
            map.invalidateSize(); 
        }

        const tripType = tripTypeEl.value; 
        const carType = carTypeEl.value; 
        const driverRequest = driverRequestEl.value;
        const waiting = parseFloat(waitingEl.value) || 0; 
        
        let perKm;
        const carTypeKey = carType.includes('7 ch·ªó') || carType.includes('7-seater') || carType.includes('7Â∫ßËΩ¶') ? '7 ch·ªó' : '4 ch·ªó';
        if (carTypeKey === '7 ch·ªó') { perKm = 12000; } else { perKm = 10000; }
        const perKmReturnDiscount = Math.round(perKm * 0.6); 

        const priceGo = Math.round(dist * perKm);
        let priceReturn = 0;
        let returnNote = LANGUAGES.vn.trip_2.split('(')[1].replace(')', ''); 
        if(currentLang !== 'vn') returnNote = LANGUAGES[currentLang].trip_2.split('(')[1].replace(')', '');

        if(tripType === '2') {
            if(dist >= 45) {
                priceReturn = Math.round(dist * perKmReturnDiscount); 
            } else {
                priceReturn = Math.round(dist * perKm); 
            }
        } 

        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total; 
        const depositAmountValue = Math.round(total * 0.2); 

        distanceText.textContent = `${L.distance_text.split(':')[0]}: ${dist.toFixed(1)} km (${LANGUAGES.vn.trip_1.toLowerCase()})`;
        priceValue.textContent = total.toLocaleString('vi-VN') + ' ƒë';

        let breakdownHtml = '';
        breakdownHtml += `‚Ä¢ ${LANGUAGES.vn.price_title.replace('üíµ ', '').replace('d·ª± ki·∫øn', 'chi·ªÅu ƒëi')}: <b>${priceGo.toLocaleString('vi-VN')} ƒë</b><br>`;
        
        if(tripType === '2'){
            breakdownHtml += `‚Ä¢ ${LANGUAGES.vn.trip_2.split('(')[0].trim()} (${returnNote}): <b>${priceReturn.toLocaleString('vi-VN')} ƒë</b><br>`;
        }

        let zaloWaitingDetail = '';
        if (tripType === '2') {
            const waitLabel = LANGUAGES.vn.waiting_label.split('(');
            if (waiting > 3) {
                zaloWaitingDetail = `‚è≥ ${L.waiting_label.split('(')[0].trim()}: ${waiting} ${waitLabel[1].replace(')', '')} (Ph√≠ ch·ªù ph√°t sinh: ${waitFee.toLocaleString('vi-VN')} ƒë)`;
                breakdownHtml += `‚Ä¢ ${waitLabel[0].trim()} (${waiting} ${waitLabel[1].replace(')', '')}, mi·ªÖn ph√≠ 0‚Äì3h): <b>${waitFee.toLocaleString('vi-VN')} ƒë</b><br>`;
            } else if (waiting > 0) {
                zaloWaitingDetail = `‚è≥ ${L.waiting_label.split('(')[0].trim()}: ${waiting} ${waitLabel[1].replace(')', '')} (Mi·ªÖn ph√≠)`;
                breakdownHtml += `‚Ä¢ ${waitLabel[0].trim()} (${waiting} ${waitLabel[1].replace(')', '')}): <b>Mi·ªÖn ph√≠</b><br>`;
            } 
        }
        
        breakdownHtml += `<hr style="margin:6px 0">‚Ä¢ <b>${L.price_title.replace('üíµ ', '').replace('d·ª± ki·∫øn', 'T·ªïng c·ªông')}: ${total.toLocaleString('vi-VN')} ƒë</b>`;
        priceBreak.innerHTML = breakdownHtml;

        timeEst.textContent = `${L.time_est.split(':')[0]}: ${minutes} ${L.time_est.split('‚Äî ')[1]}`;

        const dateVal = pickupDateTime.value;
        const formattedDate = dateVal ? new Date(dateVal).toLocaleString(currentLang, { 
            year: 'numeric', month: 'numeric', day: 'numeric', 
            hour: '2-digit', minute: '2-digit', 
            hour12: false 
        }) : `(${LANGUAGES.vn.pickup_info.split(':')[1].trim()})`;
        pickupInfo.textContent = `${L.pickup_info.split(':')[0]}: ${formattedDate}`;
        
        const stopInputsValues = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'))
            .map(s => s.value.trim()).filter(v => v);
        
        const stopDetails = stopInputsValues.map((v, i) => `üõ£Ô∏è ${LANGUAGES.vn.add_stop_btn.replace('Ôºã ', '')} ${i+1}: ${v}`).join('\n');
        
        
        const pickupAddress = pickupEl.value.trim();
        const dropoffAddress = dropoffEl.value.trim();
        const pickupLatLon = `${pickupCoord[0]},${pickupCoord[1]}`;
        const dropoffLatLon = `${dropoffCoord[0]},${dropoffCoord[1]}`;
        const mapsDirectionLink = `${GOOGLE_MAPS_DIR_URL}${pickupLatLon}/${dropoffLatLon}`;
        const mapsPickupLink = `${GOOGLE_MAPS_BASE_URL}${pickupLatLon}`; 
        
        let mapsLinksSection = [
            `\n*** üó∫Ô∏è LI√äN K·∫æT B·∫¢N ƒê·ªí CH√çNH X√ÅC ***`,
            `üìç V·ªã tr√≠ ƒë√≥n kh√°ch (T·ªça ƒë·ªô): ${mapsPickupLink}`,
            `üõ£Ô∏è Ch·ªâ ƒë∆∞·ªùng (ƒê√≥n -> Tr·∫£): ${mapsDirectionLink}`,
            `\n`
        ].join('\n');
        
        let depositSection = '';
        if (tripType === '2') {
            depositSection = `\nüí∞ ƒê·∫∂T C·ªåC: ${depositAmountValue.toLocaleString('vi-VN')} ƒë (20% T·ªïng ph√≠)`;
        }

        finalZaloMessage = [
            `üöñ ${LANGUAGES.vn.title.replace('üöñ ', '')} - Y√äU C·∫¶U ƒê·∫∂T XE`,
            '-------------------------------',
            `üìû SƒêT Kh√°ch h√†ng: [CH∆ØA C√ì]`, 
            `‚úÖ Lo·∫°i chuy·∫øn: ${tripType === '1' ? LANGUAGES.vn.trip_1 : `${LANGUAGES.vn.trip_2.split('(')[0].trim()} (${dist.toFixed(1)} km/${LANGUAGES.vn.trip_1.toLowerCase()})`}`,
            `üöò Lo·∫°i xe: ${carType}`, 
            `üßë‚Äç‚úàÔ∏è ${LANGUAGES.vn.driver_request_label}: ${driverRequest}`,
            `üìç ${LANGUAGES.vn.pickup_label}: ${pickupAddress}`,
            ...(stopInputsValues.length ? [stopDetails] : []),
            `üèÅ ${LANGUAGES.vn.dropoff_label}: ${dropoffAddress}`,
            `üïí ${LANGUAGES.vn.datetime_label}: ${formattedDate}`,
            ...(tripType === '2' ? [zaloWaitingDetail] : []), 
            `üíµ ${LANGUAGES.vn.price_title.split(':')[0].trim()}: ${total.toLocaleString('vi-VN')} ƒë`,
            depositSection, 
            mapsLinksSection, 
            '-------------------------------',
            LANGUAGES.vn.deposit_text5.split('**L∆∞u √Ω:**')[0].trim() + LANGUAGES.vn.deposit_text5.split('**L∆∞u √Ω:**')[1].trim().split('Xin ch√¢n th√†nh')[0].trim(),
        ].join('\n');

        zaloBtn.style.display = 'block'; 
        mailBtn.style.display = 'block'; 
        instructionText.style.display = 'block';
        instructionText.innerHTML = `‚úÖ **${LANGUAGES.vn.calc_btn.replace('üí∞ ', '')} th√†nh c√¥ng!** Vui l√≤ng b·∫•m **${L.zalo_btn.split(' ')[1]}/${L.mail_btn.split(' ')[1]}** ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng.`;

        resultBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return true; 
    }catch(err){
        console.error('Route error', err);
        // TH√îNG B√ÅO L·ªñI R√ï R√ÄNG H∆†N KHI OSRM G·∫∂P V·∫§N ƒê·ªÄ
        let errorMsg = L.alert_route_error;
        if (err.message.includes('OSRM API error')) {
            errorMsg = `‚ö†Ô∏è L·ªói m√°y ch·ªß ƒê·ªãnh tuy·∫øn (OSRM). Vui l√≤ng th·ª≠ l·∫°i sau v√†i gi√¢y ho·∫∑c ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.`;
        }
        distanceText.textContent = errorMsg;
        priceValue.textContent = '‚Äî';
        mailBtn.href = `mailto:netvuan@gmail.com`;
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        instructionText.innerHTML = errorMsg;
        return false;
    }
}

// X·ª≠ l√Ω n√∫t T√≠nh gi√°
calcBtn.addEventListener('click', async () => {
  if (!isServiceActive) {
      alert(LANGUAGES[currentLang].alert_service_off);
      return;
  }
  
  if(!updateCalcButtonState()) {
    alert(LANGUAGES[currentLang].alert_pickup_empty + ' & ' + LANGUAGES[currentLang].alert_dropoff_empty);
    return;
  }
  
  const success = await calculateAndGenerateMessage();

  if(success && tripTypeEl.value === '2') {
    const deposit = Math.round(finalTotalFee * 0.2);
    depositAmount.textContent = deposit.toLocaleString('vi-VN') + ' ƒë';
    depositModal.style.display = 'flex';
  }
});

// X·ª≠ l√Ω n√∫t ƒê·∫∑t qua Zalo / Mail
function handleBookingClick(action) {
    const L = LANGUAGES[currentLang];
    if (finalTotalFee === 0) {
        alert(L.alert_calc_first);
        return;
    }
    
    bookingAction = action;
    const phone = customerPhoneEl.value.trim();

    if (!validatePhone(phone)) {
        inputPhoneForBooking.value = phone;
        phoneModal.style.display = 'flex';
        inputPhoneForBooking.focus();
    } else {
        openFinalZaloModal(phone);
    }
}

zaloBtn.addEventListener('click', () => handleBookingClick('zalo'));
mailBtn.addEventListener('click', () => handleBookingClick('mail'));

// X·ª≠ l√Ω x√°c nh·∫≠n SƒêT trong Phone Modal
confirmPhoneBtn.addEventListener('click', () => {
    const L = LANGUAGES[currentLang];
    const phone = inputPhoneForBooking.value.trim();
    if (!validatePhone(phone)) {
        alert(L.alert_invalid_phone);
        inputPhoneForBooking.focus();
        return;
    }
    customerPhoneEl.value = phone; 
    phoneModal.style.display = 'none';

    if (bookingAction) {
        openFinalZaloModal(phone);
    }
});

// X·ª≠ l√Ω x√°c nh·∫≠n ƒë·∫∑t c·ªçc
confirmDepositBtn.addEventListener('click', () => {
    depositModal.style.display = 'none';
});

// M·ªü Modal Zalo/Mail ch√≠nh
function openFinalZaloModal(phone) {
    const L = LANGUAGES[currentLang];
    let finalMessage = finalZaloMessage.replace('[CH∆ØA C√ì]', phone);
    modalText.textContent = finalMessage;

    if(bookingAction === 'mail') {
        const encodedMsg = encodeURIComponent(finalMessage);
        const subject = encodeURIComponent(`${L.title.replace('üöñ ', '').split(' ')[0]} - ${L.price_title.split(':')[0].trim()} - ${distanceText.textContent.split(': ')[1]}`);
        mailBtn.href = `mailto:netvuan@gmail.com?subject=${subject}&body=${encodedMsg}`;
        alert(L.alert_mail_success);
        window.location.href = mailBtn.href;
        zaloModal.style.display = 'none';
        bookingAction = null;
        return;
    }

    zaloModal.style.display = 'flex'; 

    copyToClipboard(finalMessage).then(success => {
        if(success) {
            console.log("ƒê√£ sao ch√©p tin nh·∫Øn Zalo th√†nh c√¥ng.");
        }
    });

    bookingAction = null; 
}


async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        console.warn('Fallback: Copying directly from DOM');
        try {
            const range = document.createRange();
            range.selectNodeContents(modalText);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            document.execCommand('copy');
            selection.removeAllRanges(); 
            return true;
        } catch (errFallback) {
            console.error('Kh√¥ng th·ªÉ th·ª±c hi·ªán sao ch√©p:', errFallback);
            return false;
        }
    }
}

copyModalBtn.addEventListener('click', async () => {
    const L = LANGUAGES[currentLang];
    const success = await copyToClipboard(modalText.textContent);
    
    if (success) {
        alert(L.alert_copy_success);
        window.getSelection().removeAllRanges();
        
    } else {
        alert(L.alert_copy_fail);
    }
});

zaloModalBtn.addEventListener('click', () => {
    window.getSelection().removeAllRanges(); 
    zaloModal.style.display = 'none'; 
    window.open(ZALO_URL, '_blank');
});

// Close Modals
[closeModalBtn, closePhoneModalBtn, zaloModal, phoneModal, depositModal].forEach(el => {
    el.addEventListener('click', (e) => {
        if (e.target === el || e.target === closeModalBtn || e.target === closePhoneModalBtn) {
            window.getSelection().removeAllRanges();
            zaloModal.style.display = 'none';
            phoneModal.style.display = 'none';
            depositModal.style.display = 'none';
            bookingAction = null; 
        }
    });
});


/* ------------------------------------------------------------------
   CH·ª®C NƒÇNG PH·ª§ TR·ª¢ (HELPER FUNCTIONS) - Gi·ªØ nguy√™n
   ------------------------------------------------------------------ */
function setMinPickupDateTime() {
    const now = new Date();
    const minTime = new Date(now.getTime() + 30 * 60000); 

    const formatDateTime = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${y}-${m}-${d}T${h}:${min}`;
    };

    const minDateTimeString = formatDateTime(minTime);
    
    pickupDateTime.setAttribute('min', minDateTimeString);
    if (!pickupDateTime.value) {
        pickupDateTime.value = minDateTimeString;
    }
}

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
            inputEl.value = '';
            delete inputEl.dataset.lat;
            delete inputEl.dataset.lon;
            if (inputId === 'pickup' && pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            } else if (inputId === 'dropoff' && dropoffMarker) {
                map.removeLayer(dropoffMarker);
                dropoffMarker = null;
            }
            const suggBox = document.getElementById(`${inputId}-suggestions`);
            if (suggBox) suggBox.style.display = 'none';
            inputEl.focus(); 
            updateCalcButtonState(); 
        }
    });
});
document.querySelectorAll('input[type="text"], input[type="tel"]').forEach(inputEl => {
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if (clearBtn) {
        inputEl.addEventListener('input', () => {
            clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        inputEl.addEventListener('focus', () => {
             clearBtn.style.display = inputEl.value.trim() ? 'block' : 'none';
        });
        // FIX: ƒê·ªïi th·ªùi gian timeout cho blur ƒë·ªÉ n√∫t clear kh√¥ng b·ªã ·∫©n ngay l·∫≠p t·ª©c
        inputEl.addEventListener('blur', () => {
             setTimeout(() => {
                if (!document.activeElement.classList.contains('clear-btn')) {
                    clearBtn.style.display = 'none';
                }
             }, 200); 
        });
    }
});

// Th√™m listener cho n√∫t clear button ƒë·ªÉ khi hover/focus v√†o n√∫t clear, n√≥ kh√¥ng b·ªã ·∫©n do blur c·ªßa input
document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('mouseenter', () => btn.style.display = 'block');
    btn.addEventListener('mouseleave', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        // Ch·ªâ ·∫©n n·∫øu input kh√¥ng c√≥ focus
        if (inputEl && inputEl !== document.activeElement) {
            btn.style.display = 'none';
        }
    });
});


/* ------------------------------------------------------------------
   KH·ªûI T·∫†O V√Ä POLLING
   ------------------------------------------------------------------ */
document.addEventListener('DOMContentLoaded', async ()=>{
    // X·ª≠ l√Ω ng√¥n ng·ªØ ban ƒë·∫ßu
    const savedLang = localStorage.getItem('appLang') || 'vn';
    langSelector.value = savedLang;
    currentLang = savedLang;
    updateUIWithLanguage(currentLang); 

    // L·∫Øng nghe s·ª± ki·ªán ƒë·ªïi ng√¥n ng·ªØ
    langSelector.addEventListener('change', async (e) => {
        currentLang = e.target.value;
        updateUIWithLanguage(currentLang);
        localStorage.setItem('appLang', currentLang);
        // C·∫ßn c·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i d·ªãch v·ª• (Kill Switch) v√† v·ªã tr√≠ sau khi ƒë·ªïi ng√¥n ng·ªØ
        const status = await checkServiceStatus();
        await updateUIBasedOnStatus(status);
        getGeolocation(); 
    });

    setMinPickupDateTime();
    getGeolocation(); 
    
    const status = await checkServiceStatus();
    await updateUIBasedOnStatus(status);
    
    updateCalcButtonState(); 

    setInterval(async () => {
        const newStatus = await checkServiceStatus();
        if (newStatus.active !== isServiceActive) {
            await updateUIBasedOnStatus(newStatus);
        }
        setMinPickupDateTime(); 
    }, 15000); 
    
    reloadLocationBtn.addEventListener('click', getGeolocation); 
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then((reg) => {
        console.log('Service worker registered.', reg);
      })
      .catch((err) => {
        console.log('Service worker registration failed: ', err);
      });
  });
}
</script>
</body>
</html>
