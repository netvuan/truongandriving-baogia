<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRƯỜNG AN DRIVING - HỆ THỐNG ĐẶT XE CHUYÊN NGHIỆP (PRO VERSION)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* * ============================================================
         * PHẦN CSS: ĐỊNH DẠNG GIAO DIỆN CHI TIẾT
         * Giữ nguyên cấu trúc chi tiết để đảm bảo hiển thị đẹp nhất
         * ============================================================
         */

        :root {
            --primary-color: #28a745;   /* Màu xanh chủ đạo (Nút tính tiền, Icon) */
            --danger-color: #dc3545;    /* Màu đỏ (Nút xóa, Giá tiền) */
            --info-color: #007bff;      /* Màu xanh dương (Nút vị trí, Zalo) */
            --bg-color: #f4f6f8;        /* Màu nền tổng thể */
            --text-color: #333333;      /* Màu chữ chính */
            --header-bg: #008000;       /* Màu nền Header */
            --yellow-highlight: #ffeb3b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Container chính mô phỏng App Mobile */
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            padding-bottom: 120px; /* Khoảng trống cho thanh menu dưới */
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* --- HEADER (THANH TIÊU ĐỀ) --- */
        header {
            background-color: var(--header-bg);
            padding: 15px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .brand-col {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .brand-name {
            font-weight: 900;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        .hotline {
            font-size: 14px;
            color: #d00000;
            font-weight: 800;
            background: var(--yellow-highlight);
            padding: 4px 8px;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            width: fit-content;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Nút chuyển đổi ngôn ngữ */
        .lang-grp {
            display: flex;
            gap: 8px;
        }

        .lang-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .lang-btn.active {
            background: white;
            color: var(--header-bg);
            font-weight: bold;
            border-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- CÁC KHỐI SECTION --- */
        .section {
            padding: 20px 15px;
            border-bottom: 8px solid var(--bg-color);
        }

        .sec-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .sec-title {
            font-weight: 800;
            font-size: 16px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .t-info { color: #555; }
        .t-route { color: var(--primary-color); }
        .t-opt { color: var(--danger-color); }

        /* Nút lấy vị trí hiện tại */
        .btn-myloc {
            color: var(--info-color);
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid var(--info-color);
            padding: 6px 12px;
            border-radius: 20px;
            background: #fff;
            transition: background 0.2s;
        }

        .btn-myloc:hover {
            background: #f0f7ff;
        }

        .btn-myloc i {
            color: var(--danger-color);
        }

        /* --- FORM INPUT --- */
        .form-group {
            margin-bottom: 18px;
            position: relative;
        }

        .form-label {
            font-size: 13px;
            font-weight: 700;
            color: #444;
            margin-bottom: 8px;
            display: block;
        }

        input, select, textarea { 
            width: 100%;
            padding: 14px 15px;
            padding-right: 90px; /* Chừa chỗ cho nút xóa/map */
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 15px;
            outline: none;
            box-sizing: border-box;
            background: #fff;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            color: #000;
        }

        input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.1);
        }
        
        /* Các nút công cụ trong Input (Xóa, Map) */
        .input-tools {
            position: absolute;
            right: 8px;
            top: 33px; /* Căn chỉnh theo chiều cao input */
            display: flex;
            gap: 6px;
        }

        .tool-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: transform 0.1s;
        }

        .tool-btn:active {
            transform: scale(0.95);
        }

        .btn-x {
            background: #f0f0f0;
            color: #777;
            display: none; /* Mặc định ẩn, hiện khi có text */
        }

        .btn-map {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        } 

        .btn-trash {
            background: var(--danger-color);
            color: white;
        }

        /* --- GỢI Ý ĐỊA ĐIỂM (AUTOCOMPLETE) --- */
        .suggestions {
            position: absolute;
            top: 105%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #eee;
            z-index: 1001;
            max-height: 280px;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: none;
        }

        .sug-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f9f9f9;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: background 0.2s;
        }

        .sug-item:hover {
            background: #f5f5f5;
        }

        .sug-item i {
            color: #999;
            margin-top: 4px;
        }

        /* Trạng thái loading khi debounce */
        .search-status {
            font-size: 12px;
            color: var(--primary-color);
            font-style: italic;
            margin-top: 6px;
            display: none;
            font-weight: 500;
        }

        .btn-add-stop {
            width: 100%;
            color: var(--primary-color);
            background: none;
            border: 1px dashed var(--primary-color);
            border-radius: 8px;
            padding: 12px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: 0.2s;
        }

        .btn-add-stop:hover {
            background: rgba(40, 167, 69, 0.05);
        }

        #main-map {
            height: 250px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            display: none;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
        }

        /* --- KHUNG KẾT QUẢ GIÁ --- */
        #result-area {
            display: none;
            margin-top: 15px;
            background: #f0fff4; /* Nền xanh nhạt */
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #c3e6cb;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.1);
        }

        .price-tag {
            font-size: 32px;
            color: var(--danger-color);
            font-weight: 900;
            text-align: center;
            margin: 15px 0;
            border-top: 2px dashed #ddd;
            padding-top: 15px;
            letter-spacing: -1px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 15px;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 8px;
        }

        .detail-row strong {
            font-weight: 700;
        }
        
        .note-text {
            font-size: 12px; 
            color: #666; 
            text-align: center; 
            margin-top: 10px;
            font-style: italic;
        }

        /* --- THANH ĐẶT XE (FIXED BOTTOM) --- */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 15px;
            display: flex;
            gap: 12px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            box-sizing: border-box;
            border-top: 1px solid #eee;
        }

        .btn-calc {
            flex: 1;
            background: var(--primary-color);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
            transition: transform 0.2s;
        }
        
        .btn-calc:active {
            transform: scale(0.98);
        }

        .act-btn {
            flex: 1;
            padding: 14px;
            border-radius: 10px;
            border: none;
            color: white;
            font-weight: 800;
            cursor: pointer;
            font-size: 15px;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .zalo { background: #0068ff; } 
        .mail { background: var(--danger-color); }

        /* --- MODAL BẢN ĐỒ --- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            padding: 15px;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 15px;
            overflow: hidden;
            height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .modal-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #picker-map {
            flex: 1;
            width: 100%;
        }
        
        /* Icon ghim giữa bản đồ modal */
        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 1000;
            width: 40px;
            pointer-events: none;
        }
    </style>
</head>
<body>

<header>
    <div class="brand-col">
        <div class="brand-name" data-i18n="brand">TRƯỜNG AN DRIVING</div>
        <a href="tel:0847526893" class="hotline">☎️ 084.752.6893</a>
    </div>
    <div class="lang-grp">
        <button class="lang-btn active" onclick="changeLang('vi')">VN</button>
        <button class="lang-btn" onclick="changeLang('en')">EN</button>
        <button class="lang-btn" onclick="changeLang('cn')">CN</button>
    </div>
</header>

<div class="container">
    <div class="section">
        <div class="sec-head">
            <div class="sec-title t-info"><i class="fas fa-user-edit"></i> <span data-i18n="sec_info">THÔNG TIN KHÁCH HÀNG</span></div>
        </div>
        <div class="form-group">
            <label class="form-label" data-i18n="lbl_phone">Số điện thoại:</label>
            <input type="tel" id="phone" placeholder="Nhập số điện thoại...">
            <div class="input-tools" style="top:31px"><button class="tool-btn btn-x" onclick="clearInp('phone')">✕</button></div>
        </div>
        <div class="form-group">
            <label class="form-label" data-i18n="lbl_time">Thời gian đón:</label>
            <input type="datetime-local" id="time">
        </div>
    </div>

    <div class="section">
        <div class="sec-head">
            <div class="sec-title t-route"><i class="fas fa-route"></i> <span data-i18n="sec_route">LỘ TRÌNH DI CHUYỂN</span></div>
            <button class="btn-myloc" onclick="getMyLoc()"><i class="fas fa-location-arrow"></i> <span data-i18n="btn_myloc">VỊ TRÍ TÔI</span></button>
        </div>

        <div class="form-group">
            <label class="form-label" data-i18n="lbl_pickup">Điểm đón:</label>
            <input type="text" id="pickup" placeholder="Tìm điểm đón..." autocomplete="off">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('pickup')">✕</button>
                <button class="tool-btn btn-map" onclick="openMap('pickup')"><i class="fas fa-map-marker-alt"></i></button>
            </div>
            <div class="search-status" data-i18n="search_loading">⏳ Đang đợi bạn nhập xong (1s)...</div>
            <div class="suggestions"></div>
        </div>

        <div id="stops-container"></div>
        <button class="btn-add-stop" onclick="addStop()" data-i18n="btn_add_stop">+ Thêm điểm dừng (Nếu có)</button>

        <div class="form-group">
            <label class="form-label" data-i18n="lbl_dropoff">Điểm đến:</label>
            <input type="text" id="dropoff" placeholder="Tìm điểm đến..." autocomplete="off">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('dropoff')">✕</button>
                <button class="tool-btn btn-map" onclick="openMap('dropoff')"><i class="fas fa-map-marker-alt"></i></button>
            </div>
            <div class="search-status" data-i18n="search_loading">⏳ Đang đợi bạn nhập xong (1s)...</div>
            <div class="suggestions"></div>
        </div>
        
        <div id="main-map"></div>
    </div>

    <div class="section">
        <div class="sec-head"><div class="sec-title t-opt"><i class="fas fa-sliders-h"></i> <span data-i18n="sec_opt">TÙY CHỌN DỊCH VỤ</span></div></div>
        <div style="display:flex; gap:12px;">
            <div class="form-group" style="flex:1">
                <label class="form-label" data-i18n="lbl_car">Loại xe:</label>
                <select id="carType" onchange="resetButtonsAndMap()">
                    <option value="4" data-i18n="opt_4seat_disp">Xe 4 chỗ (10k/km)</option>
                    <option value="7" data-i18n="opt_7seat_disp">Xe 7 chỗ (12k/km)</option>
                </select>
            </div>
            <div class="form-group" style="flex:1">
                <label class="form-label" data-i18n="lbl_type">Hình thức:</label>
                <select id="tripType" onchange="resetButtonsAndMap()">
                    <option value="1" data-i18n="opt_1way_disp">Đi 1 Chiều</option>
                    <option value="2" data-i18n="opt_2way_disp">Đi 2 Chiều (-40%)</option>
                </select>
            </div>
        </div>

        <div id="result-area">
            <div class="detail-row"><span data-i18n="res_dist">Quãng đường:</span> <strong id="res-km">0 km</strong></div>
            <div class="detail-row" id="row-go"><span data-i18n="res_go_price">Giá chiều đi:</span> <strong id="val-go">0</strong></div>
            <div class="detail-row" id="row-back" style="display:none;"><span data-i18n="res_return_disc">Chiều về (Giảm 40%):</span> <strong id="val-back">0</strong></div>
            <div class="detail-row" id="row-deposit" style="display:none; color:var(--danger-color); font-weight:bold;"><span data-i18n="res_deposit">Cọc giữ xe (20%):</span> <strong id="val-deposit">0</strong></div>
            <div class="price-tag" id="res-total">0 đ</div>
            <div class="note-text" data-i18n="note_toll_fee_small">* Giá chưa bao gồm phí cầu đường, bến bãi.</div>
        </div>
    </div>
</div>

<div class="bottom-bar">
    <button class="btn-calc" id="btn-calc-main" onclick="calculate()"><i class="fas fa-calculator"></i> <span data-i18n="btn_calc">TÍNH GIÁ CƯỚC</span></button>
    <div id="book-buttons-bar" style="display:none; width:100%; gap:10px;">
        <button class="act-btn zalo" onclick="book('zalo')">ĐẶT QUA ZALO</button>
        <button class="act-btn mail" onclick="book('mail')">ĐẶT QUA EMAIL</button>
    </div>
</div>

<div id="modal-map" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span data-i18n="modal_map_title">CHỌN VỊ TRÍ TRÊN BẢN ĐỒ</span>
            <span onclick="closeMap()" style="cursor:pointer; font-size:20px;">✕</span>
        </div>
        <div id="picker-map"></div>
        <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" class="center-marker">
        <div style="padding:15px; background:white; border-top:1px solid #eee;">
            <button class="btn-calc" onclick="confirmMap()" style="width:100%">XÁC NHẬN VỊ TRÍ</button>
        </div>
    </div>
</div>
<script>
    /**
     * =================================================================
     * CẤU HÌNH API VÀ CÁC BIẾN TOÀN CỤC
     * =================================================================
     */
    const GOONG_API_KEY = 'Lrrqqduqt0pfhNfmh0bzjN9lqwEqqY8rSpCs3gcG'; // Key của bạn
    
    // Biến quản lý Debounce (Trì hoãn gọi API)
    let debounceTimer; 
    
    // Biến Session Token (Để tiết kiệm chi phí Google/Goong)
    let sessionToken = generateUUID();

    // Các biến bản đồ
    let map;            // Bản đồ chính hiển thị lộ trình
    let pickerMap;      // Bản đồ trong Modal để chọn điểm
    let routeLayer;     // Layer vẽ đường đi
    let activeInp;      // Input đang được thao tác (đón hoặc trả)

    /**
     * HÀM TẠO UUID CHO SESSION TOKEN
     * Giúp Goong nhận diện phiên làm việc, tính tiền 1 lần cho chuỗi tìm kiếm
     */
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    /**
     * =================================================================
     * BỘ DỮ LIỆU ĐA NGÔN NGỮ (VN - EN - CN)
     * =================================================================
     */
    const LANG = {
        vi: { 
            brand: "TRƯỜNG AN DRIVING", 
            sec_info: "THÔNG TIN KHÁCH HÀNG", 
            sec_route: "LỘ TRÌNH DI CHUYỂN", 
            sec_opt: "TÙY CHỌN DỊCH VỤ",
            lbl_phone: "Số điện thoại:", 
            lbl_time: "Thời gian đón:", 
            lbl_pickup: "Điểm đón:", 
            lbl_dropoff: "Điểm đến:",
            lbl_car: "Loại xe:", 
            lbl_type: "Hình thức:", 
            btn_add_stop: "+ Thêm điểm dừng (Nếu có)", 
            btn_calc: "TÍNH GIÁ CƯỚC",
            btn_myloc: "VỊ TRÍ TÔI", 
            search_loading: "⏳ Đang đợi bạn nhập xong (1s)...", 
            res_dist: "Quãng đường:", 
            res_go_price: "Giá chiều đi:",
            res_return_disc: "Chiều về (Giảm 40%):", 
            res_deposit: "Cọc giữ xe (20%):", 
            modal_map_title: "CHỌN VỊ TRÍ TRÊN BẢN ĐỒ",
            opt_4seat_disp: "Xe 4 chỗ (10k/km)",
            opt_7seat_disp: "Xe 7 chỗ (12k/km)",
            opt_1way_disp: "Đi 1 Chiều",
            opt_2way_disp: "Đi 2 Chiều (-40%)",
            note_toll_fee_small: "* Giá chưa bao gồm phí cầu đường, bến bãi."
        },
        en: { 
            brand: "TRUONG AN DRIVING", 
            sec_info: "CUSTOMER INFO", 
            sec_route: "TRIP ROUTE", 
            sec_opt: "SERVICE OPTIONS",
            lbl_phone: "Phone Number:", 
            lbl_time: "Pickup Time:", 
            lbl_pickup: "Pickup Point:", 
            lbl_dropoff: "Drop-off Point:",
            lbl_car: "Car Type:", 
            lbl_type: "Trip Type:", 
            btn_add_stop: "+ Add Stop Point", 
            btn_calc: "CALCULATE FARE",
            btn_myloc: "MY LOCATION", 
            search_loading: "⏳ Waiting for input (1s)...", 
            res_dist: "Distance:", 
            res_go_price: "Outbound fare:",
            res_return_disc: "Return (40% Off):", 
            res_deposit: "Deposit (20%):", 
            modal_map_title: "PICK LOCATION ON MAP",
            opt_4seat_disp: "4 Seats Car",
            opt_7seat_disp: "7 Seats Car",
            opt_1way_disp: "One Way",
            opt_2way_disp: "Round Trip (-40%)",
            note_toll_fee_small: "* Toll fees not included."
        },
        cn: { 
            brand: "长安驾驶", 
            sec_info: "客户信息", 
            sec_route: "行车路线", 
            sec_opt: "服务选项",
            lbl_phone: "电话号码:", 
            lbl_time: "接送时间:", 
            lbl_pickup: "上车地点:", 
            lbl_dropoff: "下车地点:",
            lbl_car: "车型:", 
            lbl_type: "行程类型:", 
            btn_add_stop: "+ 增加停靠点", 
            btn_calc: "计算运费",
            btn_myloc: "我的位置", 
            search_loading: "⏳ 正在等待输入 (1s)...", 
            res_dist: "距离:", 
            res_go_price: "去程费用:",
            res_return_disc: "回程 (减 40%):", 
            res_deposit: "定金 (20%):", 
            modal_map_title: "在地图上选择位置",
            opt_4seat_disp: "4座车",
            opt_7seat_disp: "7座车",
            opt_1way_disp: "单程",
            opt_2way_disp: "往返 (-40%)",
            note_toll_fee_small: "* 不含过路费"
        }
    };
    let curLang = 'vi';

    /**
     * KHỞI TẠO ỨNG DỤNG KHI TẢI TRANG
     */
    window.onload = () => {
        // Khởi tạo bản đồ chính (Chỉ xem)
        map = L.map('main-map').setView([10.7769, 106.7009], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);
        
        // Khởi tạo bản đồ chọn điểm (Modal)
        pickerMap = L.map('picker-map').setView([10.7769, 106.7009], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(pickerMap);

        // Kích hoạt chức năng tìm kiếm cho 2 ô input chính
        setupAddr('pickup'); 
        setupAddr('dropoff');
        
        // Xử lý nút X cho ô điện thoại
        document.getElementById('phone').addEventListener('input', function() { toggleX(this); });
    };

    /**
     * =================================================================
     * LOGIC TÌM KIẾM ĐỊA CHỈ (CORE FEATURE)
     * Áp dụng Debounce 1s và Session Token
     * =================================================================
     */
    function setupAddr(id) {
        let el = document.getElementById(id);
        let box = el.parentElement.querySelector('.suggestions');
        let status = el.parentElement.querySelector('.search-status');
        
        el.addEventListener('input', function() {
            toggleX(this);
            
            // Xóa bộ đếm cũ nếu người dùng vẫn đang gõ
            clearTimeout(debounceTimer);
            
            if (this.value.length > 2) {
                // Hiện thông báo đang chờ
                if(status) status.style.display = 'block';
                box.style.display = 'none';

                // Thiết lập bộ đếm mới: CHỜ ĐÚNG 1000ms (1 GIÂY) MỚI GỌI API
                debounceTimer = setTimeout(() => {
                    fetchSuggestions(this);
                    if(status) status.style.display = 'none';
                }, 1000); 
            } else {
                box.style.display = 'none';
                if(status) status.style.display = 'none';
            }
            // Reset trạng thái nút tính tiền nếu sửa địa chỉ
            resetButtonsAndMap();
        });
    }

    // Gọi API Autocomplete của Goong
    function fetchSuggestions(inp) {
        let box = inp.parentElement.querySelector('.suggestions');
        // Gửi kèm session_token để tiết kiệm chi phí
        let url = `https://rsapi.goong.io/Place/AutoComplete?api_key=${GOONG_API_KEY}&input=${encodeURIComponent(inp.value)}&session_token=${sessionToken}`;
        
        fetch(url).then(r => r.json()).then(data => {
            box.innerHTML = '';
            if (!data.predictions || data.predictions.length === 0) return;
            
            data.predictions.forEach(item => {
                let div = document.createElement('div');
                div.className = 'sug-item';
                div.innerHTML = `<i class="fas fa-map-marker-alt"></i> <div><strong>${item.structured_formatting.main_text}</strong><br><small>${item.description}</small></div>`;
                
                // Sự kiện khi click chọn địa điểm
                div.onmousedown = (e) => {
                    e.preventDefault();
                    inp.value = item.description; // Điền text vào ô
                    getPlaceDetail(item.place_id, inp); // Lấy tọa độ
                    box.style.display = 'none';
                };
                box.appendChild(div);
            });
            box.style.display = 'block';
        }).catch(err => console.log("Lỗi API gợi ý:", err));
    }

    // Gọi API Detail để lấy tọa độ (Lat, Lng)
    function getPlaceDetail(placeId, inp) {
        let url = `https://rsapi.goong.io/Place/Detail?place_id=${placeId}&api_key=${GOONG_API_KEY}&session_token=${sessionToken}`;
        fetch(url).then(r => r.json()).then(data => {
            if(data.result && data.result.geometry) {
                inp.dataset.lat = data.result.geometry.location.lat;
                inp.dataset.lon = data.result.geometry.location.lng;
                
                // QUAN TRỌNG: Tạo Token mới ngay sau khi hoàn tất 1 phiên tìm kiếm
                sessionToken = generateUUID(); 
                console.log("Đã reset Session Token mới:", sessionToken);
                
                resetButtonsAndMap();
            }
        });
    }

    /**
     * =================================================================
     * LOGIC TÍNH TOÁN GIÁ TIỀN & HIỂN THỊ KẾT QUẢ
     * =================================================================
     */
    async function calculate() {
        let p = document.getElementById('pickup');
        let d = document.getElementById('dropoff');
        let stops = Array.from(document.querySelectorAll('.stop-inp')); // Các điểm dừng
        
        // Lọc ra các điểm có tọa độ hợp lệ
        let points = [p, ...stops, d].filter(x => x.dataset.lat && x.dataset.lon);

        if(points.length < 2) return alert(curLang === 'vi' ? "Vui lòng chọn địa điểm từ gợi ý!" : "Please select valid locations!");

        // Tạo chuỗi tọa độ cho OSRM
        let coords = points.map(x => `${x.dataset.lon},${x.dataset.lat}`).join(';');
        
        // Hiệu ứng loading nút bấm
        let btn = document.getElementById('btn-calc-main');
        let orgText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
        btn.disabled = true;

        try {
            // Gọi API OSRM (Miễn phí) để vẽ đường
            let res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`);
            let data = await res.json();
            
            if(!data.routes || data.routes.length === 0) throw new Error("Không tìm thấy đường");

            let r = data.routes[0];
            
            // Vẽ đường lên bản đồ
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(r.geometry, {style: {color: '#28a745', weight: 6, opacity: 0.8}}).addTo(map);
            
            document.getElementById('main-map').style.display = 'block';
            map.invalidateSize(); 
            map.fitBounds(routeLayer.getBounds(), {padding: [40,40]});

            // --- TÍNH TOÁN GIÁ CƯỚC ---
            let km = r.distance / 1000;
            let carTypeVal = document.getElementById('carType').value;
            let tripTypeVal = document.getElementById('tripType').value;
            
            // Đơn giá: 4 chỗ = 10k, 7 chỗ = 12k
            let unitPrice = carTypeVal == '4' ? 10000 : 12000;
            
            let goPrice = Math.round(km * unitPrice);
            let total = goPrice;

            // Hiển thị thông số cơ bản
            document.getElementById('res-km').innerText = km.toFixed(1) + ' km';
            document.getElementById('val-go').innerText = goPrice.toLocaleString() + ' đ';

            // Xử lý logic 2 chiều (Giảm 40% chiều về)
            if(tripTypeVal == '2') {
                let backPrice = Math.round(goPrice * 0.6); // Chỉ lấy 60% giá chiều đi
                total = goPrice + backPrice;
                
                let deposit = Math.round(total * 0.2); // Cọc 20% tổng

                document.getElementById('row-back').style.display = 'flex';
                document.getElementById('val-back').innerText = backPrice.toLocaleString() + ' đ';
                
                document.getElementById('row-deposit').style.display = 'flex';
                document.getElementById('val-deposit').innerText = deposit.toLocaleString() + ' đ';
            } else {
                document.getElementById('row-back').style.display = 'none';
                document.getElementById('row-deposit').style.display = 'none';
            }

            document.getElementById('res-total').innerText = total.toLocaleString() + ' đ';
            
            // Hiển thị kết quả, ẩn nút tính
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('btn-calc-main').style.display = 'none';
            document.getElementById('book-buttons-bar').style.display = 'flex';
            
            // Cuộn xuống kết quả
            document.getElementById('result-area').scrollIntoView({behavior: "smooth"});

        } catch (e) {
            alert("Lỗi tính đường: " + e.message);
        } finally {
            btn.innerHTML = orgText;
            btn.disabled = false;
        }
    }

    /**
     * =================================================================
     * CÁC HÀM TIỆN ÍCH KHÁC (ADD STOP, MAP PICKER, NGÔN NGỮ)
     * =================================================================
     */

    // Thêm điểm dừng
    function addStop() {
        let id = 'stop-' + Date.now();
        let div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label class="form-label">Điểm dừng:</label>
            <input type="text" id="${id}" class="stop-inp" placeholder="..." autocomplete="off">
            <div class="input-tools">
                <button class="tool-btn btn-x" onclick="clearInp('${id}')">✕</button>
                <button class="tool-btn btn-trash" onclick="removeStop(this)"><i class="fas fa-trash"></i></button>
            </div>
            <div class="search-status">${LANG[curLang].search_loading}</div>
            <div class="suggestions"></div>`;
        document.getElementById('stops-container').appendChild(div);
        setupAddr(id); // Kích hoạt tìm kiếm cho điểm dừng mới
    }

    function removeStop(btn) {
        btn.parentElement.parentElement.remove();
        resetButtonsAndMap();
    }

    // Đổi ngôn ngữ
    function changeLang(code) {
        curLang = code;
        // Cập nhật trạng thái nút
        document.querySelectorAll('.lang-btn').forEach(b => {
            b.classList.toggle('active', b.getAttribute('onclick').includes(code));
        });
        // Cập nhật nội dung text
        document.querySelectorAll('[data-i18n]').forEach(el => {
            let key = el.dataset.i18n;
            if(LANG[code][key]) el.innerText = LANG[code][key];
        });
        resetButtonsAndMap();
    }

    // Tiện ích Input
    function toggleX(el) { 
        let xBtn = el.parentElement.querySelector('.btn-x');
        if(xBtn) xBtn.style.display = el.value ? 'flex' : 'none'; 
    }

    function clearInp(id) { 
        let el = document.getElementById(id); 
        el.value = ''; 
        delete el.dataset.lat; 
        delete el.dataset.lon;
        toggleX(el); 
        resetButtonsAndMap(); 
    }

    function resetButtonsAndMap() { 
        document.getElementById('book-buttons-bar').style.display = 'none'; 
        document.getElementById('btn-calc-main').style.display = 'flex'; 
        document.getElementById('result-area').style.display = 'none'; 
    }

    // Modal Bản đồ
    function openMap(id) { 
        activeInp = document.getElementById(id); 
        document.getElementById('modal-map').style.display = 'flex'; 
        // Fix lỗi bản đồ không hiện full khi ẩn
        setTimeout(() => pickerMap.invalidateSize(), 200); 
    }

    function closeMap() { 
        document.getElementById('modal-map').style.display = 'none'; 
    }

    function confirmMap() {
        let c = pickerMap.getCenter();
        activeInp.dataset.lat = c.lat; 
        activeInp.dataset.lon = c.lng;
        activeInp.value = `Tọa độ ghim: ${c.lat.toFixed(5)}, ${c.lng.toFixed(5)}`;
        closeMap(); 
        resetButtonsAndMap();
    }

    // Lấy vị trí GPS trình duyệt
    function getMyLoc() {
        if (!navigator.geolocation) return alert("Trình duyệt không hỗ trợ GPS");
        
        navigator.geolocation.getCurrentPosition(p => {
            let el = document.getElementById('pickup');
            el.dataset.lat = p.coords.latitude; 
            el.dataset.lon = p.coords.longitude;
            el.value = "Vị trí hiện tại của tôi";
            toggleX(el);
            resetButtonsAndMap();
        }, () => alert("Không thể lấy vị trí. Hãy kiểm tra quyền truy cập!"));
    }

    // Chuyển hướng đặt xe
    function book(method) {
        // Logic mở Zalo hoặc Email ở đây
        if(method === 'zalo') window.open('https://zalo.me/0847526893');
        if(method === 'mail') window.location.href = 'mailto:truongandriving@gmail.com';
    }
</script>
</body>
</html>
