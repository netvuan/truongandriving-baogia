<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-i18n="appTitle">🚖 Dịch vụ Taxi Trường An Driving</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#28a745"> 
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--green:#28a745;--muted:#6c757d;--light-gray:#f4f6f8;}
    *{box-sizing:border-box}
    #main-content {
      background:var(--light-gray);
      padding: 0;
    }
    body{margin:0;font-family:Arial,Helvetica,sans-serif;color:#111}
    header{background:var(--green);color:#fff;padding:12px 10px;text-align:center;font-size:20px;font-weight:700;line-height:1.5}
    .phone-number{font-size:18px;font-weight:700;margin-top:4px}
    .container{padding:12px}
    .label-row{display:flex;align-items:center;gap:8px;margin-top:12px} /* Tăng khoảng cách trên */
    .label-row:first-of-type { margin-top: 6px; } /* Giữ khoảng cách trên cho SĐT */
    .label-row h3{margin:0;font-size:16px} 

    #location-status-wrapper {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: auto; /* Đẩy sang phải */
    }
    #reloadLocationBtn {
        cursor: pointer;
        font-style: normal;
        font-size: 20px;
        color: #007bff;
        transition: transform 0.2s;
    }
    #reloadLocationBtn:hover {
        transform: rotate(45deg);
    }
    
    .input-row{position:relative;margin-top:8px}
    /* SỬA LỖI GIAO DIỆN: Điều chỉnh vị trí nút xóa để không bị che bởi nút Bản đồ */
    /* Nút xóa sẽ nằm cách nút Bản đồ 8px */
    .input-row .clear-btn {
        position: absolute; 
        right: 80px; /* Cách nút Bản đồ (width 60px + padding + margin) */
        top: 1px; /* Căn chỉnh lại để khớp với padding của input */
        height: calc(100% - 2px); /* Chiều cao gần bằng input */
        background: #e9ecef; /* Màu nền nhẹ để nổi bật */
        color: #6c757d; 
        border: none; 
        padding: 0 8px; /* Giảm padding */
        border-radius: 0 8px 8px 0; /* Bo tròn chỉ bên phải */
        font-weight: 700; 
        cursor: pointer; 
        line-height: 1;
        font-size: 14px; 
        display: none; 
        z-index: 1000;
        transition: background 0.1s;
        display: flex; /* Dùng flex để căn giữa chữ X */
        align-items: center;
        justify-content: center;
    }
    /* Giữ nguyên logic hiển thị nút clear-btn khi focus */
    .input-row input:focus + .clear-btn, .input-row .clear-btn:hover { 
        display: flex; /* Đảm bảo nút được hiển thị */
    }
    .input-row .clear-btn:hover { background: #dee2e6; color: #495057; }
    /* Điều chỉnh input để chừa chỗ cho clear-btn và map-btn */
    input[type="text"]{
        padding-right: 140px; /* Chừa chỗ cho clear-btn (~60px) + map-btn (~70px) */
    }
    input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
      width:100%; padding:12px 14px; border-radius:8px; border:1px solid #ddd; font-size:16px; background:#fff;
    }
    /* SỬA LỖI GIAO DIỆN: Điều chỉnh vị trí và kích thước nút Bản đồ */
    .map-btn{
        position:absolute; 
        right:8px; 
        top:8px; 
        background:var(--green); 
        color:#fff; 
        border:0; 
        padding:6px 8px; 
        border-radius:6px; 
        font-weight:700; 
        cursor:pointer;
        line-height: 1.5; /* Căn chỉnh lại */
    }
    .add-stop{display:block;background:var(--green); color:#fff; border:none; padding:12px; border-radius:10px; font-size:16px; font-weight:700; margin-top:12px; cursor:pointer}
    .calc-btn{display:block;background:var(--green); color:#fff; border:none; padding:14px; border-radius:10px; font-size:18px; font-weight:700; margin-top:12px; cursor:pointer}
    #map{height:320px;margin-top:12px;border-radius:8px;overflow:hidden}
    /* SỬA LỖI GIAO DIỆN: Đảm bảo suggestions hiển thị trên mọi thứ */
    .suggestions{
        position:absolute; 
        left:0; 
        right:0; 
        top:100%; /* Đặt ngay dưới input */
        margin-top: 4px; /* Thêm khoảng cách */
        background:#fff;
        border:1px solid #ddd;
        border-radius:8px;
        max-height:220px;
        overflow:auto; 
        -webkit-overflow-scrolling:touch; 
        z-index:2000; /* Tăng z-index để không bị modal hoặc map che */
        box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }
    .suggestions div{padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer; display:flex; gap:8px; align-items: center}
    .suggestions div:last-child{border-bottom:0}
    .suggestions div:hover{background:#f8f9fa}
    .result-box{margin-top:12px;padding:12px;border-radius:8px;background:#fff3cd;border:1px solid #ffeeba}
    .result-row{display:flex;align-items:center;gap:8px}
    .distance-text{font-size:16px}
    .price-title{font-weight:700;margin-top:6px}
    .price-value{font-size:22px;color:red;font-weight:800}
    .price-break{margin-top:8px;font-size:15px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions a{flex:1;text-align:center;padding:12px;border-radius:8px;color:#fff;text-decoration:none;font-weight:700; border: none; cursor:pointer;}
    .zalo-btn {background:#0068ff;} 
    .mail{background:#dc3545}
    .note{margin-top:12px;font-size:13px;color:var(--muted);background:#fff;padding:10px;border-radius:8px}
    .way-wrapper{position:relative;margin-top:12px}
    /* Điều chỉnh input trong way-wrapper */
    .way-wrapper input[type="text"] {
        padding-right: 50px; /* Chừa chỗ cho nút xóa stop */
    }
    .way-remove{
        position:absolute;
        right:8px;
        top:8px;
        background:#ff6b6b;
        color:#fff;
        border:0;
        padding:6px 10px;
        border-radius:6px;
        cursor:pointer;
        font-weight: 700;
    } 
    /* Ẩn nút clear-btn cho Stop Input vì đã có way-remove */
    .way-wrapper .clear-btn { display: none !important; }


    /* KILL SWITCH STYLES */
    .disabled-form {
        pointer-events: none;
        opacity: 0.6; 
        transition: opacity 0.3s;
    }
    #serviceOffNotice {
      margin-top: 12px; 
      padding: 10px; 
      background: #dc3545; 
      color: white; 
      border-radius: 8px; 
      font-size: 15px; 
      font-weight: 600; 
      text-align: center;
    }


    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.7); z-index: 9999; display: none;
      justify-content: center; align-items: center; padding: 20px;
      animation: fadeIn 0.3s;
    }
    .modal-content {
      background: #fff; border-radius: 12px; padding: 20px;
      width: 100%; max-width: 450px; 
      max-height: 90vh; 
      overflow-y: auto; 
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    .modal-content h3 {
      margin-top: 0; color: var(--green); font-size: 20px; text-align: center;
    }
    #modal-text {
      white-space: pre-wrap; 
      font-family: monospace;
      font-size: 14px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
      overflow-x: auto; /* Thêm scroll ngang nếu nội dung quá dài */
    }
    .modal-actions {
      display: flex; gap: 10px;
    }
    .modal-actions button {
      flex: 1; padding: 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer;
    }
    #copyModalBtn { background: #ffc107; color: #333; } 
    #zaloModalBtn { background: #0068ff; color: #fff; }
    #closeModalBtn { background: #ccc; color: #333; }
    
    /* Phone Modal Styles */
    #phoneModal .modal-content { background: #f8d7da; border: 1px solid #f5c6cb; }
    #phoneModal h3 { color: #721c24; }
    #phoneModal #inputPhoneForBooking { margin-top: 15px; }
    #phoneModal #confirmPhoneBtn { background: #007bff; color: white; } 

    /* Deposit Modal Styles */
    #depositModal .modal-content { background: #d4edda; border: 1px solid #c3e6cb; }
    #depositModal h3 { color: #155724; }
    #depositModal p { margin-bottom: 15px; }
    #depositModal #depositAmount { 
        font-weight: 800; 
        font-size: 20px; 
        color: #007bff; 
        background: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        display: inline-block;
    }
    #depositModal #confirmDepositBtn { background: var(--green); color: white; }
    
    /* NEW: Driver Select Styling */
    #driverRequest {
        font-size: 18px; /* Tăng cỡ chữ */
        font-weight: 600;
        border: 2px solid var(--green); /* Viền nổi bật */
    }
    .driver-option-highlight {
        color: red; /* Màu đỏ nổi bật cho Trường An Driving */
        font-weight: 900 !important; /* Đảm bảo nổi bật */
        background-color: #f7f7f7;
    }
    .driver-option-avatar {
        margin-right: 5px; 
        font-size: 1.1em;
        vertical-align: middle;
    } 

    #language-switcher {
        margin-top: 8px;
        padding: 5px 8px;
        border-radius: 6px;
        border: 1px solid white;
        background: #34c759;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }
    
    /* Loading Overlay Style */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 10000; /* Cao nhất */
        display: flex;
        justify-content: center;
        align-items: center;
    }


    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } 

    @media(min-width:700px){.container{max-width:720px;margin:0 auto}}
  </style>
</head>
<body>
<div id="main-content">
  <header>
    <span data-i18n="headerService">🚖 Dịch Vụ Taxi</span><br>
    Trường An Driving<br>
    <a href="tel:0847526893" class="phone-number" style="color:white; text-decoration: none;">☎️ 0847526893</a>
    <select id="language-switcher">
        <option value="vi">🇻🇳 Tiếng Việt</option>
        <option value="en">🇬🇧 English</option>
        <option value="zh">🇨🇳 中文</option>
    </select>
  </header> 

  <div class="container">
    
    <div id="serviceOffNotice" style="display:none;">
      </div>
    
    <div id="instructionText" style="margin-top: 12px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 15px; font-weight: 600; text-align: center;" data-i18n="statusChecking">
      💰 Đang kiểm tra trạng thái dịch vụ...
    </div> 

    <div id="booking-form-wrapper"> 
      <div class="label-row" style="margin-top:6px"><h3 data-i18n="labelPhone">📞 Số điện thoại của bạn (Không bắt buộc để Tính giá)</h3></div>
      <input id="customerPhone" type="tel" data-i18n-placeholder="placeholderPhone" placeholder="Nhập SĐT (10 số, VD: 0987654321)" inputmode="tel"> 

      <div class="label-row">
        <h3 data-i18n="labelPickup">📍 Điểm đón</h3>
        <div id="location-status-wrapper">
          <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;" data-i18n="statusLocating">(Đang tìm vị trí...)</span>
          <i id="reloadLocationBtn" data-i18n-title="titleReloadLocation" title="Thử lấy lại vị trí">🔄</i>
        </div>
      </div>
      <div class="input-row">
        <input id="pickup" type="text" data-i18n-placeholder="placeholderPickup" placeholder="Nhập địa chỉ điểm đón (hoặc tự động lấy)">
        <button class="clear-btn" data-input-id="pickup">✖</button> 
        <button class="map-btn" id="pick-from-map" data-i18n="btnMap">Bản đồ</button>
        <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
      </div> 

      <div class="label-row"><h3 data-i18n="labelTime">🕒 Ngày & Giờ đón</h3></div>
      <input id="pickupDateTime" type="datetime-local"> 

      <div id="stops"></div>
      <button class="add-stop" id="add-stop-btn" data-i18n="btnAddStop">＋ Thêm điểm dừng</button> 

      <div class="label-row"><h3 data-i18n="labelDropoff">🏁 Điểm đến</h3></div>
      <div class="input-row">
        <input id="dropoff" type="text" data-i18n-placeholder="placeholderDropoff" placeholder="Nhập địa chỉ điểm đến cuối">
        <button class="clear-btn" data-input-id="dropoff">✖</button> 
        <button class="map-btn" id="pick-to-map" data-i18n="btnMap">Bản đồ</button>
        <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
      </div>
      
      <div class="label-row"><h3 data-i18n="labelCarType">🚘 Loại xe</h3></div>
      <select id="carType">
        <option value="4 chỗ (10.000đ/km)" data-i18n="car4seater">Xe 4 chỗ (10.000đ/km)</option> 
        <option value="7 chỗ (12.000đ/km)" data-i18n="car7seater">Xe 7 chỗ (12.000đ/km)</option> 
      </select>
      
      <div class="label-row">
        <h3 data-i18n="labelDriverRequest">
            🧑‍✈️ Yêu cầu Tài xế 
            <span class="driver-option-avatar" data-i18n-title="titleDriverIcon" title="Icon này có thể thay bằng Avatar">👤</span>
        </h3>
      </div>
      <select id="driverRequest">
        <option value="Trường An Driving" class="driver-option-highlight" data-i18n="driverDefault">
            ⭐ Trường An Driving (Mặc định)
        </option>
        <option value="Thanh Loan">👸 Thanh Loan</option>
        <option value="Đình Tâm">🧑‍✈️ Đình Tâm</option>
        <option value="Hải Đăng">🧑‍✈️ Hải Đăng</option>
        <option value="Lê Tâm">🧑‍✈️ Lê Tâm</option>
        <option value="Nguyễn Thảo">👸 Nguyễn Thảo</option>
        <option value="Quốc Dũng">🧑‍✈️ Quốc Dũng</option>
        <option value="Tân Hồ">🧑‍✈️ Tân Hồ</option>
        <option value="Trần Vinh">🧑‍✈️ Trần Vinh</option>
        <option value="Xuân Phong">🧑‍✈️ Xuân Phong</option>
      </select>
      <div class="label-row"><h3 data-i18n="labelTripType">🚗 Loại chuyến đi</h3></div>
      <select id="tripType">
        <option value="1" data-i18n="tripOneWay">1 chiều</option>
        <option value="2" data-i18n="tripTwoWay">2 chiều (giảm 40% chiều về)</option>
      </select> 

      <div id="waitingWrapper"> 
        <div class="label-row"><h3 data-i18n="labelWaiting">⏳ Thời gian chờ (giờ)</h3></div>
        <input id="waiting" type="number" min="0" value="0" data-i18n-placeholder="placeholderWaiting" placeholder="Nhập số giờ chờ">
      </div> 

      <button class="calc-btn" id="calc-btn" data-i18n="btnCalculate">💰 Tính giá</button>
    </div> 
    
    <div id="map"></div> 

    <div id="result" class="result-box" style="display:none">
      <div class="result-row">
        <div class="distance-text" id="distanceText"></div>
      </div> 

      <div class="price-title" data-i18n="resultPriceTitle">💵 Giá dự kiến</div>
      <div class="price-value" id="priceValue">— đ</div> 

      <div class="price-break" id="priceBreak"></div> 

      <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst"></div>
      <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo"></div>
    </div> 

    <div class="actions">
      <a id="zaloBtn" class="zalo-btn" href="javascript:void(0);" style="display:none;" data-i18n="btnBookZalo">📱 Đặt qua Zalo</a>
      <a id="mailBtn" class="mail" href="javascript:void(0);" style="display:none;" data-i18n="btnBookMail">📧 Đặt qua Mail</a>
    </div> 

    <div class="note" data-i18n="noteMain">
      📌 Ghi chú: Giá 4 chỗ/7 chỗ: **10.000đ/km** / **12.000đ/km**. 2 chiều: chiều về giảm 40% (áp dụng cho chuyến 1 chiều **≥ 45km**).
      <br>
      **Thời gian chờ:**
      <ul>
        <li>Chờ 0–3 giờ: **Miễn phí**.</li>
        <li>Kể từ giờ thứ 4, mỗi giờ tiếp theo phát sinh phụ phí **50.000 VNĐ/giờ**.</li>
        <li>Thời gian chờ được tính từ khi hành khách **hoàn tất việc xuống xe tại điểm đến** cho đến khi xe quay trở lại đón để về điểm xuất phát ban đầu.</li>
      </ul>
      Giá đã bao gồm phí cầu đường.
    </div>
  </div>
</div> 

<div id="depositModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalDepositTitle">📝 Yêu cầu Đặt cọc cho Chuyến 2 Chiều</h3>
        <p data-i18n="modalDepositNotice1">
            **Quý khách vui lòng lưu ý:**<br>
            Để xác nhận và đảm bảo chất lượng phục vụ cho chuyến đi **Hai chiều** của Quý khách, chúng tôi kính mong Quý khách **đặt cọc trước 20%** trên tổng giá cước dự kiến.
        </p>
        <p style="text-align:center; font-size:18px;">
            <span data-i18n="modalDepositAmountText">Số tiền đặt cọc dự kiến:</span> <span id="depositAmount">0 đ</span>
        </p>
        <p data-i18n="modalDepositNotice2">
            Khi nhân viên **Trường An Driving** phản hồi qua Zalo, chúng tôi sẽ gửi **hướng dẫn thanh toán cụ thể** (chuyển khoản) để hoàn tất thủ tục đặt cọc.
        </p>
        <p style="font-size:14px; color:#555;" data-i18n="modalDepositNote">
            **Lưu ý:** Phần còn lại của cước phí sẽ được thanh toán trực tiếp cho tài xế sau khi kết thúc chuyến đi.
            Xin chân thành cảm ơn Quý khách đã tin tưởng dịch vụ.
        </p>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmDepositBtn" style="width:100%;" data-i18n="modalDepositConfirm">Đã hiểu và Tiếp tục</button>
        </div>
    </div>
</div> 

<div id="phoneModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalPhoneTitle">📞 Vui lòng nhập Số điện thoại</h3>
        <p style="text-align:center;" data-i18n="modalPhoneNotice">Quý khách vui lòng nhập SĐT để chúng tôi tiện liên hệ xác nhận đơn hàng.</p>
        <input id="inputPhoneForBooking" type="tel" data-i18n-placeholder="placeholderPhone" placeholder="Nhập SĐT (10 số, VD: 0987654321)" inputmode="tel" required>
        <div class="modal-actions" style="margin-top:15px;">
            <button id="confirmPhoneBtn" data-i18n="modalPhoneConfirm">Xác nhận</button> 
        </div>
        <button id="closePhoneModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; background:#ccc; color:#333;" data-i18n="modalClose">Đóng</button>
    </div>
</div> 

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalBookingTitle">✅ THÔNG TIN ĐẶT XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;" data-i18n="modalBookingNotice">Sao chép thông tin và gửi qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn" data-i18n="modalBtnCopy">📋 Sao Chép Thông Tin</button> 
            <button id="zaloModalBtn" data-i18n="modalBtnZalo">📱 Mở Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:8px; border-radius:8px;" data-i18n="modalClose">Đóng</button>
    </div>
</div> 

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div> 

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- I18N CONFIGURATION START ---------- */
const i18n = {
    vi: {
        appTitle: "🚖 Dịch vụ Taxi Trường An Driving",
        headerService: "🚖 Dịch Vụ Taxi",
        statusChecking: "💰 Đang kiểm tra trạng thái dịch vụ...",
        statusActive: '💰 Bấm "Tính giá" để xem chi tiết đặt xe.',
        statusLocating: "(Đang tìm vị trí...)",
        titleReloadLocation: "Thử lấy lại vị trí",
        
        // Form Labels & Placeholders
        labelPhone: "📞 Số điện thoại của bạn (Không bắt buộc để Tính giá)",
        placeholderPhone: "Nhập SĐT (10 số, VD: 0987654321)",
        labelPickup: "📍 Điểm đón",
        placeholderPickup: "Nhập địa chỉ điểm đón (hoặc tự động lấy)",
        labelTime: "🕒 Ngày & Giờ đón",
        btnAddStop: "＋ Thêm điểm dừng",
        labelDropoff: "🏁 Điểm đến",
        placeholderDropoff: "Nhập địa chỉ điểm đến cuối",
        labelCarType: "🚘 Loại xe",
        car4seater: "Xe 4 chỗ (10.000đ/km)",
        car7seater: "Xe 7 chỗ (12.000đ/km)",
        labelDriverRequest: "🧑‍✈️ Yêu cầu Tài xế",
        titleDriverIcon: "Icon này có thể thay bằng Avatar",
        driverDefault: "⭐ Trường An Driving (Mặc định)",
        labelTripType: "🚗 Loại chuyến đi",
        tripOneWay: "1 chiều",
        tripTwoWay: "2 chiều (giảm 40% chiều về)",
        labelWaiting: "⏳ Thời gian chờ (giờ)",
        placeholderWaiting: "Nhập số giờ chờ",
        btnCalculate: "💰 Tính giá",
        btnMap: "Bản đồ",
        
        // Calculation Status & Results
        statusCalculating: "Đang tính toán...",
        statusCalculatingRoute: "Đang tính lộ trình...",
        statusNoRoute: "Không tính được lộ trình",
        statusNoCoord: "Không tìm thấy tọa độ Điểm ", // + 'đón'/'đến'
        resultPriceTitle: "💵 Giá dự kiến",
        resultDistance: "✏️ Quãng đường:",
        resultTimeEst: "⏱ Thời gian dự kiến:",
        resultPickupTime: "🕒 Ngày giờ đón:",
        
        // Notes
        noteMain: `📌 Ghi chú: Giá 4 chỗ/7 chỗ: **10.000đ/km** / **12.000đ/km**. 2 chiều: chiều về giảm 40% (áp dụng cho chuyến 1 chiều **≥ 45km**).
      <br>
      **Thời gian chờ:**
      <ul>
        <li>Chờ 0–3 giờ: **Miễn phí**.</li>
        <li>Kể từ giờ thứ 4, mỗi giờ tiếp theo phát sinh phụ phí **50.000 VNĐ/giờ**.</li>
        <li>Thời gian chờ được tính từ khi hành khách **hoàn tất việc xuống xe tại điểm đến** cho đến khi xe quay trở lại đón để về điểm xuất phát ban đầu.</li>
      </ul>
      Giá đã bao gồm phí cầu đường.`,

        // Booking Buttons
        btnBookZalo: "📱 Đặt qua Zalo",
        btnBookMail: "📧 Đặt qua Mail",

        // Modals
        modalClose: "Đóng",
        modalBookingTitle: "✅ THÔNG TIN ĐẶT XE",
        modalBookingNotice: "Sao chép thông tin và gửi qua Zalo:",
        modalBtnCopy: "📋 Sao Chép Thông Tin",
        modalBtnZalo: "📱 Mở Zalo Chat",

        // Phone Modal
        modalPhoneTitle: "📞 Vui lòng nhập Số điện thoại",
        modalPhoneNotice: "Quý khách vui lòng nhập SĐT để chúng tôi tiện liên hệ xác nhận đơn hàng.",
        modalPhoneConfirm: "Xác nhận",

        // Deposit Modal
        modalDepositTitle: "📝 Yêu cầu Đặt cọc cho Chuyến 2 Chiều",
        modalDepositNotice1: "**Quý khách vui lòng lưu ý:**<br>Để xác nhận và đảm bảo chất lượng phục vụ cho chuyến đi **Hai chiều** của Quý khách, chúng tôi kính mong Quý khách **đặt cọc trước 20%** trên tổng giá cước dự kiến.",
        modalDepositAmountText: "Số tiền đặt cọc dự kiến:",
        modalDepositNotice2: "Khi nhân viên **Trường An Driving** phản hồi qua Zalo, chúng tôi sẽ gửi **hướng dẫn thanh toán cụ thể** (chuyển khoản) để hoàn tất thủ tục đặt cọc.",
        modalDepositNote: "**Lưu ý:** Phần còn lại của cước phí sẽ được thanh toán trực tiếp cho tài xế sau khi kết thúc chuyến đi. Xin chân thành cảm ơn Quý khách đã tin tưởng dịch vụ.",
        modalDepositConfirm: "Đã hiểu và Tiếp tục",

        // Geolocation Errors
        errorNetwork: "⚠️ Thiết bị đang OFFLINE hoặc LỖI KẾT NỐI. Không thể xác nhận đơn hàng.",
        errorTimeout: "⚠️ Kiểm tra trạng thái dịch vụ quá lâu. Việc đặt xe bị tạm ngưng.",
        errorServiceFetch: "⚠️ CẢNH BÁO MẠNG: Không tìm thấy file trạng thái dịch vụ (404/Server Error). Chức năng đặt xe bị tạm ngưng.",
        errorLocating: "⚠️ Lỗi tìm vị trí. Nhập thủ công.",
        errorDenied: "❌ Bị từ chối quyền truy cập vị trí.",
        errorUnavailable: "❌ Vị trí không khả dụng (Bật GPS).",
        errorTimeoutLoc: "⚠️ Hết thời gian tìm vị trí.",
        errorNotSupported: "❌ Trình duyệt không hỗ trợ Geolocation.",
        statusLocated: "✅ Đã tìm thấy vị trí",
        statusPopup: "📍 Vị trí hiện tại",
        mapPopupPickup: "📍 Điểm đón",
        mapPopupDropoff: "🏁 Điểm đến",
        mapPopupStop: "📍 Điểm dừng",
        alertPickup: '❌ Vui lòng nhập Địa chỉ Điểm đón.',
        alertDropoff: '❌ Vui lòng nhập Địa chỉ Điểm đến.',
        alertWaiting: '❌ Vì bạn chọn chuyến 2 chiều, vui lòng nhập Thời gian chờ (số giờ) để chúng tôi sắp xếp xe. Giá trị phải ≥ 0.',
        alertNoCoord: 'Không tìm thấy tọa độ. Hãy chọn gợi ý hoặc đặt trên bản đồ.',
        alertNoStopCoord: 'Không tìm thấy tọa độ cho một Điểm dừng.',
        alertNoSuggestions: 'Không tìm thấy địa điểm',
        alertSearching: 'Đang tìm kiếm...',
        alertMapPickPickup: 'Bấm vào bản đồ để chọn điểm đón',
        alertMapPickDropoff: 'Bấm vào bản đồ để chọn điểm đến',
        
    },
    en: {
        appTitle: "🚖 Truong An Driving Taxi Service",
        headerService: "🚖 Taxi Service",
        statusChecking: "💰 Checking service status...",
        statusActive: '💰 Click "Calculate Price" for booking details.',
        statusLocating: "(Locating...)",
        titleReloadLocation: "Try to get location again",

        // Form Labels & Placeholders
        labelPhone: "📞 Your Phone Number (Optional for Price Calculation)",
        placeholderPhone: "Enter Phone No. (10 digits, e.g.: 0987654321)",
        labelPickup: "📍 Pickup Location",
        placeholderPickup: "Enter pickup address (or auto-locate)",
        labelTime: "🕒 Pickup Date & Time",
        btnAddStop: "＋ Add Stopover",
        labelDropoff: "🏁 Drop-off Location",
        placeholderDropoff: "Enter final drop-off address",
        labelCarType: "🚘 Car Type",
        car4seater: "4 Seater (10,000đ/km)",
        car7seater: "7 Seater (12,000đ/km)",
        labelDriverRequest: "🧑‍✈️ Driver Request",
        titleDriverIcon: "This icon can be replaced by an Avatar",
        driverDefault: "⭐ Truong An Driving (Default)",
        labelTripType: "🚗 Trip Type",
        tripOneWay: "One-Way",
        tripTwoWay: "Two-Way (40% off return trip)",
        labelWaiting: "⏳ Waiting Time (hours)",
        placeholderWaiting: "Enter waiting time in hours",
        btnCalculate: "💰 Calculate Price",
        btnMap: "Map",
        
        // Calculation Status & Results
        statusCalculating: "Calculating...",
        statusCalculatingRoute: "Calculating route...",
        statusNoRoute: "Could not calculate route",
        statusNoCoord: "Could not find coordinates for ", // + 'Pickup'/'Drop-off'
        resultPriceTitle: "💵 Estimated Price",
        resultDistance: "✏️ Distance:",
        resultTimeEst: "⏱ Estimated Time:",
        resultPickupTime: "🕒 Pickup Date & Time:",

        // Notes
        noteMain: `📌 Note: Price 4-seater/7-seater: **10,000 VND/km** / **12,000 VND/km**. Two-way trip: 40% off return leg (applies to one-way trips **≥ 45km**).
      <br>
      **Waiting Time:**
      <ul>
        <li>0–3 hours waiting: **Free**.</li>
        <li>From the 4th hour onwards, a surcharge of **50,000 VND/hour** applies.</li>
        <li>Waiting time is calculated from when the passenger **completes drop-off at the destination** until the car returns to pick up for the original starting point.</li>
      </ul>
      Price includes all road/toll fees.`,

        // Booking Buttons
        btnBookZalo: "📱 Book via Zalo",
        btnBookMail: "📧 Book via Mail",

        // Modals
        modalClose: "Close",
        modalBookingTitle: "✅ BOOKING INFORMATION",
        modalBookingNotice: "Copy the information and send via Zalo:",
        modalBtnCopy: "📋 Copy Information",
        modalBtnZalo: "📱 Open Zalo Chat",

        // Phone Modal
        modalPhoneTitle: "📞 Please Enter Your Phone Number",
        modalPhoneNotice: "Please enter your phone number so we can contact you to confirm the order.",
        modalPhoneConfirm: "Confirm",

        // Deposit Modal
        modalDepositTitle: "📝 Deposit Required for Two-Way Trip",
        modalDepositNotice1: "**Dear customer, please note:**<br>To confirm and ensure service quality for your **Two-way** trip, we kindly request a **20% deposit** on the estimated total fare.",
        modalDepositAmountText: "Estimated deposit amount:",
        modalDepositNotice2: "When a **Truong An Driving** staff member responds via Zalo, we will send **specific payment instructions** (bank transfer) to finalize the deposit.",
        modalDepositNote: "**Note:** The remaining fare will be paid directly to the driver after the trip is completed. Thank you for trusting our service.",
        modalDepositConfirm: "I Understand and Continue",

        // Geolocation Errors
        errorNetwork: "⚠️ Device is OFFLINE or CONNECTION ERROR. Order confirmation is not possible.",
        errorTimeout: "⚠️ Service status check took too long. Booking is temporarily suspended.",
        errorServiceFetch: "⚠️ NETWORK WARNING: Service status file not found (404/Server Error). Booking functionality is suspended.",
        errorLocating: "⚠️ Location search error. Please enter manually.",
        errorDenied: "❌ Location access permission denied.",
        errorUnavailable: "❌ Location unavailable (Turn on GPS).",
        errorTimeoutLoc: "⚠️ Location search timed out.",
        errorNotSupported: "❌ Browser does not support Geolocation.",
        statusLocated: "✅ Location found",
        statusPopup: "📍 Current Location",
        mapPopupPickup: "📍 Pickup Point",
        mapPopupDropoff: "🏁 Drop-off Point",
        mapPopupStop: "📍 Stopover Point",
        alertPickup: '❌ Please enter the Pickup address.',
        alertDropoff: '❌ Please enter the Drop-off address.',
        alertWaiting: '❌ Since you chose a two-way trip, please enter the Waiting Time (hours) for us to arrange the car. Value must be ≥ 0.',
        alertNoCoord: 'Coordinates not found. Please choose a suggestion or set on the map.',
        alertNoStopCoord: 'Coordinates not found for a Stopover.',
        alertNoSuggestions: 'No locations found',
        alertSearching: 'Searching...',
        alertMapPickPickup: 'Click on the map to select the pickup point',
        alertMapPickDropoff: 'Click on the map to select the drop-off point',
    },
    zh: {
        appTitle: "🚖 长安驾驶出租车服务",
        headerService: "🚖 出租车服务",
        statusChecking: "💰 正在检查服务状态...",
        statusActive: '💰 点击“计算价格”查看预订详情。',
        statusLocating: "(正在定位...)",
        titleReloadLocation: "尝试重新获取位置",

        // Form Labels & Placeholders
        labelPhone: "📞 您的电话号码 (计算价格可选)",
        placeholderPhone: "输入电话号码 (10位，例如：0987654321)",
        labelPickup: "📍 上车地点",
        placeholderPickup: "输入上车地址 (或自动定位)",
        labelTime: "🕒 上车日期和时间",
        btnAddStop: "＋ 添加经停点",
        labelDropoff: "🏁 目的地",
        placeholderDropoff: "输入最终目的地地址",
        labelCarType: "🚘 车型",
        car4seater: "4座车 (10,000đ/公里)",
        car7seater: "7座车 (12,000đ/公里)",
        labelDriverRequest: "🧑‍✈️ 司机要求",
        titleDriverIcon: "此图标可替换为头像",
        driverDefault: "⭐ 长安驾驶 (默认)",
        labelTripType: "🚗 行程类型",
        tripOneWay: "单程",
        tripTwoWay: "双程 (返程减40%)",
        labelWaiting: "⏳ 等待时间 (小时)",
        placeholderWaiting: "输入等待时间(小时)",
        btnCalculate: "💰 计算价格",
        btnMap: "地图",
        
        // Calculation Status & Results
        statusCalculating: "正在计算...",
        statusCalculatingRoute: "正在计算路线...",
        statusNoRoute: "无法计算路线",
        statusNoCoord: "找不到坐标：", // + '上车'/'目的地'
        resultPriceTitle: "💵 预计价格",
        resultDistance: "✏️ 距离:",
        resultTimeEst: "⏱ 预计时间:",
        resultPickupTime: "🕒 上车日期和时间:",

        // Notes
        noteMain: `📌 注意：4座/7座车价格: **10,000 越南盾/公里** / **12,000 越南盾/公里**。双程: 返程减40% (适用于单程 **≥ 45公里**)。
      <br>
      **等待时间:**
      <ul>
        <li>等待 0–3 小时: **免费**。</li>
        <li>从第4小时起，每小时加收 **50,000 越南盾/小时**。</li>
        <li>等待时间从乘客在**目的地完成下车**开始计算，直到车辆返回接乘客回到最初的起点。</li>
      </ul>
      价格已包含所有过路/过桥费。`,

        // Booking Buttons
        btnBookZalo: "📱 通过 Zalo 预订",
        btnBookMail: "📧 通过邮件预订",

        // Modals
        modalClose: "关闭",
        modalBookingTitle: "✅ 预订信息",
        modalBookingNotice: "复制信息并通过 Zalo 发送:",
        modalBtnCopy: "📋 复制信息",
        modalBtnZalo: "📱 打开 Zalo 聊天",

        // Phone Modal
        modalPhoneTitle: "📞 请输入电话号码",
        modalPhoneNotice: "请输入您的电话号码，以便我们联系您确认订单。",
        modalPhoneConfirm: "确认",

        // Deposit Modal
        modalDepositTitle: "📝 双程旅行需支付押金",
        modalDepositNotice1: "**尊敬的客户，请注意:**<br>为确认并确保您**双程**旅行的服务质量，我们恳请您预先支付预估总费用的 **20% 押金**。",
        modalDepositAmountText: "预计押金金额:",
        modalDepositNotice2: "当 **长安驾驶** 员工通过 Zalo 回复您时，我们将发送**具体的付款指示** (银行转账) 以完成押金手续。",
        modalDepositNote: "**注意:** 剩余车费将在行程结束后直接支付给司机。衷心感谢您对我们服务的信任。",
        modalDepositConfirm: "我已了解并继续",

        // Geolocation Errors
        errorNetwork: "⚠️ 设备处于离线状态或连接错误。无法确认订单。",
        errorTimeout: "⚠️ 服务状态检查超时。预订暂时停止。",
        errorServiceFetch: "⚠️ 网络警告：找不到服务状态文件 (404/服务器错误)。预订功能已暂停。",
        errorLocating: "⚠️ 定位错误。请手动输入。",
        errorDenied: "❌ 位置访问权限被拒绝。",
        errorUnavailable: "❌ 位置不可用 (请打开GPS)。",
        errorTimeoutLoc: "⚠️ 位置搜索超时。",
        errorNotSupported: "❌ 浏览器不支持地理定位。",
        statusLocated: "✅ 已找到位置",
        statusPopup: "📍 当前位置",
        mapPopupPickup: "📍 上车点",
        mapPopupDropoff: "🏁 下车点",
        mapPopupStop: "📍 经停点",
        alertPickup: '❌ 请输入上车地址。',
        alertDropoff: '❌ 请输入目的地地址。',
        alertWaiting: '❌ 您选择了双程旅行，请输入等待时间 (小时) 以便我们安排车辆。该值必须 ≥ 0。',
        alertNoCoord: '找不到坐标。请选择建议或在地图上设置。',
        alertNoStopCoord: '找不到某个经停点的坐标。',
        alertNoSuggestions: '未找到地点',
        alertSearching: '正在搜索...',
        alertMapPickPickup: '点击地图选择上车点',
        alertMapPickDropoff: '点击地图选择下车点',
    }
};

let currentLang = localStorage.getItem('lang') || 'vi';

function updateContent() {
    const translations = i18n[currentLang];
    
    // 1. Update text content
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[key]) {
            element.textContent = translations[key];
        }
    });

    // 2. Update attributes (placeholder, title)
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[key]) {
            element.setAttribute('placeholder', translations[key]);
        }
    });
    
    document.querySelectorAll('[data-i18n-title]').forEach(element => {
        const key = element.getAttribute('data-i18n-title');
        if (translations[key]) {
            element.setAttribute('title', translations[key]);
        }
    });
    
    // 3. Update <title> separately
    const titleEl = document.querySelector('title');
    if (titleEl) {
        const key = titleEl.getAttribute('data-i18n');
        if (translations[key]) {
            titleEl.textContent = translations[key];
        }
    }

    // 4. Update the select options for car type
    document.getElementById('carType').querySelector('option[data-i18n="car4seater"]').textContent = translations.car4seater;
    document.getElementById('carType').querySelector('option[data-i18n="car7seater"]').textContent = translations.car7seater;

    // 5. Update the select options for trip type
    document.getElementById('tripType').querySelector('option[data-i18n="tripOneWay"]').textContent = translations.tripOneWay;
    document.getElementById('tripType').querySelector('option[data-i18n="tripTwoWay"]').textContent = translations.tripTwoWay;

    // 6. Update HTML lang attribute
    document.documentElement.setAttribute('lang', currentLang);

    // 7. Update status/popup texts that are dynamically set elsewhere
    // This is handled in the relevant functions (e.g., getGeolocation, calculateAndGenerateMessage)
    // but we can set the initial state here too.
    document.getElementById('location-status').textContent = translations.statusLocating;
    document.getElementById('instructionText').innerHTML = translations.statusChecking;
    
    // Update placeholder for stop inputs (since they are created dynamically)
    document.querySelectorAll('input[id^="stop-"]').forEach((input, index) => {
        input.setAttribute('placeholder', translations.placeholderPickup.replace('điểm đón', 'điểm dừng ' + (index + 1)).replace('pickup address', 'stopover ' + (index + 1)).replace('上车地址', '经停点 ' + (index + 1)));
    });
    
}

document.getElementById('language-switcher').addEventListener('change', (e) => {
    currentLang = e.target.value;
    localStorage.setItem('lang', currentLang);
    updateContent();
    // Re-check service status to update instruction text with new language
    checkServiceStatus().then(updateUIBasedOnStatus);
    // Re-validate to update alert messages if a trip is calculated (optional but good practice)
    // calculateAndGenerateMessage(); 
});

// Set initial language in the switcher and update content
document.getElementById('language-switcher').value = currentLang;
updateContent();
/* ---------- I18N CONFIGURATION END ---------- */


/* ---------- Cấu hình Tối Ưu Hóa ---------- */
const REMOTE_STATUS_URL = "/status-local.json"; 
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse"; 
const OSRM = "https://router.project-osrm.org/route/v1/driving"; 

const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/"; 
const GOOGLE_MAPS_DIR_URL = "https://www.google.com/maps/dir/"; 

const TAXI_PHONE = "0847526893"; 
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`; 
const DEBOUNCE_TIME = 300; 
const DEFAULT_CENTER = [10.77653, 106.70098]; 
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0'; 
let userLocation = null; 
let isServiceActive = false; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone'); 
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType'); 
const driverRequestEl = document.getElementById('driverRequest'); // New Driver Select
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper'); 
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn'); 
const mailBtn = document.getElementById('mailBtn'); 

// Kill Switch DOM
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice'); 
const bookingFormWrapper = document.getElementById('booking-form-wrapper'); 

const locationStatusEl = document.getElementById('location-status'); 
const reloadLocationBtn = document.getElementById('reloadLocationBtn'); 

// Modal DOM
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn'); 
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn'); 

// New Modal DOM
const phoneModal = document.getElementById('phoneModal');
const inputPhoneForBooking = document.getElementById('inputPhoneForBooking');
const confirmPhoneBtn = document.getElementById('confirmPhoneBtn');
const closePhoneModalBtn = document.getElementById('closePhoneModalBtn');
const depositModal = document.getElementById('depositModal');
const depositAmount = document.getElementById('depositAmount');
const confirmDepositBtn = document.getElementById('confirmDepositBtn'); 

let finalZaloMessage = ''; 
let finalTotalFee = 0; 
let map; 
let pickupMarker = null, dropoffMarker = null, routeLayer = null;
let selecting = null; 
let stopCount = 0;
let lastFocusedStopId = null;
let bookingAction = null; // 'zalo' or 'mail' 

/* ---------- TÍN HIỆU KILL SWITCH (Polling) ---------- */ 

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`; 
    const finalUrl = REMOTE_STATUS_URL + cacheBuster; 

    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) }); 
        
        if (!response.ok) {
            return { 
                active: false, 
                message_vn: i18n[currentLang].errorServiceFetch
            };
        }
        
        const data = await response.json();
        // Use the current language version of the message
        let statusMessage = data[`message_${currentLang}`] || data.message_vn;
        return { active: data.active, message_vn: statusMessage };
    } catch (error) {
        let msg = i18n[currentLang].errorNetwork;
        if (error.name === 'TimeoutError') {
             msg = i18n[currentLang].errorTimeout;
        }
        console.error("Lỗi khi fetch trạng thái dịch vụ:", error);
        return { 
            active: false, 
            message_vn: msg
        };
    }
}


async function updateUIBasedOnStatus(status) {
    if (status.active !== isServiceActive) {
        isServiceActive = status.active;
    }
    
    instructionText.style.display = 'block'; // Hiển thị mặc định 

    if (!isServiceActive) {
        // TẮT DỊCH VỤ
        calcBtn.style.background = '#ccc';
        calcBtn.style.cursor = 'not-allowed';
        calcBtn.disabled = true;
        
        serviceOffNotice.style.display = 'block';
        serviceOffNotice.innerHTML = status.message_vn;
        
        // Vô hiệu hóa form
        bookingFormWrapper.classList.add('disabled-form');
        
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';
        
    } else {
        // MỞ DỊCH VỤ
        calcBtn.style.background = 'var(--green)';
        calcBtn.style.cursor = 'pointer';
        calcBtn.disabled = false;
        
        serviceOffNotice.style.display = 'none';
        
        // Kích hoạt form
        bookingFormWrapper.classList.remove('disabled-form');
        
        instructionText.innerHTML = status.message_vn || i18n[currentLang].statusActive;
    }
} 

/* ---------- Các hàm JS khác (InitMap, Geolocation, Autocomplete, Calculate...) Đã cập nhật I18N ---------- */
function initMap(center) {
    if (!map) {
        map = L.map('map').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 

        map.on('click', handleMapClick);
        map.on('dblclick', handleMapDblClick);
    } else {
        map.setView(center, 11);
    }
} 

async function reverseGeocode(lat, lon) {
    try {
        // Use the current language in the Nominatim request
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=${currentLang},en`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        console.warn('Reverse Geocoding Error', e);
        return `${lat.toFixed(6)}, ${lon.toFixed(6)} (${i18n[currentLang].statusNoCoord + i18n[currentLang].labelPickup})`;
    }
} 

function getGeolocation() {
    const translations = i18n[currentLang];
    locationStatusEl.textContent = translations.statusLocating;
    locationStatusEl.style.color = 'var(--muted)';
    reloadLocationBtn.style.color = '#ccc'; 
    reloadLocationBtn.style.pointerEvents = 'none'; 

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            userLocation = [pos.coords.latitude, pos.coords.longitude]; 
            initMap(userLocation); 
            
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            pickupEl.parentNode.querySelector('.clear-btn').style.display = 'flex'; 

            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup(translations.statusPopup).openPopup(); 

            locationStatusEl.textContent = translations.statusLocated;
            locationStatusEl.style.color = 'var(--green)';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, (err)=>{
            console.warn('Geolocation Error:', err.message);
            initMap(DEFAULT_CENTER); 
            
            let statusText = translations.errorLocating;
            if (err.code === err.PERMISSION_DENIED) {
                 statusText = translations.errorDenied;
            } else if (err.code === err.POSITION_UNAVAILABLE) {
                 statusText = translations.errorUnavailable;
            } else if (err.code === err.TIMEOUT) {
                 statusText = translations.errorTimeoutLoc;
            }
            
            locationStatusEl.textContent = statusText;
            locationStatusEl.style.color = '#dc3545';
            reloadLocationBtn.style.color = '#007bff';
            reloadLocationBtn.style.pointerEvents = 'auto';


        }, { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }); 
    } else {
        initMap(DEFAULT_CENTER); 
        locationStatusEl.textContent = translations.errorNotSupported;
        locationStatusEl.style.color = '#dc3545';
        reloadLocationBtn.style.color = '#ccc';
        reloadLocationBtn.style.pointerEvents = 'none';
    }
} 

function debounce(func, timeout = DEBOUNCE_TIME) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
} 

function toggleWaitingInput(){
    if(tripTypeEl.value === '1'){
        waitingWrapper.style.display = 'none';
    } else {
        waitingWrapper.style.display = 'block';
    }
} 

tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput(); 

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const inputId = e.target.dataset.inputId;
        const inputEl = document.getElementById(inputId);
        if (inputEl) {
            inputEl.value = '';
            delete inputEl.dataset.lat;
            delete inputEl.dataset.lon;
            if (inputId === 'pickup' && pickupMarker) {
                map.removeLayer(pickupMarker);
                pickupMarker = null;
            } else if (inputId === 'dropoff' && dropoffMarker) {
                map.removeLayer(dropoffMarker);
                dropoffMarker = null;
            }
            const suggBox = document.getElementById(`${inputId}-suggestions`);
            if (suggBox) suggBox.style.display = 'none';
            inputEl.focus(); 
        }
    });
});
document.querySelectorAll('input[type="text"]').forEach(inputEl => {
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if (clearBtn && !inputEl.id.startsWith('stop-')) { /* Bỏ qua stop inputs */
        inputEl.addEventListener('input', () => {
            clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
        });
        inputEl.addEventListener('focus', () => {
             clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
        });
        inputEl.addEventListener('blur', () => {
             setTimeout(() => clearBtn.style.display = 'none', 150); 
        });
        // Set initial state
        if (inputEl.value.trim()) clearBtn.style.display = 'flex';
    }
});


async function geocodeOnce(query){
  try{
    let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1&accept-language=${currentLang},en`;
    
    // FIX: Removed &bounded=1 to allow searching for locations far from userLocation
    if(userLocation) { 
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.5},${lat - 0.5},${lon + 0.5},${lat + 0.5}`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    } 

    const r = await fetch(url);
    const data = await r.json();
    if(Array.isArray(data) && data.length>0) return data[0];
  }catch(e){ console.warn('geocode once error', e); }
  return null;
} 

function attachAutocomplete(inputEl, boxEl){
  let controller = null; 
    const translations = i18n[currentLang];

  const doSearch = async ()=>{
    const q = inputEl.value.trim();
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    
    if(!q){ 
        boxEl.style.display = 'none'; 
        if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'none';
        return; 
    }
    if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'flex'; 

    if(controller) controller.abort();
    controller = new AbortController();
    
    boxEl.innerHTML = `<div>${translations.alertSearching}</div>`; 
    boxEl.style.display = 'block'; 

    let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=${currentLang},en`; 
    
    // FIX: Removed &bounded=1 to allow searching for locations far from userLocation
    if(userLocation) {
        const [lat, lon] = userLocation;
        url += `&viewbox=${lon - 0.3},${lat - 0.3},${lon + 0.3},${lat + 0.3}`;
    } else {
        url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    }


    try{
      const res = await fetch(url, { signal: controller.signal });
      const data = await res.json();
      
      const fragment = document.createDocumentFragment();
      
      if(!Array.isArray(data) || data.length === 0){ 
        boxEl.innerHTML = `<div>${translations.alertNoSuggestions}</div>`; 
        setTimeout(() => boxEl.style.display = 'none', 1000); 
        return; 
      } 

      data.forEach(place => {
        const d = document.createElement('div');
        d.innerHTML = `<span style="font-size:16px">📍</span><div style="margin-left:8px">${place.display_name}</div>`;
        d.addEventListener('click', ()=>{
          inputEl.value = place.display_name;
          inputEl.dataset.lat = place.lat;
          inputEl.dataset.lon = place.lon;
          boxEl.style.display = 'none';
          if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = 'flex'; 

          const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
          if(map) {
            if(inputEl.id === 'pickup'){
              if(pickupMarker) map.removeLayer(pickupMarker);
              pickupMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupPickup).openPopup();
              map.setView(latlng, 14);
            } else if(inputEl.id === 'dropoff'){
              if(dropoffMarker) map.removeLayer(dropoffMarker);
              dropoffMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupDropoff).openPopup();
              map.setView(latlng, 14);
            } 
          }
        });
        fragment.appendChild(d);
      });
      
      boxEl.innerHTML = '';
      boxEl.appendChild(fragment);
      boxEl.style.display = 'block';
      
    }catch(err){
      if(err.name === 'AbortError') return; 
      console.error('suggest error', err);
      boxEl.innerHTML = '<div>Lỗi mạng hoặc API. Thử lại</div>'; // Keep in VN for now, assuming mostly network issue
      setTimeout(() => boxEl.style.display = 'none', 2000); 
    }
  }; 

  inputEl.addEventListener('input', debounce(doSearch)); 

  document.addEventListener('click', (ev)=>{
    if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; 
  }); 

  inputEl.addEventListener('focus', ()=> {
    const inputId = inputEl.id; 
    if(inputId && inputId.startsWith('stop-')) lastFocusedStopId = inputId;
    else lastFocusedStopId = null;
    
    const clearBtn = inputEl.parentNode.querySelector('.clear-btn');
    if(clearBtn && !inputEl.id.startsWith('stop-')) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none';
  });
} 

attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg); 

function createStopInput(prefill=''){
  stopCount++;
    const translations = i18n[currentLang];
  const wrapper = document.createElement('div');
  wrapper.className = 'way-wrapper input-row';
  const inputId = `stop-${stopCount}`;
  const suggId = `${inputId}-suggestions`;
  wrapper.innerHTML = `
    <input type="text" id="${inputId}" placeholder="${translations.placeholderPickup.replace('điểm đón', 'điểm dừng ' + stopCount).replace('pickup address', 'stopover ' + stopCount).replace('上车地址', '经停点 ' + stopCount)}">
    <button class="clear-btn" data-input-id="${inputId}">✖</button> 
    <button class="way-remove" title="Xóa">✖</button>
    <div id="${suggId}" class="suggestions" style="display:none"></div>
  `;
  stopsContainer.appendChild(wrapper); 

  const inputEl = wrapper.querySelector('input');
  const boxEl = wrapper.querySelector('.suggestions');
  attachAutocomplete(inputEl, boxEl);
  
  const clearBtn = wrapper.querySelector('.clear-btn');
    /* NOTE: Nút clear-btn cho stop input sẽ bị ẩn bởi CSS vì đã có nút way-remove */
  inputEl.addEventListener('input', () => { if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none'; });
  inputEl.addEventListener('focus', () => { if(clearBtn) clearBtn.style.display = inputEl.value.trim() ? 'flex' : 'none'; });
  inputEl.addEventListener('blur', () => { setTimeout(() => { if(clearBtn) clearBtn.style.display = 'none'; }, 150); });
  clearBtn.addEventListener('click', (e) => {
    e.stopPropagation(); 
    inputEl.value = ''; 
    delete inputEl.dataset.lat;
    delete inputEl.dataset.lon;
    boxEl.style.display = 'none';
    inputEl.focus();
  });


  wrapper.querySelector('.way-remove').addEventListener('click', ()=> wrapper.remove()); 

  inputEl.addEventListener('focus', ()=> lastFocusedStopId = inputId); 

  return inputEl;
} 

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput()); 

document.getElementById('pick-from-map').addEventListener('click', ()=> { 
    selecting = 'pickup'; 
    alert(i18n[currentLang].alertMapPickPickup); 
});
document.getElementById('pick-to-map').addEventListener('click', ()=> { 
    selecting = 'dropoff'; 
    alert(i18n[currentLang].alertMapPickDropoff); 
}); 

const handleMapClick = async (e) => {
  if (!map) return; 
  const lat = e.latlng.lat, lon = e.latlng.lng;
    const translations = i18n[currentLang];
  
  let targetInput, targetMarker; 

  if(selecting === 'pickup'){
    targetInput = pickupEl;
    targetMarker = pickupMarker;
    if(pickupMarker) map.removeLayer(pickupMarker);
    pickupMarker = L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupPickup).openPopup();
    selecting = null;
  } else if(selecting === 'dropoff'){
    targetInput = dropoffEl;
    targetMarker = dropoffMarker;
    if(dropoffMarker) map.removeLayer(dropoffMarker);
    dropoffMarker = L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupDropoff).openPopup();
    selecting = null;
  } else if(lastFocusedStopId){
    targetInput = document.getElementById(lastFocusedStopId);
    if(targetInput){
      L.marker([lat,lon]).addTo(map).bindPopup(translations.mapPopupStop).openPopup();
      lastFocusedStopId = null;
    }
  } 

  if(targetInput){
    const address = await reverseGeocode(lat, lon);
    targetInput.value = address;
    
    targetInput.dataset.lat = lat; targetInput.dataset.lon = lon;
    const clearBtn = targetInput.parentNode.querySelector('.clear-btn');
    if(clearBtn && !targetInput.id.startsWith('stop-')) clearBtn.style.display = 'flex';
    
    if(targetMarker) map.setView([lat,lon], 14);
  }
};


const handleMapDblClick = (e) => {
  if (!map) return; 
  if(lastFocusedStopId){
    const stopInput = document.getElementById(lastFocusedStopId);
    if(stopInput){
      stopInput.value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      stopInput.dataset.lat = e.latlng.lat; stopInput.dataset.lon = e.latlng.lng;
      L.marker([e.latlng.lat,e.latlng.lng]).addTo(map).bindPopup(i18n[currentLang].mapPopupStop).openPopup();
      lastFocusedStopId = null;
    }
  }
};


async function resolveCoordForInput(inputEl){
  if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon){
    return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
  }
  const v = inputEl.value.trim();
  if(!v) return null;
  const parts = v.split(',');
  if(parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))){
    // Giả định nhập Lat, Lon nếu có 2 số
    return [parseFloat(parts[0]), parseFloat(parts[1])]; 
  }
  const place = await geocodeOnce(v + ' Việt Nam');
  if(place){
    inputEl.dataset.lat = place.lat;
    inputEl.dataset.lon = place.lon;
    return [parseFloat(place.lat), parseFloat(place.lon)];
  }
  return null;
} 

function validateRouteInputs() {
    const translations = i18n[currentLang];
    if (pickupEl.value.trim() === '') {
        alert(translations.alertPickup);
        pickupEl.focus();
        return false;
    }
    if (dropoffEl.value.trim() === '') {
        alert(translations.alertDropoff);
        dropoffEl.focus();
        return false;
    }
    const tripType = tripTypeEl.value; 
    const waiting = parseFloat(waitingEl.value); 
    if (tripType === '2') {
        if (isNaN(waiting) || waiting < 0) {
            alert(translations.alertWaiting);
            waitingEl.focus();
            return false;
        }
    }
    return true;
} 

function validatePhone(phone) {
    const phoneRegex = /^\d{10}$/; 
    return phoneRegex.test(phone);
} 

// Hàm chính tính giá cước và tạo tin nhắn Zalo
async function calculateAndGenerateMessage() {
    const translations = i18n[currentLang];

    if (!validateRouteInputs()) {
        return false; 
    }
    
    const pickupCoord = await resolveCoordForInput(pickupEl);
    if(!pickupCoord){ alert(translations.statusNoCoord + (currentLang === 'en' ? 'Pickup' : (currentLang === 'zh' ? '上车' : 'đón')) + '. ' + translations.alertNoCoord); return false; }
    const dropoffCoord = await resolveCoordForInput(dropoffEl);
    if(!dropoffCoord){ alert(translations.statusNoCoord + (currentLang === 'en' ? 'Drop-off' : (currentLang === 'zh' ? '目的地' : 'đến')) + '. ' + translations.alertNoCoord); return false; } 

    const coords = [];
    coords.push(pickupCoord);
    const stopInputs = Array.from(stopsContainer.querySelectorAll('input[id^="stop-"]'));
    for(const s of stopInputs){
        if(s.value.trim()){
            const sc = await resolveCoordForInput(s);
            if(!sc){ alert(translations.alertNoStopCoord); return false; }
            coords.push(sc);
        }
    }
    coords.push(dropoffCoord); 

    const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
    const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`; 

    resultBox.style.display = 'block';
    distanceText.textContent = translations.statusCalculatingRoute;
    priceValue.textContent = '...';
    priceBreak.innerHTML = '';
    timeEst.textContent = '';
    finalZaloMessage = ''; 
    finalTotalFee = 0;
    zaloBtn.style.display = 'none'; 
    mailBtn.style.display = 'none';
    instructionText.innerHTML = translations.statusCalculating; 

    try{
        const r = await fetch(url);
        const data = await r.json();
        if(!data.routes || data.routes.length === 0){ distanceText.textContent = translations.statusNoRoute; return false; }
        const route = data.routes[0];
        const dist = route.distance / 1000; 
        const minutes = Math.round((route.duration / 60)); // OSRM gives duration in seconds

        if(map) {
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
        } 

        const tripType = tripTypeEl.value; 
        const carType = carTypeEl.value; 
        const driverRequest = driverRequestEl.value; // Get driver request
        const waiting = parseFloat(waitingEl.value) || 0; 
        
        let perKm, carName, carPrice;
        if (carType.includes('7 chỗ') || carType.includes('7 Seater') || carType.includes('7座车')) { 
                perKm = 12000; 
                carName = translations.car7seater.replace(/ \(.+\)/, '');
                carPrice = '12.000đ/km';
            } else { 
                perKm = 10000; 
                carName = translations.car4seater.replace(/ \(.+\)/, '');
                carPrice = '10.000đ/km';
            }
        const perKmReturnDiscount = Math.round(perKm * 0.6); 

        const priceGo = Math.round(dist * perKm);
        let priceReturn = 0;
        let returnNote = ''; 

        if(tripType === '2') {
            if(dist >= 45) {
                priceReturn = Math.round(dist * perKmReturnDiscount); 
                returnNote = currentLang === 'en' ? `Return trip (40% off due to one-way ≥ 45km => ${(perKmReturnDiscount/1000).toLocaleString('en-US')}k/km)` : 
                           (currentLang === 'zh' ? `返程 (单程 ≥ 45公里，减40% => ${(perKmReturnDiscount/1000).toLocaleString('zh-CN')}k/公里)` : 
                           `Chiều về (giảm 40% do 1 chiều ≥ 45km => ${perKmReturnDiscount.toLocaleString('vi-VN')}đ/km)`);
            } else {
                priceReturn = Math.round(dist * perKm); 
                returnNote = currentLang === 'en' ? `Return trip (No discount as one-way < 45km => ${(perKm/1000).toLocaleString('en-US')}k/km)` : 
                           (currentLang === 'zh' ? `返程 (单程 < 45公里，无折扣 => ${(perKm/1000).toLocaleString('zh-CN')}k/公里)` : 
                           `Chiều về (Không giảm giá do 1 chiều < 45km => ${perKm.toLocaleString('vi-VN')}đ/km)`);
            }
        } else {
            returnNote = translations.tripOneWay;
        } 

        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total; // Lưu lại tổng phí
        const depositAmountValue = Math.round(total * 0.2); // Tính tiền đặt cọc 

        // Cập nhật hiển thị kết quả
        distanceText.textContent = `${translations.resultDistance} ${dist.toFixed(1)} km`;
        priceValue.textContent = `${total.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ`;
        
            priceBreak.innerHTML = `
                <span style="font-size: 14px; display: block; margin-bottom: 4px;">${carName}: ${carPrice}</span>
                <span>${translations.tripOneWay}: ${priceGo.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ</span><br>
                ${tripType === '2' ? `<span>${returnNote}: ${priceReturn.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ</span><br>` : ''}
                ${waitFee > 0 ? `<span>${translations.labelWaiting.replace(' (giờ)', '')} (${waiting}h): ${waitFee.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ (+50k/h từ giờ thứ 4)</span><br>` : ''}
                ${tripType === '2' && waitFee === 0 && waiting > 0 ? `<span>${translations.labelWaiting.replace(' (giờ)', '')} (${waiting}h): 0 đ (Miễn phí 3 giờ đầu)</span><br>` : ''}
            `;
        
        timeEst.textContent = `${translations.resultTimeEst} ${minutes} ${currentLang === 'en' ? 'minutes' : (currentLang === 'zh' ? '分钟' : 'phút')}`;
        
        const pickupDt = pickupDateTime.value ? new Date(pickupDateTime.value).toLocaleString(currentLang === 'en' ? 'en-US' : 'vi-VN', { dateStyle: 'short', timeStyle: 'short' }) : 'Không có';
        pickupInfo.textContent = `${translations.resultPickupTime} ${pickupDt}`; 

        // Cập nhật tin nhắn Zalo/Mail
        const stopAddresses = stopInputs.filter(s => s.value.trim()).map((s, i) => `${currentLang === 'en' ? 'Stopover' : (currentLang === 'zh' ? '经停点' : 'Điểm dừng')} ${i+1}: ${s.value}`).join('\n');
            
            const zaloMessageLines = [
                `**${translations.modalBookingTitle.replace('✅ ', '')}**`,
                `---`,
                `${translations.labelPhone.replace('📞 ', '').split(' (')[0]}: ${customerPhoneEl.value || (currentLang === 'en' ? 'Not provided' : (currentLang === 'zh' ? '未提供' : 'Chưa cung cấp'))}`,
                `${translations.labelPickup.replace('📍 ', '')}: ${pickupEl.value}`,
                stopAddresses ? stopAddresses : '',
                `${translations.labelDropoff.replace('🏁 ', '')}: ${dropoffEl.value}`,
                `${translations.labelTime.replace('🕒 ', '')}: ${pickupDt}`,
                `${translations.labelCarType.replace('🚘 ', '')}: ${carName}`,
                `${translations.labelTripType.replace('🚗 ', '')}: ${tripTypeEl.options[tripTypeEl.selectedIndex].text}`,
                `${translations.labelDriverRequest.replace(/🧑‍✈️|👤 /, '').split(' (')[0]}: ${driverRequest}`,
                (tripType === '2' && waiting > 0) ? `${translations.labelWaiting.replace('⏳ ', '').replace(' (giờ)', '')}: ${waiting} ${currentLang === 'en' ? 'hours' : (currentLang === 'zh' ? '小时' : 'giờ')}` : '',
                `---`,
                `${translations.resultDistance} ${dist.toFixed(1)} km`,
                `${translations.resultPriceTitle.replace('💵 ', '')}: ${total.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ (Ước tính)`,
                `(${translations.tripOneWay}: ${priceGo.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ ${tripType === '2' ? '+ ' + returnNote.split('(')[0].trim() + ' ' + priceReturn.toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN')) + ' đ' : ''}${waitFee > 0 ? ' + phí chờ' : ''})`,
                `---`,
                currentLang === 'en' ? 'Please confirm this information.' : (currentLang === 'zh' ? '请确认这些信息。' : 'Vui lòng xác nhận lại thông tin này.'),
            ];

            finalZaloMessage = zaloMessageLines.filter(line => line.trim() !== '').join('\n');


        // Hiển thị nút đặt xe
        zaloBtn.style.display = 'block'; 
        mailBtn.style.display = 'block';
        instructionText.innerHTML = translations.statusActive; 

        return true;

    }catch(e){
        console.error('Route calculation error:', e);
        distanceText.textContent = translations.statusNoRoute;
        priceValue.textContent = 'LỖI';
        priceBreak.innerHTML = '';
        instructionText.innerHTML = translations.statusActive;
        return false;
    }
}

// Bắt đầu
document.addEventListener('DOMContentLoaded', ()=> {
    getGeolocation();
    checkServiceStatus().then(updateUIBasedOnStatus);
});

reloadLocationBtn.addEventListener('click', getGeolocation); 

calcBtn.addEventListener('click', calculateAndGenerateMessage); 


// Logic Modals
function openModal(modalEl){
    modalEl.style.display = 'flex';
}
function closeModal(modalEl){
    modalEl.style.display = 'none';
}

zaloBtn.addEventListener('click', async () => {
    if (!isServiceActive) return;

    const success = await calculateAndGenerateMessage();
    if (!success) return;

    bookingAction = 'zalo';
    const phone = customerPhoneEl.value.trim();

    if (tripTypeEl.value === '2') {
        // Show deposit modal first for two-way
        depositAmount.textContent = `${Math.round(finalTotalFee * 0.2).toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ`;
        openModal(depositModal);
        return; // Wait for deposit confirmation
    }

    if (phone && validatePhone(phone)) {
        showZaloModal();
    } else {
        // Show phone modal
        inputPhoneForBooking.value = phone;
        openModal(phoneModal);
    }
});

mailBtn.addEventListener('click', async () => {
    if (!isServiceActive) return;

    const success = await calculateAndGenerateMessage();
    if (!success) return;
    
    bookingAction = 'mail';
    const phone = customerPhoneEl.value.trim();
    
    if (tripTypeEl.value === '2') {
        // Show deposit modal first for two-way
        depositAmount.textContent = `${Math.round(finalTotalFee * 0.2).toLocaleString(currentLang === 'en' ? 'en-US' : (currentLang === 'zh' ? 'zh-CN' : 'vi-VN'))} đ`;
        openModal(depositModal);
        return; // Wait for deposit confirmation
    }
    
    if (phone && validatePhone(phone)) {
        showZaloModal(true); // Re-use modal for mail, but link to email
    } else {
        // Show phone modal
        inputPhoneForBooking.value = phone;
        openModal(phoneModal);
    }
});

confirmDepositBtn.addEventListener('click', () => {
    closeModal(depositModal);
    const phone = customerPhoneEl.value.trim();
    
    if (phone && validatePhone(phone)) {
        if (bookingAction === 'zalo') showZaloModal();
        else if (bookingAction === 'mail') showZaloModal(true);
    } else {
        // Show phone modal
        inputPhoneForBooking.value = phone;
        openModal(phoneModal);
    }
});

confirmPhoneBtn.addEventListener('click', () => {
    const phone = inputPhoneForBooking.value.trim();
    if (validatePhone(phone)) {
        customerPhoneEl.value = phone; // Update the main phone field
        closeModal(phoneModal);
        
        // Re-calculate and open final modal
        calculateAndGenerateMessage().then(success => {
            if (success) {
                if (bookingAction === 'zalo') showZaloModal();
                else if (bookingAction === 'mail') showZaloModal(true);
            }
        });
    } else {
        alert(currentLang === 'en' ? 'Please enter a valid 10-digit phone number.' : (currentLang === 'zh' ? '请输入有效的10位电话号码。' : 'Vui lòng nhập SĐT 10 số hợp lệ.'));
    }
});

closePhoneModalBtn.addEventListener('click', () => closeModal(phoneModal));
closeModalBtn.addEventListener('click', () => closeModal(zaloModal));

function showZaloModal(isMail = false) {
    const translations = i18n[currentLang];
    modalText.textContent = finalZaloMessage;

    const zaloBtn = document.getElementById('zaloModalBtn');
    const titleEl = zaloModal.querySelector('h3');
    const noticeEl = zaloModal.querySelector('p:nth-of-type(1)'); // The first <p> element

    if (isMail) {
        titleEl.textContent = translations.modalBookingTitle.replace('Zalo', 'Mail');
        noticeEl.innerHTML = currentLang === 'en' ? 'Copy the information and send via **Email**:' : 
                           (currentLang === 'zh' ? '复制信息并通过 **邮件** 发送:' : 
                           'Sao chép thông tin và gửi qua **Email**:');
        zaloBtn.textContent = currentLang === 'en' ? '📧 Send via Email' : (currentLang === 'zh' ? '📧 通过邮件发送' : '📧 Gửi qua Email');
        zaloBtn.style.background = '#dc3545';
        zaloBtn.onclick = () => {
            const subject = currentLang === 'en' ? 'Booking Truong An Driving' : (currentLang === 'zh' ? '预订长安驾驶' : 'Đặt xe Trường An Driving');
            window.location.href = `mailto:truongan.driving@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(finalZaloMessage)}`;
        };
    } else {
        titleEl.textContent = translations.modalBookingTitle;
        noticeEl.textContent = translations.modalBookingNotice;
        zaloBtn.textContent = translations.modalBtnZalo;
        zaloBtn.style.background = '#0068ff';
        zaloBtn.onclick = () => window.open(ZALO_URL, '_blank');
    }
    
    openModal(zaloModal);
}

copyModalBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(modalText.textContent).then(() => {
        copyModalBtn.textContent = currentLang === 'en' ? '✅ Copied!' : (currentLang === 'zh' ? '✅ 已复制！' : '✅ Đã Sao Chép!');
        setTimeout(() => copyModalBtn.textContent = i18n[currentLang].modalBtnCopy, 1500);
    }).catch(err => {
        console.error('Could not copy text: ', err);
        alert(currentLang === 'en' ? 'Copy failed. Please copy manually.' : (currentLang === 'zh' ? '复制失败。请手动复制。' : 'Sao chép thất bại. Vui lòng copy thủ công.'));
    });
});
</script>
</body>
</html>
