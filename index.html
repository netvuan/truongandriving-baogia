<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title data-i18n="appTitle">ğŸš– Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#28a745">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* COLOR PALETTE & VARIABLES */
        :root{
            --green: #28a745; /* MÃ u thÆ°Æ¡ng hiá»‡u chÃ­nh */
            --green-dark: #1e7e34; /* MÃ u hover */
            --muted: #6c757d;
            --light-gray: #f4f6f8;
            --white: #ffffff;
            --primary: var(--green);
            --danger: #dc3545;
        }

        /* RESET & BASE */
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: 'Roboto', Arial, Helvetica, sans-serif; /* Ãp dá»¥ng font má»›i */
            color:#111;
            background: var(--light-gray);
        }
        #main-content {
            background:var(--light-gray);
            padding: 0;
        }

        /* HEADER - Sá»¬A Láº I */
        header {
            background: var(--green);
            color: var(--white);
            padding: 12px 16px;
            text-align: center;
            font-weight: 700;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
        }
        .header-title {
            font-size: 20px;
            font-weight: 900;
            text-align: left;
            flex-shrink: 0; /* KhÃ´ng co láº¡i */
        }
        .header-info {
            display: flex;
            align-items: center;
            gap: 15px; /* Khoáº£ng cÃ¡ch giá»¯a SÄT vÃ  ngÃ´n ngá»¯ */
        }
        .phone-number {
            font-size: 18px;
            font-weight: 900;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #language-switcher {
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: transparent;
            color: white;
            font-weight: 500;
            font-size: 14px;
        }
        #language-switcher option {
            color: #000; /* MÃ u chá»¯ cho cÃ¡c option */
        }
        .brand-name {
            font-size: 16px;
            font-weight: 900;
            margin-top: 4px;
        }
        
        /* Responsive cho header */
        @media(max-width:450px){
            .header-title { font-size: 18px; }
            .phone-number { font-size: 16px; }
            .header-info { gap: 8px; }
            #language-switcher { padding: 4px; font-size: 12px; }
        }

        /* CONTAINER & LAYOUT */
        .container{
            padding:16px 12px; /* TÄƒng padding tá»•ng thá»ƒ */
        }
        .label-row{
            display:flex;
            align-items:center;
            gap:8px;
            margin-top:18px; /* TÄƒng khoáº£ng cÃ¡ch giá»¯a cÃ¡c pháº§n chÃ­nh */
        }
        .label-row:first-of-type { margin-top: 6px; }
        .label-row h3{
            margin:0;
            font-size:17px; /* TÄƒng cá»¡ chá»¯ label */
            font-weight: 700;
            color: #333;
            /* FIX: ThÃªm margin cho cÃ¡c icon/emoji Ä‘á»ƒ trÃ¡nh lá»—i máº¥t icon */
            display: flex;
            align-items: center;
        }
        .label-row h3 > span:first-child {
            margin-right: 8px; /* Khoáº£ng cÃ¡ch giá»¯a icon vÃ  chá»¯ */
            font-size: 1.2em; /* TÄƒng kÃ­ch thÆ°á»›c icon */
            line-height: 1;
        }
        #location-status-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        #reloadLocationBtn {
            cursor: pointer;
            font-style: normal;
            font-size: 20px;
            color: #007bff;
            transition: transform 0.2s;
        }
        #reloadLocationBtn:hover {
            transform: rotate(45deg);
        }

        /* INPUTS & CONTROLS */
        .input-row{position:relative;margin-top:8px}
        input[type="text"], input[type="number"], input[type="datetime-local"], select, input[type="tel"]{
            width:100%;
            padding:14px 16px; /* TÄƒng padding input */
            border-radius:12px; /* Bo trÃ²n hÆ¡n */
            border:1px solid #ddd;
            font-size:16px;
            background:var(--white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2); /* ThÃªm box shadow ná»•i báº­t */
            outline: none;
        }

        /* Clear Button (X) - ÄÃ£ tá»‘i Æ°u */
        .input-row .clear-btn {
            position: absolute;
            right: 80px;
            top: 50%;
            transform: translateY(-50%); /* CÄƒn giá»¯a dá»c */
            height: 36px; /* Chiá»u cao cá»‘ Ä‘á»‹nh */
            width: 36px;
            background: #e9ecef;
            color: #6c757d;
            border: none;
            padding: 0;
            border-radius: 8px; /* Bo trÃ²n hÃ¬nh vuÃ´ng */
            font-weight: 700;
            cursor: pointer;
            line-height: 1;
            font-size: 16px;
            display: none;
            z-index: 1000;
            transition: background 0.1s;
            align-items: center;
            justify-content: center;
            opacity: 0.8;
        }
        .input-row input:focus + .clear-btn, .input-row .clear-btn:hover {
            display: flex;
            opacity: 1;
        }
        .input-row .clear-btn:hover { background: #dee2e6; color: #495057; }
        input[type="text"]{
            padding-right: 140px;
        }

        /* Map Button - ÄÃ£ tá»‘i Æ°u */
        .map-btn{
            position:absolute;
            right:8px;
            top: 50%;
            transform: translateY(-50%); /* CÄƒn giá»¯a dá»c */
            background:var(--primary);
            color:var(--white);
            border:0;
            padding:8px 10px; /* TÄƒng padding nÃºt báº£n Ä‘á»“ */
            border-radius:10px; /* Bo trÃ²n hÆ¡n */
            font-weight:700;
            cursor:pointer;
            line-height: 1.2;
            transition: background 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .map-btn:hover {
            background: var(--green-dark);
        }

        /* Stop Input/Remove */
        .way-wrapper input[type="text"] {
            /* TÄƒng padding Ä‘á»ƒ chá»©a cáº£ nÃºt XÃ³a vÃ  Báº£n Ä‘á»“ */
            padding-right: 125px; 
        }
        .way-wrapper .map-btn {
            /* Vá»‹ trÃ­ nÃºt báº£n Ä‘á»“ trong Ä‘iá»ƒm dá»«ng */
            right: 52px; 
        }
        .way-remove{
            position:absolute;
            right:8px;
            top:50%;
            transform: translateY(-50%);
            background:#ff4d4d; /* MÃ u Ä‘á» ná»•i báº­t hÆ¡n */
            color:var(--white);
            border:0;
            padding:6px 10px;
            border-radius:8px;
            cursor:pointer;
            font-weight: 700;
            line-height: 1.5;
            transition: background 0.2s;
        }
        .way-remove:hover { background: #cc0000; }
        .way-wrapper .clear-btn { display: none !important; }

        /* General Buttons */
        .add-stop, .calc-btn {
            display:block;
            background:var(--primary);
            color:var(--white);
            border:none;
            border-radius:12px;
            font-weight:700;
            cursor:pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(40, 167, 69, 0.3);
            width: 100%;
        }
        .add-stop {
            padding:14px;
            font-size:16px;
            margin-top:16px;
        }
        .calc-btn {
            padding:16px;
            font-size:20px;
            margin-top:20px; /* TÄƒng khoáº£ng cÃ¡ch */
        }
        .add-stop:hover, .calc-btn:hover {
            background: var(--green-dark);
            transform: translateY(-1px);
        }
        .calc-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* MAP & SUGGESTIONS */
        #map{
            height:320px;
            margin-top:16px; /* TÄƒng margin */
            border-radius:12px;
            overflow:hidden;
            border: 1px solid #ddd;
        }
        .suggestions{
            position:absolute;
            left:0;
            right:0;
            top: calc(100% + 4px);
            background:var(--white);
            border:1px solid #ddd;
            border-radius:12px;
            max-height:240px; /* TÄƒng chiá»u cao tá»‘i Ä‘a */
            overflow:auto;
            -webkit-overflow-scrolling:touch;
            z-index:2000;
            box-shadow:0 8px 20px rgba(0,0,0,0.15);
        }
        .suggestions div{
            padding:12px;
            border-bottom:1px solid #f0f0f0;
            cursor:pointer;
            display:flex;
            gap:10px;
            align-items: center;
        }
        .suggestions div:last-child{border-bottom:0}
        .suggestions div:hover{background:#e9ecef}

        /* RESULT BOX - ÄÃ£ Tá»‘i Æ¯u */
        .result-box{
            margin-top:20px;
            padding:16px; /* TÄƒng padding */
            border-radius:12px;
            background:#e6f3e6; /* MÃ u xanh nháº¡t hÆ¡n, phÃ¹ há»£p vá»›i brand green */
            border:1px solid #c8e6c9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .result-row{
            display:flex;
            align-items:center;
            gap:8px;
            margin-bottom: 8px;
        }
        .distance-text{font-size:16px; font-weight: 500;}
        .price-title{
            font-weight:800;
            font-size: 18px;
            margin-top:10px;
            color: #333;
        }
        .price-value{
            font-size:30px; /* TÄƒng cá»¡ chá»¯ giÃ¡ */
            color: var(--primary); /* Äá»•i mÃ u thÆ°Æ¡ng hiá»‡u */
            font-weight:900;
            display: block;
            margin-top: 4px;
        }
        .price-break{
            margin-top:10px;
            font-size:14px;
            line-height: 1.6;
            color: #555;
            border-top: 1px solid #c8e6c9;
            padding-top: 8px;
        }

        /* ACTIONS (Booking Buttons) */
        .actions{display:flex;gap:12px;margin-top:20px}
        .actions a{
            flex:1;
            text-align:center;
            padding:14px;
            border-radius:10px;
            color:var(--white);
            text-decoration:none;
            font-weight:700;
            border: none;
            cursor:pointer;
            transition: opacity 0.2s, transform 0.1s, background 0.2s; /* ThÃªm transition cho background */
        }
        .actions a.active-booking {
            opacity: 1; /* NÃºt kÃ­ch hoáº¡t */
            pointer-events: auto;
        }
        .actions a.inactive-booking {
            background: #ccc !important; /* MÃ u xÃ¡m khi chÆ°a Ä‘á»§ Ä‘iá»u kiá»‡n Ä‘áº·t */
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
            transform: none !important;
        }
        .actions a:not(.inactive-booking):hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .zalo-btn {background:#007bff; box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);} /* MÃ u xanh Zalo */
        .mail{background:#dc3545; box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);} /* MÃ u Ä‘á» Email */

        /* NOTE & STATUS - Sá»¬A Láº I */
        .note {
            margin-top: 20px;
            font-size: 14px;
            color: #333;
            background: var(--white);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #ddd;
            line-height: 1.6;
        }
        .note p {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .note strong {
            color: #111;
        }
        .note ul {
            margin-top: 5px;
            padding-left: 25px; /* TÄƒng padding Ä‘á»ƒ icon khÃ´ng bá»‹ che */
            margin-bottom: 0;
            list-style-type: none; /* Táº¯t bullet máº·c Ä‘á»‹nh */
        }
        .note ul li {
            position: relative;
            padding-left: 5px;
            margin-bottom: 6px;
        }
        .note ul li::before {
            content: 'ğŸ“Œ';
            position: absolute;
            left: -25px;
            top: 2px;
            color: var(--primary);
        }

        #instructionText {
            margin-top: 16px !important;
            padding: 12px !important;
            background: #d1ecf1; /* MÃ u xanh nháº¡t cho thÃ´ng bÃ¡o */
            border-radius: 10px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            color: #0c5460;
            text-align: center;
        }
        #serviceOffNotice {
            margin-top: 16px;
            padding: 12px;
            background: #f8d7da; /* MÃ u Ä‘á» nháº¡t cho cáº£nh bÃ¡o táº¯t dá»‹ch vá»¥ */
            color: #721c24;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            text-align: center;
            border: 1px solid #f5c6cb;
        }

        /* NEW: Driver Select Styling */
        #driverRequest {
            font-size: 16px;
            font-weight: 500;
            border: 1px solid var(--primary); /* Viá»n mÃ u thÆ°Æ¡ng hiá»‡u */
        }
        
        /* Modal Styling */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; display: none;
            justify-content: center; align-items: center; padding: 20px;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background: #fff; border-radius: 16px; padding: 25px;
            width: 100%; max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            animation: slideIn 0.3s;
        }
        .modal-content h3 {
            margin-top: 0; color: var(--green); font-size: 24px; text-align: center;
            font-weight: 800;
        }
        #modal-text {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            overflow-x: auto;
        }
        .modal-actions {
            display: flex; gap: 10px;
        }
        .modal-actions button {
            flex: 1; padding: 12px; border-radius: 10px; font-weight: 700; border: none; cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .modal-actions button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        #copyModalBtn { background: #ffc107; color: #333; }
        #zaloModalBtn { background: #007bff; color: #fff; }
        #closeModalBtn { background: #ccc; color: #333; }
        
        /* Phone Input Modal - Má»šI */
        #phoneModal .modal-content p { margin: 10px 0 15px; font-size: 16px; text-align: center; color: #333; }
        #phoneModalInput { margin-bottom: 15px; text-align: center; }
        #phoneModalError { color: var(--danger); font-size: 14px; text-align: center; min-height: 20px; font-weight: 500; }
        #phoneModalConfirmBtn { background: var(--green); color: white; width: 100%; }
        #phoneModal .modal-actions button.close { background-color: #6c757d; }


        /* Deposit Modal Styles */
        #depositModal .modal-content { background: #e6f3e6; border: 1px solid #c8e6c9; }
        #depositModal h3 { color: #155724; }
        #depositModal #depositAmount {
            font-weight: 900;
            font-size: 22px;
            color: #007bff;
            background: #fff;
            padding: 5px 12px;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #depositModal #confirmDepositBtn { background: var(--green); color: white; }

        /* === NEW: MAP MODAL STYLES === */
        #mapModal .modal-content {
            max-width: 800px; /* Rá»™ng hÆ¡n cho báº£n Ä‘á»“ */
            padding: 15px;
        }
        #mapModal h3 {
             font-size: 20px;
             margin-bottom: 10px;
        }
        #map-modal-container {
            height: 65vh; /* Chiá»u cao tÆ°Æ¡ng Ä‘á»‘i */
            max-height: 500px;
            width: 100%;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        #mapModal .modal-actions button {
            width: 100%; /* NÃºt chiáº¿m toÃ n bá»™ chiá»u rá»™ng */
        }
        #confirmMapSelectionBtn {
            background: var(--green);
            color: white;
        }
        
        /* Loading Overlay Style */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            font-size: 40px; color: var(--primary);
        }
        .loading-overlay::after {
            content: 'âš™ï¸';
            animation: spin 1.5s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        @media(min-width:700px){
            .container{max-width:720px;margin:0 auto}
            .header-title { font-size: 22px; }
        }
    </style>
</head>
<body>
<div id="main-content">
    <header>
        <div class="header-top">
            <div class="header-title" data-i18n="headerService">ğŸš– Dá»‹ch Vá»¥ Taxi</div>
            <div class="header-info">
                <a href="tel:0847526893" class="phone-number">â˜ï¸ 0847526893</a>
                <select id="language-switcher">
                    <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                    <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                    <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                </select>
            </div>
        </div>
        <div class="brand-name">â­â­ TrÆ°á»ng An Driving â­â­</div>
    </header>

    <div class="container">

        <div id="serviceOffNotice" style="display:none;"></div>

        <div id="instructionText" data-i18n="statusChecking">
            ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...
        </div>

        <div id="booking-form-wrapper">

            <div class="label-row" style="margin-top:6px">
                <h3 data-i18n="labelPhone"><span>ğŸ“</span> Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)</h3>
            </div>
            <input id="customerPhone" type="tel" data-i18n-placeholder="placeholderPhone" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel">

            <div class="label-row">
                <h3 data-i18n="labelPickup"><span>ğŸ“</span> Äiá»ƒm Ä‘Ã³n</h3>
                <div id="location-status-wrapper">
                    <span id="location-status" style="font-size:12px; color:var(--muted); font-weight:bold;" data-i18n="statusLocating">(Äang tÃ¬m vá»‹ trÃ­...)</span>
                    <i id="reloadLocationBtn" data-i18n-title="titleReloadLocation" title="Thá»­ láº¥y láº¡i vá»‹ trÃ­">ğŸ”„</i>
                </div>
            </div>
            <div class="input-row">
                <input id="pickup" type="text" data-i18n-placeholder="placeholderPickup" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)">
                <button class="clear-btn" data-input-id="pickup">âœ–</button>
                <button class="map-btn" data-target-input="pickup" data-i18n="btnMap">Báº£n Ä‘á»“</button>
                <div id="pickup-suggestions" class="suggestions" style="display:none"></div>
            </div>

            <div class="label-row">
                <h3 data-i18n="labelTime"><span>ğŸ•’</span> NgÃ y & Giá» Ä‘Ã³n</h3>
            </div>
            <input id="pickupDateTime" type="datetime-local">

            <div id="stops"></div>
            <button class="add-stop" id="add-stop-btn" data-i18n="btnAddStop">ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng</button>

            <div class="label-row">
                <h3 data-i18n="labelDropoff"><span>ğŸ</span> Äiá»ƒm Ä‘áº¿n</h3>
            </div>
            <div class="input-row">
                <input id="dropoff" type="text" data-i18n-placeholder="placeholderDropoff" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i">
                <button class="clear-btn" data-input-id="dropoff">âœ–</button>
                <button class="map-btn" data-target-input="dropoff" data-i18n="btnMap">Báº£n Ä‘á»“</button>
                <div id="dropoff-suggestions" class="suggestions" style="display:none"></div>
            </div>

            <div class="label-row">
                <h3 data-i18n="labelCarType"><span>ğŸš˜</span> Loáº¡i xe</h3>
            </div>
            <select id="carType">
                <option value="4 chá»— (10.000Ä‘/km)" data-i18n="car4seater">Xe 4 chá»— (10.000Ä‘/km)</option>
                <option value="7 chá»— (12.000Ä‘/km)" data-i18n="car7seater">Xe 7 chá»— (12.000Ä‘/km)</option>
            </select>

            <div class="label-row">
                <h3 data-i18n="labelDriverRequest">
                    <span>ğŸ§‘â€âœˆï¸</span> YÃªu cáº§u TÃ i xáº¿
                </h3>
            </div>
            <select id="driverRequest">
                <option value="TrÆ°á»ng An Driving" data-i18n="driverDefault">â­ TrÆ°á»ng An Driving (Máº·c Ä‘á»‹nh)</option>
                <option value="Thanh Loan">ğŸ‘¸ Thanh Loan</option>
                <option value="ÄÃ¬nh TÃ¢m">ğŸ§‘â€âœˆï¸ ÄÃ¬nh TÃ¢m</option>
                <option value="Háº£i ÄÄƒng">ğŸ§‘â€âœˆï¸ Háº£i ÄÄƒng</option>
                <option value="LÃª TÃ¢m">ğŸ§‘â€âœˆï¸ LÃª TÃ¢m</option>
                <option value="Nguyá»…n Tháº£o">ğŸ‘¸ Nguyá»…n Tháº£o</option>
                <option value="Quá»‘c DÅ©ng">ğŸ§‘â€âœˆï¸ Quá»‘c DÅ©ng</option>
                <option value="TÃ¢n Há»“">ğŸ§‘â€âœˆï¸ TÃ¢n Há»“</option>
                <option value="Tráº§n Vinh">ğŸ§‘â€âœˆï¸ Tráº§n Vinh</option>
                <option value="XuÃ¢n Phong">ğŸ§‘â€âœˆï¸ XuÃ¢n Phong</option>
            </select>
            <div class="label-row">
                <h3 data-i18n="labelTripType"><span>ğŸš—</span> Loáº¡i chuyáº¿n Ä‘i</h3>
            </div>
            <select id="tripType">
                <option value="1" data-i18n="tripOneWay">1 chiá»u</option>
                <option value="2" data-i18n="tripTwoWay">2 chiá»u (giáº£m 40% chiá»u vá»)</option>
            </select>

            <div id="waitingWrapper">
                <div class="label-row">
                    <h3 data-i18n="labelWaiting"><span>â³</span> Thá»i gian chá» (giá»)</h3>
                </div>
                <input id="waiting" type="number" min="0" value="0" data-i18n-placeholder="placeholderWaiting" placeholder="Nháº­p sá»‘ giá» chá»">
            </div>

            <button class="calc-btn" id="calc-btn" data-i18n="btnCalculate">ğŸ’° TÃ­nh giÃ¡</button>
        </div>

        <div id="map"></div>

        <div id="result" class="result-box" style="display:none">
            <div class="result-row">
                <div class="distance-text" id="distanceText"></div>
            </div>

            <div class="price-title" data-i18n="resultPriceTitle">ğŸ’µ GiÃ¡ dá»± kiáº¿n</div>
            <div class="price-value" id="priceValue">â€” Ä‘</div>

            <div class="price-break" id="priceBreak"></div>

            <div style="margin-top:8px;font-size:14px;color:#333" id="timeEst"></div>
            <div style="margin-top:4px;font-size:14px;color:#333" id="pickupInfo"></div>
        </div>

        <div class="actions">
            <a id="zaloBtn" class="zalo-btn inactive-booking" href="javascript:void(0);" style="display:none;" data-i18n="btnBookZalo">ğŸ“± Äáº·t qua Zalo</a>
            <a id="mailBtn" class="mail inactive-booking" href="javascript:void(0);" style="display:none;" data-i18n="btnBookMail">ğŸ“§ Äáº·t qua Mail</a>
        </div>

        <div class="note" id="note-container">
            </div>
    </div>
</div>

<div id="mapModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="mapModalTitle">Chá»n Vá»‹ TrÃ­</h3>
        <div id="map-modal-container"></div>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmMapSelectionBtn">XÃ¡c nháº­n vá»‹ trÃ­</button>
        </div>
    </div>
</div>

<div id="phoneModal" class="modal-overlay">
    <div class="modal-content">
        <h3 data-i18n="modalPhoneTitle">ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i</h3>
        <p data-i18n="modalPhoneNotice">QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.</p>
        <input id="phoneModalInput" type="tel" placeholder="Nháº­p SÄT (10 sá»‘, VD: 0987654321)" inputmode="tel" class="input-row">
        <div id="phoneModalError"></div>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="phoneModalConfirmBtn" data-i18n="modalPhoneConfirm">XÃ¡c nháº­n</button>
        </div>
    </div>
</div>


<div id="depositModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalDepositTitle">ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u</h3>
        <p data-i18n="modalDepositNotice1">
            <strong>QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:</strong><br>
            Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i <strong>Hai chiá»u</strong> cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch <strong>Ä‘áº·t cá»c trÆ°á»›c 20%</strong> trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.
        </p>
        <p style="text-align:center; font-size:18px;">
            <span data-i18n="modalDepositAmountText">Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n:</span> <span id="depositAmount">0 Ä‘</span>
        </p>
        <p data-i18n="modalDepositNotice2">
            Khi nhÃ¢n viÃªn <strong>TrÆ°á»ng An Driving</strong> pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i <strong>hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ</strong> (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.
        </p>
        <p style="font-size:14px; color:#555;" data-i18n="modalDepositNote">
            <strong>LÆ°u Ã½:</strong> Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i.
            Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.
        </p>
        <div class="modal-actions" style="margin-top:10px;">
            <button id="confirmDepositBtn" style="width:100%;" data-i18n="modalDepositConfirm">ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c</button>
        </div>
    </div>
</div>

<div id="zaloModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h3 data-i18n="modalBookingTitle">âœ… THÃ”NG TIN Äáº¶T XE</h3>
        <p style="text-align:center; font-size:15px; font-weight:600;" data-i18n="modalBookingNotice">Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:</p>
        <pre id="modal-text"></pre>
        <div class="modal-actions">
            <button id="copyModalBtn" data-i18n="modalBtnCopy">ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin</button>
            <button id="zaloModalBtn" data-i18n="modalBtnZalo">ğŸ“± Má»Ÿ Zalo Chat</button>
        </div>
        <button id="closeModalBtn" style="width:100%; margin-top:10px; padding:12px; border-radius:10px;" data-i18n="modalClose">ÄÃ³ng</button>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay" style="display:none"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- I18N CONFIGURATION START ---------- */
const i18n = {
    vi: {
        appTitle: "ğŸš– Dá»‹ch vá»¥ Taxi TrÆ°á»ng An Driving",
        headerService: "ğŸš– Dá»‹ch Vá»¥ Taxi",
        statusChecking: "ğŸ’° Äang kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥...",
        statusActive: 'ğŸ’° Báº¥m "TÃ­nh giÃ¡" Ä‘á»ƒ xem chi tiáº¿t Ä‘áº·t xe.',
        statusLocating: "(Äang tÃ¬m vá»‹ trÃ­...)",
        titleReloadLocation: "Thá»­ láº¥y láº¡i vá»‹ trÃ­",

        // Form Labels & Placeholders
        labelPhone: "ğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i cá»§a báº¡n (KhÃ´ng báº¯t buá»™c Ä‘á»ƒ TÃ­nh giÃ¡)",
        placeholderPhone: "Nháº­p SÄT (10 sá»‘, VD: 0987654321)",
        labelPickup: "ğŸ“ Äiá»ƒm Ä‘Ã³n",
        placeholderPickup: "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘Ã³n (hoáº·c tá»± Ä‘á»™ng láº¥y)",
        labelTime: "ğŸ•’ NgÃ y & Giá» Ä‘Ã³n",
        btnAddStop: "ï¼‹ ThÃªm Ä‘iá»ƒm dá»«ng",
        labelDropoff: "ğŸ Äiá»ƒm Ä‘áº¿n",
        placeholderDropoff: "Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm Ä‘áº¿n cuá»‘i",
        labelCarType: "ğŸš˜ Loáº¡i xe",
        car4seater: "Xe 4 chá»— (10.000Ä‘/km)",
        car7seater: "Xe 7 chá»— (12.000Ä‘/km)",
        labelDriverRequest: "ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿",
        driverDefault: "â­ TrÆ°á»ng An Driving (Máº·c Ä‘á»‹nh)",
        labelTripType: "ğŸš— Loáº¡i chuyáº¿n Ä‘i",
        tripOneWay: "1 chiá»u",
        tripTwoWay: "2 chiá»u (giáº£m 40% chiá»u vá»)",
        labelWaiting: "â³ Thá»i gian chá» (giá»)",
        placeholderWaiting: "Nháº­p sá»‘ giá» chá»",
        btnCalculate: "ğŸ’° TÃ­nh giÃ¡",
        btnMap: "Báº£n Ä‘á»“",

        // Calculation Status & Results
        statusCalculating: "Äang tÃ­nh toÃ¡n...",
        statusCalculatingRoute: "Äang tÃ­nh lá»™ trÃ¬nh...",
        statusNoRoute: "KhÃ´ng tÃ­nh Ä‘Æ°á»£c lá»™ trÃ¬nh",
        statusNoCoord: "KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ Äiá»ƒm ", // + 'Ä‘Ã³n'/'Ä‘áº¿n'
        resultPriceTitle: "ğŸ’µ GiÃ¡ dá»± kiáº¿n",
        resultDistance: "âœï¸ QuÃ£ng Ä‘Æ°á»ng:",
        resultTimeEst: "â± Thá»i gian dá»± kiáº¿n:",
        resultPickupTime: "ğŸ•’ NgÃ y giá» Ä‘Ã³n:",

        // Notes - Äá»ŠNH Dáº NG Láº I
        noteMain: `
            <p>GiÃ¡ 4 chá»—/7 chá»—: <strong>10.000Ä‘/km</strong> / <strong>12.000Ä‘/km</strong>. 2 chiá»u: chiá»u vá» giáº£m 40% (Ã¡p dá»¥ng cho chuyáº¿n 1 chiá»u <strong>â‰¥ 45km</strong>).</p>
            <p><strong>Thá»i gian chá»:</strong></p>
            <ul>
                <li>Chá» 0â€“3 giá»: <strong>Miá»…n phÃ­</strong>.</li>
                <li>Ká»ƒ tá»« giá» thá»© 4, má»—i giá» tiáº¿p theo phÃ¡t sinh phá»¥ phÃ­ <strong>50.000 VNÄ/giá»</strong>.</li>
                <li>Thá»i gian chá» Ä‘Æ°á»£c tÃ­nh tá»« khi hÃ nh khÃ¡ch <strong>hoÃ n táº¥t viá»‡c xuá»‘ng xe táº¡i Ä‘iá»ƒm Ä‘áº¿n</strong> cho Ä‘áº¿n khi xe quay trá»Ÿ láº¡i Ä‘Ã³n Ä‘á»ƒ vá» Ä‘iá»ƒm xuáº¥t phÃ¡t ban Ä‘áº§u.</li>
            </ul>
            <p>GiÃ¡ Ä‘Ã£ bao gá»“m phÃ­ cáº§u Ä‘Æ°á»ng.</p>
        `,

        // Booking Buttons
        btnBookZalo: "ğŸ“± Äáº·t qua Zalo",
        btnBookMail: "ğŸ“§ Äáº·t qua Mail",

        // Modals
        modalClose: "ÄÃ³ng",
        modalBookingTitle: "âœ… THÃ”NG TIN Äáº¶T XE",
        modalBookingNotice: "Sao chÃ©p thÃ´ng tin vÃ  gá»­i qua Zalo:",
        modalBtnCopy: "ğŸ“‹ Sao ChÃ©p ThÃ´ng Tin",
        modalBtnZalo: "ğŸ“± Má»Ÿ Zalo Chat",

        // Phone Modal (Má»šI)
        modalPhoneTitle: "ğŸ“ Vui lÃ²ng nháº­p Sá»‘ Ä‘iá»‡n thoáº¡i",
        modalPhoneNotice: "QuÃ½ khÃ¡ch vui lÃ²ng nháº­p SÄT Ä‘á»ƒ chÃºng tÃ´i tiá»‡n liÃªn há»‡ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.",
        modalPhoneConfirm: "XÃ¡c nháº­n",
        alertPhoneInvalid: "Vui lÃ²ng nháº­p SÄT 10 sá»‘ há»£p lá»‡ (VD: 0987654321) Ä‘á»ƒ Ä‘áº·t xe.",

        // Deposit Modal
        modalDepositTitle: "ğŸ“ YÃªu cáº§u Äáº·t cá»c cho Chuyáº¿n 2 Chiá»u",
        modalDepositNotice1: "<strong>QuÃ½ khÃ¡ch vui lÃ²ng lÆ°u Ã½:</strong><br>Äá»ƒ xÃ¡c nháº­n vÃ  Ä‘áº£m báº£o cháº¥t lÆ°á»£ng phá»¥c vá»¥ cho chuyáº¿n Ä‘i <strong>Hai chiá»u</strong> cá»§a QuÃ½ khÃ¡ch, chÃºng tÃ´i kÃ­nh mong QuÃ½ khÃ¡ch <strong>Ä‘áº·t cá»c trÆ°á»›c 20%</strong> trÃªn tá»•ng giÃ¡ cÆ°á»›c dá»± kiáº¿n.",
        modalDepositAmountText: "Sá»‘ tiá»n Ä‘áº·t cá»c dá»± kiáº¿n:",
        modalDepositNotice2: "Khi nhÃ¢n viÃªn <strong>TrÆ°á»ng An Driving</strong> pháº£n há»“i qua Zalo, chÃºng tÃ´i sáº½ gá»­i <strong>hÆ°á»›ng dáº«n thanh toÃ¡n cá»¥ thá»ƒ</strong> (chuyá»ƒn khoáº£n) Ä‘á»ƒ hoÃ n táº¥t thá»§ tá»¥c Ä‘áº·t cá»c.",
        modalDepositNote: "<strong>LÆ°u Ã½:</strong> Pháº§n cÃ²n láº¡i cá»§a cÆ°á»›c phÃ­ sáº½ Ä‘Æ°á»£c thanh toÃ¡n trá»±c tiáº¿p cho tÃ i xáº¿ sau khi káº¿t thÃºc chuyáº¿n Ä‘i. Xin chÃ¢n thÃ nh cáº£m Æ¡n QuÃ½ khÃ¡ch Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥.",
        modalDepositConfirm: "ÄÃ£ hiá»ƒu vÃ  Tiáº¿p tá»¥c",

        // Geolocation Errors
        errorNetwork: "âš ï¸ Thiáº¿t bá»‹ Ä‘ang OFFLINE hoáº·c Lá»–I Káº¾T Ná»I. KhÃ´ng thá»ƒ xÃ¡c nháº­n Ä‘Æ¡n hÃ ng.",
        errorTimeout: "âš ï¸ Kiá»ƒm tra tráº¡ng thÃ¡i dá»‹ch vá»¥ quÃ¡ lÃ¢u. Viá»‡c Ä‘áº·t xe bá»‹ táº¡m ngÆ°ng.",
        errorServiceFetch: "âš ï¸ Cáº¢NH BÃO Máº NG: KhÃ´ng tÃ¬m tháº¥y file tráº¡ng thÃ¡i dá»‹ch vá»¥ (404/Server Error). Chá»©c nÄƒng Ä‘áº·t xe bá»‹ táº¡m ngÆ°ng.",
        errorLocating: "âš ï¸ Lá»—i tÃ¬m vá»‹ trÃ­. Nháº­p thá»§ cÃ´ng.",
        errorDenied: "âŒ Bá»‹ tá»« chá»‘i quyá»n truy cáº­p vá»‹ trÃ­.",
        errorUnavailable: "âŒ Vá»‹ trÃ­ khÃ´ng kháº£ dá»¥ng (Báº­t GPS).",
        errorTimeoutLoc: "âš ï¸ Háº¿t thá»i gian tÃ¬m vá»‹ trÃ­.",
        errorNotSupported: "âŒ TrÃ¬nh duyá»‡t khÃ´ng há»— trá»£ Geolocation.",
        statusLocated: "âœ… ÄÃ£ tÃ¬m tháº¥y vá»‹ trÃ­",
        statusPopup: "ğŸ“ Vá»‹ trÃ­ hiá»‡n táº¡i",
        mapPopupPickup: "ğŸ“ Äiá»ƒm Ä‘Ã³n",
        mapPopupDropoff: "ğŸ Äiá»ƒm Ä‘áº¿n",
        mapPopupStop: "ğŸ“ Äiá»ƒm dá»«ng",
        alertPickup: 'âŒ Vui lÃ²ng nháº­p Äá»‹a chá»‰ Äiá»ƒm Ä‘Ã³n.',
        alertDropoff: 'âŒ Vui lÃ²ng nháº­p Äá»‹a chá»‰ Äiá»ƒm Ä‘áº¿n.',
        alertWaiting: 'âŒ VÃ¬ báº¡n chá»n chuyáº¿n 2 chiá»u, vui lÃ²ng nháº­p Thá»i gian chá» (sá»‘ giá») Ä‘á»ƒ chÃºng tÃ´i sáº¯p xáº¿p xe. GiÃ¡ trá»‹ pháº£i â‰¥ 0.',
        alertNoCoord: 'KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™. HÃ£y chá»n gá»£i Ã½ hoáº·c Ä‘áº·t trÃªn báº£n Ä‘á»“.',
        alertNoStopCoord: 'KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ cho má»™t Äiá»ƒm dá»«ng.',
        alertNoSuggestions: 'KhÃ´ng tÃ¬m tháº¥y Ä‘á»‹a Ä‘iá»ƒm',
        alertSearching: 'Äang tÃ¬m kiáº¿m...',
        mapModalTitlePickup: 'Chá»n Ä‘iá»ƒm Ä‘Ã³n',
        mapModalTitleDropoff: 'Chá»n Ä‘iá»ƒm Ä‘áº¿n',
        mapModalTitleStop: 'Chá»n Ä‘iá»ƒm dá»«ng',
    },
    en: {
        appTitle: "ğŸš– Truong An Driving Taxi Service",
        headerService: "ğŸš– Taxi Service",
        statusChecking: "ğŸ’° Checking service status...",
        statusActive: 'ğŸ’° Click "Calculate Price" for booking details.',
        statusLocating: "(Locating...)",
        titleReloadLocation: "Try to get location again",

        labelPhone: "ğŸ“ Your Phone Number (Optional for Price Calculation)",
        placeholderPhone: "Enter Phone No. (10 digits, e.g.: 0987654321)",
        labelPickup: "ğŸ“ Pickup Location",
        placeholderPickup: "Enter pickup address (or auto-locate)",
        labelTime: "ğŸ•’ Pickup Date & Time",
        btnAddStop: "ï¼‹ Add Stopover",
        labelDropoff: "ğŸ Drop-off Location",
        placeholderDropoff: "Enter final drop-off address",
        labelCarType: "ğŸš˜ Car Type",
        car4seater: "4 Seater (10,000Ä‘/km)",
        car7seater: "7 Seater (12,000Ä‘/km)",
        labelDriverRequest: "ğŸ§‘â€âœˆï¸ Driver Request",
        driverDefault: "â­ Truong An Driving (Default)",
        labelTripType: "ğŸš— Trip Type",
        tripOneWay: "One-Way",
        tripTwoWay: "Two-Way (40% off return trip)",
        labelWaiting: "â³ Waiting Time (hours)",
        placeholderWaiting: "Enter waiting time in hours",
        btnCalculate: "ğŸ’° Calculate Price",
        btnMap: "Map",

        statusCalculating: "Calculating...",
        statusCalculatingRoute: "Calculating route...",
        statusNoRoute: "Could not calculate route",
        statusNoCoord: "Could not find coordinates for ", // + 'Pickup'/'Drop-off'
        resultPriceTitle: "ğŸ’µ Estimated Price",
        resultDistance: "âœï¸ Distance:",
        resultTimeEst: "â± Estimated Time:",
        resultPickupTime: "ğŸ•’ Pickup Date & Time:",

        noteMain: `
            <p>Price 4-seater/7-seater: <strong>10,000 VND/km</strong> / <strong>12,000 VND/km</strong>. Two-way trip: 40% off return leg (applies to one-way trips <strong>â‰¥ 45km</strong>).</p>
            <p><strong>Waiting Time:</strong></p>
            <ul>
                <li>0â€“3 hours waiting: <strong>Free</strong>.</li>
                <li>From the 4th hour onwards, a surcharge of <strong>50,000 VND/hour</strong> applies.</li>
                <li>Waiting time is calculated from when the passenger <strong>completes drop-off at the destination</strong> until the car returns to pick up for the original starting point.</li>
            </ul>
            <p>Price includes all road/toll fees.</p>
        `,

        btnBookZalo: "ğŸ“± Book via Zalo",
        btnBookMail: "ğŸ“§ Book via Mail",

        modalClose: "Close",
        modalBookingTitle: "âœ… BOOKING INFORMATION",
        modalBookingNotice: "Copy the information and send via Zalo:",
        modalBtnCopy: "ğŸ“‹ Copy Information",
        modalBtnZalo: "ğŸ“± Open Zalo Chat",

        modalPhoneTitle: "ğŸ“ Please Enter Phone Number",
        modalPhoneNotice: "Please enter your phone number so we can contact you to confirm the order.",
        modalPhoneConfirm: "Confirm",
        alertPhoneInvalid: "Please enter a valid 10-digit phone number (e.g., 0987654321) to place an order.",

        modalDepositTitle: "ğŸ“ Deposit Required for Two-Way Trip",
        modalDepositNotice1: "<strong>Dear customer, please note:</strong><br>To confirm and ensure service quality for your <strong>Two-way</strong> trip, we kindly request a <strong>20% deposit</strong> on the estimated total fare.",
        modalDepositAmountText: "Estimated deposit amount:",
        modalDepositNotice2: "When a <strong>Truong An Driving</strong> staff member responds via Zalo, we will send <strong>specific payment instructions</strong> (bank transfer) to finalize the deposit.",
        modalDepositNote: "<strong>Note:</strong> The remaining fare will be paid directly to the driver after the trip is completed. Thank you for trusting our service.",
        modalDepositConfirm: "I Understand and Continue",
        
        errorNetwork: "âš ï¸ Device is OFFLINE or CONNECTION ERROR. Order confirmation is not possible.",
        errorTimeout: "âš ï¸ Service status check took too long. Booking is temporarily suspended.",
        errorServiceFetch: "âš ï¸ NETWORK WARNING: Service status file not found (404/Server Error). Booking functionality is suspended.",
        errorLocating: "âš ï¸ Location search error. Please enter manually.",
        errorDenied: "âŒ Location access permission denied.",
        errorUnavailable: "âŒ Location unavailable (Turn on GPS).",
        errorTimeoutLoc: "âš ï¸ Location search timed out.",
        errorNotSupported: "âŒ Browser does not support Geolocation.",
        statusLocated: "âœ… Location found",
        statusPopup: "ğŸ“ Current Location",
        mapPopupPickup: "ğŸ“ Pickup Point",
        mapPopupDropoff: "ğŸ Drop-off Point",
        mapPopupStop: "ğŸ“ Stopover Point",
        alertPickup: 'âŒ Please enter the Pickup address.',
        alertDropoff: 'âŒ Please enter the Drop-off address.',
        alertWaiting: 'âŒ Since you chose a two-way trip, please enter the Waiting Time (hours) for us to arrange the car. Value must be â‰¥ 0.',
        alertNoCoord: 'Coordinates not found. Please choose a suggestion or set on the map.',
        alertNoStopCoord: 'Coordinates not found for a Stopover.',
        alertNoSuggestions: 'No locations found',
        alertSearching: 'Searching...',
        mapModalTitlePickup: 'Select Pickup Location',
        mapModalTitleDropoff: 'Select Drop-off Location',
        mapModalTitleStop: 'Select Stopover Location',
    },
    zh: {
        appTitle: "ğŸš– é•¿å®‰é©¾é©¶å‡ºç§Ÿè½¦æœåŠ¡",
        headerService: "ğŸš– å‡ºç§Ÿè½¦æœåŠ¡",
        statusChecking: "ğŸ’° æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...",
        statusActive: 'ğŸ’° ç‚¹å‡»â€œè®¡ç®—ä»·æ ¼â€æŸ¥çœ‹é¢„è®¢è¯¦æƒ…ã€‚',
        statusLocating: "(æ­£åœ¨å®šä½...)",
        titleReloadLocation: "å°è¯•é‡æ–°è·å–ä½ç½®",

        labelPhone: "ğŸ“ æ‚¨çš„ç”µè¯å·ç  (è®¡ç®—ä»·æ ¼å¯é€‰)",
        placeholderPhone: "è¾“å…¥ç”µè¯å·ç  (10ä½ï¼Œä¾‹å¦‚ï¼š0987654321)",
        labelPickup: "ğŸ“ ä¸Šè½¦åœ°ç‚¹",
        placeholderPickup: "è¾“å…¥ä¸Šè½¦åœ°å€ (æˆ–è‡ªåŠ¨å®šä½)",
        labelTime: "ğŸ•’ ä¸Šè½¦æ—¥æœŸå’Œæ—¶é—´",
        btnAddStop: "ï¼‹ æ·»åŠ ç»åœç‚¹",
        labelDropoff: "ğŸ ç›®çš„åœ°",
        placeholderDropoff: "è¾“å…¥æœ€ç»ˆç›®çš„åœ°åœ°å€",
        labelCarType: "ğŸš˜ è½¦å‹",
        car4seater: "4åº§è½¦ (10,000Ä‘/å…¬é‡Œ)",
        car7seater: "7åº§è½¦ (12,000Ä‘/å…¬é‡Œ)",
        labelDriverRequest: "ğŸ§‘â€âœˆï¸ å¸æœºè¦æ±‚",
        driverDefault: "â­ é•¿å®‰é©¾é©¶ (é»˜è®¤)",
        labelTripType: "ğŸš— è¡Œç¨‹ç±»å‹",
        tripOneWay: "å•ç¨‹",
        tripTwoWay: "åŒç¨‹ (è¿”ç¨‹å‡40%)",
        labelWaiting: "â³ ç­‰å¾…æ—¶é—´ (å°æ—¶)",
        placeholderWaiting: "è¾“å…¥ç­‰å¾…æ—¶é—´(å°æ—¶)",
        btnCalculate: "ğŸ’° è®¡ç®—ä»·æ ¼",
        btnMap: "åœ°å›¾",

        statusCalculating: "æ­£åœ¨è®¡ç®—...",
        statusCalculatingRoute: "æ­£åœ¨è®¡ç®—è·¯çº¿...",
        statusNoRoute: "æ— æ³•è®¡ç®—è·¯çº¿",
        statusNoCoord: "æ‰¾ä¸åˆ°åæ ‡ï¼š", // + 'ä¸Šè½¦'/'ç›®çš„åœ°'
        resultPriceTitle: "ğŸ’µ é¢„è®¡ä»·æ ¼",
        resultDistance: "âœï¸ è·ç¦»:",
        resultTimeEst: "â± é¢„è®¡æ—¶é—´:",
        resultPickupTime: "ğŸ•’ ä¸Šè½¦æ—¥æœŸå’Œæ—¶é—´:",

        noteMain: `
            <p>4åº§/7åº§è½¦ä»·æ ¼: <strong>10,000 è¶Šå—ç›¾/å…¬é‡Œ</strong> / <strong>12,000 è¶Šå—ç›¾/å…¬é‡Œ</strong>ã€‚åŒç¨‹: è¿”ç¨‹å‡40% (é€‚ç”¨äºå•ç¨‹ <strong>â‰¥ 45å…¬é‡Œ</strong>)ã€‚</p>
            <p><strong>ç­‰å¾…æ—¶é—´:</strong></p>
            <ul>
                <li>ç­‰å¾… 0â€“3 å°æ—¶: <strong>å…è´¹</strong>ã€‚</li>
                <li>ä»ç¬¬4å°æ—¶èµ·ï¼Œæ¯å°æ—¶åŠ æ”¶ <strong>50,000 è¶Šå—ç›¾/å°æ—¶</strong>ã€‚</li>
                <li>ç­‰å¾…æ—¶é—´ä»ä¹˜å®¢åœ¨<strong>ç›®çš„åœ°å®Œæˆä¸‹è½¦</strong>å¼€å§‹è®¡ç®—ï¼Œç›´åˆ°è½¦è¾†è¿”å›æ¥ä¹˜å®¢å›åˆ°æœ€åˆçš„èµ·ç‚¹ã€‚</li>
            </ul>
            <p>ä»·æ ¼å·²åŒ…å«æ‰€æœ‰è¿‡è·¯/è¿‡æ¡¥è´¹ã€‚</p>
        `,

        btnBookZalo: "ğŸ“± é€šè¿‡ Zalo é¢„è®¢",
        btnBookMail: "ğŸ“§ é€šè¿‡é‚®ä»¶é¢„è®¢",

        modalClose: "å…³é—­",
        modalBookingTitle: "âœ… é¢„è®¢ä¿¡æ¯",
        modalBookingNotice: "å¤åˆ¶ä¿¡æ¯å¹¶é€šè¿‡ Zalo å‘é€:",
        modalBtnCopy: "ğŸ“‹ å¤åˆ¶ä¿¡æ¯",
        modalBtnZalo: "ğŸ“± æ‰“å¼€ Zalo èŠå¤©",

        modalPhoneTitle: "ğŸ“ è¯·è¾“å…¥ç”µè¯å·ç ",
        modalPhoneNotice: "è¯·è¾“å…¥æ‚¨çš„ç”µè¯å·ç ï¼Œä»¥ä¾¿æˆ‘ä»¬ä¸æ‚¨è”ç³»ç¡®è®¤è®¢å•ã€‚",
        modalPhoneConfirm: "ç¡®è®¤",
        alertPhoneInvalid: "è¯·è¾“å…¥æœ‰æ•ˆçš„10ä½ç”µè¯å·ç  (ä¾‹å¦‚ 0987654321) æ¥ä¸‹è®¢å•ã€‚",

        modalDepositTitle: "ğŸ“ åŒç¨‹æ—…è¡Œéœ€æ”¯ä»˜æŠ¼é‡‘",
        modalDepositNotice1: "<strong>å°Šæ•¬çš„å®¢æˆ·ï¼Œè¯·æ³¨æ„:</strong><br>ä¸ºç¡®è®¤å¹¶ç¡®ä¿æ‚¨<strong>åŒç¨‹</strong>æ—…è¡Œçš„æœåŠ¡è´¨é‡ï¼Œæˆ‘ä»¬æ³è¯·æ‚¨é¢„å…ˆæ”¯ä»˜é¢„ä¼°æ€»è´¹ç”¨çš„ <strong>20% æŠ¼é‡‘</strong>ã€‚",
        modalDepositAmountText: "é¢„è®¡æŠ¼é‡‘é‡‘é¢:",
        modalDepositNotice2: "å½“ <strong>é•¿å®‰é©¾é©¶</strong> å‘˜å·¥é€šè¿‡ Zalo å›å¤æ‚¨æ—¶ï¼Œæˆ‘ä»¬å°†å‘é€<strong>å…·ä½“çš„ä»˜æ¬¾æŒ‡ç¤º</strong> (é“¶è¡Œè½¬è´¦) ä»¥å®ŒæˆæŠ¼é‡‘æ‰‹ç»­ã€‚",
        modalDepositNote: "<strong>æ³¨æ„:</strong> å‰©ä½™è½¦è´¹å°†åœ¨è¡Œç¨‹ç»“æŸåç›´æ¥æ”¯ä»˜ç»™å¸æœºã€‚è¡·å¿ƒæ„Ÿè°¢æ‚¨å¯¹æˆ‘ä»¬æœåŠ¡çš„ä¿¡ä»»ã€‚",
        modalDepositConfirm: "æˆ‘å·²äº†è§£å¹¶ç»§ç»­",

        errorNetwork: "âš ï¸ è®¾å¤‡å¤„äºç¦»çº¿çŠ¶æ€æˆ–è¿æ¥é”™è¯¯ã€‚æ— æ³•ç¡®è®¤è®¢å•ã€‚",
        errorTimeout: "âš ï¸ æœåŠ¡çŠ¶æ€æ£€æŸ¥è¶…æ—¶ã€‚é¢„è®¢æš‚æ—¶åœæ­¢ã€‚",
        errorServiceFetch: "âš ï¸ ç½‘ç»œè­¦å‘Šï¼šæ‰¾ä¸åˆ°æœåŠ¡çŠ¶æ€æ–‡ä»¶ (404/æœåŠ¡å™¨é”™è¯¯)ã€‚é¢„è®¢åŠŸèƒ½å·²æš‚åœã€‚",
        errorLocating: "âš ï¸ å®šä½é”™è¯¯ã€‚è¯·æ‰‹åŠ¨è¾“å…¥ã€‚",
        errorDenied: "âŒ ä½ç½®è®¿é—®æƒé™è¢«æ‹’ç»ã€‚",
        errorUnavailable: "âŒ ä½ç½®ä¸å¯ç”¨ (è¯·æ‰“å¼€GPS)ã€‚",
        errorTimeoutLoc: "âš ï¸ ä½ç½®æœç´¢è¶…æ—¶ã€‚",
        errorNotSupported: "âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½ã€‚",
        statusLocated: "âœ… å·²æ‰¾åˆ°ä½ç½®",
        statusPopup: "ğŸ“ å½“å‰ä½ç½®",
        mapPopupPickup: "ğŸ“ ä¸Šè½¦ç‚¹",
        mapPopupDropoff: "ğŸ ä¸‹è½¦ç‚¹",
        mapPopupStop: "ğŸ“ ç»åœç‚¹",
        alertPickup: 'âŒ è¯·è¾“å…¥ä¸Šè½¦åœ°å€ã€‚',
        alertDropoff: 'âŒ è¯·è¾“å…¥ç›®çš„åœ°åœ°å€ã€‚',
        alertWaiting: 'âŒ æ‚¨é€‰æ‹©äº†åŒç¨‹æ—…è¡Œï¼Œè¯·è¾“å…¥ç­‰å¾…æ—¶é—´ (å°æ—¶) ä»¥ä¾¿æˆ‘ä»¬å®‰æ’è½¦è¾†ã€‚è¯¥å€¼å¿…é¡» â‰¥ 0ã€‚',
        alertNoCoord: 'æ‰¾ä¸åˆ°åæ ‡ã€‚è¯·é€‰æ‹©å»ºè®®æˆ–åœ¨åœ°å›¾ä¸Šè®¾ç½®ã€‚',
        alertNoStopCoord: 'æ‰¾ä¸åˆ°æŸä¸ªç»åœç‚¹çš„åæ ‡ã€‚',
        alertNoSuggestions: 'æœªæ‰¾åˆ°åœ°ç‚¹',
        alertSearching: 'æ­£åœ¨æœç´¢...',
        mapModalTitlePickup: 'é€‰æ‹©ä¸Šè½¦åœ°ç‚¹',
        mapModalTitleDropoff: 'é€‰æ‹©ä¸‹è½¦åœ°ç‚¹',
        mapModalTitleStop: 'é€‰æ‹©ç»åœç‚¹',
    }
};

let currentLang = localStorage.getItem('lang') || 'vi';

function updateContent() {
    const translations = i18n[currentLang];

    // 1. Update text content and HTML content
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        if (translations[key]) {
             if (key === 'noteMain' || key.includes('modalDeposit')) {
                element.innerHTML = translations[key];
            } else {
                element.textContent = translations[key];
            }
        }
    });
    
    // Cáº­p nháº­t riÃªng cho note-container vÃ¬ Ä‘Ã£ bá» data-i18n
    document.getElementById('note-container').innerHTML = translations.noteMain;


    // 2. Update attributes (placeholder, title)
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        if (translations[key]) {
            element.setAttribute('placeholder', translations[key]);
        }
    });

    document.querySelectorAll('[data-i18n-title]').forEach(element => {
        const key = element.getAttribute('data-i18n-title');
        if (translations[key]) {
            element.setAttribute('title', translations[key]);
        }
    });

    // 3. Update <title>
    const titleEl = document.querySelector('title');
    if (titleEl) {
        const key = titleEl.getAttribute('data-i18n');
        if (translations[key]) {
            titleEl.textContent = translations[key];
        }
    }

    // Cáº­p nháº­t cÃ¡c element khÃ¡c
    document.documentElement.setAttribute('lang', currentLang);
    document.getElementById('location-status').textContent = translations.statusLocating;
    document.getElementById('instructionText').innerHTML = translations.statusChecking;
}

document.getElementById('language-switcher').addEventListener('change', (e) => {
    currentLang = e.target.value;
    localStorage.setItem('lang', currentLang);
    updateContent();
    checkServiceStatus().then(updateUIBasedOnStatus);
    checkPhoneStatus();
});

document.getElementById('language-switcher').value = currentLang;
updateContent();
/* ---------- I18N CONFIGURATION END ---------- */


/* ---------- Cáº¥u hÃ¬nh Tá»‘i Æ¯u HÃ³a ---------- */
const REMOTE_STATUS_URL = "/status-local.json";
const NOMINATIM = "https://nominatim.openstreetmap.org/search";
const REVERSE_NOMINATIM = "https://nominatim.openstreetmap.org/reverse";
const OSRM = "https://router.project-osrm.org/route/v1/driving";
const GOOGLE_MAPS_BASE_URL = "https://www.google.com/maps/search/?api=1&query=";
const TAXI_PHONE = "0847526893";
const ZALO_URL = `https://zalo.me/${TAXI_PHONE}`;
const DEBOUNCE_TIME = 300;
const DEFAULT_CENTER = [10.9833, 106.6667]; // Tá»a Ä‘á»™ BÃ¬nh DÆ°Æ¡ng
const SOUTHERN_VN_VIEWBOX = '104.5,8.5,107.5,12.0';
let userLocation = null;
let isServiceActive = false;
let lastBookingAction = null; 

/* DOM */
const customerPhoneEl = document.getElementById('customerPhone');
const pickupEl = document.getElementById('pickup');
const pickupSugg = document.getElementById('pickup-suggestions');
const dropoffEl = document.getElementById('dropoff');
const dropoffSugg = document.getElementById('dropoff-suggestions');
const stopsContainer = document.getElementById('stops');
const calcBtn = document.getElementById('calc-btn');
const tripTypeEl = document.getElementById('tripType');
const carTypeEl = document.getElementById('carType');
const driverRequestEl = document.getElementById('driverRequest');
const waitingEl = document.getElementById('waiting');
const waitingWrapper = document.getElementById('waitingWrapper');
const resultBox = document.getElementById('result');
const distanceText = document.getElementById('distanceText');
const priceValue = document.getElementById('priceValue');
const priceBreak = document.getElementById('priceBreak');
const timeEst = document.getElementById('timeEst');
const pickupDateTime = document.getElementById('pickupDateTime');
const zaloBtn = document.getElementById('zaloBtn');
const mailBtn = document.getElementById('mailBtn');
const instructionText = document.getElementById('instructionText');
const serviceOffNotice = document.getElementById('serviceOffNotice');
const bookingFormWrapper = document.getElementById('booking-form-wrapper');
const locationStatusEl = document.getElementById('location-status');
const reloadLocationBtn = document.getElementById('reloadLocationBtn');

// Modal DOMs
const zaloModal = document.getElementById('zaloModal');
const modalText = document.getElementById('modal-text');
const copyModalBtn = document.getElementById('copyModalBtn');
const zaloModalBtn = document.getElementById('zaloModalBtn');
const closeModalBtn = document.getElementById('closeModalBtn');
const phoneModal = document.getElementById('phoneModal');
const phoneModalInput = document.getElementById('phoneModalInput');
const phoneModalError = document.getElementById('phoneModalError');
const phoneModalConfirmBtn = document.getElementById('phoneModalConfirmBtn');
const depositModal = document.getElementById('depositModal');
const depositAmount = document.getElementById('depositAmount');
const confirmDepositBtn = document.getElementById('confirmDepositBtn');

// === NEW MAP MODAL DOM ===
const mapModal = document.getElementById('mapModal');
const mapModalTitle = document.getElementById('mapModalTitle');
const confirmMapSelectionBtn = document.getElementById('confirmMapSelectionBtn');
const mapModalContainer = document.getElementById('map-modal-container');

let finalZaloMessage = '';
let finalTotalFee = 0;
let map, modalMap;
let pickupMarker = null, dropoffMarker = null, routeLayer = null, modalMarker = null;
let currentTargetInputId = null; // ID cá»§a input Ä‘ang Ä‘Æ°á»£c chá»n báº±ng báº£n Ä‘á»“ popup
let stopCount = 0;
let bookingAction = null;

/* ---------- TÃN HIá»†U KILL SWITCH (Polling) ---------- */

async function checkServiceStatus() {
    const cacheBuster = `?t=${Date.now()}`;
    const finalUrl = REMOTE_STATUS_URL + cacheBuster;

    try {
        const response = await fetch(finalUrl, { cache: 'no-store', signal: AbortSignal.timeout(3000) });
        if (!response.ok) {
            return { active: false, message_vn: i18n[currentLang].errorServiceFetch };
        }
        const data = await response.json();
        let statusMessage = data[`message_${currentLang}`] || data.message_vn;
        return { active: data.active, message_vn: statusMessage };
    } catch (error) {
        let msg = i18n[currentLang].errorNetwork;
        if (error.name === 'TimeoutError') msg = i18n[currentLang].errorTimeout;
        console.error("Lá»—i khi fetch tráº¡ng thÃ¡i dá»‹ch vá»¥:", error);
        return { active: false, message_vn: msg };
    }
}

async function updateUIBasedOnStatus(status) {
    isServiceActive = status.active;
    instructionText.style.display = 'block';

    if (!isServiceActive) {
        calcBtn.disabled = true;
        serviceOffNotice.style.display = 'block';
        serviceOffNotice.innerHTML = status.message_vn;
        zaloBtn.style.display = 'none';
        mailBtn.style.display = 'none';
        resultBox.style.display = 'none';
        instructionText.style.display = 'none';

    } else {
        calcBtn.disabled = false;
        serviceOffNotice.style.display = 'none';
        instructionText.innerHTML = status.message_vn || i18n[currentLang].statusActive;
        zaloBtn.style.display = 'block';
        mailBtn.style.display = 'block';
    }
    checkPhoneStatus();
}

function validatePhone(phone) {
    return /^0\d{9}$/.test(phone);
}

function checkPhoneStatus() {
    const phone = customerPhoneEl.value.trim();
    const isValid = validatePhone(phone);
    const hasPrice = resultBox.style.display === 'block';

    if (isValid && hasPrice && isServiceActive) {
        zaloBtn.classList.remove('inactive-booking');
        mailBtn.classList.remove('inactive-booking');
    } else {
        zaloBtn.classList.add('inactive-booking');
        mailBtn.classList.add('inactive-booking');
    }
}

customerPhoneEl.addEventListener('input', checkPhoneStatus);

function initMap(center) {
    if (!map) {
        map = L.map('map').setView(center, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    } else {
        map.setView(center, 11);
    }
}
async function reverseGeocode(lat, lon) {
    try {
        const url = `${REVERSE_NOMINATIM}?lat=${lat}&lon=${lon}&format=jsonv2&addressdetails=1&accept-language=${currentLang},en`;
        const r = await fetch(url);
        const data = await r.json();
        return data.display_name;
    } catch (e) {
        return `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    }
}
function getGeolocation() {
    const translations = i18n[currentLang];
    locationStatusEl.textContent = translations.statusLocating;
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async (pos)=>{
            userLocation = [pos.coords.latitude, pos.coords.longitude];
            initMap(userLocation);
            const address = await reverseGeocode(userLocation[0], userLocation[1]);
            pickupEl.value = address;
            pickupEl.dataset.lat = userLocation[0];
            pickupEl.dataset.lon = userLocation[1];
            if(pickupMarker) map.removeLayer(pickupMarker);
            pickupMarker = L.marker(userLocation).addTo(map).bindPopup(translations.statusPopup).openPopup();
            locationStatusEl.textContent = translations.statusLocated;
            locationStatusEl.style.color = 'var(--green)';
        }, (err)=>{
            initMap(DEFAULT_CENTER);
            let statusText = translations.errorLocating;
            if (err.code === err.PERMISSION_DENIED) statusText = translations.errorDenied;
            else if (err.code === err.POSITION_UNAVAILABLE) statusText = translations.errorUnavailable;
            else if (err.code === err.TIMEOUT) statusText = translations.errorTimeoutLoc;
            locationStatusEl.textContent = statusText;
            locationStatusEl.style.color = 'var(--danger)';
        });
    } else {
        initMap(DEFAULT_CENTER);
        locationStatusEl.textContent = translations.errorNotSupported;
    }
}
function debounce(func, timeout = DEBOUNCE_TIME) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, timeout); }; }
function toggleWaitingInput(){ waitingWrapper.style.display = (tripTypeEl.value === '1') ? 'none' : 'block'; }
tripTypeEl.addEventListener('change', toggleWaitingInput);
toggleWaitingInput();
async function geocodeOnce(query){
  try{
    let url = `${NOMINATIM}?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=VN&addressdetails=1&accept-language=${currentLang},en`;
    if(userLocation) url += `&viewbox=${userLocation[1]-0.5},${userLocation[0]-0.5},${userLocation[1]+0.5},${userLocation[0]+0.5}`;
    else url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    const r = await fetch(url);
    const data = await r.json();
    if(Array.isArray(data) && data.length>0) return data[0];
  }catch(e){ console.warn('geocode once error', e); }
  return null;
}
function attachAutocomplete(inputEl, boxEl){
  let controller = null;
  const translations = i18n[currentLang];
  const doSearch = async ()=>{
    const q = inputEl.value.trim();
    if(!q){ boxEl.style.display = 'none'; return; }
    if(controller) controller.abort();
    controller = new AbortController();
    boxEl.innerHTML = `<div>${translations.alertSearching}</div>`;
    boxEl.style.display = 'block';
    let url = `${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=VN&addressdetails=1&extratags=1&accept-language=${currentLang},en`;
    if(userLocation) url += `&viewbox=${userLocation[1]-0.3},${userLocation[0]-0.3},${userLocation[1]+0.3},${userLocation[0]+0.3}`;
    else url += `&viewbox=${SOUTHERN_VN_VIEWBOX}`;
    try{
      const res = await fetch(url, { signal: controller.signal });
      const data = await res.json();
      if(!Array.isArray(data) || data.length === 0){
        boxEl.innerHTML = `<div>${translations.alertNoSuggestions}</div>`;
        setTimeout(() => boxEl.style.display = 'none', 1000); return;
      }
      boxEl.innerHTML = '';
      data.forEach(place => {
        const d = document.createElement('div');
        d.innerHTML = `<span>ğŸ“</span><div>${place.display_name}</div>`;
        d.addEventListener('click', ()=>{
          inputEl.value = place.display_name;
          inputEl.dataset.lat = place.lat; inputEl.dataset.lon = place.lon;
          boxEl.style.display = 'none';
          const latlng = [parseFloat(place.lat), parseFloat(place.lon)];
          if(map) {
            if(inputEl.id === 'pickup'){ if(pickupMarker) map.removeLayer(pickupMarker); pickupMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupPickup).openPopup(); map.setView(latlng, 14); }
            else if(inputEl.id === 'dropoff'){ if(dropoffMarker) map.removeLayer(dropoffMarker); dropoffMarker = L.marker(latlng).addTo(map).bindPopup(translations.mapPopupDropoff).openPopup(); map.setView(latlng, 14); }
          }
        });
        boxEl.appendChild(d);
      });
    }catch(err){ if(err.name !== 'AbortError') console.error('suggest error', err); }
  };
  inputEl.addEventListener('input', debounce(doSearch));
  document.addEventListener('click', (ev)=>{ if(!boxEl.contains(ev.target) && ev.target !== inputEl) boxEl.style.display = 'none'; });
}
attachAutocomplete(pickupEl, pickupSugg);
attachAutocomplete(dropoffEl, dropoffSugg);

function createStopInput(prefill=''){
    stopCount++;
    const translations = i18n[currentLang];
    const wrapper = document.createElement('div');
    wrapper.className = 'way-wrapper input-row';
    const inputId = `stop-${stopCount}`;
    
    // === MODIFIED: Add map button to the template ===
    wrapper.innerHTML = `<input type="text" id="${inputId}" placeholder="Nháº­p Ä‘á»‹a chá»‰ Ä‘iá»ƒm dá»«ng ${stopCount}">
                         <button class="map-btn" data-target-input="${inputId}" data-i18n="btnMap">Báº£n Ä‘á»“</button>
                         <button class="way-remove" title="XÃ³a">âœ–</button>
                         <div id="${inputId}-suggestions" class="suggestions" style="display:none"></div>`;
                         
    stopsContainer.appendChild(wrapper);
    const inputEl = wrapper.querySelector('input');
    const boxEl = wrapper.querySelector('.suggestions');
    
    // === NEW: Add event listener to the new map button ===
    wrapper.querySelector('.map-btn').addEventListener('click', (e) => {
        const targetId = e.currentTarget.getAttribute('data-target-input');
        openMapModal(targetId);
    });

    attachAutocomplete(inputEl, boxEl);
    wrapper.querySelector('.way-remove').addEventListener('click', ()=> wrapper.remove());
    return inputEl;
}

document.getElementById('add-stop-btn').addEventListener('click', ()=> createStopInput());


async function resolveCoordForInput(inputEl){
    if(inputEl.dataset && inputEl.dataset.lat && inputEl.dataset.lon) return [parseFloat(inputEl.dataset.lat), parseFloat(inputEl.dataset.lon)];
    const v = inputEl.value.trim();
    if(!v) return null;
    const place = await geocodeOnce(v + ' Viá»‡t Nam');
    if(place){ inputEl.dataset.lat = place.lat; inputEl.dataset.lon = place.lon; return [parseFloat(place.lat), parseFloat(place.lon)]; }
    return null;
}
function validateRouteInputs() {
    const translations = i18n[currentLang];
    if (!pickupEl.value.trim()) { alert(translations.alertPickup); pickupEl.focus(); return false; }
    if (!dropoffEl.value.trim()) { alert(translations.alertDropoff); dropoffEl.focus(); return false; }
    if (tripTypeEl.value === '2' && (isNaN(parseFloat(waitingEl.value)) || parseFloat(waitingEl.value) < 0)) {
        alert(translations.alertWaiting); waitingEl.focus(); return false;
    }
    return true;
}

// === NEW: MAP MODAL LOGIC ===
function initModalMap(center) {
    if (!modalMap) {
        modalMap = L.map(mapModalContainer).setView(center, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(modalMap);
        modalMap.on('click', (e) => {
            if (modalMarker) {
                modalMarker.setLatLng(e.latlng);
            }
        });
    } else {
        modalMap.setView(center, 13);
    }
}

function openMapModal(targetInputId) {
    currentTargetInputId = targetInputId;
    const targetInput = document.getElementById(targetInputId);
    const translations = i18n[currentLang];
    
    // Set modal title based on the input
    if (targetInputId === 'pickup') {
        mapModalTitle.textContent = translations.mapModalTitlePickup;
    } else if (targetInputId === 'dropoff') {
        mapModalTitle.textContent = translations.mapModalTitleDropoff;
    } else {
        mapModalTitle.textContent = translations.mapModalTitleStop;
    }

    let initialCenter = userLocation || DEFAULT_CENTER;
    // If the input already has coordinates, use them
    if (targetInput.dataset.lat && targetInput.dataset.lon) {
        initialCenter = [parseFloat(targetInput.dataset.lat), parseFloat(targetInput.dataset.lon)];
    }

    openModal(mapModal);
    initModalMap(initialCenter);

    if (modalMarker) {
        modalMarker.setLatLng(initialCenter);
    } else {
        modalMarker = L.marker(initialCenter, { draggable: true }).addTo(modalMap);
    }
    
    // This is crucial to fix map rendering inside a modal
    setTimeout(() => {
        modalMap.invalidateSize();
    }, 10); 
}

confirmMapSelectionBtn.addEventListener('click', async () => {
    if (!modalMarker || !currentTargetInputId) return;

    const { lat, lng } = modalMarker.getLatLng();
    const targetInput = document.getElementById(currentTargetInputId);

    // Show a temporary loading state on the input
    const originalPlaceholder = targetInput.placeholder;
    targetInput.value = '';
    targetInput.placeholder = 'Äang láº¥y Ä‘á»‹a chá»‰...';

    const address = await reverseGeocode(lat, lng);

    targetInput.value = address;
    targetInput.dataset.lat = lat;
    targetInput.dataset.lon = lng;
    targetInput.placeholder = originalPlaceholder;
    
    // Update main map marker for visual consistency
    if(map) {
        if(currentTargetInputId === 'pickup'){ 
            if(pickupMarker) map.removeLayer(pickupMarker); 
            pickupMarker = L.marker([lat, lng]).addTo(map).bindPopup(i18n[currentLang].mapPopupPickup).openPopup(); 
            map.setView([lat, lng], 14); 
        } else if(currentTargetInputId === 'dropoff'){ 
            if(dropoffMarker) map.removeLayer(dropoffMarker); 
            dropoffMarker = L.marker([lat, lng]).addTo(map).bindPopup(i18n[currentLang].mapPopupDropoff).openPopup(); 
            map.setView([lat, lng], 14); 
        } else {
             L.marker([lat, lng]).addTo(map).bindPopup(i18n[currentLang].mapPopupStop).openPopup();
        }
    }

    closeModal(mapModal);
    currentTargetInputId = null;
});

// Add listeners to existing map buttons
document.querySelectorAll('.map-btn[data-target-input]').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const targetId = e.currentTarget.getAttribute('data-target-input');
        openMapModal(targetId);
    });
});
// =============================

async function calculateAndGenerateMessage() {
    const translations = i18n[currentLang];
    if (!validateRouteInputs()) return false;

    resultBox.style.display = 'block';
    resultBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
    distanceText.textContent = translations.statusCalculatingRoute;
    priceValue.textContent = '...'; priceBreak.innerHTML = ''; timeEst.textContent = '';
    instructionText.innerHTML = translations.statusCalculating;
    zaloBtn.classList.add('inactive-booking'); mailBtn.classList.add('inactive-booking');

    const pickupCoord = await resolveCoordForInput(pickupEl);
    if(!pickupCoord){ alert(translations.alertNoCoord); return false; }
    const dropoffCoord = await resolveCoordForInput(dropoffEl);
    if(!dropoffCoord){ alert(translations.alertNoCoord); return false; }

    const coords = [pickupCoord];
    const stopCoords = [];
    for(const s of stopsContainer.querySelectorAll('input[id^="stop-"]')){
        if(s.value.trim()){
            const sc = await resolveCoordForInput(s);
            if(!sc){ alert(translations.alertNoStopCoord); return false; }
            coords.push(sc); stopCoords.push({input: s, coord: sc});
        }
    }
    coords.push(dropoffCoord);

    const coordStr = coords.map(c => `${c[1]},${c[0]}`).join(';');
    const url = `${OSRM}/${coordStr}?overview=full&geometries=geojson`;

    try{
        const r = await fetch(url);
        const data = await r.json();
        if(!data.routes || data.routes.length === 0){ distanceText.textContent = translations.statusNoRoute; return false; }
        const route = data.routes[0];
        const dist = route.distance / 1000;
        const minutes = Math.round(route.duration / 60);

        if(map) {
            if(routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.geoJSON(route.geometry, { style: { color: '#007bff', weight: 5 } }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [20,20] });
        }

        const tripType = tripTypeEl.value;
        const carType = carTypeEl.value;
        const driverRequest = driverRequestEl.value;
        const waiting = parseFloat(waitingEl.value) || 0;

        let perKm = carType.includes('7 chá»—') ? 12000 : 10000;
        let carName = carType.split(' (')[0];
        const priceGo = Math.round(dist * perKm);
        let priceReturn = (tripType === '2') ? (dist >= 45 ? Math.round(dist * perKm * 0.6) : priceGo) : 0;
        const waitFee = waiting > 3 ? Math.round((waiting - 3) * 50000) : 0;
        const total = priceGo + priceReturn + waitFee;
        finalTotalFee = total;

        distanceText.textContent = `${translations.resultDistance} ${dist.toFixed(1)} km`;
        priceValue.textContent = `${total.toLocaleString('vi-VN')} Ä‘`;
        priceBreak.innerHTML = `<span>Chiá»u Ä‘i: ${priceGo.toLocaleString('vi-VN')} Ä‘</span><br>
            ${tripType === '2' ? `<span>Chiá»u vá»${dist < 45 ? ' (KhÃ´ng giáº£m giÃ¡)' : ' (Giáº£m 40%)'}: ${priceReturn.toLocaleString('vi-VN')} Ä‘</span><br>` : ''}
            ${waitFee > 0 ? `<span>PhÃ­ chá» (${waiting}h): ${waitFee.toLocaleString('vi-VN')} Ä‘</span>` : ''}`;
        timeEst.textContent = `${translations.resultTimeEst} ${minutes} phÃºt`;
        
        const dtValue = pickupDateTime.value;
        let pickupDt = 'KhÃ´ng cÃ³';
        if (dtValue) {
            const date = new Date(dtValue);
            const time = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit'});
            const day = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric'});
            pickupDt = `${time} ${day}`;
        }
        pickupInfo.textContent = `${translations.resultPickupTime} ${pickupDt}`;

        const getMapLink = (lat, lon, name) => `${GOOGLE_MAPS_BASE_URL}${lat},${lon}`;
        const stopAddresses = stopCoords.map((item, i) => `ğŸ“ Äiá»ƒm dá»«ng ${i+1}: ${item.input.value}\n  [ğŸ”— Vá»‹ TrÃ­: ${getMapLink(item.coord[0], item.coord[1], item.input.value)}]`).join('\n');
        
        finalZaloMessage = [
            `**âœ… THÃ”NG TIN Äáº¶T XE âœ…**`,
            `--------------------------------`,
            `ğŸ“ SÄT: ${customerPhoneEl.value || 'ChÆ°a cung cáº¥p'}`,
            `---`,
            `ğŸ•’ Thá»i gian Ä‘Ã³n: ${pickupDt}`,
            `ğŸš˜ Loáº¡i xe: ${carName}`,
            `ğŸš— Loáº¡i chuyáº¿n: ${tripTypeEl.options[tripTypeEl.selectedIndex].text}`,
            (tripType === '2' && waiting > 0) ? `â³ Thá»i gian chá»: ${waiting} giá»` : '',
            `ğŸ§‘â€âœˆï¸ YÃªu cáº§u TÃ i xáº¿: ${driverRequest}`,
            `---`,
            `ğŸ“ Äiá»ƒm Ä‘Ã³n: ${pickupEl.value}\n  [ğŸ”— Vá»‹ TrÃ­: ${getMapLink(pickupCoord[0], pickupCoord[1], pickupEl.value)}]`,
            stopAddresses,
            `ğŸ Äiá»ƒm Ä‘áº¿n: ${dropoffEl.value}\n  [ğŸ”— Vá»‹ TrÃ­: ${getMapLink(dropoffCoord[0], dropoffCoord[1], dropoffEl.value)}]`,
            `---`,
            `ğŸ’µ **GiÃ¡ dá»± kiáº¿n: ${total.toLocaleString('vi-VN')} Ä‘**`,
            tripType === '2' ? `ğŸ’° Äáº·t cá»c (20%): ${Math.round(total * 0.2).toLocaleString('vi-VN')} Ä‘` : '',
            `--------------------------------`,
            `Vui lÃ²ng xÃ¡c nháº­n láº¡i thÃ´ng tin nÃ y.`
        ].filter(Boolean).join('\n');


        checkPhoneStatus();
        instructionText.innerHTML = translations.statusActive;
        return true;
    }catch(e){
        distanceText.textContent = translations.statusNoRoute; priceValue.textContent = 'Lá»–I'; return false;
    }
}

document.addEventListener('DOMContentLoaded', ()=> {
    getGeolocation();
    checkServiceStatus().then(updateUIBasedOnStatus);
    
    const now = new Date();
    const minPickupTime = new Date(now.getTime() + 30 * 60000);
    minPickupTime.setMinutes(minPickupTime.getMinutes() - minPickupTime.getTimezoneOffset());
    const minDateTimeString = minPickupTime.toISOString().slice(0, 16);
    
    pickupDateTime.min = minDateTimeString;
    pickupDateTime.value = minDateTimeString;
});

reloadLocationBtn.addEventListener('click', getGeolocation);
calcBtn.addEventListener('click', calculateAndGenerateMessage);

function openModal(modalEl){ modalEl.style.display = 'flex'; }
function closeModal(modalEl){ modalEl.style.display = 'none'; }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeModal(overlay);
    });
});

function handleBookingClick(type) {
    lastBookingAction = type;
    if (!validatePhone(customerPhoneEl.value)) {
        phoneModalError.textContent = '';
        phoneModalInput.value = '';
        openModal(phoneModal);
        phoneModalInput.focus();
        return;
    }
    
    proceedWithBooking(type);
}

async function proceedWithBooking(type) {
    if (!isServiceActive) return;
    const success = await calculateAndGenerateMessage();
    if (!success) return;

    bookingAction = type;

    if (tripTypeEl.value === '2') {
        depositAmount.textContent = `${Math.round(finalTotalFee * 0.2).toLocaleString('vi-VN')} Ä‘`;
        openModal(depositModal);
        return;
    }
    
    showZaloModal(type === 'mail');
}

zaloBtn.addEventListener('click', () => handleBookingClick('zalo'));
mailBtn.addEventListener('click', () => handleBookingClick('mail'));

phoneModalConfirmBtn.addEventListener('click', () => {
    const phone = phoneModalInput.value.trim();
    if (validatePhone(phone)) {
        customerPhoneEl.value = phone;
        closeModal(phoneModal);
        if (lastBookingAction) {
            proceedWithBooking(lastBookingAction);
        }
    } else {
        phoneModalError.textContent = i18n[currentLang].alertPhoneInvalid;
    }
});

confirmDepositBtn.addEventListener('click', () => {
    closeModal(depositModal);
    if (bookingAction) showZaloModal(bookingAction === 'mail');
});

closeModalBtn.addEventListener('click', () => closeModal(zaloModal));

function showZaloModal(isMail = false) {
    const translations = i18n[currentLang];
    modalText.textContent = finalZaloMessage;
    const titleEl = zaloModal.querySelector('h3');
    if (isMail) {
        titleEl.textContent = "THÃ”NG TIN Äáº¶T MAIL";
        zaloModalBtn.textContent = "ğŸ“§ Gá»­i qua Email";
        zaloModalBtn.onclick = () => {
            window.location.href = `mailto:truongan.driving@gmail.com?subject=Äáº·t xe TrÆ°á»ng An Driving&body=${encodeURIComponent(finalZaloMessage)}`;
        };
    } else {
        titleEl.textContent = translations.modalBookingTitle;
        zaloModalBtn.textContent = translations.modalBtnZalo;
        zaloModalBtn.onclick = () => window.open(ZALO_URL, '_blank');
    }
    openModal(zaloModal);
}

copyModalBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(modalText.textContent).then(() => {
        copyModalBtn.textContent = 'âœ… ÄÃ£ Sao ChÃ©p!';
        setTimeout(() => copyModalBtn.textContent = i18n[currentLang].modalBtnCopy, 1500);
    }).catch(err => alert('Sao chÃ©p tháº¥t báº¡i.'));
});

</script>
</body>
</html>
